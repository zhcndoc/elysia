---
url: 'https://elysiajs.com/plugins/graphql-apollo.md'
---

# GraphQL Apollo æ’ä»¶

ç”¨äº [elysia](https://github.com/elysiajs/elysia) çš„æ’ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ GraphQL Apolloã€‚

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š

```bash
bun add graphql @elysiajs/apollo @apollo/server
```

ç„¶åä½¿ç”¨å®ƒï¼š

```typescript
import { Elysia } from 'elysia'
import { apollo, gql } from '@elysiajs/apollo'

const app = new Elysia()
	.use(
		apollo({
			typeDefs: gql`
				type Book {
					title: String
					author: String
				}

				type Query {
					books: [Book]
				}
			`,
			resolvers: {
				Query: {
					books: () => {
						return [
							{
								title: 'Elysia',
								author: 'saltyAom'
							}
						]
					}
				}
			}
		})
	)
	.listen(3000)
```

è®¿é—® `/graphql` åº”è¯¥ä¼šæ˜¾ç¤º Apollo GraphQL playground å·¥ä½œæƒ…å†µã€‚

## èƒŒæ™¯

ç”±äº Elysia åŸºäº Web æ ‡å‡†è¯·æ±‚å’Œå“åº”ï¼Œè¿™ä¸ Express ä½¿ç”¨çš„ Node çš„ `HttpRequest` å’Œ `HttpResponse` ä¸åŒï¼Œå¯¼è‡´ `req, res` åœ¨ä¸Šä¸‹æ–‡ä¸­ä¸ºæœªå®šä¹‰ã€‚

å› æ­¤ï¼ŒElysia ç”¨ `context` æ›¿ä»£ä¸¤è€…ï¼Œç±»ä¼¼äºè·¯ç”±å‚æ•°ã€‚

```typescript
const app = new Elysia()
	.use(
		apollo({
			typeDefs,
			resolvers,
			context: async ({ request }) => {
				const authorization = request.headers.get('Authorization')

				return {
					authorization
				}
			}
		})
	)
	.listen(3000)
```

## é…ç½®

è¯¥æ’ä»¶æ‰©å±•äº† Apollo çš„ [ServerRegistration](https://www.apollographql.com/docs/apollo-server/api/apollo-server/#options)ï¼ˆå³ `ApolloServer` çš„æ„é€ å‚æ•°ï¼‰ã€‚

ä»¥ä¸‹æ˜¯ç”¨äºä½¿ç”¨ Elysia é…ç½® Apollo Server çš„æ‰©å±•å‚æ•°ã€‚

### path

@default `"/graphql"`

æš´éœ² Apollo Server çš„è·¯å¾„ã€‚

### enablePlayground

@default `process.env.ENV !== 'production'`

ç¡®å®š Apollo æ˜¯å¦åº”æä¾› Apollo Playgroundã€‚

---

---
url: 'https://elysiajs.com/plugins/bearer.md'
---

# Bearer æ’ä»¶

ç”¨äº [elysia](https://github.com/elysiajs/elysia) çš„æ’ä»¶ï¼Œç”¨äºè·å– Bearer ä»¤ç‰Œã€‚

é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š

```bash
bun add @elysiajs/bearer
```

ç„¶åä½¿ç”¨å®ƒï¼š

```typescript twoslash
import { Elysia } from 'elysia'
import { bearer } from '@elysiajs/bearer'

const app = new Elysia()
    .use(bearer())
    .get('/sign', ({ bearer }) => bearer, {
        beforeHandle({ bearer, set, status }) {
            if (!bearer) {
                set.headers[
                    'WWW-Authenticate'
                ] = `Bearer realm='sign', error="invalid_request"`

                return status(400, 'Unauthorized')
            }
        }
    })
    .listen(3000)
```

è¯¥æ’ä»¶ç”¨äºè·å–åœ¨ [RFC6750](https://www.rfc-editor.org/rfc/rfc6750#section-2) ä¸­æŒ‡å®šçš„ Bearer ä»¤ç‰Œã€‚

è¯¥æ’ä»¶ä¸å¤„ç†æ‚¨çš„æœåŠ¡å™¨çš„èº«ä»½éªŒè¯éªŒè¯ã€‚ç›¸åï¼Œè¯¥æ’ä»¶å°†å†³å®šæƒç•™ç»™å¼€å‘äººå‘˜ï¼Œä»¥ä¾¿ä»–ä»¬è‡ªå·±åº”ç”¨éªŒè¯æ£€æŸ¥çš„é€»è¾‘ã€‚

---

---
url: 'https://elysiajs.com/integrations/better-auth.md'
---

# æ›´å¥½çš„èº«ä»½éªŒè¯

æ›´å¥½çš„èº«ä»½éªŒè¯æ˜¯ä¸€ä¸ªä¸æ¡†æ¶æ— å…³çš„ TypeScript èº«ä»½éªŒè¯ï¼ˆå’Œæˆæƒï¼‰æ¡†æ¶ã€‚

å®ƒæä¾›äº†ä¸€æ•´å¥—å…¨é¢çš„åŠŸèƒ½ï¼Œå¹¶åŒ…æ‹¬ä¸€ä¸ªæ’ä»¶ç”Ÿæ€ç³»ç»Ÿï¼Œå¯ä»¥ç®€åŒ–æ·»åŠ é«˜çº§åŠŸèƒ½ã€‚

æˆ‘ä»¬å»ºè®®åœ¨è®¿é—®æ­¤é¡µé¢ä¹‹å‰å…ˆæŸ¥çœ‹ [Better Auth åŸºæœ¬è®¾ç½®](https://www.better-auth.com/docs/installation)ã€‚

æˆ‘ä»¬åŸºæœ¬çš„è®¾ç½®çœ‹èµ·æ¥å¦‚ä¸‹ï¼š

```ts [auth.ts]
import { betterAuth } from 'better-auth'
import { Pool } from 'pg'

export const auth = betterAuth({
    database: new Pool()
})
```

## å¤„ç†ç¨‹åº

åœ¨è®¾ç½®äº†æ›´å¥½çš„èº«ä»½éªŒè¯å®ä¾‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ [mount](/patterns/mount.html) å°†å…¶æŒ‚è½½åˆ° Elysiaã€‚

æˆ‘ä»¬éœ€è¦å°†å¤„ç†ç¨‹åºæŒ‚è½½åˆ° Elysia ç«¯ç‚¹ã€‚

```ts [index.ts]
import { Elysia } from 'elysia'
import { auth } from './auth'

const app = new Elysia()
	.mount(auth.handler) // [!code ++]
	.listen(3000)

console.log(
    `ğŸ¦Š Elysia is running at ${app.server?.hostname}:${app.server?.port}`
)
```

ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ `http://localhost:3000/api/auth` è®¿é—®æ›´å¥½çš„èº«ä»½éªŒè¯ã€‚

### è‡ªå®šä¹‰ç«¯ç‚¹

æˆ‘ä»¬å»ºè®®åœ¨ä½¿ç”¨ [mount](/patterns/mount.html) æ—¶è®¾ç½®ä¸€ä¸ªå‰ç¼€è·¯å¾„ã€‚

```ts [index.ts]
import { Elysia } from 'elysia'

const app = new Elysia()
	.mount('/auth', auth.handler) // [!code ++]
	.listen(3000)

console.log(
    `ğŸ¦Š Elysia is running at ${app.server?.hostname}:${app.server?.port}`
)
```

ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ `http://localhost:3000/auth/api/auth` è®¿é—®æ›´å¥½çš„èº«ä»½éªŒè¯ã€‚

ä½†æ˜¯è¿™ä¸ª URL çœ‹èµ·æ¥æœ‰äº›å†—ä½™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ›´å¥½çš„èº«ä»½éªŒè¯å®ä¾‹ä¸­å°† `/api/auth` å‰ç¼€è‡ªå®šä¹‰ä¸ºå…¶ä»–å†…å®¹ã€‚

```ts
import { betterAuth } from 'better-auth'
import { openAPI } from 'better-auth/plugins'
import { passkey } from 'better-auth/plugins/passkey'

import { Pool } from 'pg'

export const auth = betterAuth({
    basePath: '/api' // [!code ++]
})
```

ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡ `http://localhost:3000/auth/api` è®¿é—® Better Authã€‚

ä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½å°†æ›´å¥½çš„èº«ä»½éªŒè¯å®ä¾‹çš„ `basePath` è®¾ç½®ä¸ºä¸ºç©ºæˆ– `/`ã€‚

## OpenAPI

æ›´å¥½çš„èº«ä»½éªŒè¯æ”¯æŒä½¿ç”¨ `better-auth/plugins` çš„ `openapi`ã€‚

ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ [@elysiajs/openapi](/plugins/openapi)ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ä»æ›´å¥½çš„èº«ä»½éªŒè¯å®ä¾‹ä¸­æå–æ–‡æ¡£ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç å®ç°ï¼š

```ts
import { openAPI } from 'better-auth/plugins'

let _schema: ReturnType<typeof auth.api.generateOpenAPISchema>
const getSchema = async () => (_schema ??= auth.api.generateOpenAPISchema())

export const OpenAPI = {
    getPaths: (prefix = '/auth/api') =>
        getSchema().then(({ paths }) => {
            const reference: typeof paths = Object.create(null)

            for (const path of Object.keys(paths)) {
                const key = prefix + path
                reference[key] = paths[path]

                for (const method of Object.keys(paths[path])) {
                    const operation = (reference[key] as any)[method]

                    operation.tags = ['Better Auth']
                }
            }

            return reference
        }) as Promise<any>,
    components: getSchema().then(({ components }) => components) as Promise<any>
} as const
```

ç„¶ååœ¨æˆ‘ä»¬ä½¿ç”¨ `@elysiajs/openapi` çš„ Elysia å®ä¾‹ä¸­ã€‚

```ts
import { Elysia } from 'elysia'
import { openapi } from '@elysiajs/openapi'

import { OpenAPI } from './auth'

const app = new Elysia().use(
    openapi({
        documentation: {
            components: await OpenAPI.components,
            paths: await OpenAPI.getPaths()
        }
    })
)
```

## CORS

è¦é…ç½® CORSï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `@elysiajs/cors` ä¸­çš„ `cors` æ’ä»¶ã€‚

```ts
import { Elysia } from 'elysia'
import { cors } from '@elysiajs/cors'

import { auth } from './auth'

const app = new Elysia()
    .use(
        cors({
            origin: 'http://localhost:3001',
            methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
            credentials: true,
            allowedHeaders: ['Content-Type', 'Authorization']
        })
    )
    .mount(auth.handler)
    .listen(3000)

console.log(
    `ğŸ¦Š Elysia is running at ${app.server?.hostname}:${app.server?.port}`
)
```

## å®

æ‚¨å¯ä»¥ç»“åˆä½¿ç”¨ [macro](https://elysiajs.com/patterns/macro.html#macro) å’Œ [resolve](https://elysiajs.com/essential/handler.html#resolve) æ¥åœ¨ä¼ é€’ç»™è§†å›¾ä¹‹å‰æä¾›ä¼šè¯å’Œç”¨æˆ·ä¿¡æ¯ã€‚

```ts
import { Elysia } from 'elysia'
import { auth } from './auth'

// ç”¨æˆ·ä¸­é—´ä»¶ï¼ˆè®¡ç®—ç”¨æˆ·å’Œä¼šè¯å¹¶ä¼ é€’ç»™è·¯ç”±ï¼‰
const betterAuth = new Elysia({ name: 'better-auth' })
    .mount(auth.handler)
    .macro({
        auth: {
            async resolve({ status, request: { headers } }) {
                const session = await auth.api.getSession({
                    headers
                })

                if (!session) return status(401)

                return {
                    user: session.user,
                    session: session.session
                }
            }
        }
    })

const app = new Elysia()
    .use(betterAuth)
    .get('/user', ({ user }) => user, {
        auth: true
    })
    .listen(3000)

console.log(
    `ğŸ¦Š Elysia is running at ${app.server?.hostname}:${app.server?.port}`
)
```

è¿™å°†å…è®¸æ‚¨åœ¨æ‰€æœ‰è·¯ç”±ä¸­è®¿é—® `user` å’Œ `session` å¯¹è±¡ã€‚

---

---
url: 'https://elysiajs.com/migrate.md'
---
# Comparison with Other Frameworks

Elysia is designed to be intuitive and easy to use, especially for those familiar with other web frameworks.

If you have used other popular frameworks like Express, Fastify, or Hono, you will find Elysia right at home with just a few differences.

---

---
url: 'https://elysiajs.com/tutorial/patterns/cookie.md'
---

# Cookie

æ‚¨å¯ä»¥é€šè¿‡ä¸Šä¸‹æ–‡ä¸­çš„ cookie ä¸ cookie è¿›è¡Œäº¤äº’ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ cookie: { visit } }) => {
		const total = +visit.value ?? 0
		visit.value++

		return `æ‚¨å·²è®¿é—® ${visit.value} æ¬¡`
	})
	.listen(3000)
```

Cookie æ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ã€‚ä¸€æ—¦è¢«ä¿®æ”¹ï¼Œå“åº”å°†ä¼šåæ˜ å‡ºè¿™ä¸ªå˜åŒ–ã€‚

## å€¼

å½“æä¾›äº†ç±»å‹æ³¨é‡Šæ—¶ï¼ŒElysia ä¼šå°è¯•å°†å…¶å¼ºåˆ¶è½¬æ¢ä¸ºç›¸åº”çš„å€¼ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ cookie: { visit } }) => {
		visit.value ??= 0
		visit.value.total++

		return `æ‚¨å·²è®¿é—® ${visit.value.total} æ¬¡`
	}, {
		cookie: t.Object({
			visit: t.Optional(
				t.Object({
					total: t.Number()
				})
			)
		})
	})
	.listen(3000)
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ cookie schema æ¥éªŒè¯å’Œè§£æ cookieã€‚

## å±æ€§

æˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶å±æ€§åç§°è·å–æˆ–è®¾ç½® cookie å±æ€§ã€‚

å¦åˆ™ï¼Œä½¿ç”¨ `.set()` æ‰¹é‡è®¾ç½®å±æ€§ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ cookie: { visit } }) => {
		visit.value ??= 0
		visit.value++

		visit.httpOnly = true
		visit.path = '/'

		visit.set({
			sameSite: 'lax',
			secure: true,
			maxAge: 60 * 60 * 24 * 7
		})

		return `æ‚¨å·²è®¿é—® ${visit.value} æ¬¡`
	})
	.listen(3000)
```

è¯·æŸ¥çœ‹ Cookie å±æ€§ã€‚

## ç§»é™¤

æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ `.remove()` æ–¹æ³•æ¥ç§»é™¤ cookieã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ cookie: { visit } }) => {
		visit.remove()

		return `Cookie å·²ç§»é™¤`
	})
	.listen(3000)
```

## Cookie ç­¾å

Elysia å¯ä»¥å¯¹ cookie è¿›è¡Œç­¾åä»¥é˜²æ­¢ç¯¡æ”¹ï¼š

1. å‘ Elysia æ„é€ å‡½æ•°æä¾› cookie ç§˜å¯†ã€‚
2. ä½¿ç”¨ `t.Cookie` ä¸ºæ¯ä¸ª cookie æä¾›ç§˜å¯†ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia({
	cookie: {
		secret: 'Fischl von Luftschloss Narfidort',
	}
})
	.get('/', ({ cookie: { visit } }) => {
		visit.value ??= 0
		visit.value++

		return `æ‚¨å·²è®¿é—® ${visit.value} æ¬¡`
	}, {
		cookie: t.Cookie({
			visit: t.Optional(t.Number())
        }, {
            secrets: 'Fischl von Luftschloss Narfidort',
            sign: ['visit']
        })
	})
	.listen(3000)
```

å¦‚æœæä¾›äº†å¤šä¸ªç§˜å¯†ï¼ŒElysia å°†ä½¿ç”¨ç¬¬ä¸€ä¸ªç§˜å¯†å¯¹ cookie è¿›è¡Œç­¾åï¼Œå¹¶å°è¯•ç”¨å…¶ä½™çš„ç§˜å¯†è¿›è¡ŒéªŒè¯ã€‚

è¯·å‚è§ Cookie ç­¾åï¼ŒCookie è½®æ¢ã€‚

## ä»»åŠ¡

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨ï¼Œç”¨äºè·Ÿè¸ªæ‚¨è®¿é—®ç½‘ç«™çš„æ¬¡æ•°ã€‚

\<template #answer>

1. æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹ `visit.value` æ¥æ›´æ–° cookie å€¼ã€‚
2. æˆ‘ä»¬å¯ä»¥è®¾ç½® **HTTP åªè¯»** å±æ€§ï¼Œé€šè¿‡è®¾ç½® `visit.httpOnly = true`ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/', ({ cookie: { visit } }) => {
		visit.value ??= 0
		visit.value++

		visit.httpOnly = true

		return `æ‚¨å·²è®¿é—® ${visit.value} æ¬¡`
	}, {
		cookie: t.Object({
			visit: t.Optional(
				t.Number()
			)
		})
	})
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/plugins/cors.md'
---

# CORS æ’ä»¶

è¿™ä¸ªæ’ä»¶ä¸ºè‡ªå®šä¹‰ [è·¨æºèµ„æºå…±äº«](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS) è¡Œä¸ºæä¾›æ”¯æŒã€‚

å®‰è£…å‘½ä»¤ï¼š

```bash
bun add @elysiajs/cors
```

ç„¶åä½¿ç”¨å®ƒï¼š

```typescript twoslash
import { Elysia } from 'elysia'
import { cors } from '@elysiajs/cors'

new Elysia().use(cors()).listen(3000)
```

è¿™æ ·å°†ä½¿ Elysia æ¥å—æ¥è‡ªä»»ä½•æºçš„è¯·æ±‚ã€‚

## é…ç½®

ä»¥ä¸‹æ˜¯è¯¥æ’ä»¶æ¥å—çš„é…ç½®

### origin

@é»˜è®¤ `true`

æŒ‡ç¤ºæ˜¯å¦å¯ä»¥ä¸æ¥è‡ªç»™å®šæ¥æºçš„è¯·æ±‚ä»£ç å…±äº«å“åº”ã€‚

å€¼å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š

* **å­—ç¬¦ä¸²** - æºçš„åç§°ï¼Œä¼šç›´æ¥åˆ†é…ç»™ [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin) å¤´éƒ¨ã€‚
* **å¸ƒå°”å€¼** - å¦‚æœè®¾ç½®ä¸º trueï¼Œ [Access-Control-Allow-Origin](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin) å°†è®¾ç½®ä¸º `*`ï¼ˆä»»ä½•æ¥æºï¼‰ã€‚
* **RegExp** - åŒ¹é…è¯·æ±‚ URL çš„æ¨¡å¼ï¼Œå¦‚æœåŒ¹é…åˆ™å…è®¸ã€‚
* **å‡½æ•°** - è‡ªå®šä¹‰é€»è¾‘ä»¥å…è®¸èµ„æºå…±äº«ï¼Œå¦‚æœè¿”å› true åˆ™å…è®¸ã€‚
  * é¢„æœŸå…·æœ‰ä»¥ä¸‹ç±»å‹ï¼š
  ```typescript
  cors(context: Context) => boolean | void
  ```
* **Array\<string | RegExp | Function>** - æŒ‰é¡ºåºè¿­ä»£ä¸Šè¿°æ‰€æœ‰æƒ…å†µï¼Œåªè¦æœ‰ä»»ä½•ä¸€ä¸ªå€¼ä¸º `true` åˆ™å…è®¸ã€‚

***

### methods

@é»˜è®¤ `*`

å…è®¸çš„è·¨æºè¯·æ±‚æ–¹æ³•ã€‚

åˆ†é… [Access-Control-Allow-Methods](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Methods) å¤´éƒ¨ã€‚

å€¼å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š

* **undefined | null | ''** - å¿½ç•¥æ‰€æœ‰æ–¹æ³•ã€‚
* **\*** - å…è®¸æ‰€æœ‰æ–¹æ³•ã€‚
* **å­—ç¬¦ä¸²** - æœŸæœ›å•ä¸ªæ–¹æ³•æˆ–é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
  * (ä¾‹å¦‚: `'GET, PUT, POST'`)
* **string\[]** - å…è®¸å¤šä¸ª HTTP æ–¹æ³•ã€‚
  * ä¾‹å¦‚: `['GET', 'PUT', 'POST']`

***

### allowedHeaders

@é»˜è®¤ `*`

å…è®¸çš„ä¼ å…¥è¯·æ±‚å¤´ã€‚

åˆ†é… [Access-Control-Allow-Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers) å¤´éƒ¨ã€‚

å€¼å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š

* **å­—ç¬¦ä¸²** - æœŸæœ›å•ä¸ªå¤´æˆ–é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
  * ä¾‹å¦‚: `'Content-Type, Authorization'`ã€‚
* **string\[]** - å…è®¸å¤šä¸ª HTTP å¤´ã€‚
  * ä¾‹å¦‚: `['Content-Type', 'Authorization']`

***

### exposeHeaders

@é»˜è®¤ `*`

å“åº” CORS ä¸­åŒ…å«æŒ‡å®šçš„å¤´éƒ¨ã€‚

åˆ†é… [Access-Control-Expose-Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Expose-Headers) å¤´éƒ¨ã€‚

å€¼å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š

* **å­—ç¬¦ä¸²** - æœŸæœ›å•ä¸ªå¤´æˆ–é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ã€‚
  * ä¾‹å¦‚: `'Content-Type, X-Powered-By'`ã€‚
* **string\[]** - å…è®¸å¤šä¸ª HTTP å¤´ã€‚
  * ä¾‹å¦‚: `['Content-Type', 'X-Powered-By']`

***

### credentials

@é»˜è®¤ `true`

Access-Control-Allow-Credentials å“åº”å¤´å‘Šè¯‰æµè§ˆå™¨åœ¨è¯·æ±‚çš„å‡­è¯æ¨¡å¼ [Request.credentials](https://developer.mozilla.org/en-US/docs/Web/API/Request/credentials) ä¸º `include` æ—¶ï¼Œæ˜¯å¦å°†å“åº”æš´éœ²ç»™å‰ç«¯ JavaScript ä»£ç ã€‚

å½“è¯·æ±‚çš„å‡­è¯æ¨¡å¼ [Request.credentials](https://developer.mozilla.org/en-US/docs/Web/API/Request/credentials) ä¸º `include` æ—¶ï¼Œæµè§ˆå™¨ä»…åœ¨ Access-Control-Allow-Credentials å€¼ä¸º true çš„æƒ…å†µä¸‹ï¼Œå°†å“åº”æš´éœ²ç»™å‰ç«¯ JavaScript ä»£ç ã€‚

å‡­è¯åŒ…æ‹¬ cookiesã€æˆæƒå¤´æˆ– TLS å®¢æˆ·ç«¯è¯ä¹¦ã€‚

åˆ†é… [Access-Control-Allow-Credentials](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) å¤´éƒ¨ã€‚

***

### maxAge

@é»˜è®¤ `5`

æŒ‡ç¤º [é¢„æ£€è¯·æ±‚](https://developer.mozilla.org/en-US/docs/Glossary/Preflight_request) çš„ç»“æœï¼ˆå³åŒ…å«åœ¨ [Access-Control-Allow-Methods](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Methods) å’Œ [Access-Control-Allow-Headers](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Headers) å¤´éƒ¨ä¸­çš„ä¿¡æ¯ï¼‰å¯ä»¥ç¼“å­˜å¤šä¹…ã€‚

åˆ†é… [Access-Control-Max-Age](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Max-Age) å¤´éƒ¨ã€‚

***

### preflight

é¢„æ£€è¯·æ±‚æ˜¯ç”¨æ¥æ£€æŸ¥ CORS åè®®æ˜¯å¦è¢«ç†è§£ä»¥åŠæœåŠ¡å™¨æ˜¯å¦çŸ¥é“å¦‚ä½•ä½¿ç”¨ç‰¹å®šæ–¹æ³•å’Œå¤´éƒ¨çš„è¯·æ±‚ã€‚

ä½¿ç”¨ **OPTIONS** è¯·æ±‚çš„å“åº”ä¸­åŒ…å« 3 ä¸ª HTTP è¯·æ±‚å¤´ï¼š

* **Access-Control-Request-Method**
* **Access-Control-Request-Headers**
* **Origin**

æ­¤é…ç½®æŒ‡ç¤ºæœåŠ¡å™¨æ˜¯å¦åº”è¯¥å“åº”é¢„æ£€è¯·æ±‚ã€‚

## ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä½¿ç”¨è¯¥æ’ä»¶çš„å¸¸è§æ¨¡å¼ã€‚

## æŒ‰é¡¶çº§åŸŸåå…è®¸ CORS

```typescript twoslash
import { Elysia } from 'elysia'
import { cors } from '@elysiajs/cors'

const app = new Elysia()
	.use(
		cors({
			origin: /.*\.saltyaom\.com$/
		})
	)
	.get('/', () => 'ä½ å¥½')
	.listen(3000)
```

è¿™å°†å…è®¸æ¥è‡ªé¡¶çº§åŸŸå `saltyaom.com` çš„è¯·æ±‚ã€‚

---

---
url: 'https://elysiajs.com/plugins/cron.md'
---

# Cron æ’ä»¶

æ­¤æ’ä»¶ä¸º Elysia æœåŠ¡å™¨æ·»åŠ äº†è¿è¡Œ cronjob çš„æ”¯æŒã€‚

é€šè¿‡ä»¥ä¸‹æ–¹å¼å®‰è£…ï¼š

```bash
bun add @elysiajs/cron
```

ç„¶åä½¿ç”¨å®ƒï¼š

```typescript twoslash
import { Elysia } from 'elysia'
import { cron } from '@elysiajs/cron'

new Elysia()
	.use(
		cron({
			name: 'heartbeat',
			pattern: '*/10 * * * * *',
			run() {
				console.log('Heartbeat')
			}
		})
	)
	.listen(3000)
```

ä¸Šè¿°ä»£ç å°†æ¯ 10 ç§’è®°å½•ä¸€æ¬¡ `heartbeat`ã€‚

## cron

ä¸º Elysia æœåŠ¡å™¨åˆ›å»ºä¸€ä¸ª cronjobã€‚

ç±»å‹ï¼š

```
cron(config: CronConfig, callback: (Instance['store']) => void): this
```

`CronConfig` æ¥å—ä»¥ä¸‹å‚æ•°ï¼š

### name

æ³¨å†Œåˆ° `store` çš„ä½œä¸šåç§°ã€‚

è¿™å°†ä»¥æŒ‡å®šçš„åç§°å°† cron å®ä¾‹æ³¨å†Œåˆ° `store`ï¼Œå¯ä¾›åç»­è¿‡ç¨‹å¼•ç”¨ï¼Œä¾‹å¦‚åœæ­¢ä½œä¸šã€‚

### pattern

æ ¹æ®ä¸‹é¢çš„ [cron è¯­æ³•](https://en.wikipedia.org/wiki/Cron) æŒ‡å®šä½œä¸šè¿è¡Œæ—¶é—´ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç§’ï¼ˆå¯é€‰ï¼‰
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶
â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€ æ¯æœˆçš„æ—¥æœŸ
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€ æœˆ
â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€ æ˜ŸæœŸå‡ 
â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
* * * * * *
```

å¯ä»¥ä½¿ç”¨ [Crontab Guru](https://crontab.guru/) ç­‰å·¥å…·ç”Ÿæˆã€‚

***

æ­¤æ’ä»¶é€šè¿‡ [cronner](https://github.com/hexagon/croner) æ‰©å±•äº† Elysia çš„ cron æ–¹æ³•ã€‚

ä»¥ä¸‹æ˜¯ cronner æ¥å—çš„é…ç½®ã€‚

### timezone

ä»¥æ¬§æ´²/æ–¯å¾·å“¥å°”æ‘©æ ¼å¼è¡¨ç¤ºçš„æ—¶åŒºã€‚

### startAt

ä½œä¸šçš„è°ƒåº¦å¼€å§‹æ—¶é—´ã€‚

### stopAt

ä½œä¸šçš„è°ƒåº¦åœæ­¢æ—¶é—´ã€‚

### maxRuns

æœ€å¤§æ‰§è¡Œæ¬¡æ•°ã€‚

### catch

å³ä½¿è§¦å‘çš„å‡½æ•°æŠ›å‡ºæœªå¤„ç†é”™è¯¯ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œã€‚

### interval

æ‰§è¡Œä¹‹é—´çš„æœ€å°é—´éš”ï¼ˆç§’ï¼‰ã€‚

## æ¨¡å¼

ä¸‹é¢æ˜¯ä½¿ç”¨è¯¥æ’ä»¶çš„å¸¸ç”¨æ¨¡å¼ã€‚

## åœæ­¢ cronjob

æ‚¨å¯ä»¥é€šè¿‡è®¿é—®æ³¨å†Œåˆ° `store` çš„ cronjob åç§°æ‰‹åŠ¨åœæ­¢ cronjobã€‚

```typescript
import { Elysia } from 'elysia'
import { cron } from '@elysiajs/cron'

const app = new Elysia()
	.use(
		cron({
			name: 'heartbeat',
			pattern: '*/1 * * * * *',
			run() {
				console.log('Heartbeat')
			}
		})
	)
	.get(
		'/stop',
		({
			store: {
				cron: { heartbeat }
			}
		}) => {
			heartbeat.stop()

			return 'Stop heartbeat'
		}
	)
	.listen(3000)
```

## é¢„å®šä¹‰æ¨¡å¼

æ‚¨å¯ä»¥ä½¿ç”¨ `@elysiajs/cron/schedule` ä¸­çš„é¢„å®šä¹‰æ¨¡å¼ã€‚

```typescript
import { Elysia } from 'elysia'
import { cron, Patterns } from '@elysiajs/cron'

const app = new Elysia()
	.use(
		cron({
			name: 'heartbeat',
			pattern: Patterns.everySecond(),
			run() {
				console.log('Heartbeat')
			}
		})
	)
	.get(
		'/stop',
		({
			store: {
				cron: { heartbeat }
			}
		}) => {
			heartbeat.stop()

			return 'Stop heartbeat'
		}
	)
	.listen(3000)
```

### å‡½æ•°

| å‡½æ•°                                   | æè¿°                                                |
| -------------------------------------- | --------------------------------------------------- |
| `.everySeconds(2)`                    | æ¯ 2 ç§’è¿è¡Œä¸€æ¬¡ä»»åŠ¡                                  |
| `.everyMinutes(5)`                    | æ¯ 5 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ä»»åŠ¡                                |
| `.everyHours(3)`                      | æ¯ 3 å°æ—¶è¿è¡Œä¸€æ¬¡ä»»åŠ¡                                |
| `.everyHoursAt(3, 15)`                | æ¯ 3 å°æ—¶åœ¨ 15 åˆ†é’Ÿæ—¶è¿è¡Œä¸€æ¬¡ä»»åŠ¡                   |
| `.everyDayAt('04:19')`                | æ¯å¤©åœ¨ 04:19 è¿è¡Œä¸€æ¬¡ä»»åŠ¡                            |
| `.everyWeekOn(Patterns.MONDAY, '19:30')` | æ¯å‘¨ä¸€åœ¨ 19:30 è¿è¡Œä¸€æ¬¡ä»»åŠ¡                        |
| `.everyWeekdayAt('17:00')`            | æ¯ä¸ªå·¥ä½œæ—¥çš„ 17:00 è¿è¡Œä¸€æ¬¡ä»»åŠ¡                     |
| `.everyWeekendAt('11:00')`            | æ¯å‘¨å…­å’Œå‘¨æ—¥åœ¨ 11:00 è¿è¡Œä¸€æ¬¡ä»»åŠ¡                  |

### å‡½æ•°åˆ«ååˆ°å¸¸é‡

| å‡½æ•°              | å¸¸é‡                           |
| ----------------- | ------------------------------ |
| `.everySecond()`  | EVERY\_SECOND                   |
| `.everyMinute()`  | EVERY\_MINUTE                   |
| `.hourly()`       | EVERY\_HOUR                     |
| `.daily()`        | EVERY\_DAY\_AT\_MIDNIGHT          |
| `.everyWeekday()` | EVERY\_WEEKDAY                  |
| `.everyWeekend()` | EVERY\_WEEKEND                  |
| `.weekly()`       | EVERY\_WEEK                     |
| `.monthly()`      | EVERY\_1ST\_DAY\_OF\_MONTH\_AT\_MIDNIGHT |
| `.everyQuarter()` | EVERY\_QUARTER                  |
| `.yearly()`       | EVERY\_YEAR                     |

### å¸¸é‡

| å¸¸é‡                                    | æ¨¡å¼                    |
| --------------------------------------- | ----------------------- |
| `.EVERY_SECOND`                         | `* * * * * *`           |
| `.EVERY_5_SECONDS`                      | `*/5 * * * * *`         |
| `.EVERY_10_SECONDS`                     | `*/10 * * * * *`        |
| `.EVERY_30_SECONDS`                     | `*/30 * * * * *`        |
| `.EVERY_MINUTE`                         | `*/1 * * * *`           |
| `.EVERY_5_MINUTES`                      | `0 */5 * * * *`         |
| `.EVERY_10_MINUTES`                     | `0 */10 * * * *`        |
| `.EVERY_30_MINUTES`                     | `0 */30 * * * *`        |
| `.EVERY_HOUR`                           | `0 0-23/1 * * *`        |
| `.EVERY_2_HOURS`                        | `0 0-23/2 * * *`        |
| `.EVERY_3_HOURS`                        | `0 0-23/3 * * *`        |
| `.EVERY_4_HOURS`                        | `0 0-23/4 * * *`        |
| `.EVERY_5_HOURS`                        | `0 0-23/5 * * *`        |
| `.EVERY_6_HOURS`                        | `0 0-23/6 * * *`        |
| `.EVERY_7_HOURS`                        | `0 0-23/7 * * *`        |
| `.EVERY_8_HOURS`                        | `0 0-23/8 * * *`        |
| `.EVERY_9_HOURS`                        | `0 0-23/9 * * *`        |
| `.EVERY_10_HOURS`                       | `0 0-23/10 * * *`       |
| `.EVERY_11_HOURS`                       | `0 0-23/11 * * *`       |
| `.EVERY_12_HOURS`                       | `0 0-23/12 * * *`       |
| `.EVERY_DAY_AT_1AM`                     | `0 01 * * *`            |
| `.EVERY_DAY_AT_2AM`                     | `0 02 * * *`            |
| `.EVERY_DAY_AT_3AM`                     | `0 03 * * *`            |
| `.EVERY_DAY_AT_4AM`                     | `0 04 * * *`            |
| `.EVERY_DAY_AT_5AM`                     | `0 05 * * *`            |
| `.EVERY_DAY_AT_6AM`                     | `0 06 * * *`            |
| `.EVERY_DAY_AT_7AM`                     | `0 07 * * *`            |
| `.EVERY_DAY_AT_8AM`                     | `0 08 * * *`            |
| `.EVERY_DAY_AT_9AM`                     | `0 09 * * *`            |
| `.EVERY_DAY_AT_10AM`                    | `0 10 * * *`            |
| `.EVERY_DAY_AT_11AM`                    | `0 11 * * *`            |
| `.EVERY_DAY_AT_NOON`                    | `0 12 * * *`            |
| `.EVERY_DAY_AT_1PM`                     | `0 13 * * *`            |
| `.EVERY_DAY_AT_2PM`                     | `0 14 * * *`            |
| `.EVERY_DAY_AT_3PM`                     | `0 15 * * *`            |
| `.EVERY_DAY_AT_4PM`                     | `0 16 * * *`            |
| `.EVERY_DAY_AT_5PM`                     | `0 17 * * *`            |
| `.EVERY_DAY_AT_6PM`                     | `0 18 * * *`            |
| `.EVERY_DAY_AT_7PM`                     | `0 19 * * *`            |
| `.EVERY_DAY_AT_8PM`                     | `0 20 * * *`            |
| `.EVERY_DAY_AT_9PM`                     | `0 21 * * *`            |
| `.EVERY_DAY_AT_10PM`                    | `0 22 * * *`            |
| `.EVERY_DAY_AT_11PM`                    | `0 23 * * *`            |
| `.EVERY_DAY_AT_MIDNIGHT`                | `0 0 * * *`             |
| `.EVERY_WEEK`                           | `0 0 * * 0`             |
| `.EVERY_WEEKDAY`                        | `0 0 * * 1-5`           |
| `.EVERY_WEEKEND`                        | `0 0 * * 6,0`           |
| `.EVERY_1ST_DAY_OF_MONTH_AT_MIDNIGHT`   | `0 0 1 * *`             |
| `.EVERY_1ST_DAY_OF_MONTH_AT_NOON`       | `0 12 1 * *`            |
| `.EVERY_2ND_HOUR`                       | `0 */2 * * *`           |
| `.EVERY_2ND_HOUR_FROM_1AM_THROUGH_11PM` | `0 1-23/2 * * *`        |
| `.EVERY_2ND_MONTH`                      | `0 0 1 */2 *`           |
| `.EVERY_QUARTER`                        | `0 0 1 */3 *`           |
| `.EVERY_6_MONTHS`                       | `0 0 1 */6 *`           |
| `.EVERY_YEAR`                           | `0 0 1 1 *`             |
| `.EVERY_30_MINUTES_BETWEEN_9AM_AND_5PM` | `0 */30 9-17 * * *`     |
| `.EVERY_30_MINUTES_BETWEEN_9AM_AND_6PM` | `0 */30 9-18 * * *`     |
| `.EVERY_30_MINUTES_BETWEEN_10AM_AND_7PM`| `0 */30 10-19 * * *`    |

---

---
url: 'https://elysiajs.com/eden/fetch.md'
---

# Eden Fetch

ä¸€ä¸ªåƒ Fetch çš„æ›¿ä»£å“ï¼Œä¸ Eden Treaty ç›¸æ¯”ã€‚

ä½¿ç”¨ Eden Fetchï¼Œå¯ä»¥ä½¿ç”¨ Fetch API ä»¥ç±»å‹å®‰å…¨çš„æ–¹å¼ä¸ Elysia æœåŠ¡å™¨äº¤äº’ã€‚

***

é¦–å…ˆå¯¼å‡ºæ‚¨ç°æœ‰çš„ Elysia æœåŠ¡å™¨ç±»å‹ï¼š

```typescript
// server.ts
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .get('/hi', () => 'Hi Elysia')
    .get('/id/:id', ({ params: { id } }) => id)
    .post('/mirror', ({ body }) => body, {
        body: t.Object({
            id: t.Number(),
            name: t.String()
        })
    })
    .listen(3000)

export type App = typeof app
```

ç„¶åå¯¼å…¥æœåŠ¡å™¨ç±»å‹ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ Elysia APIï¼š

```typescript
import { edenFetch } from '@elysiajs/eden'
import type { App } from './server'

const fetch = edenFetch<App>('http://localhost:3000')

// å“åº”ç±»å‹: 'Hi Elysia'
const pong = await fetch('/hi', {})

// å“åº”ç±»å‹: 1895
const id = await fetch('/id/:id', {
    params: {
        id: '1895'
    }
})

// å“åº”ç±»å‹: { id: 1895, name: 'Skadi' }
const nendoroid = await fetch('/mirror', {
    method: 'POST',
    body: {
        id: 1895,
        name: 'Skadi'
    }
})
```

## é”™è¯¯å¤„ç†

æ‚¨å¯ä»¥åƒå¤„ç† Eden Treaty ä¸€æ ·å¤„ç†é”™è¯¯ï¼š

```typescript
import { edenFetch } from '@elysiajs/eden'
import type { App } from './server'

const fetch = edenFetch<App>('http://localhost:3000')

// å“åº”ç±»å‹: { id: 1895, name: 'Skadi' }
const { data: nendoroid, error } = await fetch('/mirror', {
    method: 'POST',
    body: {
        id: 1895,
        name: 'Skadi'
    }
})

if(error) {
    switch(error.status) {
        case 400:
        case 401:
            throw error.value
            break

        case 500:
        case 502:
            throw error.value
            break

        default:
            throw error.value
            break
    }
}

const { id, name } = nendoroid
```

## ä½•æ—¶åº”è¯¥ä½¿ç”¨ Eden Fetch è€Œä¸æ˜¯ Eden Treaty

ä¸ Elysia < 1.0 ä¸åŒï¼ŒEden Fetch ç°åœ¨å¹¶ä¸æ¯” Eden Treaty æ›´å¿«ã€‚

é€‰æ‹©å–å†³äºæ‚¨å’Œæ‚¨çš„å›¢é˜Ÿçš„åè®®ï¼Œç„¶è€Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ [Eden Treaty](/eden/treaty/overview)ã€‚

å¯¹äº Elysia < 1.0ï¼š

ä½¿ç”¨ Eden Treaty éœ€è¦å¤§é‡çš„é™çº§è¿­ä»£æ¥ä¸€æ¬¡æ€§æ˜ å°„æ‰€æœ‰å¯èƒ½çš„ç±»å‹ï¼Œè€Œç›¸åï¼ŒEden Fetch å¯ä»¥å»¶è¿Ÿæ‰§è¡Œï¼Œç›´åˆ°æ‚¨é€‰æ‹©ä¸€ä¸ªè·¯ç”±ã€‚

å¯¹äºå¤æ‚çš„ç±»å‹å’Œå¤§é‡çš„æœåŠ¡å™¨è·¯ç”±ï¼Œåœ¨ä½ç«¯å¼€å‘è®¾å¤‡ä¸Šä½¿ç”¨ Eden Treaty å¯èƒ½å¯¼è‡´ç±»å‹æ¨æ–­å’Œè‡ªåŠ¨è¡¥å…¨å˜æ…¢ã€‚

ä½†éšç€ Elysia è°ƒæ•´å’Œä¼˜åŒ–äº†å¾ˆå¤šç±»å‹å’Œæ¨æ–­ï¼ŒEden Treaty åœ¨å¤§é‡è·¯ç”±ä¸­è¡¨ç°å¾—éå¸¸å¥½ã€‚

å¦‚æœæ‚¨çš„å•ä¸ªè¿›ç¨‹åŒ…å« **è¶…è¿‡ 500 ä¸ªè·¯ç”±**ï¼Œè€Œæ‚¨éœ€è¦åœ¨ **å•ä¸ªå‰ç«¯ä»£ç åº“ä¸­ä½¿ç”¨æ‰€æœ‰è·¯ç”±**ï¼Œé‚£ä¹ˆæ‚¨å¯èƒ½æƒ³è¦ä½¿ç”¨ Eden Fetchï¼Œå› ä¸ºå®ƒçš„ TypeScript æ€§èƒ½æ˜¾è‘—ä¼˜äº Eden Treatyã€‚

---

---
url: 'https://elysiajs.com/eden/treaty/parameters.md'
---

# å‚æ•°

æˆ‘ä»¬æœ€ç»ˆéœ€è¦å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªæœ‰æ•ˆè½½è·ã€‚

ä¸ºæ­¤ï¼ŒEden Treaty çš„æ–¹æ³•æ¥å— 2 ä¸ªå‚æ•°æ¥å‘é€æ•°æ®åˆ°æœåŠ¡å™¨ã€‚

è¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯ç±»å‹å®‰å…¨çš„ï¼Œå¹¶å°†ç”± TypeScript è‡ªåŠ¨æŒ‡å¯¼ï¼š

1. body
2. å…¶ä»–å‚æ•°
   * query
   * headers
   * fetch

```typescript
import { Elysia, t } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
    .post('/user', ({ body }) => body, {
        body: t.Object({
            name: t.String()
        })
    })
    .listen(3000)

const api = treaty<typeof app>('localhost:3000')

// âœ… æœ‰æ•ˆ
api.user.post({
    name: 'Elysia'
})

// âœ… ä¹Ÿæœ‰æ•ˆ
api.user.post({
    name: 'Elysia'
}, {
    // åœ¨æ¨¡å¼ä¸­æœªæŒ‡å®šï¼Œè¿™æ˜¯å¯é€‰çš„
    headers: {
        authorization: 'Bearer 12345'
    },
    query: {
        id: 2
    }
})
```

é™¤éæ–¹æ³•ä¸æ¥å— bodyï¼Œå¦åˆ™å°†çœç•¥ bodyï¼Œä»…ä¿ç•™ä¸€ä¸ªå‚æ•°ã€‚

å¦‚æœæ–¹æ³•ä¸º **"GET"** æˆ– **"HEAD"**ï¼š

1. å…¶ä»–å‚æ•°
   * query
   * headers
   * fetch

```typescript
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
    .get('/hello', () => 'hi')
    .listen(3000)

const api = treaty<typeof app>('localhost:3000')

// âœ… æœ‰æ•ˆ
api.hello.get({
    // åœ¨æ¨¡å¼ä¸­æœªæŒ‡å®šï¼Œè¿™æ˜¯å¯é€‰çš„
    headers: {
        hello: 'world'
    }
})
```

## ç©ºçš„ body

å¦‚æœ body å¯é€‰æˆ–ä¸éœ€è¦ï¼Œä½† query æˆ– headers æ˜¯å¿…éœ€çš„ï¼Œåˆ™å¯ä»¥å°† body ä¼ é€’ä¸º `null` æˆ– `undefined`ã€‚

```typescript
import { Elysia, t } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
    .post('/user', () => 'hi', {
        query: t.Object({
            name: t.String()
        })
    })
    .listen(3000)

const api = treaty<typeof app>('localhost:3000')

api.user.post(null, {
    query: {
        name: 'Ely'
    }
})
```

## Fetch å‚æ•°

Eden Treaty æ˜¯ä¸€ä¸ª fetch å°è£…ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†æœ‰æ•ˆçš„ [Fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch) å‚æ•°ä¼ é€’ç»™ `$fetch` æ¥æ·»åŠ åˆ° Eden ä¸­ï¼š

```typescript
import { Elysia, t } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
    .get('/hello', () => 'hi')
    .listen(3000)

const api = treaty<typeof app>('localhost:3000')

const controller = new AbortController()

const cancelRequest = setTimeout(() => {
    controller.abort()
}, 5000)

await api.hello.get({
    fetch: {
        signal: controller.signal
    }
})

clearTimeout(cancelRequest)
```

## æ–‡ä»¶ä¸Šä¼ 

æˆ‘ä»¬å¯ä»¥ä¼ é€’ä»¥ä¸‹ä»»ä¸€é¡¹æ¥é™„åŠ æ–‡ä»¶ï¼š

* **File**
* **File\[]**
* **FileList**
* **Blob**

é™„åŠ æ–‡ä»¶å°†ä½¿ **content-type** å˜ä¸º **multipart/form-data**

å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„æœåŠ¡å™¨ï¼š

```typescript
import { Elysia, t } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
    .post('/image', ({ body: { image, title } }) => title, {
        body: t.Object({
            title: t.String(),
            image: t.Files()
        })
    })
    .listen(3000)

export const api = treaty<typeof app>('localhost:3000')

const images = document.getElementById('images') as HTMLInputElement

const { data } = await api.image.post({
    title: "Misono Mika",
    image: images.files!,
})
```

---

---
url: 'https://elysiajs.com/eden/treaty/response.md'
---

# å“åº”

ä¸€æ—¦è°ƒç”¨ fetch æ–¹æ³•ï¼ŒEden Treaty ä¼šè¿”å›ä¸€ä¸ªåŒ…å«ä»¥ä¸‹å±æ€§çš„å¯¹è±¡çš„ `Promise`ï¼š

* data - å“åº”è¿”å›çš„å€¼ï¼ˆ2xxï¼‰
* error - å“åº”è¿”å›çš„é”™è¯¯å€¼ï¼ˆ>= 3xxï¼‰
* response `Response` - Web æ ‡å‡†çš„ Response ç±»
* status `number` - HTTP çŠ¶æ€ç 
* headers `FetchRequestInit['headers']` - å“åº”å¤´ä¿¡æ¯

è¿”å›åï¼Œæ‚¨å¿…é¡»è¿›è¡Œé”™è¯¯å¤„ç†ä»¥ç¡®ä¿å“åº”æ•°æ®å€¼è¢«è§£åŒ…ï¼Œå¦åˆ™è¯¥å€¼å°†ä¸ºå¯ç©ºã€‚Elysia æä¾›äº† `error()` è¾…åŠ©å‡½æ•°æ¥å¤„ç†é”™è¯¯ï¼ŒEden ä¼šä¸ºé”™è¯¯å€¼æä¾›ç±»å‹æ”¶çª„ã€‚

```typescript
import { Elysia, t } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
    .post('/user', ({ body: { name }, status }) => {
        if(name === 'Otto') return status(400)

        return name
    }, {
        body: t.Object({
            name: t.String()
        })
    })
    .listen(3000)

const api = treaty<typeof app>('localhost:3000')

const submit = async (name: string) => {
    const { data, error } = await api.user.post({
        name
    })

    // ç±»å‹: string | null
    console.log(data)

    if (error)
        switch(error.status) {
            case 400:
                // é”™è¯¯ç±»å‹å°†è¢«æ”¶çª„
                throw error.value

            default:
                throw error.value
        }

    // ä¸€æ—¦é”™è¯¯è¢«å¤„ç†ï¼Œç±»å‹å°†è¢«è§£åŒ…
    // ç±»å‹: string
    return data
}
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia ä¼šè‡ªåŠ¨æ¨æ–­ `error` å’Œ `response` çš„ç±»å‹åˆ° TypeScriptï¼ŒEden å°†æä¾›è‡ªåŠ¨è¡¥å…¨å’Œç±»å‹æ”¶çª„ä»¥å®ç°å‡†ç¡®çš„è¡Œä¸ºã€‚

::: tip
å¦‚æœæœåŠ¡å™¨å“åº”çš„ HTTP çŠ¶æ€ç  >= 300ï¼Œåˆ™å€¼å§‹ç»ˆä¸º `null`ï¼Œè€Œ `error` ä¼šåŒ…å«è¿”å›çš„å€¼ã€‚

å¦åˆ™ï¼Œå“åº”å€¼å°†ä¼ é€’ç»™ `data`ã€‚
:::

## æµå“åº”

Eden ä¼šå°†æµå“åº”æˆ– [æœåŠ¡å™¨å‘é€äº‹ä»¶ (Server-Sent Events)](/essential/handler.html#server-sent-events-sse) è§£é‡Šä¸º `AsyncGenerator`ï¼Œå…è®¸æˆ‘ä»¬ä½¿ç”¨ `for await` å¾ªç¯æ¥æ¶ˆè´¹è¯¥æµã€‚

::: code-group

```typescript twoslash [æµ]
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
	.get('/ok', function* () {
		yield 1
		yield 2
		yield 3
	})

const { data, error } = await treaty(app).ok.get()
if (error) throw error

for await (const chunk of data)
	console.log(chunk)
               // ^?
```

```typescript twoslash [æœåŠ¡å™¨å‘é€äº‹ä»¶]
import { Elysia, sse } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
	.get('/ok', function* () {
		yield sse({
			event: 'message',
			data: 1
		})
		yield sse({
			event: 'message',
			data: 2
		})
		yield sse({
			event: 'end'
		})
	})

const { data, error } = await treaty(app).ok.get()
if (error) throw error

for await (const chunk of data)
	console.log(chunk)
               // ^?







//
```

:::

## å·¥å…·ç±»å‹

Eden Treaty æä¾›äº†å·¥å…·ç±»å‹ `Treaty.Data<T>` å’Œ `Treaty.Error<T>` æ¥æå–å“åº”ä¸­çš„ `data` å’Œ `error` ç±»å‹ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

import { treaty, Treaty } from '@elysiajs/eden'

const app = new Elysia()
	.post('/user', ({ body: { name }, status }) => {
		if(name === 'Otto') return status(400)

		return name
	}, {
		body: t.Object({
			name: t.String()
		})
	})
	.listen(3000)

const api =
	treaty<typeof app>('localhost:3000')

type UserData = Treaty.Data<typeof api.user.post>
//     ^?


// æˆ–è€…ä½ ä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªå“åº”å¯¹è±¡
const response = await api.user.post({
	name: 'Saltyaom'
})

type UserDataFromResponse = Treaty.Data<typeof response>
//     ^?



type UserError = Treaty.Error<typeof api.user.post>
//     ^?












//
```

---

---
url: 'https://elysiajs.com/eden/treaty/config.md'
---

# é…ç½®

Eden Treaty æ¥å— 2 ä¸ªå‚æ•°ï¼š

* **urlOrInstance** - URL ç»ˆç«¯æˆ– Elysia å®ä¾‹
* **options**ï¼ˆå¯é€‰ï¼‰ - è‡ªå®šä¹‰è·å–è¡Œä¸º

## urlOrInstance

æ¥å— URL ç»ˆç«¯ä½œä¸ºå­—ç¬¦ä¸²æˆ–å­—é¢é‡ Elysia å®ä¾‹ã€‚

Eden ä¼šæ ¹æ®ç±»å‹æ”¹å˜è¡Œä¸ºå¦‚ä¸‹ï¼š

### URL ç»ˆç«¯ (å­—ç¬¦ä¸²)

å¦‚æœä¼ å…¥ URL ç»ˆç«¯ï¼ŒEden Treaty å°†ä½¿ç”¨ `fetch` æˆ– `config.fetcher` åˆ›å»ºå¯¹ Elysia å®ä¾‹çš„ç½‘ç»œè¯·æ±‚ã€‚

```typescript
import { treaty } from '@elysiajs/eden'
import type { App } from './server'

const api = treaty<App>('localhost:3000')
```

ä½ å¯ä»¥é€‰æ‹©æ˜¯å¦ä¸º URL ç»ˆç«¯æŒ‡å®šåè®®ã€‚

Elysia å°†è‡ªåŠ¨é™„åŠ ç»ˆç«¯å¦‚ä¸‹ï¼š

1. å¦‚æœæŒ‡å®šäº†åè®®ï¼Œç›´æ¥ä½¿ç”¨è¯¥ URL
2. å¦‚æœ URL æ˜¯ localhost å¹¶ä¸” ENV ä¸æ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œä½¿ç”¨ http
3. å¦åˆ™ä½¿ç”¨ https

è¿™åŒæ ·é€‚ç”¨äº Web Socketï¼Œä»¥ç¡®å®šä½¿ç”¨ **ws://** è¿˜æ˜¯ **wss://**ã€‚

***

### Elysia å®ä¾‹

å¦‚æœä¼ å…¥ Elysia å®ä¾‹ï¼ŒEden Treaty å°†åˆ›å»ºä¸€ä¸ª `Request` ç±»ï¼Œå¹¶ç›´æ¥ä¼ é€’åˆ° `Elysia.handle`ï¼Œè€Œæ— éœ€åˆ›å»ºç½‘ç»œè¯·æ±‚ã€‚

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥ä¸ Elysia æœåŠ¡å™¨äº¤äº’ï¼Œè€Œæ— éœ€è¯·æ±‚å¼€é”€æˆ–å¯åŠ¨æœåŠ¡å™¨ã€‚

```typescript
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
    .get('/hi', 'Hi Elysia')
    .listen(3000)

const api = treaty(app)
```

å¦‚æœä¼ å…¥å®ä¾‹ï¼Œåˆ™ä¸éœ€è¦ä¼ é€’æ³›å‹ï¼Œå› ä¸º Eden Treaty å¯ä»¥ç›´æ¥ä»å‚æ•°ä¸­æ¨æ–­ç±»å‹ã€‚

è¿™ç§æ¨¡å¼æ¨èç”¨äºæ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œæˆ–åˆ›å»ºç±»å‹å®‰å…¨çš„åå‘ä»£ç†æœåŠ¡å™¨æˆ–å¾®æœåŠ¡ã€‚

## é€‰é¡¹

Eden Treaty çš„ç¬¬äºŒä¸ªå¯é€‰å‚æ•°ç”¨äºè‡ªå®šä¹‰è·å–è¡Œä¸ºï¼Œæ¥å—ä»¥ä¸‹å‚æ•°ï¼š

* [fetch](#fetch) - æ·»åŠ é»˜è®¤å‚æ•°åˆ°è·å–åˆå§‹åŒ–ï¼ˆRequestInitï¼‰
* [headers](#headers) - å®šä¹‰é»˜è®¤å¤´éƒ¨
* [fetcher](#fetcher) - è‡ªå®šä¹‰è·å–å‡½æ•°ï¼Œä¾‹å¦‚ Axiosï¼Œunfetch
* [onRequest](#onrequest) - åœ¨å‘é€è¯·æ±‚å‰æ‹¦æˆªå¹¶ä¿®æ”¹è·å–è¯·æ±‚
* [onResponse](#onresponse) - åœ¨è·å–å“åº”åæ‹¦æˆªå¹¶ä¿®æ”¹å“åº”

## è·å–

é»˜è®¤å‚æ•°é™„åŠ åˆ° fetch çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ‰©å±•ç±»å‹ä¸º **Fetch.RequestInit**ã€‚

```typescript
export type App = typeof app // [!code ++]
import { treaty } from '@elysiajs/eden'
// ---cut---
treaty<App>('localhost:3000', {
    fetch: {
        credentials: 'include'
    }
})
```

æ‰€æœ‰ä¼ é€’ç»™ fetch çš„å‚æ•°ï¼Œå°†ä½œä¸ºç­‰ä»·ä¼ é€’ç»™ fetcherï¼š

```typescript
fetch('http://localhost:3000', {
    credentials: 'include'
})
```

## å¤´éƒ¨

æä¾›é¢å¤–çš„é»˜è®¤å¤´éƒ¨åˆ° fetchï¼Œä¸º `options.fetch.headers` çš„ç®€å†™ã€‚

```typescript
treaty<App>('localhost:3000', {
    headers: {
        'X-Custom': 'Griseo'
    }
})
```

æ‰€æœ‰ä¼ é€’ç»™ fetch çš„å‚æ•°ï¼Œå°†ä½œä¸ºç­‰ä»·ä¼ é€’ç»™ fetcherï¼š

```typescript twoslash
fetch('localhost:3000', {
    headers: {
        'X-Custom': 'Griseo'
    }
})
```

å¤´éƒ¨å¯ä»¥æ¥å—ä»¥ä¸‹å‚æ•°ï¼š

* å¯¹è±¡
* å‡½æ•°

### å¤´éƒ¨å¯¹è±¡

å¦‚æœä¼ å…¥å¯¹è±¡ï¼Œåˆ™å°†ç›´æ¥ä¼ é€’åˆ° fetch

```typescript
treaty<App>('localhost:3000', {
    headers: {
        'X-Custom': 'Griseo'
    }
})
```

### å‡½æ•°

ä½ å¯ä»¥å°†å¤´éƒ¨æŒ‡å®šä¸ºå‡½æ•°ï¼Œä»¥æ ¹æ®æ¡ä»¶è¿”å›è‡ªå®šä¹‰å¤´éƒ¨ã€‚

```typescript
treaty<App>('localhost:3000', {
    headers(path, options) {
        if(path.startsWith('user'))
            return {
                authorization: 'Bearer 12345'
            }
    }
})
```

ä½ å¯ä»¥è¿”å›å¯¹è±¡ä»¥å°†å…¶å€¼è¿½åŠ åˆ° fetch å¤´éƒ¨ã€‚

å¤´éƒ¨å‡½æ•°æ¥å— 2 ä¸ªå‚æ•°ï¼š

* path `string` - å°†å‘é€åˆ°å‚æ•°çš„è·¯å¾„
  * æ³¨æ„ï¼šä¸»æœºåå°†è¢« **æ’é™¤**ï¼Œä¾‹å¦‚ï¼ˆ/user/griseoï¼‰
* options `RequestInit`: é€šè¿‡ fetch çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥çš„å‚æ•°

### æ•°ç»„

å¦‚æœéœ€è¦å¤šä¸ªæ¡ä»¶ï¼Œæ‚¨å¯ä»¥å°† headers å‡½æ•°å®šä¹‰ä¸ºæ•°ç»„ã€‚

```typescript
treaty<App>('localhost:3000', {
    headers: [
      (path, options) => {
        if(path.startsWith('user'))
            return {
                authorization: 'Bearer 12345'
            }
        }
    ]
})
```

Eden Treaty å°† **è¿è¡Œæ‰€æœ‰å‡½æ•°**ï¼Œå³ä½¿å€¼å·²ç»è¿”å›ã€‚

## å¤´éƒ¨ä¼˜å…ˆçº§

Eden Treaty å°†ä¼˜å…ˆè€ƒè™‘å¤´éƒ¨çš„é¡ºåºï¼Œå¦‚æœé‡å¤å¦‚ä¸‹ï¼š

1. å†…è”æ–¹æ³• - ç›´æ¥ä¼ é€’çš„æ–¹æ³•å‡½æ•°
2. headers - ä¼ é€’ç»™ `config.headers`

* å¦‚æœ `config.headers` æ˜¯æ•°ç»„ï¼Œåˆ™åæ¥çš„å‚æ•°å°†è¢«ä¼˜å…ˆè€ƒè™‘

3. fetch - ä¼ é€’ç»™ `config.fetch.headers`

ä¾‹å¦‚ï¼Œå¯¹äºä»¥ä¸‹ç¤ºä¾‹ï¼š

```typescript
const api = treaty<App>('localhost:3000', {
    headers: {
        authorization: 'Bearer Aponia'
    }
})

api.profile.get({
    headers: {
        authorization: 'Bearer Griseo'
    }
})
```

è¿™å°†å¯¼è‡´ä»¥ä¸‹ç»“æœï¼š

```typescript
fetch('http://localhost:3000', {
    headers: {
        authorization: 'Bearer Griseo'
    }
})
```

å¦‚æœå†…è”å‡½æ•°æœªæŒ‡å®šå¤´éƒ¨ï¼Œåˆ™ç»“æœå°†æ˜¯ "**Bearer Aponia**"ã€‚

## Fetcher

æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„è·å–å‡½æ•°ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç¯å¢ƒçš„é»˜è®¤ fetchã€‚

```typescript
treaty<App>('localhost:3000', {
    fetcher(url, options) {
        return fetch(url, options)
    }
})
```

å¦‚æœä½ æƒ³ä½¿ç”¨å…¶ä»–å®¢æˆ·ç«¯è€Œä¸æ˜¯ fetchï¼Œå»ºè®®æ›¿æ¢ fetchï¼Œä¾‹å¦‚ Axiosï¼Œunfetchã€‚

## OnRequest

åœ¨å‘é€è¯·æ±‚å‰æ‹¦æˆªå¹¶ä¿®æ”¹è·å–è¯·æ±‚ã€‚

ä½ å¯ä»¥è¿”å›å¯¹è±¡ä»¥å°†å€¼è¿½åŠ åˆ° **RequestInit**ã€‚

```typescript
treaty<App>('localhost:3000', {
    onRequest(path, options) {
        if(path.startsWith('user'))
            return {
                headers: {
                    authorization: 'Bearer 12345'
                }
            }
    }
})
```

å¦‚æœè¿”å›äº†å€¼ï¼ŒEden Treaty å°†å¯¹è¿”å›çš„å€¼å’Œ `value.headers` è¿›è¡Œ **æµ…åˆå¹¶**ã€‚

**onRequest** æ¥å— 2 ä¸ªå‚æ•°ï¼š

* path `string` - å°†å‘é€åˆ°å‚æ•°çš„è·¯å¾„
  * æ³¨æ„ï¼šä¸»æœºåå°†è¢« **æ’é™¤**ï¼Œä¾‹å¦‚ï¼ˆ/user/griseoï¼‰
* options `RequestInit`: é€šè¿‡ fetch çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥çš„å‚æ•°

### æ•°ç»„

å¦‚æœéœ€è¦å¤šä¸ªæ¡ä»¶ï¼Œä½ å¯ä»¥å°† onRequest å‡½æ•°å®šä¹‰ä¸ºæ•°ç»„ã€‚

```typescript
treaty<App>('localhost:3000', {
    onRequest: [
      (path, options) => {
        if(path.startsWith('user'))
            return {
                headers: {
                    authorization: 'Bearer 12345'
                }
            }
        }
    ]
})
```

Eden Treaty å°† **è¿è¡Œæ‰€æœ‰å‡½æ•°**ï¼Œå³ä½¿å€¼å·²ç»è¿”å›ã€‚

## onResponse

æ‹¦æˆªå¹¶ä¿®æ”¹ fetch çš„å“åº”æˆ–è¿”å›æ–°å€¼ã€‚

```typescript
treaty<App>('localhost:3000', {
    onResponse(response) {
        if(response.ok)
            return response.json()
    }
})
```

**onResponse** æ¥å— 1 ä¸ªå‚æ•°ï¼š

* response `Response` - é€šå¸¸ä» `fetch` è¿”å›çš„ Web æ ‡å‡†å“åº”

### æ•°ç»„

å¦‚æœéœ€è¦å¤šä¸ªæ¡ä»¶ï¼Œä½ å¯ä»¥å°† onResponse å‡½æ•°å®šä¹‰ä¸ºæ•°ç»„ã€‚

```typescript
treaty<App>('localhost:3000', {
    onResponse: [
        (response) => {
            if(response.ok)
                return response.json()
        }
    ]
})
```

ä¸ [headers](#headers) å’Œ [onRequest](#onrequest) ä¸åŒï¼ŒEden Treaty å°†å¾ªç¯æ‰§è¡Œå‡½æ•°ï¼Œç›´åˆ°æ‰¾åˆ°è¿”å›çš„å€¼æˆ–æŠ›å‡ºé”™è¯¯ï¼Œè¿”å›çš„å€¼å°†ç”¨ä½œæ–°å“åº”ã€‚

---

---
url: 'https://elysiajs.com/eden/installation.md'
---

# Eden å®‰è£…

é¦–å…ˆé€šè¿‡ä»¥ä¸‹å‘½ä»¤åœ¨ä½ çš„å‰ç«¯å®‰è£… Edenï¼š

```bash
bun add @elysiajs/eden
bun add -d elysia
```

::: tip
Eden éœ€è¦ Elysia æ¥æ¨æ–­å·¥å…·çš„ç±»å‹ã€‚

ç¡®ä¿å®‰è£…çš„ Elysia ç‰ˆæœ¬ä¸æœåŠ¡å™¨åŒ¹é…ã€‚
:::

é¦–å…ˆï¼Œå¯¼å‡ºä½ ç°æœ‰çš„ Elysia æœåŠ¡å™¨ç±»å‹ï¼š

```typescript
// server.ts
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .get('/', () => 'å—¨ Elysia')
    .get('/id/:id', ({ params: { id } }) => id)
    .post('/mirror', ({ body }) => body, {
        body: t.Object({
            id: t.Number(),
            name: t.String()
        })
    })
    .listen(3000)

export type App = typeof app // [!code ++]
```

ç„¶ååœ¨å®¢æˆ·ç«¯ä½¿ç”¨ Elysia APIï¼š

```typescript twoslash
// @filename: server.ts
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .get('/', 'å—¨ Elysia')
    .get('/id/:id', ({ params: { id } }) => id)
    .post('/mirror', ({ body }) => body, {
        body: t.Object({
            id: t.Number(),
            name: t.String()
        })
    })
    .listen(3000)

export type App = typeof app // [!code ++]

// @filename: index.ts
// ---cut---
// client.ts
import { treaty } from '@elysiajs/eden'
import type { App } from './server' // [!code ++]

const client = treaty<App>('localhost:3000') // [!code ++]

// å“åº”: å—¨ Elysia
const { data: index } = await client.get()

// å“åº”: 1895
const { data: id } = await client.id({ id: 1895 }).get()

// å“åº”: { id: 1895, name: 'Skadi' }
const { data: nendoroid } = await client.mirror.post({
    id: 1895,
    name: 'Skadi'
})

// @noErrors
client.
//     ^|
```

## æ³¨æ„äº‹é¡¹

æœ‰æ—¶ï¼ŒEden å¯èƒ½æ— æ³•æ­£ç¡®ä» Elysia æ¨æ–­ç±»å‹ï¼Œä»¥ä¸‹æ˜¯è§£å†³ Eden ç±»å‹æ¨æ–­é—®é¢˜çš„æœ€å¸¸è§æ–¹æ³•ã€‚

### ç±»å‹ä¸¥æ ¼

ç¡®ä¿åœ¨ **tsconfig.json** ä¸­å¯ç”¨ä¸¥æ ¼æ¨¡å¼

```json
{
  "compilerOptions": {
    "strict": true // [!code ++]
  }
}
```

### Elysia ç‰ˆæœ¬ä¸åŒ¹é…

Eden ä¾èµ– Elysia ç±»æ¥å¯¼å…¥ Elysia å®ä¾‹å¹¶æ­£ç¡®æ¨æ–­ç±»å‹ã€‚

ç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä½¿ç”¨åŒ¹é…çš„ Elysia ç‰ˆæœ¬ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ [`npm why`](https://docs.npmjs.com/cli/v10/commands/npm-explain) å‘½ä»¤æ£€æŸ¥å®ƒï¼š

```bash
npm why elysia
```

å¹¶ä¸”è¾“å‡ºåº”ä»…åŒ…å«ä¸€ä¸ªé¡¶å±‚çš„ elysia ç‰ˆæœ¬ï¼š

```
elysia@1.1.12
node_modules/elysia
  elysia@"1.1.25" from the root project
  peer elysia@">= 1.1.0" from @elysiajs/html@1.1.0
  node_modules/@elysiajs/html
    dev @elysiajs/html@"1.1.1" from the root project
  peer elysia@">= 1.1.0" from @elysiajs/opentelemetry@1.1.2
  node_modules/@elysiajs/opentelemetry
    dev @elysiajs/opentelemetry@"1.1.7" from the root project
  peer elysia@">= 1.1.0" from @elysiajs/swagger@1.1.0
  node_modules/@elysiajs/swagger
    dev @elysiajs/swagger@"1.1.6" from the root project
  peer elysia@">= 1.1.0" from @elysiajs/eden@1.1.2
  node_modules/@elysiajs/eden
    dev @elysiajs/eden@"1.1.3" from the root project
```

### TypeScript ç‰ˆæœ¬

Elysia ä½¿ç”¨äº†è¾ƒæ–°çš„ TypeScript åŠŸèƒ½å’Œè¯­æ³•æ¥å®ç°é«˜æ•ˆçš„ç±»å‹æ¨æ–­ã€‚åƒ Const Generic å’Œ Template Literal è¿™æ ·çš„ç‰¹æ€§è¢«å¹¿æ³›ä½¿ç”¨ã€‚

ç¡®ä¿ä½ çš„å®¢æˆ·ç«¯ä½¿ç”¨çš„ TypeScript ç‰ˆæœ¬æœ€ä½ä¸º **5.0** æˆ–æ›´é«˜ã€‚

### æ–¹æ³•é“¾è°ƒç”¨

ä¸ºäº†ä½¿ Eden æ­£ç¡®å·¥ä½œï¼ŒElysia å¿…é¡»ä½¿ç”¨ **æ–¹æ³•é“¾è°ƒç”¨**

Elysia çš„ç±»å‹ç³»ç»Ÿéå¸¸å¤æ‚ï¼Œæ–¹æ³•é€šå¸¸ä¼šä¸ºå®ä¾‹å¼•å…¥æ–°çš„ç±»å‹ã€‚

ä½¿ç”¨æ–¹æ³•é“¾å¯ä»¥å¸®åŠ©ä¿å­˜è¿™ä¸ªæ–°çš„ç±»å‹å¼•ç”¨ã€‚

ä¾‹å¦‚ï¼š

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .state('build', 1)
    // Store æ˜¯ä¸¥æ ¼ç±»å‹ // [!code ++]
    .get('/', ({ store: { build } }) => build)
    .listen(3000)
```

è¿™æ ·ï¼Œ**state** ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ **ElysiaInstance** ç±»å‹ï¼Œåœ¨ store ä¸­å¼•å…¥ **build**ï¼Œæ›¿ä»£å½“å‰çš„ç±»å‹ã€‚

å¦‚æœä¸ä½¿ç”¨æ–¹æ³•é“¾è°ƒç”¨ï¼ŒElysia ä¸ä¼šä¿å­˜æ–°å¼•å…¥çš„ç±»å‹ï¼Œå¯¼è‡´ç±»å‹æ— æ³•æ¨æ–­ã€‚

```typescript twoslash
// @errors: 2339
import { Elysia } from 'elysia'

const app = new Elysia()

app.state('build', 1)

app.get('/', ({ store: { build } }) => build)

app.listen(3000)
```

### ç±»å‹å®šä¹‰

å¦‚æœä½ ä½¿ç”¨äº† Bun ç‰¹æœ‰çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ `Bun.file` æˆ–ç±»ä¼¼çš„ APIï¼Œå¹¶ä¸”ä»å¤„ç†å™¨å‡½æ•°ä¸­è¿”å›å®ƒï¼Œä½ å¯èƒ½éœ€è¦ä¸ºå®¢æˆ·ç«¯å®‰è£… Bun çš„ç±»å‹å®šä¹‰ã€‚

```bash
bun add -d @types/bun
```

### è·¯å¾„åˆ«åï¼ˆmonorepoï¼‰

å¦‚æœä½ åœ¨ monorepo ä¸­ä½¿ç”¨äº†è·¯å¾„åˆ«åï¼Œç¡®ä¿å‰ç«¯èƒ½å¤Ÿåƒåç«¯ä¸€æ ·è§£æè¿™äº›è·¯å¾„ã€‚

::: tip
åœ¨ monorepo ä¸­è®¾ç½®è·¯å¾„åˆ«åæœ‰äº›æ£˜æ‰‹ï¼Œæ‚¨å¯ä»¥åˆ†å‰æˆ‘ä»¬çš„ç¤ºä¾‹æ¨¡æ¿ï¼š[Kozeki æ¨¡æ¿](https://github.com/SaltyAom/kozeki-template)å¹¶æ ¹æ®æ‚¨çš„éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚
:::

ä¾‹å¦‚ï¼Œä½ åœ¨ **tsconfig.json** ä¸­ä¸ºåç«¯è®¾ç½®äº†å¦‚ä¸‹è·¯å¾„åˆ«åï¼š

```json
{
  "compilerOptions": {
  	"baseUrl": ".",
	"paths": {
	  "@/*": ["./src/*"]
	}
  }
}
```

ä½ çš„åç«¯ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```typescript
import { Elysia } from 'elysia'
import { a, b } from '@/controllers'

const app = new Elysia()
	.use(a)
	.use(b)
	.listen(3000)

export type app = typeof app
```

ä½ **å¿…é¡»**ç¡®ä¿å‰ç«¯ä»£ç ä¹Ÿèƒ½è§£æç›¸åŒçš„è·¯å¾„åˆ«åï¼Œå¦åˆ™ç±»å‹æ¨æ–­å°±ä¼šå˜æˆ anyã€‚

```typescript
import { treaty } from '@elysiajs/eden'
import type { app } from '@/index'

const client = treaty<app>('localhost:3000')

// è¿™åº”è¯¥èƒ½å¤Ÿåœ¨å‰ç«¯å’Œåç«¯è§£æç›¸åŒçš„æ¨¡å—ï¼Œè€Œä¸æ˜¯ `any`ã€‚
import { a, b } from '@/controllers' // [!code ++]
```

è¦è§£å†³æ­¤é—®é¢˜ï¼Œä½ å¿…é¡»ç¡®ä¿è·¯å¾„åˆ«ååœ¨å‰ç«¯å’Œåç«¯è§£æä¸ºç›¸åŒçš„æ–‡ä»¶ã€‚

å› æ­¤ï¼Œä½ å¿…é¡»å°† **tsconfig.json** ä¸­çš„è·¯å¾„åˆ«åæ”¹ä¸ºï¼š

```json
{
  "compilerOptions": {
  	"baseUrl": ".",
	"paths": {
	  "@/*": ["../apps/backend/src/*"]
	}
  }
}
```

å¦‚æœé…ç½®æ­£ç¡®ï¼Œä½ åº”è¯¥èƒ½å¤Ÿåœ¨å‰ç«¯å’Œåç«¯è§£æç›¸åŒçš„æ¨¡å—ã€‚

```typescript
// è¿™åº”è¯¥èƒ½å¤Ÿåœ¨å‰ç«¯å’Œåç«¯è§£æç›¸åŒçš„æ¨¡å—ï¼Œè€Œä¸æ˜¯ `any`ã€‚
import { a, b } from '@/controllers'
```

#### å‘½åç©ºé—´

æˆ‘ä»¬å»ºè®®ä¸ºæ‚¨å•ä½“ä»“åº“ä¸­çš„æ¯ä¸ªæ¨¡å—æ·»åŠ ä¸€ä¸ª **å‘½åç©ºé—´** å‰ç¼€ï¼Œä»¥é¿å…å¯èƒ½å‘ç”Ÿçš„ä»»ä½•æ··æ·†å’Œå†²çªã€‚

```json
{
  "compilerOptions": {
  	"baseUrl": ".",
	"paths": {
	  "@frontend/*": ["./apps/frontend/src/*"],
	  "@backend/*": ["./apps/backend/src/*"]
	}
  }
}
```

ç„¶åï¼Œä½ å¯ä»¥è¿™æ ·å¯¼å…¥æ¨¡å—ï¼š

```typescript
// åº”è¯¥èƒ½åœ¨å‰ç«¯å’Œåç«¯éƒ½æ­£å¸¸ä½¿ç”¨ï¼Œä¸”ä¸ä¼šè¿”å› `any`
import { a, b } from '@backend/controllers'
```

æˆ‘ä»¬å»ºè®®åˆ›å»ºä¸€ä¸ª **å•ä¸€çš„ tsconfig.json**ï¼Œå°† `baseUrl` æŒ‡å‘é¡¹ç›®æ ¹ç›®å½•ï¼Œæ ¹æ®æ¨¡å—ä½ç½®æä¾›è·¯å¾„åˆ«åï¼Œå¹¶ä¸ºæ¯ä¸ªæ¨¡å—åˆ›å»ºç»§æ‰¿è‡ªæ ¹ tsconfig.json çš„ **tsconfig.json**ï¼Œä»¥ä½¿ç”¨è·¯å¾„åˆ«åã€‚

ä½ å¯ä»¥åœ¨è¿™ä¸ª [è·¯å¾„åˆ«åç¤ºä¾‹ä»“åº“](https://github.com/SaltyAom/elysia-monorepo-path-alias) æˆ–è€… [Kozeki æ¨¡æ¿](https://github.com/SaltyAom/kozeki-template) ä¸­æŸ¥çœ‹ä¸€ä¸ªå·¥ä½œç¤ºä¾‹ã€‚

---

---
url: 'https://elysiajs.com/eden/test.md'
---

# Eden æµ‹è¯•

ä½¿ç”¨ Edenï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå…·æœ‰ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨å’Œè‡ªåŠ¨è¡¥å…¨çš„é›†æˆæµ‹è¯•ã€‚

## è®¾ç½®

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [Bun test](https://bun.sh/guides/test/watch-mode) æ¥åˆ›å»ºæµ‹è¯•ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º **test/index.test.ts**ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```typescript
// test/index.test.ts
import { describe, expect, it } from 'bun:test'

import { edenTreaty } from '@elysiajs/eden'

const app = new Elysia()
    .get('/', () => 'hi')
    .listen(3000)

const api = edenTreaty<typeof app>('http://localhost:3000')

describe('Elysia', () => {
    it('è¿”å›ä¸€ä¸ªå“åº”', async () => {
        const { data } = await api.get()

        expect(data).toBe('hi')
    })
})
```

ç„¶åè¿è¡Œ **bun test** æ¥æ‰§è¡Œæµ‹è¯•ï¼š

```bash
bun test
```

è¿™å…è®¸æˆ‘ä»¬ä»¥ç¼–ç¨‹æ–¹å¼æ‰§è¡Œé›†æˆæµ‹è¯•ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ fetchï¼ŒåŒæ—¶è‡ªåŠ¨æ”¯æŒç±»å‹æ£€æŸ¥ã€‚

---

---
url: 'https://elysiajs.com/illust.md'
---


---

---
url: 'https://elysiajs.com/plugins/graphql-yoga.md'
---

# GraphQL Yoga æ’ä»¶

æ­¤æ’ä»¶å°† GraphQL Yoga é›†æˆåˆ° Elysia ä¸­

å®‰è£…æ–¹æ³•ï¼š

```bash
bun add @elysiajs/graphql-yoga
```

ç„¶åä½¿ç”¨å®ƒï¼š

```typescript
import { Elysia } from 'elysia'
import { yoga } from '@elysiajs/graphql-yoga'

const app = new Elysia()
	.use(
		yoga({
			typeDefs: /* GraphQL */ `
				type Query {
					hi: String
				}
			`,
			resolvers: {
				Query: {
					hi: () => 'Hello from Elysia'
				}
			}
		})
	)
	.listen(3000)
```

åœ¨æµè§ˆå™¨ä¸­è®¿é—® `/graphql`ï¼ˆGET è¯·æ±‚ï¼‰å°†æ˜¾ç¤ºä¸€ä¸ª GraphiQL å®ä¾‹ï¼Œç”¨äºæ”¯æŒ GraphQL çš„ Elysia æœåŠ¡å™¨ã€‚

å¯é€‰ï¼šæ‚¨è¿˜å¯ä»¥å®‰è£…è‡ªå®šä¹‰ç‰ˆæœ¬çš„å¯é€‰å¯¹ç­‰ä¾èµ–é¡¹ï¼š

```bash
bun add graphql graphql-yoga
```

## è§£æå™¨

Elysia ä½¿ç”¨ [Mobius](https://github.com/saltyaom/mobius) è‡ªåŠ¨ä» **typeDefs** å­—æ®µæ¨æ–­ç±»å‹ï¼Œå…è®¸æ‚¨åœ¨è¾“å…¥ **resolver** ç±»å‹æ—¶è·å¾—å®Œå…¨çš„ç±»å‹å®‰å…¨å’Œè‡ªåŠ¨å®Œæˆã€‚

## ä¸Šä¸‹æ–‡

æ‚¨å¯ä»¥é€šè¿‡æ·»åŠ  **context** ä¸ºè§£æå™¨å‡½æ•°æ·»åŠ è‡ªå®šä¹‰ä¸Šä¸‹æ–‡

```ts
import { Elysia } from 'elysia'
import { yoga } from '@elysiajs/graphql-yoga'

const app = new Elysia()
	.use(
		yoga({
			typeDefs: /* GraphQL */ `
				type Query {
					hi: String
				}
			`,
			context: {
				name: 'Mobius'
			},
			// å¦‚æœä¸Šä¸‹æ–‡æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¸å‡ºç°åœ¨è¿™é‡Œ
			// ç”±äºæŸç§åŸå› ï¼Œå®ƒä¸ä¼šæ¨æ–­ä¸Šä¸‹æ–‡ç±»å‹
			useContext(_) {},
			resolvers: {
				Query: {
					hi: async (parent, args, context) => context.name
				}
			}
		})
	)
	.listen(3000)
```

## é…ç½®

æ­¤æ’ä»¶æ‰©å±•äº† [GraphQL Yoga çš„ createYoga é€‰é¡¹ï¼Œè¯·å‚è€ƒ GraphQL Yoga æ–‡æ¡£](https://the-guild.dev/graphql/yoga-server/docs)ï¼Œå¹¶å°† `schema` é…ç½®å†…è”åˆ°æ ¹éƒ¨ã€‚

ä»¥ä¸‹æ˜¯æ’ä»¶æ¥å—çš„é…ç½®

### path

@default `/graphql`

å…¬å¼€ GraphQL å¤„ç†ç¨‹åºçš„ç«¯ç‚¹

---

---
url: 'https://elysiajs.com/tutorial/getting-started/guard.md'
---

# Guard

å½“ä½ éœ€è¦å°†å¤šä¸ªé’©å­åº”ç”¨åˆ°ä½ çš„åº”ç”¨ç¨‹åºæ—¶ï¼Œä¸ç”¨é‡å¤å¤šæ¬¡é’©å­ï¼Œå¯ä»¥ä½¿ç”¨ `guard` æ¥æ‰¹é‡æ·»åŠ é’©å­åˆ°ä½ çš„åº”ç”¨ä¸­ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.onBeforeHandle(({ query: { name }, status }) => { // [!code --]
		if(!name) return status(401) // [!code --]
	}) // [!code --]
	.onBeforeHandle(({ query: { name } }) => { // [!code --]
		console.log(name) // [!code --]
	}) // [!code --]
	.onAfterResponse(({ responseValue }) => { // [!code --]
		console.log(responseValue) // [!code --]
	}) // [!code --]
	.guard({ // [!code ++]
		beforeHandle: [ // [!code ++]
			({ query: { name }, status }) => { // [!code ++]
				if(!name) return status(401) // [!code ++]
			}, // [!code ++]
			({ query: { name } }) => { // [!code ++]
				console.log(name) // [!code ++]
			} // [!code ++]
		], // [!code ++]
		afterResponse({ responseValue }) { // [!code ++]
			console.log(responseValue) // [!code ++]
		} // [!code ++]
	}) // [!code ++]
	.get(
		'/auth',
		({ query: { name = 'anon' } }) => `Hello ${name}!`,
		{
			query: t.Object({
				name: t.String()
			})
		}
	)
	.get(
		'/profile',
		({ query: { name = 'anon' } }) => `Hello ${name}!`,
		{
			query: t.Object({
				name: t.String()
			})
		}
	)
	.listen(3000)
```

ä¸ä»…å¦‚æ­¤ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ `guard` å°† **æ¨¡å¼** åº”ç”¨åˆ°å¤šä¸ªè·¯ç”±ä¸Šã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.guard({
		beforeHandle: [
			({ query: { name }, status }) => {
				if(!name) return status(401)
			},
			({ query: { name } }) => {
				console.log(name)
			}
		],
		afterResponse({ responseValue }) {
			console.log(responseValue)
		},
		query: t.Object({ // [!code ++]
			name: t.String() // [!code ++]
		}) // [!code ++]
	})
	.get(
		'/auth',
		({ query: { name = 'anon' } }) => `Hello ${name}!`,
		{ // [!code --]
			query: t.Object({ // [!code --]
				name: t.String() // [!code --]
			}) // [!code --]
		} // [!code --]
	)
	.get(
		'/profile',
		({ query: { name = 'anon' } }) => `Hello ${name}!`,
		{ // [!code --]
			query: t.Object({ // [!code --]
				name: t.String() // [!code --]
			}) // [!code --]
		} // [!code --]
	)
	.listen(3000)
```

è¿™å°†åœ¨åŒä¸€å®ä¾‹ä¸­ `guard` è¢«è°ƒç”¨ä¹‹åï¼Œå°†é’©å­å’Œæ¨¡å¼åº”ç”¨åˆ°æ¯ä¸ªè·¯ç”±ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ Guardã€‚

## ä»»åŠ¡

è®©æˆ‘ä»¬å°†ä¸¤ç§ç±»å‹çš„é’©å­ä»˜è¯¸å®è·µã€‚

\<template #answer>

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `beforeHandle` æ¥æ‹¦æˆªè¯·æ±‚ï¼Œè¿”å›ä¸€ä¸ªå¸¦æœ‰ `status` æ–¹æ³•çš„å“åº”ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.onBeforeHandle(({ query: { name }, status }) => {
		if(!name) return status(401)
	})
	.get('/auth', ({ query: { name = 'anon' } }) => {
		return `Hello ${name}!`
	})
	.get('/profile', ({ query: { name = 'anon' } }) => {
		return `Hello ${name}!`
	})
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/plugins/html.md'
---

# HTML æ’ä»¶

å…è®¸æ‚¨åœ¨ Elysia æœåŠ¡å™¨ä¸­ä½¿ç”¨ [JSX](#jsx) å’Œ HTMLï¼Œå¹¶æä¾›é€‚å½“çš„å¤´éƒ¨å’Œæ”¯æŒã€‚

å®‰è£…æ–¹æ³•ï¼š

```bash
bun add @elysiajs/html
```

ç„¶åä½¿ç”¨å®ƒï¼š

```tsx twoslash
import React from 'react'
// ---cut---
import { Elysia } from 'elysia'
import { html, Html } from '@elysiajs/html'

new Elysia()
	.use(html())
	.get(
		'/html',
		() => `
            <html lang='en'>
                <head>
                    <title>Hello World</title>
                </head>
                <body>
                    <h1>Hello World</h1>
                </body>
            </html>`
	)
	.get('/jsx', () => (
		<html lang="en">
			<head>
				<title>Hello World</title>
			</head>
			<body>
				<h1>Hello World</h1>
			</body>
		</html>
	))
	.listen(3000)
```

è¯¥æ’ä»¶å°†è‡ªåŠ¨åœ¨å“åº”ä¸­æ·»åŠ  `Content-Type: text/html; charset=utf8` å¤´éƒ¨ï¼Œæ·»åŠ  `<!doctype html>`ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ªå“åº”å¯¹è±¡ã€‚

## JSX

Elysia HTML åŸºäº [@kitajs/html](https://github.com/kitajs/html)ï¼Œå…è®¸æˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶å°† JSX å®šä¹‰ä¸ºå­—ç¬¦ä¸²ï¼Œä»¥å®ç°é«˜æ€§èƒ½ã€‚

éœ€è¦ä½¿ç”¨ JSX çš„æ–‡ä»¶åç§°åº”ä»¥åç¼€ **"x"** ç»“å°¾ï¼š

* .js -> .jsx
* .ts -> .tsx

è¦æ³¨å†Œ TypeScript ç±»å‹ï¼Œè¯·å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ° **tsconfig.json**ï¼š

```jsonc
// tsconfig.json
{
	"compilerOptions": {
		"jsx": "react",
		"jsxFactory": "Html.createElement",
		"jsxFragmentFactory": "Html.Fragment"
	}
}
```

å°±æ˜¯è¿™æ ·ï¼Œç°åœ¨æ‚¨å¯ä»¥å°† JSX ç”¨ä½œæ¨¡æ¿å¼•æ“ï¼š

```tsx twoslash
import React from 'react'
// ---cut---
import { Elysia } from 'elysia'
import { html, Html } from '@elysiajs/html' // [!code ++]

new Elysia()
	.use(html()) // [!code ++]
	.get('/', () => (
		<html lang="en">
			<head>
				<title>Hello World</title>
			</head>
			<body>
				<h1>Hello World</h1>
			</body>
		</html>
	))
	.listen(3000)
```

å¦‚æœå‡ºç°é”™è¯¯ `Cannot find name 'Html'. Did you mean 'html'?`ï¼Œåˆ™å¿…é¡»å°†æ­¤å¯¼å…¥æ·»åŠ åˆ° JSX æ¨¡æ¿ä¸­ï¼š

```tsx
import { Html } from '@elysiajs/html'
```

åŠ¡å¿…ä»¥å¤§å†™å­—æ¯ä¹¦å†™ã€‚

## XSS

Elysia HTML åŸºäº Kita HTML æ’ä»¶ï¼Œåœ¨ç¼–è¯‘æ—¶æ£€æµ‹å¯èƒ½çš„ XSS æ”»å‡»ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä¸“ç”¨çš„ `safe` å±æ€§æ¥æ¸…ç†ç”¨æˆ·å€¼ï¼Œä»¥é˜²æ­¢ XSS æ¼æ´ã€‚

```tsx
import { Elysia, t } from 'elysia'
import { html, Html } from '@elysiajs/html'

new Elysia()
	.use(html())
	.post(
		'/',
		({ body }) => (
			<html lang="en">
				<head>
					<title>Hello World</title>
				</head>
				<body>
					<h1 safe>{body}</h1>
				</body>
			</html>
		),
		{
			body: t.String()
		}
	)
	.listen(3000)
```

ç„¶è€Œï¼Œåœ¨æ„å»ºå¤§å‹åº”ç”¨æ—¶ï¼Œæœ€å¥½æœ‰ç±»å‹æé†’ä»¥æ£€æµ‹ä»£ç åº“ä¸­å¯èƒ½çš„ XSS æ¼æ´ã€‚

è¦æ·»åŠ ç±»å‹å®‰å…¨æé†’ï¼Œè¯·å®‰è£…ï¼š

```sh
bun add @kitajs/ts-html-plugin
```

ç„¶ååœ¨ **tsconfig.json** ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```jsonc
// tsconfig.json
{
	"compilerOptions": {
		"jsx": "react",
		"jsxFactory": "Html.createElement",
		"jsxFragmentFactory": "Html.Fragment",
		"plugins": [{ "name": "@kitajs/ts-html-plugin" }]
	}
}
```

## é€‰é¡¹

### contentType

* ç±»å‹: `string`
* é»˜è®¤å€¼: `'text/html; charset=utf8'`

å“åº”çš„å†…å®¹ç±»å‹ã€‚

### autoDetect

* ç±»å‹: `boolean`
* é»˜è®¤å€¼: `true`

æ˜¯å¦è‡ªåŠ¨æ£€æµ‹ HTML å†…å®¹å¹¶è®¾ç½®å†…å®¹ç±»å‹ã€‚

### autoDoctype

* ç±»å‹: `boolean | 'full'`
* é»˜è®¤å€¼: `true`

æ˜¯å¦åœ¨å“åº”å¼€å¤´æ˜¯ `<html>` æ—¶è‡ªåŠ¨æ·»åŠ  `<!doctype html>`ï¼Œå¦‚æœæœªæ‰¾åˆ°ã€‚

ä½¿ç”¨ `full` è¿˜å¯ä»¥åœ¨æ²¡æœ‰æ­¤æ’ä»¶çš„å“åº”ä¸­è‡ªåŠ¨æ·»åŠ æ–‡æ¡£ç±»å‹ã€‚

```ts
// æ²¡æœ‰æ’ä»¶
app.get('/', () => '<html></html>')

// æœ‰æ’ä»¶
app.get('/', ({ html }) => html('<html></html>'))
```

### isHtml

* ç±»å‹: `(value: string) => boolean`
* é»˜è®¤: `isHtml` ï¼ˆå¯¼å‡ºçš„å‡½æ•°ï¼‰

è¯¥å‡½æ•°ç”¨äºæ£€æµ‹ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ä¸º HTMLã€‚é»˜è®¤å®ç°æ˜¯å¦‚æœé•¿åº¦å¤§äº 7ï¼Œä¸”ä»¥ `<` å¼€å¤´å¹¶ä»¥ `>` ç»“å°¾ã€‚

è¯·æ³¨æ„ï¼Œæ²¡æœ‰çœŸæ­£çš„æ–¹æ³•æ¥éªŒè¯ HTMLï¼Œå› æ­¤é»˜è®¤å®ç°åªæ˜¯ä¸€ä¸ªæœ€ä½³çŒœæµ‹ã€‚

---

---
url: 'https://elysiajs.com/plugins/jwt.md'
---

# JWT æ’ä»¶

è¯¥æ’ä»¶å¢å¼ºäº†åœ¨ Elysia å¤„ç†ç¨‹åºä¸­ä½¿ç”¨ JWT çš„æ”¯æŒã€‚

å®‰è£…å‘½ä»¤ï¼š

```bash
bun add @elysiajs/jwt
```

ç„¶åä½¿ç”¨å®ƒï¼š

::: code-group

```typescript [cookie]
import { Elysia } from 'elysia'
import { jwt } from '@elysiajs/jwt'

const app = new Elysia()
    .use(
        jwt({
            name: 'jwt',
            secret: 'Fischl von Luftschloss Narfidort'
        })
    )
    .get('/sign/:name', async ({ jwt, params: { name }, cookie: { auth } }) => {
    	const value = await jwt.sign({ name })

        auth.set({
            value,
            httpOnly: true,
            maxAge: 7 * 86400,
            path: '/profile',
        })

        return `ä»¥ ${value} ç™»å…¥`
    })
    .get('/profile', async ({ jwt, status, cookie: { auth } }) => {
        const profile = await jwt.verify(auth.value)

        if (!profile)
            return status(401, 'æœªæˆæƒ')

        return `ä½ å¥½ ${profile.name}`
    })
    .listen(3000)
```

```typescript [headers]
import { Elysia } from 'elysia'
import { jwt } from '@elysiajs/jwt'

const app = new Elysia()
    .use(
        jwt({
            name: 'jwt',
            secret: 'Fischl von Luftschloss Narfidort'
        })
    )
    .get('/sign/:name', ({ jwt, params: { name } }) => {
    	return jwt.sign({ name })
    })
    .get('/profile', async ({ jwt, error, headers: { authorization } }) => {
        const profile = await jwt.verify(authorization)

        if (!profile)
            return status(401, 'æœªæˆæƒ')

        return `ä½ å¥½ ${profile.name}`
    })
    .listen(3000)
```

:::

## é…ç½®

è¯¥æ’ä»¶æ‰©å±•äº† [jose](https://github.com/panva/jose) çš„é…ç½®ã€‚

ä»¥ä¸‹æ˜¯æ’ä»¶æ¥å—çš„é…ç½®ã€‚

### name

æ³¨å†Œ `jwt` å‡½æ•°çš„åç§°ã€‚

ä¾‹å¦‚ï¼Œ`jwt` å‡½æ•°å°†ä»¥è‡ªå®šä¹‰åç§°æ³¨å†Œã€‚

```typescript
app
    .use(
        jwt({
            name: 'myJWTNamespace',
            secret: process.env.JWT_SECRETS!
        })
    )
    .get('/sign/:name', ({ myJWTNamespace, params }) => {
        return myJWTNamespace.sign(params)
    })
```

å› ä¸ºæœ‰äº›äººå¯èƒ½éœ€è¦åœ¨åŒä¸€æœåŠ¡å™¨ä¸­ä½¿ç”¨å¤šä¸ªå…·æœ‰ä¸åŒé…ç½®çš„ `jwt`ï¼Œå› æ­¤æ˜¾å¼ä½¿ç”¨ä¸åŒåç§°æ³¨å†Œ JWT å‡½æ•°æ˜¯å¿…è¦çš„ã€‚

### secret

ç”¨äºç­¾ç½² JWT è´Ÿè½½çš„ç§é’¥ã€‚

### schema

å¯¹ JWT è´Ÿè½½è¿›è¡Œä¸¥æ ¼çš„ç±»å‹éªŒè¯ã€‚

***

ä»¥ä¸‹æ˜¯æ‰©å±•è‡ª [cookie](https://npmjs.com/package/cookie) çš„é…ç½®

### alg

@default `HS256`

ç”¨äºç­¾ç½² JWT è´Ÿè½½çš„ç­¾åç®—æ³•ã€‚

å¯ä¾› jose ä½¿ç”¨çš„å±æ€§æœ‰ï¼š
HS256
HS384
HS512
PS256
PS384
PS512
RS256
RS384
RS512
ES256
ES256K
ES384
ES512
EdDSA

### iss

å‘è¡Œè€…å£°æ˜æ ‡è¯†æ ¹æ® [RFC7519](https://www.rfc-editor.org/rfc/rfc7519#section-4.1.1) ç­¾å‘ JWT çš„ä¸»ä½“ã€‚

ç®€è€Œè¨€ä¹‹ï¼šé€šå¸¸æ˜¯ç­¾åè€…ï¼ˆåŸŸåï¼‰çš„åç§°ã€‚

### sub

ä¸»ä½“å£°æ˜æ ‡è¯† JWT çš„ä¸»é¢˜ã€‚

JWT ä¸­çš„å£°æ˜é€šå¸¸æ˜¯å…³äºä¸»é¢˜çš„è¯­å¥ï¼Œæ ¹æ® [RFC7519](https://www.rfc-editor.org/rfc/rfc7519#section-4.1.2)

### aud

å—ä¼—å£°æ˜æ ‡è¯† JWT é¢„æœŸçš„æ¥æ”¶è€…ã€‚

æ¯ä¸ªé¢„æœŸå¤„ç† JWT çš„ä¸»ä½“å¿…é¡»åœ¨å—ä¼—å£°æ˜ä¸­ä»¥ä¸€ä¸ªå€¼æ ‡è¯†è‡ªå·±ï¼Œæ ¹æ® [RFC7519](https://www.rfc-editor.org/rfc/rfc7519#section-4.1.3)

### jti

JWT ID å£°æ˜æä¾› JWT çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ ¹æ® [RFC7519](https://www.rfc-editor.org/rfc/rfc7519#section-4.1.7)

### nbf

â€œæœªç”Ÿæ•ˆâ€å£°æ˜æ ‡è¯† JWT åœ¨å¤„ç†ä¹‹å‰ä¸å¾—è¢«æ¥å—çš„æ—¶é—´ï¼Œæ ¹æ® [RFC7519](https://www.rfc-editor.org/rfc/rfc7519#section-4.1.5)

### exp

è¿‡æœŸæ—¶é—´å£°æ˜æ ‡è¯†åœ¨è¯¥æ—¶é—´ä¹‹åä¸å¾—è¢«æ¥å—å¤„ç†çš„ JWTï¼Œæ ¹æ® [RFC7519](https://www.rfc-editor.org/rfc/rfc7519#section-4.1.4)

### iat

â€œç­¾å‘æ—¶é—´â€å£°æ˜æ ‡è¯† JWT è¢«ç­¾å‘çš„æ—¶é—´ã€‚

è¯¥å£°æ˜å¯ç”¨äºç¡®å®š JWT çš„å¹´é¾„ï¼Œæ ¹æ® [RFC7519](https://www.rfc-editor.org/rfc/rfc7519#section-4.1.6)

### b64

æ­¤ JWS æ‰©å±•å¤´å‚æ•°ä¿®æ”¹ JWS è´Ÿè½½è¡¨ç¤ºå’Œ JWS ç­¾åè¾“å…¥è®¡ç®—ï¼Œæ ¹æ® [RFC7797](https://www.rfc-editor.org/rfc/rfc7797)ã€‚

### kid

æŒ‡ç¤ºç”¨äºä¿æŠ¤ JWS çš„å¯†é’¥çš„æç¤ºã€‚

è¯¥å‚æ•°å…è®¸åˆ›å»ºè€…æ˜¾å¼ä¿¡å·å‘æ¥æ”¶æ–¹å˜åŒ–å¯†é’¥ï¼Œæ ¹æ® [RFC7515](https://www.rfc-editor.org/rfc/rfc7515#section-4.1.4)

### x5t

(X.509 è¯ä¹¦ SHA-1 æŒ‡çº¹) å¤´å‚æ•°æ˜¯ X.509 è¯ä¹¦çš„ DER ç¼–ç çš„ base64url ç¼–ç  SHA-1 æ‘˜è¦ [RFC5280](https://www.rfc-editor.org/rfc/rfc5280)ï¼Œä¸ç”¨äºæ•°å­—ç­¾å JWS çš„å¯†é’¥å¯¹åº”ï¼Œæ ¹æ® [RFC7515](https://www.rfc-editor.org/rfc/rfc7515#section-4.1.7)

### x5c

(X.509 è¯ä¹¦é“¾) å¤´å‚æ•°åŒ…å«ä¸ç”¨äºæ•°å­—ç­¾å JWS çš„å¯†é’¥å¯¹åº”çš„ X.509 å…¬é’¥è¯ä¹¦æˆ–è¯ä¹¦é“¾ [RFC5280](https://www.rfc-editor.org/rfc/rfc5280)ï¼Œæ ¹æ® [RFC7515](https://www.rfc-editor.org/rfc/rfc7515#section-4.1.6)

### x5u

(X.509 URL) å¤´å‚æ•°æ˜¯æŒ‡å‘ X.509 å…¬é’¥è¯ä¹¦æˆ–è¯ä¹¦é“¾çš„ URI [RFC3986](https://www.rfc-editor.org/rfc/rfc3986)ï¼Œå…¶å¯¹åº”äºç”¨äºæ•°å­—ç­¾å JWS çš„å¯†é’¥ï¼Œæ ¹æ® [RFC7515](https://www.rfc-editor.org/rfc/rfc7515#section-4.1.5)

### jwk

â€œjkuâ€ï¼ˆJWK é›† URLï¼‰å¤´å‚æ•°æ˜¯ä¸€ä¸ª URI \[RFC3986]ï¼ŒæŒ‡å‘ JSON ç¼–ç å…¬é’¥é›†åˆçš„èµ„æºï¼Œå…¶ä¸­ä¹‹ä¸€ä¸ç”¨äºæ•°å­—ç­¾å JWS çš„å¯†é’¥å¯¹åº”ã€‚

è¿™äº›å¯†é’¥å¿…é¡»ä½œä¸º JWK é›† \[JWK] ç¼–ç ï¼Œæ ¹æ® [RFC7515](https://www.rfc-editor.org/rfc/rfc7515#section-4.1.2)

### typ

`typ`ï¼ˆç±»å‹ï¼‰å¤´å‚æ•°ç”± JWS åº”ç”¨ç¨‹åºç”¨äºå£°æ˜è¯¥å®Œæ•´ JWS çš„åª’ä½“ç±»å‹ \[IANA.MediaTypes]ã€‚

å½“åº”ç”¨ç¨‹åºä¸­å¯èƒ½å‡ºç°å¤šç§å¯¹è±¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ­¤å†…å®¹ï¼Œæ ¹æ® [RFC7515](https://www.rfc-editor.org/rfc/rfc7515#section-4.1.9)

### ctr

Content-Type å‚æ•°ç”± JWS åº”ç”¨ç¨‹åºç”¨äºå£°æ˜è¢«ä¿æŠ¤å†…å®¹ï¼ˆè´Ÿè½½ï¼‰çš„åª’ä½“ç±»å‹ \[IANA.MediaTypes]ã€‚

å½“ JWS è´Ÿè½½ä¸­å¯èƒ½å­˜åœ¨å¤šç§å¯¹è±¡æ—¶ï¼Œè¿™ä¸€å†…å®¹ç”¨äºè¯¥åº”ç”¨ç¨‹åºï¼Œæ ¹æ® [RFC7515](https://www.rfc-editor.org/rfc/rfc7515#section-4.1.9)

## å¤„ç†ç¨‹åº

ä»¥ä¸‹æ˜¯æ·»åŠ åˆ°å¤„ç†ç¨‹åºä¸­çš„å€¼ã€‚

### jwt.sign

ä¸ JWT ä½¿ç”¨ç›¸å…³çš„åŠ¨æ€å¯¹è±¡é›†åˆï¼Œç”± JWT æ’ä»¶æ³¨å†Œã€‚

ç±»å‹ï¼š

```typescript
sign: (payload: JWTPayloadSpec): Promise<string>
```

`JWTPayloadSpec` æ¥å—ä¸ [JWT é…ç½®](#config) ç›¸åŒçš„å€¼ã€‚

### jwt.verify

ä½¿ç”¨æä¾›çš„ JWT é…ç½®éªŒè¯è´Ÿè½½ã€‚

ç±»å‹ï¼š

```typescript
verify(payload: string) => Promise<JWTPayloadSpec | false>
```

`JWTPayloadSpec` æ¥å—ä¸ [JWT é…ç½®](#config) ç›¸åŒçš„å€¼ã€‚

## æ¨¡å¼

ä»¥ä¸‹æ˜¯ä½¿ç”¨è¯¥æ’ä»¶çš„å¸¸è§æ¨¡å¼ã€‚

## è®¾ç½® JWT è¿‡æœŸæ—¶é—´

é»˜è®¤æƒ…å†µä¸‹ï¼Œé…ç½®ä¼šä¼ é€’ç»™ `setCookie` å¹¶ç»§æ‰¿å…¶å€¼ã€‚

```typescript
const app = new Elysia()
    .use(
        jwt({
            name: 'jwt',
            secret: 'kunikuzushi',
            exp: '7d'
        })
    )
    .get('/sign/:name', async ({ jwt, params }) => jwt.sign(params))
```

è¿™å°†ç­¾ç½²ä¸€ä¸ªè¿‡æœŸæ—¶é—´ä¸ºæ¥ä¸‹æ¥çš„ 7 å¤©çš„ JWTã€‚

---

---
url: 'https://elysiajs.com/migrate/from-trpc.md'
---

# From tRPC to Elysia

This guide is for tRPC users who want to see a differences from Elysia including syntax, and how to migrate your application from tRPC to Elysia by example.

**tRPC** is a typesafe RPC framework for building APIs using TypeScript. It provides a way to create end-to-end type-safe APIs with type-safe contract between frontend and backend.

**Elysia** is an ergonomic web framework. Designed to be ergonomic and developer-friendly with a focus on **sound type safety** and performance.

## Overview

tRPC is primarily designed as RPC communication with proprietary abstraction over RESTful API, while Elysia is focused on RESTful API.

Main feature of tRPC is end-to-end type safety contract between frontend and backend which Elysia also offers via [Eden](/eden/overview).

Making Elysia a better fit for building a universal API with RESTful standard that developers already know instead of learning a new proprietary abstraction while having the end-to-end type safety that tRPC offers.

## Routing

Elysia use a syntax similar to Express, and Hono like `app.get()` and `app.post()` methods to define routes and similar path parameters syntax.

While tRPC use a nested router approach to define routes.

::: code-group

```ts [tRPC]
import { initTRPC } from '@trpc/server'
import { createHTTPServer } from '@trpc/server/adapters/standalone'

const t = initTRPC.create()

const appRouter = t.router({
	hello: t.procedure.query(() => 'Hello World'),
	user: t.router({
		getById: t.procedure
			.input((id: string) => id)
			.query(({ input }) => {
				return { id: input }
			})
	})
})

const server = createHTTPServer({
  	router: appRouter
})

server.listen(3000)
```

:::


> tRPC use nested router and procedure to define routes

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
    .get('/', 'Hello World')
    .post(
    	'/id/:id',
     	({ status, params: { id } }) => {
      		return status(201, id)
      	}
    )
    .listen(3000)
```

:::


> Elysia use HTTP method, and path parameters to define routes

While tRPC use proprietary abstraction over RESTful API with procedure and router, Elysia use a syntax similar to Express, and Hono like `app.get()` and `app.post()` methods to define routes and similar path parameters syntax.

## Handler

tRPC handler is called `procedure` which can be either `query` or `mutation`, while Elysia use HTTP method like `get`, `post`, `put`, `delete` and so on.

tRPC is doesn't have a concept of HTTP property like query, headers, status code, and so on, only `input` and `output`.

::: code-group

```ts [tRPC]
import { initTRPC } from '@trpc/server'

const t = initTRPC.create()

const appRouter = t.router({
	user: t.procedure
		.input((val: { limit?: number; name: string; authorization?: string }) => val)
		.mutation(({ input }) => {
			const limit = input.limit
			const name = input.name
			const auth = input.authorization

			return { limit, name, auth }
		})
})
```

:::


> tRPC use single `input` for all properties

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
	.post('/user', (ctx) => {
	    const limit = ctx.query.limit
	    const name = ctx.body.name
	    const auth = ctx.headers.authorization

	    return { limit, name, auth }
	})
```

:::


> Elysia use specific property for each HTTP property

Elysia use **static code analysis** to determine what to parse, and only parse the required properties.

This is useful for performance and type safety.

## Subrouter

tRPC use nested router to define subrouter, while Elysia use `.use()` method to define a subrouter.

::: code-group

```ts [tRPC]
import { initTRPC } from '@trpc/server'

const t = initTRPC.create()

const subRouter = t.router({
	user: t.procedure.query(() => 'Hello User')
})

const appRouter = t.router({
	api: subRouter
})
```

:::


> tRPC use nested router to define subrouter

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia()
	.get('/user', 'Hello User')

const app = new Elysia()
	.use(subRouter)
```

:::


> Elysia use a `.use()` method to define a subrouter

While you can inline the subrouter in tRPC, Elysia use `.use()` method to define a subrouter.

## Validation

Both support Standard Schema for validation. Allowing you to use various validation library like Zod, Yup, Valibot, and so on.

::: code-group

```ts [tRPC]
import { initTRPC } from '@trpc/server'
import { z } from 'zod'

const t = initTRPC.create()

const appRouter = t.router({
	user: t.procedure
		.input(
			z.object({
				id: z.number(),
				name: z.string()
			})
		)
		.mutation(({ input }) => input)
//                    ^?
})
```

:::


> tRPC use `input` to define validation schema

::: code-group

```ts twoslash [Elysia TypeBox]
import { Elysia, t } from 'elysia'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: t.Object({
			id: t.Number()
		}),
		body: t.Object({
			name: t.String()
		})
	})
```

```ts twoslash [Elysia Zod]
import { Elysia } from 'elysia'
import { z } from 'zod'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: z.object({
			id: z.number()
		}),
		body: z.object({
			name: z.string()
		})
	})
```

```ts twoslash [Elysia Valibot]
import { Elysia } from 'elysia'
import * as v from 'zod'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: v.object({
			id: v.number()
		}),
		body: v.object({
			name: v.string()
		})
	})
```

:::


> Elysia use specific property to define validation schema

Both offers type inference from schema to context automatically.

## File upload

tRPC doesn't support file upload out-of-the-box and require you to use `base64` string as input which is inefficient, and doesn't support mimetype validation.

While Elysia has built-in support for file upload using Web Standard API.

::: code-group

```ts [tRPC]
import { initTRPC } from '@trpc/server'
import { z } from 'zod'

import { fileTypeFromBuffer } from 'file-type'

const t = initTRPC.create()

export const uploadRouter = t.router({
	uploadImage: t.procedure
		.input(z.base64())
		.mutation(({ input }) => {
			const buffer = Buffer.from(input, 'base64')

			const type = await fileTypeFromBuffer(buffer)
			if (!type || !type.mime.startsWith('image/'))
				throw new TRPCError({
      				code: 'UNPROCESSABLE_CONTENT',
       				message: 'Invalid file type',
    			})

			return input
		})
})
```

:::


> tRPC

::: code-group

```ts [Elysia]
import { Elysia, t } from 'elysia'

const app = new Elysia()
	.post('/upload', ({ body }) => body.file, {
		body: t.Object({
			file: t.File({
				type: 'image'
			})
		})
	})
```

:::


> Elysia handle file, and mimetype validation declaratively

As doesn't validate mimetype out-of-the-box, you need to use a third-party library like `file-type` to validate an actual type.

## Middleware

tRPC middleware use a single queue-based order with `next` similar to Express, while Elysia give you a more granular control using an **event-based** lifecycle.

Elysia's Life Cycle event can be illustrated as the following.
![Elysia Life Cycle Graph](/assets/lifecycle-chart.svg)

> Click on image to enlarge

While tRPC has a single flow for request pipeline in order, Elysia can intercept each event in a request pipeline.

::: code-group

```ts [tRPC]
import { initTRPC } from '@trpc/server'

const t = initTRPC.create()

const log = t.middleware(async ({ ctx, next }) => {
	console.log('Request started')

	const result = await next()

	console.log('Request ended')

	return result
})

const appRouter = t.router({
	hello: log
		.procedure
		.query(() => 'Hello World')
})
```

:::


> tRPC use a single middleware queue defined as a procedure

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
	// Global middleware
	.onRequest(({ method, path }) => {
		console.log(`${method} ${path}`)
	})
	// Route-specific middleware
	.get('/protected', () => 'protected', {
		beforeHandle({ status, headers }) {
  			if (!headers.authorizaton)
     			return status(401)
		}
	})
```

:::


> Elysia use a specific event interceptor for each point in the request pipeline

While tRPC has a `next` function to call the next middleware in the queue, Elysia use specific event interceptor for each point in the request pipeline.

## Sounds type safety

Elysia is designed to be sounds type safety.

For example, you can customize context in a **type safe** manner using [derive](/essential/life-cycle.html#derive) and [resolve](/essential/life-cycle.html#resolve) while tRPC offers one by using `context` by type case which is doesn't ensure 100% type safety, making it unsounds.

::: code-group

```ts twoslash [tRPC]
import { initTRPC } from '@trpc/server'

const t = initTRPC.context<{
	version: number
	token: string
}>().create()

const appRouter = t.router({
	version: t.procedure.query(({ ctx: { version } }) => version),
	//                                                     ^?


	token: t.procedure.query(({ ctx: { token, version } }) => {
		version
		//  ^?

		return token
		//       ^?
	})
})
```

:::


> tRPC use `context` to extend context but doesn't have sounds type safety

::: code-group

```ts twoslash [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
	.decorate('version', 2)
	.get('/version', ({ version }) => version)
	.resolve(({ status, headers: { authorization } }) => {
		if(!authorization?.startsWith('Bearer '))
			return status(401)

		return {
			token: authorization.split(' ')[1]
		}
	})
	.get('/token', ({ token, version }) => {
		version
		//  ^?


		return token
		//       ^?
	})
```

:::


> Elysia use a specific event interceptor for each point in the request pipeline

## Middleware parameter

Both support custom middleware, but Elysia use macro to pass custom argument to custom middleware while tRPC use higher-order-function which is not type safe.

::: code-group

```ts twoslash [tRPC]
import { initTRPC, TRPCError } from '@trpc/server'

const t = initTRPC.create()

const findUser = (authorization?: string) => {
	return {
		name: 'Jane Doe',
		role: 'admin' as const
	}
}

const role = (role: 'user' | 'admin') =>
	t.middleware(({ next, input }) => {
		const user = findUser(input as string)
		//                      ^?


		if(user.role !== role)
			throw new TRPCError({
      			code: 'UNAUTHORIZED',
      			message: 'Unauthorized',
    		})

		return next({
			ctx: {
				user
			}
		})
	})

const appRouter = t.router({
	token: t.procedure
		.use(role('admin'))
		.query(({ ctx: { user } }) => user)
		//                 ^?
})



// ---cut-after---
// Unused
```

:::


> tRPC use higher-order-function to pass custom argument to custom middleware

::: code-group

```ts twoslash [Elysia]
const findUser = (authorization?: string) => {
	return {
		name: 'Jane Doe',
		role: 'admin' as const
	}
}
// ---cut---
import { Elysia } from 'elysia'

const app = new Elysia()
	.macro({
		role: (role: 'user' | 'admin') => ({
			resolve({ status, headers: { authorization } }) {
				const user = findUser(authorization)

				if(user.role !== role)
					return status(401)

				return {
					user
				}
			}
		})
	})
	.get('/token', ({ user }) => user, {
	//                 ^?
		role: 'admin'
	})
```

:::


> Elysia use macro to pass custom argument to custom middleware

## Error handling

tRPC use middleware-like to handle error, while Elysia provide custom error with type safety, and error interceptor for both global and route specific error handler.

::: code-group

```ts [trpc]
import { initTRPC, TRPCError } from '@trpc/server'

const t = initTRPC.create()

class CustomError extends Error {
	constructor(message: string) {
		super(message)
		this.name = 'CustomError'
	}
}

const appRouter = t.router()
	.middleware(async ({ next }) => {
		try {
			return await next()
		} catch (error) {
			console.log(error)

			throw new TRPCError({
	  			code: 'INTERNAL_SERVER_ERROR',
	  			message: error.message
			})
		}
	})
	.query('error', () => {
		throw new CustomError('oh uh')
	})
```

:::


> tRPC use middleware-like to handle error

::: code-group

```ts twoslash [Elysia]
import { Elysia } from 'elysia'

class CustomError extends Error {
	// Optional: custom HTTP status code
	status = 500

	constructor(message: string) {
		super(message)
		this.name = 'CustomError'
	}

	// Optional: what should be sent to the client
	toResponse() {
		return {
			message: "If you're seeing this, our dev forgot to handle this error",
			error: this
		}
	}
}

const app = new Elysia()
	// Optional: register custom error class
	.error({
		CUSTOM: CustomError,
	})
	// Global error handler
	.onError(({ error, code }) => {
		if(code === 'CUSTOM')
		// ^?




			return {
				message: 'Something went wrong!',
				error
			}
	})
	.get('/error', () => {
		throw new CustomError('oh uh')
	}, {
		// Optional: route specific error handler
		error({ error }) {
			return {
				message: 'Only for this route!',
				error
			}
		}
	})
```

:::


> Elysia provide more granular control over error handling, and scoping mechanism

While tRPC offers error handling using middleware-like, Elysia provide:

1. Both global and route specific error handler
2. Shorthand for mapping HTTP status and `toResponse` for mapping error to a response
3. Provide a custom error code for each error

The error code is useful for logging and debugging, and is important when differentiating between different error types extending the same class.

Elysia provides all of this with type safety while tRPC doesn't.

## Encapsulation

tRPC encapsulate side-effect of a by procedure or router making it always isolated, while Elysia give you a control over side-effect of a plugin via explicit scoping mechanism, and order-of-code.

::: code-group

```ts [tRPC]
import { initTRPC } from '@trpc/server'

const t = initTRPC.create()

const subRouter = t.router()
	.middleware(({ ctx, next }) => {
		if(!ctx.headers.authorization?.startsWith('Bearer '))
			throw new TRPCError({
	  			code: 'UNAUTHORIZED',
	  			message: 'Unauthorized',
			})

		return next()
	})

const appRouter = t.router({
	// doesn't have side-effect from subRouter
	hello: t.procedure.query(() => 'Hello World'),
	api: subRouter
		.mutation('side-effect', () => 'hi')
})
```

:::


> tRPC encapsulate side-effect of a plugin into the procedure or router

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia()
	.onBeforeHandle(({ status, headers: { authorization } }) => {
		if(!authorization?.startsWith('Bearer '))
			return status(401)
   	})

const app = new Elysia()
    .get('/', 'Hello World')
    .use(subRouter)
    // doesn't have side-effect from subRouter
    .get('/side-effect', () => 'hi')
```

:::


> Elysia encapsulate side-effect of a plugin unless explicitly stated

Both has a encapsulate mechanism of a plugin to prevent side-effect.

However, Elysia can explicitly stated which plugin should have side-effect by declaring a scoped while Fastify always encapsulate it.

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia()
	.onBeforeHandle(({ status, headers: { authorization } }) => {
		if(!authorization?.startsWith('Bearer '))
			return status(401)
   	})
	// Scoped to parent instance but not beyond
	.as('scoped') // [!code ++]

const app = new Elysia()
    .get('/', 'Hello World')
    .use(subRouter)
    // [!code ++]
    // now have side-effect from subRouter
    .get('/side-effect', () => 'hi')
```

Elysia offers 3 type of scoping mechanism:

1. **local** - Apply to current instance only, no side-effect (default)
2. **scoped** - Scoped side-effect to the parent instance but not beyond
3. **global** - Affects every instances

## OpenAPI

tRPC doesn't offers OpenAPI first party, and relying on third-party library like `trpc-to-openapi` which is not a streamlined solution.

While Elysia has built-in support for OpenAPI using [@elysiajs/openapi](/plugins/openapi) from a single line of code.

::: code-group

```ts [tRPC]
import { initTRPC } from '@trpc/server'
import { createHTTPServer } from '@trpc/server/adapters/standalone'

import { OpenApiMeta } from 'trpc-to-openapi';

const t = initTRPC.meta<OpenApiMeta>().create()

const appRouter = t.router({
	user: t.procedure
		.meta({
			openapi: {
				method: 'post',
				path: '/users',
				tags: ['User'],
				summary: 'Create user',
			}
		})
		.input(
			t.array(
				t.object({
					name: t.string(),
					age: t.number()
				})
			)
		)
		.output(
			t.array(
				t.object({
					name: t.string(),
					age: t.number()
				})
			)
		)
		.mutation(({ input }) => input)
})

export const openApiDocument = generateOpenApiDocument(appRouter, {
  	title: 'tRPC OpenAPI',
  	version: '1.0.0',
  	baseUrl: 'http://localhost:3000'
})
```

:::


> tRPC rely on third-party library to generate OpenAPI spec

::: code-group

```ts twoslash [Elysia]
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi' // [!code ++]

const app = new Elysia()
	.use(openapi()) // [!code ++]
	.model({
		user: t.Array(
			t.Object({
				name: t.String(),
				age: t.Number()
			})
		)
	})
	.post('/users', ({ body }) => body, {
	//                  ^?
		body: 'user',
		response: {
			201: 'user'
		},
		detail: {
			summary: 'Create user'
		}
	})

```

:::


> Elysia seamlessly integrate the specification into the schema

tRPC rely on third-party library to generate OpenAPI spec, and **MUST** require you to define a correct path name and HTTP method in the metadata which is force you to be **consistently aware** of how you place a router, and procedure.

While Elysia use schema you provide to generate the OpenAPI specification, and validate the request/response, and infer type automatically all from a **single source of truth**.

Elysia also appends the schema registered in `model` to the OpenAPI spec, allowing you to reference the model in a dedicated section in Swagger or Scalar UI while this is missing on tRPC inline the schema to the route.

## Testing

Elysia use Web Standard API to handle request and response while tRPC require a lot of ceremony to run the request using `createCallerFactory`.

::: code-group

```ts [tRPC]
import { describe, it, expect } from 'vitest'

import { initTRPC } from '@trpc/server'
import { z } from 'zod'

const t = initTRPC.create()

const publicProcedure = t.procedure
const { createCallerFactory, router } = t

const appRouter = router({
	post: router({
		add: publicProcedure
			.input(
				z.object({
					title: z.string().min(2)
				})
			)
			.mutation(({ input }) => input)
	})
})

const createCaller = createCallerFactory(appRouter)

const caller = createCaller({})

describe('GET /', () => {
	it('should return Hello World', async () => {
		const newPost = await caller.post.add({
			title: '74 Itoki Hana'
		})

		expect(newPost).toEqual({
			title: '74 Itoki Hana'
		})
	})
})
```

:::


> tRPC require `createCallerFactory`, and a lot of ceremony to run the request

::: code-group

```ts [Elysia]
import { Elysia, t } from 'elysia'
import { describe, it, expect } from 'vitest'

const app = new Elysia()
	.post('/add', ({ body }) => body, {
		body: t.Object({
			title: t.String({ minLength: 2 })
		})
	})

describe('GET /', () => {
	it('should return Hello World', async () => {
		const res = await app.handle(
			new Request('http://localhost/add', {
				method: 'POST',
				body: JSON.stringify({ title: '74 Itoki Hana' }),
				headers: {
					'Content-Type': 'application/json'
				}
			})
		)

		expect(res.status).toBe(200)
		expect(await res.res()).toEqual({
			title: '74 Itoki Hana'
		})
	})
})
```

:::


> Elysia use Web Standard API to handle request and response

Alternatively, Elysia also offers a helper library called [Eden](/eden/overview) for End-to-end type safety which is similar to `tRPC.createCallerFactory`, allowing us to test with auto-completion, and full type safety like tRPC without the ceremony.

```ts twoslash [Elysia]
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'
import { describe, expect, it } from 'bun:test'

const app = new Elysia().get('/hello', 'Hello World')
const api = treaty(app)

describe('GET /', () => {
	it('should return Hello World', async () => {
		const { data, error, status } = await api.hello.get()

		expect(status).toBe(200)
		expect(data).toBe('Hello World')
		//      ^?
	})
})
```

## End-to-end type safety

Both offers end-to-end type safety for client-server communication.

::: code-group

```ts twoslash [tRPC]
import { initTRPC } from '@trpc/server'
import { createHTTPServer } from '@trpc/server/adapters/standalone'
import { z }  from 'zod'

import { createTRPCProxyClient, httpBatchLink } from '@trpc/client'

const t = initTRPC.create()

const appRouter = t.router({
	mirror: t.procedure
		.input(
			z.object({
				message: z.string()
			})
		)
		.output(
			z.object({
				message: z.string()
			})
		)
		.mutation(({ input }) => input)
})

const server = createHTTPServer({
  	router: appRouter
})

server.listen(3000)

const client = createTRPCProxyClient<typeof appRouter>({
	links: [
		httpBatchLink({
			url: 'http://localhost:3000'
		})
	]
})

const { message } = await client.mirror.mutate({
	message: 'Hello World'
})

message
// ^?




// ---cut-after---
console.log('ok')
```

:::


> tRPC use `createTRPCProxyClient` to create a client with end-to-end type safety

::: code-group

```ts twoslash [Elysia]
import { Elysia, t } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
	.post('/mirror', ({ body }) => body, {
		body: t.Object({
			message: t.String()
		})
	})

const api = treaty(app)

const { data, error } = await api.mirror.post({
	message: 'Hello World'
})

if(error)
	throw error
	//     ^?















console.log(data)
//          ^?



// ---cut-after---
console.log('ok')
```

:::


> Elysia use `treaty` to run the request, and offers end-to-end type safety

While both offers end-to-end type safety, tRPC only handle **happy path** where the request is successful, and doesn't have a type soundness of error handling, making it unsound.

If type soundness is important for you, then Elysia is the right choice.

***

While tRPC is a great framework for building type-safe APIs, it has its limitations in terms of RESTful compliance, and type soundness.

Elysia is designed to be ergonomic and developer-friendly with a focus on developer experience, and **type soundness** complying with RESTful, OpenAPI, and WinterTC Standard making it a better fit for building a universal API.

Alternatively, if you are coming from a different framework, you can check out:

---

---
url: 'https://elysiajs.com/tutorial/features/mount.md'
---

# Mount

Elysia æä¾›äº†ä¸€ä¸ª Elysia.mount ç”¨äºåœ¨åŸºäº Web æ ‡å‡†ï¼ˆå¦‚ Honoã€H3 ç­‰ï¼‰æ„å»ºçš„åç«¯æ¡†æ¶ä¹‹é—´äº’æ“ä½œã€‚

```typescript
import { Elysia, t } from 'elysia'
import { Hono } from 'hono'

const hono = new Hono()
	.get('/', (c) => c.text('Hello from Hono'))

new Elysia()
	.get('/', 'Hello from Elysia')
	.mount('/hono', hono.fetch)
	.listen(3000)
```

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿé€æ­¥å°†åº”ç”¨ç¨‹åºè¿ç§»åˆ° Elysiaï¼Œæˆ–è€…åœ¨å•ä¸ªåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨å¤šä¸ªæ¡†æ¶ã€‚

## ä»»åŠ¡

è®©æˆ‘ä»¬ä½¿ç”¨é¢„è§ˆæ¥ **GET '/hono'**ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„ Hono è·¯ç”±æ˜¯å¦å·¥ä½œã€‚

å°è¯•ä¿®æ”¹ä»£ç ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å˜åŒ–çš„ï¼

---

---
url: 'https://elysiajs.com/patterns/mount.md'
---

# Mount&#x20;

[WinterTC](https://wintertc.org/) æ˜¯ä¸€ä¸ªç”¨äºåœ¨ Cloudflareã€Denoã€Vercel ç­‰å¹³å°èƒŒåæ„å»º HTTP æœåŠ¡çš„æ ‡å‡†ã€‚

å®ƒå…è®¸ Web æœåŠ¡å™¨é€šè¿‡ä½¿ç”¨ [Request](https://developer.mozilla.org/en-US/docs/Web/API/Request) å’Œ [Response](https://developer.mozilla.org/en-US/docs/Web/API/Response) å®ç°è·¨è¿è¡Œæ—¶çš„äº’æ“ä½œè¿è¡Œã€‚

Elysia å…¼å®¹ WinterTCã€‚å·²é’ˆå¯¹ Bun è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä½†åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä¹Ÿæ”¯æŒå…¶ä»–è¿è¡Œæ—¶ã€‚

è¿™å…è®¸ä»»ä½•ç¬¦åˆ WinterCG æ ‡å‡†çš„æ¡†æ¶æˆ–ä»£ç å…±åŒè¿è¡Œï¼Œä»è€Œä½¿ Elysiaã€Honoã€Remixã€Itty Router ç­‰æ¡†æ¶å¯ä»¥ä¸€èµ·åœ¨ä¸€ä¸ªç®€å•çš„å‡½æ•°å†…è¿è¡Œã€‚

## Mount

è¦ä½¿ç”¨ **.mount**ï¼Œ[åªéœ€ä¼ é€’ä¸€ä¸ª `fetch` å‡½æ•°](https://twitter.com/saltyAom/status/1684786233594290176)ï¼š

```ts
import { Elysia } from 'elysia'
import { Hono } from 'hono'

const hono = new Hono()
	.get('/', (c) => c.text('Hello from Hono!'))

const app = new Elysia()
    .get('/', () => 'Hello from Elysia')
    .mount('/hono', hono.fetch)
```

ä»»ä½•ä½¿ç”¨ `Request` å’Œ `Response` çš„æ¡†æ¶éƒ½å¯ä»¥ä¸ Elysia å®ç°äº’æ“ä½œï¼Œä¾‹å¦‚ï¼š

* Hono
* Nitro
* H3
* [Nextjs API è·¯ç”±](/integrations/nextjs)
* [Nuxt API è·¯ç”±](/integrations/nuxt)
* [SvelteKit API è·¯ç”±](/integrations/sveltekit)

è¿™äº›æ¡†æ¶ä¹Ÿèƒ½åœ¨å¤šç§è¿è¡Œæ—¶ç¯å¢ƒä¸­ä½¿ç”¨ï¼š

* Bun
* Deno
* Vercel Edge Runtime
* Cloudflare Worker
* Netlify Edge Function

å¦‚æœæ¡†æ¶æ”¯æŒ **.mount** å‡½æ•°ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨å¦ä¸€ä¸ªæ¡†æ¶å†…éƒ¨æŒ‚è½½ Elysiaï¼š

```ts
import { Elysia } from 'elysia'
import { Hono } from 'hono'

const elysia = new Elysia()
    .get('/', () => 'Hello from Elysia inside Hono inside Elysia')

const hono = new Hono()
    .get('/', (c) => c.text('Hello from Hono!'))
    .mount('/elysia', elysia.fetch)

const main = new Elysia()
    .get('/', () => 'Hello from Elysia')
    .mount('/hono', hono.fetch)
    .listen(3000)
```

## é‡ç”¨ Elysia

æ­¤å¤–ï¼Œæ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šé‡ç”¨å¤šä¸ªç°æœ‰çš„ Elysia é¡¹ç›®ã€‚

```ts
import { Elysia } from 'elysia'

import A from 'project-a/elysia'
import B from 'project-b/elysia'
import C from 'project-c/elysia'

new Elysia()
    .mount(A)
    .mount(B)
    .mount(C)
```

å¦‚æœä¼ é€’ç»™ `mount` çš„å®ä¾‹æ˜¯ä¸€ä¸ª Elysia å®ä¾‹ï¼Œå®ƒå°†é€šè¿‡ `use` è‡ªåŠ¨è§£æï¼Œé»˜è®¤æä¾›ç±»å‹å®‰å…¨å’Œ Eden æ”¯æŒã€‚

è¿™ä½¿å¾—äº’æ“ä½œæ¡†æ¶å’Œè¿è¡Œæ—¶çš„å¯èƒ½æ€§æˆä¸ºç°å®ã€‚

---

---
url: 'https://elysiajs.com/tutorial/features/openapi.md'
---

# OpenAPI

Elysia æ˜¯å›´ç»• OpenAPI æ„å»ºçš„ï¼Œå¹¶æ”¯æŒå¼€ç®±å³ç”¨çš„ OpenAPI æ–‡æ¡£ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ OpenAPI æ’ä»¶ æ¥å±•ç¤º API æ–‡æ¡£ã€‚

```typescript
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi' // [!code ++]

new Elysia()
	.use(openapi()) // [!code ++]
	.post(
		'/',
		({ body }) => body,
		{
			body: t.Object({
				age: t.Number()
			})
		}
	)
	.listen(3000)
```

æ·»åŠ åï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ **/openapi** è®¿é—®æˆ‘ä»¬çš„ API æ–‡æ¡£ã€‚

## è¯¦æƒ…

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªéµå¾ª OpenAPI 3.0 è§„èŒƒçš„ `detail` å­—æ®µæä¾›æ–‡æ¡£ APIï¼ˆæ”¯æŒè‡ªåŠ¨è¡¥å…¨ï¼‰ï¼š

```typescript
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi'

new Elysia()
	.use(openapi())
	.post(
		'/',
		({ body }) => body,
		{
			body: t.Object({
				age: t.Number()
			}),
			detail: { // [!code ++]
				summary: 'åˆ›å»ºç”¨æˆ·', // [!code ++]
				description: 'æ ¹æ®å¹´é¾„åˆ›å»ºç”¨æˆ·', // [!code ++]
				tags: ['ç”¨æˆ·'], // [!code ++]
			} // [!code ++]
		}
	)
	.listen(3000)
```

## å‚è€ƒæ¨¡å‹

æˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰å¯é‡ç”¨çš„æ¨¡å¼ï¼Œä½¿ç”¨ å‚è€ƒæ¨¡å‹ï¼š

```typescript
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi'

new Elysia()
	.use(openapi())
	.model({
		age: t.Object({ // [!code ++]
			age: t.Number() // [!code ++]
		}) // [!code ++]
	})
	.post(
		'/',
		({ body }) => body,
		{
			age: t.Object({ // [!code --]
				age: t.Number() // [!code --]
			}), // [!code --]
			body: 'age',  // [!code ++]
			detail: {
				summary: 'åˆ›å»ºç”¨æˆ·',
				description: 'æ ¹æ®å¹´é¾„åˆ›å»ºç”¨æˆ·',
				tags: ['ç”¨æˆ·'],
			}
		}
	)
	.listen(3000)
```

å½“æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå‚è€ƒæ¨¡å‹æ—¶ï¼Œå®ƒå°†æ˜¾ç¤ºåœ¨ OpenAPI æ–‡æ¡£çš„ **ç»„ä»¶** éƒ¨åˆ†ã€‚

## ç±»å‹ç”Ÿæˆ

OpenAPI ç±»å‹ç”Ÿæˆ å¯ä»¥è‡ªåŠ¨æ–‡æ¡£åŒ–æ‚¨çš„ API **è€Œæ— éœ€æ‰‹åŠ¨æ³¨é‡Š**ï¼Œç›´æ¥ä» TypeScript ç±»å‹æ¨æ–­ã€‚æ— éœ€ Zodã€TypeBoxã€æ‰‹åŠ¨æ¥å£å£°æ˜ç­‰ã€‚

**æ­¤åŠŸèƒ½ä»…é€‚ç”¨äº Elysia**ï¼Œåœ¨å…¶ä»– JavaScript æ¡†æ¶ä¸­ä¸å¯ç”¨ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ Drizzle ORM æˆ– Prismaï¼ŒElysia å¯ä»¥ç›´æ¥ä»æŸ¥è¯¢ä¸­æ¨æ–­å‡ºæ¨¡å¼ã€‚

![Drizzle](/blog/openapi-type-gen/drizzle-typegen.webp)

> ä» Elysia è·¯ç”±å¤„ç†ç¨‹åºè¿”å› Drizzle æŸ¥è¯¢å°†è¢«è‡ªåŠ¨æ¨æ–­ä¸º OpenAPI æ¨¡å¼ã€‚

è¦ä½¿ç”¨ OpenAPI ç±»å‹ç”Ÿæˆï¼Œåªéœ€åœ¨ `openapi` æ’ä»¶ä¹‹å‰åº”ç”¨ `fromTypes` æ’ä»¶ã€‚

```typescript
import { Elysia } from 'elysia'

import { openapi, fromTypes } from '@elysiajs/openapi' // [!code ++]

new Elysia()
	.use(openapi({
		references: fromTypes() // [!code ++]
	}))
	.get('/', { hello: 'world' })
	.listen(3000)
```

### æµè§ˆå™¨ç¯å¢ƒ

ä¸å¹¸çš„æ˜¯ï¼Œæ­¤åŠŸèƒ½éœ€è¦ä¸€ä¸ª **fs** æ¨¡å—æ¥è¯»å–æ‚¨çš„æºä»£ç ï¼Œå› æ­¤åœ¨æ­¤ç½‘é¡µæ¸¸ä¹åœºä¸­ä¸å¯ç”¨ã€‚ç”±äº Elysia ç›´æ¥åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­è¿è¡Œï¼ˆè€Œä¸æ˜¯åœ¨åˆ†ç¦»çš„æœåŠ¡å™¨ä¸Šï¼‰ã€‚

æ‚¨å¯ä»¥åœ¨æœ¬åœ°å°è¯•æ­¤åŠŸèƒ½ï¼Œä½¿ç”¨ Type Gen ç¤ºä¾‹ä»“åº“ï¼š

```bash
git clone https://github.com/SaltyAom/elysia-typegen-example && \
cd elysia-typegen-example && \
bun install && \
bun run dev
```

## ä½œä¸š

è®©æˆ‘ä»¬ä½¿ç”¨é¢„è§ˆæ¥ **GET '/openapi'**ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„ API æ–‡æ¡£æ˜¯ä»€ä¹ˆæ ·å­ã€‚

è¿™ä¸ª API æ–‡æ¡£æ˜¯ä»ä½ çš„ä»£ç åæ˜ è¿‡æ¥çš„ã€‚

å°è¯•ä¿®æ”¹ä»£ç ï¼Œçœ‹çœ‹æ–‡æ¡£å¦‚ä½•å˜åŒ–ï¼

---

---
url: 'https://elysiajs.com/patterns/openapi.md'
---

# OpenAPI&#x20;

Elysia é»˜è®¤æ”¯æŒå¹¶éµå¾ª OpenAPI è§„èŒƒã€‚

Elysia å¯ä»¥é€šè¿‡ä½¿ç”¨ OpenAPI æ’ä»¶è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£é¡µé¢ã€‚

è¦ç”Ÿæˆ Swagger é¡µé¢ï¼Œéœ€å®‰è£…è¯¥æ’ä»¶ï¼š

```bash
bun add @elysiajs/openapi
```

å¹¶å°†æ’ä»¶æ³¨å†Œåˆ°æœåŠ¡å™¨ï¼š

```typescript
import { Elysia } from 'elysia'
import { openapi } from '@elysiajs/openapi' // [!code ++]

new Elysia()
	.use(openapi()) // [!code ++]
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia ä½¿ç”¨ OpenAPI V3 è§„èŒƒå’Œ [Scalar UI](http://scalar.com)

é€šè¿‡è®¿é—® `/openapi`ï¼Œä½ å°†çœ‹åˆ°ç”± Elysia æœåŠ¡å™¨ç”Ÿæˆçš„ç«¯ç‚¹æ–‡æ¡£çš„ Scalar UI ç•Œé¢ã€‚

æœ‰å…³ OpenAPI æ’ä»¶é…ç½®ï¼Œè¯·å‚è§[OpenAPI æ’ä»¶é¡µé¢](/plugins/openapi)ã€‚

## ä»ç±»å‹ç”Ÿæˆ OpenAPI

> è¿™æ˜¯å¯é€‰çš„ï¼Œä½†æˆ‘ä»¬å¼ºçƒˆæ¨èè¿™æ ·åšï¼Œä»¥è·å¾—æ›´å¥½çš„æ–‡æ¡£ä½“éªŒã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia ä¾èµ–è¿è¡Œæ—¶çš„ schema æ¥ç”Ÿæˆ OpenAPI æ–‡æ¡£ã€‚

ä½†æ˜¯ï¼Œä½ ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ OpenAPI æ’ä»¶ä¸­çš„ç”Ÿæˆå™¨æ ¹æ®ç±»å‹ç”Ÿæˆ OpenAPI æ–‡æ¡£ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š

1. æŒ‡å®šä½ çš„ Elysia æ ¹æ–‡ä»¶ï¼ˆå¦‚æœæœªæŒ‡å®šï¼ŒElysia å°†ä½¿ç”¨ `src/index.ts`ï¼‰ï¼Œå¹¶å¯¼å‡ºä¸€ä¸ªå®ä¾‹

2. å¯¼å…¥ç”Ÿæˆå™¨å¹¶å‘ç±»å‹ç”Ÿæˆå™¨æä¾›**ç›¸å¯¹äºé¡¹ç›®æ ¹çš„æ–‡ä»¶è·¯å¾„**

```ts
import { Elysia, t } from 'elysia'
import { openapi, fromTypes } from '@elysiajs/openapi' // [!code ++]

export const app = new Elysia() // [!code ++]
    .use(
        openapi({
            references: fromTypes() // [!code ++]
        })
    )
    .get('/', { test: 'hello' as const })
    .post('/json', ({ body, status }) => body, {
        body: t.Object({
            hello: t.String()
        })
    })
    .listen(3000)
```

Elysia ä¼šå°è¯•é€šè¿‡è¯»å–å¯¼å‡ºå®ä¾‹çš„ç±»å‹æ¥ç”Ÿæˆ OpenAPI æ–‡æ¡£ã€‚

è¿™å°†ä¸è¿è¡Œæ—¶çš„ schema å…±å­˜ï¼Œä¸”è¿è¡Œæ—¶ schema ä¼šä¼˜å…ˆäºç±»å‹å®šä¹‰ã€‚

### ç”Ÿäº§ç¯å¢ƒ

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½ å¾ˆå¯èƒ½ä¼šå°† Elysia ç¼–è¯‘ä¸º [Bun å•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶](/patterns/deploy.html) æˆ– [æ‰“åŒ…ä¸ºå•ä¸ª JavaScript æ–‡ä»¶](https://elysiajs.com/patterns/deploy.html#compile-to-javascript)ã€‚

æ¨èé¢„å…ˆç”Ÿæˆå£°æ˜æ–‡ä»¶ï¼ˆ**.d.ts**ï¼‰æ¥æä¾›ç±»å‹å£°æ˜ç»™ç”Ÿæˆå™¨ã€‚

```ts
import { Elysia, t } from 'elysia'
import { openapi, fromTypes } from '@elysiajs/openapi'

const app = new Elysia()
    .use(
        openapi({
            references: fromTypes(
            	process.env.NODE_ENV === 'production' // [!code ++]
             		? 'dist/index.d.ts' // [!code ++]
               		: 'src/index.ts' // [!code ++]
            )
        })
    )
```

### æ³¨æ„äº‹é¡¹ï¼šæ ¹è·¯å¾„

ç”±äºæ¨æ–­é¡¹ç›®æ ¹ç›®å½•ä¸å¯é ï¼Œå»ºè®®æ˜ç¡®æä¾›é¡¹ç›®æ ¹è·¯å¾„ï¼Œè¿™æ ·ç”Ÿæˆå™¨æ‰èƒ½æ­£ç¡®è¿è¡Œï¼Œå°¤å…¶åœ¨ä½¿ç”¨ monorepo æ—¶ã€‚

```ts
import { Elysia, t } from 'elysia'
import { openapi, fromTypes } from '@elysiajs/openapi'

export const app = new Elysia()
    .use(
        openapi({
            references: fromTypes('src/index.ts', {
            	projectRoot: path.join('..', import.meta.dir) // [!code ++]
            })
        })
    )
    .get('/', { test: 'hello' as const })
    .post('/json', ({ body, status }) => body, {
        body: t.Object({
            hello: t.String()
        })
    })
    .listen(3000)
```

### è‡ªå®šä¹‰ tsconfig.json

å¦‚æœä½ æœ‰å¤šä¸ª `tsconfig.json`ï¼ŒåŠ¡å¿…æŒ‡å®šæ­£ç¡®çš„ `tsconfig.json` æ–‡ä»¶ç”¨äºç±»å‹ç”Ÿæˆã€‚

```ts
import { Elysia, t } from 'elysia'
import { openapi, fromTypes } from '@elysiajs/openapi'

export const app = new Elysia()
    .use(
        openapi({
            references: fromTypes('src/index.ts', {
            	// è¿™æ˜¯ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•çš„è·¯å¾„
            	tsconfigPath: 'tsconfig.dts.json' // [!code ++]
            })
        })
    )
    .get('/', { test: 'hello' as const })
    .post('/json', ({ body, status }) => body, {
        body: t.Object({
            hello: t.String()
        })
    })
    .listen(3000)
```

## ä½¿ç”¨æ ‡å‡† Schema ç”Ÿæˆ OpenAPI

Elysia ä¼šå°è¯•ä½¿ç”¨æ¯ä¸ª schema è‡ªå¸¦çš„æ–¹æ³•æ¥è½¬æ¢ä¸º OpenAPI schemaã€‚

å¦‚æœ schema æ²¡æœ‰æä¾›åŸç”Ÿæ–¹æ³•ï¼Œä½ å¯ä»¥é€šè¿‡ç»™ OpenAPI æä¾› `mapJsonSchema` è‡ªå®šä¹‰è½¬æ¢å‡½æ•°ï¼Œä¾‹å¦‚ï¼š

\<Tab
id="schema-openapi"
noTitle
:names="\['Zod', 'Valibot', 'Effect']"
:tabs="\['zod', 'valibot', 'effect']"

>

### Zod OpenAPI

ç”±äº Zod çš„ schema ä¸Šæ²¡æœ‰ `toJSONSchema` æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦æä¾›è‡ªå®šä¹‰æ˜ å°„å‡½æ•°ï¼Œå°† Zod schema è½¬æ¢ä¸º OpenAPI schemaã€‚

::: code-group

```typescript [Zod 4]
import openapi from '@elysiajs/openapi'
import * as z from 'zod'

openapi({
	mapJsonSchema: {
		zod: z.toJSONSchema
	}
})
```

```typescript [Zod 3]
import openapi from '@elysiajs/openapi'
import { zodToJsonSchema } from 'zod-to-json-schema'

openapi({
	mapJsonSchema: {
		zod: zodToJsonSchema
	}
})
```

:::

### Valibot OpenAPI

Valibot ä½¿ç”¨ç‹¬ç«‹åŒ…ï¼ˆ`@valibot/to-json-schema`ï¼‰æ¥è½¬æ¢ Valibot schema ä¸º JSON Schemaã€‚

```typescript
import openapi from '@elysiajs/openapi'
import { toJsonSchema } from '@valibot/to-json-schema'

openapi({
	mapJsonSchema: {
		valibot: toJsonSchema
	}
})
```

### Effect OpenAPI

ç”±äº Effect çš„ schema ä¸Šæ²¡æœ‰ `toJSONSchema` æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦æä¾›è‡ªå®šä¹‰æ˜ å°„å‡½æ•°ï¼Œå°† Effect schema è½¬æ¢ä¸º OpenAPI schemaã€‚

```typescript
import openapi from '@elysiajs/openapi'
import { JSONSchema } from 'effect'

openapi({
 	mapJsonSchema: {
   		effect: JSONSchema.make
 	}
})
```

## æè¿°è·¯ç”±

æˆ‘ä»¬å¯ä»¥é€šè¿‡æä¾› schema ç±»å‹æ¥æ·»åŠ è·¯ç”±ä¿¡æ¯ã€‚

ä½†æœ‰æ—¶ä»…å®šä¹‰ç±»å‹å¹¶ä¸æ¸…æ™°è·¯ç”±å…·ä½“åŠŸèƒ½ã€‚ä½ å¯ä»¥ä½¿ç”¨ [detail](/plugins/openapi#detail) å­—æ®µæ˜ç¡®æè¿°è·¯ç”±ã€‚

```typescript
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi'

new Elysia()
	.use(openapi())
	.post(
		'/sign-in',
		({ body }) => body, {
    		body: t.Object(
      		{
	            username: t.String(),
	            password: t.String({
	                minLength: 8,
	                description: 'ç”¨æˆ·å¯†ç ï¼ˆè‡³å°‘8ä¸ªå­—ç¬¦ï¼‰' // [!code ++]
	            })
	        },
	        { // [!code ++]
	            description: 'éœ€è¦ç”¨æˆ·åå’Œå¯†ç ' // [!code ++]
	        } // [!code ++]
	    ),
	    detail: { // [!code ++]
	        summary: 'ç”¨æˆ·ç™»å½•', // [!code ++]
	        tags: ['authentication'] // [!code ++]
	    } // [!code ++]
	})
```

detail å­—æ®µéµå¾ª OpenAPI V3 å®šä¹‰ï¼Œé»˜è®¤å…·å¤‡è‡ªåŠ¨è¡¥å…¨å’Œç±»å‹å®‰å…¨ã€‚

detail ä¼šä¼ é€’ç»™ OpenAPIï¼Œä¸ºè·¯ç”±æ·»åŠ æè¿°ã€‚

## å“åº”å¤´

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ `withHeader` åŒ…è£… schema æ¥æ·»åŠ å“åº”å¤´ï¼š

```typescript
import { Elysia, t } from 'elysia'
import { openapi, withHeader } from '@elysiajs/openapi' // [!code ++]

new Elysia()
	.use(openapi())
	.get(
		'/thing',
		({ body, set }) => {
			set.headers['x-powered-by'] = 'Elysia'

			return body
		},
		{
		    response: withHeader( // [!code ++]
				t.Literal('Hi'), // [!code ++]
				{ // [!code ++]
					'x-powered-by': t.Literal('Elysia') // [!code ++]
				} // [!code ++]
			) // [!code ++]
		}
	)
```

æ³¨æ„ï¼Œ`withHeader` ä»…ä½œæ³¨è§£ç”¨ï¼Œä¸ä¼šå¼ºåˆ¶æˆ–éªŒè¯å®é™…å“åº”å¤´ã€‚ä½ éœ€è¦æ‰‹åŠ¨è®¾ç½®å“åº”å¤´ã€‚

### éšè—è·¯ç”±

ä½ å¯ä»¥é€šè¿‡å°† `detail.hide` è®¾ç½®ä¸º `true` æ¥éšè— Swagger é¡µé¢ä¸­çš„è·¯ç”±ã€‚

```typescript
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi'

new Elysia()
	.use(openapi())
	.post(
		'/sign-in',
		({ body }) => body,
		{
		    body: t.Object(
		        {
		            username: t.String(),
		            password: t.String()
		        },
		        {
		            description: 'éœ€è¦ç”¨æˆ·åå’Œå¯†ç '
		        }
		    ),
		    detail: { // [!code ++]
		        hide: true // [!code ++]
		    } // [!code ++]
		}
	)
```

## æ ‡ç­¾

Elysia å¯ä»¥é€šè¿‡ Swagger çš„æ ‡ç­¾ç³»ç»Ÿå°†ç«¯ç‚¹åˆ†ç»„ã€‚

é¦–å…ˆï¼Œåœ¨ Swagger é…ç½®å¯¹è±¡ä¸­å®šä¹‰å¯ç”¨çš„æ ‡ç­¾

```typescript
new Elysia().use(
    openapi({
        documentation: {
            tags: [
                { name: 'App', description: 'é€šç”¨ç«¯ç‚¹' },
                { name: 'Auth', description: 'èº«ä»½éªŒè¯ç«¯ç‚¹' }
            ]
        }
    })
)
```

ç„¶åï¼Œåœ¨ç«¯ç‚¹é…ç½®éƒ¨åˆ†çš„ detail å±æ€§ä¸­ä¸ºè¯¥ç«¯ç‚¹æŒ‡å®šæ ‡ç­¾

```typescript
new Elysia()
    .get('/', () => 'Hello Elysia', {
        detail: {
            tags: ['App']
        }
    })
    .group('/auth', (app) =>
        app.post(
            '/sign-up',
            ({ body }) =>
                db.user.create({
                    data: body,
                    select: {
                        id: true,
                        username: true
                    }
                }),
            {
                detail: {
                    tags: ['Auth']
                }
            }
        )
    )
```

è¿™å°†ç”Ÿæˆå¦‚ä¸‹çš„ Swagger é¡µé¢


### æ ‡ç­¾åˆ†ç»„

Elysia ä¹Ÿå¯æ¥å—æ ‡ç­¾ï¼Œå°†æ•´ä¸ªå®ä¾‹æˆ–è·¯ç”±ç»„å½’åˆ°ç‰¹å®šæ ‡ç­¾ä¸‹ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia({
    tags: ['user']
})
    .get('/user', 'user')
    .get('/admin', 'admin')
```

## æ¨¡å‹

é€šè¿‡ä½¿ç”¨[å¼•ç”¨æ¨¡å‹](/essential/validation.html#reference-model)ï¼ŒElysia ä¼šè‡ªåŠ¨å¤„ç† schema ç”Ÿæˆã€‚

å°†æ¨¡å‹åˆ†ç¦»åˆ°ä¸“é—¨çš„éƒ¨åˆ†å¹¶é€šè¿‡å¼•ç”¨é“¾æ¥ã€‚

```typescript
new Elysia()
    .model({
        User: t.Object({
            id: t.Number(),
            username: t.String()
        })
    })
    .get('/user', () => ({ id: 1, username: 'saltyaom' }), {
        response: {
            200: 'User'
        },
        detail: {
            tags: ['User']
        }
    })
```

## å®ˆå«

å¦å¤–ï¼ŒElysia ä¹Ÿå¯é€šè¿‡å®ˆå«å°†æ•´ä¸ªå®ä¾‹æˆ–è·¯ç”±ç»„å…³è”åˆ°ç‰¹å®šå®ˆå«ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
    .guard({
        detail: {
            description: 'è¦æ±‚ç”¨æˆ·å¿…é¡»ç™»å½•'
        }
    })
    .get('/user', 'user')
    .get('/admin', 'admin')
```

## æ›´æ”¹ OpenAPI ç«¯ç‚¹

ä½ å¯ä»¥é€šè¿‡åœ¨æ’ä»¶é…ç½®ä¸­è®¾ç½® [path](#path) æ¥æ›´æ”¹ OpenAPI ç«¯ç‚¹ã€‚

```typescript twoslash
import { Elysia } from 'elysia'
import { openapi } from '@elysiajs/openapi'

new Elysia()
    .use(
        openapi({
            path: '/v2/openapi'
        })
    )
    .listen(3000)
```

## è‡ªå®šä¹‰ OpenAPI ä¿¡æ¯

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨æ’ä»¶é…ç½®ä¸­è®¾ç½® [documentation.info](#documentationinfo) æ¥è‡ªå®šä¹‰ OpenAPI ä¿¡æ¯ã€‚

```typescript twoslash
import { Elysia } from 'elysia'
import { openapi } from '@elysiajs/openapi'

new Elysia()
    .use(
        openapi({
            documentation: {
                info: {
                    title: 'Elysia æ–‡æ¡£',
                    version: '1.0.0'
                }
            }
        })
    )
    .listen(3000)
```

è¿™å¯¹äºä»¥ä¸‹æƒ…å†µéå¸¸æœ‰ç”¨ï¼š

* æ·»åŠ æ ‡é¢˜
* è®¾ç½® API ç‰ˆæœ¬
* æ·»åŠ æè¿°è¯´æ˜æˆ‘ä»¬çš„ API æ˜¯å…³äºä»€ä¹ˆçš„
* è§£é‡Šå¯ç”¨çš„æ ‡ç­¾ï¼Œä»¥åŠæ¯ä¸ªæ ‡ç­¾çš„å«ä¹‰

## å®‰å…¨é…ç½®

ä¸ºäº†ä¿æŠ¤ä½ çš„ API ç«¯ç‚¹ï¼Œä½ å¯ä»¥åœ¨ Swagger é…ç½®ä¸­å®šä¹‰å®‰å…¨æ–¹æ¡ˆã€‚ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Bearer è®¤è¯ (JWT) ä¿æŠ¤ç«¯ç‚¹ï¼š

```typescript
new Elysia().use(
    openapi({
        documentation: {
            components: {
                securitySchemes: {
                    bearerAuth: {
                        type: 'http',
                        scheme: 'bearer',
                        bearerFormat: 'JWT'
                    }
                }
            }
        }
    })
)

export const addressController = new Elysia({
    prefix: '/address',
    detail: {
        tags: ['Address'],
        security: [
            {
                bearerAuth: []
            }
        ]
    }
})
```

è¿™å°†ç¡®ä¿ `/address` å‰ç¼€ä¸‹çš„æ‰€æœ‰ç«¯ç‚¹éƒ½éœ€è¦æœ‰æ•ˆçš„ JWT ä»¤ç‰Œæ‰èƒ½è®¿é—®ã€‚

---

---
url: 'https://elysiajs.com/plugins/openapi.md'
---

# OpenAPI æ’ä»¶&#x20;

ä¸º [elysia](https://github.com/elysiajs/elysia) æä¾›è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£é¡µé¢çš„æ’ä»¶ã€‚

å®‰è£…å‘½ä»¤ï¼š

```bash
bun add @elysiajs/openapi
```

ç„¶åä½¿ç”¨è¯¥æ’ä»¶ï¼š

```typescript twoslash
import { Elysia } from 'elysia'
import { openapi } from '@elysiajs/openapi'

new Elysia()
    .use(openapi())
    .get('/', () => 'hello')
    .post('/hello', () => 'OpenAPI')
    .listen(3000)
```

è®¿é—® `/openapi` ä¼šå±•ç¤ºä¸€ä¸ª Scalar UIï¼Œæ ¹æ® Elysia æœåŠ¡å™¨ç”Ÿæˆçš„ç«¯ç‚¹æ–‡æ¡£ã€‚ä½ ä¹Ÿå¯ä»¥è®¿é—® `/openapi/json` æ¥è·å–åŸå§‹çš„ OpenAPI è§„èŒƒã€‚

::: tip
æ­¤é¡µé¢ä¸ºæ’ä»¶é…ç½®å‚è€ƒã€‚

å¦‚æœä½ åœ¨å¯»æ‰¾ OpenAPI çš„å¸¸è§æ¨¡å¼æˆ–é«˜çº§ç”¨æ³•ï¼Œè¯·æŸ¥çœ‹ [Patterns: OpenAPI](/patterns/openapi)
:::

## è¯¦æƒ…

`detail` æ‰©å±•äº† [OpenAPI Operation Object](https://spec.openapis.org/oas/v3.0.3.html#operation-object) è§„èŒƒã€‚

detail å­—æ®µæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨äºæè¿°ç”¨äº API æ–‡æ¡£çš„è·¯ç”±ä¿¡æ¯ã€‚

å®ƒå¯èƒ½åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

## detail.hide

ä½ å¯ä»¥é€šè¿‡è®¾ç½® `detail.hide` ä¸º `true` æ¥éšè—è¯¥è·¯ç”±ï¼Œä¸åœ¨ Swagger é¡µé¢æ˜¾ç¤ºã€‚

```typescript
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi'

new Elysia().use(openapi()).post('/sign-in', ({ body }) => body, {
    body: t.Object(
        {
            username: t.String(),
            password: t.String()
        },
        {
            description: 'æœŸæœ›æ¥æ”¶ç”¨æˆ·åå’Œå¯†ç '
        }
    ),
    detail: {
        // [!code ++]
        hide: true // [!code ++]
    } // [!code ++]
})
```

### detail.deprecated

å£°æ˜è¯¥æ“ä½œå·²è¢«å¼ƒç”¨ã€‚ä½¿ç”¨è€…åº”é¿å…ä½¿ç”¨è¯¥æ“ä½œã€‚é»˜è®¤å€¼ä¸º `false`ã€‚

### detail.description

å¯¹æ“ä½œè¡Œä¸ºçš„è¯¦ç»†è¯´æ˜ã€‚

### detail.summary

è¯¥æ“ä½œçš„ç®€çŸ­æ‘˜è¦ã€‚

## é…ç½®

ä»¥ä¸‹æ˜¯æ’ä»¶æ¥å—çš„é…ç½®é¡¹

## enabled

@default true
å¯ç”¨/ç¦ç”¨è¯¥æ’ä»¶

## documentation

OpenAPI æ–‡æ¡£ä¿¡æ¯

@see https://spec.openapis.org/oas/v3.0.3.html

## exclude

é…ç½®æ’é™¤ä¸åœ¨æ–‡æ¡£ä¸­çš„è·¯å¾„æˆ–æ–¹æ³•

## exclude.methods

æ’é™¤æ–‡æ¡£çš„è¯·æ±‚æ–¹æ³•åˆ—è¡¨

## exclude.paths

æ’é™¤æ–‡æ¡£çš„è·¯å¾„åˆ—è¡¨

## exclude.staticFile

@default true

æ’é™¤é™æ€æ–‡ä»¶è·¯ç”±ï¼Œä¸ç”Ÿæˆæ–‡æ¡£

## exclude.tags

æ’é™¤æ–‡æ¡£çš„æ ‡ç­¾åˆ—è¡¨

## mapJsonSchema

A custom mapping function from Standard schema to OpenAPI schema

### Example

```typescript
import { openapi } from '@elysiajs/openapi'
import { toJsonSchema } from '@valibot/to-json-schema'

openapi({
	mapJsonSchema: {
	  	valibot: toJsonSchema
  	}
})
```

## path

@default '/openapi'

æš´éœ² OpenAPI æ–‡æ¡£å‰ç«¯çš„ç«¯ç‚¹è·¯å¾„

## provider

@default 'scalar'

OpenAPI æ–‡æ¡£å‰ç«¯å®ç°é€‰é¡¹ï¼š

* [Scalar](https://github.com/scalar/scalar)
* [SwaggerUI](https://github.com/swagger-api/swagger-ui)
* nullï¼šç¦ç”¨å‰ç«¯é¡µé¢

## references

æ¯ä¸ªç«¯ç‚¹çš„é¢å¤– OpenAPI å¼•ç”¨é…ç½®

## scalar

Scalar é…ç½®ï¼Œå‚è€ƒ [Scalar config](https://github.com/scalar/scalar/blob/main/documentation/configuration.md)

## specPath

@default '/${path}/json'

æš´éœ² OpenAPI è§„èŒƒï¼ˆJSON æ ¼å¼ï¼‰çš„ç«¯ç‚¹è·¯å¾„

## swagger

Swagger é…ç½®ï¼Œå‚è€ƒ [Swagger config](https://swagger.io/docs/open-source-tools/swagger-ui/usage/configuration/)

ä¸‹é¢ä½ å¯ä»¥æ‰¾åˆ°ä½¿ç”¨è¯¥æ’ä»¶çš„å¸¸è§æ¨¡å¼ã€‚

---

---
url: 'https://elysiajs.com/patterns/opentelemetry.md'
---

# OpenTelemetry

è¦å¼€å§‹ä½¿ç”¨ OpenTelemetryï¼Œè¯·å®‰è£… `@elysiajs/opentelemetry` å¹¶å°†æ’ä»¶åº”ç”¨äºä»»ä½•å®ä¾‹ã€‚

```typescript
import { Elysia } from 'elysia'
import { opentelemetry } from '@elysiajs/opentelemetry'

new Elysia()
	.use(opentelemetry())
```

![jaeger æ˜¾ç¤ºæ”¶é›†åˆ°çš„è·Ÿè¸ªä¿¡æ¯](/blog/elysia-11/jaeger.webp)

Elysia OpenTelemetry å°† **æ”¶é›†ä¸ OpenTelemetry æ ‡å‡†å…¼å®¹çš„ä»»ä½•åº“çš„ span**ï¼Œå¹¶ä¼šè‡ªåŠ¨åº”ç”¨çˆ¶å­ spanã€‚

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åº”ç”¨ `Prisma` æ¥è·Ÿè¸ªæ¯ä¸ªæŸ¥è¯¢æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚

é€šè¿‡åº”ç”¨ OpenTelemetryï¼ŒElysia å°†ï¼š

* æ”¶é›†é¥æµ‹æ•°æ®
* å°†ç›¸å…³ç”Ÿå‘½å‘¨æœŸåˆ†ç»„
* æµ‹é‡æ¯ä¸ªå‡½æ•°æ‰€èŠ±è´¹çš„æ—¶é—´
* å¯¹ HTTP è¯·æ±‚å’Œå“åº”è¿›è¡Œä»ªå™¨åŒ–
* æ”¶é›†é”™è¯¯å’Œå¼‚å¸¸

æ‚¨å¯ä»¥å°†é¥æµ‹æ•°æ®å¯¼å‡ºåˆ° Jaegerã€Zipkinã€New Relicã€Axiom æˆ–ä»»ä½•å…¶ä»–ä¸ OpenTelemetry å…¼å®¹çš„åç«¯ã€‚

![axiom æ˜¾ç¤ºæ”¶é›†åˆ°çš„ OpenTelemetry è·Ÿè¸ªä¿¡æ¯](/blog/elysia-11/axiom.webp)

ä»¥ä¸‹æ˜¯å°†é¥æµ‹æ•°æ®å¯¼å‡ºåˆ° [Axiom](https://axiom.co) çš„ç¤ºä¾‹

```typescript
import { Elysia } from 'elysia'
import { opentelemetry } from '@elysiajs/opentelemetry'

import { BatchSpanProcessor } from '@opentelemetry/sdk-trace-node'
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-proto'

new Elysia().use(
	opentelemetry({
		spanProcessors: [
			new BatchSpanProcessor(
				new OTLPTraceExporter({
					url: 'https://api.axiom.co/v1/traces', // [!code ++]
					headers: {
						// [!code ++]
						Authorization: `Bearer ${Bun.env.AXIOM_TOKEN}`, // [!code ++]
						'X-Axiom-Dataset': Bun.env.AXIOM_DATASET // [!code ++]
					} // [!code ++]
				})
			)
		]
	})
)
```

## OpenTelemetry SDK

Elysia OpenTelemetry ä»…ç”¨äºå°† OpenTelemetry åº”ç”¨åˆ° Elysia æœåŠ¡å™¨ã€‚

æ‚¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ OpenTelemetry SDKï¼Œå¹¶ä¸” span åœ¨ Elysia çš„è¯·æ±‚ span ä¸‹è¿è¡Œï¼Œå®ƒå°†è‡ªåŠ¨å‡ºç°åœ¨ Elysia çš„è·Ÿè¸ªä¸­ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬ä¹Ÿæä¾› `getTracer` å’Œ `record` å®ç”¨å·¥å…·ï¼Œä»¥ä¾¿ä»æ‚¨åº”ç”¨çš„ä»»ä½•éƒ¨åˆ†æ”¶é›† spanã€‚

```typescript
import { Elysia } from 'elysia'
import { record } from '@elysiajs/opentelemetry'

export const plugin = new Elysia().get('', () => {
	return record('database.query', () => {
		return db.query('SELECT * FROM users')
	})
})
```

## Record å®ç”¨å·¥å…·

`record` ç›¸å½“äº OpenTelemetry çš„ `startActiveSpan`ï¼Œä½†å®ƒå°†è‡ªåŠ¨å¤„ç†å…³é—­å¹¶æ•è·å¼‚å¸¸ã€‚

æ‚¨å¯ä»¥å°† `record` çœ‹ä½œæ˜¯æ‚¨çš„ä»£ç çš„æ ‡ç­¾ï¼Œè¿™å°†åœ¨è·Ÿè¸ªä¸­æ˜¾ç¤ºã€‚

### ä¸ºå¯è§‚å¯Ÿæ€§å‡†å¤‡æ‚¨çš„ä»£ç åº“

Elysia OpenTelemetry å°†åˆ†ç»„ç”Ÿå‘½å‘¨æœŸå¹¶è¯»å–æ¯ä¸ªé’©å­çš„ **å‡½æ•°åç§°** ä½œä¸º span çš„åç§°ã€‚

ç°åœ¨æ˜¯ **å‘½åæ‚¨çš„å‡½æ•°** çš„å¥½æ—¶æœºã€‚

å¦‚æœæ‚¨çš„é’©å­å¤„ç†ç¨‹åºæ˜¯ä¸€ä¸ªç®­å¤´å‡½æ•°ï¼Œæ‚¨å¯ä»¥å°†å…¶é‡æ„ä¸ºå‘½åå‡½æ•°ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£è·Ÿè¸ªï¼Œå¦åˆ™ï¼Œæ‚¨çš„è·Ÿè¸ª span å°†è¢«å‘½åä¸º `anonymous`ã€‚

```typescript
const bad = new Elysia()
	// âš ï¸ span åç§°å°†æ˜¯åŒ¿åçš„
	.derive(async ({ cookie: { session } }) => {
		return {
			user: await getProfile(session)
		}
	})

const good = new Elysia()
	// âœ… span åç§°å°†æ˜¯ getProfile
	.derive(async function getProfile({ cookie: { session } }) {
		return {
			user: await getProfile(session)
		}
	})
```

## getCurrentSpan

`getCurrentSpan` æ˜¯ä¸€ä¸ªå®ç”¨å·¥å…·ï¼Œç”¨äºåœ¨å¤„ç†ç¨‹åºå¤–éƒ¨è·å–å½“å‰è¯·æ±‚çš„å½“å‰ spanã€‚

```typescript
import { getCurrentSpan } from '@elysiajs/opentelemetry'

function utility() {
	const span = getCurrentSpan()
	span.setAttributes({
		'custom.attribute': 'value'
	})
}
```

è¿™åœ¨å¤„ç†ç¨‹åºå¤–éƒ¨é€šè¿‡ä» `AsyncLocalStorage` è·å–å½“å‰ span è€Œå·¥ä½œã€‚

## setAttributes

`setAttribute` æ˜¯ä¸€ä¸ªç”¨äºå°†å±æ€§è®¾ç½®ä¸ºå½“å‰ span çš„å®ç”¨å·¥å…·ã€‚

```typescript
import { setAttributes } from '@elysiajs/opentelemetry'

function utility() {
	setAttributes({
		'custom.attribute': 'value'
	})
}
```

è¿™æ˜¯ `getCurrentSpan().setAttributes` çš„è¯­æ³•ç³–ã€‚

## é…ç½®

è¯·æŸ¥çœ‹ [opentelemetry æ’ä»¶](/plugins/opentelemetry) ä»¥è·å–é…ç½®é€‰é¡¹å’Œå®šä¹‰ã€‚

## ä»ªå™¨åŒ– é«˜çº§æ¦‚å¿µ

è®¸å¤šä»ªå™¨åŒ–åº“è¦æ±‚ SDK **å¿…é¡»** åœ¨å¯¼å…¥æ¨¡å—ä¹‹å‰è¿è¡Œã€‚

ä¾‹å¦‚ï¼Œè¦ä½¿ç”¨ `PgInstrumentation`ï¼Œ`OpenTelemetry SDK` å¿…é¡»åœ¨å¯¼å…¥ `pg` æ¨¡å—ä¹‹å‰è¿è¡Œã€‚

è¦åœ¨ Bun ä¸­å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥

1. å°† OpenTelemetry è®¾ç½®åˆ†æˆä¸€ä¸ªä¸åŒçš„æ–‡ä»¶
2. åˆ›å»º `bunfig.toml` ä»¥é¢„åŠ è½½ OpenTelemetry è®¾ç½®æ–‡ä»¶

è®©æˆ‘ä»¬åœ¨ `src/instrumentation.ts` ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶

```ts [src/instrumentation.ts]
import { opentelemetry } from '@elysiajs/opentelemetry'
import { PgInstrumentation } from '@opentelemetry/instrumentation-pg'

export const instrumentation = opentelemetry({
	instrumentations: [new PgInstrumentation()]
})
```

ç„¶åæˆ‘ä»¬å¯ä»¥å°†æ­¤ `instrumentation` æ’ä»¶åº”ç”¨äº `src/index.ts` ä¸­çš„ä¸»å®ä¾‹

```ts [src/index.ts]
import { Elysia } from 'elysia'
import { instrumentation } from './instrumentation.ts'

new Elysia().use(instrumentation).listen(3000)
```

ç„¶ååˆ›å»ºä¸€ä¸ª `bunfig.toml`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```toml [bunfig.toml]
preload = ["./src/instrumentation.ts"]
```

è¿™å°†å‘Šè¯‰ Bun åœ¨è¿è¡Œ `src/index.ts` ä¹‹å‰åŠ è½½å¹¶è®¾ç½® `instrumentation`ï¼Œä»¥å…è®¸ OpenTelemetry æŒ‰éœ€è®¾ç½®ã€‚

### éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ é«˜çº§æ¦‚å¿µ

å¦‚æœæ‚¨ä½¿ç”¨ `bun build` æˆ–å…¶ä»–æ‰“åŒ…å·¥å…·ã€‚

ç”±äº OpenTelemetry ä¾èµ–äºçŒ´å­è¡¥ä¸ `node_modules/<library>`ã€‚ä¸ºäº†ç¡®ä¿ä»ªå™¨åŒ–æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šè¦è¢«ä»ªå™¨åŒ–çš„åº“ä½œä¸ºå¤–éƒ¨æ¨¡å—ï¼Œä»¥å°†å…¶æ’é™¤åœ¨æ‰“åŒ…ä¹‹å¤–ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ `@opentelemetry/instrumentation-pg` æ¥å¯¹ `pg` åº“è¿›è¡Œä»ªå™¨åŒ–ã€‚æˆ‘ä»¬éœ€è¦å°† `pg` æ’é™¤åœ¨æ‰“åŒ…ä¹‹å¤–ï¼Œå¹¶ç¡®ä¿å®ƒä» `node_modules/pg` å¯¼å…¥ã€‚

è¦ä½¿å…¶æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `--external pg` å°† `pg` æŒ‡å®šä¸ºå¤–éƒ¨æ¨¡å—

```bash
bun build --compile --external pg --outfile server src/index.ts
```

è¿™å‘Šè¯‰ bun ä¸è¦å°† `pg` æ‰“åŒ…åˆ°æœ€ç»ˆè¾“å‡ºæ–‡ä»¶ä¸­ï¼Œå¹¶å°†åœ¨è¿è¡Œæ—¶ä» **node\_modules** ç›®å½•å¯¼å…¥ã€‚æ‰€ä»¥åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šï¼Œæ‚¨è¿˜å¿…é¡»ä¿ç•™ **node\_modules** ç›®å½•ã€‚

å»ºè®®åœ¨ **package.json** ä¸­å°†åº”åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šå¯ç”¨çš„åŒ…æŒ‡å®šä¸º **dependencies**ï¼Œå¹¶ä½¿ç”¨ `bun install --production` ä»…å®‰è£…ç”Ÿäº§ä¾èµ–é¡¹ã€‚

```json
{
	"dependencies": {
		"pg": "^8.15.6"
	},
	"devDependencies": {
		"@elysiajs/opentelemetry": "^1.2.0",
		"@opentelemetry/instrumentation-pg": "^0.52.0",
		"@types/pg": "^8.11.14",
		"elysia": "^1.2.25"
	}
}
```

ç„¶ååœ¨è¿è¡Œæ„å»ºå‘½ä»¤åï¼Œåœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Š

```bash
bun install --production
```

å¦‚æœ node\_modules ç›®å½•ä»åŒ…å«å¼€å‘ä¾èµ–é¡¹ï¼Œæ‚¨å¯ä»¥åˆ é™¤ node\_modules ç›®å½•å¹¶å†æ¬¡å®‰è£…ç”Ÿäº§ä¾èµ–é¡¹ã€‚

---

---
url: 'https://elysiajs.com/plugins/opentelemetry.md'
---

# OpenTelemetry

::: tip
æ­¤é¡µé¢æ˜¯ **OpenTelemetry** çš„ **é…ç½®å‚è€ƒ**ï¼Œå¦‚æœæ‚¨æƒ³è¦è®¾ç½®å’Œé›†æˆ OpenTelemetryï¼Œæˆ‘ä»¬å»ºè®®æ‚¨æŸ¥çœ‹ [ä¸ OpenTelemetry é›†æˆ](/patterns/opentelemetry)ã€‚
:::

è¦å¼€å§‹ä½¿ç”¨ OpenTelemetryï¼Œè¯·å®‰è£… `@elysiajs/opentelemetry` å¹¶å°†æ’ä»¶åº”ç”¨äºä»»æ„å®ä¾‹ã€‚

```typescript twoslash
import { Elysia } from 'elysia'
import { opentelemetry } from '@elysiajs/opentelemetry'

import { BatchSpanProcessor } from '@opentelemetry/sdk-trace-node'
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-proto'

new Elysia()
	.use(
		opentelemetry({
			spanProcessors: [
				new BatchSpanProcessor(
					new OTLPTraceExporter()
				)
			]
		})
	)
```

![jaeger æ˜¾ç¤ºè‡ªåŠ¨æ”¶é›†çš„è¿½è¸ª](/blog/elysia-11/jaeger.webp)

Elysia OpenTelemetry å°† **æ”¶é›†ä»»ä½•ä¸ OpenTelemetry æ ‡å‡†å…¼å®¹çš„åº“çš„è·¨åº¦**ï¼Œå¹¶å°†è‡ªåŠ¨åº”ç”¨çˆ¶å­è·¨åº¦ã€‚

## ä½¿ç”¨

è¯·å‚è§ [opentelemetry](/patterns/opentelemetry) ä»¥è·å–ç”¨æ³•å’Œå®ç”¨å·¥å…·

## é…ç½®

æ­¤æ’ä»¶æ‰©å±• OpenTelemetry SDK å‚æ•°é€‰é¡¹ã€‚

ä»¥ä¸‹æ˜¯æ’ä»¶æ¥å—çš„é…ç½®

### autoDetectResources - å¸ƒå°”å€¼

ä½¿ç”¨é»˜è®¤èµ„æºæ¢æµ‹å™¨è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒä¸­çš„èµ„æºã€‚

é»˜è®¤å€¼ï¼š`true`

### contextManager - ContextManager

ä½¿ç”¨è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚

é»˜è®¤å€¼ï¼š`AsyncHooksContextManager`

### textMapPropagator - TextMapPropagator

ä½¿ç”¨è‡ªå®šä¹‰ä¼ æ’­å™¨ã€‚

é»˜è®¤å€¼ï¼š`CompositePropagator`ï¼Œä½¿ç”¨ W3C Trace Context å’Œ Baggage

### metricReader - MetricReader

æ·»åŠ ä¸€ä¸ªå°†è¢«ä¼ é€’ç»™ MeterProvider çš„ MetricReaderã€‚

### views - View\[]

è¦ä¼ é€’ç»™ MeterProvider çš„è§†å›¾åˆ—è¡¨ã€‚

æ¥å— View å®ä¾‹çš„æ•°ç»„ã€‚æ­¤å‚æ•°å¯ç”¨äºé…ç½®ç›´æ–¹å›¾æŒ‡æ ‡çš„æ˜¾å¼æ¡¶å¤§å°ã€‚

### instrumentations - (Instrumentation | Instrumentation\[])\[]

é…ç½®ä»ªå™¨ã€‚

é»˜è®¤æƒ…å†µä¸‹å¯ç”¨ `getNodeAutoInstrumentations`ï¼Œå¦‚æœæ‚¨å¸Œæœ›å¯ç”¨å®ƒä»¬ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å…ƒåŒ…æˆ–å•ç‹¬é…ç½®æ¯ä¸ªä»ªå™¨ã€‚

é»˜è®¤å€¼ï¼š`getNodeAutoInstrumentations()`

### resource - IResource

é…ç½®èµ„æºã€‚

èµ„æºä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ SDK çš„ autoDetectResources æ–¹æ³•æ¥æ£€æµ‹ã€‚

### resourceDetectors - Array\<Detector | DetectorSync>

é…ç½®èµ„æºæ¢æµ‹å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œèµ„æºæ¢æµ‹å™¨ä¸º \[envDetector, processDetector, hostDetector]ã€‚ æ³¨æ„ï¼šä¸ºäº†å¯ç”¨æ¢æµ‹ï¼Œå‚æ•° autoDetectResources å¿…é¡»ä¸º trueã€‚

å¦‚æœæ²¡æœ‰è®¾ç½® resourceDetectorsï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡ OTEL\_NODE\_RESOURCE\_DETECTORS æ¥å¯ç”¨ç‰¹å®šæ¢æµ‹å™¨æˆ–å®Œå…¨ç¦ç”¨å®ƒä»¬ï¼š

* env
* host
* os
* process
* serviceinstance (å®éªŒæ€§)
* all - å¯ç”¨ä¸Šè¿°æ‰€æœ‰èµ„æºæ¢æµ‹å™¨
* none - ç¦ç”¨èµ„æºæ¢æµ‹

ä¾‹å¦‚ï¼Œåªå¯ç”¨ env å’Œ host æ¢æµ‹å™¨ï¼š

```bash
export OTEL_NODE_RESOURCE_DETECTORS="env,host"
```

### sampler - Sampler

é…ç½®è‡ªå®šä¹‰é‡‡æ ·å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è¿½è¸ªå°†è¢«é‡‡æ ·ã€‚

### serviceName - å­—ç¬¦ä¸²

è¦æ ‡è¯†çš„å‘½åç©ºé—´ã€‚

### spanProcessors - SpanProcessor\[]

è¦æ³¨å†Œåˆ°è¿½è¸ªå™¨æä¾›ç¨‹åºçš„è·¨åº¦å¤„ç†å™¨æ•°ç»„ã€‚

### traceExporter - SpanExporter

é…ç½®è¿½è¸ªå¯¼å‡ºå™¨ã€‚å¦‚æœé…ç½®äº†å¯¼å‡ºå™¨ï¼Œåˆ™å°†ä¸ `BatchSpanProcessor` ä¸€èµ·ä½¿ç”¨ã€‚

å¦‚æœæ²¡æœ‰ä»¥ç¼–ç¨‹æ–¹å¼é…ç½®å¯¼å‡ºå™¨æˆ–è·¨åº¦å¤„ç†å™¨ï¼Œè¯¥è½¯ä»¶åŒ…å°†è‡ªåŠ¨è®¾ç½®ä½¿ç”¨ http/protobuf åè®®çš„é»˜è®¤ otlp å¯¼å‡ºå™¨å’Œä¸€ä¸ª BatchSpanProcessorã€‚

### spanLimits - SpanLimits

é…ç½®è¿½è¸ªå‚æ•°ã€‚è¿™äº›ä¸é…ç½®è¿½è¸ªå™¨ä½¿ç”¨çš„ç›¸åŒè¿½è¸ªå‚æ•°ã€‚

---

---
url: 'https://elysiajs.com/integrations/react-email.md'
---

# React Email

React Email æ˜¯ä¸€ä¸ªåº“ï¼Œå…è®¸æ‚¨ä½¿ç”¨ React ç»„ä»¶åˆ›å»ºç”µå­é‚®ä»¶ã€‚

ç”±äº Elysia ä½¿ç”¨ Bun ä½œä¸ºè¿è¡Œç¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ç¼–å†™ä¸€ä¸ª React Email ç»„ä»¶ï¼Œå¹¶å°† JSX ç›´æ¥å¯¼å…¥åˆ°æˆ‘ä»¬çš„ä»£ç ä¸­ä»¥å‘é€ç”µå­é‚®ä»¶ã€‚

## å®‰è£…

è¦å®‰è£… React Emailï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
bun add -d react-email
bun add @react-email/components react react-dom
```

ç„¶ååœ¨ `package.json` ä¸­æ·»åŠ ä»¥ä¸‹è„šæœ¬ï¼š

```json
{
  "scripts": {
    "email": "email dev --dir src/emails"
  }
}
```

æˆ‘ä»¬å»ºè®®å°†ç”µå­é‚®ä»¶æ¨¡æ¿æ·»åŠ åˆ° `src/emails` ç›®å½•ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¼å…¥ JSX æ–‡ä»¶ã€‚

### TypeScript

å¦‚æœæ‚¨ä½¿ç”¨ TypeScriptï¼Œå¯èƒ½éœ€è¦åœ¨ `tsconfig.json` ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "compilerOptions": {
	"jsx": "react"
  }
}
```

## æ‚¨çš„ç¬¬ä¸€å°ç”µå­é‚®ä»¶

åˆ›å»ºæ–‡ä»¶ `src/emails/otp.tsx`ï¼Œå¹¶è¾“å…¥ä»¥ä¸‹ä»£ç ï¼š

```tsx
import * as React from 'react'
import { Tailwind, Section, Text } from '@react-email/components'

export default function OTPEmail({ otp }: { otp: number }) {
    return (
        <Tailwind>
            <Section className="flex justify-center items-center w-full min-h-screen font-sans">
                <Section className="flex flex-col items-center w-76 rounded-2xl px-6 py-1 bg-gray-50">
                    <Text className="text-xs font-medium text-violet-500">
                        éªŒè¯æ‚¨çš„ç”µå­é‚®ä»¶åœ°å€
                    </Text>
                    <Text className="text-gray-500 my-0">
                        ä½¿ç”¨ä»¥ä¸‹ä»£ç éªŒè¯æ‚¨çš„ç”µå­é‚®ä»¶åœ°å€
                    </Text>
                    <Text className="text-5xl font-bold pt-2">{otp}</Text>
                    <Text className="text-gray-400 font-light text-xs pb-4">
                        æ­¤ä»£ç åœ¨ 10 åˆ†é’Ÿå†…æœ‰æ•ˆ
                    </Text>
                    <Text className="text-gray-600 text-xs">
                        æ„Ÿè°¢åŠ å…¥æˆ‘ä»¬
                    </Text>
                </Section>
            </Section>
        </Tailwind>
    )
}

OTPEmail.PreviewProps = {
    otp: 123456
}
```

æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°æˆ‘ä»¬ä½¿ç”¨äº† `@react-email/components` æ¥åˆ›å»ºç”µå­é‚®ä»¶æ¨¡æ¿ã€‚

è¯¥åº“æä¾›äº†ä¸€ç»„ä¸é‚®ä»¶å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ Gmailã€Outlook ç­‰ï¼‰å…¼å®¹çš„ç»„ä»¶ï¼ŒåŒ…æ‹¬ **ä½¿ç”¨ Tailwind è¿›è¡Œæ ·å¼è®¾ç½®**ã€‚

æˆ‘ä»¬è¿˜å‘ `OTPEmail` å‡½æ•°æ·»åŠ äº† `PreviewProps`ã€‚è¿™ä»…åœ¨æˆ‘ä»¬åœ¨ PLAYGROUND ä¸Šé¢„è§ˆç”µå­é‚®ä»¶æ—¶é€‚ç”¨ã€‚

## é¢„è§ˆæ‚¨çš„ç”µå­é‚®ä»¶

è¦é¢„è§ˆæ‚¨çš„ç”µå­é‚®ä»¶ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
bun email
```

è¿™å°†æ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨çª—å£ï¼Œæ˜¾ç¤ºæ‚¨çš„ç”µå­é‚®ä»¶é¢„è§ˆã€‚

![React Email playground showing an OTP email we have just written](/recipe/react-email/email-preview.webp)

## å‘é€ç”µå­é‚®ä»¶

è¦å‘é€ç”µå­é‚®ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `react-dom/server` æ¥æ¸²æŸ“ç”µå­é‚®ä»¶ï¼Œç„¶åä½¿ç”¨é¦–é€‰æä¾›å•†è¿›è¡Œå‘é€ï¼š

::: code-group

```tsx [Nodemailer]
import { Elysia, t } from 'elysia'

import * as React from 'react'
import { renderToStaticMarkup } from 'react-dom/server'

import OTPEmail from './emails/otp'

import nodemailer from 'nodemailer' // [!code ++]

const transporter = nodemailer.createTransport({ // [!code ++]
  	host: 'smtp.gehenna.sh', // [!code ++]
  	port: 465, // [!code ++]
  	auth: { // [!code ++]
  		user: 'makoto', // [!code ++]
  		pass: '12345678' // [!code ++]
  	} // [!code ++]
}) // [!code ++]

new Elysia()
	.get('/otp', async async ({ body }) => {
		// éšæœºç”Ÿæˆ 100,000 åˆ° 999,999 ä¹‹é—´çš„æ•°å­—
  		const otp = ~~(Math.random() * (900_000 - 1)) + 100_000

		const html = renderToStaticMarkup(<OTPEmail otp={otp} />)

        await transporter.sendMail({ // [!code ++]
        	from: 'ibuki@gehenna.sh', // [!code ++]
           	to: body, // [!code ++]
           	subject: 'éªŒè¯æ‚¨çš„ç”µå­é‚®ä»¶åœ°å€', // [!code ++]
            html, // [!code ++]
        }) // [!code ++]

        return { success: true }
	}, {
		body: t.String({ format: 'email' })
	})
	.listen(3000)
```

```tsx [Resend]
import { Elysia, t } from 'elysia'

import OTPEmail from './emails/otp'

import Resend from 'resend' // [!code ++]

const resend = new Resend('re_123456789') // [!code ++]

new Elysia()
	.get('/otp', async ({ body }) => {
		// éšæœºç”Ÿæˆ 100,000 åˆ° 999,999 ä¹‹é—´çš„æ•°å­—
  		const otp = ~~(Math.random() * (900_000 - 1)) + 100_000

        await resend.emails.send({ // [!code ++]
        	from: 'ibuki@gehenna.sh', // [!code ++]
           	to: body, // [!code ++]
           	subject: 'éªŒè¯æ‚¨çš„ç”µå­é‚®ä»¶åœ°å€', // [!code ++]
            html: <OTPEmail otp={otp} />, // [!code ++]
        }) // [!code ++]

        return { success: true }
	}, {
		body: t.String({ format: 'email' })
	})
	.listen(3000)
```

```tsx [AWS SES]
import { Elysia, t } from 'elysia'

import * as React from 'react'
import { renderToStaticMarkup } from 'react-dom/server'

import OTPEmail from './emails/otp'

import { type SendEmailCommandInput, SES } from '@aws-sdk/client-ses' // [!code ++]
import { fromEnv } from '@aws-sdk/credential-providers' // [!code ++]

const ses = new SES({ // [!code ++]
    credentials: // [!code ++]
        process.env.NODE_ENV === 'production' ? fromEnv() : undefined // [!code ++]
}) // [!code ++]

new Elysia()
	.get('/otp', async ({ body }) => {
		// éšæœºç”Ÿæˆ 100,000 åˆ° 999,999 ä¹‹é—´çš„æ•°å­—
  		const otp = ~~(Math.random() * (900_000 - 1)) + 100_000

		const html = renderToStaticMarkup(<OTPEmail otp={otp} />)

        await ses.sendEmail({ // [!code ++]
            Source: 'ibuki@gehenna.sh', // [!code ++]
            Destination: { // [!code ++]
                ToAddresses: [body] // [!code ++]
            }, // [!code ++]
            Message: { // [!code ++]
                Body: { // [!code ++]
                    Html: { // [!code ++]
                        Charset: 'UTF-8', // [!code ++]
                        Data: html // [!code ++]
                    } // [!code ++]
                }, // [!code ++]
                Subject: { // [!code ++]
                    Charset: 'UTF-8', // [!code ++]
                    Data: 'éªŒè¯æ‚¨çš„ç”µå­é‚®ä»¶åœ°å€' // [!code ++]
                } // [!code ++]
            } // [!code ++]
        } satisfies SendEmailCommandInput) // [!code ++]

        return { success: true }
	}, {
		body: t.String({ format: 'email' })
	})
	.listen(3000)
```

```tsx [Sendgrid]
import { Elysia, t } from 'elysia'

import OTPEmail from './emails/otp'

import sendgrid from "@sendgrid/mail" // [!code ++]

sendgrid.setApiKey(process.env.SENDGRID_API_KEY) // [!code ++]

new Elysia()
	.get('/otp', async ({ body }) => {
		// éšæœºç”Ÿæˆ 100,000 åˆ° 999,999 ä¹‹é—´çš„æ•°å­—
  		const otp = ~~(Math.random() * (900_000 - 1)) + 100_000

    	const html = renderToStaticMarkup(<OTPEmail otp={otp} />)

        await sendgrid.send({ // [!code ++]
        	from: 'ibuki@gehenna.sh', // [!code ++]
           	to: body, // [!code ++]
           	subject: 'éªŒè¯æ‚¨çš„ç”µå­é‚®ä»¶åœ°å€', // [!code ++]
            html // [!code ++]
        }) // [!code ++]

        return { success: true }
	}, {
		body: t.String({ format: 'email' })
	})
	.listen(3000)
```

:::

::: tip
æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¼å…¥ç”µå­é‚®ä»¶ç»„ä»¶ï¼Œè¿™è¦å½’åŠŸäº Bun
:::

æ‚¨å¯ä»¥åœ¨ [React Email Integration](https://react.email/docs/integrations/overview) ä¸­æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„ React Email é›†æˆï¼Œå¹¶åœ¨ [React Email documentation](https://react.email/docs) ä¸­äº†è§£æ›´å¤šä¿¡æ¯ã€‚

---

---
url: 'https://elysiajs.com/plugins/swagger.md'
---

::: warning
Swagger æ’ä»¶å·²å¼ƒç”¨ä¸”ä¸å†ç»´æŠ¤ã€‚è¯·ä½¿ç”¨ [OpenAPI æ’ä»¶](/plugins/openapi) æ›¿ä»£ã€‚
:::

# Swagger æ’ä»¶

è¯¥æ’ä»¶ä¸º Elysia æœåŠ¡å™¨ç”Ÿæˆä¸€ä¸ª Swagger ç«¯ç‚¹ã€‚

å®‰è£…å‘½ä»¤ï¼š

```bash
bun add @elysiajs/swagger
```

ç„¶åè¿™æ ·ä½¿ç”¨å®ƒï¼š

```typescript
import { Elysia } from 'elysia'
import { swagger } from '@elysiajs/swagger'

new Elysia()
    .use(swagger())
    .get('/', () => 'hi')
    .post('/hello', () => 'world')
    .listen(3000)
```

è®¿é—® `/swagger` å°†å±•ç¤ºä¸€ä¸ª Scalar UIï¼Œæ˜¾ç¤ºä» Elysia æœåŠ¡å™¨ç”Ÿæˆçš„ç«¯ç‚¹æ–‡æ¡£ã€‚æ‚¨è¿˜å¯ä»¥åœ¨ `/swagger/json` è®¿é—®åŸå§‹çš„ OpenAPI è§„èŒƒã€‚

## é…ç½®

ä»¥ä¸‹æ˜¯æ’ä»¶æ¥å—çš„é…ç½®é¡¹ï¼š

### provider

@default `scalar`

æ–‡æ¡£ UI çš„æä¾›è€…ï¼Œé»˜è®¤æ˜¯ Scalarã€‚

### scalar

è‡ªå®šä¹‰ Scalar çš„é…ç½®ã€‚

è¯·å‚è€ƒ [Scalar é…ç½®](https://github.com/scalar/scalar/blob/main/documentation/configuration.md)

### swagger

è‡ªå®šä¹‰ Swagger çš„é…ç½®ã€‚

è¯·å‚è€ƒ [Swagger è§„èŒƒ](https://swagger.io/specification/v2/)ã€‚

### excludeStaticFile

@default `true`

ç¡®å®š Swagger æ˜¯å¦åº”æ’é™¤é™æ€æ–‡ä»¶ã€‚

### path

@default `/swagger`

æš´éœ² Swagger çš„ç«¯ç‚¹è·¯å¾„ã€‚

### exclude

éœ€è¦ä» Swagger æ–‡æ¡£ä¸­æ’é™¤çš„è·¯å¾„ã€‚

æ”¯æŒä»¥ä¸‹ç±»å‹çš„å€¼ï¼š

* **å­—ç¬¦ä¸²**
* **æ­£åˆ™è¡¨è¾¾å¼ï¼ˆRegExpï¼‰**
* **å­—ç¬¦ä¸²æˆ–æ­£åˆ™è¡¨è¾¾å¼æ•°ç»„**

## ä½¿ç”¨æ¨¡å¼

ä»¥ä¸‹æ˜¯è¯¥æ’ä»¶çš„ä¸€äº›å¸¸è§ä½¿ç”¨æ¨¡å¼ã€‚

## æ›´æ”¹ Swagger ç«¯ç‚¹

æ‚¨å¯ä»¥é€šè¿‡æ’ä»¶é…ç½®ä¸­çš„ [path](#path) å±æ€§æ›´æ”¹ Swagger ç«¯ç‚¹ä½ç½®ã€‚

```typescript
import { Elysia } from 'elysia'
import { swagger } from '@elysiajs/swagger'

new Elysia()
    .use(
        swagger({
            path: '/v2/swagger'
        })
    )
    .listen(3000)
```

## è‡ªå®šä¹‰ Swagger ä¿¡æ¯

```typescript
import { Elysia } from 'elysia'
import { swagger } from '@elysiajs/swagger'

new Elysia()
    .use(
        swagger({
            documentation: {
                info: {
                    title: 'Elysia æ–‡æ¡£',
                    version: '1.0.0'
                }
            }
        })
    )
    .listen(3000)
```

## ä½¿ç”¨æ ‡ç­¾

Elysia å¯ä»¥åˆ©ç”¨ Swagger çš„æ ‡ç­¾ç³»ç»Ÿå¯¹ç«¯ç‚¹è¿›è¡Œåˆ†ç»„ã€‚

é¦–å…ˆï¼Œåœ¨ Swagger é…ç½®å¯¹è±¡ä¸­å®šä¹‰å¯ç”¨æ ‡ç­¾ï¼š

```typescript
app.use(
    swagger({
        documentation: {
            tags: [
                { name: 'App', description: 'é€šç”¨ç«¯ç‚¹' },
                { name: 'Auth', description: 'è®¤è¯ç«¯ç‚¹' }
            ]
        }
    })
)
```

ç„¶ååœ¨ç«¯ç‚¹é…ç½®çš„ `detail` å±æ€§ä¸­ä¸ºè¯¥ç«¯ç‚¹åˆ†é…æ ‡ç­¾ç»„ï¼š

```typescript
app.get('/', () => 'Hello Elysia', {
    detail: {
        tags: ['App']
    }
})

app.group('/auth', (app) =>
    app.post(
        '/sign-up',
        async ({ body }) =>
            db.user.create({
                data: body,
                select: {
                    id: true,
                    username: true
                }
            }),
        {
            detail: {
                tags: ['Auth']
            }
        }
    )
)
```

è¿™æ ·å°†ç”Ÿæˆç±»ä¼¼å¦‚ä¸‹çš„ Swagger é¡µé¢


## å®‰å…¨é…ç½®

ä¸ºäº†ä¿æŠ¤æ‚¨çš„ API ç«¯ç‚¹ï¼Œæ‚¨å¯ä»¥åœ¨ Swagger é…ç½®ä¸­å®šä¹‰å®‰å…¨æ–¹æ¡ˆã€‚ä¸‹é¢ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ç”¨ Bearer è®¤è¯ï¼ˆJWTï¼‰æ¥ä¿æŠ¤ç«¯ç‚¹ï¼š

```typescript
app.use(
    swagger({
        documentation: {
            components: {
                securitySchemes: {
                    bearerAuth: {
                        type: 'http',
                        scheme: 'bearer',
                        bearerFormat: 'JWT'
                    }
                }
            }
        }
    })
)

export const addressController = new Elysia({
    prefix: '/address',
    detail: {
        tags: ['Address'],
        security: [
            {
                bearerAuth: []
            }
        ]
    }
})
```

æ­¤é…ç½®ç¡®ä¿æ‰€æœ‰ä»¥ `/address` å‰ç¼€çš„ç«¯ç‚¹éƒ½éœ€è¦æœ‰æ•ˆçš„ JWT ä»¤ç‰Œæ‰èƒ½è®¿é—®ã€‚

---

---
url: 'https://elysiajs.com/patterns/trace.md'
---

# Trace

æ€§èƒ½æ˜¯ Elysia ä¸€ä¸ªé‡è¦çš„æ–¹é¢ã€‚

æˆ‘ä»¬ä¸ä»…å¸Œæœ›åœ¨åŸºå‡†æµ‹è¯•ä¸­å¿«é€Ÿè¿è¡Œï¼Œæˆ‘ä»¬å¸Œæœ›æ‚¨åœ¨çœŸå®åœºæ™¯ä¸­æ‹¥æœ‰ä¸€ä¸ªçœŸæ­£å¿«é€Ÿçš„æœåŠ¡å™¨ã€‚

æœ‰è®¸å¤šå› ç´ å¯èƒ½ä¼šå‡æ…¢æˆ‘ä»¬çš„åº”ç”¨ç¨‹åº - å¹¶ä¸”å¾ˆéš¾è¯†åˆ«å®ƒä»¬ï¼Œä½† **trace** å¯ä»¥é€šè¿‡åœ¨æ¯ä¸ªç”Ÿå‘½å‘¨æœŸä¸­æ³¨å…¥å¼€å§‹å’Œåœæ­¢ä»£ç æ¥å¸®åŠ©è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

Trace å…è®¸æˆ‘ä»¬åœ¨æ¯ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„å‰åæ³¨å…¥ä»£ç ï¼Œä»è€Œé˜»æ­¢å¹¶ä¸å‡½æ•°çš„æ‰§è¡Œè¿›è¡Œäº¤äº’ã€‚

## Trace

Trace ä½¿ç”¨å›è°ƒç›‘å¬å™¨ä»¥ç¡®ä¿å›è°ƒå‡½æ•°åœ¨ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¹‹å‰å®Œæˆã€‚

è¦ä½¿ç”¨ `trace`ï¼Œæ‚¨éœ€è¦åœ¨ Elysia å®ä¾‹ä¸Šè°ƒç”¨ `trace` æ–¹æ³•ï¼Œå¹¶ä¼ é€’ä¸€ä¸ªå°†åœ¨æ¯ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸­æ‰§è¡Œçš„å›è°ƒå‡½æ•°ã€‚

æ‚¨å¯ä»¥é€šè¿‡åœ¨ç”Ÿå‘½å‘¨æœŸåç§°å‰æ·»åŠ  `on` å‰ç¼€æ¥ç›‘å¬æ¯ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œä¾‹å¦‚ `onHandle` ä»¥ç›‘å¬ `handle` äº‹ä»¶ã€‚

```ts twoslash
import { Elysia } from 'elysia'

const app = new Elysia()
    .trace(async ({ onHandle }) => {
	    onHandle(({ begin, onStop }) => {
			onStop(({ end }) => {
        		console.log('handle took', end - begin, 'ms')
			})
	    })
    })
    .get('/', () => 'Hi')
    .listen(3000)
```

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [ç”Ÿå‘½å‘¨æœŸäº‹ä»¶](/essential/life-cycle#events)ï¼š

![Elysia ç”Ÿå‘½å‘¨æœŸ](/assets/lifecycle-chart.svg)

## å­äº‹ä»¶

æ¯ä¸ªäº‹ä»¶é™¤äº† `handle` ä¹‹å¤–éƒ½æœ‰ä¸€ä¸ªå­äº‹ä»¶ï¼Œè¿™æ˜¯åœ¨æ¯ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶å†…éƒ¨æ‰§è¡Œçš„äº‹ä»¶æ•°ç»„ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ `onEvent` æ¥æŒ‰é¡ºåºç›‘å¬æ¯ä¸ªå­äº‹ä»¶ã€‚

```ts twoslash
import { Elysia } from 'elysia'

const sleep = (time = 1000) =>
    new Promise((resolve) => setTimeout(resolve, time))

const app = new Elysia()
    .trace(async ({ onBeforeHandle }) => {
        onBeforeHandle(({ total, onEvent }) => {
            console.log('æ€»å­äº‹ä»¶:', total)

            onEvent(({ onStop }) => {
                onStop(({ elapsed }) => {
                    console.log('å­äº‹ä»¶è€—æ—¶', elapsed, 'ms')
                })
            })
        })
    })
    .get('/', () => 'Hi', {
        beforeHandle: [
            function setup() {},
            async function delay() {
                await sleep()
            }
        ]
    })
    .listen(3000)
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ€»å­äº‹ä»¶å°†ä¸º `2`ï¼Œå› ä¸ºåœ¨ `beforeHandle` äº‹ä»¶ä¸­æœ‰ 2 ä¸ªå­äº‹ä»¶ã€‚

ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ `onEvent` ç›‘å¬æ¯ä¸ªå­äº‹ä»¶ï¼Œå¹¶æ‰“å°æ¯ä¸ªå­äº‹ä»¶çš„æŒç»­æ—¶é—´ã€‚

## Trace å‚æ•°

æ¯ä¸ªç”Ÿå‘½å‘¨æœŸè¢«è°ƒç”¨æ—¶

```ts twoslash
import { Elysia } from 'elysia'

const app = new Elysia()
	// è¿™æ˜¯ trace å‚æ•°
	// æ‚¬åœä»¥æŸ¥çœ‹ç±»å‹
	.trace((parameter) => {
	})
	.get('/', () => 'Hi')
	.listen(3000)
```

`trace` æ¥å—ä»¥ä¸‹å‚æ•°ï¼š

### id - `number`

ä¸ºæ¯ä¸ªè¯·æ±‚éšæœºç”Ÿæˆçš„å”¯ä¸€ id

### context - `Context`

Elysia çš„ [ä¸Šä¸‹æ–‡](/essential/handler.html#context)ï¼Œä¾‹å¦‚ `set`ã€`store`ã€`query``ã€`params\`

### set - `Context.set`

`context.set` çš„å¿«æ·æ–¹å¼ï¼Œç”¨äºè®¾ç½®ä¸Šä¸‹æ–‡çš„å¤´éƒ¨æˆ–çŠ¶æ€

### store - `Singleton.store`

`context.store` çš„å¿«æ·æ–¹å¼ï¼Œç”¨äºè®¿é—®ä¸Šä¸‹æ–‡ä¸­çš„æ•°æ®

### time - `number`

è¯·æ±‚è¢«è°ƒç”¨çš„æ—¶é—´æˆ³

### on\[Event] - `TraceListener`

æ¯ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„äº‹ä»¶ç›‘å¬å™¨ã€‚

æ‚¨å¯ä»¥ç›‘å¬ä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸï¼š

* **onRequest** - é€šçŸ¥æ¯ä¸ªæ–°è¯·æ±‚
* **onParse** - ç”¨äºè§£æä¸»ä½“çš„å‡½æ•°æ•°ç»„
* **onTransform** - åœ¨éªŒè¯ä¹‹å‰è½¬æ¢è¯·æ±‚å’Œä¸Šä¸‹æ–‡
* **onBeforeHandle** - åœ¨ä¸»å¤„ç†å™¨ä¹‹å‰æ£€æŸ¥çš„è‡ªå®šä¹‰è¦æ±‚ï¼Œå¯ä»¥åœ¨è¿”å›å“åº”æ—¶è·³è¿‡ä¸»å¤„ç†å™¨ã€‚
* **onHandle** - åˆ†é…ç»™è·¯å¾„çš„å‡½æ•°
* **onAfterHandle** - åœ¨å°†å“åº”å‘å›å®¢æˆ·ç«¯ä¹‹å‰ä¸å“åº”è¿›è¡Œäº¤äº’
* **onMapResponse** - å°†è¿”å›å€¼æ˜ å°„åˆ° Web æ ‡å‡†å“åº”
* **onError** - å¤„ç†åœ¨å¤„ç†è¯·æ±‚æœŸé—´æŠ›å‡ºçš„é”™è¯¯
* **onAfterResponse** - åœ¨å“åº”å‘é€ä¹‹åçš„æ¸…ç†å‡½æ•°

## Trace ç›‘å¬å™¨

æ¯ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„ç›‘å¬å™¨

```ts twoslash
import { Elysia } from 'elysia'

const app = new Elysia()
	.trace(({ onBeforeHandle }) => {
		// è¿™æ˜¯ trace ç›‘å¬å™¨
		// æ‚¬åœä»¥æŸ¥çœ‹ç±»å‹
		onBeforeHandle((parameter) => {

		})
	})
	.get('/', () => 'Hi')
	.listen(3000)
```

æ¯ä¸ªç”Ÿå‘½å‘¨æœŸç›‘å¬å™¨æ¥å—ä»¥ä¸‹å†…å®¹

### name - `string`

å‡½æ•°çš„åç§°ï¼Œå¦‚æœå‡½æ•°æ˜¯åŒ¿åçš„ï¼Œåˆ™åç§°å°†ä¸º `anonymous`

### begin - `number`

å‡½æ•°å¼€å§‹æ‰§è¡Œçš„æ—¶é—´

### end - `Promise<number>`

å‡½æ•°ç»“æŸæ—¶çš„æ—¶é—´ï¼Œå½“å‡½æ•°ç»“æŸæ—¶å°†è§£æ

### error - `Promise<Error | null>`

åœ¨ç”Ÿå‘½å‘¨æœŸä¸­æŠ›å‡ºçš„é”™è¯¯ï¼Œå°†åœ¨å‡½æ•°ç»“æŸæ—¶è§£æ

### onStop - `callback?: (detail: TraceEndDetail) => any`

åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶å°†æ‰§è¡Œçš„å›è°ƒ

```ts twoslash
import { Elysia } from 'elysia'

const app = new Elysia()
	.trace(({ onBeforeHandle, set }) => {
		onBeforeHandle(({ onStop }) => {
			onStop(({ elapsed }) => {
				set.headers['X-Elapsed'] = elapsed.toString()
			})
		})
	})
	.get('/', () => 'Hi')
	.listen(3000)
```

å»ºè®®åœ¨æ­¤å‡½æ•°ä¸­ä¿®æ”¹ä¸Šä¸‹æ–‡ï¼Œå› ä¸ºæœ‰ä¸€ä¸ªé”æœºåˆ¶ä»¥ç¡®ä¿ä¸Šä¸‹æ–‡åœ¨ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¹‹å‰æˆåŠŸä¿®æ”¹ã€‚

## TraceEndDetail

ä¼ é€’ç»™ `onStop` å›è°ƒçš„å‚æ•°

### end - `number`

å‡½æ•°ç»“æŸæ—¶çš„æ—¶é—´

### error - `Error | null`

åœ¨ç”Ÿå‘½å‘¨æœŸä¸­æŠ›å‡ºçš„é”™è¯¯

### elapsed - `number`

ç”Ÿå‘½å‘¨æœŸçš„ç»è¿‡æ—¶é—´æˆ– `end - begin`

---

---
url: 'https://elysiajs.com/patterns/typebox.md'
---

# TypeBox (Elysia.t)

ä»¥ä¸‹æ˜¯ä½¿ç”¨ `Elysia.t` ç¼–å†™éªŒè¯ç±»å‹çš„å¸¸è§æ¨¡å¼ã€‚

## åŸºæœ¬ç±»å‹

TypeBox API æ˜¯å›´ç»• TypeScript ç±»å‹è®¾è®¡çš„ï¼Œå¹¶ä¸ä¹‹ç±»ä¼¼ã€‚

æœ‰è®¸å¤šç†Ÿæ‚‰çš„åç§°å’Œè¡Œä¸ºä¸ TypeScript å¯¹åº”é¡¹äº¤å‰ï¼Œä¾‹å¦‚ **String**ã€**Number**ã€**Boolean** å’Œ **Object**ï¼Œä»¥åŠæ›´é«˜çº§çš„åŠŸèƒ½ï¼Œå¦‚ **Intersect**ã€**KeyOf** å’Œ **Tuple**ï¼Œä»¥å¢å¼ºçµæ´»æ€§ã€‚

å¦‚æœä½ ç†Ÿæ‚‰ TypeScriptï¼Œåˆ›å»º TypeBox æ¨¡å¼çš„è¡Œä¸ºå°±åƒç¼–å†™ TypeScript ç±»å‹ä¸€æ ·ï¼Œåªæ˜¯å®ƒåœ¨è¿è¡Œæ—¶æä¾›å®é™…çš„ç±»å‹éªŒè¯ã€‚

è¦åˆ›å»ºç¬¬ä¸€ä¸ªæ¨¡å¼ï¼Œä» Elysia å¯¼å…¥ **Elysia.t**ï¼Œå¹¶ä»æœ€åŸºæœ¬çš„ç±»å‹å¼€å§‹ï¼š

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.post('/', ({ body }) => `Hello ${body}`, {
		body: t.String()
	})
	.listen(3000)
```

è¿™æ®µä»£ç å‘Šè¯‰ Elysia éªŒè¯ä¼ å…¥çš„ HTTP ä¸»ä½“ï¼Œç¡®ä¿ä¸»ä½“æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å¦‚æœå®ƒæ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™å¯ä»¥åœ¨è¯·æ±‚ç®¡é“å’Œå¤„ç†ç¨‹åºä¸­æµåŠ¨ã€‚

å¦‚æœå½¢çŠ¶ä¸åŒ¹é…ï¼Œå°†æŠ›å‡ºé”™è¯¯åˆ° [é”™è¯¯ç”Ÿå‘½å‘¨æœŸ](/essential/life-cycle.html#on-error)ã€‚

![Elysia ç”Ÿå‘½å‘¨æœŸ](/assets/lifecycle-chart.svg)

### åŸºæœ¬ç±»å‹

TypeBox æä¾›å…·æœ‰ä¸ TypeScript ç±»å‹ç›¸åŒè¡Œä¸ºçš„åŸºæœ¬åŸå§‹ç±»å‹ã€‚

ä»¥ä¸‹è¡¨æ ¼åˆ—å‡ºäº†æœ€å¸¸è§çš„åŸºæœ¬ç±»å‹ï¼š

```typescript
t.String()
```

```typescript
string
```

```typescript
t.Number()
```

```typescript
number
```

```typescript
t.Boolean()
```

```typescript
boolean
```

```typescript
t.Array(
    t.Number()
)
```

```typescript
number[]
```

```typescript
t.Object({
    x: t.Number()
})
```

```typescript
{
    x: number
}
```

```typescript
t.Null()
```

```typescript
null
```

```typescript
t.Literal(42)
```

```typescript
42
```

Elysia æ‰©å±•äº†æ¥è‡ª TypeBox çš„æ‰€æœ‰ç±»å‹ï¼Œå…è®¸ä½ å¼•ç”¨ TypeBox ä¸­çš„å¤§å¤šæ•° API ä»¥ä¾›åœ¨ Elysia ä¸­ä½¿ç”¨ã€‚

æœ‰å…³ TypeBox æ”¯æŒçš„å…¶ä»–ç±»å‹ï¼Œè¯·å‚è§ [TypeBox çš„ç±»å‹](https://github.com/sinclairzx81/typebox#json-types)ã€‚

### å±æ€§

TypeBox å¯ä»¥æ¥å—åŸºäº JSON Schema 7 è§„èŒƒçš„å‚æ•°ï¼Œä»¥å®ç°æ›´å…¨é¢çš„è¡Œä¸ºã€‚

```typescript
t.String({
    format: 'email'
})
```

```typescript
saltyaom@elysiajs.com
```

```typescript
t.Number({
    minimum: 10,
    maximum: 100
})
```

```typescript
10
```

```typescript
t.Array(
    t.Number(),
    {
        /**
         * æœ€å°é¡¹æ•°é‡
         */
        minItems: 1,
        /**
         * æœ€å¤§é¡¹æ•°é‡
         */
        maxItems: 5
    }
)
```

```typescript
[1, 2, 3, 4, 5]
```

```typescript
t.Object(
    {
        x: t.Number()
    },
    {
        /**
         * @default false
         * æ¥å—æœªåœ¨æ¨¡å¼ä¸­æŒ‡å®šçš„å…¶ä»–å±æ€§
         * ä½†ä»ç„¶åŒ¹é…ç±»å‹
         */
        additionalProperties: true
    }
)
```

```typescript
x: 100
y: 200
```

æœ‰å…³æ¯ä¸ªå±æ€§çš„æ›´å¤šè§£é‡Šï¼Œè¯·å‚è§ [JSON Schema 7 è§„èŒƒ](https://json-schema.org/draft/2020-12/json-schema-validation)ã€‚

## è£èª‰æåŠ

ä»¥ä¸‹æ˜¯åˆ›å»ºæ¨¡å¼æ—¶å¸¸è§çš„æœ‰ç”¨æ¨¡å¼ã€‚

### è”åˆç±»å‹

å…è®¸ `t.Object` ä¸­çš„å­—æ®µå…·æœ‰å¤šç§ç±»å‹ã€‚

```typescript
t.Union([
    t.String(),
    t.Number()
])
```

```typescript
string | number
```

```
Hello
123
```

### å¯é€‰ç±»å‹

å…è®¸ `t.Object` ä¸­çš„å­—æ®µä¸ºæœªå®šä¹‰æˆ–å¯é€‰ã€‚

```typescript
t.Object({
    x: t.Number(),
    y: t.Optional(t.Number())
})
```

```typescript
{
    x: number,
    y?: number
}
```

```typescript
{
    x: 123
}
```

### éƒ¨åˆ†ç±»å‹

å…è®¸ `t.Object` ä¸­çš„æ‰€æœ‰å­—æ®µä¸ºå¯é€‰ã€‚

```typescript
t.Partial(
    t.Object({
        x: t.Number(),
        y: t.Number()
    })
)
```

```typescript
{
    x?: number,
    y?: number
}
```

```typescript
{
    y: 123
}
```

## Elysia ç±»å‹

`Elysia.t` å»ºç«‹åœ¨ TypeBox ä¹‹ä¸Šï¼Œè¿›è¡Œäº†é¢„é…ç½®ä»¥ä¾¿äºæœåŠ¡å™¨ä½¿ç”¨ï¼Œæä¾›äº†åœ¨æœåŠ¡å™¨ç«¯éªŒè¯ä¸­å¸¸è§çš„é¢å¤–ç±»å‹ã€‚

ä½ å¯ä»¥åœ¨ `elysia/type-system` ä¸­æ‰¾åˆ° Elysia ç±»å‹çš„æ‰€æœ‰æºä»£ç ã€‚

ä»¥ä¸‹æ˜¯ Elysia æä¾›çš„ç±»å‹ï¼š

### è”åˆæšä¸¾

`UnionEnum` å…è®¸å€¼æ˜¯æŒ‡å®šçš„å€¼ä¹‹ä¸€ã€‚

```typescript
t.UnionEnum(['rapi', 'anis', 1, true, false])
```

### æ–‡ä»¶

å•ä¸ªæ–‡ä»¶ï¼Œé€šå¸¸ç”¨äº **æ–‡ä»¶ä¸Šä¼ ** éªŒè¯ã€‚

```typescript
t.File()
```

æ–‡ä»¶æ‰©å±•äº†åŸºæœ¬æ¨¡å¼çš„å±æ€§ï¼Œå¹¶å…·æœ‰å¦‚ä¸‹é™„åŠ å±æ€§ï¼š

#### ç±»å‹

æŒ‡å®šæ–‡ä»¶çš„æ ¼å¼ï¼Œå¦‚å›¾åƒã€è§†é¢‘æˆ–éŸ³é¢‘ã€‚

å¦‚æœæä¾›äº†ä¸€ä¸ªæ•°ç»„ï¼Œå®ƒå°†å°è¯•éªŒè¯ä»»ä½•æ ¼å¼æ˜¯å¦æœ‰æ•ˆã€‚

```typescript
type?: MaybeArray<string>
```

#### æœ€å°å¤§å°

æ–‡ä»¶çš„æœ€å°å¤§å°ã€‚

æ¥å—ä»¥å­—èŠ‚ä¸ºå•ä½çš„æ•°å­—æˆ–æ–‡ä»¶å•ä½çš„åç¼€ï¼š

```typescript
minSize?: number | `${number}${'k' | 'm'}`
```

#### æœ€å¤§å¤§å°

æ–‡ä»¶çš„æœ€å¤§å¤§å°ã€‚

æ¥å—ä»¥å­—èŠ‚ä¸ºå•ä½çš„æ•°å­—æˆ–æ–‡ä»¶å•ä½çš„åç¼€ï¼š

```typescript
maxSize?: number | `${number}${'k' | 'm'}`
```

#### æ–‡ä»¶å•ä½åç¼€ï¼š

ä»¥ä¸‹æ˜¯æ–‡ä»¶å•ä½çš„è§„æ ¼ï¼š
m: å…†å­—èŠ‚ï¼ˆ1048576 å­—èŠ‚ï¼‰
k: åƒå­—èŠ‚ï¼ˆ1024 å­—èŠ‚ï¼‰

### æ–‡ä»¶æ•°ç»„

ä» [æ–‡ä»¶](#file) æ‰©å±•ï¼Œä½†å¢åŠ äº†å¯¹å•ä¸ªå­—æ®µä¸­çš„æ–‡ä»¶æ•°ç»„çš„æ”¯æŒã€‚

```typescript
t.Files()
```

æ–‡ä»¶æ•°ç»„æ‰©å±•äº†åŸºæœ¬æ¨¡å¼ã€æ•°ç»„å’Œæ–‡ä»¶çš„å±æ€§ã€‚

### Cookie

ä»å¯¹è±¡ç±»å‹æ‰©å±•çš„ Cookie Jar çš„ç±»å¯¹è±¡è¡¨ç¤ºã€‚

```typescript
t.Cookie({
    name: t.String()
})
```

Cookie æ‰©å±• [Object](https://json-schema.org/draft/2020-12/json-schema-validation#name-validation-keywords-for-obj) å’Œ [Cookie](https://github.com/jshttp/cookie#options-1) çš„å±æ€§ï¼Œå¹¶å…·æœ‰å¦‚ä¸‹é™„åŠ å±æ€§ï¼š

#### secrets

ç”¨äºç­¾å Cookie çš„ç§˜å¯†å¯†é’¥ã€‚

æ¥å—å­—ç¬¦ä¸²æˆ–å­—ç¬¦ä¸²æ•°ç»„ã€‚

```typescript
secrets?: string | string[]
```

å¦‚æœæä¾›äº†ä¸€ä¸ªæ•°ç»„ï¼Œå°†ä½¿ç”¨ [å¯†é’¥è½®æ¢](https://crypto.stackexchange.com/questions/41796/whats-the-purpose-of-key-rotation)ã€‚æ–°ç­¾åçš„å€¼å°†ä½¿ç”¨ç¬¬ä¸€ä¸ªç§˜å¯†ä½œä¸ºå¯†é’¥ã€‚

### å¯ä¸ºç©º

å…è®¸å€¼ä¸º null ä½†ä¸ä¸º undefinedã€‚

```typescript
t.Nullable(t.String())
```

### å…è®¸ç©ºå€¼

å…è®¸å€¼ä¸º null å’Œ undefinedã€‚

```typescript
t.MaybeEmpty(t.String())
```

æœ‰å…³å…¶ä»–ä¿¡æ¯ï¼Œä½ å¯ä»¥åœ¨ [`elysia/type-system`](https://github.com/elysiajs/elysia/blob/main/src/type-system/index.ts) ä¸­æ‰¾åˆ°å®Œæ•´çš„ç±»å‹ç³»ç»Ÿæºä»£ç ã€‚

### è¡¨å•

å¯¹æˆ‘ä»¬çš„ `t.Object` è¿›è¡Œè¯­æ³•ç³–å¤„ç†ï¼Œæ”¯æŒéªŒè¯ [è¡¨å•](/essential/handler.html#formdata)ï¼ˆFormDataï¼‰ çš„è¿”å›å€¼ã€‚

```typescript
t.Form({
	someValue: t.File()
})
```

### UInt8Array

æ¥å—å¯ä»¥è¢«è§£æä¸º `Uint8Array` çš„ç¼“å†²åŒºã€‚

```typescript
t.UInt8Array()
```

å½“ä½ æƒ³æ¥å—å¯ä»¥è¢«è§£æä¸º `Uint8Array` çš„ç¼“å†²åŒºæ—¶éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä¼ ã€‚å®ƒè®¾è®¡ç”¨äºé…åˆ `arrayBuffer` è§£æå™¨éªŒè¯è¯·æ±‚ä½“ï¼Œä»¥å¼ºåˆ¶è¯·æ±‚ä½“ç±»å‹ã€‚

### ArrayBuffer

æ¥å—å¯ä»¥è¢«è§£æä¸º `ArrayBuffer` çš„ç¼“å†²åŒºã€‚

```typescript
t.ArrayBuffer()
```

å½“ä½ æƒ³æ¥å—å¯ä»¥è¢«è§£æä¸º `Uint8Array` çš„ç¼“å†²åŒºæ—¶éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚äºŒè¿›åˆ¶æ–‡ä»¶ä¸Šä¼ ã€‚å®ƒè®¾è®¡ç”¨äºé…åˆ `arrayBuffer` è§£æå™¨éªŒè¯è¯·æ±‚ä½“ï¼Œä»¥å¼ºåˆ¶è¯·æ±‚ä½“ç±»å‹ã€‚

### ObjectString

æ¥å—å¯ä»¥è¢«è§£æä¸ºå¯¹è±¡çš„å­—ç¬¦ä¸²ã€‚

```typescript
t.ObjectString()
```

å½“ä½ æƒ³æ¥å—å¯ä»¥è¢«è§£æä¸ºå¯¹è±¡çš„å­—ç¬¦ä¸²ä½†ç¯å¢ƒä¸æ”¯æŒæ˜¾å¼ä¼ é€’æ—¶éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚æŸ¥è¯¢å­—ç¬¦ä¸²ã€è¯·æ±‚å¤´æˆ– FormData è¯·æ±‚ä½“ã€‚

### BooleanString

æ¥å—å¯ä»¥è¢«è§£æä¸ºå¸ƒå°”å€¼çš„å­—ç¬¦ä¸²ã€‚

ç±»ä¼¼äº [ObjectString](#objectstring)ï¼Œå½“ä½ æƒ³æ¥å—å¯ä»¥è¢«è§£æä¸ºå¸ƒå°”å€¼çš„å­—ç¬¦ä¸²ä½†ç¯å¢ƒä¸æ”¯æŒæ˜¾å¼ä¼ é€’æ—¶éå¸¸æœ‰ç”¨ã€‚

```typescript
t.BooleanString()
```

### Numeric

Numeric æ¥å—æ•°å­—å­—ç¬¦ä¸²æˆ–æ•°å­—ï¼Œç„¶åå°†å€¼è½¬æ¢ä¸ºæ•°å­—ã€‚

```typescript
t.Numeric()
```

å½“ä¼ å…¥å€¼æ˜¯æ•°å­—å­—ç¬¦ä¸²æ—¶éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚è·¯å¾„å‚æ•°æˆ–æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚

Numeric æ”¯æŒä¸ [Numeric å®ä¾‹](https://json-schema.org/draft/2020-12/json-schema-validation#name-validation-keywords-for-num) ç›¸åŒçš„å±æ€§ã€‚

## Elysia è¡Œä¸º

Elysia é»˜è®¤ä½¿ç”¨ TypeBoxã€‚

ç„¶è€Œï¼Œä¸ºäº†æ›´æ–¹ä¾¿åœ°å¤„ç† HTTPï¼ŒElysia æœ‰ä¸€äº›ä¸“ç”¨ç±»å‹ï¼Œå¹¶ä¸”ä¸ TypeBox æœ‰ä¸€äº›è¡Œä¸ºä¸Šçš„ä¸åŒã€‚

## å¯é€‰ç±»å‹

è¦ä½¿å­—æ®µå¯é€‰ï¼Œè¯·ä½¿ç”¨ `t.Optional`ã€‚

è¿™å°†å…è®¸å®¢æˆ·ç«¯å¯é€‰åœ°æä¾›æŸ¥è¯¢å‚æ•°ã€‚æ­¤è¡Œä¸ºä¹Ÿé€‚ç”¨äº `body`ã€`headers`ã€‚

è¿™ä¸ TypeBox ä¸åŒï¼Œå…¶ä¸­å¯é€‰ç”¨äºæ ‡è®°å¯¹è±¡å­—æ®µä¸ºå¯é€‰ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/optional', ({ query }) => query, {
                       // ^?




		query: t.Optional(
			t.Object({
				name: t.String()
			})
		)
	})
```

## æ•°å­—åˆ° Numeric

é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä½œä¸ºè·¯ç”±æ¨¡å¼æä¾›æ—¶ï¼ŒElysia ä¼šå°† `t.Number` è½¬æ¢ä¸º [t.Numeric](#numeric)ã€‚

å› ä¸ºè§£æçš„ HTTP å¤´ã€æŸ¥è¯¢ã€URL å‚æ•°æ€»æ˜¯å­—ç¬¦ä¸²ã€‚è¿™æ„å‘³ç€å³ä½¿å€¼æ˜¯æ•°å­—ï¼Œå®ƒä¹Ÿä¼šè¢«è§†ä¸ºå­—ç¬¦ä¸²ã€‚

Elysia é€šè¿‡æ£€æŸ¥å­—ç¬¦ä¸²å€¼æ˜¯å¦çœ‹èµ·æ¥åƒæ•°å­—æ¥è¦†ç›–æ­¤è¡Œä¸ºï¼Œç„¶ååœ¨é€‚å½“æ—¶è¿›è¡Œè½¬æ¢ã€‚

è¿™ä»…åœ¨ä½œä¸ºè·¯ç”±æ¨¡å¼ä½¿ç”¨æ—¶åº”ç”¨ï¼Œè€Œä¸åœ¨åµŒå¥—çš„ `t.Object` ä¸­ã€‚

```ts
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/:id', ({ id }) => id, {
		params: t.Object({
			// è½¬æ¢ä¸º t.Numeric()
			id: t.Number()
		}),
		body: t.Object({
			// ä¸ è½¬æ¢ä¸º t.Numeric()
			id: t.Number()
		})
	})

// ä¸ è½¬æ¢ä¸º t.Numeric()
t.Number()
```

## å¸ƒå°”å€¼åˆ°å¸ƒå°”å­—ç¬¦ä¸²

ç±»ä¼¼äº [æ•°å­—åˆ°æ•°å­—ç±»å‹](#æ•°å€¼åˆ°-numeric)

ä»»ä½• `t.Boolean` å°†è½¬æ¢ä¸º `t.BooleanString`ã€‚

```ts
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/:id', ({ id }) => id, {
		params: t.Object({
			// è½¬æ¢ä¸º t.BooleanString()
			id: t.Boolean()
		}),
		body: t.Object({
			// ä¸ è½¬æ¢ä¸º t.BooleanString()
			id: t.Boolean()
		})
	})

// ä¸ è½¬æ¢ä¸º t.BooleanString()
t.Boolean()
```

---

---
url: 'https://elysiajs.com/patterns/typescript.md'
---

# TypeScript

Elysia å¼€ç®±å³ç”¨æ”¯æŒ TypeScriptã€‚

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ æ— éœ€æ‰‹åŠ¨æ·»åŠ ä»»ä½• TypeScript æ³¨è§£ã€‚

## æ¨æ–­

Elysia ä¼šæ ¹æ®ä½ æä¾›çš„ Schema æ¨æ–­è¯·æ±‚å’Œå“åº”çš„ç±»å‹ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'
import { z } from 'zod'

const app = new Elysia()
  	.post('/user/:id', ({ body }) => body, {
  	//                     ^?
	  	body: t.Object({
			id: t.String()
		}),
		query: z.object({
			name: z.string()
		})
   	})
```

Elysia å¯ä»¥è‡ªåŠ¨ä»è¯¸å¦‚ TypeBox å’Œä½ å–œæ¬¢çš„éªŒè¯åº“ï¼ˆå‚è§ [æ ‡å‡† Schema](/essential/validation#standard-schema)ï¼‰çš„ Schema ä¸­æ¨å¯¼ç±»å‹ï¼Œä¾‹å¦‚ï¼š

* Zod
* Valibot
* ArkType
* Effect Schema
* Yup
* Joi

### Schema è½¬ Type

Elysia æ”¯æŒçš„æ‰€æœ‰ Schema åº“éƒ½å¯ä»¥è½¬æ¢æˆ TypeScript ç±»å‹ã€‚

\<Tab
id="quickstart"
:names="\['TypeBox', 'Zod', 'Valibot', 'ArkType']"
:tabs="\['typebox', 'zod', 'valibot', 'arktype']"
noTitle

>

```ts twoslash
import { Elysia, t } from 'elysia'

const User = t.Object({
  	id: t.String(),
  	name: t.String()
})

type User = typeof User['static']
//    ^?
```

```ts twoslash
import { z } from 'zod'

const User = z.object({
  	id: z.string(),
  	name: z.string()
})

type User = z.infer<typeof User>
//    ^?
```

```ts twoslash
import * as v from 'valibot'

const User = v.object({
  	id: v.string(),
  	name: v.string()
})

type User = v.InferOutput<typeof User>
//    ^?
```

```ts twoslash
import { type } from 'arktype'

const User = type({
  	id: 'string',
  	name: 'string'
})

type User = typeof User.infer
//    ^?
```

## ç±»å‹æ€§èƒ½

Elysia çš„è®¾è®¡è€ƒè™‘äº†ç±»å‹æ¨æ–­æ€§èƒ½ã€‚

åœ¨æ¯æ¬¡å‘å¸ƒå‰ï¼Œæˆ‘ä»¬éƒ½ä¼šè¿›è¡Œæœ¬åœ°åŸºå‡†æµ‹è¯•ï¼Œç¡®ä¿ç±»å‹æ¨æ–­å¿«é€Ÿæµç•…ï¼Œä¸ä¼šè®©ä½ çš„ IDE æŠ¥â€œç±»å‹å®ä¾‹åŒ–è¿‡æ·±ä¸”å¯èƒ½æ— é™â€çš„é”™è¯¯ã€‚

å¤§éƒ¨åˆ†ä½¿ç”¨ Elysia çš„æ—¶é—´é‡Œï¼Œä½ ä¸ä¼šé‡åˆ°ä»»ä½•ç±»å‹æ€§èƒ½é—®é¢˜ã€‚

ä¸è¿‡å¦‚æœé‡åˆ°äº†ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¥æ’æŸ¥å“ªäº›éƒ¨åˆ†æ‹–æ…¢äº†ç±»å‹æ¨æ–­ï¼š

1. è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œè¿è¡Œ

```
tsc --generateTrace trace --noEmit --incremental false
```

è¿™ä¼šåœ¨é¡¹ç›®æ ¹ç›®å½•ç”Ÿæˆä¸€ä¸ªåä¸º `trace` çš„æ–‡ä»¶å¤¹ã€‚

2. æ‰“å¼€ [Perfetto UI](https://ui.perfetto.dev)ï¼Œå°† `trace/trace.json` æ–‡ä»¶æ‹–å…¥é¡µé¢ã€‚

![Perfetto](/assets/perfetto.webp)

> ç•Œé¢ä¼šæ˜¾ç¤ºç±»ä¼¼ç«ç„°å›¾çš„å†…å®¹

æ‰¾åˆ°è€—æ—¶è¾ƒé•¿çš„éƒ¨åˆ†ï¼Œç‚¹å‡»æŸ¥çœ‹å®ƒçš„æ¨æ–­æ—¶é—´ã€æ¥æºçš„æ–‡ä»¶å’Œè¡Œå·ã€‚

è¿™æ ·å¯ä»¥å¸®åŠ©å®šä½ç±»å‹æ¨æ–­çš„æ€§èƒ½ç“¶é¢ˆã€‚

### Eden

å¦‚æœä½ åœ¨ä½¿ç”¨ [Eden](/eden/overview) æ—¶é‡åˆ°ç±»å‹æ¨æ–­ç¼“æ…¢é—®é¢˜ï¼Œå¯ä»¥å°è¯•ç”¨ Elysia çš„å­åº”ç”¨æ¥éš”ç¦»ç±»å‹æ¨æ–­ã€‚

```ts [backend/src/index.ts]
import { Elysia } from 'elysia'
import { plugin1, plugin2, plugin3 } from './plugin'

const app = new Elysia()
	.use([plugin1, plugin2, plugin3])
  	.listen(3000)

export type app = typeof app

// å¯¼å‡ºå­åº”ç”¨
export type subApp = typeof plugin1 // [!code ++]
```

åœ¨å‰ç«¯ï¼Œä½ å¯ä»¥å¯¼å…¥å­åº”ç”¨è€Œéæ•´ä¸ªåº”ç”¨ã€‚

```ts [frontend/src/index.ts]
import { treaty } from '@elysiajs/eden'
import type { subApp } from 'backend/src'

const api = treaty<subApp>('localhost:3000') // [!code ++]
```

è¿™èƒ½è®©ç±»å‹æ¨æ–­æ›´å¿«ï¼Œå› ä¸ºä¸å¿…æ¨æ–­æ•´ä¸ªåº”ç”¨ã€‚

è¯¦è§ [Eden Treaty](/eden/overview) äº†è§£æ›´å¤šå…³äº Eden çš„å†…å®¹ã€‚

---

---
url: 'https://elysiajs.com/patterns/websocket.md'
---

# WebSocket

WebSocket æ˜¯ä¸€ç§ç”¨äºå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´é€šä¿¡çš„å®æ—¶åè®®ã€‚

ä¸ HTTP ä¸åŒï¼Œå®¢æˆ·ç«¯ä¸€æ¬¡åˆä¸€æ¬¡åœ°è¯¢é—®ç½‘ç«™ä¿¡æ¯å¹¶ç­‰å¾…æ¯æ¬¡çš„å›å¤ï¼ŒWebSocket å»ºç«‹äº†ä¸€æ¡ç›´æ¥çš„é€šé“ï¼Œä½¿æˆ‘ä»¬çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥ç›´æ¥æ¥å›å‘é€æ¶ˆæ¯ï¼Œä»è€Œä½¿å¯¹è¯æ›´å¿«ã€æ›´æµç•…ï¼Œè€Œæ— éœ€æ¯æ¡æ¶ˆæ¯éƒ½é‡æ–°å¼€å§‹ã€‚

SocketIO æ˜¯ä¸€ä¸ªæµè¡Œçš„ WebSocket åº“ï¼Œä½†å¹¶ä¸æ˜¯å”¯ä¸€çš„ã€‚Elysia ä½¿ç”¨ [uWebSocket](https://github.com/uNetworking/uWebSockets)ï¼Œå®ƒä¸ Bun åœ¨åº•å±‚ä½¿ç”¨ç›¸åŒçš„ APIã€‚

è¦ä½¿ç”¨ WebSocketï¼Œåªéœ€è°ƒç”¨ `Elysia.ws()`ï¼š

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .ws('/ws', {
        message(ws, message) {
            ws.send(message)
        }
    })
    .listen(3000)
```

## WebSocket æ¶ˆæ¯éªŒè¯ï¼š

ä¸æ™®é€šè·¯ç”±ç›¸åŒï¼ŒWebSocket ä¹Ÿæ¥å—ä¸€ä¸ª **schema** å¯¹è±¡æ¥ä¸¥æ ¼ç±»å‹åŒ–å’ŒéªŒè¯è¯·æ±‚ã€‚

```typescript
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .ws('/ws', {
        // éªŒè¯ä¼ å…¥æ¶ˆæ¯
        body: t.Object({
            message: t.String()
        }),
        query: t.Object({
            id: t.String()
        }),
        message(ws, { message }) {
            // ä» `ws.data` è·å– schema
            const { id } = ws.data.query
            ws.send({
                id,
                message,
                time: Date.now()
            })
        }
    })
    .listen(3000)
```

WebSocket schema å¯ä»¥éªŒè¯å¦‚ä¸‹å†…å®¹ï¼š

* **message** - ä¼ å…¥æ¶ˆæ¯ã€‚
* **query** - æŸ¥è¯¢å­—ç¬¦ä¸²æˆ– URL å‚æ•°ã€‚
* **params** - è·¯å¾„å‚æ•°ã€‚
* **header** - è¯·æ±‚çš„å¤´éƒ¨ã€‚
* **cookie** - è¯·æ±‚çš„ cookieã€‚
* **response** - ä»å¤„ç†å™¨è¿”å›çš„å€¼ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia å°†è§£æä¼ å…¥çš„å­—ç¬¦ä¸²åŒ– JSON æ¶ˆæ¯ä¸ºå¯¹è±¡ä»¥ä¾›éªŒè¯ã€‚

## é…ç½®

æ‚¨å¯ä»¥é€šè¿‡ Elysia æ„é€ å‡½æ•°è®¾ç½® WebSocket å€¼ã€‚

```ts
import { Elysia } from 'elysia'

new Elysia({
    websocket: {
        idleTimeout: 30
    }
})
```

Elysia çš„ WebSocket å®ç°æ‰©å±•äº† Bun çš„ WebSocket é…ç½®ï¼Œæ›´å¤šä¿¡æ¯è¯·å‚è§ [Bun çš„ WebSocket æ–‡æ¡£](https://bun.zhcndoc.com/api/websockets)ã€‚

ä»¥ä¸‹æ˜¯ [Bun WebSocket](https://bun.zhcndoc.com/api/websockets#create-a-websocket-server) çš„ç®€è¦é…ç½®ï¼š

### perMessageDeflate

@default `false`

ä¸ºæ”¯æŒçš„å®¢æˆ·ç«¯å¯ç”¨å‹ç¼©ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œå‹ç¼©æ˜¯ç¦ç”¨çš„ã€‚

### maxPayloadLength

æ¶ˆæ¯çš„æœ€å¤§å¤§å°ã€‚

### idleTimeout

@default `120`

åœ¨è¿æ¥æœªæ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œç»è¿‡è¿™ä¸€ç§’æ•°å°†å…³é—­è¿æ¥ã€‚

### backpressureLimit

@default `16777216` (16MB)

å•ä¸ªè¿æ¥å¯ä»¥ç¼“å†²çš„æœ€å¤§å­—èŠ‚æ•°ã€‚

### closeOnBackpressureLimit

@default `false`

å¦‚æœè¶…è¿‡èƒŒå‹é™åˆ¶ï¼Œå…³é—­è¿æ¥ã€‚

## æ–¹æ³•

ä»¥ä¸‹æ˜¯å¯ç”¨äº WebSocket è·¯ç”±çš„æ–°æ–¹æ³•ã€‚

## ws

åˆ›å»º WebSocket å¤„ç†ç¨‹åºã€‚

ç¤ºä¾‹ï¼š

```typescript
import { Elysia } from 'elysia'

const app = new Elysia()
    .ws('/ws', {
        message(ws, message) {
            ws.send(message)
        }
    })
    .listen(3000)
```

ç±»å‹ï¼š

```typescript
.ws(endpoint: path, options: Partial<WebSocketHandler<Context>>): this
```

* **endpoint** - ä½œä¸º WebSocket å¤„ç†ç¨‹åºæš´éœ²çš„è·¯å¾„
* **options** - è‡ªå®šä¹‰ WebSocket å¤„ç†ç¨‹åºè¡Œä¸º

## WebSocketHandler

WebSocketHandler æ‰©å±•è‡ª [config](#configuration) çš„é…ç½®ã€‚

ä»¥ä¸‹æ˜¯ `ws` æ¥å—çš„é…ç½®ã€‚

## open

æ–°çš„ WebSocket è¿æ¥çš„å›è°ƒå‡½æ•°ã€‚

ç±»å‹ï¼š

```typescript
open(ws: ServerWebSocket<{
    // æ¯ä¸ªè¿æ¥çš„ uid
    id: string
    data: Context
}>): this
```

## message

ä¼ å…¥ WebSocket æ¶ˆæ¯çš„å›è°ƒå‡½æ•°ã€‚

ç±»å‹ï¼š

```typescript
message(
    ws: ServerWebSocket<{
        // æ¯ä¸ªè¿æ¥çš„ uid
        id: string
        data: Context
    }>,
    message: Message
): this
```

`Message` ç±»å‹åŸºäº `schema.message`ã€‚é»˜è®¤æ˜¯ `string`ã€‚

## close

å…³é—­ WebSocket è¿æ¥çš„å›è°ƒå‡½æ•°ã€‚

ç±»å‹ï¼š

```typescript
close(ws: ServerWebSocket<{
    // æ¯ä¸ªè¿æ¥çš„ uid
    id: string
    data: Context
}>): this
```

## drain

æœåŠ¡å™¨å‡†å¤‡å¥½æ¥å—æ›´å¤šæ•°æ®çš„å›è°ƒå‡½æ•°ã€‚

ç±»å‹ï¼š

```typescript
drain(
    ws: ServerWebSocket<{
        // æ¯ä¸ªè¿æ¥çš„ uid
        id: string
        data: Context
    }>,
    code: number,
    reason: string
): this
```

## parse

`Parse` ä¸­é—´ä»¶åœ¨å°† HTTP è¿æ¥å‡çº§åˆ° WebSocket ä¹‹å‰è§£æè¯·æ±‚ã€‚

## beforeHandle

`Before Handle` ä¸­é—´ä»¶åœ¨å°† HTTP è¿æ¥å‡çº§åˆ° WebSocket ä¹‹å‰æ‰§è¡Œã€‚

ç†æƒ³çš„éªŒè¯ä½ç½®ã€‚

## transform

`Transform` ä¸­é—´ä»¶åœ¨éªŒè¯ä¹‹å‰æ‰§è¡Œã€‚

## transformMessage

ç±»ä¼¼äº `transform`ï¼Œä½†åœ¨éªŒè¯ WebSocket æ¶ˆæ¯ä¹‹å‰æ‰§è¡Œã€‚

## header

åœ¨å°†è¿æ¥å‡çº§åˆ° WebSocket ä¹‹å‰æ·»åŠ çš„é™„åŠ å¤´ã€‚

---

---
url: 'https://elysiajs.com/tutorial/whats-next.md'
---

# æ­å–œï¼

æ‚¨å·²å®Œæˆæ•™ç¨‹ã€‚

ç°åœ¨æ‚¨å‡†å¤‡å¥½ä½¿ç”¨ Elysia æ„å»ºè‡ªå·±çš„åº”ç”¨ç¨‹åºäº†ï¼

## é¦–å…ˆ

æˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨åœ¨å¼€å§‹ä½¿ç”¨ Elysia ä¹‹å‰å…ˆæŸ¥çœ‹è¿™ä¸¤é¡µå†…å®¹ï¼š

### llms.txt

æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä¸‹è½½ llms.txt æˆ– llms-full.txtï¼Œå¹¶å°†å…¶æä¾›ç»™æ‚¨æœ€å–œæ¬¢çš„ LLMï¼Œä¾‹å¦‚ ChatGPTã€Claude æˆ– Geminiï¼Œä»¥è·å¾—æ›´äº’åŠ¨çš„ä½“éªŒã€‚

### å¦‚æœæ‚¨é‡åˆ°å›°éš¾

è¯·éšæ—¶åœ¨ GitHub Discussionsã€Discord å’Œ Twitter ä¸Šå‘æˆ‘ä»¬çš„ç¤¾åŒºæé—®ã€‚

## æ¥è‡ªå…¶ä»–æ¡†æ¶ï¼Ÿ

å¦‚æœæ‚¨ä½¿ç”¨è¿‡å…¶ä»–æµè¡Œæ¡†æ¶ï¼Œå¦‚ Expressã€Fastify æˆ– Honoï¼Œæ‚¨ä¼šå‘ç° Elysia ä¹Ÿå¾ˆä¸Šæ‰‹ï¼Œä»…æœ‰ä¸€äº›å°å·®åˆ«ã€‚

## é‡è¦ç« èŠ‚

ä»¥ä¸‹æ˜¯ Elysia çš„åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨åœ¨è·³è½¬åˆ°å…¶ä»–ä¸»é¢˜ä¹‹å‰å…ˆæµè§ˆè¿™äº›é¡µé¢ï¼š

## æ›´å¤šæ¨¡å¼

å¦‚æœæ‚¨æƒ³æ¢ç´¢æ›´å¤š Elysia ç‰¹æ€§ï¼Œè¯·æŸ¥çœ‹ï¼š

## ä¸ Meta æ¡†æ¶é›†æˆ

æˆ‘ä»¬è¿˜å¯ä»¥å°† Elysia ä¸ Meta æ¡†æ¶é›†æˆï¼Œå¦‚ Nextjsã€Nuxtã€Astro ç­‰ã€‚

## ä¸æ‚¨å–œæ¬¢çš„å·¥å…·é›†æˆ

æˆ‘ä»¬ä¸ä¸€äº›æµè¡Œå·¥å…·è¿›è¡Œäº†é›†æˆï¼š

***

æˆ‘ä»¬å¸Œæœ›æ‚¨ä¼šåƒæˆ‘ä»¬ä¸€æ ·å–œçˆ± Elysiaï¼

---

---
url: 'https://elysiajs.com/integrations/ai-sdk.md'
---

# ä¸ AI SDK é›†æˆ

Elysia æä¾›äº†å¯¹å“åº”æµçš„æ”¯æŒï¼Œä½¿æ‚¨èƒ½å¤Ÿæ— ç¼é›†æˆ [Vercel AI SDKs](https://vercel.com/docs/ai)ã€‚

## å“åº”æµ

Elysia æ”¯æŒå¯¹ `ReadableStream` å’Œ `Response` çš„æŒç»­æµå¼å¤„ç†ï¼Œå…è®¸æ‚¨ç›´æ¥ä» AI SDK è¿”å›æµã€‚

```ts
import { Elysia } from 'elysia'
import { streamText } from 'ai'
import { openai } from '@ai-sdk/openai'

new Elysia().get('/', () => {
    const stream = streamText({
        model: openai('gpt-5'),
        system: 'ä½ æ˜¯ã€ŠåŸç¥ã€‹ä¸­çš„å…«é‡ç¥å­',
        prompt: 'å—¨ï¼ä½ è¿‘æ¥æ€ä¹ˆæ ·ï¼Ÿ'
    })

    // ç›´æ¥è¿”å›ä¸€ä¸ª ReadableStream
    return stream.textStream // [!code ++]

    // ä¹Ÿæ”¯æŒ UI æ¶ˆæ¯æµ
    return stream.toUIMessageStream() // [!code ++]
})
```

Elysia ä¼šè‡ªåŠ¨å¤„ç†æµï¼Œå…è®¸æ‚¨ä»¥å¤šç§æ–¹å¼ä½¿ç”¨å®ƒã€‚

## æœåŠ¡å™¨å‘é€äº‹ä»¶ï¼ˆServer Sent Eventï¼‰

Elysia è¿˜æ”¯æŒé€šè¿‡ç®€å•åœ°å°† `ReadableStream` åŒ…è£¹åœ¨ `sse` å‡½æ•°ä¸­ï¼Œå®ç°æµå¼å“åº”çš„æœåŠ¡å™¨å‘é€äº‹ä»¶ã€‚

```ts
import { Elysia, sse } from 'elysia' // [!code ++]
import { streamText } from 'ai'
import { openai } from '@ai-sdk/openai'

new Elysia().get('/', () => {
    const stream = streamText({
        model: openai('gpt-5'),
        system: 'ä½ æ˜¯ã€ŠåŸç¥ã€‹ä¸­çš„å…«é‡ç¥å­',
        prompt: 'å—¨ï¼ä½ è¿‘æ¥æ€ä¹ˆæ ·ï¼Ÿ'
    })

    // æ¯ä¸ªæ•°æ®å—éƒ½ä¼šä½œä¸ºæœåŠ¡å™¨å‘é€äº‹ä»¶å‘é€
    return sse(stream.textStream) // [!code ++]

    // ä¹Ÿæ”¯æŒ UI æ¶ˆæ¯æµ
    return sse(stream.toUIMessageStream()) // [!code ++]
})
```

## ä½œä¸ºå“åº”

å¦‚æœæ‚¨ä¸éœ€è¦åç»­ä½¿ç”¨ [Eden](/eden/overview) çš„æµç±»å‹å®‰å…¨ï¼Œå¯ä»¥ç›´æ¥å°†æµä½œä¸ºå“åº”è¿”å›ã€‚

```ts
import { Elysia } from 'elysia'
import { ai } from 'ai'
import { openai } from '@ai-sdk/openai'

new Elysia().get('/', () => {
    const stream = streamText({
        model: openai('gpt-5'),
        system: 'ä½ æ˜¯ã€ŠåŸç¥ã€‹ä¸­çš„å…«é‡ç¥å­',
        prompt: 'å—¨ï¼ä½ è¿‘æ¥æ€ä¹ˆæ ·ï¼Ÿ'
    })

    return stream.toTextStreamResponse() // [!code ++]

    // UI æ¶ˆæ¯æµå“åº”å°†ä½¿ç”¨ SSE
    return stream.toUIMessageStreamResponse() // [!code ++]
})
```

## æ‰‹åŠ¨æµå¼å¤„ç†

å¦‚æœæ‚¨æƒ³å¯¹æµè¿‡ç¨‹æœ‰æ›´å¤šæ§åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ç”Ÿæˆå™¨å‡½æ•°æ‰‹åŠ¨äº§å‡ºæ•°æ®å—ã€‚

```ts
import { Elysia, sse } from 'elysia'
import { ai } from 'ai'
import { openai } from '@ai-sdk/openai'

new Elysia().get('/', async function* () {
    const stream = streamText({
        model: openai('gpt-5'),
        system: 'ä½ æ˜¯ã€ŠåŸç¥ã€‹ä¸­çš„å…«é‡ç¥å­',
        prompt: 'å—¨ï¼ä½ è¿‘æ¥æ€ä¹ˆæ ·ï¼Ÿ'
    })

    for await (const data of stream.textStream) // [!code ++]
        yield sse({ // [!code ++]
            data, // [!code ++]
            event: 'message' // [!code ++]
        }) // [!code ++]

    yield sse({
        event: 'done'
    })
})
```

## ä½¿ç”¨ Fetch

å¦‚æœ AI SDK ä¸æ”¯æŒæ‚¨ä½¿ç”¨çš„æ¨¡å‹ï¼Œæ‚¨ä»ç„¶å¯ä»¥ä½¿ç”¨ `fetch` å‡½æ•°å‘ AI SDK å‘èµ·è¯·æ±‚å¹¶ç›´æ¥æµå¼ä¼ è¾“å“åº”ã€‚

```ts
import { Elysia, fetch } from 'elysia'

new Elysia().get('/', () => {
    return fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${process.env.OPENAI_API_KEY}`
        },
        body: JSON.stringify({
            model: 'gpt-5',
            stream: true,
            messages: [
                {
                    role: 'system',
                    content: 'ä½ æ˜¯ã€ŠåŸç¥ã€‹ä¸­çš„å…«é‡ç¥å­'
                },
                { role: 'user', content: 'å—¨ï¼ä½ è¿‘æ¥æ€ä¹ˆæ ·ï¼Ÿ' }
            ]
        })
    })
})
```

Elysia ä¼šè‡ªåŠ¨ä»£ç†å¸¦æœ‰æµæ”¯æŒçš„ fetch å“åº”ã€‚

***

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ [AI SDK æ–‡æ¡£](https://ai-sdk.dev/docs/introduction)

---

---
url: 'https://elysiajs.com/integrations/astro.md'
---

# ä¸ Astro çš„é›†æˆ

ä½¿ç”¨ [Astro Endpoint](https://astro.zhcndoc.com/zh-cn/core-concepts/endpoints/)ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ Astro ä¸Šè¿è¡Œ Elysiaã€‚

1. åœ¨ **astro.config.mjs** ä¸­å°† **output** è®¾ç½®ä¸º **server**

```javascript
// astro.config.mjs
import { defineConfig } from 'astro/config'

// https://astro.build/config
export default defineConfig({
    output: 'server' // [!code ++]
})
```

2. åˆ›å»º **pages/\[...slugs].ts**
3. åœ¨ **\[...slugs].ts** ä¸­åˆ›å»ºæˆ–å¯¼å…¥ä¸€ä¸ªç°æœ‰çš„ Elysia æœåŠ¡å™¨
4. ç”¨æ‚¨æƒ³è¦å…¬å¼€çš„æ–¹æ³•åç§°å¯¼å‡ºå¤„ç†å™¨

```typescript
// pages/[...slugs].ts
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .get('/api', () => 'hi')
    .post('/api', ({ body }) => body, {
        body: t.Object({
            name: t.String()
        })
    })

const handle = ({ request }: { request: Request }) => app.handle(request) // [!code ++]

export const GET = handle // [!code ++]
export const POST = handle // [!code ++]
```

Elysia èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œå› ä¸ºéµå¾ªäº† WinterCGã€‚

æˆ‘ä»¬æ¨èåœ¨ [Bun ä¸Šè¿è¡Œ Astro](https://astro.zhcndoc.com/zh-cn/recipes/bun)ï¼Œå› ä¸º Elysia è®¾è®¡æ˜¯ä¸ºäº†åœ¨ Bun ä¸Šè¿è¡Œã€‚

::: tip
æ‚¨å¯ä»¥åœ¨ä¸ä½¿ç”¨ Bun è¿è¡Œ Astro çš„æƒ…å†µä¸‹è¿è¡Œ Elysia æœåŠ¡å™¨ï¼Œè¿™å¾—ç›Šäº WinterCG çš„æ”¯æŒã€‚

ä½†æ˜¯å¦‚æœæ‚¨åœ¨ Node ä¸Šè¿è¡Œ Astroï¼ŒæŸäº›æ’ä»¶å¦‚ **Elysia Static** å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚
:::

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ‚¨å¯ä»¥åœ¨å•ä¸ªä»£ç åº“ä¸­å…±åŒæ‹¥æœ‰å‰ç«¯å’Œåç«¯ï¼Œå¹¶ä¸”ä¸ Eden å®ç°ç«¯åˆ°ç«¯çš„ç±»å‹å®‰å…¨ã€‚

### pnpm

å¦‚æœæ‚¨ä½¿ç”¨ pnpmï¼Œ[pnpm é»˜è®¤ä¸ä¼šè‡ªåŠ¨å®‰è£… peer ä¾èµ–](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230)ï¼Œè¿™ä¼šè¦æ±‚æ‚¨æ‰‹åŠ¨å®‰è£…é¢å¤–çš„ä¾èµ–ã€‚

```bash
pnpm add @sinclair/typebox openapi-types
```

## å‰ç¼€

å¦‚æœæ‚¨å°† Elysia æœåŠ¡å™¨æ”¾åœ¨åº”ç”¨è·¯ç”±çš„æ ¹ç›®å½•ä¹‹å¤–ï¼Œæ‚¨éœ€è¦ä¸º Elysia æœåŠ¡å™¨æ³¨é‡Šå‰ç¼€ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°† Elysia æœåŠ¡å™¨æ”¾åœ¨ **pages/api/\[...slugs].ts**ï¼Œåˆ™éœ€è¦å°†å‰ç¼€æ³¨é‡Šä¸º **/api**ã€‚

```typescript
// pages/api/[...slugs].ts
import { Elysia, t } from 'elysia'

const app = new Elysia({ prefix: '/api' }) // [!code ++]
    .get('/', () => 'hi')
    .post('/', ({ body }) => body, {
        body: t.Object({
            name: t.String()
        })
    })

const handle = ({ request }: { request: Request }) => app.handle(request) // [!code ++]

export const GET = handle // [!code ++]
export const POST = handle // [!code ++]
```

è¿™å°†ç¡®ä¿ Elysia è·¯ç”±åœ¨æ‚¨æ”¾ç½®çš„ä½ç½®ä¸Šèƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [Astro Endpoint](https://astro.zhcndoc.com/zh-cn/core-concepts/endpoints/)ã€‚

---

---
url: 'https://elysiajs.com/integrations/cloudflare-worker.md'
---

# Cloudflare Worker å®éªŒæ€§

Elysia ç°åœ¨æ”¯æŒé€šè¿‡ä¸€ä¸ª**å®éªŒæ€§**çš„ Cloudflare Worker é€‚é…å™¨è¿è¡Œåœ¨ Cloudflare Worker ä¸Šã€‚

1. ä½ éœ€è¦ä½¿ç”¨ [Wrangler](https://developers.cloudflare.com/workers/wrangler/install-and-update) è¿›è¡Œè®¾ç½®ï¼Œå¹¶å¯åŠ¨å¼€å‘æœåŠ¡å™¨ã€‚

```bash
wrangler init elysia-on-cloudflare
```

2. æ¥ç€å°† Cloudflare é€‚é…å™¨æ·»åŠ åˆ°ä½ çš„ Elysia åº”ç”¨ï¼Œå¹¶ç¡®ä¿åœ¨å¯¼å‡ºåº”ç”¨å‰è°ƒç”¨ `.compile()`ã€‚

```ts
import { Elysia } from 'elysia'
import { CloudflareAdapter } from 'elysia/adapter/cloudflare-worker' // [!code ++]

export default new Elysia({
	adapter: CloudflareAdapter // [!code ++]
})
	.get('/', () => 'Hello Cloudflare Worker!')
	// ä½¿ Elysia èƒ½åœ¨ Cloudflare Worker ä¸Šè¿è¡Œæ‰€å¿…éœ€
	.compile() // [!code ++]
```

3. ç¡®ä¿åœ¨ä½ çš„ wrangler é…ç½®ä¸­å°† `compatibility_date` è®¾ç½®è‡³å°‘ä¸º `2025-06-01`

::: code-group

```jsonc [wrangler.jsonc]
{
	"$schema": "node_modules/wrangler/config-schema.json",
 	"name": "elysia-on-cloudflare",
	"main": "src/index.ts",
	"compatibility_date": "2025-06-01" // [!code ++]
}
```

```toml [wrangler.toml]
main = "src/index.ts"
name = "elysia-on-cloudflare"
compatibility_date = "2025-06-01" # [!code ++]
```

:::

4. ç°åœ¨ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š

```bash
wrangler dev
```

è¿™å°†å¯åŠ¨ä¸€ä¸ªå¼€å‘æœåŠ¡å™¨ï¼Œåœ°å€ä¸º `http://localhost:8787`

ä½ ä¸éœ€è¦ `nodejs_compat` æ ‡å¿—ï¼Œå› ä¸º Elysia ä¸ä½¿ç”¨ä»»ä½• Node.js å†…ç½®æ¨¡å—ï¼ˆæˆ–è€…è¯´æˆ‘ä»¬ä½¿ç”¨çš„æ¨¡å—è¿˜ä¸æ”¯æŒ Cloudflare Workerï¼‰ã€‚

### pnpm

å¦‚æœä½ ä½¿ç”¨ pnpmï¼Œ[pnpm é»˜è®¤ä¸ä¼šè‡ªåŠ¨å®‰è£… peer ä¾èµ–](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230)ï¼Œéœ€è¦ä½ æ‰‹åŠ¨å®‰è£…é¢å¤–ä¾èµ–ã€‚

```bash
pnpm add @sinclair/typebox openapi-types
```

## é™åˆ¶

ä»¥ä¸‹æ˜¯åœ¨ Cloudflare Worker ä¸Šä½¿ç”¨ Elysia çš„ä¸€äº›å·²çŸ¥é™åˆ¶ï¼š

1. `Elysia.file` å’Œ [é™æ€æ’ä»¶](/plugins/static) ä¸å¯ç”¨ï¼Œ[å› ä¸ºç¼ºå°‘ `fs` æ¨¡å—æ”¯æŒ](https://developers.cloudflare.com/workers/runtime-apis/nodejs/#supported-nodejs-apis)ï¼Œè¯¦è§[é™æ€æ–‡ä»¶](#static-file)éƒ¨åˆ†çš„æ›¿ä»£æ–¹æ¡ˆ
2. [OpenAPI ç±»å‹ç”Ÿæˆ](/blog/openapi-type-gen) ä¸å¯ç”¨ï¼Œ[å› ä¸ºç¼ºå°‘ `fs` æ¨¡å—æ”¯æŒ](https://developers.cloudflare.com/workers/runtime-apis/nodejs/#supported-nodejs-apis)
3. ä½ ä¸èƒ½åœ¨æœåŠ¡å™¨å¯åŠ¨å‰å®šä¹‰[**Response**](https://x.com/saltyAom/status/1966602691754553832)ï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨ä¼šè¿™æ ·åšçš„æ’ä»¶
4. ç”±äºç¬¬ 3 ç‚¹ï¼Œä½ ä¸èƒ½å†…è”ä¸€ä¸ªå€¼ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	// è¿™ä¼šæŠ›å‡ºé”™è¯¯
    .get('/', 'Hello Elysia')
    .listen(3000)
```

## é™æ€æ–‡ä»¶

[é™æ€æ’ä»¶](/plugins/static) ä¸å¯ç”¨ï¼Œä½†ä½ ä»ç„¶å¯ä»¥ä½¿ç”¨ [Cloudflare å†…ç½®çš„é™æ€æ–‡ä»¶æœåŠ¡](https://developers.cloudflare.com/workers/static-assets/) æ¥æä¾›é™æ€æ–‡ä»¶ã€‚

åœ¨ä½ çš„ wrangler é…ç½®ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

::: code-group

```jsonc [wrangler.jsonc]
{
	"$schema": "node_modules/wrangler/config-schema.json",
 	"name": "elysia-on-cloudflare",
	"main": "src/index.ts",
	"compatibility_date": "2025-06-01",
	"assets": { "directory": "public" } // [!code ++]
}
```

```toml [wrangler.toml]
name = "elysia-on-cloudflare"
main = "src/index.ts"
compatibility_date = "2025-06-01"
assets = { directory = "public" } # [!code ++]
```

:::

åˆ›å»ºä¸€ä¸ª `public` æ–‡ä»¶å¤¹å¹¶å°†ä½ çš„é™æ€æ–‡ä»¶æ”¾å…¥å…¶ä¸­ã€‚

ä¾‹å¦‚ï¼Œä½ æœ‰å¦‚ä¸‹æ–‡ä»¶å¤¹ç»“æ„ï¼š

```
â”‚
â”œâ”€ public
â”‚  â”œâ”€ kyuukurarin.mp4
â”‚  â””â”€ static
â”‚     â””â”€ mika.webp
â”œâ”€ src
â”‚  â””â”€â”€ index.ts
â””â”€ wrangler.toml
```

é‚£ä¹ˆä½ åº”è¯¥èƒ½é€šè¿‡ä»¥ä¸‹è·¯å¾„è®¿é—®é™æ€æ–‡ä»¶ï¼š

* **http://localhost:8787/kyuukurarin.mp4**
* **http://localhost:8787/static/mika.webp**

## ç»‘å®š

é€šè¿‡ä» `cloudflare:workers` å¯¼å…¥ envï¼Œä½ å¯ä»¥ä½¿ç”¨ Cloudflare Workers ç»‘å®šã€‚

```ts
import { Elysia } from 'elysia'
import { CloudflareAdapter } from 'elysia/adapter/cloudflare-worker'
import { env } from 'cloudflare:workers' // [!code ++]

export default new Elysia({
	adapter: CloudflareAdapter
})
	.get('/', () => `Hello ${await env.KV.get('my-key')}`) // [!code ++]
	.compile()
```

æ›´å¤šç»‘å®šä¿¡æ¯è¯·å‚é˜… [Cloudflare Workers: Binding](https://developers.cloudflare.com/workers/runtime-apis/bindings/#importing-env-as-a-global)ã€‚

## é¢„ç¼–è¯‘ï¼ˆAoTï¼‰ç¼–è¯‘

æ­¤å‰ï¼Œåœ¨ Cloudflare Worker ä¸Šä½¿ç”¨ Elysia æ—¶ï¼Œä½ éœ€è¦ç»™ Elysia æ„é€ å‡½æ•°ä¼ å…¥ `aot: false`ã€‚

è¿™ç°åœ¨å·²ä¸å†å¿…è¦ï¼Œ[å› ä¸º Cloudflare ç°åœ¨æ”¯æŒå¯åŠ¨æœŸé—´çš„å‡½æ•°ç¼–è¯‘](https://developers.cloudflare.com/workers/configuration/compatibility-flags/#enable-eval-during-startup)ã€‚

ä» Elysia 1.4.7 ç‰ˆæœ¬èµ·ï¼Œä½ å¯ä»¥åœ¨ Cloudflare Worker ä¸Šå¯ç”¨é¢„ç¼–è¯‘ï¼ˆAhead of Time Compilationï¼‰ï¼Œå¹¶ä¸”å¯ä»¥å»æ‰ `aot: false` é€‰é¡¹ã€‚

```ts
import { Elysia } from 'elysia'
import { CloudflareAdapter } from 'elysia/adapter/cloudflare-worker' // [!code ++]

export default new Elysia({
	aot: false, // [!code --]
	adapter: CloudflareAdapter // [!code ++]
})
```

å½“ç„¶ï¼Œå¦‚æœä½ ä¸æƒ³ä½¿ç”¨é¢„ç¼–è¯‘ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨ `aot: false`ï¼Œä½†æˆ‘ä»¬æ¨èå¯ç”¨ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½å’Œæ›´å‡†ç¡®çš„æ’ä»¶å°è£…ã€‚

---

---
url: 'https://elysiajs.com/integrations/deno.md'
---

# ä¸ Deno é›†æˆ

Elysia æ„å»ºäº Web æ ‡å‡†çš„ Request/Response ä¹‹ä¸Šï¼Œå…è®¸æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ Deno.serve è¿è¡Œ Elysiaã€‚

è¦åœ¨ Deno ä¸Šè¿è¡Œ Elysiaï¼Œåªéœ€å°† `Elysia.fetch` åŒ…è£¹åœ¨ `Deno.serve` ä¸­å³å¯

```typescript
import { Elysia } from 'elysia'

const app = new Elysia()
	.get('/', () => 'Hello Elysia')
	.listen(3000) // [!code --]

Deno.serve(app.fetch) // [!code ++]
```

ç„¶åä½ å¯ä»¥ä½¿ç”¨ `deno serve` å‘½ä»¤æ¥è¿è¡ŒæœåŠ¡å™¨ï¼š

```bash
deno serve --watch src/index.ts
```

è¿™å°±æ˜¯åœ¨ Deno ä¸Šè¿è¡Œ Elysia æ‰€éœ€çš„å…¨éƒ¨æ­¥éª¤ã€‚

### æ›´æ”¹ç«¯å£å·

ä½ å¯ä»¥åœ¨ `Deno.serve` ä¸­æŒ‡å®šç«¯å£å·ã€‚

```ts
Deno.serve(app.fetch) // [!code --]
Deno.serve({ port:8787 }, app.fetch) // [!code ++]
```

### pnpm

å¦‚æœä½ ä½¿ç”¨ pnpmï¼Œ[pnpm é»˜è®¤ä¸è‡ªåŠ¨å®‰è£… peer ä¾èµ–](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230)ï¼Œè¿™å°±è¦æ±‚ä½ æ‰‹åŠ¨å®‰è£…é¢å¤–çš„ä¾èµ–ã€‚

```bash
pnpm add @sinclair/typebox openapi-types
```

---

---
url: 'https://elysiajs.com/integrations/drizzle.md'
---

# Drizzle

Drizzle ORM æ˜¯ä¸€ä¸ªæ— å¤´ TypeScript ORMï¼Œä¸“æ³¨äºç±»å‹å®‰å…¨å’Œå¼€å‘è€…ä½“éªŒã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `drizzle-typebox` å°† Drizzle æ¨¡å¼è½¬æ¢ä¸º Elysia éªŒè¯æ¨¡å‹ã€‚

### Drizzle Typebox

[Elysia.t](/essential/validation.html#elysia-type) æ˜¯ TypeBox çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå…è®¸æˆ‘ä»¬ç›´æ¥åœ¨ Elysia ä¸­ä½¿ç”¨ä»»ä½• TypeBox ç±»å‹ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ["drizzle-typebox"](https://npmjs.org/package/drizzle-typebox) å°† Drizzle æ¨¡å¼è½¬æ¢ä¸º TypeBox æ¨¡å¼ï¼Œå¹¶ç›´æ¥åœ¨ Elysia çš„æ¨¡å¼éªŒè¯ä¸­ä½¿ç”¨ã€‚

### å…¶å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

1. åœ¨ Drizzle ä¸­å®šä¹‰ä½ çš„æ•°æ®åº“æ¨¡å¼ã€‚
2. ä½¿ç”¨ `drizzle-typebox` å°† Drizzle æ¨¡å¼è½¬æ¢ä¸º Elysia éªŒè¯æ¨¡å‹ã€‚
3. ä½¿ç”¨è½¬æ¢åçš„ Elysia éªŒè¯æ¨¡å‹æ¥ç¡®ä¿ç±»å‹éªŒè¯ã€‚
4. ä» Elysia éªŒè¯æ¨¡å‹ç”Ÿæˆ OpenAPI æ¨¡å¼ã€‚
5. æ·»åŠ  [Eden Treaty](/eden/overview) ä»¥å¢å¼ºå‰ç«¯çš„ç±»å‹å®‰å…¨ã€‚

```
                                                    * â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” *
                                                    |                 |
                                               | -> |  æ–‡æ¡£          |
* â€”â€”â€”â€”â€”â€”â€”â€”â€” *             * â€”â€”â€”â€”â€”â€”â€”â€” * OpenAPI |    |                 |
|           |   drizzle-  |          | â€”â€”â€”â€”â€”â€”â€” |    * â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” *
|  Drizzle  | â€”â€”â€”â€”â€”â€”â€”â€”â€”-> |  Elysia  |
|           |  -typebox   |          | â€”â€”â€”â€”â€”â€”â€” |    * â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” *
* â€”â€”â€”â€”â€”â€”â€”â€”â€” *             * â€”â€”â€”â€”â€”â€”â€”â€” *   Eden  |    |                 |
                                               | -> |  å‰ç«¯ä»£ç       |
												    |                 |
												    * â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” *

```

## å®‰è£…

è¦å®‰è£… Drizzleï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
bun add drizzle-orm drizzle-typebox
```

ç„¶åä½ éœ€è¦å›ºå®š `@sinclair/typebox` çš„ç‰ˆæœ¬ï¼Œå› ä¸º `drizzle-typebox` å’Œ `Elysia` ä¹‹é—´å¯èƒ½å­˜åœ¨ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´çš„ç¬¦å·å†²çªã€‚

æˆ‘ä»¬å»ºè®®ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å›ºå®š `@sinclair/typebox` çš„ç‰ˆæœ¬ä¸º `elysia` ä½¿ç”¨çš„ **æœ€ä½ç‰ˆæœ¬**ï¼š

```bash
grep "@sinclair/typebox" node_modules/elysia/package.json
```

æˆ‘ä»¬å¯ä»¥åœ¨ `package.json` ä¸­ä½¿ç”¨ `overrides` å­—æ®µæ¥å›ºå®š `@sinclair/typebox` çš„ç‰ˆæœ¬ï¼š

```json
{
  "overrides": {
  	"@sinclair/typebox": "0.32.4"
  }
}
```

## Drizzle æ¨¡å¼

å‡è®¾æˆ‘ä»¬åœ¨ä»£ç åº“ä¸­æœ‰ä¸€ä¸ª `user` è¡¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

::: code-group

```ts [src/database/schema.ts]
import {
    pgTable,
    varchar,
    timestamp
} from 'drizzle-orm/pg-core'

import { createId } from '@paralleldrive/cuid2'

export const user = pgTable(
    'user',
    {
        id: varchar('id')
            .$defaultFn(() => createId())
            .primaryKey(),
        username: varchar('username').notNull().unique(),
        password: varchar('password').notNull(),
        email: varchar('email').notNull().unique(),
        salt: varchar('salt', { length: 64 }).notNull(),
        createdAt: timestamp('created_at').defaultNow().notNull(),
    }
)

export const table = {
	user
} as const

export type Table = typeof table
```

:::

## drizzle-typebox

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `drizzle-typebox` å°† `user` è¡¨è½¬æ¢ä¸º TypeBox æ¨¡å‹ï¼š

::: code-group

```ts [src/index.ts]
import { t } from 'elysia'
import { createInsertSchema } from 'drizzle-typebox'
import { table } from './database/schema'

const _createUser = createInsertSchema(table.user, {
	// ä½¿ç”¨ Elysia çš„ email ç±»å‹æ›¿æ¢ç”µå­é‚®ä»¶
	email: t.String({ format: 'email' })
})

new Elysia()
	.post('/sign-up', ({ body }) => {
		// åˆ›å»ºæ–°ç”¨æˆ·
	}, {
		body: t.Omit(
			_createUser,
			['id', 'salt', 'createdAt']
		)
	})
```

:::

è¿™ä½¿æˆ‘ä»¬å¯ä»¥åœ¨ Elysia éªŒè¯æ¨¡å‹ä¸­é‡å¤ä½¿ç”¨æ•°æ®åº“æ¨¡å¼ã€‚

## ç±»å‹å®ä¾‹åŒ–å¯èƒ½æ˜¯æ— é™çš„

å¦‚æœä½ é‡åˆ°é”™è¯¯ **ç±»å‹å®ä¾‹åŒ–å¯èƒ½æ˜¯æ— é™çš„**ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸º `drizzle-typebox` å’Œ `Elysia` ä¹‹é—´å­˜åœ¨å¾ªç¯å¼•ç”¨ã€‚

å¦‚æœæˆ‘ä»¬å°†æ¥è‡ª drizzle-typebox çš„ç±»å‹åµŒå¥—åˆ° Elysia æ¨¡å¼ä¸­ï¼Œå®ƒå°†å¯¼è‡´ç±»å‹å®ä¾‹åŒ–çš„æ— é™å¾ªç¯ã€‚

ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦ **åœ¨ `drizzle-typebox` å’Œ `Elysia` æ¨¡å¼ä¹‹é—´æ˜¾å¼å®šä¹‰ä¸€ä¸ªç±»å‹**ï¼š

```ts
import { t } from 'elysia'
import { createInsertSchema } from 'drizzle-typebox'

import { table } from './database/schema'

const _createUser = createInsertSchema(table.user, {
	email: t.String({ format: 'email' })
})

// âœ… è¿™æ ·åšæœ‰æ•ˆï¼Œé€šè¿‡å¼•ç”¨æ¥è‡ª `drizzle-typebox` çš„ç±»å‹
const createUser = t.Omit(
	_createUser,
	['id', 'salt', 'createdAt']
)

// âŒ è¿™æ ·åšä¼šå¯¼è‡´ç±»å‹å®ä¾‹åŒ–çš„æ— é™å¾ªç¯
const createUser = t.Omit(
	createInsertSchema(table.user, {
		email: t.String({ format: 'email' })
	}),
	['id', 'salt', 'createdAt']
)
```

å¦‚æœä½ æƒ³ä½¿ç”¨ Elysia ç±»å‹ï¼Œå§‹ç»ˆä¸º `drizzle-typebox` å£°æ˜ä¸€ä¸ªå˜é‡å¹¶å¼•ç”¨å®ƒã€‚

## å®ç”¨å·¥å…·

ç”±äºæˆ‘ä»¬å¾ˆå¯èƒ½ä¼šä½¿ç”¨ `t.Pick` å’Œ `t.Omit` æ¥æ’é™¤æˆ–åŒ…æ‹¬æŸäº›å­—æ®µï¼Œé‡å¤è¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šå¾ˆç¹çï¼š

æˆ‘ä»¬å»ºè®®ä½¿ç”¨ä»¥ä¸‹å®ç”¨å‡½æ•° **ï¼ˆæŒ‰åŸæ ·å¤åˆ¶ï¼‰** æ¥ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼š

::: code-group

```ts [src/database/utils.ts]
/**
 * @lastModified 2025-02-04
 * @see https://elysiajs.com/recipe/drizzle.html#utility
 */

import { Kind, type TObject } from '@sinclair/typebox'
import {
    createInsertSchema,
    createSelectSchema,
    BuildSchema,
} from 'drizzle-typebox'

import { table } from './schema'
import type { Table } from 'drizzle-orm'

type Spread<
    T extends TObject | Table,
    Mode extends 'select' | 'insert' | undefined,
> =
    T extends TObject<infer Fields>
        ? {
              [K in keyof Fields]: Fields[K]
          }
        : T extends Table
          ? Mode extends 'select'
              ? BuildSchema<
                    'select',
                    T['_']['columns'],
                    undefined
                >['properties']
              : Mode extends 'insert'
                ? BuildSchema<
                      'insert',
                      T['_']['columns'],
                      undefined
                  >['properties']
                : {}
          : {}

/**
 * å°† Drizzle æ¨¡å¼å±•å¼€ä¸ºä¸€ä¸ªæ™®é€šå¯¹è±¡
 */
export const spread = <
    T extends TObject | Table,
    Mode extends 'select' | 'insert' | undefined,
>(
    schema: T,
    mode?: Mode,
): Spread<T, Mode> => {
    const newSchema: Record<string, unknown> = {}
    let table

    switch (mode) {
        case 'insert':
        case 'select':
            if (Kind in schema) {
                table = schema
                break
            }

            table =
                mode === 'insert'
                    ? createInsertSchema(schema)
                    : createSelectSchema(schema)

            break

        default:
            if (!(Kind in schema)) throw new Error('æœŸæœ›æ˜¯ä¸€ä¸ªæ¨¡å¼')
            table = schema
    }

    for (const key of Object.keys(table.properties))
        newSchema[key] = table.properties[key]

    return newSchema as any
}

/**
 * å°† Drizzle è¡¨å±•å¼€ä¸ºä¸€ä¸ªæ™®é€šå¯¹è±¡
 *
 * å¦‚æœ `mode` æ˜¯ 'insert'ï¼Œåˆ™æ¨¡å¼å°†ç»è¿‡æ’å…¥ä¼˜åŒ–
 * å¦‚æœ `mode` æ˜¯ 'select'ï¼Œåˆ™æ¨¡å¼å°†ç»è¿‡é€‰æ‹©ä¼˜åŒ–
 * å¦‚æœ `mode` æ˜¯æœªå®šä¹‰ï¼Œæ¨¡å¼å°†æŒ‰åŸæ ·å±•å¼€ï¼Œæ¨¡å‹éœ€è¦æ‰‹åŠ¨ä¼˜åŒ–
 */
export const spreads = <
    T extends Record<string, TObject | Table>,
    Mode extends 'select' | 'insert' | undefined,
>(
    models: T,
    mode?: Mode,
): {
    [K in keyof T]: Spread<T[K], Mode>
} => {
    const newSchema: Record<string, unknown> = {}
    const keys = Object.keys(models)

    for (const key of keys) newSchema[key] = spread(models[key], mode)

    return newSchema as any
}
```

:::

è¿™ä¸ªå®ç”¨å‡½æ•°å°†æŠŠ Drizzle æ¨¡å¼è½¬æ¢ä¸ºä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡å±æ€§åç§°ä½œä¸ºæ™®é€šå¯¹è±¡è¿›è¡Œé€‰æ‹©ï¼š

```ts
// âœ… ä½¿ç”¨å±•å¼€å®ç”¨å‡½æ•°
const user = spread(table.user, 'insert')

const createUser = t.Object({
	id: user.id, // { type: 'string' }
	username: user.username, // { type: 'string' }
	password: user.password // { type: 'string' }
})

// âš ï¸ ä½¿ç”¨ t.Pick
const _createUser = createInsertSchema(table.user)

const createUser = t.Pick(
	_createUser,
	['id', 'username', 'password']
)
```

### è¡¨å•ä¾‹

æˆ‘ä»¬å»ºè®®ä½¿ç”¨å•ä¾‹æ¨¡å¼æ¥å­˜å‚¨è¡¨æ¨¡å¼ï¼Œè¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä»£ç åº“çš„ä»»ä½•åœ°æ–¹è®¿é—®è¡¨æ¨¡å¼ï¼š

::: code-group

```ts [src/database/model.ts]
import { table } from './schema'
import { spreads } from './utils'

export const db = {
	insert: spreads({
		user: table.user,
	}, 'insert'),
	select: spreads({
		user: table.user,
	}, 'select')
} as const
```

:::

è¿™æ ·æˆ‘ä»¬å°±èƒ½åœ¨ä»£ç åº“çš„ä»»ä½•åœ°æ–¹è®¿é—®è¡¨æ¨¡å¼ï¼š

::: code-group

```ts [src/index.ts]
import { Elysia, t } from 'elysia'
import { db } from './database/model'

const { user } = db.insert

new Elysia()
	.post('/sign-up', ({ body }) => {
		// åˆ›å»ºæ–°ç”¨æˆ·
	}, {
		body: t.Object({
			id: user.username,
			username: user.username,
			password: user.password
		})
	})
```

:::

### ç²¾ç»†åŒ–

å¦‚æœéœ€è¦ç±»å‹ç²¾ç»†åŒ–ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ `createInsertSchema` å’Œ `createSelectSchema` æ¥ç²¾ç»†åŒ–æ¨¡å¼ã€‚

::: code-group

```ts [src/database/model.ts]
import { t } from 'elysia'
import { createInsertSchema, createSelectSchema } from 'drizzle-typebox'

import { table } from './schema'
import { spreads } from './utils'

export const db = {
	insert: spreads({
		user: createInsertSchema(table.user, {
			email: t.String({ format: 'email' })
		}),
	}, 'insert'),
	select: spreads({
		user: createSelectSchema(table.user, {
			email: t.String({ format: 'email' })
		})
	}, 'select')
} as const
```

:::

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç²¾ç»†åŒ–äº† `user.email` æ¨¡å¼ä»¥åŒ…æ‹¬ä¸€ä¸ª `format` å±æ€§ã€‚

`spread` å®ç”¨å‡½æ•°å°†è·³è¿‡ä¼˜åŒ–çš„æ¨¡å¼ï¼Œå› æ­¤ä½ å¯ä»¥æŒ‰åŸæ ·ä½¿ç”¨å®ƒã€‚

***

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ [Drizzle ORM](https://orm.drizzle.team) å’Œ [Drizzle TypeBox](https://orm.drizzle.team/docs/typebox) æ–‡æ¡£ã€‚

---

---
url: 'https://elysiajs.com/integrations/expo.md'
---

# ä¸ Expo é›†æˆ

ä» Expo SDK 50 å’Œ App Router v3 å¼€å§‹ï¼ŒExpo å…è®¸æˆ‘ä»¬ç›´æ¥åœ¨ Expo åº”ç”¨ä¸­åˆ›å»º API è·¯ç”±ã€‚

1. åˆ›å»º **app/\[...slugs]+api.ts**
2. å®šä¹‰ä¸€ä¸ª Elysia æœåŠ¡å™¨
3. å¯¼å‡ºæ‚¨æƒ³è¦ä½¿ç”¨çš„ HTTP æ–¹æ³•åçš„ **Elysia.fetch**

::: code-group

```typescript [app/[...slugs]+api.ts]
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .get('/', 'hello Expo')
    .post('/', ({ body }) => body, {
        body: t.Object({
            name: t.String()
        })
    })

export const GET = app.fetch // [!code ++]
export const POST = app.fetch // [!code ++]
```

:::
Elysia å°†æ­£å¸¸è¿è¡Œï¼Œå› ä¸ºå¾—ç›Šäº WinterCG çš„å…¼å®¹æ€§ï¼Œç„¶è€Œï¼ŒæŸäº›æ’ä»¶å¦‚ **Elysia Static** å¯èƒ½åœ¨æ‚¨åœ¨ Node ä¸Šè¿è¡Œ Expo æ—¶æ— æ³•æ­£å¸¸å·¥ä½œã€‚

æ‚¨å¯ä»¥åƒå¯¹å¾…æ™®é€šçš„ Expo API è·¯ç”±é‚£æ ·å¯¹å¾… Elysia æœåŠ¡å™¨ã€‚

### pnpm

å¦‚æœæ‚¨ä½¿ç”¨ pnpmï¼Œ[pnpm é»˜è®¤ä¸è‡ªåŠ¨å®‰è£… peer dependencies](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230)ï¼Œè¿™ä¼šè¿«ä½¿æ‚¨æ‰‹åŠ¨å®‰è£…é¢å¤–çš„ä¾èµ–é¡¹ã€‚

```bash
pnpm add @sinclair/typebox openapi-types
```

## å‰ç¼€

å¦‚æœæ‚¨å°† Elysia æœåŠ¡å™¨æ”¾ç½®åœ¨åº”ç”¨è·¯ç”±çš„æ ¹ç›®å½•ä¹‹å¤–ï¼Œæ‚¨éœ€è¦ä¸º Elysia æœåŠ¡å™¨æ³¨é‡Šå‰ç¼€ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ [API è·¯ç”±](https://docs.expo.dev/router/reference/api-routes/)ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°† Elysia æœåŠ¡å™¨æ”¾åœ¨ **app/api/\[...slugs]+api.ts** ä¸­ï¼Œæ‚¨éœ€è¦å°†å‰ç¼€æ³¨é‡Šä¸º **/api**ã€‚

::: code-group

```typescript [app/api/[...slugs]+api.ts]
import { Elysia, t } from 'elysia'

const app = new Elysia({ prefix: '/api' }) // [!code ++]
    .get('/', 'Hello Expo')
    .post('/', ({ body }) => body, {
        body: t.Object({
            name: t.String()
        })
    })

export const GET = app.fetch
export const POST = app.fetch
```

:::

è¿™æ ·å¯ä»¥ç¡®ä¿æ— è®ºæ‚¨å°†å…¶æ”¾ç½®åœ¨ä½•å¤„ï¼ŒElysia è·¯ç”±éƒ½ä¼šæ­£å¸¸å·¥ä½œã€‚

## Eden

æˆ‘ä»¬å¯ä»¥æ·»åŠ  [Eden](/eden/overview) å®ç°ç±»ä¼¼ tRPC çš„**ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨**ã€‚

1. ä» Elysia æœåŠ¡å™¨å¯¼å‡º `type`

::: code-group

```typescript [app/[...slugs]+api.ts]
import { Elysia } from 'elysia'

const app = new Elysia()
	.get('/', 'Hello Nextjs')
	.post(
		'/user',
		({ body }) => body,
		{
			body: treaty.schema('User', {
				name: 'string'
			})
		}
	)

export type app = typeof app // [!code ++]

export const GET = app.fetch
export const POST = app.fetch
```

:::

2. åˆ›å»º Treaty å®¢æˆ·ç«¯

::: code-group

```typescript [lib/eden.ts]
import { treaty } from '@elysiajs/eden'
import type { app } from '../app/[...slugs]+api'

export const api = treaty<app>('localhost:3000/api')
```

:::

3. åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç»„ä»¶ä¸­ä½¿ç”¨è¯¥å®¢æˆ·ç«¯

::: code-group

```tsx [app/page.tsx]
import { api } from '../lib/eden'

export default async function Page() {
	const message = await api.get()

	return <h1>Hello, {message}</h1>
}
```

:::

## éƒ¨ç½²

æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ Elysia çš„ API è·¯ç”±ï¼Œæ ¹æ®éœ€è¦éƒ¨ç½²ä¸ºæ­£å¸¸çš„ Elysia åº”ç”¨ï¼Œæˆ–ä½¿ç”¨ [å®éªŒæ€§çš„ Expo æœåŠ¡å™¨è¿è¡Œæ—¶](https://docs.expo.dev/router/reference/api-routes/#deployment)ã€‚

å¦‚æœæ‚¨ä½¿ç”¨ Expo æœåŠ¡å™¨è¿è¡Œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `expo export` å‘½ä»¤ä¸ºæ‚¨çš„ Expo åº”ç”¨åˆ›å»ºä¼˜åŒ–æ„å»ºï¼Œè¿™å°†åŒ…æ‹¬ä¸€ä¸ªä½¿ç”¨ Elysia çš„ Expo å‡½æ•°ï¼Œä½äº **dist/server/\_expo/functions/\[...slugs]+api.js**

::: tip
è¯·æ³¨æ„ï¼ŒExpo å‡½æ•°è¢«è§†ä¸ºè¾¹ç¼˜å‡½æ•°ï¼Œè€Œä¸æ˜¯æ™®é€šæœåŠ¡å™¨ï¼Œå› æ­¤ç›´æ¥è¿è¡Œè¾¹ç¼˜å‡½æ•°ä¸ä¼šåˆ†é…ä»»ä½•ç«¯å£ã€‚
:::

æ‚¨å¯ä»¥ä½¿ç”¨ Expo æä¾›çš„ Expo å‡½æ•°é€‚é…å™¨æ¥éƒ¨ç½²æ‚¨çš„è¾¹ç¼˜å‡½æ•°ã€‚

ç›®å‰ Expo æ”¯æŒä»¥ä¸‹é€‚é…å™¨ï¼š

* [Express](https://docs.expo.dev/router/reference/api-routes/#express)
* [Netlify](https://docs.expo.dev/router/reference/api-routes/#netlify)
* [Vercel](https://docs.expo.dev/router/reference/api-routes/#vercel)

---

---
url: 'https://elysiajs.com/integrations/netlify.md'
---

# ä¸ Netlify Edge Function é›†æˆ

[Netlify Edge Function](https://docs.netlify.com/build/edge-functions/overview/) è¿è¡Œåœ¨ [Deno](/integrations/deno) ç¯å¢ƒä¸Šï¼ŒDeno æ˜¯ Elysia æ”¯æŒçš„è¿è¡Œæ—¶ä¹‹ä¸€ï¼Œå› ä¸º Elysia æ˜¯å»ºç«‹åœ¨ Web æ ‡å‡†ä¹‹ä¸Šã€‚

Netlify Edge Functions éœ€è¦ä¸€ä¸ªç‰¹å®šçš„ç›®å½•æ¥è¿è¡Œå‡½æ•°ï¼Œé»˜è®¤ç›®å½•æ˜¯ **\<directory>/netlify/edge-functions**ã€‚

å¦‚æœè¦åˆ›å»ºä¸€ä¸ªè·¯å¾„ä¸º **/hello** çš„å‡½æ•°ï¼Œéœ€è¦åœ¨ `netlify/edge-functions/hello.ts` æ–‡ä»¶ä¸­åˆ›å»ºï¼Œç„¶åç›´æ¥ `export default` ä¸€ä¸ª Elysia å®ä¾‹ã€‚

::: code-group

```typescript [netlify/edge-functions/hello.ts]
import { Elysia } from 'elysia'

export const config = { path: '/hello' } // [!code ++]

export default new Elysia({ prefix: '/hello' }) // [!code ++]
	.get('/', () => 'Hello Elysia')
```

:::

### æœ¬åœ°è¿è¡Œ

è¦åœ¨æœ¬åœ°æµ‹è¯• Netlify Edge Function ä¸Šçš„ Elysia æœåŠ¡å™¨ï¼Œå¯ä»¥å®‰è£… [Netlify CLI](https://docs.netlify.com/build/edge-functions/get-started/#test-locally) æ¥æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨ã€‚

å®‰è£… Netlify CLIï¼š

```bash
bun add -g netlify-cli
```

å¯åŠ¨å¼€å‘ç¯å¢ƒï¼š

```bash
netlify dev
```

æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ [Netlify Edge Function æ–‡æ¡£](https://docs.netlify.com/build/edge-functions)ã€‚

### pnpm

å¦‚æœä½ ä½¿ç”¨ pnpmï¼Œ[pnpm é»˜è®¤ä¸è‡ªåŠ¨å®‰è£… peer ä¾èµ–](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230)ï¼Œéœ€è¦ä½ æ‰‹åŠ¨å®‰è£…é¢å¤–çš„ä¾èµ–ã€‚

```bash
pnpm add @sinclair/typebox openapi-types
```

---

---
url: 'https://elysiajs.com/integrations/nextjs.md'
---

# ä¸ Nextjs é›†æˆ

ä½¿ç”¨ Nextjs åº”ç”¨è·¯ç”±ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Nextjs è·¯ç”±ä¸Šè¿è¡Œ Elysiaã€‚

1. åœ¨åº”ç”¨è·¯ç”±ä¸­åˆ›å»º **api/\[\[...slugs]]/route.ts**
2. åœ¨ **route.ts** ä¸­åˆ›å»ºæˆ–å¯¼å…¥ä¸€ä¸ªç°æœ‰çš„ Elysia æœåŠ¡å™¨
3. å¯¼å‡ºæ‚¨æƒ³è¦ä¸ `Elysia.fetch` ä¸€èµ·ä½¿ç”¨çš„ HTTP æ–¹æ³•

::: code-group

```typescript [app/api/[[...slugs]]/route.ts]
import { Elysia, t } from 'elysia'

const app = new Elysia({ prefix: '/api' })
    .get('/', 'Hello Nextjs')
    .post('/', ({ body }) => body, {
        body: t.Object({
            name: t.String()
        })
    })

export const GET = app.fetch // [!code ++]
export const POST = app.fetch // [!code ++]
```

:::

Elysia å°†æ­£å¸¸å·¥ä½œï¼Œå› ä¸ºå®ƒç¬¦åˆ WinterCG è§„èŒƒï¼Œä½†å¦‚æœæ‚¨åœ¨ Node ç¯å¢ƒä¸‹è¿è¡Œ Nextjsï¼ŒæŸäº›æ’ä»¶ï¼ˆå¦‚ **Elysia Static**ï¼‰å¯èƒ½ä¸ä¼šæ­£å¸¸å·¥ä½œã€‚

æ‚¨å¯ä»¥å°† Elysia æœåŠ¡å™¨è§†ä¸ºä¸€ä¸ªæ™®é€šçš„ Nextjs API è·¯ç”±ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ‚¨å¯ä»¥åœ¨ä¸€ä¸ªä»£ç åº“ä¸­å°†å‰ç«¯å’Œåç«¯å…±åŒæ”¾ç½®ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŠ¨ä½œä¸­æ‹¥æœ‰ [Eden çš„ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨](https://elysiajs.com/eden/overview.html)ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [Nextjs è·¯ç”±å¤„ç†ç¨‹åº](https://nextjs.org/docs/app/building-your-application/routing/route-handlers#static-route-handlers)ã€‚

### pnpm

å¦‚æœæ‚¨ä½¿ç”¨ pnpmï¼Œ[pnpm é»˜è®¤ä¸ä¼šè‡ªåŠ¨å®‰è£… peer ä¾èµ–](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230)ï¼Œéœ€è¦æ‚¨æ‰‹åŠ¨å®‰è£…é¢å¤–ä¾èµ–ã€‚

```bash
pnpm add @sinclair/typebox openapi-types
```

## å‰ç¼€

å› ä¸ºæˆ‘ä»¬çš„ Elysia æœåŠ¡å™¨ä¸åœ¨åº”ç”¨è·¯ç”±çš„æ ¹ç›®å½•ä¸‹ï¼Œæ‰€ä»¥æ‚¨éœ€è¦ä¸º Elysia æœåŠ¡å™¨æ³¨é‡Šå‰ç¼€ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°† Elysia æœåŠ¡å™¨æ”¾åœ¨ **app/user/\[\[...slugs]]/route.ts** ä¸­ï¼Œåˆ™éœ€è¦å°†å‰ç¼€æ³¨é‡Šä¸º **/user**ã€‚

::: code-group

```typescript [app/user/[[...slugs]]/route.ts]
import { Elysia, t } from 'elysia'

const app = new Elysia({ prefix: '/user' }) // [!code ++]
	.get('/', 'Hello Nextjs')
    .post('/', ({ body }) => body, {
        body: t.Object({
            name: t.String()
        })
    })

export const GET = app.fetch
export const POST = app.fetch
```

:::

è¿™å°†ç¡®ä¿ Elysia è·¯ç”±èƒ½å¤Ÿåœ¨æ‚¨æ”¾ç½®å®ƒçš„ä»»ä½•ä½ç½®æ­£å¸¸å·¥ä½œã€‚

## Eden

æˆ‘ä»¬å¯ä»¥æ·»åŠ  [Eden](/eden/overview) æ¥å®ç°ç±»ä¼¼ tRPC çš„**ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨**ã€‚

1. ä» Elysia æœåŠ¡å™¨å¯¼å‡º `type`

::: code-group

```typescript [app/api/[[...slugs]]/route.ts]
import { Elysia } from 'elysia'

export const app = new Elysia({ prefix: '/api' }) // [!code ++]
	.get('/', 'Hello Nextjs')
	.post(
		'/user',
		({ body }) => body,
		{
			body: treaty.schema('User', {
				name: 'string'
			})
		}
	)

export const GET = app.fetch
export const POST = app.fetch
```

:::

2. åˆ›å»º Treaty å®¢æˆ·ç«¯

::: code-group

```typescript [lib/eden.ts]
import { treaty } from '@elysiajs/eden'
import type { app } from '../app/api/[[...slugs]]/route'

// .api ç”¨ä»¥è¿›å…¥ /api å‰ç¼€
export const api =
  // process is defined on server side and build time
  typeof process !== 'undefined'
    ? treaty(app).api
    : treaty<typeof app>('localhost:3000').api
```

ä½ åº”è¯¥ä½¿ç”¨ `typeof process` è€Œä¸æ˜¯ `typeof window`ï¼Œå› ä¸ºåœ¨æ„å»ºæ—¶ `window` æœªè¢«å®šä¹‰ï¼Œä¼šå¯¼è‡´æ°´åˆé”™è¯¯ã€‚

:::

3. åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç»„ä»¶ä¸­ä½¿ç”¨è¯¥å®¢æˆ·ç«¯

::: code-group

```tsx [app/page.tsx]
import { api } from '../lib/eden'

export default async function Page() {
	const message = await api.get()

	return <h1>Hello, {message}</h1>
}
```

:::

è¿™ä½¿æ‚¨èƒ½å¤Ÿä»¥æœ€å°‘çš„å·¥ä½œé‡ä»å‰ç«¯åˆ°åç«¯å®ç°ç±»å‹å®‰å…¨ï¼Œå¹¶ä¸”åŒæ—¶æ”¯æŒæœåŠ¡å™¨ç»„ä»¶ã€å®¢æˆ·ç«¯ç»„ä»¶ä»¥åŠå¢é‡é™æ€å†ç”Ÿï¼ˆISRï¼‰ã€‚

## React Query

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ React Query åœ¨å®¢æˆ·ç«¯ä¸ Elysia æœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚

::: code-group

```tsx [src/routes/index.tsx]
import { createFileRoute } from '@tanstack/react-router'
import { useQuery } from '@tanstack/react-query'

import { getTreaty } from './api.$' // [!code ++]

export const Route = createFileRoute('/a')({
	component: App
})

function App() {
	const { data: response } = useQuery({ // [!code ++]
		queryKey: ['get'], // [!code ++]
		queryFn: () => getTreaty().get() // [!code ++]
	}) // [!code ++]

	return response?.data
}
```

::: code-group

è¿™å¯ä»¥ä¸ä»»ä½• React Query åŠŸèƒ½ä¸€èµ·ä½¿ç”¨ï¼Œæ¯”å¦‚ç¼“å­˜ã€åˆ†é¡µã€æ— é™æŸ¥è¯¢ç­‰ã€‚

***

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [Next.js è·¯ç”±å¤„ç†ç¨‹åº](https://nextjs.org/docs/app/building-your-application/routing/route-handlers#static-route-handlers)ã€‚

---

---
url: 'https://elysiajs.com/integrations/node.md'
---

# ä¸ Node.js é›†æˆ

Elysia æä¾›äº†è¿è¡Œæ—¶é€‚é…å™¨ï¼Œå¯åœ¨å¤šä¸ªè¿è¡Œæ—¶ç¯å¢ƒä¸­è¿è¡Œ Elysiaï¼ŒåŒ…æ‹¬ Node.jsã€‚

è¦åœ¨ Node.js ä¸Šè¿è¡Œ Elysiaï¼Œåªéœ€å®‰è£… Node é€‚é…å™¨ã€‚

::: code-group

```bash [bun]
bun add elysia @elysiajs/node
```

```bash [pnpm]
pnpm add elysia @elysiajs/node
```

```bash [npm]
npm install elysia @elysiajs/node
```

```bash [yarn]
yarn add elysia @elysiajs/node
```

:::

ç„¶åå°† node é€‚é…å™¨åº”ç”¨åˆ°ä½ çš„ä¸» Elysia å®ä¾‹ä¸­ã€‚

```typescript
import { Elysia } from 'elysia'
import { node } from '@elysiajs/node' // [!code ++]

const app = new Elysia({ adapter: node() }) // [!code ++]
	.get('/', () => 'Hello Elysia')
	.listen(3000)
```

è¿™å°±æ˜¯ä½ è¿è¡Œ Elysia äº Node.js æ‰€éœ€çš„ä¸€åˆ‡ã€‚

### é¢å¤–è®¾ç½®ï¼ˆå¯é€‰ï¼‰

ä¸ºäº†è·å¾—æœ€ä½³ä½“éªŒï¼Œæˆ‘ä»¬å»ºè®®å®‰è£… `tsx` æˆ– `ts-node` ä»¥åŠ `nodemon`ã€‚

`tsx` æ˜¯ä¸€ä¸ª CLI å·¥å…·ï¼Œå®ƒèƒ½å°† TypeScript è½¬è¯‘ä¸º JavaScriptï¼Œæ”¯æŒçƒ­é‡è½½ä»¥åŠä½ æœŸæœ›ç°ä»£å¼€å‘ç¯å¢ƒå…·å¤‡çš„è¯¸å¤šåŠŸèƒ½ã€‚

::: code-group

```bash [bun]
bun add -d tsx @types/node typescript
```

```bash [pnpm]
pnpm add -D tsx @types/node typescript
```

```bash [npm]
npm install --save-dev tsx @types/node typescript
```

```bash [yarn]
yarn add -D tsx @types/node typescript
```

:::

ç„¶åæ‰“å¼€ä½ çš„ `package.json` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹è„šæœ¬ï¼š

```json
{
   	"scripts": {
  		"dev": "tsx watch src/index.ts",
    	"build": "tsc src/index.ts --outDir dist",
  		"start": "NODE_ENV=production node dist/index.js"
   	}
}
```

è¿™äº›è„šæœ¬æŒ‡ä»£å¼€å‘åº”ç”¨çš„ä¸åŒé˜¶æ®µï¼š

* **dev** - åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯åŠ¨ Elysiaï¼Œå¹¶åœ¨ä»£ç æ›´æ”¹æ—¶è‡ªåŠ¨é‡è½½ã€‚
* **build** - æ„å»ºåº”ç”¨ä»¥ä¾›ç”Ÿäº§ä½¿ç”¨ã€‚
* **start** - å¯åŠ¨ Elysia ç”Ÿäº§æœåŠ¡å™¨ã€‚

ç¡®ä¿åˆ›å»º `tsconfig.json` æ–‡ä»¶ï¼š

```bash
tsc --init
```

åˆ«å¿˜äº†å°† `tsconfig.json` ä¸­çš„ `compilerOptions.strict` è®¾ç½®ä¸º `true`ï¼š

```json
{
   	"compilerOptions": {
  		"strict": true
   	}
}
```

è¿™å°†ä¸ºä½ æä¾›çƒ­é‡è½½å’Œ JSX æ”¯æŒï¼Œä½¿ä½ ä»¥ç±»ä¼¼äº `bun dev` çš„ä½“éªŒè¿è¡Œ Elysiaã€‚

### pnpm

å¦‚æœä½ ä½¿ç”¨ pnpmï¼Œ[pnpm é»˜è®¤ä¸ä¼šè‡ªåŠ¨å®‰è£… peer ä¾èµ–](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230)ï¼Œè¿™å°±éœ€è¦ä½ æ‰‹åŠ¨å®‰è£…é¢å¤–çš„ä¾èµ–ã€‚

```bash
pnpm add @sinclair/typebox openapi-types
```

---

---
url: 'https://elysiajs.com/integrations/nuxt.md'
---

# ä¸ Nuxt é›†æˆ

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Nuxt çš„ç¤¾åŒºæ’ä»¶ [nuxt-elysia](https://github.com/tkesgar/nuxt-elysia)ï¼Œåˆ©ç”¨ Eden Treaty åœ¨ Nuxt API è·¯ç”±ä¸Šé…ç½® Elysiaã€‚

1. é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…æ’ä»¶ï¼š

```bash
bun add elysia @elysiajs/eden
bun add -d nuxt-elysia
```

2. åœ¨ä½ çš„ Nuxt é…ç½®ä¸­æ·»åŠ  `nuxt-elysia`ï¼š

```ts
export default defineNuxtConfig({
    modules: [ // [!code ++]
        'nuxt-elysia' // [!code ++]
    ] // [!code ++]
})
```

3. åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `api.ts`ï¼š

```typescript [api.ts]
export default () => new Elysia() // [!code ++]
  .get('/hello', () => ({ message: 'Hello world!' })) // [!code ++]
```

4. åœ¨ä½ çš„ Nuxt åº”ç”¨ä¸­ä½¿ç”¨ Eden Treatyï¼š

```vue
<template>
    <div>
        <p>{{ data.message }}</p>
    </div>
</template>
<script setup lang="ts">
const { $api } = useNuxtApp()

const { data } = await useAsyncData(async () => {
    const { data, error } = await $api.hello.get()

    if (error)
        throw new Error('è°ƒç”¨ API å¤±è´¥')

    return data
})
</script>
```

è¿™å°†è‡ªåŠ¨åœ¨ Nuxt API è·¯ç”±ä¸Šé…ç½®å¹¶è¿è¡Œ Elysiaã€‚

### pnpm

å¦‚æœä½ ä½¿ç”¨ pnpmï¼Œ[pnpm é»˜è®¤ä¸è‡ªåŠ¨å®‰è£… peer ä¾èµ–](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230)ï¼Œä½ éœ€è¦æ‰‹åŠ¨å®‰è£…é¢å¤–ä¾èµ–ã€‚

```bash
pnpm add @sinclair/typebox openapi-types
```

## å‰ç¼€

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia å°†æŒ‚è½½åœ¨ **/\_api**ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡ `nuxt-elysia` é…ç½®è¿›è¡Œè‡ªå®šä¹‰ã€‚

```ts
export default defineNuxtConfig({
	nuxtElysia: {
		path: '/api' // [!code ++]
	}
})
```

è¿™ä¼šå°† Elysia æŒ‚è½½åˆ° **/api**ï¼Œè€Œé **/\_api**ã€‚

æ›´å¤šé…ç½®è¯·å‚è€ƒ [nuxt-elysia](https://github.com/tkesgar/nuxt-elysia)

---

---
url: 'https://elysiajs.com/integrations/prisma.md'
---

# Prisma

[Prisma](https://prisma.io) æ˜¯ä¸€ä¸ª ORMï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿä»¥ç±»å‹å®‰å…¨çš„æ–¹å¼ä¸æ•°æ®åº“äº¤äº’ã€‚

å®ƒæä¾›äº†ä¸€ç§ä½¿ç”¨ Prisma æ¶æ„æ–‡ä»¶å®šä¹‰æ•°æ®åº“æ¨¡å¼çš„æ–¹æ³•ï¼Œç„¶ååŸºäºè¯¥æ¨¡å¼ç”Ÿæˆ TypeScript ç±»å‹ã€‚

### Prismabox

[Prismabox](https://github.com/m1212e/prismabox) æ˜¯ä¸€ä¸ªåº“ï¼Œå¯ä» Prisma æ¨¡å¼ç”Ÿæˆ TypeBox æˆ– Elysia éªŒè¯æ¨¡å‹ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Prismabox å°† Prisma æ¨¡å¼è½¬æ¢ä¸º Elysia éªŒè¯æ¨¡å‹ï¼Œç„¶åç”¨æ¥ç¡®ä¿ Elysia ä¸­çš„ç±»å‹éªŒè¯ã€‚

### å·¥ä½œåŸç†ï¼š

1. åœ¨ Prisma æ¨¡å¼ä¸­å®šä¹‰æ•°æ®åº“æ¶æ„ã€‚
2. æ·»åŠ  `prismabox` ç”Ÿæˆå™¨ä»¥ç”Ÿæˆ Elysia æ¨¡å¼ã€‚
3. ä½¿ç”¨è½¬æ¢åçš„ Elysia éªŒè¯æ¨¡å‹ç¡®ä¿ç±»å‹éªŒè¯ã€‚
4. ä» Elysia éªŒè¯æ¨¡å‹ç”Ÿæˆ OpenAPI æ¨¡å¼ã€‚
5. æ·»åŠ  [Eden Treaty](/eden/overview) ä»¥ä¸ºå‰ç«¯æ·»åŠ ç±»å‹å®‰å…¨ã€‚

```
                                                    * â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” *
                                                    |                 |
                                               | -> |  æ–‡æ¡£          |
* â€”â€”â€”â€”â€”â€”â€”â€”â€” *             * â€”â€”â€”â€”â€”â€”â€”â€” * OpenAPI |    |                 |
|           |  prismabox  |          | â€”â€”â€”â€”â€”â€”â€” |    * â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” *
|  Prisma   | â€”â€”â€”â€”â€”â€”â€”â€”â€”-> |  Elysia  |
|           |             |          | â€”â€”â€”â€”â€”â€”â€” |    * â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” *
* â€”â€”â€”â€”â€”â€”â€”â€”â€” *             * â€”â€”â€”â€”â€”â€”â€”â€” *   Eden  |    |                 |
                                               | -> |  å‰ç«¯ä»£ç       |
												    |                 |
												    * â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” *

```

## å®‰è£…

å®‰è£… Prismaï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
bun add @prisma/client prismabox && \
bun add -d prisma
```

## Prisma æ¨¡å¼

å‡è®¾ä½ å·²ç»æœ‰ä¸€ä¸ª `prisma/schema.prisma` æ–‡ä»¶ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨ Prisma æ¨¡å¼æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª `prismabox` ç”Ÿæˆå™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

::: code-group

```ts [prisma/schema.prisma]
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator prismabox { // [!code ++]
  provider = "prismabox" // [!code ++]
  typeboxImportDependencyName = "elysia" // [!code ++]
  typeboxImportVariableName = "t" // [!code ++]
  inputModel = true // [!code ++]
  output   = "../generated/prismabox" // [!code ++]
} // [!code ++]

model User {
  id    String  @id @default(cuid())
  email String  @unique
  name  String?
  posts Post[]
}

model Post {
  id    	String  @id @default(cuid())
  title     String
  content   String?
  published Boolean @default(false)
  author    User    @relation(fields: [authorId], references: [id])
  authorId  String
}
```

:::

è¿™å°†åœ¨ `generated/prismabox` ç›®å½•ç”Ÿæˆ Elysia éªŒè¯æ¨¡å‹ã€‚

æ¯ä¸ªæ¨¡å‹ä¼šæœ‰è‡ªå·±çš„æ–‡ä»¶ï¼Œä¸”æ¨¡å‹åç§°åŸºäº Prisma çš„æ¨¡å‹åç§°ã€‚

ä¾‹å¦‚ï¼š

* `User` æ¨¡å‹å°†ç”Ÿæˆåˆ° `generated/prismabox/User.ts`
* `Post` æ¨¡å‹å°†ç”Ÿæˆåˆ° `generated/prismabox/Post.ts`

## ä½¿ç”¨ç”Ÿæˆçš„æ¨¡å‹

ç„¶åæˆ‘ä»¬å¯ä»¥åœ¨ Elysia åº”ç”¨ä¸­å¯¼å…¥ç”Ÿæˆçš„æ¨¡å‹ï¼š

::: code-group

```ts [src/index.ts]
import { Elysia, t } from 'elysia'

import { PrismaClient } from '../generated/prisma' // [!code ++]
import { UserPlain, UserPlainInputCreate } from '../generated/prismabox/User' // [!code ++]

const prisma = new PrismaClient()

const app = new Elysia()
    .put(
        '/',
        async ({ body }) =>
            prisma.user.create({
                data: body
            }),
        {
            body: UserPlainInputCreate, // [!code ++]
            response: UserPlain // [!code ++]
        }
    )
    .get(
        '/id/:id',
        async ({ params: { id }, status }) => {
            const user = await prisma.user.findUnique({
                where: { id }
            })

            if (!user) return status(404, 'ç”¨æˆ·æœªæ‰¾åˆ°')

            return user
        },
        {
            response: {
                200: UserPlain, // [!code ++]
                404: t.String() // [!code ++]
            }
        }
    )
    .listen(3000)

console.log(
    `ğŸ¦Š Elysia æ­£åœ¨è¿è¡Œäº ${app.server?.hostname}:${app.server?.port}`
)
```

:::

è¿™ä½¿æˆ‘ä»¬å¯ä»¥åœ¨ Elysia éªŒè¯æ¨¡å‹ä¸­å¤ç”¨æ•°æ®åº“æ¶æ„ã€‚

***

æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [Prisma](https://prisma.io) å’Œ [Prismabox](https://github.com/m1212e/prismabox) æ–‡æ¡£ã€‚

---

---
url: 'https://elysiajs.com/integrations/sveltekit.md'
---

# ä¸ SvelteKit çš„é›†æˆ

ä½¿ç”¨ SvelteKitï¼Œæ‚¨å¯ä»¥åœ¨æœåŠ¡å™¨è·¯ç”±ä¸Šè¿è¡Œ Elysiaã€‚

1. åˆ›å»º **src/routes/\[...slugs]/+server.ts**ã€‚
2. åœ¨ **+server.ts** ä¸­åˆ›å»ºæˆ–å¯¼å…¥ä¸€ä¸ªç°æœ‰çš„ Elysia æœåŠ¡å™¨
3. å¯¼å‡ºæ‚¨æƒ³è¦å…¬å¼€çš„æ–¹æ³•çš„å¤„ç†ç¨‹åºï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ `fallback` è®© Elysia å¤„ç†æ‰€æœ‰æ–¹æ³•ã€‚

```typescript
// src/routes/[...slugs]/+server.ts
import { Elysia, t } from 'elysia';

const app = new Elysia()
    .get('/', 'hello SvelteKit')
    .post('/', ({ body }) => body, {
        body: t.Object({
            name: t.String()
        })
    })

interface WithRequest {
	request: Request
}

export const fallback = ({ request }: WithRequest) => app.handle(request) // [!code ++]
```

æ‚¨å¯ä»¥å°† Elysia æœåŠ¡å™¨è§†ä¸ºæ™®é€šçš„ SvelteKit æœåŠ¡å™¨è·¯ç”±ã€‚

é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæ‚¨å¯ä»¥åœ¨å•ä¸ªä»£ç åº“ä¸­å…±åŒå®šä½å‰ç«¯å’Œåç«¯ï¼Œå¹¶ä¸”å¯ä»¥å®ç° [Eden çš„ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨](https://elysiajs.com/eden/overview.html)ï¼Œæ”¯æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„æ“ä½œã€‚

### pnpm

å¦‚æœæ‚¨ä½¿ç”¨ pnpmï¼Œ[pnpm é»˜è®¤ä¸è‡ªåŠ¨å®‰è£… peer ä¾èµ–](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230)ï¼Œè¿™éœ€è¦æ‚¨æ‰‹åŠ¨å®‰è£…é¢å¤–çš„ä¾èµ–ã€‚

```bash
pnpm add @sinclair/typebox openapi-types
```

## å‰ç¼€

å¦‚æœæ‚¨å°† Elysia æœåŠ¡å™¨æ”¾åœ¨åº”ç”¨è·¯ç”±çš„æ ¹ç›®å½•ä»¥å¤–çš„ä½ç½®ï¼Œæ‚¨éœ€è¦ä¸º Elysia æœåŠ¡å™¨æ³¨é‡Šå‰ç¼€ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°† Elysia æœåŠ¡å™¨æ”¾åœ¨ **src/routes/api/\[...slugs]/+server.ts** ä¸­ï¼Œæ‚¨éœ€è¦å°†å‰ç¼€æ³¨é‡Šä¸º **/api**ã€‚

```typescript twoslash
// src/routes/api/[...slugs]/+server.ts
import { Elysia, t } from 'elysia';

const app = new Elysia({ prefix: '/api' }) // [!code ++]
    .get('/', () => 'hi')
    .post('/', ({ body }) => body, {
        body: t.Object({
            name: t.String()
        })
    })

type RequestHandler = (v: { request: Request }) => Response | Promise<Response>

export const fallback: RequestHandler = ({ request }) => app.handle(request)
```

è¿™æ ·å¯ä»¥ç¡®ä¿ Elysia è·¯ç”±åœ¨æ‚¨æ”¾ç½®å®ƒçš„ä»»ä½•ä½ç½®éƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ [SvelteKit è·¯ç”±](https://kit.svelte.dev/docs/routing#server)ã€‚

---

---
url: 'https://elysiajs.com/integrations/tanstack-start.md'
---

# ä¸ Tanstack Start é›†æˆ

Elysia å¯ä»¥è¿è¡Œåœ¨ Tanstack Start æœåŠ¡å™¨è·¯ç”±å†…ã€‚

1. åˆ›å»º **src/routes/api.$.ts**
2. å®šä¹‰ä¸€ä¸ª Elysia æœåŠ¡å™¨
3. åœ¨ **server.handlers** ä¸­å¯¼å‡º Elysia å¤„ç†å™¨

::: code-group

```typescript [src/routes/api.$.ts]
import { Elysia } from 'elysia'

import { createFileRoute } from '@tanstack/react-router'
import { createIsomorphicFn } from '@tanstack/react-start'

const app = new Elysia({
	prefix: '/api' // [!code ++]
}).get('/', 'Hello Elysia!')

const handle = ({ request }: { request: Request }) => app.fetch(request) // [!code ++]

export const Route = createFileRoute('/api/$')({
	server: {
		handlers: {
			GET: handle, // [!code ++]
			POST: handle // [!code ++]
		}
	}
})
```

:::

ç°åœ¨ Elysia åº”è¯¥å·²ç»è¿è¡Œåœ¨ **/api** è·¯å¾„ä¸‹ã€‚

æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦å‘ **server.handlers** æ·»åŠ å…¶ä»– HTTP æ–¹æ³•æ”¯æŒã€‚

### pnpm

If you use pnpm, [pnpm doesn't auto install peer dependencies by default](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230) forcing you to install additional dependencies manually.

```bash
pnpm add @sinclair/typebox openapi-types
```

## Eden

æˆ‘ä»¬å¯ä»¥æ·»åŠ  [Eden](/eden/overview.html) å®ç°ç±»ä¼¼ tRPC çš„**ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨**ã€‚

::: code-group

```typescript [src/routes/api.$.ts]
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden' // [!code ++]

import { createFileRoute } from '@tanstack/react-router'
import { createIsomorphicFn } from '@tanstack/react-start'

const app = new Elysia({
	prefix: '/api'
}).get('/', 'Hello Elysia!')

const handle = ({ request }: { request: Request }) => app.fetch(request)

export const Route = createFileRoute('/api/$')({
	server: {
		handlers: {
			GET: handle,
			POST: handle
		}
	}
})

export const getTreaty = createIsomorphicFn() // [!code ++]
	.server(() => treaty(app).api) // [!code ++]
	.client(() => treaty<typeof app>('localhost:3000').api) // [!code ++]
```

:::

æ³¨æ„æˆ‘ä»¬ä½¿ç”¨ **createIsomorphicFn** åˆ†åˆ«ä¸ºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åˆ›å»ºä¸åŒçš„ Eden Treaty å®ä¾‹ã€‚

1. æœåŠ¡å™¨ç«¯ç›´æ¥è°ƒç”¨ Elysiaï¼Œæ— éœ€ HTTP å¼€é”€ã€‚
2. å®¢æˆ·ç«¯é€šè¿‡ HTTP è°ƒç”¨ Elysia æœåŠ¡å™¨ã€‚

åœ¨ React ç»„ä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `getTreaty` ä»¥ç±»å‹å®‰å…¨çš„æ–¹å¼è°ƒç”¨ Elysia æœåŠ¡å™¨ã€‚

## åŠ è½½å™¨æ•°æ®

Tanstack Start æ”¯æŒ **Loader**ï¼Œç”¨äºåœ¨æ¸²æŸ“ç»„ä»¶å‰è·å–æ•°æ®ã€‚

::: code-group

```tsx [src/routes/index.tsx]
import { createFileRoute } from '@tanstack/react-router'

import { getTreaty } from './api.$' // [!code ++]

export const Route = createFileRoute('/a')({
	component: App,
	loader: () => getTreaty().get().then((res) => res.data) // [!code ++]
})

function App() {
	const data = Route.useLoaderData() // [!code ++]

	return data
}
```

:::

ä½œä¸ºåŠ è½½å™¨è°ƒç”¨ Elysiaï¼Œä¼šåœ¨ SSR æœŸé—´äºæœåŠ¡å™¨ç«¯æ‰§è¡Œï¼Œæ— éœ€ HTTP å¼€é”€ã€‚

Eden Treaty ä¼šä¿è¯æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ç±»å‹å®‰å…¨ã€‚

## React Query

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ React Query åœ¨å®¢æˆ·ç«¯ä¸ Elysia æœåŠ¡å™¨äº¤äº’ã€‚

::: code-group

```tsx [src/routes/index.tsx]
import { createFileRoute } from '@tanstack/react-router'
import { useQuery } from '@tanstack/react-query'

import { getTreaty } from './api.$' // [!code ++]

export const Route = createFileRoute('/a')({
	component: App
})

function App() {
	const { data: response } = useQuery({ // [!code ++]
		queryKey: ['get'], // [!code ++]
		queryFn: () => getTreaty().get() // [!code ++]
	}) // [!code ++]

	return response?.data
}
```

::: code-group

è¿™å¯ä»¥ä¸ React Query çš„ä»»ä½•ç‰¹æ€§é…åˆä½¿ç”¨ï¼Œå¦‚ç¼“å­˜ã€åˆ†é¡µã€æ— é™æŸ¥è¯¢ç­‰ã€‚

***

å¦‚éœ€äº†è§£æ›´å¤šå…³äº Tanstack Start çš„ä¿¡æ¯ï¼Œè¯·è®¿é—® [Tanstack Start æ–‡æ¡£](https://tanstack.com/start)ã€‚

---

---
url: 'https://elysiajs.com/tutorial.md'
---

# æ¬¢è¿æ¥åˆ° Elysia

å¾ˆé«˜å…´æ‚¨èƒ½æ¥åˆ°è¿™é‡Œï¼è¿™ä¸ªæ¸¸ä¹åœºå°†å¸®åŠ©æ‚¨ä»¥äº’åŠ¨çš„æ–¹å¼å¼€å§‹ä½¿ç”¨ Elysiaã€‚

ä¸ä¼ ç»Ÿçš„åç«¯æ¡†æ¶ä¸åŒï¼Œ**Elysia ä¹Ÿå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ**ï¼å°½ç®¡å®ƒä¸æ”¯æŒæ‰€æœ‰åŠŸèƒ½ï¼Œä½†å®ƒæ˜¯å­¦ä¹ å’Œå®éªŒçš„å®Œç¾ç¯å¢ƒã€‚

æ‚¨å¯ä»¥é€šè¿‡ç‚¹å‡»å·¦ä¾§è¾¹æ çš„  æ¥æŸ¥çœ‹ API æ–‡æ¡£ã€‚

## ä»€ä¹ˆæ˜¯ Elysia

Elysia æ˜¯ä¸€ä¸ªä»¥äººä¸ºæœ¬çš„æ¡†æ¶ã€‚

å¥½çš„ï¼Œè®¤çœŸè¯´ï¼ŒElysia æ˜¯ä¸€ä¸ªå…³æ³¨å¼€å‘è€…ä½“éªŒå’Œæ€§èƒ½çš„åç«¯ TypeScript æ¡†æ¶ã€‚

Elysia ä¸å…¶ä»–æ¡†æ¶çš„ä¸åŒä¹‹å¤„åœ¨äºï¼š

1. å…·æœ‰å¯ä¸ Golang ç›¸åª²ç¾çš„å“è¶Šæ€§èƒ½ã€‚
2. æä¾›å“è¶Šçš„ TypeScript æ”¯æŒï¼Œå…·æœ‰ **ç±»å‹å®‰å…¨æ€§**ã€‚
3. ä»åº•å±‚å›´ç»• OpenAPI æ„å»ºã€‚
4. æä¾›åƒ tRPC ä¸€æ ·çš„ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ã€‚
5. ä½¿ç”¨ Web æ ‡å‡†ï¼Œè®©æ‚¨èƒ½å¤Ÿåœ¨ Cloudflare Workersã€Denoã€Bunã€Node.js ç­‰ä»»æ„åœ°æ–¹è¿è¡Œä»£ç ã€‚
6. å½“ç„¶ï¼Œå®ƒæ˜¯ **ä¼˜å…ˆä¸ºäººè®¾è®¡çš„**ã€‚

å°½ç®¡ Elysia æœ‰ä¸€äº›é‡è¦æ¦‚å¿µï¼Œä½†ä¸€æ—¦æŒæ¡ï¼Œè®¸å¤šäººå‘ç°ä¸ä¹‹åˆä½œéå¸¸æ„‰å¿«å’Œç›´è§‚ã€‚

## å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæ¸¸ä¹åœº

æ¸¸ä¹åœºåˆ†ä¸º 3 ä¸ªéƒ¨åˆ†ï¼š

1. å·¦ä¾§æ˜¯æ–‡æ¡£å’Œä»»åŠ¡ï¼ˆæ‚¨æ­£åœ¨é˜…è¯»çš„å†…å®¹ï¼‰ã€‚
2. å³ä¸Šè§’æ˜¯ä»£ç ç¼–è¾‘å™¨ã€‚
3. å³ä¸‹è§’æ˜¯é¢„è§ˆã€è¾“å‡ºå’Œæ§åˆ¶å°ã€‚

## ä»»åŠ¡

ä½œä¸ºç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œè®©æˆ‘ä»¬ä¿®æ”¹ä»£ç ï¼Œä½¿æœåŠ¡å™¨å“åº” `"Hello Elysia!"` è€Œä¸æ˜¯ `"Hello World!"`ã€‚

è¯·éšæ„æŸ¥çœ‹ä»£ç ç¼–è¾‘å™¨å’Œé¢„è§ˆéƒ¨åˆ†ï¼Œä»¥ç†Ÿæ‚‰ç¯å¢ƒã€‚

\<template #answer>

æ‚¨å¯ä»¥é€šè¿‡å°† `.get` æ–¹æ³•ä¸­çš„å†…å®¹ä» `'Hello World!'` æ”¹ä¸º `'Hello Elysia!'` æ¥æ”¹å˜å“åº”ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', 'Hello World!') // [!code --]
	.get('/', 'Hello Elysia!') // [!code ++]
	.listen(3000)
```

è¿™å°†ä½¿ Elysia åœ¨æ‚¨è®¿é—® `/` æ—¶å“åº” `"Hello Elysia!"`ã€‚

---

---
url: 'https://elysiajs.com/migrate/from-express.md'
---

# ä» Express åˆ° Elysia

æœ¬æŒ‡å—é€‚ç”¨äºå¸Œæœ›äº†è§£ Express ä¸ Elysia ä¹‹é—´å·®å¼‚çš„ Express ç”¨æˆ·ï¼ŒåŒ…æ‹¬è¯­æ³•ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ç¤ºä¾‹å°†åº”ç”¨ç¨‹åºä» Express è¿ç§»åˆ° Elysiaã€‚

**Express** æ˜¯ä¸€ä¸ªæµè¡Œçš„ Node.js ç½‘ç»œæ¡†æ¶ï¼Œå¹¿æ³›ç”¨äºæ„å»º Web åº”ç”¨ç¨‹åºå’Œ APIã€‚å› å…¶ç®€å•æ€§å’Œçµæ´»æ€§è€Œé—»åã€‚

**Elysia** æ˜¯ä¸€ä¸ªäººæ€§åŒ–çš„ Web æ¡†æ¶ï¼Œé€‚ç”¨äº Bunã€Node.js å’Œæ”¯æŒ Web æ ‡å‡† API çš„è¿è¡Œæ—¶ã€‚è®¾è®¡æ—¶å¼ºè°ƒäººä½“å·¥å­¦å’Œå¼€å‘è€…å‹å¥½ï¼Œä¸“æ³¨äº **å¥å…¨çš„ç±»å‹å®‰å…¨** å’Œæ€§èƒ½ã€‚

## æ€§èƒ½

ç”±äºæœ¬æœº Bun å®ç°å’Œé™æ€ä»£ç åˆ†æï¼ŒElysia åœ¨æ€§èƒ½ä¸Šç›¸æ¯” Express æœ‰æ˜¾è‘—æé«˜ã€‚

## è·¯ç”±

Express å’Œ Elysia æœ‰ç±»ä¼¼çš„è·¯ç”±è¯­æ³•ï¼Œä½¿ç”¨ `app.get()` å’Œ `app.post()` æ–¹æ³•æ¥å®šä¹‰è·¯ç”±ï¼Œå¹¶ä¸”æœ‰ç±»ä¼¼çš„è·¯å¾„å‚æ•°è¯­æ³•ã€‚

::: code-group

```ts [Express]
import express from 'express'

const app = express()

app.get('/', (req, res) => {
    res.send('Hello World')
})

app.post('/id/:id', (req, res) => {
    res.status(201).send(req.params.id)
})

app.listen(3000)
```

:::


> Express ä½¿ç”¨ `req` å’Œ `res` ä½œä¸ºè¯·æ±‚å’Œå“åº”å¯¹è±¡

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
    .get('/', 'Hello World')
    .post(
    	'/id/:id',
     	({ status, params: { id } }) => {
      		return status(201, id)
      	}
    )
    .listen(3000)
```

:::


> Elysia ä½¿ç”¨å•ä¸€çš„ `context` ç›´æ¥è¿”å›å“åº”

åœ¨é£æ ¼æŒ‡å—ä¸Šå­˜åœ¨ä¸€äº›ç»†å¾®çš„å·®å¼‚ï¼ŒElysia æ¨èä½¿ç”¨æ–¹æ³•é“¾å’Œå¯¹è±¡è§£æ„ã€‚

å¦‚æœæ‚¨ä¸éœ€è¦ä½¿ç”¨ä¸Šä¸‹æ–‡ï¼ŒElysia è¿˜æ”¯æŒå†…è”å€¼ä½œä¸ºå“åº”ã€‚

## å¤„ç†ç¨‹åº

ä¸¤è€…åœ¨è®¿é—®è¾“å…¥å‚æ•°ï¼ˆå¦‚ `headers`ã€`query`ã€`params` å’Œ `body`ï¼‰æ—¶æœ‰ç±»ä¼¼çš„å±æ€§ã€‚

::: code-group

```ts [Express]
import express from 'express'

const app = express()

app.use(express.json())

app.post('/user', (req, res) => {
    const limit = req.query.limit
    const name = req.body.name
    const auth = req.headers.authorization

    res.json({ limit, name, auth })
})
```

:::


> Express éœ€è¦ `express.json()` ä¸­é—´ä»¶æ¥è§£æ JSON ä¸»ä½“

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
	.post('/user', (ctx) => {
	    const limit = ctx.query.limit
	    const name = ctx.body.name
	    const auth = ctx.headers.authorization

	    return { limit, name, auth }
	})
```

:::


> Elysia é»˜è®¤è§£æ JSONã€URL ç¼–ç æ•°æ®å’Œè¡¨å•æ•°æ®

## å­è·¯ç”±

Express ä½¿ç”¨ä¸“é—¨çš„ `express.Router()` å£°æ˜å­è·¯ç”±ï¼Œè€Œ Elysia å°†æ¯ä¸ªå®ä¾‹è§†ä¸ºå¯ä»¥æ’ä»¶å¼ç»„åˆçš„ç»„ä»¶ã€‚

::: code-group

```ts [Express]
import express from 'express'

const subRouter = express.Router()

subRouter.get('/user', (req, res) => {
	res.send('Hello User')
})

const app = express()

app.use('/api', subRouter)
```

:::


> Express ä½¿ç”¨ `express.Router()` åˆ›å»ºå­è·¯ç”±

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia({ prefix: '/api' })
	.get('/user', 'Hello User')

const app = new Elysia()
	.use(subRouter)
```

:::


> Elysia å°†æ¯ä¸ªå®ä¾‹è§†ä¸ºä¸€ä¸ªç»„ä»¶

## éªŒè¯

Elysia å†…ç½®æ”¯æŒä½¿ç”¨ TypeBox è¿›è¡Œè¯·æ±‚éªŒè¯ï¼Œæä¾›ç±»å‹å®‰å…¨ï¼Œå¹¶å¼€ç®±å³ç”¨æ”¯æŒæ ‡å‡† Schemaï¼Œä½¿æ‚¨å¯ä»¥ä½¿ç”¨å–œæ¬¢çš„åº“å¦‚ Zodã€Valibotã€ArkTypeã€Effect Schema ç­‰ã€‚è€Œ Express ä¸æä¾›å†…ç½®éªŒè¯ï¼Œéœ€è¦åŸºäºå„éªŒè¯åº“æ‰‹åŠ¨å£°æ˜ç±»å‹ã€‚

::: code-group

```ts [Express]
import express from 'express'
import { z } from 'zod'

const app = express()

app.use(express.json())

const paramSchema = z.object({
	id: z.coerce.number()
})

const bodySchema = z.object({
	name: z.string()
})

app.patch('/user/:id', (req, res) => {
	const params = paramSchema.safeParse(req.params)
	if (!params.success)
		return res.status(422).json(result.error)

	const body = bodySchema.safeParse(req.body)
	if (!body.success)
		return res.status(422).json(result.error)

	res.json({
		params: params.id.data,
		body: body.data
	})
})
```

:::


> Express éœ€è¦å¤–éƒ¨éªŒè¯åº“å¦‚ `zod` æˆ– `joi` æ¥éªŒè¯è¯·æ±‚ä¸»ä½“

::: code-group

```ts twoslash [Elysia TypeBox]
import { Elysia, t } from 'elysia'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
//                           ^?
		params,
		body
//   ^?
	}),



	{
		params: t.Object({
			id: t.Number()
		}),
		body: t.Object({
			name: t.String()
		})
	})
```

```ts twoslash [Elysia Zod]
import { Elysia } from 'elysia'
import { z } from 'zod'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: z.object({
			id: z.number()
		}),
		body: z.object({
			name: z.string()
		})
	})
```

```ts twoslash [Elysia Valibot]
import { Elysia } from 'elysia'
import * as v from 'valibot'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: v.object({
			id: v.number()
		}),
		body: v.object({
			name: v.string()
		})
	})
```

:::


> Elysia ä½¿ç”¨ TypeBox è¿›è¡ŒéªŒè¯ï¼Œå¹¶è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼ŒåŒæ—¶æ”¯æŒ Zodã€Valibot ç­‰å¤šç§éªŒè¯åº“ï¼Œä¸”è¯­æ³•ä¸€è‡´ã€‚

## æ–‡ä»¶ä¸Šä¼ 

Express ä½¿ç”¨å¤–éƒ¨åº“ `multer` å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼Œè€Œ Elysia å†…ç½®æ”¯æŒæ–‡ä»¶å’Œè¡¨å•æ•°æ®ï¼Œå¹¶ä½¿ç”¨å£°æ˜å¼ API è¿›è¡Œ MIME ç±»å‹éªŒè¯ã€‚

::: code-group

```ts [Express]
import express from 'express'
import multer from 'multer'
import { fileTypeFromFile } from 'file-type'
import path from 'path'

const app = express()
const upload = multer({ dest: 'uploads/' })

app.post('/upload', upload.single('image'), async (req, res) => {
	const file = req.file

	if (!file)
		return res
			.status(422)
			.send('æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶')

	const type = await fileTypeFromFile(file.path)
	if (!type || !type.mime.startsWith('image/'))
		return res
			.status(422)
			.send('æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„å›¾åƒ')

	const filePath = path.resolve(file.path)
	res.sendFile(filePath)
})
```

:::


> Express éœ€è¦ `express.json()` ä¸­é—´ä»¶æ¥è§£æ JSON ä¸»ä½“

::: code-group

```ts [Elysia]
import { Elysia, t } from 'elysia'

const app = new Elysia()
	.post('/upload', ({ body }) => body.file, {
		body: t.Object({
			file: t.File({
				type: 'image'
			})
		})
	})
```

:::


> Elysia ç”¨å£°æ˜å¼æ–¹æ³•å¤„ç†æ–‡ä»¶å’Œ MIME ç±»å‹éªŒè¯

ç”±äº **multer** ä¸éªŒè¯ MIME ç±»å‹ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ **file-type** æˆ–ç±»ä¼¼åº“æ‰‹åŠ¨éªŒè¯ MIME ç±»å‹ã€‚

Elysia éªŒè¯æ–‡ä»¶ä¸Šä¼ ï¼Œå¹¶ä½¿ç”¨ **file-type** è‡ªåŠ¨éªŒè¯ MIME ç±»å‹ã€‚

## ä¸­é—´ä»¶

Express ä¸­é—´ä»¶ä½¿ç”¨å•ä¸€çš„åŸºäºé˜Ÿåˆ—çš„é¡ºåºï¼Œè€Œ Elysia æä¾›ä½¿ç”¨ **åŸºäºäº‹ä»¶** çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œæ›´ç²¾ç»†çš„æ§åˆ¶ã€‚

Elysia çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¯ä»¥å¦‚ä¸‹æ‰€ç¤ºã€‚
![Elysia ç”Ÿå‘½å‘¨æœŸå›¾](/assets/lifecycle-chart.svg)

> ç‚¹å‡»å›¾ç‰‡æ”¾å¤§

å°½ç®¡ Express å¯¹è¯·æ±‚ç®¡é“æœ‰å•ä¸€æµçš„å¤„ç†é¡ºåºï¼ŒElysia å¯ä»¥æ‹¦æˆªè¯·æ±‚ç®¡é“ä¸­çš„æ¯ä¸ªäº‹ä»¶ã€‚

::: code-group

```ts [Express]
import express from 'express'

const app = express()

// å…¨å±€ä¸­é—´ä»¶
app.use((req, res, next) => {
	console.log(`${req.method} ${req.url}`)
	next()
})

app.get(
	'/protected',
	// è·¯ç”±ç‰¹å®šä¸­é—´ä»¶
	(req, res, next) => {
	  	const token = req.headers.authorization

	  	if (!token)
	   		return res.status(401).send('æœªæˆæƒ')

	  	next()
	},
	(req, res) => {
  		res.send('å—ä¿æŠ¤çš„è·¯ç”±')
	}
)
```

:::


> Express ä½¿ç”¨å•ä¸ªåŸºäºé˜Ÿåˆ—çš„é¡ºåºæ¥å¤„ç†ä¸­é—´ä»¶ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
	// å…¨å±€ä¸­é—´ä»¶
	.onRequest(({ method, path }) => {
		console.log(`${method} ${path}`)
	})
	// è·¯ç”±ç‰¹å®šä¸­é—´ä»¶
	.get('/protected', () => 'protected', {
		beforeHandle({ status, headers }) {
  			if (!headers.authorizaton)
     			return status(401)
		}
	})
```

:::


> Elysia ä¸ºè¯·æ±‚ç®¡é“ä¸­çš„æ¯ä¸ªç‚¹ä½¿ç”¨ç‰¹å®šçš„äº‹ä»¶æ‹¦æˆªå™¨

è™½ç„¶ Express å…·æœ‰è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„ `next` å‡½æ•°ï¼Œä½† Elysia å¹¶æ²¡æœ‰ã€‚

## å¥å…¨çš„ç±»å‹å®‰å…¨

Elysia è¢«è®¾è®¡ä¸ºå…·æœ‰å¥å…¨çš„ç±»å‹å®‰å…¨ã€‚

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [derive](/essential/life-cycle.html#derive) å’Œ [resolve](/essential/life-cycle.html#resolve) ä»¥ **ç±»å‹å®‰å…¨** çš„æ–¹å¼è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ï¼Œè€Œ Express åˆ™æ— æ³•åšåˆ°ã€‚

::: code-group

```ts twoslash [Express]
// @errors: 2339
import express from 'express'
import type { Request, Response } from 'express'

const app = express()

const getVersion = (req: Request, res: Response, next: Function) => {
	// @ts-ignore
    req.version = 2

	next()
}

app.get('/version', getVersion, (req, res) => {
	res.send(req.version)
	//            ^?
})

const authenticate = (req: Request, res: Response, next: Function) => {
  	const token = req.headers.authorization

  	if (!token)
   		return res.status(401).send('æœªæˆæƒ')

	// @ts-ignore
    req.token = token.split(' ')[1]

	next()
}

app.get('/token', getVersion, authenticate, (req, res) => {
	req.version
	//  ^?

  	res.send(req.token)
   //            ^?
})
```

:::


> Express ä½¿ç”¨å•ä¸ªåŸºäºé˜Ÿåˆ—çš„é¡ºåºæ¥å¤„ç†ä¸­é—´ä»¶ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ

::: code-group

```ts twoslash [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
	.decorate('version', 2)
	.get('/version', ({ version }) => version)
	.resolve(({ status, headers: { authorization } }) => {
		if(!authorization?.startsWith('Bearer '))
			return status(401)

		return {
			token: authorization.split(' ')[1]
		}
	})
	.get('/token', ({ token, version }) => {
		version
		//  ^?


		return token
		//       ^?
	})
```

:::


> Elysia ä¸ºè¯·æ±‚ç®¡é“ä¸­çš„æ¯ä¸ªç‚¹ä½¿ç”¨ç‰¹å®šçš„äº‹ä»¶æ‹¦æˆªå™¨

è™½ç„¶ Express å¯ä»¥ä½¿ç”¨ `declare module` æ‰©å±• `Request` æ¥å£ï¼Œä½†å®ƒæ˜¯å…¨å±€å¯ç”¨çš„ï¼Œå¹¶ä¸”æ²¡æœ‰å¥å…¨çš„ç±»å‹å®‰å…¨ï¼Œä¹Ÿä¸ä¿è¯è¯¥å±æ€§åœ¨æ‰€æœ‰è¯·æ±‚å¤„ç†ç¨‹åºä¸­éƒ½æ˜¯å¯ç”¨çš„ã€‚

```ts
declare module 'express' {
  	interface Request {
    	version: number
  		token: string
  	}
}
```

> è¿™å¯¹äºä½¿ä¸Šé¢çš„ Express ç¤ºä¾‹æ­£å¸¸å·¥ä½œæ˜¯å¿…éœ€çš„ï¼Œä½†å¹¶ä¸æä¾›å¥å…¨çš„ç±»å‹å®‰å…¨

## ä¸­é—´ä»¶å‚æ•°

Express ä½¿ç”¨å‡½æ•°è¿”å›æ’ä»¶æ¥å®šä¹‰å¯é‡ç”¨çš„è·¯ç”±ç‰¹å®šä¸­é—´ä»¶ï¼Œè€Œ Elysia ä½¿ç”¨ [macro](/patterns/macro) å®šä¹‰è‡ªå®šä¹‰é’©å­ã€‚

::: code-group

```ts twoslash [Express]
const findUser = (authorization?: string) => {
	return {
		name: 'Jane Doe',
		role: 'admin' as const
	}
}
// ---cut---
// @errors: 2339
import express from 'express'
import type { Request, Response } from 'express'

const app = express()

const role = (role: 'user' | 'admin') =>
	(req: Request, res: Response, next: Function) => {
	  	const user = findUser(req.headers.authorization)

	  	if (user.role !== role)
	   		return res.status(401).send('æœªæˆæƒ')

		// @ts-ignore
	    req.user = user

		next()
	}

app.get('/token', role('admin'), (req, res) => {
  	res.send(req.user)
   //            ^?
})
```

:::


> Express ä½¿ç”¨å‡½æ•°å›è°ƒæ¥å—ä¸­é—´ä»¶çš„è‡ªå®šä¹‰å‚æ•°

::: code-group

```ts twoslash [Elysia]
const findUser = (authorization?: string) => {
	return {
		name: 'Jane Doe',
		role: 'admin' as const
	}
}
// ---cut---
import { Elysia } from 'elysia'

const app = new Elysia()
	.macro({
		role: (role: 'user' | 'admin') => ({
			resolve({ status, headers: { authorization } }) {
				const user = findUser(authorization)

				if(user.role !== role)
					return status(401)

				return {
					user
				}
			}
		})
	})
	.get('/token', ({ user }) => user, {
	//                 ^?
		role: 'admin'
	})
```

:::


> Elysia ä½¿ç”¨å®å°†è‡ªå®šä¹‰å‚æ•°ä¼ é€’ç»™è‡ªå®šä¹‰ä¸­é—´ä»¶

## é”™è¯¯å¤„ç†

Express ä½¿ç”¨å•ä¸€é”™è¯¯å¤„ç†ç¨‹åºå¤„ç†æ‰€æœ‰è·¯ç”±ï¼Œè€Œ Elysia æä¾›äº†æ›´ç²¾ç»†çš„é”™è¯¯å¤„ç†æ§åˆ¶ã€‚

::: code-group

```ts
import express from 'express'

const app = express()

class CustomError extends Error {
	constructor(message: string) {
		super(message)
		this.name = 'CustomError'
	}
}

// å…¨å±€é”™è¯¯å¤„ç†ç¨‹åº
app.use((error, req, res, next) => {
	if(error instanceof CustomError) {
		res.status(500).json({
			message: 'å‘ç”Ÿäº†é”™è¯¯ï¼',
			error
		})
	}
})

// è·¯ç”±ç‰¹å®šé”™è¯¯å¤„ç†ç¨‹åº
app.get('/error', (req, res) => {
	throw new CustomError('å“¦ï¼Œå•Š')
})
```

:::


> Express ä½¿ç”¨ä¸­é—´ä»¶å¤„ç†é”™è¯¯ï¼Œæ‰€æœ‰è·¯ç”±å…±äº«ä¸€ä¸ªé”™è¯¯å¤„ç†ç¨‹åº

::: code-group

```ts twoslash [Elysia]
import { Elysia } from 'elysia'

class CustomError extends Error {
	// å¯é€‰ï¼šè‡ªå®šä¹‰ HTTP çŠ¶æ€ç 
	status = 500

	constructor(message: string) {
		super(message)
		this.name = 'CustomError'
	}

	// å¯é€‰ï¼šå‘é€åˆ°å®¢æˆ·ç«¯çš„å†…å®¹
	toResponse() {
		return {
			message: "å¦‚æœæ‚¨çœ‹åˆ°è¿™ä¸ªï¼Œæˆ‘ä»¬çš„å¼€å‘äººå‘˜å¿˜è®°å¤„ç†æ­¤é”™è¯¯",
			error: this
		}
	}
}

const app = new Elysia()
	// å¯é€‰ï¼šæ³¨å†Œè‡ªå®šä¹‰é”™è¯¯ç±»
	.error({
		CUSTOM: CustomError,
	})
	// å…¨å±€é”™è¯¯å¤„ç†ç¨‹åº
	.onError(({ error, code }) => {
		if(code === 'CUSTOM')
		// ^?


			return {
				message: 'å‘ç”Ÿäº†é”™è¯¯ï¼',
				error
			}
	})
	.get('/error', () => {
		throw new CustomError('å“¦ï¼Œå•Š')
	}, {
		// å¯é€‰ï¼šè·¯ç”±ç‰¹å®šé”™è¯¯å¤„ç†ç¨‹åº
		error({ error }) {
			return {
				message: 'ä»…é€‚ç”¨äºæ­¤è·¯ç”±ï¼',
				error
			}
		}
	})
```

:::


> Elysia æä¾›æ›´ç²¾ç»†çš„é”™è¯¯å¤„ç†æ§åˆ¶å’Œä½œç”¨åŸŸæœºåˆ¶

å°½ç®¡ Express ä½¿ç”¨ä¸­é—´ä»¶è¿›è¡Œé”™è¯¯å¤„ç†ï¼ŒElysia æä¾›ï¼š

1. å…¨å±€å’Œè·¯ç”±ç‰¹å®šçš„é”™è¯¯å¤„ç†å™¨
2. ç”¨äºæ˜ å°„ HTTP çŠ¶æ€ç å’Œ `toResponse` æ–¹æ³•ç®€å†™ï¼Œå°†é”™è¯¯æ˜ å°„ä¸ºå“åº”
3. ä¸ºæ¯ç§é”™è¯¯æä¾›è‡ªå®šä¹‰é”™è¯¯ä»£ç 

é”™è¯¯ä»£ç å¯¹æ—¥å¿—è®°å½•å’Œè°ƒè¯•éå¸¸æœ‰ç”¨ï¼Œå¹¶ä¸”åœ¨åŒºåˆ†ç»§æ‰¿è‡ªåŒä¸€ç±»çš„ä¸åŒç±»å‹é”™è¯¯æ—¶éå¸¸é‡è¦ã€‚

Elysia åœ¨æä¾›ä»¥ä¸ŠåŠŸèƒ½çš„åŒæ—¶ç¡®ä¿ç±»å‹å®‰å…¨ï¼Œè€Œ Express åˆ™æ²¡æœ‰ã€‚

## å°è£…

Express ä¸­é—´ä»¶æ³¨å†Œä¸ºå…¨å±€ï¼Œè€Œ Elysia é€šè¿‡æ˜¾å¼ä½œç”¨åŸŸæœºåˆ¶å’Œä»£ç é¡ºåºï¼Œæ§åˆ¶æ’ä»¶çš„å‰¯ä½œç”¨ã€‚

::: code-group

```ts [Express]
import express from 'express'

const app = express()

app.get('/', (req, res) => {
	res.send('Hello World')
})

const subRouter = express.Router()

subRouter.use((req, res, next) => {
	const token = req.headers.authorization

	if (!token)
		return res.status(401).send('æœªæˆæƒ')

	next()
})

app.use(subRouter)

// ä»å­è·¯ç”±äº§ç”Ÿå‰¯ä½œç”¨
app.get('/side-effect', (req, res) => {
	res.send('å—¨')
})

```

:::


> Express ä¸ä¼šå¤„ç†ä¸­é—´ä»¶çš„å‰¯ä½œç”¨ï¼Œéœ€è¦æ·»åŠ å‰ç¼€ä»¥åˆ†å¼€å‰¯ä½œç”¨

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia()
	.onBeforeHandle(({ status, headers: { authorization } }) => {
		if(!authorization?.startsWith('Bearer '))
			return status(401)
   	})

const app = new Elysia()
    .get('/', 'Hello World')
    .use(subRouter)
    // ä¸ä¼šæœ‰æ¥è‡ªå­è·¯ç”±çš„å‰¯ä½œç”¨
    .get('/side-effect', () => 'å—¨')
```

:::


> Elysia å°†å‰¯ä½œç”¨å°è£…åˆ°æ’ä»¶ä¸­

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia å°†ç”Ÿå‘½äº‹ä»¶å’Œä¸Šä¸‹æ–‡å°è£…åˆ°æ‰€ä½¿ç”¨çš„å®ä¾‹ä¸­ï¼Œå› æ­¤æ’ä»¶çš„å‰¯ä½œç”¨ä¸ä¼šå½±å“çˆ¶å®ä¾‹ï¼Œé™¤éæ˜ç¡®è¯´æ˜ã€‚

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia()
	.onBeforeHandle(({ status, headers: { authorization } }) => {
		if(!authorization?.startsWith('Bearer '))
			return status(401)
   	})
	// ä½œç”¨åŸŸé™å®šäºçˆ¶å®ä¾‹ï¼Œä½†ä¸å†è¶…è¿‡æ­¤èŒƒå›´
	.as('scoped') // [!code ++]

const app = new Elysia()
    .get('/', 'Hello World')
    .use(subRouter)
    // [!code ++]
    // ç°åœ¨æœ‰æ¥è‡ªå­è·¯ç”±çš„å‰¯ä½œç”¨
    .get('/side-effect', () => 'å—¨')
```

Elysia æä¾›ä¸‰ç§ç±»å‹çš„ä½œç”¨åŸŸæœºåˆ¶ï¼š

1. **å±€éƒ¨** - åªåº”ç”¨äºå½“å‰å®ä¾‹ï¼Œæ²¡æœ‰å‰¯ä½œç”¨ï¼ˆé»˜è®¤ï¼‰
2. **å—é™** - å°†å‰¯ä½œç”¨ä½œç”¨åŸŸé™å®šäºçˆ¶å®ä¾‹ï¼Œä½†ä¸å†è¶…è¿‡æ­¤èŒƒå›´
3. **å…¨å±€** - å½±å“æ‰€æœ‰å®ä¾‹

è™½ç„¶ Express å¯ä»¥é€šè¿‡æ·»åŠ å‰ç¼€æ¥é™åˆ¶ä¸­é—´ä»¶å‰¯ä½œç”¨ï¼Œä½†è¿™å¹¶ä¸æ˜¯çœŸæ­£çš„å°è£…ã€‚å‰¯ä½œç”¨ä»ç„¶å­˜åœ¨ï¼Œä½†è¢«åˆ†éš”åˆ°ä»¥æ‰€è¿°å‰ç¼€å¼€å¤´çš„ä»»ä½•è·¯ç”±ï¼Œä½¿å¾—å¼€å‘äººå‘˜éœ€è¦è®°ä½å“ªä¸ªå‰ç¼€å…·æœ‰å‰¯ä½œç”¨ã€‚

è¿™ä½¿å¾—æ‚¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

1. é‡æ–°æ’åˆ—ä»£ç é¡ºåºï¼Œä½†ä»…åœ¨åªæœ‰ä¸€ä¸ªå…·æœ‰å‰¯ä½œç”¨çš„å®ä¾‹ä¸­æœ‰æ•ˆã€‚
2. æ·»åŠ å‰ç¼€ï¼Œä½†å‰¯ä½œç”¨ä»ç„¶å­˜åœ¨ã€‚å¦‚æœå…¶ä»–å®ä¾‹å…·æœ‰ç›¸åŒçš„å‰ç¼€ï¼Œåˆ™å®ƒä¹Ÿå…·æœ‰å‰¯ä½œç”¨ã€‚

è¿™å¯èƒ½å¯¼è‡´è°ƒè¯•æ—¶å‡ºç°å™©æ¢¦åœºæ™¯ï¼Œå› ä¸º Express ä¸æä¾›çœŸæ­£çš„å°è£…ã€‚

## Cookie

Express ä½¿ç”¨å¤–éƒ¨åº“ `cookie-parser` è§£æ cookiesï¼Œè€Œ Elysia å†…ç½®æ”¯æŒ cookieï¼Œå¹¶ä½¿ç”¨åŸºäºä¿¡å·çš„æ–¹æ³•å¤„ç† cookiesã€‚

::: code-group

```ts [Express]
import express from 'express'
import cookieParser from 'cookie-parser'

const app = express()

app.use(cookieParser('secret'))

app.get('/', function (req, res) {
	req.cookies.name
	req.signedCookies.name

	res.cookie('name', 'value', {
		signed: true,
		maxAge: 1000 * 60 * 60 * 24
	})
})
```

:::


> Express ä½¿ç”¨ `cookie-parser` è§£æ Cookies

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia({
	cookie: {
		secret: 'secret'
	}
})
	.get('/', ({ cookie: { name } }) => {
		// ç­¾åéªŒè¯è‡ªåŠ¨å¤„ç†
		name.value

		// æ•´ä¸ª cookie ç­¾åè‡ªåŠ¨å¤„ç†
		name.value = 'value'
		name.maxAge = 1000 * 60 * 60 * 24
	})
```

:::


> Elysia ä½¿ç”¨åŸºäºä¿¡å·çš„æ–¹æ³•å¤„ç† Cookies

## OpenAPI

Express éœ€è¦å•ç‹¬çš„é…ç½®æ¥æ”¯æŒ OpenAPIã€éªŒè¯å’Œç±»å‹å®‰å…¨ï¼Œè€Œ Elysia ä½¿ç”¨æ¶æ„ä½œä¸º **å•ä¸€çœŸå®æ¥æº** å†…ç½®æ”¯æŒ OpenAPIã€‚

::: code-group

```ts [Express]
import express from 'express'

import swaggerUi from 'swagger-ui-express'

const app = express()
app.use(express.json())

app.post('/users', (req, res) => {
	// TODO: éªŒè¯è¯·æ±‚ä¸»ä½“
	res.status(201).json(req.body)
})

const swaggerSpec = {
	openapi: '3.0.0',
	info: {
		title: 'æˆ‘çš„ API',
		version: '1.0.0'
	},
	paths: {
		'/users': {
			post: {
				summary: 'åˆ›å»ºç”¨æˆ·',
				requestBody: {
					content: {
						'application/json': {
							schema: {
								type: 'object',
								properties: {
									name: {
										type: 'string',
										description: 'ä»…ä¸ºå'
									},
									age: { type: 'integer' }
								},
								required: ['name', 'age']
							}
						}
					}
				},
				responses: {
					'201': {
						description: 'ç”¨æˆ·å·²åˆ›å»º'
					}
				}
			}
		}
	}
}

app.use('/docs', swaggerUi.serve, swaggerUi.setup(swaggerSpec))
```

:::


> Express éœ€è¦å•ç‹¬çš„é…ç½®æ¥æ”¯æŒ OpenAPIã€éªŒè¯å’Œç±»å‹å®‰å…¨

::: code-group

```ts twoslash [Elysia]
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi' // [!code ++]

const app = new Elysia()
	.use(openapi()) // [!code ++]
	.model({
		user: t.Array(
			t.Object({
				name: t.String(),
				age: t.Number()
			})
		)
	})
	.post('/users', ({ body }) => body, {
	//                  ^?
		body: 'user',
		response: {
			201: 'user'
		},
		detail: {
			summary: 'åˆ›å»ºç”¨æˆ·'
		}
	})
```

:::


> Elysia å°†æ¶æ„ç”¨ä½œå•ä¸€çœŸå®æ¥æº

Elysia ä¼šæ ¹æ®æ‚¨æä¾›çš„æ¶æ„ç”Ÿæˆ OpenAPI è§„èŒƒï¼Œå¹¶æ ¹æ®è¯¥æ¶æ„éªŒè¯è¯·æ±‚å’Œå“åº”ï¼Œå¹¶è‡ªåŠ¨æ¨æ–­ç±»å‹ã€‚

Elysia è¿˜å°†åœ¨ `model` ä¸­æ³¨å†Œçš„æ¶æ„é™„åŠ åˆ° OpenAPI è§„èŒƒï¼Œå…è®¸æ‚¨åœ¨ Swagger æˆ– Scalar UI çš„ä¸“ç”¨éƒ¨åˆ†ä¸­å¼•ç”¨è¯¥æ¨¡å‹ã€‚

## æµ‹è¯•

Express ä½¿ç”¨å•ä¸ª `supertest` åº“æµ‹è¯•åº”ç”¨ç¨‹åºï¼Œè€Œ Elysia æ„å»ºåœ¨ Web æ ‡å‡† API ä¹‹ä¸Šï¼Œå…è®¸ä¸ä»»ä½•æµ‹è¯•åº“ä¸€èµ·ä½¿ç”¨ã€‚

::: code-group

```ts [Express]
import express from 'express'
import request from 'supertest'
import { describe, it, expect } from 'vitest'

const app = express()

app.get('/', (req, res) => {
	res.send('Hello World')
})

describe('GET /', () => {
	it('åº”è¯¥è¿”å› Hello World', async () => {
		const res = await request(app).get('/')

		expect(res.status).toBe(200)
		expect(res.text).toBe('Hello World')
	})
})
```

:::


> Express ä½¿ç”¨ `supertest` åº“æµ‹è¯•åº”ç”¨ç¨‹åº

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'
import { describe, it, expect } from 'vitest'

const app = new Elysia()
	.get('/', 'Hello World')

describe('GET /', () => {
	it('åº”è¯¥è¿”å› Hello World', async () => {
		const res = await app.handle(
			new Request('http://localhost')
		)

		expect(res.status).toBe(200)
		expect(await res.text()).toBe('Hello World')
	})
})
```

:::


> Elysia ä½¿ç”¨ Web æ ‡å‡† API å¤„ç†è¯·æ±‚å’Œå“åº”

æ­¤å¤–ï¼ŒElysia è¿˜æä¾›äº†ä¸€ä¸ªç§°ä¸º [Eden](/eden/overview) çš„åŠ©æ‰‹åº“ï¼Œç”¨äºç«¯åˆ°ç«¯çš„ç±»å‹å®‰å…¨ï¼Œå…è®¸æˆ‘ä»¬è¿›è¡Œè‡ªåŠ¨è¡¥å…¨å’Œå®Œå…¨ç±»å‹å®‰å…¨çš„æµ‹è¯•ã€‚

```ts twoslash [Elysia]
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'
import { describe, expect, it } from 'bun:test'

const app = new Elysia().get('/hello', 'Hello World')
const api = treaty(app)

describe('GET /', () => {
	it('åº”è¯¥è¿”å› Hello World', async () => {
		const { data, error, status } = await api.hello.get()

		expect(status).toBe(200)
		expect(data).toBe('Hello World')
		//      ^?
	})
})
```

## ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨

Elysia å†…ç½®æ”¯æŒ **ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨**ï¼Œæ— éœ€ä»£ç ç”Ÿæˆï¼ŒExpress ä¸æä¾›æ­¤åŠŸèƒ½ã€‚

::: code-group

```ts twoslash [Elysia]
import { Elysia, t } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
	.post('/mirror', ({ body }) => body, {
		body: t.Object({
			message: t.String()
		})
	})

const api = treaty(app)

const { data, error } = await api.mirror.post({
	message: 'Hello World'
})

if(error)
	throw error
	//     ^?














console.log(data)
//          ^?



// ---cut-after---
console.log('ok')
```

:::

å¦‚æœç«¯åˆ°ç«¯ç±»å‹å®‰å…¨å¯¹æ‚¨æ¥è¯´å¾ˆé‡è¦ï¼Œé‚£ä¹ˆ Elysia æ˜¯æ­£ç¡®çš„é€‰æ‹©ã€‚

***

Elysia æä¾›äº†æ›´äººæ€§åŒ–å’Œå¼€å‘è€…å‹å¥½çš„ä½“éªŒï¼Œä¸“æ³¨äºæ€§èƒ½ã€ç±»å‹å®‰å…¨å’Œç®€æ˜“æ€§ï¼Œè€Œ Express æ˜¯ä¸€ä¸ªæµè¡Œçš„ Node.js ç½‘ç»œæ¡†æ¶ï¼Œä½†åœ¨æ€§èƒ½å’Œç®€æ˜“æ€§æ–¹é¢å­˜åœ¨ä¸€äº›å±€é™æ€§ã€‚

å¦‚æœæ‚¨åœ¨å¯»æ‰¾ä¸€ä¸ªæ˜“äºä½¿ç”¨ã€å…·æœ‰å‡ºè‰²å¼€å‘è€…ä½“éªŒä¸”åŸºäº Web æ ‡å‡† API çš„æ¡†æ¶ï¼ŒElysia æ˜¯æ‚¨æ­£ç¡®çš„é€‰æ‹©ã€‚

å¦å¤–ï¼Œå¦‚æœæ‚¨æ¥è‡ªå…¶ä»–æ¡†æ¶ï¼Œå¯ä»¥æŸ¥çœ‹ï¼š

---

---
url: 'https://elysiajs.com/migrate/from-fastify.md'
---

# ä» Fastify åˆ° Elysia

æœ¬æŒ‡å—é¢å‘å¸Œæœ›çœ‹åˆ° Fastify ä¹‹é—´å·®å¼‚çš„ç”¨æˆ·ï¼ŒåŒ…æ‹¬è¯­æ³•ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ç¤ºä¾‹å°†åº”ç”¨ç¨‹åºä» Fastify è¿ç§»åˆ° Elysiaã€‚

**Fastify** æ˜¯ä¸€ä¸ªå¿«é€Ÿä¸”ä½å¼€é”€çš„ Node.js ç½‘ç»œæ¡†æ¶ï¼Œæ—¨åœ¨ç®€å•æ˜“ç”¨ã€‚å®ƒåŸºäº HTTP æ¨¡å—æ„å»ºï¼Œæä¾›äº†ä¸€ç»„æ˜“äºæ„å»º Web åº”ç”¨ç¨‹åºçš„åŠŸèƒ½ã€‚

**Elysia** æ˜¯ä¸€ä¸ªç¬¦åˆäººä½“å·¥ç¨‹å­¦çš„ Web æ¡†æ¶ï¼Œæ”¯æŒ Bunã€Node.js å’Œ Web æ ‡å‡† API çš„è¿è¡Œæ—¶ã€‚æ—¨åœ¨ä½¿å¼€å‘äººå‘˜å‹å¥½ï¼Œå¹¶ä¸“æ³¨äº **è‰¯å¥½çš„ç±»å‹å®‰å…¨** å’Œæ€§èƒ½ã€‚

## æ€§èƒ½

å¾—ç›Šäºæœ¬åœ° Bun å®ç°å’Œé™æ€ä»£ç åˆ†æï¼ŒElysia ç›¸æ¯” Fastify æœ‰äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ã€‚

## è·¯ç”±

Fastify å’Œ Elysia å…·æœ‰ç±»ä¼¼çš„è·¯ç”±è¯­æ³•ï¼Œä½¿ç”¨ `app.get()` å’Œ `app.post()` æ–¹æ³•å®šä¹‰è·¯ç”±ï¼Œå¹¶ä½¿ç”¨ç±»ä¼¼çš„è·¯å¾„å‚æ•°è¯­æ³•ã€‚

::: code-group

```ts [Fastify]
import fastify from 'fastify'

const app = fastify()

app.get('/', (request, reply) => {
    res.send('Hello World')
})

app.post('/id/:id', (request, reply) => {
    reply.status(201).send(req.params.id)
})

app.listen({ port: 3000 })
```

:::


> Fastify ä½¿ç”¨ `request` å’Œ `reply` ä½œä¸ºè¯·æ±‚å’Œå“åº”å¯¹è±¡

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
    .get('/', 'Hello World')
    .post(
    	'/id/:id',
     	({ status, params: { id } }) => {
      		return status(201, id)
      	}
    )
    .listen(3000)
```

:::


> Elysia ä½¿ç”¨å•ä¸€çš„ `context` å¹¶ç›´æ¥è¿”å›å“åº”

åœ¨é£æ ¼æŒ‡å—ä¸Šæœ‰ä¸€ç‚¹ä¸åŒï¼ŒElysia æ¨èä½¿ç”¨æ–¹æ³•é“¾å’Œå¯¹è±¡è§£æ„ã€‚

å¦‚æœæ‚¨ä¸éœ€è¦ä½¿ç”¨ä¸Šä¸‹æ–‡ï¼ŒElysia è¿˜æ”¯æŒå“åº”çš„å†…è”å€¼ã€‚

## å¤„ç†ç¨‹åº

ä¸¤è€…éƒ½å…·æœ‰ç±»ä¼¼çš„å±æ€§ï¼Œä»¥è®¿é—®è¾“å…¥å‚æ•°ï¼Œå¦‚ `headers`ã€`query`ã€`params` å’Œ `body`ï¼Œå¹¶è‡ªåŠ¨å°†è¯·æ±‚ä¸»ä½“è§£æä¸º JSONã€URL ç¼–ç æ•°æ®å’Œè¡¨å•æ•°æ®ã€‚

::: code-group

```ts [Fastify]
import fastify from 'fastify'

const app = fastify()

app.post('/user', (request, reply) => {
    const limit = request.query.limit
    const name = request.body.name
    const auth = request.headers.authorization

    reply.send({ limit, name, auth })
})
```

:::


> Fastify è§£ææ•°æ®å¹¶å°†å…¶æ”¾å…¥ `request` å¯¹è±¡ä¸­

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
	.post('/user', (ctx) => {
	    const limit = ctx.query.limit
	    const name = ctx.body.name
	    const auth = ctx.headers.authorization

	    return { limit, name, auth }
	})
```

:::


> Elysia è§£ææ•°æ®å¹¶å°†å…¶æ”¾å…¥ `context` å¯¹è±¡ä¸­

## å­è·¯ç”±

Fastify ä½¿ç”¨å‡½æ•°å›è°ƒæ¥å®šä¹‰å­è·¯ç”±ï¼Œè€Œ Elysia åˆ™å°†æ¯ä¸ªå®ä¾‹è§†ä¸ºå¯ä»¥å³æ’å³ç”¨çš„ç»„ä»¶ã€‚

::: code-group

```ts [Fastify]
import fastify, { FastifyPluginCallback } from 'fastify'

const subRouter: FastifyPluginCallback = (app, opts, done) => {
	app.get('/user', (request, reply) => {
		reply.send('Hello User')
	})
}

const app = fastify()

app.register(subRouter, {
	prefix: '/api'
})
```

:::


> Fastify ä½¿ç”¨å‡½æ•°å›è°ƒå£°æ˜å­è·¯ç”±

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia({ prefix: '/api' })
	.get('/user', 'Hello User')

const app = new Elysia()
	.use(subRouter)
```

:::


> Elysia å°†æ¯ä¸ªå®ä¾‹è§†ä¸ºä¸€ä¸ªç»„ä»¶

è™½ç„¶ Elysia åœ¨æ„é€ å‡½æ•°ä¸­è®¾ç½®å‰ç¼€ï¼Œä½† Fastify è¦æ±‚æ‚¨åœ¨é€‰é¡¹ä¸­è®¾ç½®å‰ç¼€ã€‚

## éªŒè¯

Elysia å†…ç½®æ”¯æŒè¯·æ±‚éªŒè¯ï¼Œå…·æœ‰è‰¯å¥½çš„ç±»å‹å®‰å…¨ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ **TypeBox**ï¼Œè€Œ Fastify ä½¿ç”¨ JSON Schema å£°æ˜æ¨¡å¼ï¼Œå¹¶ä½¿ç”¨ **ajv** è¿›è¡ŒéªŒè¯ã€‚

ä½†æ˜¯ï¼Œä¸èƒ½è‡ªåŠ¨æ¨å¯¼ç±»å‹ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ç±»å‹æä¾›ç¨‹åºï¼Œå¦‚ `@fastify/type-provider-json-schema-to-ts` æ¥æ¨å¯¼ç±»å‹ã€‚

::: code-group

```ts [Fastify]
import fastify from 'fastify'
import { JsonSchemaToTsProvider } from '@fastify/type-provider-json-schema-to-ts'

const app = fastify().withTypeProvider<JsonSchemaToTsProvider>()

app.patch(
	'/user/:id',
	{
		schema: {
			params: {
				type: 'object',
				properties: {
					id: {
						type: 'string',
						pattern: '^[0-9]+$'
					}
				},
				required: ['id']
			},
			body: {
				type: 'object',
				properties: {
					name: { type: 'string' }
				},
				required: ['name']
			},
		}
	},
	(request, reply) => {
		// å°†å­—ç¬¦ä¸²æ˜ å°„åˆ°æ•°å­—
		request.params.id = +request.params.id

		reply.send({
			params: request.params,
			body: request.body
		})
	}
})
```

:::


> Fastify ä½¿ç”¨ JSON Schema è¿›è¡ŒéªŒè¯

::: code-group

```ts twoslash [Elysia TypeBox]
import { Elysia, t } from 'elysia'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: t.Object({
			id: t.Number()
		}),
		body: t.Object({
			name: t.String()
		})
	})
```

```ts twoslash [Elysia Zod]
import { Elysia } from 'elysia'
import { z } from 'zod'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: z.object({
			id: z.number()
		}),
		body: z.object({
			name: z.string()
		})
	})
```

```ts twoslash [Elysia Valibot]
import { Elysia } from 'elysia'
import * as v from 'zod'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: v.object({
			id: v.number()
		}),
		body: v.object({
			name: v.string()
		})
	})
```

:::


> Elysia ä½¿ç”¨ TypeBox è¿›è¡ŒéªŒè¯ï¼Œå¹¶è‡ªåŠ¨å¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚åŒæ—¶ä¹Ÿæ”¯æŒåƒ Zodã€Valibot ç­‰å„ç§éªŒè¯åº“ï¼Œå¹¶ä½¿ç”¨ç›¸åŒçš„è¯­æ³•ã€‚

æ­¤å¤–ï¼ŒFastify è¿˜å¯ä»¥ä½¿ç”¨ **TypeBox** æˆ– **Zod** è¿›è¡ŒéªŒè¯ï¼Œä½¿ç”¨ `@fastify/type-provider-typebox` è‡ªåŠ¨æ¨å¯¼ç±»å‹ã€‚

è€Œ Elysia **åå¥½ä½¿ç”¨ TypeBox** è¿›è¡ŒéªŒè¯ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒæ ‡å‡† Schemaï¼Œå…è®¸æ‚¨å¼€ç®±å³ç”¨åœ°ä½¿ç”¨ Zodã€Valibotã€ArkTypeã€Effect Schema ç­‰åº“ã€‚

## æ–‡ä»¶ä¸Šä¼ 

Fastify ä½¿ç”¨ `fastify-multipart` å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼Œåº•å±‚ä½¿ç”¨ `Busboy`ï¼Œè€Œ Elysia ä½¿ç”¨ Web æ ‡å‡† API å¤„ç†è¡¨å•æ•°æ®ï¼Œä½¿ç”¨å£°æ˜æ€§ API è¿›è¡Œ mimetype éªŒè¯ã€‚

ç„¶è€Œï¼ŒFastify å¹¶æ²¡æœ‰æä¾›ä¸€ç§ç®€å•çš„æ–¹æ³•è¿›è¡Œæ–‡ä»¶éªŒè¯ï¼Œä¾‹å¦‚ï¼Œæ–‡ä»¶å¤§å°å’Œ mimetypeï¼Œéœ€è¦ä¸€äº›å˜é€šæ–¹æ³•æ¥éªŒè¯æ–‡ä»¶ã€‚

::: code-group

```ts [Fastify]
import fastify from 'fastify'
import multipart from '@fastify/multipart'

import { fileTypeFromBuffer } from 'file-type'

const app = fastify()
app.register(multipart, {
	attachFieldsToBody: 'keyValues'
})

app.post(
	'/upload',
	{
		schema: {
			body: {
				type: 'object',
				properties: {
					file: { type: 'object' }
				},
				required: ['file']
			}
		}
	},
	async (req, res) => {
		const file = req.body.file
		if (!file) return res.status(422).send('æœªä¸Šä¼ æ–‡ä»¶')

		const type = await fileTypeFromBuffer(file)
		if (!type || !type.mime.startsWith('image/'))
			return res.status(422).send('æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„å›¾åƒ')

		res.header('Content-Type', type.mime)
		res.send(file)
	}
)
```

:::


> Fastify ä½¿ç”¨ `fastify-multipart` å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼Œä¼ªè£… `type: object` ä»¥å…è®¸ Buffer

::: code-group

```ts [Elysia]
import { Elysia, t } from 'elysia'

const app = new Elysia()
	.post('/upload', ({ body }) => body.file, {
		body: t.Object({
			file: t.File({
				type: 'image'
			})
		})
	})
```

:::


> Elysia é€šè¿‡ `t.File` å¤„ç†æ–‡ä»¶å’Œ mimetype éªŒè¯

ç”±äº **multer** ä¸éªŒè¯ mimetypeï¼Œæ‚¨éœ€è¦ä½¿ç”¨ **file-type** æˆ–ç±»ä¼¼åº“æ‰‹åŠ¨éªŒè¯ mimetypeã€‚

è€Œ Elysia è‡ªåŠ¨éªŒè¯æ–‡ä»¶ä¸Šä¼ ï¼Œä½¿ç”¨ **file-type** è‡ªåŠ¨éªŒè¯ mimetypeã€‚

## ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

Fastify å’Œ Elysia éƒ½æœ‰ä¸€äº›ç±»ä¼¼çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œé‡‡ç”¨åŸºäºäº‹ä»¶çš„æ–¹æ³•ã€‚

### Elysia ç”Ÿå‘½å‘¨æœŸ

Elysia çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¯ä»¥å¦‚ä¸‹æ‰€ç¤ºã€‚
![Elysia ç”Ÿå‘½å‘¨æœŸå›¾](/assets/lifecycle-chart.svg)

> ç‚¹å‡»å›¾ç‰‡æ”¾å¤§

### Fastify ç”Ÿå‘½å‘¨æœŸ

Fastify çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¯ä»¥å¦‚ä¸‹æ‰€ç¤ºã€‚

```
è¾“å…¥è¯·æ±‚
  â”‚
  â””â”€â–¶ è·¯ç”±
        â”‚
        â””â”€â–¶ å®ä¾‹è®°å½•å™¨
             â”‚
   4**/5** â—€â”€â”´â”€â–¶ onRequest é’©å­
                  â”‚
        4**/5** â—€â”€â”´â”€â–¶ preParsing é’©å­
                        â”‚
              4**/5** â—€â”€â”´â”€â–¶ è§£æ
                             â”‚
                   4**/5** â—€â”€â”´â”€â–¶ preValidation é’©å­
                                  â”‚
                            400 â—€â”€â”´â”€â–¶ éªŒè¯
                                        â”‚
                              4**/5** â—€â”€â”´â”€â–¶ preHandler é’©å­
                                              â”‚
                                    4**/5** â—€â”€â”´â”€â–¶ ç”¨æˆ·å¤„ç†ç¨‹åº
                                                    â”‚
                                                    â””â”€â–¶ å›å¤
                                                          â”‚
                                                4**/5** â—€â”€â”´â”€â–¶ preSerialization é’©å­
                                                                â”‚
                                                                â””â”€â–¶ onSend é’©å­
                                                                      â”‚
                                                            4**/5** â—€â”€â”´â”€â–¶ è¾“å‡ºå“åº”
                                                                            â”‚
                                                                            â””â”€â–¶ onResponse é’©å­
```

ä¸¤è€…åœ¨æ‹¦æˆªè¯·æ±‚å’Œå“åº”ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„è¯­æ³•ä¸Šä¹Ÿç›¸ä¼¼ï¼Œç„¶è€Œ Elysia ä¸éœ€è¦æ‚¨è°ƒç”¨ `done` æ¥ç»§ç»­ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚

::: code-group

```ts [Fastify]
import fastify from 'fastify'

const app = fastify()

// å…¨å±€ä¸­é—´ä»¶
app.addHook('onRequest', (request, reply, done) => {
	console.log(`${request.method} ${request.url}`)

	done()
})

app.get(
	'/protected',
	{
		// è·¯ç”±ç‰¹å®šä¸­é—´ä»¶
		preHandler(request, reply, done) {
			const token = request.headers.authorization

			if (!token) reply.status(401).send('æœªæˆæƒ')

			done()
		}
	},
	(request, reply) => {
		reply.send('å—ä¿æŠ¤çš„è·¯ç”±')
	}
)
```

:::


> Fastify ä½¿ç”¨ `addHook` æ³¨å†Œä¸­é—´ä»¶ï¼Œå¹¶è¦æ±‚æ‚¨è°ƒç”¨ `done` ç»§ç»­ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
	// å…¨å±€ä¸­é—´ä»¶
	.onRequest(({ method, path }) => {
		console.log(`${method} ${path}`)
	})
	// è·¯ç”±ç‰¹å®šä¸­é—´ä»¶
	.get('/protected', () => 'protected', {
		beforeHandle({ status, headers }) {
  			if (!headers.authorizaton)
     			return status(401)
		}
	})
```

:::


> Elysia è‡ªåŠ¨æ£€æµ‹ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œå¹¶ä¸éœ€è¦æ‚¨è°ƒç”¨ `done` æ¥ç»§ç»­ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

## è‰¯å¥½çš„ç±»å‹å®‰å…¨

Elysia ç¡®ä¿è‰¯å¥½çš„ç±»å‹å®‰å…¨ã€‚

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [derive](/essential/life-cycle.html#derive) å’Œ [resolve](/essential/life-cycle.html#resolve) ä»¥ **ç±»å‹å®‰å…¨** çš„æ–¹å¼è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ï¼Œè€Œ Fastify åˆ™ä¸èƒ½ã€‚

::: code-group

```ts twoslash [Fastify]
// @errors: 2339
import fastify from 'fastify'

const app = fastify()

app.decorateRequest('version', 2)

app.get('/version', (req, res) => {
	res.send(req.version)
	//            ^?
})

app.get(
	'/token',
	{
		preHandler(req, res, done) {
			const token = req.headers.authorization

			if (!token) return res.status(401).send('æœªæˆæƒ')

			// @ts-ignore
			req.token = token.split(' ')[1]

			done()
		}
	},
	(req, res) => {
		req.version
		//  ^?

		res.send(req.token)
		//            ^?
	}
)

app.listen({
	port: 3000
})
```

:::


> Fastify ä½¿ç”¨ `decorateRequest`ï¼Œä½†æ²¡æœ‰æä¾›è‰¯å¥½çš„ç±»å‹å®‰å…¨

::: code-group

```ts twoslash [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
	.decorate('version', 2)
	.get('/version', ({ version }) => version)
	.resolve(({ status, headers: { authorization } }) => {
		if(!authorization?.startsWith('Bearer '))
			return status(401)

		return {
			token: authorization.split(' ')[1]
		}
	})
	.get('/token', ({ token, version }) => {
		version
		//  ^?


		return token
		//       ^?
	})
```

:::


> Elysia ä½¿ç”¨ `decorate` æ‰©å±•ä¸Šä¸‹æ–‡ï¼Œå¹¶ä½¿ç”¨ `resolve` å°†è‡ªå®šä¹‰å±æ€§æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­

è™½ç„¶ Fastify å¯ä»¥ä½¿ç”¨ `declare module` æ‰©å±• `FastifyRequest` æ¥å£ï¼Œä½†å®ƒæ˜¯å…¨å±€å¯ç”¨çš„ï¼Œå¹¶ä¸”æ²¡æœ‰è‰¯å¥½çš„ç±»å‹å®‰å…¨ï¼Œä¹Ÿæ— æ³•ä¿è¯è¯¥å±æ€§åœ¨æ‰€æœ‰è¯·æ±‚å¤„ç†ç¨‹åºä¸­éƒ½å¯ç”¨ã€‚

```ts
declare module 'fastify' {
  	interface FastifyRequest {
    	version: number
  		token: string
  	}
}
```

> è¿™æ˜¯ä»¥ä¸Š Fastify ç¤ºä¾‹æ­£å¸¸å·¥ä½œçš„å¿…è¦æ¡ä»¶ï¼Œä½†å¹¶æ²¡æœ‰æä¾›è‰¯å¥½çš„ç±»å‹å®‰å…¨

## ä¸­é—´ä»¶å‚æ•°

Fastify ä½¿ç”¨å‡½æ•°è¿”å› Fastify æ’ä»¶å®šä¹‰å‘½åä¸­é—´ä»¶ï¼Œè€Œ Elysia ä½¿ç”¨ [macro](/patterns/macro) å®šä¹‰è‡ªå®šä¹‰é’©å­ã€‚

::: code-group

```ts twoslash [Fastify]
const findUser = (authorization?: string) => {
	return {
		name: 'Jane Doe',
		role: 'admin' as const
	}
}
// ---cut---
// @errors: 2339
import fastify from 'fastify'
import type { FastifyRequest, FastifyReply } from 'fastify'

const app = fastify()

const role =
	(role: 'user' | 'admin') =>
	(request: FastifyRequest, reply: FastifyReply, next: Function) => {
		const user = findUser(request.headers.authorization)

		if (user.role !== role) return reply.status(401).send('æœªæˆæƒ')

		// @ts-ignore
		request.user = user

		next()
	}

app.get(
	'/token',
	{
		preHandler: role('admin')
	},
	(request, reply) => {
		reply.send(request.user)
		//            ^?
	}
)
```

:::


> Fastify ä½¿ç”¨å‡½æ•°å›è°ƒæ¥å—ä¸­é—´ä»¶çš„è‡ªå®šä¹‰å‚æ•°

::: code-group

```ts twoslash [Elysia]
const findUser = (authorization?: string) => {
	return {
		name: 'Jane Doe',
		role: 'admin' as const
	}
}
// ---cut---
import { Elysia } from 'elysia'

const app = new Elysia()
	.macro({
		role: (role: 'user' | 'admin') => ({
			resolve({ status, headers: { authorization } }) {
				const user = findUser(authorization)

				if(user.role !== role)
					return status(401)

				return {
					user
				}
			}
		})
	})
	.get('/token', ({ user }) => user, {
	//                 ^?
		role: 'admin'
	})
```

:::


> Elysia ä½¿ç”¨å®ä¼ é€’è‡ªå®šä¹‰å‚æ•°ç»™è‡ªå®šä¹‰ä¸­é—´ä»¶

è™½ç„¶ Fastify ä½¿ç”¨å‡½æ•°å›è°ƒï¼Œä½†å®ƒéœ€è¦è¿”å›ä¸€ä¸ªæ”¾ç½®åœ¨äº‹ä»¶å¤„ç†ç¨‹åºä¸­çš„å‡½æ•°æˆ–è¡¨ç¤ºé’©å­çš„å¯¹è±¡ï¼Œè¿™åœ¨éœ€è¦å¤šä¸ªè‡ªå®šä¹‰å‡½æ•°æ—¶å¯èƒ½å¾ˆéš¾å¤„ç†ï¼Œå› ä¸ºæ‚¨éœ€è¦å°†å®ƒä»¬åˆå¹¶åˆ°ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚

## é”™è¯¯å¤„ç†

Fastify å’Œ Elysia éƒ½æä¾›ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æ¥å¤„ç†é”™è¯¯ã€‚

::: code-group

```ts
import fastify from 'fastify'

const app = fastify()

class CustomError extends Error {
	constructor(message: string) {
		super(message)
		this.name = 'CustomError'
	}
}

// å…¨å±€é”™è¯¯å¤„ç†ç¨‹åº
app.setErrorHandler((error, request, reply) => {
	if (error instanceof CustomError)
		reply.status(500).send({
			message: 'å‡ºç°é—®é¢˜ï¼',
			error
		})
})

app.get(
	'/error',
	{
		// è·¯ç”±ç‰¹å®šé”™è¯¯å¤„ç†ç¨‹åº
		errorHandler(error, request, reply) {
			reply.send({
				message: 'ä»…æ­¤è·¯ç”±é€‚ç”¨ï¼',
				error
			})
		}
	},
	(request, reply) => {
		throw new CustomError('å“¦ uh')
	}
)
```

:::


> Fastify ä½¿ç”¨ `setErrorHandler` ä½œä¸ºå…¨å±€é”™è¯¯å¤„ç†ç¨‹åºï¼Œä»¥åŠä½¿ç”¨ `errorHandler` ä½œä¸ºè·¯ç”±ç‰¹å®šé”™è¯¯å¤„ç†ç¨‹åº

::: code-group

```ts twoslash [Elysia]
import { Elysia } from 'elysia'

class CustomError extends Error {
	// å¯é€‰ï¼šè‡ªå®šä¹‰ HTTP çŠ¶æ€ç 
	status = 500

	constructor(message: string) {
		super(message)
		this.name = 'CustomError'
	}

	// å¯é€‰ï¼šåº”å°†ä»€ä¹ˆå‘é€ç»™å®¢æˆ·ç«¯
	toResponse() {
		return {
			message: "å¦‚æœæ‚¨çœ‹åˆ°æ­¤æ¶ˆæ¯ï¼Œæˆ‘ä»¬çš„å¼€å‘äººå‘˜å¿˜è®°å¤„ç†æ­¤é”™è¯¯",
			error: this
		}
	}
}

const app = new Elysia()
	// å¯é€‰ï¼šæ³¨å†Œè‡ªå®šä¹‰é”™è¯¯ç±»
	.error({
		CUSTOM: CustomError,
	})
	// å…¨å±€é”™è¯¯å¤„ç†ç¨‹åº
	.onError(({ error, code }) => {
		if(code === 'CUSTOM')
		// ^?




			return {
				message: 'å‡ºç°é—®é¢˜ï¼',
				error
			}
	})
	.get('/error', () => {
		throw new CustomError('å“¦ uh')
	}, {
		// å¯é€‰ï¼šè·¯ç”±ç‰¹å®šé”™è¯¯å¤„ç†ç¨‹åº
		error({ error }) {
			return {
				message: 'ä»…æ­¤è·¯ç”±é€‚ç”¨ï¼',
				error
			}
		}
	})
```

:::


> Elysia æä¾›è‡ªå®šä¹‰é”™è¯¯ä»£ç ï¼Œç®€å†™ HTTP çŠ¶æ€å’Œ `toResponse` ç”¨äºå°†é”™è¯¯æ˜ å°„åˆ°å“åº”ã€‚

è™½ç„¶ä¸¤è€…éƒ½åœ¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸­æä¾›é”™è¯¯å¤„ç†ï¼Œä½† Elysia è¿˜æä¾›ï¼š

1. è‡ªå®šä¹‰é”™è¯¯ä»£ç 
2. æ˜¾ç¤ºæ˜ å°„ HTTP çŠ¶æ€å’Œ `toResponse` ç”¨äºå°†é”™è¯¯æ˜ å°„åˆ°å“åº”

é”™è¯¯ä»£ç å¯¹æ—¥å¿—è®°å½•å’Œè°ƒè¯•éå¸¸æœ‰ç”¨ï¼Œå¹¶ä¸”åœ¨åŒºåˆ†æ‰©å±•ç›¸åŒç±»çš„ä¸åŒé”™è¯¯ç±»å‹æ—¶å¾ˆé‡è¦ã€‚

Elysia æä¾›äº†æ‰€æœ‰è¿™äº›ç±»å‹å®‰å…¨ï¼Œè€Œ Fastify åˆ™æ²¡æœ‰ã€‚

## å°è£…

Fastify å°è£…æ’ä»¶çš„å‰¯ä½œç”¨ï¼Œè€Œ Elysia é€šè¿‡æ˜¾å¼ä½œç”¨åŸŸæœºåˆ¶å’Œä»£ç é¡ºåºæ§åˆ¶æ’ä»¶çš„å‰¯ä½œç”¨ã€‚

::: code-group

```ts [Fastify]
import fastify from 'fastify'
import type { FastifyPluginCallback } from 'fastify'

const subRouter: FastifyPluginCallback = (app, opts, done) => {
	app.addHook('preHandler', (request, reply) => {
		if (!request.headers.authorization?.startsWith('Bearer '))
			reply.code(401).send({ error: 'æœªæˆæƒ' })
	})

	done()
}

const app = fastify()
	.get('/', (request, reply) => {
		reply.send('Hello World')
	})
	.register(subRouter)
	// æ²¡æœ‰æ¥è‡ª subRouter çš„å‰¯ä½œç”¨
	.get('/side-effect', () => 'hi')
```

:::


> Fastify å°è£…æ’ä»¶çš„å‰¯ä½œç”¨

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia()
	.onBeforeHandle(({ status, headers: { authorization } }) => {
		if(!authorization?.startsWith('Bearer '))
			return status(401)
   	})

const app = new Elysia()
    .get('/', 'Hello World')
    .use(subRouter)
    // æ²¡æœ‰æ¥è‡ª subRouter çš„å‰¯ä½œç”¨
    .get('/side-effect', () => 'hi')
```

:::


> Elysia é™¤éæ˜¾å¼å£°æ˜ï¼Œå¦åˆ™ä¸ä¼šæœ‰æ’ä»¶çš„å‰¯ä½œç”¨

ä¸¤è€…éƒ½æœ‰æ’ä»¶çš„å°è£…æœºåˆ¶ï¼Œä»¥é˜²æ­¢å‰¯ä½œç”¨ã€‚

ç„¶è€Œï¼ŒElysia å¯ä»¥æ˜¾å¼å£°æ˜å“ªä¸ªæ’ä»¶åº”è¯¥æœ‰å‰¯ä½œç”¨ï¼Œé€šè¿‡å£°æ˜ä¸€ä¸ªä½œç”¨åŸŸï¼Œè€Œ Fastify å§‹ç»ˆå¯¹æ­¤è¿›è¡Œå°è£…ã€‚

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia()
	.onBeforeHandle(({ status, headers: { authorization } }) => {
		if(!authorization?.startsWith('Bearer '))
			return status(401)
   	})
	// ä»…é™äºçˆ¶å®ä¾‹çš„ä½œç”¨åŸŸï¼Œä½†ä¸è¶…å‡º
	.as('scoped') // [!code ++]

const app = new Elysia()
    .get('/', 'Hello World')
    .use(subRouter)
    // [!code ++]
    // ç°åœ¨æœ‰æ¥è‡ª subRouter çš„å‰¯ä½œç”¨
    .get('/side-effect', () => 'hi')
```

Elysia æä¾› 3 ç§ç±»å‹çš„ä½œç”¨åŸŸæœºåˆ¶ï¼š

1. **local** - ä»…é€‚ç”¨äºå½“å‰å®ä¾‹ï¼Œæ— å‰¯ä½œç”¨ï¼ˆé»˜è®¤ï¼‰
2. **scoped** - å°†å‰¯ä½œç”¨é™åˆ¶åˆ°çˆ¶å®ä¾‹ï¼Œä½†ä¸è¶…å‡º
3. **global** - å½±å“æ‰€æœ‰å®ä¾‹

***

ç”±äº Fastify ä¸æä¾›ä½œç”¨åŸŸæœºåˆ¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

1. ä¸ºæ¯ä¸ªé’©å­åˆ›å»ºä¸€ä¸ªå‡½æ•°å¹¶æ‰‹åŠ¨é™„åŠ 
2. ä½¿ç”¨é«˜é˜¶å‡½æ•°ï¼Œå¹¶å°†å…¶åº”ç”¨åˆ°éœ€è¦æ•ˆæœçš„å®ä¾‹

ç„¶è€Œï¼Œè¿™å¯èƒ½å¯¼è‡´åœ¨å¤„ç†ä¸å½“çš„æƒ…å†µä¸‹äº§ç”Ÿé‡å¤çš„å‰¯ä½œç”¨ã€‚

```ts
import fastify from 'fastify'
import type {
	FastifyRequest,
	FastifyReply,
	FastifyPluginCallback
} from 'fastify'

const log = (request: FastifyRequest, reply: FastifyReply, done: Function) => {
	console.log('ä¸­é—´ä»¶å·²æ‰§è¡Œ')

	done()
}

const app = fastify()

app.addHook('onRequest', log)
app.get('/main', (request, reply) => {
	reply.send('æ¥è‡ªä¸»è·¯ç”±çš„é—®å€™ï¼')

})

const subRouter: FastifyPluginCallback = (app, opts, done) => {
	app.addHook('onRequest', log)

	// è¿™å°†è®°å½•ä¸¤æ¬¡
	app.get('/sub', (request, reply) => {
		return reply.send('æ¥è‡ªå­è·¯ç”±çš„é—®å€™ï¼')
	})

	done()
}

app.register(subRouter, {
	prefix: '/sub'
})

app.listen({
	port: 3000
})
```

åœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼ŒElysia æä¾›äº†ä¸€ä¸ªæ’ä»¶å»é‡æœºåˆ¶ï¼Œä»¥é˜²æ­¢é‡å¤çš„å‰¯ä½œç”¨ã€‚

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia({ name: 'subRouter' }) // [!code ++]
	.onBeforeHandle(({ status, headers: { authorization } }) => {
		if(!authorization?.startsWith('Bearer '))
			return status(401)
   	})
	.as('scoped')

const app = new Elysia()
	.get('/', 'Hello World')
	.use(subRouter)
	.use(subRouter) // [!code ++]
	.use(subRouter) // [!code ++]
	.use(subRouter) // [!code ++]
	// å‰¯ä½œç”¨åªè°ƒç”¨ä¸€æ¬¡
	.get('/side-effect', () => 'hi')
```

é€šè¿‡ä½¿ç”¨å”¯ä¸€çš„ `name`ï¼ŒElysia å°†æ’ä»¶ä»…åº”ç”¨ä¸€æ¬¡ï¼Œè€Œä¸ä¼šå¯¼è‡´é‡å¤çš„å‰¯ä½œç”¨ã€‚

## Cookie

Fastify ä½¿ç”¨ `@fastify/cookie` æ¥è§£æ cookiesï¼Œè€Œ Elysia åˆ™å†…ç½®æ”¯æŒ cookiesï¼Œä½¿ç”¨åŸºäºä¿¡å·çš„æ–¹æ³•å¤„ç† cookiesã€‚

::: code-group

```ts [Fastify]
import fastify from 'fastify'
import cookie from '@fastify/cookie'

const app = fastify()

app.use(cookie, {
	secret: 'secret',
	hook: 'onRequest'
})

app.get('/', function (request, reply) {
	request.unsignCookie(request.cookies.name)

	reply.setCookie('name', 'value', {
      	path: '/',
      	signed: true
    })
})
```

:::


> Fastify ä½¿ç”¨ `unsignCookie` éªŒè¯ cookie ç­¾åï¼Œä½¿ç”¨ `setCookie` è®¾ç½® cookie

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia({
	cookie: {
		secret: 'secret'
	}
})
	.get('/', ({ cookie: { name } }) => {
		// ç­¾åéªŒè¯è‡ªåŠ¨å¤„ç†
		name.value

		// cookie ç­¾åè‡ªåŠ¨ç­¾å
		name.value = 'value'
		name.maxAge = 1000 * 60 * 60 * 24
	})
```

:::


> Elysia ä½¿ç”¨åŸºäºä¿¡å·çš„æ–¹æ³•å¤„ç† cookiesï¼Œç­¾åéªŒè¯è‡ªåŠ¨å¤„ç†

## OpenAPI

ä¸¤è€…éƒ½æä¾›åŸºäº Swagger çš„ OpenAPI æ–‡æ¡£ï¼Œä½† Elysia é»˜è®¤é‡‡ç”¨ Scalar UIï¼Œè¿™æ˜¯ä¸€ç§æ›´ç°ä»£ä¸”ç”¨æˆ·å‹å¥½çš„ OpenAPI æ–‡æ¡£ç•Œé¢ã€‚

::: code-group

```ts [Fastify]
import fastify from 'fastify'
import swagger from '@fastify/swagger'

const app = fastify()
app.register(swagger, {
	openapi: '3.0.0',
	info: {
		title: 'æˆ‘çš„ API',
		version: '1.0.0'
	}
})

app.addSchema({
	$id: 'user',
	type: 'object',
	properties: {
		name: {
			type: 'string',
			description: 'ä»…é™åå­—'
		},
		age: { type: 'integer' }
	},
	required: ['name', 'age']
})

app.post(
	'/users',
	{
		schema: {
			summary: 'åˆ›å»ºç”¨æˆ·',
			body: {
				$ref: 'user#'
			},
			response: {
				'201': {
					$ref: 'user#'
				}
			}
		}
	},
	(req, res) => {
		res.status(201).send(req.body)
	}
)

await fastify.ready()
fastify.swagger()
```

:::


> Fastify ä½¿ç”¨ `@fastify/swagger` è¿›è¡Œ OpenAPI æ–‡æ¡£çš„ç”Ÿæˆ

::: code-group

```ts twoslash [Elysia]
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi' // [!code ++]

const app = new Elysia()
	.use(openapi()) // [!code ++]
	.model({
		user: t.Array(
			t.Object({
				name: t.String(),
				age: t.Number()
			})
		)
	})
	.post('/users', ({ body }) => body, {
	//                  ^?
		body: 'user',
		response: {
			201: 'user'
		},
		detail: {
			summary: 'åˆ›å»ºç”¨æˆ·'
		}
	})
```

:::


> Elysia ä½¿ç”¨ `@elysiajs/swagger` è¿›è¡Œ OpenAPI æ–‡æ¡£ç”Ÿæˆï¼Œé»˜è®¤ä½¿ç”¨ Scalarï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨ Swagger

ä¸¤è€…éƒ½æä¾›ä½¿ç”¨ `$ref` çš„æ¨¡å‹å¼•ç”¨ä»¥ç”Ÿæˆ OpenAPI æ–‡æ¡£ï¼Œç„¶è€Œ Fastify ä¸æä¾›ç±»å‹å®‰å…¨å’Œä¸ºæ¨¡å‹åç§°æŒ‡å®šæ—¶çš„è‡ªåŠ¨è¡¥å…¨ï¼Œè€Œ Elysia æä¾›ã€‚

## æµ‹è¯•

Fastify å†…ç½®æ”¯æŒæµ‹è¯•ï¼Œä½¿ç”¨ `fastify.inject()` **æ¨¡æ‹Ÿ** ç½‘ç»œè¯·æ±‚ï¼Œè€Œ Elysia ä½¿ç”¨ Web æ ‡å‡† API è¿›è¡Œ **å®é™…** è¯·æ±‚ã€‚

::: code-group

```ts [Fastify]
import fastify from 'fastify'
import request from 'supertest'
import { describe, it, expect } from 'vitest'

function build(opts = {}) {
  	const app = fastify(opts)

  	app.get('/', async function (request, reply) {
	    reply.send({ hello: 'world' })
	})

  	return app
}

describe('GET /', () => {
	it('åº”è¯¥è¿”å› Hello World', async () => {
  		const app = build()

		const response = await app.inject({
		    url: '/',
		    method: 'GET',
	  })

		expect(res.status).toBe(200)
		expect(res.text).toBe('Hello World')
	})
})
```

:::


> Fastify ä½¿ç”¨ `fastify.inject()` æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'
import { describe, it, expect } from 'vitest'

const app = new Elysia()
	.get('/', 'Hello World')

describe('GET /', () => {
	it('åº”è¯¥è¿”å› Hello World', async () => {
		const res = await app.handle(
			new Request('http://localhost')
		)

		expect(res.status).toBe(200)
		expect(await res.text()).toBe('Hello World')
	})
})
```

:::


> Elysia ä½¿ç”¨ Web æ ‡å‡† API å¤„ç† **å®é™…** è¯·æ±‚

æ­¤å¤–ï¼ŒElysia è¿˜æä¾›äº†ä¸€ä¸ªåä¸º [Eden](/eden/overview) çš„å¸®åŠ©åº“ï¼Œæä¾›ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ï¼Œå…è®¸æˆ‘ä»¬åœ¨æµ‹è¯•æ—¶è·å¾—è‡ªåŠ¨è¡¥å…¨å’Œå®Œå…¨çš„ç±»å‹å®‰å…¨ã€‚

```ts twoslash [Elysia]
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'
import { describe, expect, it } from 'bun:test'

const app = new Elysia().get('/hello', 'Hello World')
const api = treaty(app)

describe('GET /', () => {
	it('åº”è¯¥è¿”å› Hello World', async () => {
		const { data, error, status } = await api.hello.get()

		expect(status).toBe(200)
		expect(data).toBe('Hello World')
		//      ^?
	})
})
```

## ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨

Elysia æä¾›å†…ç½®æ”¯æŒ **ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨**ï¼Œæ— éœ€ä»£ç ç”Ÿæˆï¼ŒFastify åˆ™æ²¡æœ‰æ­¤åŠŸèƒ½ã€‚

::: code-group

```ts twoslash [Elysia]
import { Elysia, t } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
	.post('/mirror', ({ body }) => body, {
		body: t.Object({
			message: t.String()
		})
	})

const api = treaty(app)

const { data, error } = await api.mirror.post({
	message: 'Hello World'
})

if(error)
	throw error
	//     ^?














console.log(data)
//          ^?



// ---cut-after---
console.log('ok')
```

:::

å¦‚æœç«¯åˆ°ç«¯ç±»å‹å®‰å…¨å¯¹æ‚¨è€Œè¨€å¾ˆé‡è¦ï¼Œåˆ™ Elysia æ˜¯æ‚¨çš„æ­£ç¡®é€‰æ‹©ã€‚

***

Elysia æä¾›äº†æ›´ç¬¦åˆäººä½“å·¥ç¨‹å­¦å’Œå¼€å‘äººå‘˜å‹å¥½çš„ä½“éªŒï¼Œä¸“æ³¨äºæ€§èƒ½ã€ç±»å‹å®‰å…¨å’Œç®€å•æ€§ï¼Œè€Œ Fastify æ˜¯ä¸€ä¸ªæˆç†Ÿçš„ Node.js æ¡†æ¶ï¼Œä½†æ²¡æœ‰æä¾› **è‰¯å¥½çš„ç±»å‹å®‰å…¨** å’Œ **ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨** ã€‚

å¦‚æœæ‚¨æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªæ˜“äºä½¿ç”¨ã€å…·æœ‰è‰¯å¥½å¼€å‘ä½“éªŒï¼Œå¹¶å»ºç«‹åœ¨ Web æ ‡å‡† API ä¹‹ä¸Šçš„æ¡†æ¶ï¼ŒElysia æ˜¯æ‚¨çš„ç†æƒ³é€‰æ‹©ã€‚

å¦å¤–ï¼Œå¦‚æœæ‚¨æ¥è‡ªå…¶ä»–æ¡†æ¶ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹ï¼š

---

---
url: 'https://elysiajs.com/migrate/from-hono.md'
---

# ä» Hono åˆ° Elysia

æœ¬æŒ‡å—é€‚ç”¨äºå¸Œæœ›äº†è§£ Elysia ä¸ Hono ä¹‹é—´çš„å·®å¼‚ï¼ŒåŒ…æ‹¬è¯­æ³•ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ç¤ºä¾‹å°†åº”ç”¨ç¨‹åºä» Hono è¿ç§»åˆ° Elysia çš„ Hono ç”¨æˆ·ã€‚

**Hono** æ˜¯ä¸€ä¸ªå¿«é€Ÿä¸”è½»é‡çš„ç½‘ç»œæ¡†æ¶ï¼ŒåŸºäº Web æ ‡å‡†æ„å»ºã€‚å®ƒä¸å¤šç§è¿è¡Œæ—¶å…·æœ‰å¹¿æ³›çš„å…¼å®¹æ€§ï¼Œå¦‚ Denoã€Bunã€Cloudflare Workers å’Œ Node.jsã€‚

**Elysia** æ˜¯ä¸€ä¸ªç¬¦åˆäººä½“å·¥å­¦çš„ Web æ¡†æ¶ã€‚ä¸“ä¸ºå¼€å‘è€…ä½“éªŒè®¾è®¡ï¼Œæ³¨é‡**ä¸¥æ ¼ç±»å‹å®‰å…¨**å’Œæ€§èƒ½ã€‚ä¸ä»…é™äº Bunï¼ŒElysia è¿˜æ”¯æŒå¤šç§è¿è¡Œæ—¶ï¼Œå¦‚ Node.js å’Œ Cloudflare Workersã€‚

## é€‚ç”¨åœºæ™¯

ä»¥ä¸‹æ˜¯ Hono å’Œ Elysia çš„ç®€è¦å¯¹æ¯”ï¼Œå¸®åŠ©ä½ åšå‡ºé€‰æ‹©ï¼š

**Hono**

* **æœ€åˆä¸º Cloudflare Workers æ„å»º**ï¼Œä¸ Cloudflare ç”Ÿæ€ç³»ç»Ÿé›†æˆåº¦æ›´é«˜
* æ”¯æŒå¤šç§åŸºäº Web æ ‡å‡†çš„è¿è¡Œæ—¶ï¼ŒåŒ…æ‹¬ **Node.js** å’Œ **Bun**
* è½»é‡ä¸”æç®€ï¼Œé€‚åˆè¾¹ç¼˜ç¯å¢ƒ
* æ”¯æŒ OpenAPIï¼Œä½†éœ€è¦é¢å¤–å·¥ä½œæ¥æè¿°è§„èŒƒ
* å€¾å‘äºç®€å•ã€çº¿æ€§çš„ä¸­é—´ä»¶æ–¹å¼
* ç±»å‹å®‰å…¨æ€§ä¼˜äºå¤§å¤šæ•°æ¡†æ¶ï¼Œä½†åœ¨æŸäº›æ–¹é¢å¹¶ä¸å®Œå…¨å¯é 
* åœ¨ä¸­é—´ä»¶å’Œæ’ä»¶é£æ ¼ä¸Šä¸ Expressã€Koa æœ‰äº›ç›¸ä¼¼

**Elysia**

* **æœ€åˆä¸ºåŸç”Ÿ Bun æ„å»º**ï¼Œæœ€å¤§é™åº¦åœ°åˆ©ç”¨ Bun çš„å¤§éƒ¨åˆ†åŠŸèƒ½
* æ”¯æŒå¤šç§è¿è¡Œæ—¶å’Œ Web æ ‡å‡†ï¼ŒåŒ…æ‹¬ **Node.sjs** å’Œ **Cloudflare Worker**
* **æ›´å¥½çš„æ€§èƒ½**ã€‚é€šè¿‡ JIT å€¾å‘äºé•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡å™¨ã€‚
* **æ›´å¥½çš„ OpenAPI æ”¯æŒ**ï¼Œå¸¦æ¥æ— ç¼ä½“éªŒï¼Œç‰¹åˆ«æ˜¯ä¸ [OpenAPI Type Gen](/patterns/openapi#openapi-from-types) é…åˆä½¿ç”¨æ—¶
* æ›´å€¾å‘äºåŸºäºäº‹ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ§åˆ¶è¯·æ±‚ç®¡é“
* å…¨é¢å®ç°ç±»å‹å®‰å…¨ï¼ŒåŒ…æ‹¬ä¸­é—´ä»¶å’Œé”™è¯¯å¤„ç†
* åœ¨ä¸­é—´ä»¶ã€å°è£…å’Œæ’ä»¶é£æ ¼æ–¹é¢ä¸ Fastify æœ‰äº›ç›¸ä¼¼

åœ¨â€œå…¼å®¹æŸç‰©â€å’Œâ€œä¸“ä¸ºæŸç‰©æ„å»ºâ€ä¹‹é—´æœ‰å¾ˆå¤§çš„åŒºåˆ«ã€‚

å¦‚æœä½ å†³å®šåœ¨ Cloudflare Workers ä¸Šä½¿ç”¨ Elysiaï¼Œä½ å¯èƒ½ä¼šé”™è¿‡ Hono æä¾›çš„ä¸€äº› Cloudflare ç‰¹å®šåŠŸèƒ½ã€‚åŒæ ·åœ°ï¼Œå¦‚æœä½ åœ¨ Bun ä¸Šä½¿ç”¨ Honoï¼Œä¸ä½ ä½¿ç”¨ Elysia ç›¸æ¯”ï¼Œå¯èƒ½æ— æ³•è·å¾—æœ€ä½³æ€§èƒ½ã€‚

## æ€§èƒ½

ç”±äºé™æ€ä»£ç åˆ†æï¼ŒElysia åœ¨æ€§èƒ½ä¸Šç›¸è¾ƒ Hono æœ‰æ˜¾è‘—æå‡ã€‚

## è·¯ç”±

Hono å’Œ Elysia çš„è·¯ç”±è¯­æ³•ç›¸ä¼¼ï¼Œä½¿ç”¨ `app.get()` å’Œ `app.post()` æ–¹æ³•æ¥å®šä¹‰è·¯ç”±ï¼Œå¹¶é‡‡ç”¨ç±»ä¼¼çš„è·¯å¾„å‚æ•°è¯­æ³•ã€‚

ä¸¤è€…éƒ½ä½¿ç”¨å•ä¸ª `Context` å‚æ•°æ¥å¤„ç†è¯·æ±‚å’Œå“åº”ï¼Œå¹¶ç›´æ¥è¿”å›å“åº”ã€‚

::: code-group

```ts [Hono]
import { Hono } from 'hono'

const app = new Hono()

app.get('/', (c) => {
    return c.text('Hello World')
})

app.post('/id/:id', (c) => {
    c.status(201)
    return c.text(req.params.id)
})

export default app
```

:::


> Hono ä½¿ç”¨è¾…åŠ©å‡½æ•° `c.text`ã€`c.json` è¿”å›å“åº”

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
    .get('/', 'Hello World')
    .post(
        '/id/:id',
        ({ status, params: { id } }) => {
            return status(201, id)
        }
    )
    .listen(3000)
```

:::


> Elysia ä½¿ç”¨å•ä¸ª `context` å¹¶ç›´æ¥è¿”å›å“åº”

è™½ç„¶ Hono ä½¿ç”¨ `c.text` å’Œ `c.json` æ¥åŒ…è£…å“åº”ï¼ŒElysia åˆ™è‡ªåŠ¨å°†å€¼æ˜ å°„åˆ°å“åº”ã€‚

åœ¨æ ·å¼æŒ‡å—ä¸Šæœ‰è½»å¾®å·®å¼‚ï¼ŒElysia æ¨èä½¿ç”¨æ–¹æ³•é“¾å’Œå¯¹è±¡è§£æ„ã€‚

Hono çš„ç«¯å£åˆ†é…ä¾èµ–äºè¿è¡Œæ—¶å’Œé€‚é…å™¨ï¼Œè€Œ Elysia ä½¿ç”¨å•ä¸ª `listen` æ–¹æ³•æ¥å¯åŠ¨æœåŠ¡å™¨ã€‚

## å¤„ç†ç¨‹åº

Hono ä½¿ç”¨åŠŸèƒ½æ‰‹åŠ¨è§£ææŸ¥è¯¢ã€å¤´å’Œä¸»ä½“ï¼Œè€Œ Elysia è‡ªåŠ¨è§£æå±æ€§ã€‚

::: code-group

```ts [Hono]
import { Hono } from 'hono'

const app = new Hono()

app.post('/user', async (c) => {
    const limit = c.req.query('limit')
    const { name } = await c.body()
    const auth = c.req.header('authorization')

    return c.json({ limit, name, auth })
})
```

:::


> Hono è‡ªåŠ¨è§£æä¸»ä½“ï¼Œä½†ä¸é€‚ç”¨äºæŸ¥è¯¢å’Œå¤´

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
    .post('/user', (ctx) => {
        const limit = ctx.query.limit
        const name = ctx.body.name
        const auth = ctx.headers.authorization

        return { limit, name, auth }
    })
```

:::


> Elysia ä½¿ç”¨é™æ€ä»£ç åˆ†ææ¥åˆ†æè¦è§£æçš„å†…å®¹

Elysia ä½¿ç”¨ **é™æ€ä»£ç åˆ†æ** æ¥ç¡®å®šè¦è§£æçš„å†…å®¹ï¼Œä»…è§£ææ‰€éœ€çš„å±æ€§ã€‚

è¿™å¯¹æ€§èƒ½å’Œç±»å‹å®‰å…¨éå¸¸æœ‰ç”¨ã€‚

## å­è·¯ç”±

ä¸¤è€…éƒ½å¯ä»¥ä½œä¸ºè·¯ç”±å™¨ç»§æ‰¿å¦ä¸€ä¸ªå®ä¾‹ï¼Œä½† Elysia å°†æ¯ä¸ªå®ä¾‹è§†ä¸ºå¯ç”¨ä½œå­è·¯ç”±å™¨çš„ç»„ä»¶ã€‚

::: code-group

```ts [Hono]
import { Hono } from 'hono'

const subRouter = new Hono()

subRouter.get('/user', (c) => {
    return c.text('Hello User')
})

const app = new Hono()

app.route('/api', subRouter)
```

:::


> Hono **éœ€è¦** å‰ç¼€æ¥åˆ†éš”å­è·¯ç”±å™¨

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia({ prefix: '/api' })
    .get('/user', 'Hello User')

const app = new Elysia()
    .use(subRouter)
```

:::


> Elysia ä½¿ç”¨å¯é€‰å‰ç¼€æ„é€ å‡½æ•°æ¥å®šä¹‰å‰ç¼€

è™½ç„¶ Hono éœ€è¦å‰ç¼€æ¥åˆ†éš”å­è·¯ç”±å™¨ï¼Œä½† Elysia ä¸éœ€è¦å‰ç¼€ã€‚

## éªŒè¯

è™½ç„¶ Hono é€šè¿‡å¤–éƒ¨åŒ…æ”¯æŒå„ç§éªŒè¯å™¨ï¼ŒElysia å†…ç½®äº†åŸºäº **TypeBox** çš„éªŒè¯ï¼Œå¹¶å¼€ç®±å³ç”¨æ”¯æŒæ ‡å‡†æ¨¡å¼ï¼ˆStandard Schemaï¼‰ï¼Œå…è®¸æ‚¨ç›´æ¥ä½¿ç”¨å–œæ¬¢çš„åº“ï¼Œå¦‚ Zodã€Valibotã€ArkTypeã€Effect Schema ç­‰ï¼Œæ— éœ€é¢å¤–åº“ã€‚Elysia è¿˜æä¾›ä¸ OpenAPI çš„æ— ç¼é›†æˆåŠå¹•åç±»å‹æ¨æ–­ã€‚

::: code-group

```ts [Hono]
import { Hono } from 'hono'
import { zValidator } from '@hono/zod-validator'
import { z } from 'zod'

const app = new Hono()

app.patch(
    '/user/:id',
    zValidator(
        'param',
        z.object({
            id: z.coerce.number()
        })
    ),
    zValidator(
        'json',
        z.object({
            name: z.string()
        })
    ),
    (c) => {
        return c.json({
            params: c.req.param(),
            body: c.req.json()
        })
    }
)
```

:::


> Hono ä½¿ç”¨åŸºäºç®¡é“çš„æ–¹å¼

::: code-group

```ts twoslash [Elysia TypeBox]
import { Elysia, t } from 'elysia'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: t.Object({
			id: t.Number()
		}),
		body: t.Object({
			name: t.String()
		})
	})
```

```ts twoslash [Elysia Zod]
import { Elysia } from 'elysia'
import { z } from 'zod'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: z.object({
			id: z.number()
		}),
		body: z.object({
			name: z.string()
		})
	})
```

```ts twoslash [Elysia Valibot]
import { Elysia } from 'elysia'
import * as v from 'valibot'

const app = new Elysia()
	.patch('/user/:id', ({ params, body }) => ({
		params,
		body
	}),
	{
		params: v.object({
			id: v.number()
		}),
		body: v.object({
			name: v.string()
		})
	})
```

:::


> Elysia ä½¿ç”¨ TypeBox è¿›è¡ŒéªŒè¯ï¼Œå¹¶è‡ªåŠ¨è½¬æ¢ç±»å‹ã€‚åŒæ—¶ä¹Ÿæ”¯æŒå¦‚ Zodã€Valibot çš„å„ç§éªŒè¯åº“ï¼Œä¸”è¯­æ³•ä¸€è‡´ã€‚

ä¸¤è€…éƒ½è‡ªåŠ¨ä»æ¨¡å¼æ¨æ–­ç±»å‹åˆ°ä¸Šä¸‹æ–‡ã€‚

## æ–‡ä»¶ä¸Šä¼ 

Hono å’Œ Elysia éƒ½ä½¿ç”¨ Web æ ‡å‡† API å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼Œä½† Elysia å…·æœ‰å†…ç½®çš„å£°æ˜å¼æ”¯æŒï¼Œä½¿ç”¨ **file-type** éªŒè¯ MIME ç±»å‹ã€‚

::: code-group

```ts [Hono]
import { Hono } from 'hono'
import { z } from 'zod'
import { zValidator } from '@hono/zod-validator'

import { fileTypeFromBlob } from 'file-type'

const app = new Hono()

app.post(
    '/upload',
    zValidator(
        'form',
        z.object({
            file: z.instanceof(File)
        })
    ),
    async (c) => {
        const body = await c.req.parseBody()

        const type = await fileTypeFromBlob(body.image as File)
        if (!type || !type.mime.startsWith('image/')) {
            c.status(422)
            return c.text('File is not a valid image')
        }

        return new Response(body.image)
    }
)
```

:::


> Hono éœ€è¦å•ç‹¬çš„ `file-type` åº“æ¥éªŒè¯ MIME ç±»å‹

::: code-group

```ts [Elysia]
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .post('/upload', ({ body }) => body.file, {
        body: t.Object({
            file: t.File({
                type: 'image'
            })
        })
    })
```

:::


> Elysia ä»¥å£°æ˜æ–¹å¼å¤„ç†æ–‡ä»¶å’Œ MIME ç±»å‹éªŒè¯

ç”±äº Web æ ‡å‡† API ä¸éªŒè¯ MIME ç±»å‹ï¼Œå› æ­¤ä¿¡ä»»å®¢æˆ·ç«¯æä¾›çš„ `content-type` å¯èƒ½å­˜åœ¨å®‰å…¨é£é™©ï¼Œå› æ­¤ Hono éœ€è¦å¤–éƒ¨åº“ï¼Œè€Œ Elysia åˆ™ä½¿ç”¨ `file-type` è‡ªåŠ¨éªŒè¯ MIME ç±»å‹ã€‚

## ä¸­é—´ä»¶

Hono ä¸­é—´ä»¶ä½¿ç”¨ç±»ä¼¼äº Express çš„å•é˜Ÿåˆ—é¡ºåºï¼Œè€Œ Elysia ä½¿ç”¨ **åŸºäºäº‹ä»¶** çš„ç”Ÿå‘½å‘¨æœŸä¸ºæ‚¨æä¾›æ›´ç²¾ç»†çš„æ§åˆ¶ã€‚

Elysia çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¯ä»¥å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚
![Elysia ç”Ÿå‘½å‘¨æœŸå›¾](/assets/lifecycle-chart.svg)

> å•å‡»å›¾ç‰‡æ”¾å¤§

è™½ç„¶ Hono çš„è¯·æ±‚ç®¡é“æœ‰å•ä¸€æµç¨‹ï¼Œä½† Elysia å¯ä»¥æ‹¦æˆªè¯·æ±‚ç®¡é“ä¸­çš„æ¯ä¸ªäº‹ä»¶ã€‚

::: code-group

```ts [Hono]
import { Hono } from 'hono'

const app = new Hono()

// å…¨å±€ä¸­é—´ä»¶
app.use(async (c, next) => {
    console.log(`${c.method} ${c.url}`)

    await next()
})

app.get(
    '/protected',
    // è·¯ç”±ç‰¹å®šä¸­é—´ä»¶
    async (c, next) => {
        const token = c.headers.authorization

        if (!token) {
            c.status(401)
            return c.text('Unauthorized')
        }

        await next()
    },
    (req, res) => {
        res.send('Protected route')
    }
)
```

:::


> Hono ä½¿ç”¨å•é˜Ÿåˆ—é¡ºåºçš„ä¸­é—´ä»¶ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
    // å…¨å±€ä¸­é—´ä»¶
    .onRequest(({ method, path }) => {
        console.log(`${method} ${path}`)
    })
    // è·¯ç”±ç‰¹å®šä¸­é—´ä»¶
    .get('/protected', () => 'protected', {
        beforeHandle({ status, headers }) {
            if (!headers.authorization)
                return status(401)
        }
    })
```

:::


> Elysia ä¸ºè¯·æ±‚ç®¡é“ä¸­çš„æ¯ä¸ªç‚¹ä½¿ç”¨ç‰¹å®šçš„äº‹ä»¶æ‹¦æˆªå™¨

è™½ç„¶ Hono æœ‰ `next` å‡½æ•°æ¥è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œä½† Elysia æ²¡æœ‰è¿™ä¸ªå‡½æ•°ã€‚

## ç±»å‹å®‰å…¨

Elysia æ—¨åœ¨å®ç°å¼ºç±»å‹å®‰å…¨ã€‚

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ [derive](/essential/life-cycle.html#derive) å’Œ [resolve](/essential/life-cycle.html#resolve) ä»¥ **ç±»å‹å®‰å…¨** çš„æ–¹å¼è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ï¼Œè€Œ Hono åˆ™ä¸èƒ½ã€‚

::: code-group

```ts twoslash [Hono]
// @errors: 2339, 2769
import { Hono } from 'hono'
import { createMiddleware } from 'hono/factory'

const app = new Hono()

const getVersion = createMiddleware(async (c, next) => {
    c.set('version', 2)

    await next()
})

app.use(getVersion)

app.get('/version', getVersion, (c) => {
    return c.text(c.get('version') + '')
})

const authenticate = createMiddleware(async (c, next) => {
    const token = c.req.header('authorization')

    if (!token) {
        c.status(401)
        return c.text('Unauthorized')
    }

    c.set('token', token.split(' ')[1])

    await next()
})

app.post('/user', authenticate, async (c) => {
    c.get('version')

    return c.text(c.get('token'))
})
```

:::


> Hono ä½¿ç”¨ä¸­é—´ä»¶æ‰©å±•ä¸Šä¸‹æ–‡ï¼Œä½†ä¸å…·å¤‡ç±»å‹å®‰å…¨

::: code-group

```ts twoslash [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia()
    .decorate('version', 2)
    .get('/version', ({ version }) => version)
    .resolve(({ status, headers: { authorization } }) => {
        if (!authorization?.startsWith('Bearer '))
            return status(401)

        return {
            token: authorization.split(' ')[1]
        }
    })
    .get('/token', ({ token, version }) => {
        version
        //  ^?


        return token
        //       ^?
    })
```

:::


> Elysia ä¸ºè¯·æ±‚ç®¡é“ä¸­çš„æ¯ä¸ªç‚¹ä½¿ç”¨ç‰¹å®šçš„äº‹ä»¶æ‹¦æˆªå™¨

è™½ç„¶ Hono å¯ä»¥ä½¿ç”¨ `declare module` æ¥æ‰©å±• `ContextVariableMap` æ¥å£ï¼Œä½†å®ƒæ˜¯å…¨å±€å¯ç”¨çš„ï¼Œå› æ­¤ä¸å…·å¤‡ç±»å‹å®‰å…¨ï¼Œä¹Ÿæ— æ³•ç¡®ä¿è¯¥å±æ€§åœ¨æ‰€æœ‰è¯·æ±‚å¤„ç†ç¨‹åºä¸­å¯ç”¨ã€‚

```ts
declare module 'hono' {
  	interface ContextVariableMap {
    	version: number
  		token: string
  	}
}
```

> è¿™å¯¹äºä¸Šè¿° Hono ç¤ºä¾‹çš„æ­£å¸¸å·¥ä½œæ˜¯å¿…éœ€çš„ï¼Œä½†ä¸æä¾›å¼ºç±»å‹å®‰å…¨ã€‚

## ä¸­é—´ä»¶å‚æ•°

Hono ä½¿ç”¨å›è°ƒå‡½æ•°å®šä¹‰å¯é‡ç”¨çš„è·¯ç”±ç‰¹å®šä¸­é—´ä»¶ï¼Œè€Œ Elysia ä½¿ç”¨ [macro](/patterns/macro) å®šä¹‰è‡ªå®šä¹‰é’©å­ã€‚

::: code-group

```ts twoslash [Hono]
const findUser = (authorization?: string) => {
    return {
        name: 'Jane Doe',
        role: 'admin' as const
    }
}
// ---cut---
// @errors: 2339 2589 2769
import { Hono } from 'hono'
import { createMiddleware } from 'hono/factory'

const app = new Hono()

const role = (role: 'user' | 'admin') => createMiddleware(async (c, next) => {
    const user = findUser(c.req.header('Authorization'))

    if (user.role !== role) {
        c.status(401)
        return c.text('Unauthorized')
    }

    c.set('user', user)

    await next()
})

app.get('/user/:id', role('admin'), (c) => {
    return c.json(c.get('user'))
})
```

:::


> Hono ä½¿ç”¨å›è°ƒè¿”å› `createMiddleware` æ¥åˆ›å»ºå¯é‡ç”¨çš„ä¸­é—´ä»¶ï¼Œä½†ä¸å…·å¤‡ç±»å‹å®‰å…¨

::: code-group

```ts twoslash [Elysia]
const findUser = (authorization?: string) => {
    return {
        name: 'Jane Doe',
        role: 'admin' as const
    }
}
// ---cut---
import { Elysia } from 'elysia'

const app = new Elysia()
    .macro({
        role: (role: 'user' | 'admin') => ({
            resolve({ status, headers: { authorization } }) {
                const user = findUser(authorization)

                if (user.role !== role)
                    return status(401)

                return {
                    user
                }
            }
        })
    })
    .get('/token', ({ user }) => user, {
    //                 ^?
        role: 'admin'
    })
```

:::


> Elysia ä½¿ç”¨å®å°†è‡ªå®šä¹‰å‚æ•°ä¼ é€’ç»™è‡ªå®šä¹‰ä¸­é—´ä»¶

## é”™è¯¯å¤„ç†

Hono æä¾›äº†ä¸€ä¸ªé€‚ç”¨äºæ‰€æœ‰è·¯ç”±çš„ `onError` å‡½æ•°ï¼Œè€Œ Elysia åˆ™æä¾›äº†æ›´ç»†ç²’åº¦çš„é”™è¯¯å¤„ç†æ§åˆ¶ã€‚

::: code-group

```ts
import { Hono } from 'hono'

const app = new Hono()

class CustomError extends Error {
    constructor(message: string) {
        super(message)
        this.name = 'CustomError'
    }
}

// å…¨å±€é”™è¯¯å¤„ç†ç¨‹åº
app.onError((error, c) => {
    if (error instanceof CustomError) {
        c.status(500)

        return c.json({
            message: 'å‡ºäº†ä¸€äº›é—®é¢˜ï¼',
            error
        })
    }
})

// è·¯ç”±ç‰¹å®šé”™è¯¯å¤„ç†ç¨‹åº
app.get('/error', (req, res) => {
    throw new CustomError('å“¦ï¼Œå‡ºé”™äº†')
})
```

:::


> Hono ä½¿ç”¨ `onError` å‡½æ•°å¤„ç†é”™è¯¯ï¼Œæ‰€æœ‰è·¯ç”±å…±äº«ä¸€ä¸ªé”™è¯¯å¤„ç†å™¨

::: code-group

```ts twoslash [Elysia]
import { Elysia } from 'elysia'

class CustomError extends Error {
	// Optional: custom HTTP status code
	status = 500

	constructor(message: string) {
		super(message)
		this.name = 'CustomError'
	}

	// Optional: what should be sent to the client
	toResponse() {
		return {
			message: "If you're seeing this, our dev forgot to handle this error",
			error: this
		}
	}
}

const app = new Elysia()
	// Optional: register custom error class
	.error({
		CUSTOM: CustomError,
	})
	// Global error handler
	.onError(({ error, code }) => {
		if(code === 'CUSTOM')
		// ^?




			return {
				message: 'Something went wrong!',
				error
			}
	})
	.get('/error', () => {
		throw new CustomError('oh uh')
	}, {
		// Optional: route specific error handler
		error({ error }) {
			return {
				message: 'Only for this route!',
				error
			}
		}
	})
```

:::


> Elysia åœ¨é”™è¯¯å¤„ç†æ–¹é¢æä¾›äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶å’Œä½œç”¨åŸŸæœºåˆ¶

è™½ç„¶ Hono æä¾›ç±»ä¼¼ä¸­é—´ä»¶çš„é”™è¯¯å¤„ç†ï¼ŒElysia æä¾›ï¼š

1. å…¨å±€å’Œè·¯ç”±ç‰¹å®šçš„é”™è¯¯å¤„ç†
2. ç”¨äºæ˜ å°„ HTTP çŠ¶æ€ç çš„ç®€å†™æ–¹å¼åŠå°†é”™è¯¯æ˜ å°„ä¸ºå“åº”çš„ `toResponse`
3. ä¸ºæ¯ä¸ªé”™è¯¯æä¾›è‡ªå®šä¹‰é”™è¯¯ç 

é”™è¯¯ç å¯¹äºæ—¥å¿—å’Œè°ƒè¯•éå¸¸æœ‰ç”¨ï¼Œå¯¹äºåŒºåˆ†æ‰©å±•ç›¸åŒç±»çš„ä¸åŒé”™è¯¯ç±»å‹ä¹Ÿå¾ˆé‡è¦ã€‚

Elysia åœ¨ä»¥ä¸Šæ–¹é¢éƒ½å…·å¤‡ç±»å‹å®‰å…¨ï¼Œè€Œ Hono åˆ™æ²¡æœ‰ã€‚

## å°è£…

Hono å°è£…æ’ä»¶å‰¯ä½œç”¨ï¼Œè€Œ Elysia é€šè¿‡æ˜¾å¼çš„ä½œç”¨åŸŸæœºåˆ¶å’Œä»£ç é¡ºåºï¼Œèµ‹äºˆæ‚¨æ§åˆ¶æ’ä»¶å‰¯ä½œç”¨çš„èƒ½åŠ›ã€‚

::: code-group

```ts [Hono]
import { Hono } from 'hono'

const subRouter = new Hono()

subRouter.get('/user', (c) => {
    return c.text('Hello User')
})

const app = new Hono()

app.route('/api', subRouter)
```

:::


> Hono å°è£…æ’ä»¶çš„å‰¯ä½œç”¨

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia()
    .onBeforeHandle(({ status, headers: { authorization } }) => {
        if (!authorization?.startsWith('Bearer '))
            return status(401)
    })

const app = new Elysia()
    .get('/', 'Hello World')
    .use(subRouter)
    // ä¸ä¼šæœ‰ subRouter çš„å‰¯ä½œç”¨
    .get('/side-effect', () => 'hi')
```

:::


> Elysia é™¤éæ˜ç¡®å£°æ˜ï¼Œå¦åˆ™ä¸å°è£…æ’ä»¶çš„å‰¯ä½œç”¨

ä¸¤è€…éƒ½æœ‰æ’ä»¶çš„å°è£…æœºåˆ¶ä»¥é˜²æ­¢å‰¯ä½œç”¨ã€‚

ç„¶è€Œï¼ŒElysia å¯é€šè¿‡å£°æ˜ä½œç”¨åŸŸæ˜ç¡®æŒ‡å®šå“ªäº›æ’ä»¶åº”å…·æœ‰å‰¯ä½œç”¨ï¼Œè€Œ Hono å§‹ç»ˆå°è£…å‰¯ä½œç”¨ã€‚

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia()
    .onBeforeHandle(({ status, headers: { authorization } }) => {
        if (!authorization?.startsWith('Bearer '))
            return status(401)
    })
    // ä½œç”¨åŸŸé™å®šäºçˆ¶å®ä¾‹ï¼Œä¸èƒ½è¶…å‡º
    .as('scoped') // [!code ++]

const app = new Elysia()
    .get('/', 'Hello World')
    .use(subRouter)
    // [!code ++]
    // ç°åœ¨å…·æœ‰æ¥è‡ª subRouter çš„å‰¯ä½œç”¨
    .get('/side-effect', () => 'hi')
```

Elysia æä¾› 3 ç§ç±»å‹çš„ä½œç”¨åŸŸæœºåˆ¶ï¼š

1. **local** - ä»…é€‚ç”¨äºå½“å‰å®ä¾‹ï¼Œæ²¡æœ‰å‰¯ä½œç”¨ï¼ˆé»˜è®¤ï¼‰
2. **scoped** - å°†å‰¯ä½œç”¨èŒƒå›´é™å®šäºçˆ¶å®ä¾‹ï¼Œä½†ä¸èƒ½è¶…å‡º
3. **global** - å½±å“æ‰€æœ‰å®ä¾‹

***

ç”±äº Hono ä¸æä¾›ä½œç”¨åŸŸæœºåˆ¶ï¼Œæˆ‘ä»¬éœ€è¦ï¼š

1. ä¸ºæ¯ä¸ªé’©å­åˆ›å»ºä¸€ä¸ªå‡½æ•°å¹¶æ‰‹åŠ¨é™„åŠ å®ƒä»¬
2. ä½¿ç”¨é«˜é˜¶å‡½æ•°ï¼Œå¹¶å°†å…¶åº”ç”¨äºéœ€è¦æ•ˆæœçš„å®ä¾‹

ä½†æ˜¯ï¼Œå¦‚æœå¤„ç†ä¸å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´å‰¯ä½œç”¨çš„é‡å¤ã€‚

```ts [Hono]
import { Hono } from 'hono'
import { createMiddleware } from 'hono/factory'

const middleware = createMiddleware(async (c, next) => {
    console.log('called')

    await next()
})

const app = new Hono()
const subRouter = new Hono()

app.use(middleware)
app.get('/main', (c) => c.text('Hello from main!'))

subRouter.use(middleware)

// è¿™å°†ä¼šè®°å½•ä¸¤æ¬¡
subRouter.get('/sub', (c) => c.text('Hello from sub router!'))

app.route('/sub', subRouter)

export default app
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒElysia æä¾›äº†ä¸€ä¸ªæ’ä»¶å»é‡æœºåˆ¶ä»¥é˜²æ­¢é‡å¤å‰¯ä½œç”¨ã€‚

```ts [Elysia]
import { Elysia } from 'elysia'

const subRouter = new Elysia({ name: 'subRouter' }) // [!code ++]
    .onBeforeHandle(({ status, headers: { authorization } }) => {
        if (!authorization?.startsWith('Bearer '))
            return status(401)
    })
    .as('scoped')

const app = new Elysia()
    .get('/', 'Hello World')
    .use(subRouter)
    .use(subRouter) // [!code ++]
    .use(subRouter) // [!code ++]
    .use(subRouter) // [!code ++]
    // å‰¯ä½œç”¨åªä¼šè°ƒç”¨ä¸€æ¬¡
    .get('/side-effect', () => 'hi')
```

é€šè¿‡ä½¿ç”¨å”¯ä¸€çš„ `name`ï¼ŒElysia åªä¼šåº”ç”¨æ’ä»¶ä¸€æ¬¡ï¼Œå¹¶ä¸ä¼šå¯¼è‡´å‰¯ä½œç”¨çš„é‡å¤ã€‚

## Cookie

Hono åœ¨ `hono/cookie` ä¸‹æœ‰å†…ç½®çš„ cookie å·¥å…·å‡½æ•°ï¼Œè€Œ Elysia é‡‡ç”¨åŸºäºä¿¡å·çš„æ–¹æ³•å¤„ç† Cookiesã€‚

::: code-group

```ts [Hono]
import { Hono } from 'hono'
import { getSignedCookie, setSignedCookie } from 'hono/cookie'

const app = new Hono()

app.get('/', async (c) => {
    const name = await getSignedCookie(c, 'secret', 'name')

    await setSignedCookie(
        c,
        'name',
        'value',
        'secret',
        {
            maxAge: 1000,
        }
    )
})
```

:::


> Hono ä½¿ç”¨å·¥å…·å‡½æ•°å¤„ç† cookies

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'

const app = new Elysia({
    cookie: {
        secret: 'secret'
    }
})
    .get('/', ({ cookie: { name } }) => {
        // ç­¾åéªŒè¯ä¼šè‡ªåŠ¨å¤„ç†
        name.value

        // cookie ç­¾åä¼šè‡ªåŠ¨ç­¾å
        name.value = 'value'
        name.maxAge = 1000 * 60 * 60 * 24
    })
```

:::


> Elysia ä½¿ç”¨åŸºäºä¿¡å·çš„æ–¹æ³•å¤„ç† cookies

## OpenAPI

Hono éœ€è¦é¢å¤–çš„å·¥ä½œæ¥æè¿°è§„èŒƒï¼Œè€Œ Elysia æ— ç¼åœ°å°†è§„èŒƒé›†æˆåˆ°æ¨¡å¼ä¸­ã€‚

::: code-group

```ts [Hono]
import { Hono } from 'hono'
import { describeRoute, openAPISpecs } from 'hono-openapi'
import { resolver, validator as zodValidator } from 'hono-openapi/zod'
import { swaggerUI } from '@hono/swagger-ui'

import { z } from '@hono/zod-openapi'

const app = new Hono()

const model = z.array(
    z.object({
        name: z.string().openapi({
            description: 'ä»…é™å§“'
        }),
        age: z.number()
    })
)

const detail = await resolver(model).builder()

console.log(detail)

app.post(
    '/',
    zodValidator('json', model),
    describeRoute({
        validateResponse: true,
        summary: 'åˆ›å»ºç”¨æˆ·',
        requestBody: {
            content: {
                'application/json': { schema: detail.schema }
            }
        },
        responses: {
            201: {
                description: 'ç”¨æˆ·åˆ›å»º',
                content: {
                    'application/json': { schema: resolver(model) }
                }
            }
        }
    }),
    (c) => {
        c.status(201)
        return c.json(c.req.valid('json'))
    }
)

app.get('/ui', swaggerUI({ url: '/doc' }))

app.get(
    '/doc',
    openAPISpecs(app, {
        documentation: {
            info: {
                title: 'Hono API',
                version: '1.0.0',
                description: 'é—®å€™ API'
            },
            components: {
                ...detail.components
            }
        }
    })
)

export default app
```

:::


> Hono éœ€è¦é¢å¤–åŠªåŠ›æ¥æè¿°è§„èŒƒ

::: code-group

```ts twoslash [Elysia]
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi' // [!code ++]

const app = new Elysia()
	.use(openapi()) // [!code ++]
	.model({
		user: t.Array(
			t.Object({
				name: t.String(),
				age: t.Number()
			})
		)
	})
	.post('/users', ({ body }) => body, {
	//                  ^?
		body: 'user',
		response: {
			201: 'user'
		},
		detail: {
			summary: 'Create user'
		}
	})

```

:::


> Elysia æ— ç¼åœ°å°†è§„èŒƒé›†æˆåˆ°æ¨¡å¼ä¸­

Hono å…·æœ‰å•ç‹¬çš„å‡½æ•°æ¥æè¿°è·¯ç”±è§„èŒƒã€éªŒè¯ï¼Œå¹¶ä¸”éœ€è¦ä¸€äº›é¢å¤–çš„å·¥ä½œè¿›è¡Œæ­£ç¡®è®¾ç½®ã€‚

Elysia ä½¿ç”¨æ‚¨æä¾›çš„æ¨¡å¼ç”Ÿæˆ OpenAPI è§„èŒƒï¼Œå¹¶éªŒè¯è¯·æ±‚/å“åº”ï¼Œå¹¶è‡ªåŠ¨æ¨æ–­ç±»å‹ï¼Œæ‰€æœ‰è¿™äº›éƒ½æ¥è‡ªä¸€ä¸ª **å•ä¸€çš„ä¿¡æ¯æº**ã€‚

Elysia è¿˜å°†æ³¨å†Œçš„æ¨¡å¼é™„åŠ åˆ° OpenAPI è§„èŒƒä¸­ï¼Œå…è®¸æ‚¨åœ¨ Swagger æˆ– Scalar UI ä¸­çš„ä¸“ç”¨éƒ¨åˆ†ä¸­å¼•ç”¨è¯¥æ¨¡å‹ï¼Œè€Œ Hono å°†æ¨¡å¼å†…è”åˆ°è·¯ç”±ä¸­ã€‚

## æµ‹è¯•

ä¸¤ä¸ªæ¡†æ¶å‡å»ºç«‹åœ¨ Web æ ‡å‡† API ä¹‹ä¸Šï¼Œå…è®¸ä¸ä»»ä½•æµ‹è¯•åº“ä¸€èµ·ä½¿ç”¨ã€‚

::: code-group

```ts [Hono]
import { Hono } from 'hono'
import { describe, it, expect } from 'vitest'

const app = new Hono()
    .get('/', (c) => c.text('Hello World'))

describe('GET /', () => {
    it('should return Hello World', async () => {
        const res = await app.request('/')

        expect(res.status).toBe(200)
        expect(await res.text()).toBe('Hello World')
    })
})
```

:::


> Hono å…·æœ‰å†…ç½®çš„ `request` æ–¹æ³•æ¥æ‰§è¡Œè¯·æ±‚

::: code-group

```ts [Elysia]
import { Elysia } from 'elysia'
import { describe, it, expect } from 'vitest'

const app = new Elysia()
    .get('/', 'Hello World')

describe('GET /', () => {
    it('should return Hello World', async () => {
        const res = await app.handle(
            new Request('http://localhost')
        )

        expect(res.status).toBe(200)
        expect(await res.text()).toBe('Hello World')
    })
})
```

:::


> Elysia ä½¿ç”¨ Web æ ‡å‡† API å¤„ç†è¯·æ±‚å’Œå“åº”

å¦å¤–ï¼ŒElysia è¿˜æä¾›äº†ä¸€ä¸ªåä¸º [Eden](/eden/overview) çš„è¾…åŠ©åº“ï¼Œç”¨äºç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ï¼Œå…è®¸æˆ‘ä»¬åœ¨æµ‹è¯•ä¸­è¿›è¡Œè‡ªåŠ¨è¡¥å…¨å’Œå®Œæ•´çš„ç±»å‹å®‰å…¨ã€‚

```ts twoslash [Elysia]
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'
import { describe, expect, it } from 'bun:test'

const app = new Elysia().get('/hello', 'Hello World')
const api = treaty(app)

describe('GET /', () => {
    it('should return Hello World', async () => {
        const { data, error, status } = await api.hello.get()

        expect(status).toBe(200)
        expect(data).toBe('Hello World')
        //      ^?
    })
})
```

## ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨

ä¸¤è€…éƒ½æä¾›ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ï¼Œç„¶è€Œ Hono åœ¨åŸºäºçŠ¶æ€ç çš„é”™è¯¯å¤„ç†æ–¹é¢ä¼¼ä¹ä¸æä¾›ç±»å‹å®‰å…¨ã€‚

::: code-group

```ts twoslash [Hono]
import { Hono } from 'hono'
import { hc } from 'hono/client'
import { z } from 'zod'
import { zValidator } from '@hono/zod-validator'

const app = new Hono()
    .post(
        '/mirror',
        zValidator(
            'json',
            z.object({
                message: z.string()
            })
        ),
        (c) => c.json(c.req.valid('json'))
    )

const client = hc<typeof app>('/')

const response = await client.mirror.$post({
    json: {
        message: 'Hello, world!'
    }
})

const data = await response.json()
//     ^?

console.log(data)
```

:::


> Hono ä½¿ç”¨ `hc` è¿è¡Œè¯·æ±‚ï¼Œå¹¶æä¾›ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨

::: code-group

```ts twoslash [Elysia]
import { Elysia, t } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
    .post('/mirror', ({ body }) => body, {
        body: t.Object({
            message: t.String()
        })
    })

const api = treaty(app)

const { data, error } = await api.mirror.post({
    message: 'Hello World'
})

if (error)
    throw error
    //     ^?















console.log(data)
//          ^?



// ---cut-after---
console.log('ok')
```

:::


> Elysia ä½¿ç”¨ `treaty` è¿è¡Œè¯·æ±‚ï¼Œå¹¶æä¾›ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨

è™½ç„¶ä¸¤è€…éƒ½æä¾›ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ï¼Œä½† Elysia åœ¨åŸºäºçŠ¶æ€ç çš„é”™è¯¯å¤„ç†æ–¹é¢æä¾›äº†æ›´å¤šç±»å‹å®‰å…¨ï¼Œè€Œ Hono åˆ™æ²¡æœ‰ã€‚

ä½¿ç”¨ç›¸åŒç›®çš„çš„ä»£ç æ¥æµ‹é‡ç±»å‹æ¨ç†é€Ÿåº¦æ—¶ï¼ŒElysia åœ¨ç±»å‹æ£€æŸ¥æ–¹é¢æ¯” Hono å¿« 2.3 å€ã€‚

![Elysia eden ç±»å‹æ¨ç†æ€§èƒ½](/migrate/elysia-type-infer.webp)

> Elysia èŠ±è´¹ 536 æ¯«ç§’æ¨æ–­ Elysia å’Œ Edenï¼ˆç‚¹å‡»æ”¾å¤§ï¼‰

![Hono HC ç±»å‹æ¨ç†æ€§èƒ½](/migrate/hono-type-infer.webp)

> Hono èŠ±è´¹ 1.27 ç§’æ¨æ–­ Hono å’Œ HCï¼Œå¸¦æœ‰é”™è¯¯ï¼ˆä¸­æ­¢ï¼‰ï¼ˆç‚¹å‡»æ”¾å¤§ï¼‰

1.27 ç§’å¹¶ä¸åæ˜ æ¨æ–­çš„æ•´ä¸ªæŒç»­æ—¶é—´ï¼Œè€Œæ˜¯ä»å¼€å§‹åˆ°å› é”™è¯¯ **â€œç±»å‹å®ä¾‹åŒ–è¿‡äºæ·±ä¸”å¯èƒ½æ˜¯æ— é™çš„ã€‚â€** è€Œä¸­æ­¢çš„æŒç»­æ—¶é—´ï¼Œè¿™åœ¨æ¨¡å¼è¿‡å¤§æ—¶ä¼šå‘ç”Ÿã€‚

![Hono HC æ˜¾ç¤ºè¿‡äºæ·±çš„é”™è¯¯](/migrate/hono-hc-infer.webp)

> Hono HC æ˜¾ç¤ºè¿‡äºæ·±çš„é”™è¯¯

è¿™æ˜¯ç”±äºæ¨¡å¼è¿‡å¤§ï¼ŒHono ä¸æ”¯æŒè¶…è¿‡ 100 ä¸ªè·¯ç”±ï¼Œä¸”å…·æœ‰å¤æ‚ä¸»ä½“å’Œå“åº”éªŒè¯ï¼Œè€Œ Elysia åˆ™æ²¡æœ‰è¿™ä¸ªé—®é¢˜ã€‚

![Elysia Eden ä»£ç æ˜¾ç¤ºç±»å‹æ¨ç†æ²¡æœ‰é”™è¯¯](/migrate/elysia-eden-infer.webp)

> Elysia Eden ä»£ç æ˜¾ç¤ºç±»å‹æ¨ç†æ²¡æœ‰é”™è¯¯

Elysia çš„ç±»å‹æ¨ç†æ€§èƒ½æ›´å¿«ï¼Œä¸”ä¸å¿…æ‹…å¿ƒ **â€œç±»å‹å®ä¾‹åŒ–è¿‡äºæ·±ä¸”å¯èƒ½æ˜¯æ— é™çš„ã€‚â€** *è‡³å°‘* åœ¨å…·æœ‰å¤æ‚ä¸»ä½“å’Œå“åº”éªŒè¯çš„ 2000 æ¡è·¯ç”±ä¹‹å†…ã€‚

å¦‚æœç«¯åˆ°ç«¯ç±»å‹å®‰å…¨å¯¹æ‚¨å¾ˆé‡è¦ï¼Œé‚£ä¹ˆ Elysia æ˜¯æ­£ç¡®çš„é€‰æ‹©ã€‚

***

ä¸¤è€…éƒ½æ˜¯å»ºç«‹åœ¨ Web æ ‡å‡† API ä¹‹ä¸Šçš„ä¸‹ä¸€ä»£ web æ¡†æ¶ï¼Œå­˜åœ¨ç»†å¾®çš„å·®åˆ«ã€‚

Elysia æ—¨åœ¨ç¬¦åˆäººä½“å·¥ç¨‹å­¦ä¸”å¯¹å¼€å‘è€…å‹å¥½ï¼Œå…³æ³¨ **å¼ºç±»å‹å®‰å…¨**ï¼Œå¹¶ä¸”åœ¨æ€§èƒ½ä¸Šä¼˜äº Honoã€‚

è™½ç„¶ Hono æä¾›äº†å¯¹å¤šä¸ªè¿è¡Œæ—¶çš„å¹¿æ³›å…¼å®¹æ€§ï¼Œç‰¹åˆ«æ˜¯ä¸ Cloudflare Workers å…¼å®¹ï¼Œä»¥åŠæ›´å¤§çš„ç”¨æˆ·åŸºç¡€ã€‚

å¦‚æœæ‚¨æ˜¯æ¥è‡ªå…¶ä»–æ¡†æ¶çš„ç”¨æˆ·ï¼Œå¯ä»¥æŸ¥çœ‹ï¼š

---

---
url: 'https://elysiajs.com/eden/treaty/unit-test.md'
---

# å•å…ƒæµ‹è¯•

æ ¹æ® [ä¼Šç”¸æ¡çº¦é…ç½®](/eden/treaty/config.html#urlorinstance) å’Œ [å•å…ƒæµ‹è¯•](/patterns/unit-test)ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†ä¸€ä¸ª Elysia å®ä¾‹ä¼ é€’ç»™ä¼Šç”¸æ¡çº¦ï¼Œä»è€Œç›´æ¥ä¸ Elysia æœåŠ¡å™¨è¿›è¡Œäº¤äº’ï¼Œè€Œæ— éœ€å‘é€ç½‘ç»œè¯·æ±‚ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ç§æ¨¡å¼åˆ›å»ºä¸€ä¸ªå…·æœ‰ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨æ€§å’Œç±»å‹çº§åˆ«æµ‹è¯•çš„å•å…ƒæµ‹è¯•ã€‚

```typescript twoslash
// test/index.test.ts
import { describe, expect, it } from 'bun:test'
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia().get('/hello', 'hi')
const api = treaty(app)

describe('Elysia', () => {
    it('è¿”å›å“åº”', async () => {
        const { data } = await api.hello.get()

        expect(data).toBe('hi')
              // ^?

    })
})
```

## ç±»å‹å®‰å…¨æµ‹è¯•

è¦æ‰§è¡Œç±»å‹å®‰å…¨æµ‹è¯•ï¼Œåªéœ€è¿è¡Œ **tsc** æ¥æµ‹è¯•æ–‡ä»¶å¤¹ã€‚

```bash
tsc --noEmit test/**/*.ts
```

è¿™å¯¹äºç¡®ä¿å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„ç±»å‹å®Œæ•´æ€§éå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿ç§»æœŸé—´ã€‚

---

---
url: 'https://elysiajs.com/eden/treaty/legacy.md'
---

# ä¼Šç”¸æ¡çº¦é—äº§

::: tip æ³¨æ„
è¿™æ˜¯é’ˆå¯¹ä¼Šç”¸æ¡çº¦ 1 æˆ– (edenTreaty) çš„æ–‡æ¡£ã€‚

å¯¹äºæ–°é¡¹ç›®ï¼Œå»ºè®®ä½¿ç”¨ä¼Šç”¸æ¡çº¦ 2 (treaty) è€Œä¸æ˜¯ã€‚
:::

ä¼Šç”¸æ¡çº¦æ˜¯ Elysia æœåŠ¡å™¨çš„å¯¹è±¡ç±»ä¼¼è¡¨ç¤ºã€‚

æä¾›ç±»ä¼¼æ™®é€šå¯¹è±¡çš„è®¿é—®å™¨ï¼Œç›´æ¥ä»æœåŠ¡å™¨è·å–ç±»å‹ï¼Œå¸®åŠ©æˆ‘ä»¬æ›´å¿«åœ°å·¥ä½œï¼Œå¹¶ç¡®ä¿ä¸ä¼šå‘ç”Ÿé”™è¯¯ã€‚

***

è¦ä½¿ç”¨ä¼Šç”¸æ¡çº¦ï¼Œé¦–å…ˆå¯¼å‡ºæ‚¨ç°æœ‰çš„ Elysia æœåŠ¡å™¨ç±»å‹ï¼š

```typescript
// server.ts
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .get('/', () => 'å—¨ï¼ŒElysia')
    .get('/id/:id', ({ params: { id } }) => id)
    .post('/mirror', ({ body }) => body, {
        body: t.Object({
            id: t.Number(),
            name: t.String()
        })
    })
    .listen(3000)

export type App = typeof app // [!ä»£ç  ++]
```

ç„¶åå¯¼å…¥æœåŠ¡å™¨ç±»å‹ï¼Œå¹¶åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ Elysia APIï¼š

```typescript
// client.ts
import { edenTreaty } from '@elysiajs/eden'
import type { App } from './server' // [!ä»£ç  ++]

const app = edenTreaty<App>('http://localhost:')

// å“åº”ç±»å‹: 'å—¨ï¼ŒElysia'
const { data: pong, error } = app.get()

// å“åº”ç±»å‹: 1895
const { data: id, error } = app.id['1895'].get()

// å“åº”ç±»å‹: { id: 1895, name: 'Skadi' }
const { data: nendoroid, error } = app.mirror.post({
    id: 1895,
    name: 'Skadi'
})
```

::: tip
ä¼Šç”¸æ¡çº¦å…·æœ‰å®Œå…¨çš„ç±»å‹å®‰å…¨å’Œè‡ªåŠ¨è¡¥å…¨æ”¯æŒã€‚
:::

## æ„é€ 

ä¼Šç”¸æ¡çº¦ä¼šå°†æ‰€æœ‰ç°æœ‰è·¯å¾„è½¬æ¢ä¸ºå¯¹è±¡ç±»ä¼¼è¡¨ç¤ºï¼Œå¯ä»¥æè¿°ä¸ºï¼š

```typescript
EdenTreaty.<1>.<2>.<n>.<method>({
    ...body,
    $query?: {},
    $fetch?: RequestInit
})
```

### è·¯å¾„

ä¼Šç”¸ä¼šå°† `/` è½¬æ¢ä¸º `.`ï¼Œå¯ä»¥ç”¨å·²æ³¨å†Œçš„ `method` è°ƒç”¨ï¼Œä¾‹å¦‚ï¼š

* **/path** -> .path
* **/nested/path** -> .nested.path

### è·¯å¾„å‚æ•°

è·¯å¾„å‚æ•°ä¼šæ ¹æ®å®ƒä»¬åœ¨ URL ä¸­çš„åç§°è‡ªåŠ¨æ˜ å°„ã€‚

* **/id/:id** -> .id.`<ä»»ä½•ä¸œè¥¿>`
* ä¾‹å¦‚: .id.hi
* ä¾‹å¦‚: .id\['123']

::: tip
å¦‚æœè·¯å¾„ä¸æ”¯æŒè·¯å¾„å‚æ•°ï¼ŒTypeScript ä¼šæ˜¾ç¤ºé”™è¯¯ã€‚
:::

### æŸ¥è¯¢

æ‚¨å¯ä»¥ä½¿ç”¨ `$query` å°†æŸ¥è¯¢é™„åŠ åˆ°è·¯å¾„ï¼š

```typescript
app.get({
    $query: {
        name: 'ä¼Šç”¸',
        code: 'é‡‘'
    }
})
```

### è·å–

ä¼Šç”¸æ¡çº¦æ˜¯ä¸€ä¸ªè·å–å°è£…å™¨ï¼Œæ‚¨å¯ä»¥é€šè¿‡å°†å…¶ä¼ é€’ç»™ `$fetch` æ¥ä¸ºä¼Šç”¸æ·»åŠ ä»»ä½•æœ‰æ•ˆçš„ [Fetch](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch) å‚æ•°ï¼š

```typescript
app.post({
    $fetch: {
        headers: {
            'x-organization': 'MANTIS'
        }
    }
})
```

## é”™è¯¯å¤„ç†

ä¼Šç”¸æ¡çº¦å°†è¿”å›ä¸€ä¸ª `data` å’Œ `error` çš„å€¼ä½œä¸ºç»“æœï¼Œå‡ä¸ºå®Œå…¨ç±»å‹ã€‚

```typescript
// å“åº”ç±»å‹: { id: 1895, name: 'Skadi' }
const { data: nendoroid, error } = app.mirror.post({
    id: 1895,
    name: 'Skadi'
})

if(error) {
    switch(error.status) {
        case 400:
        case 401:
            warnUser(error.value)
            break

        case 500:
        case 502:
            emergencyCallDev(error.value)
            break

        default:
            reportError(error.value)
            break
    }

    throw error
}

const { id, name } = nendoroid
```

**data** å’Œ **error** çš„ç±»å‹åœ¨æ‚¨ç¡®è®¤å…¶çŠ¶æ€ä¹‹å‰éƒ½æ˜¯å¯ä¸ºç©ºçš„ã€‚

ç®€å•æ¥è¯´ï¼Œå¦‚æœè·å–æˆåŠŸï¼Œdata å°†æœ‰å€¼è€Œ error å°†ä¸º nullï¼Œåä¹‹äº¦ç„¶ã€‚

::: tip
é”™è¯¯è¢«åŒ…è£…åœ¨ä¸€ä¸ª `Error` ä¸­ï¼Œå…¶å€¼ä»æœåŠ¡å™¨è¿”å›ï¼Œå¯ä»¥ä» `Error.value` ä¸­æ£€ç´¢
:::

### åŸºäºçŠ¶æ€çš„é”™è¯¯ç±»å‹

å¦‚æœæ‚¨åœ¨ Elysia æœåŠ¡å™¨ä¸­æ˜ç¡®æä¾›äº†é”™è¯¯ç±»å‹ï¼Œä¼Šç”¸æ¡çº¦å’Œä¼Šç”¸è·å–å¯ä»¥æ ¹æ®çŠ¶æ€ç ç¼©å°é”™è¯¯ç±»å‹ã€‚

```typescript
// server.ts
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .model({
        nendoroid: t.Object({
            id: t.Number(),
            name: t.String()
        }),
        error: t.Object({
            message: t.String()
        })
    })
    .get('/', () => 'å—¨ï¼ŒElysia')
    .get('/id/:id', ({ params: { id } }) => id)
    .post('/mirror', ({ body }) => body, {
        body: 'nendoroid',
        response: {
            200: 'nendoroid', // [!ä»£ç  ++]
            400: 'error', // [!ä»£ç  ++]
            401: 'error' // [!ä»£ç  ++]
        }
    })
    .listen(3000)

export type App = typeof app
```

åœ¨å®¢æˆ·ç«¯ï¼š

```typescript
const { data: nendoroid, error } = app.mirror.post({
    id: 1895,
    name: 'Skadi'
})

if(error) {
    switch(error.status) {
        case 400:
        case 401:
            // ç¼©å°åˆ°æœåŠ¡å™¨ä¸­æè¿°çš„ç±»å‹ 'error'
            warnUser(error.value)
            break

        default:
            // ç±»å‹ä¸º unknown
            reportError(error.value)
            break
    }

    throw error
}
```

## WebSocket

ä¼Šç”¸æ”¯æŒ WebSocketï¼Œä½¿ç”¨ä¸æ™®é€šè·¯ç”±ç›¸åŒçš„ APIã€‚

```typescript
// æœåŠ¡å™¨
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .ws('/chat', {
        message(ws, message) {
            ws.send(message)
        },
        body: t.String(),
        response: t.String()
    })
    .listen(3000)

type App = typeof app
```

è¦å¼€å§‹ç›‘å¬å®æ—¶æ•°æ®ï¼Œè°ƒç”¨ `.subscribe` æ–¹æ³•ï¼š

```typescript
// å®¢æˆ·ç«¯
import { edenTreaty } from '@elysiajs/eden'
const app = edenTreaty<App>('http://localhost:')

const chat = app.chat.subscribe()

chat.subscribe((message) => {
    console.log('æ¥æ”¶åˆ°', message)
})

chat.send('å®¢æˆ·ç«¯å‘é€çš„ä½ å¥½')
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [schema](/integrations/cheat-sheet#schema) æ¥å¼ºåˆ¶ WebSocket çš„ç±»å‹å®‰å…¨ï¼Œæ­£å¦‚æ™®é€šè·¯ç”±ä¸€æ ·ã€‚

***

**Eden.subscribe** è¿”å› **EdenWebSocket**ï¼Œå®ƒæ‰©å±•äº† [WebSocket](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/WebSocket) ç±»ï¼Œå…·å¤‡ç±»å‹å®‰å…¨ã€‚è¯­æ³•ä¸ WebSocket ç›¸åŒã€‚

å¦‚æœéœ€è¦æ›´å¤šæ§åˆ¶ï¼Œå¯ä»¥è®¿é—® **EdenWebSocket.raw** ä¸åŸç”Ÿ WebSocket API äº¤äº’ã€‚

## æ–‡ä»¶ä¸Šä¼ 

æ‚¨å¯ä»¥å°†ä»¥ä¸‹ä¹‹ä¸€ä¼ é€’åˆ°å­—æ®µä¸­ä»¥é™„åŠ æ–‡ä»¶ï¼š

* **File**
* **FileList**
* **Blob**

é™„åŠ æ–‡ä»¶å°†å¯¼è‡´ **content-type** ä¸º **multipart/form-data**ã€‚

å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹æœåŠ¡å™¨ï¼š

```typescript
// server.ts
import { Elysia } from 'elysia'

const app = new Elysia()
    .post('/image', ({ body: { image, title } }) => title, {
        body: t.Object({
            title: t.String(),
            image: t.Files(),
        })
    })
    .listen(3000)

export type App = typeof app
```

æˆ‘ä»¬å¯ä»¥å¦‚ä¸‹ä½¿ç”¨å®¢æˆ·ç«¯ï¼š

```typescript
// client.ts
import { edenTreaty } from '@elysia/eden'
import type { Server } from './server'

export const client = edenTreaty<Server>('http://localhost:3000')

const id = <T extends HTMLElement = HTMLElement>(id: string) =>
    document.getElementById(id)! as T

const { data } = await client.image.post({
    title: "Misono Mika",
    image: id<HTMLInputElement>('picture').files!,
})
```

---

---
url: 'https://elysiajs.com/tutorial/getting-started/your-first-route.md'
---

# ä½ çš„ç¬¬ä¸€æ¡è·¯ç”±

å½“æˆ‘ä»¬è®¿é—®ä¸€ä¸ªç½‘ç«™æ—¶ï¼Œå®ƒä¼šæ¥æ”¶

1. **è·¯å¾„**ï¼Œä¾‹å¦‚ `/`ã€`/about` æˆ– `/contact`
2. **æ–¹æ³•**ï¼Œä¾‹å¦‚ `GET`ã€`POST` æˆ– `DELETE`

ä»¥ç¡®å®šè¦æ˜¾ç¤ºçš„èµ„æºï¼Œè¿™è¢«ç®€å•ç§°ä¸º **"è·¯ç”±"**ã€‚

åœ¨ Elysia ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®šä¹‰è·¯ç”±ï¼š

1. è°ƒç”¨ä»¥ HTTP æ–¹æ³•å‘½åçš„æ–¹æ³•
2. è·¯å¾„ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°
3. å¤„ç†ç¨‹åºä½œä¸ºç¬¬äºŒä¸ªå‚æ•°

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', 'ä½ å¥½ï¼Œä¸–ç•Œï¼')
	.listen(3000)
```

## è·¯ç”±

Elysia ä¸­çš„è·¯å¾„å¯ä»¥åˆ†ä¸º 3 ç§ç±»å‹ï¼š

1. é™æ€è·¯å¾„ - ç¡¬ç¼–ç å­—ç¬¦ä¸²ä»¥å®šä½æœåŠ¡å™¨ä¸Šçš„èµ„æº
2. åŠ¨æ€è·¯å¾„ - æ®µå¯ä»¥æ˜¯ä»»ä½•å€¼
3. é€šé…ç¬¦ - è·¯å¾„ç›´åˆ°ç‰¹å®šç‚¹å¯ä»¥æ˜¯ä»»ä½•å†…å®¹

æŸ¥çœ‹ è·¯ç”±ã€‚

## é™æ€è·¯å¾„

é™æ€è·¯å¾„æ˜¯ä¸€ä¸ªç¡¬ç¼–ç å­—ç¬¦ä¸²ï¼Œç”¨äºå®šä½æœåŠ¡å™¨ä¸Šçš„èµ„æºã€‚

```ts
import { Elysia } from 'elysia'

new Elysia()
	.get('/hello', 'ä½ å¥½')
	.get('/hi', 'å—¨')
	.listen(3000)
```

æŸ¥çœ‹ é™æ€è·¯å¾„ã€‚

## åŠ¨æ€è·¯å¾„

åŠ¨æ€è·¯å¾„åŒ¹é…æŸäº›éƒ¨åˆ†å¹¶æ•è·å€¼ä»¥æå–é¢å¤–ä¿¡æ¯ã€‚

è¦å®šä¹‰åŠ¨æ€è·¯å¾„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†’å· `:` ä¹‹åè·Ÿåç§°ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/id/:id', ({ params: { id } }) => id)
    .listen(3000)
```

åœ¨è¿™é‡Œï¼ŒåŠ¨æ€è·¯å¾„é€šè¿‡ `/id/:id` åˆ›å»ºã€‚è¿™å‘Šè¯‰ Elysia æ•è·å€¼ä¸º `:id` çš„æ®µï¼Œä¾‹å¦‚ **/id/1**ã€**/id/123**ã€**/id/anything**ã€‚

æŸ¥çœ‹ åŠ¨æ€è·¯å¾„ã€‚

### å¯é€‰è·¯å¾„å‚æ•°

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å‚æ•°åç§°åæ·»åŠ é—®å· `?` æ¥ä½¿è·¯å¾„å‚æ•°å˜ä¸ºå¯é€‰ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/id/:id?', ({ params: { id } }) => `id ${id}`)
    .listen(3000)
```

æŸ¥çœ‹ å¯é€‰è·¯å¾„å‚æ•°ã€‚

## é€šé…ç¬¦

åŠ¨æ€è·¯å¾„å…è®¸æ•è·å•ä¸ªæ®µï¼Œè€Œé€šé…ç¬¦å…è®¸æ•è·è·¯å¾„çš„å…¶ä½™éƒ¨åˆ†ã€‚

è¦å®šä¹‰é€šé…ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ˜Ÿå· `*`ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/id/*', ({ params }) => params['*'])
    .listen(3000)
```

æŸ¥çœ‹ é€šé…ç¬¦ã€‚

## ä»»åŠ¡

è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ï¼Œå¹¶åˆ›å»º 3 æ¡å…·æœ‰ä¸åŒç±»å‹çš„è·¯å¾„ï¼š

\<template #answer>

1. é™æ€è·¯å¾„ `/elysia`ï¼Œå“åº”ä¸º `"Hello Elysia!"`
2. åŠ¨æ€è·¯å¾„ `/friends/:name?`ï¼Œå“åº”ä¸º `"Hello {name}!"`
3. é€šé…ç¬¦è·¯å¾„ `/flame-chasers/*`ï¼Œå“åº”ä¸ºè·¯å¾„å…¶ä½™éƒ¨åˆ†ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/elysia', 'ä½ å¥½ Elysiaï¼')
	.get('/friends/:name?', ({ params: { name } }) => `ä½ å¥½ ${name}ï¼`)
	.get('/flame-chasers/*', ({ params }) => params['*'])
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/patterns/fullstack-dev-server.md'
---

# Elysia ä¸ Bun å…¨æ ˆå¼€å‘æœåŠ¡å™¨

Bun 1.3 å¼•å…¥äº†ä¸€ä¸ª[å…¨æ ˆå¼€å‘æœåŠ¡å™¨](https://bun.com/docs/bundler/fullstack)ï¼Œæ”¯æŒ HMRã€‚

è¿™å…è®¸æˆ‘ä»¬ç›´æ¥ä½¿ç”¨ Reactï¼Œæ— éœ€ä»»ä½•æ‰“åŒ…å·¥å…·å¦‚ Vite æˆ– Webpackã€‚

ä½ å¯ä»¥ä½¿ç”¨[æ­¤ç¤ºä¾‹](https://github.com/saltyaom/elysia-fullstack-example)å¿«é€Ÿä½“éªŒã€‚

å¦åˆ™ï¼Œè¯·æ‰‹åŠ¨å®‰è£…ï¼š

1. å®‰è£… Elysia é™æ€èµ„æºæ’ä»¶

```ts
import { Elysia } from 'elysia'
import { staticPlugin } from '@elysiajs/static'

new Elysia()
	.use(await staticPlugin()) // [!code ++]
	.listen(3000)
```

:::tip
æ³¨æ„ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `staticPlugin()` å‰åŠ ä¸Š `await`ï¼Œä»¥å¯ç”¨å…¨æ ˆå¼€å‘æœåŠ¡å™¨ã€‚

è¿™æ˜¯è®¾ç½®å¿…è¦çš„ HMR é’©å­æ‰€å¿…éœ€çš„ã€‚
:::

2. åˆ›å»º **public/index.html** å’Œ **index.tsx**

::: code-group

```html [public/index.html]
<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Elysia React åº”ç”¨</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>
	<body>
		<div id="root"></div>
		<script type="module" src="./index.tsx"></script>
	</body>
</html>
```

```tsx [public/index.tsx]
import { useState } from 'react'
import { createRoot } from 'react-dom/client'

function App() {
	const [count, setCount] = useState(0)
	const increase = () => setCount((c) => c + 1)

	return (
		<main>
			<h2>{count}</h2>
			<button onClick={increase}>
				å¢åŠ 
			</button>
		</main>
	)
}

const root = createRoot(document.getElementById('root')!)
root.render(<App />)
```

:::

3. åœ¨ tsconfig.json ä¸­å¯ç”¨ JSX

```json
{
  "compilerOptions": {
	"jsx": "react-jsx" // [!code ++]
  }
}
```

4. è®¿é—® `http://localhost:3000/public` æŸ¥çœ‹æ•ˆæœã€‚

è¿™å…è®¸æˆ‘ä»¬åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­å¼€å‘å‰ç«¯å’Œåç«¯ï¼Œæ— éœ€ä»»ä½•æ‰“åŒ…å·¥å…·ã€‚

æˆ‘ä»¬å·²éªŒè¯å…¨æ ˆå¼€å‘æœåŠ¡å™¨æ”¯æŒ HMRã€[Tailwind](#tailwind)ã€Tanstack Queryã€[Eden Treaty](/eden/overview) ä»¥åŠè·¯å¾„åˆ«åã€‚

## è‡ªå®šä¹‰å‰ç¼€è·¯å¾„

æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘ `staticPlugin` ä¼ å…¥ `prefix` é€‰é¡¹ï¼Œä¿®æ”¹é»˜è®¤çš„ `/public` å‰ç¼€ã€‚

```ts
import { Elysia } from 'elysia'
import { staticPlugin } from '@elysiajs/static'

new Elysia()
  	.use(
  		await staticPlugin({
  			prefix: '/' // [!code ++]
   		})
   )
  .listen(3000)
```

è¿™æ ·é™æ€æ–‡ä»¶å°±ä¼šæŒ‚è½½åˆ° `/` è€Œé `/public`ã€‚

æ›´å¤šé…ç½®é€‰é¡¹è¯·æŸ¥çœ‹[é™æ€èµ„æºæ’ä»¶](/plugins/static)ã€‚

## Tailwind CSS

æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ Bun å…¨æ ˆå¼€å‘æœåŠ¡å™¨ä¸­ä½¿ç”¨ Tailwind CSSã€‚

1. å®‰è£…ä¾èµ–

```bash
bun add tailwindcss@4
bun add -d bun-plugin-tailwind
```

2. åˆ›å»º `bunfig.toml`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```toml
[serve.static]
plugins = ["bun-plugin-tailwind"]
```

3. åˆ›å»ºåŒ…å« Tailwind æŒ‡ä»¤çš„ CSS æ–‡ä»¶

::: code-group

```css [public/global.css]
@tailwind base;
```

:::

4. å°† Tailwind æ·»åŠ åˆ°ä½ çš„ HTML æ–‡ä»¶ï¼Œæˆ–ä½œä¸ºæ›¿ä»£ï¼Œå°†å…¶å¼•å…¥ JavaScript/TypeScript æ–‡ä»¶

::: code-group

```html [public/index.html]
<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>Elysia React åº”ç”¨</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0">
  		<link rel="stylesheet" href="tailwindcss"> <!-- [!code ++] -->
	</head>
	<body>
		<div id="root"></div>
		<script type="module" src="./index.tsx"></script>
	</body>
</html>
```

```tsx [public/index.tsx]
import { useState } from 'react'
import { createRoot } from 'react-dom/client'

import './global.css' // [!code ++]

function App() {
	const [count, setCount] = useState(0)
	const increase = () => setCount((c) => c + 1)

	return (
		<main>
			<h2>{count}</h2>
			<button onClick={increase}>
				å¢åŠ 
			</button>
		</main>
	)
}

const root = createRoot(document.getElementById('root')!)
root.render(<App />)
```

:::

## è·¯å¾„åˆ«å

æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ Bun å…¨æ ˆå¼€å‘æœåŠ¡å™¨ä¸­ä½¿ç”¨è·¯å¾„åˆ«åã€‚

1. åœ¨ `tsconfig.json` ä¸­æ·»åŠ  `paths`

```json
{
  "compilerOptions": {
	"baseUrl": ".", // [!code ++]
	"paths": { // [!code ++]
	  "@public/*": ["public/*"] // [!code ++]
	} // [!code ++]
  }
}
```

2. åœ¨ä»£ç ä¸­ä½¿ç”¨åˆ«å

```tsx
import { useState } from 'react'
import { createRoot } from 'react-dom/client'

import '@public/global.css' // [!code ++]

function App() {
	const [count, setCount] = useState(0)
	const increase = () => setCount((c) => c + 1)

	return (
		<main>
			<h2>{count}</h2>
			<button onClick={increase}>
				å¢åŠ 
			</button>
		</main>
	)
}

const root = createRoot(document.getElementById('root')!)
root.render(<App />)
```

è¿™ä¼šå¼€ç®±å³ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

## ç”Ÿäº§ç¯å¢ƒæ„å»º

ä½ å¯ä»¥åƒæ„å»ºæ™®é€š Elysia æœåŠ¡å™¨ä¸€æ ·æ„å»ºå…¨æ ˆæœåŠ¡å™¨ã€‚

```bash
bun build --compile --target bun --outfile server src/index.ts
```

è¿™ä¼šç”Ÿæˆä¸€ä¸ªå•ä¸€å¯æ‰§è¡Œæ–‡ä»¶ **server**ã€‚

è¿è¡Œ **server** å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œè¯·ç¡®ä¿åŒ…å« **public** æ–‡ä»¶å¤¹ï¼Œä¸å¼€å‘ç¯å¢ƒç±»ä¼¼ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è§[éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ](/patterns/deploy)ã€‚

---

---
url: 'https://elysiajs.com/key-concept.md'
---

# å…³é”®æ¦‚å¿µ&#x20;

Elysia æ‹¥æœ‰ä¸€äº›éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œæ‚¨éœ€è¦ç†è§£å®ƒä»¬æ‰èƒ½ä½¿ç”¨ã€‚

æœ¬é¡µé¢æ¶µç›–äº†åœ¨å¼€å§‹ä½¿ç”¨ä¹‹å‰æ‚¨åº”è¯¥äº†è§£çš„å¤§å¤šæ•°æ¦‚å¿µã€‚

## å°è£…&#x20;

Elysia çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä»…**å°è£…**åœ¨å…¶è‡ªèº«å®ä¾‹å†…ã€‚

è¿™æ„å‘³ç€å¦‚æœæ‚¨åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå®ƒä¸ä¼šä¸å…¶ä»–å®ä¾‹å…±äº«ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚

```ts
import { Elysia } from 'elysia'

const profile = new Elysia()
	.onBeforeHandle(({ cookie }) => {
		throwIfNotSignIn(cookie)
	})
	.get('/profile', () => 'Hi there!')

const app = new Elysia()
	.use(profile)
	// âš ï¸ è¿™é‡Œå°†ä¸ä¼šæœ‰ç™»å½•æ£€æŸ¥
	.patch('/rename', ({ body }) => updateProfile(body))
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`isSignIn` æ£€æŸ¥ä»…åº”ç”¨åœ¨ `profile`ï¼Œè€Œä¸ä¼šåº”ç”¨åœ¨ `app`ã€‚

> è¯•ç€åœ¨åœ°å€æ ä¸­æ”¹ä¸ºè®¿é—® **/rename** å¹¶æŸ¥çœ‹ç»“æœ

**Elysia é»˜è®¤ä¼šéš”ç¦»ç”Ÿå‘½å‘¨æœŸ**ï¼Œé™¤éæ˜ç¡®è¯´æ˜ã€‚è¿™ç±»ä¼¼äº JavaScript ä¸­çš„ **export**ï¼Œä½ éœ€è¦å¯¼å‡ºå‡½æ•°æ‰èƒ½è®©å®ƒåœ¨æ¨¡å—å¤–å¯ç”¨ã€‚

è‹¥è¦å°†ç”Ÿå‘½å‘¨æœŸâ€œå¯¼å‡ºâ€åˆ°å…¶ä»–å®ä¾‹ï¼Œæ‚¨å¿…é¡»æŒ‡å®šä½œç”¨åŸŸã€‚

```ts
import { Elysia } from 'elysia'

const profile = new Elysia()
	.onBeforeHandle(
		{ as: 'global' }, // [!code ++]
		({ cookie }) => {
			throwIfNotSignIn(cookie)
		}
	)
	.get('/profile', () => 'Hi there!')

const app = new Elysia()
	.use(profile)
	// è¿™é‡Œå°†æœ‰ç™»å½•æ£€æŸ¥
	.patch('/rename', ({ body }) => updateProfile(body))
```

å°†ç”Ÿå‘½å‘¨æœŸä½œç”¨åŸŸè®¾ç½®ä¸º **"global"** å°†å…¶å¯¼å‡ºåˆ° **æ‰€æœ‰å®ä¾‹**ã€‚

æ›´å¤šå†…å®¹è¯·è§ [scope](/essential/plugin.html#scope-level)ã€‚

## æ–¹æ³•é“¾&#x20;

Elysia ä»£ç åº”**å§‹ç»ˆ**ä½¿ç”¨æ–¹æ³•é“¾ã€‚

è¿™å¯¹**ç¡®ä¿ç±»å‹å®‰å…¨**éå¸¸é‡è¦ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .state('build', 1)
    // store æ˜¯ä¸¥æ ¼ç±»å‹ // [!code ++]
    .get('/', ({ store: { build } }) => build)
                        // ^?
    .listen(3000)
```

åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ**state** è¿”å›ä¸€ä¸ªæ–°çš„ **ElysiaInstance** ç±»å‹ï¼Œé™„å¸¦äº†ç±»å‹åŒ–çš„ `build` å±æ€§ã€‚

### ä¸ä½¿ç”¨æ–¹æ³•é“¾

å› ä¸º Elysia çš„ç±»å‹ç³»ç»Ÿå¾ˆå¤æ‚ï¼ŒElysia ä¸­çš„æ¯ä¸ªæ–¹æ³•éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ç±»å‹å¼•ç”¨ã€‚

å¦‚æœä¸ä½¿ç”¨æ–¹æ³•é“¾ï¼ŒElysia ä¸ä¼šä¿å­˜è¿™äº›æ–°ç±»å‹ï¼Œå¯¼è‡´æ— æ³•è¿›è¡Œç±»å‹æ¨æ–­ã€‚

```typescript twoslash
// @errors: 2339
import { Elysia } from 'elysia'

const app = new Elysia()

app.state('build', 1)

app.get('/', ({ store: { build } }) => build)

app.listen(3000)
```

æˆ‘ä»¬å»ºè®®æ‚¨**å§‹ç»ˆä½¿ç”¨æ–¹æ³•é“¾**ä»¥ä¾¿è·å¾—å‡†ç¡®çš„ç±»å‹æ¨æ–­ã€‚

## ä¾èµ–&#x20;

Elysia å¤©ç„¶ç”±å¤šä¸ªå¾®å‹çš„ Elysia åº”ç”¨ç»„æˆï¼Œè¿™äº›å®ä¾‹å¯ä»¥åƒå¾®æœåŠ¡ä¸€æ ·**ç‹¬ç«‹è¿è¡Œ**å¹¶ç›¸äº’é€šä¿¡ã€‚

æ¯ä¸ª Elysia å®ä¾‹éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œ**å¹¶ä¸”å¯ä»¥ä½œä¸ºç‹¬ç«‹æœåŠ¡å™¨è¿è¡Œ**ã€‚

å½“ä¸€ä¸ªå®ä¾‹éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªå®ä¾‹çš„æœåŠ¡æ—¶ï¼Œæ‚¨**å¿…é¡»æ˜¾å¼å£°æ˜ä¾èµ–**ã€‚

```ts twoslash
// @errors: 2339
import { t } from 'elysia'

abstract class Auth {
	static getProfile() {
		return {
			name: 'Elysia User'
		}
	}

	static models = {
		user: t.Object({
			name: t.String()
		})
	} as const
}
// ---cut---
import { Elysia } from 'elysia'

const auth = new Elysia()
	.decorate('Auth', Auth)
	.model(Auth.models)

const main = new Elysia()
 	// âŒ ç¼ºå°‘ 'auth'
	.get('/', ({ Auth }) => Auth.getProfile())
	// éœ€è¦ä½¿ç”¨ auth æ¥è°ƒç”¨ Auth çš„æœåŠ¡
	.use(auth) // [!code ++]
	.get('/profile', ({ Auth }) => Auth.getProfile())
//                                        ^?



// ---cut-after---
```

è¿™ç±»ä¼¼äº**ä¾èµ–æ³¨å…¥**ï¼Œæ¯ä¸ªå®ä¾‹å¿…é¡»å£°æ˜å®ƒè‡ªèº«çš„ä¾èµ–ã€‚

è¿™ç§æ–¹å¼å¼ºåˆ¶æ‚¨æ˜¾å¼å£°æ˜ä¾èµ–ï¼Œåˆ©äºä¾èµ–è·Ÿè¸ªå’Œæ¨¡å—åŒ–ã€‚

### å»é‡&#x20;

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ’ä»¶åœ¨åº”ç”¨åˆ°å¦ä¸€ä¸ªå®ä¾‹æ—¶éƒ½ä¼š**æ¯æ¬¡æ‰§è¡Œ**ã€‚

ä¸ºé˜²æ­¢é‡å¤æ‰§è¡Œï¼ŒElysia å¯ä»¥é€šè¿‡ä¸ºå®ä¾‹æ·»åŠ **å”¯ä¸€æ ‡è¯†ç¬¦**ï¼Œä½¿ç”¨ `name` ä»¥åŠå¯é€‰çš„ `seed` å±æ€§ï¼Œæ¥å®ç°ç”Ÿå‘½å‘¨æœŸçš„å»é‡ã€‚

```ts twoslash
import { Elysia } from 'elysia'

// `name` æ˜¯å”¯ä¸€æ ‡è¯†ç¬¦
const ip = new Elysia({ name: 'ip' }) // [!code ++]
	.derive(
		{ as: 'global' },
		({ server, request }) => ({
			ip: server?.requestIP(request)
		})
	)
	.get('/ip', ({ ip }) => ip)

const router1 = new Elysia()
	.use(ip)
	.get('/ip-1', ({ ip }) => ip)

const router2 = new Elysia()
	.use(ip)
	.get('/ip-2', ({ ip }) => ip)

const server = new Elysia()
	.use(router1)
	.use(router2)
```

ä¸ºå®ä¾‹æ·»åŠ  `name` å±æ€§ä¼šè®©å®ƒæˆä¸ºå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä»è€Œé˜²æ­¢é‡å¤è°ƒç”¨ã€‚

æ›´å¤šå†…å®¹è¯·è§ [æ’ä»¶å»é‡](/essential/plugin.html#plugin-deduplication)ã€‚

### å…¨å±€ä¾èµ– vs æ˜¾å¼ä¾èµ–

æœ‰äº›æƒ…å†µä¸‹ä½¿ç”¨å…¨å±€ä¾èµ–æ¯”æ˜¾å¼ä¾èµ–æ›´åˆé€‚ã€‚

**å…¨å±€** æ’ä»¶ç¤ºä¾‹ï¼š

* **ä¸æ·»åŠ ç±»å‹çš„æ’ä»¶** â€”â€” å¦‚ corsã€compressã€helmet
* æ·»åŠ å…¨å±€ç”Ÿå‘½å‘¨æœŸä¸”æ— å®ä¾‹åº”æ§åˆ¶çš„æ’ä»¶ â€”â€” å¦‚ tracing, logging

ç¤ºä¾‹ç”¨ä¾‹ï¼š

* OpenAPI/Open - å…¨å±€æ–‡æ¡£
* OpenTelemetry - å…¨å±€è¿½è¸ªå™¨
* Logging - å…¨å±€æ—¥å¿—å™¨

è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ›å»ºä¸ºå…¨å±€ä¾èµ–æ›´æœ‰æ„ä¹‰ï¼Œè€Œä¸æ˜¯å°†å®ƒåº”ç”¨åˆ°æ¯ä¸ªå®ä¾‹ã€‚

ç„¶è€Œï¼Œå¦‚æœæ‚¨çš„ä¾èµ–ä¸ç¬¦åˆä¸Šè¿°ç±»åˆ«ï¼Œåˆ™å»ºè®®ä½¿ç”¨**æ˜¾å¼ä¾èµ–**ã€‚

**æ˜¾å¼ä¾èµ–** ç¤ºä¾‹ï¼š

* **æ·»åŠ ç±»å‹çš„æ’ä»¶** â€”â€” å¦‚ macroã€stateã€model
* æ·»åŠ ä¸šåŠ¡é€»è¾‘ä¸”å®ä¾‹å¯äº¤äº’çš„æ’ä»¶ â€”â€” å¦‚ Authã€Database

ç¤ºä¾‹ç”¨ä¾‹ï¼š

* çŠ¶æ€ç®¡ç† â€”â€” å¦‚ Storeã€Session
* æ•°æ®å»ºæ¨¡ â€”â€” å¦‚ ORMã€ODM
* ä¸šåŠ¡é€»è¾‘ â€”â€” å¦‚ Authã€Database
* åŠŸèƒ½æ¨¡å— â€”â€” å¦‚ Chatã€Notification

## ä»£ç é¡ºåº&#x20;

Elysia çš„ç”Ÿå‘½å‘¨æœŸä»£ç é¡ºåºéå¸¸é‡è¦ã€‚

äº‹ä»¶åªä¼šå¯¹æ³¨å†Œä¹‹åçš„è·¯ç”±ç”Ÿæ•ˆã€‚

å¦‚æœæŠŠ onError æ”¾åœ¨æ’ä»¶ä¹‹å‰ï¼Œæ’ä»¶å°†ä¸ä¼šç»§æ‰¿è¯¥ onError äº‹ä»¶ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
 	.onBeforeHandle(() => {
        console.log('1')
    })
	.get('/', () => 'hi')
    .onBeforeHandle(() => {
        console.log('2')
    })
    .listen(3000)
```

æ§åˆ¶å°åº”æ‰“å°ï¼š

```bash
1
```

æ³¨æ„æœªæ‰“å° **2**ï¼Œå› ä¸ºäº‹ä»¶æ˜¯åœ¨è·¯ç”±ä¹‹åæ³¨å†Œçš„ï¼Œæ‰€ä»¥ä¸ä¼šå¯¹è¯¥è·¯ç”±ç”Ÿæ•ˆã€‚

æ›´å¤šå†…å®¹è¯·è§ [ä»£ç é¡ºåº](/essential/life-cycle.html#order-of-code)ã€‚

## ç±»å‹æ¨æ–­

Elysia æ‹¥æœ‰å¤æ‚çš„ç±»å‹ç³»ç»Ÿï¼Œå…è®¸æ‚¨ä»å®ä¾‹æ¨æ–­ç±»å‹ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

const app = new Elysia()
	.post('/', ({ body }) => body, {
                // ^?

		body: t.Object({
			name: t.String()
		})
	})
```

æ‚¨åº”**å§‹ç»ˆä½¿ç”¨å†…è”å‡½æ•°**ä»¥è·å¾—å‡†ç¡®çš„ç±»å‹æ¨æ–­ã€‚

å¦‚æœæ‚¨éœ€è¦ä½¿ç”¨ç‹¬ç«‹å‡½æ•°ï¼Œæ¯”å¦‚ MVC æ§åˆ¶å™¨æ¨¡å¼ï¼Œå»ºè®®ä»å†…è”å‡½æ•°ä¸­è§£æ„æ‰€éœ€å±æ€§ï¼Œä»¥é¿å…ä¸å¿…è¦çš„ç±»å‹æ¨æ–­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```ts twoslash
import { Elysia, t } from 'elysia'

abstract class Controller {
	static greet({ name }: { name: string }) {
		return 'hello ' + name
	}
}

const app = new Elysia()
	.post('/', ({ body }) => Controller.greet(body), {
		body: t.Object({
			name: t.String()
		})
	})
```

è¯¦è§ [æœ€ä½³å®è·µï¼šMVC æ§åˆ¶å™¨](/essential/best-practice.html#controller)ã€‚

### TypeScript

æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¿é—® `static` å±æ€§æ¥è·å–æ¯ä¸ª Elysia/TypeBox ç±»å‹çš„ç±»å‹å®šä¹‰ï¼š

```ts twoslash
import { t } from 'elysia'

const MyType = t.Object({
	hello: t.Literal('Elysia')
})

type MyType = typeof MyType.static
//    ^?
```

è¿™ä½¿å¾— Elysia èƒ½å¤Ÿè‡ªåŠ¨æ¨æ–­å¹¶æä¾›ç±»å‹ï¼Œå‡å°‘äº†é‡å¤å£°æ˜ schema çš„éœ€æ±‚ã€‚

å•ä¸ª Elysia/TypeBox schema å¯ç”¨äºï¼š

* è¿è¡Œæ—¶éªŒè¯
* æ•°æ®å¼ºåˆ¶è½¬æ¢
* TypeScript ç±»å‹
* OpenAPI schema

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°† schema ä½œä¸º**å•ä¸€å¯ä¿¡æº**ã€‚

---

---
url: 'https://elysiajs.com/essential/best-practice.md'
---

# æœ€ä½³å®è·µ

Elysia æ˜¯ä¸€ä¸ªä¸æ¨¡å¼æ— å…³çš„æ¡†æ¶ï¼Œç¼–ç æ¨¡å¼çš„é€‰æ‹©ç•™ç»™ä½ å’Œä½ çš„å›¢é˜Ÿå†³å®šã€‚

ç„¶è€Œï¼Œåœ¨å°è¯•ç”¨ Elysia é€‚é… MVC æ¨¡å¼ [(æ¨¡å‹-è§†å›¾-æ§åˆ¶å™¨)](https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller) æ—¶ï¼Œå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæˆ‘ä»¬å‘ç°å¾ˆéš¾å®ç°è§£è€¦å’Œå¤„ç†ç±»å‹ã€‚

æœ¬é¡µé¢æ˜¯ç»“åˆ MVC æ¨¡å¼éµå¾ª Elysia ç»“æ„æœ€ä½³å®è·µçš„æŒ‡å—ï¼Œä½†åŒæ ·å¯ä»¥é€‚é…ä½ å–œæ¬¢çš„ä»»ä½•ç¼–ç æ¨¡å¼ã€‚

## æ–‡ä»¶å¤¹ç»“æ„

Elysia å¯¹æ–‡ä»¶å¤¹ç»“æ„æŒæ— åè§æ€åº¦ï¼Œç•™ç»™ä½  **è‡ªå·±å†³å®š** å¦‚ä½•ç»„ç»‡ä»£ç ã€‚

ä¸è¿‡ï¼Œ**å¦‚æœä½ æ²¡æœ‰å…·ä½“ç»“æ„æƒ³æ³•**ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨åŸºäºåŠŸèƒ½çš„æ–‡ä»¶å¤¹ç»“æ„ï¼Œæ¯ä¸ªåŠŸèƒ½éƒ½æœ‰è‡ªå·±çš„æ–‡ä»¶å¤¹ï¼ŒåŒ…å«æ§åˆ¶å™¨ã€æœåŠ¡ä»¥åŠæ¨¡å‹ã€‚

```
| src
  | modules
	| auth
	  | index.ts (Elysia æ§åˆ¶å™¨)
	  | service.ts (æœåŠ¡)
	  | model.ts (æ¨¡å‹)
	| user
	  | index.ts (Elysia æ§åˆ¶å™¨)
	  | service.ts (æœåŠ¡)
	  | model.ts (æ¨¡å‹)
  | utils
	| a
	  | index.ts
	| b
	  | index.ts
```

è¯¥ç»“æ„æ–¹ä¾¿ä½ æŸ¥æ‰¾å’Œç®¡ç†ä»£ç ï¼Œå°†ç›¸å…³ä»£ç èšé›†åœ¨ä¸€èµ·ã€‚

ä»¥ä¸‹ç¤ºä¾‹ä»£ç å±•ç¤ºäº†å¦‚ä½•åˆ†é…ä»£ç åˆ°åŸºäºåŠŸèƒ½çš„æ–‡ä»¶å¤¹ç»“æ„ï¼š

::: code-group

```typescript [auth/index.ts]
// æ§åˆ¶å™¨å¤„ç† HTTP ç›¸å…³ï¼Œå¦‚è·¯ç”±ï¼Œè¯·æ±‚éªŒè¯
import { Elysia } from 'elysia'

import { Auth } from './service'
import { AuthModel } from './model'

export const auth = new Elysia({ prefix: '/auth' })
	.get(
		'/sign-in',
		async ({ body, cookie: { session } }) => {
			const response = await Auth.signIn(body)

			// è®¾ç½® session cookie
			session.value = response.token

			return response
		}, {
			body: AuthModel.signInBody,
			response: {
				200: AuthModel.signInResponse,
				400: AuthModel.signInInvalid
			}
		}
	)
```

```typescript [auth/service.ts]
// æœåŠ¡å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä¸ Elysia æ§åˆ¶å™¨è§£è€¦
import { status } from 'elysia'

import type { AuthModel } from './model'

// å¦‚æœç±»ä¸éœ€è¦å­˜å‚¨å±æ€§ï¼Œ
// å¯ä»¥ä½¿ç”¨ `abstract class` é¿å…åˆ›å»ºå®ä¾‹
export abstract class Auth {
	static async signIn({ username, password }: AuthModel.signInBody) {
		const user = await sql`
			SELECT password
			FROM users
			WHERE username = ${username}
			LIMIT 1`

		if (await Bun.password.verify(password, user.password))
			// å¯ä»¥ç›´æ¥æŠ›å‡º HTTP é”™è¯¯
			throw status(
				400,
				'Invalid username or password' satisfies AuthModel.signInInvalid
			)

		return {
			username,
			token: await generateAndSaveTokenToDB(user.id)
		}
	}
}
```

```typescript [auth/model.ts]
// æ¨¡å‹å®šä¹‰è¯·æ±‚å’Œå“åº”çš„æ•°æ®ç»“æ„åŠéªŒè¯
import { t } from 'elysia'

export namespace AuthModel {
	// å®šä¹‰ç”¨äº Elysia éªŒè¯çš„ DTO
	export const signInBody = t.Object({
		username: t.String(),
		password: t.String(),
	})

	// å®šä¹‰ TypeScript ç±»å‹
	export type signInBody = typeof signInBody.static

	// å…¶ä»–æ¨¡å‹ä¾æ­¤ç±»æ¨
	export const signInResponse = t.Object({
		username: t.String(),
		token: t.String(),
	})

	export type signInResponse = typeof signInResponse.static

	export const signInInvalid = t.Literal('Invalid username or password')
	export type signInInvalid = typeof signInInvalid.static
}
```

:::

æ¯ä¸ªæ–‡ä»¶çš„èŒè´£å¦‚ä¸‹ï¼š

* **æ§åˆ¶å™¨**ï¼šå¤„ç† HTTP è·¯ç”±ã€è¯·æ±‚éªŒè¯å’Œ Cookieã€‚
* **æœåŠ¡**ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œå°½é‡ä¸ Elysia æ§åˆ¶å™¨è§£è€¦ã€‚
* **æ¨¡å‹**ï¼šå®šä¹‰è¯·æ±‚å’Œå“åº”çš„æ•°æ®ç»“æ„åŠéªŒè¯ã€‚

å¯ä»¥æ ¹æ®ä½ çš„éœ€æ±‚è°ƒæ•´æ­¤ç»“æ„ï¼Œå¹¶ä½¿ç”¨ä½ å–œæ¬¢çš„ä»»ä½•ç¼–ç æ¨¡å¼ã€‚

## æ§åˆ¶å™¨

é‰´äº Elysia çš„ç±»å‹ç³»ç»Ÿå¥å£®ï¼Œæˆ‘ä»¬ä¸æ¨èä½¿ç”¨ä¼ ç»Ÿçš„ç´§è€¦åˆ Elysia `Context` çš„æ§åˆ¶å™¨ç±»ï¼Œå› ä¸ºï¼š

1. **Elysia ç±»å‹å¤æ‚**ï¼Œä¸”å¼ºä¾èµ–æ’ä»¶åŠå¤šå±‚é“¾å¼è°ƒç”¨ã€‚
2. **éš¾ä»¥å‡†ç¡®ç±»å‹åŒ–**ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨è£…é¥°å™¨å’Œå­˜å‚¨æ—¶ï¼ŒElysia ç±»å‹å¯èƒ½éšæ—¶å˜åŒ–ã€‚
3. **ç±»å‹å®Œæ•´æ€§ä¸¢å¤±**ï¼Œä»£ç çš„ç±»å‹å’Œè¿è¡Œæ—¶ä¸ä¸€è‡´ã€‚

æ¨èä»¥ä¸‹ä¸¤ç§æ–¹å¼å®ç° Elysia æ§åˆ¶å™¨ï¼š

1. ä½¿ç”¨ Elysia å®ä¾‹æœ¬èº«ä½œä¸ºæ§åˆ¶å™¨
2. åˆ›å»ºä¸ä¾èµ–äº HTTP è¯·æ±‚æˆ– Elysia çš„æ§åˆ¶å™¨

***

### 1. ä½¿ç”¨ Elysia å®ä¾‹ä½œä¸ºæ§åˆ¶å™¨

> 1 ä¸ª Elysia å®ä¾‹ = 1 ä¸ªæ§åˆ¶å™¨

å°† Elysia å®ä¾‹è§†ä¸ºæ§åˆ¶å™¨ï¼Œç›´æ¥åœ¨ Elysia å®ä¾‹ä¸Šå®šä¹‰è·¯ç”±ã€‚

```typescript
// âœ… æ¨èåšæ³•
import { Elysia } from 'elysia'
import { Service } from './service'

new Elysia()
    .get('/', ({ stuff }) => {
        Service.doStuff(stuff)
    })
```

è¯¥æ–¹å¼å…è®¸ Elysia è‡ªåŠ¨æ¨æ–­ `Context` ç±»å‹ï¼Œä¿è¯ç±»å‹å®Œæ•´æ€§å’Œè¿è¡Œæ—¶ä¸ç±»å‹çš„ä¸€è‡´æ€§ã€‚

```typescript
// âŒ ä¸æ¨è
import { Elysia, t, type Context } from 'elysia'

abstract class Controller {
    static root(context: Context) {
        return Service.doStuff(context.stuff)
    }
}

new Elysia()
    .get('/', Controller.root)
```

è¯¥æ–¹å¼éš¾ä»¥æ­£ç¡®ç±»å‹åŒ– `Context`ï¼Œå¯èƒ½å¯¼è‡´ç±»å‹å®Œæ•´æ€§ä¸¢å¤±ã€‚

### 2. ä¸ä¾èµ– HTTP è¯·æ±‚çš„æ§åˆ¶å™¨

è‹¥è¦åˆ›å»ºæ§åˆ¶å™¨ç±»ï¼Œå»ºè®®åˆ›å»ºä¸ HTTP è¯·æ±‚æˆ– Elysia å®Œå…¨æ— å…³çš„ç±»ã€‚

è¿™æ ·å…è®¸ä½ è§£è€¦æ§åˆ¶å™¨å’Œ Elysiaï¼Œä½¿æµ‹è¯•ã€å¤ç”¨ï¼Œç”šè‡³æ›¿æ¢æ¡†æ¶æ›´ä¸ºç®€å•ï¼ŒåŒæ—¶ä¿æŒ MVC æ¨¡å¼ã€‚

```typescript
import { Elysia } from 'elysia'

abstract class Controller {
	static doStuff(stuff: string) {
		return Service.doStuff(stuff)
	}
}

new Elysia()
	.get('/', ({ stuff }) => Controller.doStuff(stuff))
```

ç»‘å®šæ§åˆ¶å™¨åˆ° Elysia Context å¯èƒ½å¯¼è‡´ï¼š

1. ç±»å‹å®Œæ•´æ€§ä¸¢å¤±
2. ä¸æ˜“æµ‹è¯•å’Œå¤ç”¨
3. äº§ç”Ÿå‚å•†é”å®š

æ¨èå°½é‡è®©æ§åˆ¶å™¨ä¸ Elysia è§£è€¦ã€‚

### âŒ ä¸æ¨èï¼šä¼ é€’æ•´ä¸ª `Context` ç»™æ§åˆ¶å™¨

**Context æ˜¯é«˜åº¦åŠ¨æ€çš„ç±»å‹**ï¼Œå¯ç”± Elysia å®ä¾‹æ¨æ–­ã€‚

ä¸è¦å°†æ•´ä¸ª `Context` ä¼ ç»™æ§åˆ¶å™¨ï¼Œåº”é€šè¿‡å¯¹è±¡è§£æ„æå–æ‰€éœ€å‚æ•°ä¼ å…¥ã€‚

```typescript
import type { Context } from 'elysia'

abstract class Controller {
	constructor() {}

	// âŒ ä¸è¦è¿™æ ·åš
	static root(context: Context) {
		return Service.doStuff(context.stuff)
	}
}
```

æ­¤åšæ³•éš¾ä»¥æ­£ç¡®ç±»å‹åŒ– `Context`ï¼Œå¯èƒ½å¯¼è‡´ç±»å‹å®Œæ•´æ€§ä¸§å¤±ã€‚

### æµ‹è¯•

å¦‚æœä½¿ç”¨ Elysia ä½œä¸ºæ§åˆ¶å™¨ï¼Œå¯ç”¨ `handle` æ–¹æ³•ç›´æ¥è°ƒç”¨å‡½æ•°ï¼ˆåŒ…æ‹¬å…¶ç”Ÿå‘½å‘¨æœŸï¼‰è¿›è¡Œæµ‹è¯•ï¼š

```typescript
import { Elysia } from 'elysia'
import { Service } from './service'

import { describe, it, expect } from 'bun:test'

const app = new Elysia()
    .get('/', ({ stuff }) => {
        Service.doStuff(stuff)

        return 'ok'
    })

describe('Controller', () => {
	it('should work', async () => {
		const response = await app
			.handle(new Request('http://localhost/'))
			.then((x) => x.text())

		expect(response).toBe('ok')
	})
})
```

æ›´å¤šæµ‹è¯•ä¿¡æ¯å¯æŸ¥çœ‹ [å•å…ƒæµ‹è¯•](/patterns/unit-test.html)ã€‚

## æœåŠ¡

æœåŠ¡æ˜¯ä¸€ç»„è§£è€¦çš„å·¥å…·/è¾…åŠ©å‡½æ•°ï¼Œç”¨äºæ¨¡å—/æ§åˆ¶å™¨ä¸­çš„ä¸šåŠ¡é€»è¾‘ã€‚

æ‰€æœ‰å¯ä»¥ä¸æ§åˆ¶å™¨è§£è€¦çš„æŠ€æœ¯é€»è¾‘ï¼Œéƒ½å¯ä»¥æ”¾åœ¨ **æœåŠ¡** ä¸­ã€‚

Elysia ä¸­æœ‰ä¸¤ç§æœåŠ¡ç±»å‹ï¼š

1. éè¯·æ±‚ä¾èµ–çš„æœåŠ¡
2. è¯·æ±‚ä¾èµ–çš„æœåŠ¡

### 1. æŠ½è±¡éè¯·æ±‚ä¾èµ–æœåŠ¡

æ¨èå°†æœåŠ¡ç±»/å‡½æ•°æŠ½è±¡å‡ºæ¥ï¼Œç‹¬ç«‹äº Elysiaã€‚

å¦‚æœæœåŠ¡æˆ–å‡½æ•°ä¸ä¾èµ– HTTP è¯·æ±‚æˆ–ä¸è®¿é—® `Context`ï¼Œå»ºè®®å®ç°ä¸ºé™æ€ç±»æˆ–å‡½æ•°ã€‚

```typescript
import { Elysia, t } from 'elysia'

abstract class Service {
    static fibo(number: number): number {
        if(number < 2)
            return number

        return Service.fibo(number - 1) + Service.fibo(number - 2)
    }
}

new Elysia()
    .get('/fibo', ({ body }) => {
        return Service.fibo(body)
    }, {
        body: t.Numeric()
    })
```

å¦‚æœæœåŠ¡ä¸éœ€å­˜å‚¨å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨ `abstract class` å’Œ `static` é¿å…å®ä¾‹åŒ–ã€‚

### 2. è¯·æ±‚ä¾èµ–æœåŠ¡ä½œä¸º Elysia å®ä¾‹

**å¦‚æœæœåŠ¡æ˜¯è¯·æ±‚ä¾èµ–çš„**ï¼Œæˆ–éœ€è¦å¤„ç† HTTP è¯·æ±‚ï¼Œæ¨èæŠ½è±¡æˆ Elysia å®ä¾‹ä»¥ä¿è¯ç±»å‹å®Œæ•´æ€§å’Œæ¨æ–­ï¼š

```typescript
import { Elysia } from 'elysia'

// âœ… æ¨èåšæ³•
const AuthService = new Elysia({ name: 'Auth.Service' })
    .macro({
        isSignIn: {
            resolve({ cookie, status }) {
                if (!cookie.session.value) return status(401)

                return {
                	session: cookie.session.value,
                }
            }
        }
    })

const UserController = new Elysia()
    .use(AuthService)
    .get('/profile', ({ Auth: { user } }) => user, {
    	isSignIn: true
    })
```

::: tip
Elysia é»˜è®¤æ”¯æŒ[æ’ä»¶å»é‡](/essential/plugin.html#plugin-deduplication)ï¼Œä½ æ— éœ€æ‹…å¿ƒæ€§èƒ½é—®é¢˜ï¼Œåªè¦æŒ‡å®š **"name"** å±æ€§ï¼Œå³ä¿è¯ä¸ºå•ä¾‹ã€‚
:::

### âœ… æ¨èï¼šåªè£…é¥°è¯·æ±‚ä¾èµ–å±æ€§

å»ºè®® `decorate` ä»…ç”¨äºè¯·æ±‚ä¾èµ–å±æ€§ï¼Œå¦‚ `requestIP`ã€`requestTime` æˆ– `session`ã€‚

è¿‡åº¦ä½¿ç”¨è£…é¥°å™¨ä¼šä½¿ä»£ç ç´§è€¦åˆ Elysiaï¼Œå½±å“æµ‹è¯•å’Œå¤ç”¨ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.decorate('requestIP', ({ request }) => request.headers.get('x-forwarded-for') || request.ip)
	.decorate('requestTime', () => Date.now())
	.decorate('session', ({ cookie }) => cookie.session.value)
	.get('/', ({ requestIP, requestTime, session }) => {
		return { requestIP, requestTime, session }
	})
```

## æ¨¡å‹

æ¨¡å‹æˆ– [DTOï¼ˆæ•°æ®ä¼ è¾“å¯¹è±¡ï¼‰](https://en.wikipedia.org/wiki/Data_transfer_object) ç”± [Elysia.t (éªŒè¯)](/essential/validation.html#elysia-type) å¤„ç†ã€‚

Elysia å†…ç½®éªŒè¯ç³»ç»Ÿï¼Œå¯è‡ªåŠ¨æ¨æ–­ç±»å‹å¹¶åœ¨è¿è¡Œæ—¶éªŒè¯ã€‚

### âœ… æ¨èä½¿ç”¨ Elysia éªŒè¯ç³»ç»Ÿ

Elysia çš„ä¼˜åŠ¿åœ¨äºä¼˜å…ˆä¿è¯ç±»å‹å’Œè¿è¡Œæ—¶éªŒè¯çš„å•ä¸€å¯ä¿¡æ¥æºã€‚

ä¸è¦å£°æ˜æ¥å£ï¼Œå¤ç”¨éªŒè¯æ¨¡å‹ï¼š

```typescript twoslash
// âœ… æ¨è
import { Elysia, t } from 'elysia'

const customBody = t.Object({
	username: t.String(),
	password: t.String()
})

// å¯é€‰ï¼šå¦‚æœæƒ³è·å–æ¨¡å‹çš„ç±»å‹
// é€šå¸¸ä¸éœ€è¦ä¸“é—¨å£°æ˜ç±»å‹ï¼ŒElysia ä¼šæ¨æ–­
type CustomBody = typeof customBody.static
    // ^?

export { customBody }
```

ç”¨ `typeof` å’Œ `.static` å±æ€§è·å–æ¨¡å‹ç±»å‹ã€‚

ç„¶åç”¨ `CustomBody` æ¨æ–­è¯·æ±‚ä½“ç±»å‹ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

const customBody = t.Object({
	username: t.String(),
	password: t.String()
})
// ---æˆªæ–­---
// âœ… æ¨èåšæ³•
new Elysia()
	.post('/login', ({ body }) => {
	                 // ^?
		return body
	}, {
		body: customBody
	})
```

### âŒ ä¸è¦å£°æ˜ç±»å®ä¾‹ä½œä¸ºæ¨¡å‹

ä¸è¦ç”¨ç±»å®ä¾‹å£°æ˜æ¨¡å‹ï¼š

```typescript
// âŒ ä¸æ¨è
class CustomBody {
	username: string
	password: string

	constructor(username: string, password: string) {
		this.username = username
		this.password = password
	}
}

// âŒ ä¸æ¨è
interface ICustomBody {
	username: string
	password: string
}
```

### âŒ ä¸è¦å°†ç±»å‹å’Œæ¨¡å‹åˆ†å¼€å£°æ˜

ä¸è¦åˆ†å¼€å£°æ˜ç±»å‹ï¼Œåº”ä½¿ç”¨ `typeof` å’Œ `.static` ç›´æ¥è·å–æ¨¡å‹ç±»å‹ã€‚

```typescript
// âŒ ä¸æ¨è
import { Elysia, t } from 'elysia'

const customBody = t.Object({
	username: t.String(),
	password: t.String()
})

type CustomBody = {
	username: string
	password: string
}

// âœ… æ¨è
const customBody = t.Object({
	username: t.String(),
	password: t.String()
})

type CustomBody = typeof customBody.static
```

### åˆ†ç»„

ä½ å¯ä»¥å°†å¤šä¸ªæ¨¡å‹èšåˆåˆ°å•ä¸ªå¯¹è±¡ä¸­ï¼Œæ›´åŠ ç»„ç»‡åŒ–ã€‚

```typescript
import { Elysia, t } from 'elysia'

export const AuthModel = {
	sign: t.Object({
		username: t.String(),
		password: t.String()
	})
}

const models = AuthModel.models
```

### æ¨¡å‹æ³¨å…¥

è™½ç„¶å¯é€‰ï¼Œä½†è‹¥ä¸¥æ ¼éµå¾ª MVC æ¨¡å¼ï¼Œä½ å¯èƒ½å¸Œæœ›åƒæ³¨å…¥æœåŠ¡ä¸€æ ·æ³¨å…¥æ¨¡å‹ã€‚æˆ‘ä»¬æ¨èä½¿ç”¨ [Elysia å¼•ç”¨æ¨¡å‹](/essential/validation#reference-model)ã€‚

ä½¿ç”¨ Elysia çš„æ¨¡å‹å¼•ç”¨ç¤ºä¾‹ï¼š

```typescript twoslash
import { Elysia, t } from 'elysia'

const customBody = t.Object({
	username: t.String(),
	password: t.String()
})

const AuthModel = new Elysia()
    .model({
        sign: customBody
    })

const models = AuthModel.models

const UserController = new Elysia({ prefix: '/auth' })
    .use(AuthModel)
    .prefix('model', 'auth.')
    .post('/sign-in', async ({ body, cookie: { session } }) => {
                             // ^?

        return true
    }, {
        body: 'auth.Sign'
    })
```

è¯¥æ–¹å¼å¸¦æ¥å¤šä¸ªå¥½å¤„ï¼š

1. å…è®¸æ¨¡å‹å‘½åå¹¶æ”¯æŒè‡ªåŠ¨è¡¥å…¨ã€‚
2. ä¾¿äºåç»­ä¿®æ”¹ Schema æˆ–æ‰§è¡Œ [é‡æ˜ å°„](/essential/handler.html#remap)ã€‚
3. åœ¨ OpenAPI åˆè§„å®¢æˆ·ç«¯ï¼ˆå¦‚ OpenAPIï¼‰ä¸­æ˜¾ç¤ºä¸ºâ€œmodelsâ€ã€‚
4. æé«˜ TypeScript ç±»å‹æ¨æ–­é€Ÿåº¦ï¼Œå› ä¸ºæ¨¡å‹ç±»å‹æ³¨å†Œæ—¶ä¼šè¢«ç¼“å­˜ã€‚

---

---
url: 'https://elysiajs.com/tutorial/features/unit-test.md'
---

# å•å…ƒæµ‹è¯•

Elysia æä¾›äº†ä¸€ä¸ª **Elysia.fetch** å‡½æ•°ï¼Œå¯ä»¥è½»æ¾æµ‹è¯•æ‚¨çš„åº”ç”¨ç¨‹åºã€‚

**Elysia.fetch** æ¥å—ä¸€ä¸ª Web æ ‡å‡†è¯·æ±‚ï¼Œå¹¶è¿”å›ä¸€ä¸ªç±»ä¼¼äºæµè§ˆå™¨çš„ fetch APIçš„å“åº”ã€‚

```typescript
import { Elysia } from 'elysia'

const app = new Elysia()
	.get('/', 'Hello World')

app.fetch(new Request('http://localhost/'))
	.then((res) => res.text())
	.then(console.log)
```

è¿™å°†åƒä¸€ä¸ª **å®é™…è¯·æ±‚** ä¸€æ ·è¿è¡Œè¯·æ±‚ï¼ˆä¸æ˜¯æ¨¡æ‹Ÿçš„ï¼‰ã€‚

### æµ‹è¯•

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸è¿è¡ŒæœåŠ¡å™¨çš„æƒ…å†µä¸‹è½»æ¾æµ‹è¯•æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚

::: code-group

```typescript [Bun Test]
import { describe, it, expect } from 'bun:test'

import { Elysia } from 'elysia'

describe('Elysia', () => {
	it('åº”è¯¥è¿”å› Hello World', async () => {
		const app = new Elysia().get('/', 'Hello World')

		const text = await app.fetch(new Request('http://localhost/'))
			.then(res => res.text())

		expect(text).toBe('Hello World')
	})
})
```

```typescript [Vitest]
import { describe, it, expect } from 'vitest'

import { Elysia } from 'elysia'

describe('Elysia', () => {
	it('åº”è¯¥è¿”å› Hello World', async () => {
		const app = new Elysia().get('/', 'Hello World')

		const text = await app.fetch(new Request('http://localhost/'))
			.then(res => res.text())

		expect(text).toBe('Hello World')
	})
})
```

```typescript [Jest]
import { describe, it, test } from '@jest/globals'

import { Elysia } from 'elysia'

describe('Elysia', () => {
	test('åº”è¯¥è¿”å› Hello World', async () => {
		const app = new Elysia().get('/', 'Hello World')

		const text = await app.fetch(new Request('http://localhost/'))
			.then(res => res.text())

		expect(text).toBe('Hello World')
	})
})
```

:::

è¯·å‚è§ å•å…ƒæµ‹è¯•ã€‚

## ä»»åŠ¡

è®©æˆ‘ä»¬ç‚¹å‡»é¢„è§ˆä¸­çš„  å›¾æ ‡ï¼Œçœ‹çœ‹è¯·æ±‚æ˜¯å¦‚ä½•è¢«è®°å½•çš„ã€‚

---

---
url: 'https://elysiajs.com/patterns/cookie.md'
---

# Cookie&#x20;

Elysia æä¾›äº†ä¸€ä¸ªå¯å˜ä¿¡å·ï¼Œç”¨äºä¸ Cookie è¿›è¡Œäº¤äº’ã€‚

æ²¡æœ‰ get/setï¼Œæ‚¨å¯ä»¥ç›´æ¥æå– Cookie åç§°å¹¶æ£€ç´¢æˆ–æ›´æ–°å…¶å€¼ã€‚

```ts
import { Elysia } from 'elysia'

new Elysia()
    .get('/', ({ cookie: { name } }) => {
        // è·å–
        name.value

        // è®¾ç½®
        name.value = "æ–°å€¼"
    })
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œå“åº”å¼ Cookie å¯ä»¥è‡ªåŠ¨ç¼–ç /è§£ç å¯¹è±¡ç±»å‹ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå°† Cookie è§†ä¸ºå¯¹è±¡ï¼Œè€Œæ— éœ€æ‹…å¿ƒç¼–ç /è§£ç ã€‚**å®ƒå°±æ˜¯è¿™æ ·å·¥ä½œçš„**ã€‚

## å“åº”æ€§

Elysia çš„ Cookie æ˜¯å“åº”å¼çš„ã€‚è¿™æ„å‘³ç€å½“æ‚¨æ›´æ”¹ Cookie å€¼æ—¶ï¼ŒCookie ä¼šæ ¹æ®ç±»ä¼¼ä¿¡å·çš„æ–¹å¼è‡ªåŠ¨æ›´æ–°ã€‚

Elysia Cookies æä¾›äº†å¤„ç† Cookies çš„å•ä¸€çœŸå®æ¥æºï¼Œèƒ½å¤Ÿè‡ªåŠ¨è®¾ç½®å¤´éƒ¨å¹¶åŒæ­¥ Cookie å€¼ã€‚

ç”±äº Cookies é»˜è®¤æ˜¯åŸºäº Proxy çš„å¯¹è±¡ï¼Œæå–çš„å€¼æ°¸è¿œä¸ä¼šæ˜¯ **undefined**ï¼›ç›¸åï¼Œå®ƒå°†å§‹ç»ˆæ˜¯ä¸€ä¸ª `Cookie<unknown>` çš„å€¼ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ **.value** å±æ€§è·å–ã€‚

æˆ‘ä»¬å¯ä»¥å°† Cookie ç½è§†ä¸ºå¸¸è§„å¯¹è±¡ï¼Œå¯¹å…¶è¿›è¡Œè¿­ä»£åªä¼šè¿­ä»£å·²ç»å­˜åœ¨çš„ Cookie å€¼ã€‚

## Cookie å±æ€§

è¦ä½¿ç”¨ Cookie å±æ€§ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»ä¸€æ–¹æ³•ï¼š

1. ç›´æ¥è®¾ç½®å±æ€§
2. ä½¿ç”¨ `set` æˆ– `add` æ¥æ›´æ–° Cookie å±æ€§ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [Cookie å±æ€§é…ç½®](/patterns/cookie.html#config)ã€‚

### åˆ†é…å±æ€§

æ‚¨å¯ä»¥åƒå¯¹å¾…ä»»ä½•æ™®é€šå¯¹è±¡ä¸€æ ·è·å–/è®¾ç½® Cookie çš„å±æ€§ï¼Œå“åº”æ€§æ¨¡å‹ä¼šè‡ªåŠ¨åŒæ­¥ Cookie å€¼ã€‚

```ts
import { Elysia } from 'elysia'

new Elysia()
    .get('/', ({ cookie: { name } }) => {
        // è·å–
        name.domain

        // è®¾ç½®
        name.domain = 'millennium.sh'
        name.httpOnly = true
    })
```

## set

**set** å…è®¸ä¸€æ¬¡æ›´æ–°å¤šä¸ª Cookie å±æ€§ï¼Œé€šè¿‡ **é‡ç½®æ‰€æœ‰å±æ€§** å¹¶ç”¨æ–°å€¼è¦†ç›–è¯¥å±æ€§ã€‚

```ts
import { Elysia } from 'elysia'

new Elysia()
    .get('/', ({ cookie: { name } }) => {
        name.set({
            domain: 'millennium.sh',
            httpOnly: true
        })
    })
```

## add

ä¸ **set** ç›¸ä¼¼ï¼Œ**add** å…è®¸æˆ‘ä»¬ä¸€æ¬¡æ›´æ–°å¤šä¸ª Cookie å±æ€§ï¼Œä½†åªä¼šè¦†ç›–å·²å®šä¹‰çš„å±æ€§ï¼Œè€Œä¸æ˜¯é‡ç½®ã€‚

## remove

è¦ç§»é™¤ Cookieï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»»ä¸€æ–¹æ³•ï¼š

1. name.remove
2. delete cookie.name

```ts
import { Elysia } from 'elysia'

new Elysia()
    .get('/', ({ cookie, cookie: { name } }) => {
        name.remove()

        delete cookie.name
    })
```

## Cookie æ¨¡å¼

æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ `t.Cookie` çš„ Cookie æ¨¡å¼ä¸¥æ ¼éªŒè¯ Cookie ç±»å‹ï¼Œå¹¶æä¾› Cookie çš„ç±»å‹æ¨æ–­ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia()
    .get('/', ({ cookie: { name } }) => {
        // è®¾ç½®
        name.value = {
            id: 617,
            name: 'å¬å”¤ 101'
        }
    }, {
        cookie: t.Cookie({
            name: t.Object({
                id: t.Numeric(),
                name: t.String()
            })
        })
    })
```

## å¯ç©º Cookie

è¦å¤„ç†å¯ç©º Cookie å€¼ï¼Œæ‚¨å¯ä»¥åœ¨æ‚¨å¸Œæœ›å¯ç©ºçš„ Cookie åç§°ä¸Šä½¿ç”¨ `t.Optional`ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia()
    .get('/', ({ cookie: { name } }) => {
        // è®¾ç½®
        name.value = {
            id: 617,
            name: 'å¬å”¤ 101'
        }
    }, {
        cookie: t.Cookie({
            name: t.Optional(
                t.Object({
                    id: t.Numeric(),
                    name: t.String()
                })
            )
        })
    })
```

## Cookie ç­¾å

é€šè¿‡å¼•å…¥ Cookie Schemaï¼Œå’Œ `t.Cookie` ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„ç±»å‹æ¥å¤„ç†ç­¾å/éªŒè¯ Cookie ç­¾åã€‚

Cookie ç­¾åæ˜¯é™„åŠ åˆ° Cookie å€¼çš„åŠ å¯†å“ˆå¸Œï¼Œæ˜¯ä½¿ç”¨ç§˜å¯†å¯†é’¥å’Œ Cookie çš„å†…å®¹ç”Ÿæˆçš„ï¼Œä»¥é€šè¿‡å‘ Cookie æ·»åŠ ç­¾åæ¥å¢å¼ºå®‰å…¨æ€§ã€‚

è¿™ç¡®ä¿äº† Cookie å€¼æœªè¢«æ¶æ„è¡Œä¸ºè€…ä¿®æ”¹ï¼Œæœ‰åŠ©äºéªŒè¯ Cookie æ•°æ®çš„çœŸå®æ€§å’Œå®Œæ•´æ€§ã€‚

## ä½¿ç”¨ Cookie ç­¾å

é€šè¿‡æä¾› Cookie å¯†é’¥ï¼Œä»¥åŠ `sign` å±æ€§æ¥æŒ‡ç¤ºå“ªäº› Cookie åº”å…·æœ‰ç­¾åéªŒè¯ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia()
    .get('/', ({ cookie: { profile } }) => {
        profile.value = {
            id: 617,
            name: 'å¬å”¤ 101'
        }
    }, {
        cookie: t.Cookie({
            profile: t.Object({
                id: t.Numeric(),
                name: t.String()
            })
        }, {
            secrets: 'Fischl von Luftschloss Narfidort',
            sign: ['profile']
        })
    })
```

Elysia ç„¶åä¼šè‡ªåŠ¨ç­¾åå’ŒéªŒè¯ Cookie å€¼ã€‚

## æ„é€ å‡½æ•°

æ‚¨å¯ä»¥ä½¿ç”¨ Elysia æ„é€ å‡½æ•°è®¾ç½®å…¨å±€ Cookie `secret` å’Œ `sign` å€¼ï¼Œä»¥é€‚ç”¨äºæ‰€æœ‰è·¯ç”±ï¼Œè€Œä¸æ˜¯åœ¨æ¯ä¸ªéœ€è¦çš„è·¯ç”±ä¸­å†…è”ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia({
    cookie: {
        secrets: 'Fischl von Luftschloss Narfidort',
        sign: ['profile']
    }
})
    .get('/', ({ cookie: { profile } }) => {
        profile.value = {
            id: 617,
            name: 'å¬å”¤ 101'
        }
    }, {
        cookie: t.Cookie({
            profile: t.Object({
                id: t.Numeric(),
                name: t.String()
            })
        })
    })
```

## Cookie è½®æ¢

Elysia ä¼šè‡ªåŠ¨å¤„ç† Cookie çš„å¯†é’¥è½®æ¢ã€‚

Cookie è½®æ¢æ˜¯ä¸€ç§è¿ç§»æŠ€æœ¯ï¼Œç”¨äºä½¿ç”¨è¾ƒæ–°çš„å¯†é’¥å¯¹ Cookie è¿›è¡Œç­¾åï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤ŸéªŒè¯æ—§çš„ Cookie ç­¾åã€‚

```ts
import { Elysia } from 'elysia'

new Elysia({
    cookie: {
        secrets: ['å¤ä»‡å°†å±äºæˆ‘', 'Fischl von Luftschloss Narfidort']
    }
})
```

## é…ç½®

ä»¥ä¸‹æ˜¯ Elysia æ¥å—çš„ Cookie é…ç½®ã€‚

### secret

ç”¨äºç­¾å/å–æ¶ˆç­¾å Cookie çš„å¯†é’¥ã€‚

å¦‚æœä¼ é€’äº†ä¸€ä¸ªæ•°ç»„ï¼Œåˆ™å°†ä½¿ç”¨å¯†é’¥è½®æ¢ã€‚

å¯†é’¥è½®æ¢æ˜¯æŒ‡å°†åŠ å¯†å¯†é’¥é€€å½¹å¹¶é€šè¿‡ç”Ÿæˆæ–°çš„åŠ å¯†å¯†é’¥è¿›è¡Œæ›¿æ¢ã€‚

***

ä»¥ä¸‹æ˜¯ä» [cookie](https://npmjs.com/package/cookie) æ‰©å±•çš„é…ç½®ã€‚

### domain

æŒ‡å®š [Domain Set-Cookie å±æ€§](https://tools.ietf.org/html/rfc6265#section-5.2.3) çš„å€¼ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰è®¾ç½®åŸŸï¼Œå¤§å¤šæ•°å®¢æˆ·ç«¯å°†åªè€ƒè™‘å½“å‰åŸŸçš„ Cookieã€‚

### encode

@default `encodeURIComponent`

æŒ‡å®šå°†ç”¨äºç¼–ç  Cookie å€¼çš„å‡½æ•°ã€‚

ç”±äº Cookie çš„å€¼å…·æœ‰æœ‰é™çš„å­—ç¬¦é›†ï¼ˆå¹¶ä¸”å¿…é¡»æ˜¯ç®€å•å­—ç¬¦ä¸²ï¼‰ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨æ­¤å‡½æ•°å°†å€¼ç¼–ç ä¸ºé€‚åˆ Cookie å€¼çš„å­—ç¬¦ä¸²ã€‚

é»˜è®¤å‡½æ•°æ˜¯å…¨å±€çš„ `encodeURIComponent`ï¼Œå®ƒä¼šå°† JavaScript å­—ç¬¦ä¸²ç¼–ç ä¸º UTF-8 å­—èŠ‚åºåˆ—ï¼Œç„¶åå¯¹è½åœ¨ Cookie èŒƒå›´å¤–çš„è¿›è¡Œ URL ç¼–ç ã€‚

### expires

æŒ‡å®šä½œä¸º [Expires Set-Cookie å±æ€§](https://tools.ietf.org/html/rfc6265#section-5.2.1) å€¼çš„æ—¥æœŸå¯¹è±¡ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¤§å¤šæ•°å®¢æˆ·ç«¯å°†è§†å…¶ä¸ºâ€œéæŒä¹…æ€§ Cookieâ€ï¼Œå¹¶å°†åœ¨é€€å‡º Web æµè§ˆå™¨åº”ç”¨ç¨‹åºç­‰æ¡ä»¶ä¸‹åˆ é™¤å®ƒã€‚

::: tip
[Cookie å­˜å‚¨æ¨¡å‹è§„èŒƒ](https://tools.ietf.org/html/rfc6265#section-5.3) è§„å®šï¼Œå¦‚æœåŒæ—¶è®¾ç½®äº† `expires` å’Œ `maxAge`ï¼Œåˆ™ `maxAge` ä¼˜å…ˆï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å¯èƒ½éµå®ˆï¼Œå› æ­¤å¦‚æœåŒæ—¶è®¾ç½®äº†å®ƒä»¬ï¼Œåˆ™åº”æŒ‡å‘åŒä¸€æ—¥æœŸå’Œæ—¶é—´ã€‚
:::

### httpOnly

@default `false`

æŒ‡å®šå¸ƒå°”å€¼ä½œä¸º [HttpOnly Set-Cookie å±æ€§](https://tools.ietf.org/html/rfc6265#section-5.2.6) çš„å€¼ã€‚

å½“ä¸ºçœŸæ—¶ï¼Œä¼šè®¾ç½® HttpOnly å±æ€§ï¼Œå¦åˆ™ä¸ä¼šè®¾ç½®ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸è®¾ç½® HttpOnly å±æ€§ã€‚

::: tip
è®¾ç½®ä¸º true æ—¶è¦å°å¿ƒï¼Œå› ä¸ºç¬¦åˆè§„èŒƒçš„å®¢æˆ·ç«¯å°†ä¸å…è®¸å®¢æˆ·ç«¯ JavaScript åœ¨ `document.cookie` ä¸­æŸ¥çœ‹è¯¥ Cookieã€‚
:::

### maxAge

@default `undefined`

æŒ‡å®šä½œä¸º [Max-Age Set-Cookie å±æ€§](https://tools.ietf.org/html/rfc6265#section-5.2.2) çš„å€¼çš„æ•°å­—ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚

ç»™å®šçš„æ•°å­—å°†é€šè¿‡å‘ä¸‹å–æ•´è¿›è¡Œè½¬æ¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸è®¾ç½®æœ€å¤§å¹´é¾„ã€‚

::: tip
[Cookie å­˜å‚¨æ¨¡å‹è§„èŒƒ](https://tools.ietf.org/html/rfc6265#section-5.3) è§„å®šï¼Œå¦‚æœåŒæ—¶è®¾ç½®äº† `expires` å’Œ `maxAge`ï¼Œåˆ™ `maxAge` ä¼˜å…ˆï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å¯èƒ½éµå®ˆï¼Œå› æ­¤å¦‚æœåŒæ—¶è®¾ç½®äº†å®ƒä»¬ï¼Œåˆ™åº”æŒ‡å‘åŒä¸€æ—¥æœŸå’Œæ—¶é—´ã€‚
:::

### path

æŒ‡å®šä½œä¸º [Path Set-Cookie å±æ€§](https://tools.ietf.org/html/rfc6265#section-5.2.4) çš„å€¼ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œè·¯å¾„å¤„ç†å™¨è¢«è§†ä¸ºé»˜è®¤è·¯å¾„ã€‚

### priority

æŒ‡å®šå­—ç¬¦ä¸²ä½œä¸º [Priority Set-Cookie å±æ€§](https://tools.ietf.org/html/draft-west-cookie-priority-00#section-4.1) çš„å€¼ã€‚
`low` å°†æŠŠä¼˜å…ˆçº§å±æ€§è®¾ç½®ä¸ºä½ã€‚
`medium` å°†æŠŠä¼˜å…ˆçº§å±æ€§è®¾ç½®ä¸ºä¸­ï¼Œæœªè®¾ç½®æ—¶çš„é»˜è®¤ä¼˜å…ˆçº§ã€‚
`high` å°†æŠŠä¼˜å…ˆçº§å±æ€§è®¾ç½®ä¸ºé«˜ã€‚

æœ‰å…³ä¸åŒä¼˜å…ˆçº§çº§åˆ«çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [è§„èŒƒ](https://tools.ietf.org/html/draft-west-cookie-priority-00#section-4.1)ã€‚

::: tip
è¿™æ˜¯ä¸€ä¸ªå°šæœªå®Œå…¨æ ‡å‡†åŒ–çš„å±æ€§ï¼Œæœªæ¥å¯èƒ½ä¼šæœ‰æ‰€æ›´æ”¹ã€‚è¿™ä¹Ÿæ„å‘³ç€è®¸å¤šå®¢æˆ·ç«¯å¯èƒ½ä¼šåœ¨ç†è§£ä¹‹å‰å¿½ç•¥æ­¤å±æ€§ã€‚
:::

### sameSite

æŒ‡å®šå¸ƒå°”å€¼æˆ–å­—ç¬¦ä¸²ä½œä¸º [SameSite Set-Cookie å±æ€§](https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-09#section-5.4.7) çš„å€¼ã€‚
`true` å°† SameSite å±æ€§è®¾ç½®ä¸ºä¸¥æ ¼çš„åŒç«™å¼ºåˆ¶ã€‚
`false` ä¸ä¼šè®¾ç½® SameSite å±æ€§ã€‚
`'lax'` å°† SameSite å±æ€§è®¾ç½®ä¸ºå®½æ¾åŒç«™å¼ºåˆ¶ã€‚
`'none'` å°† SameSite å±æ€§è®¾ç½®ä¸ºæ— ä»¥ç¤ºæ˜ç¡®çš„è·¨ç«™ Cookieã€‚
`'strict'` å°† SameSite å±æ€§è®¾ç½®ä¸ºä¸¥æ ¼çš„åŒç«™å¼ºåˆ¶ã€‚
æœ‰å…³ä¸åŒå¼ºåˆ¶çº§åˆ«çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [è§„èŒƒ](https://tools.ietf.org/html/draft-ietf-httpbis-rfc6265bis-09#section-5.4.7)ã€‚

::: tip
è¿™æ˜¯ä¸€ä¸ªå°šæœªå®Œå…¨æ ‡å‡†åŒ–çš„å±æ€§ï¼Œæœªæ¥å¯èƒ½ä¼šæœ‰æ‰€æ›´æ”¹ã€‚è¿™ä¹Ÿæ„å‘³ç€è®¸å¤šå®¢æˆ·ç«¯å¯èƒ½ä¼šåœ¨ç†è§£ä¹‹å‰å¿½ç•¥æ­¤å±æ€§ã€‚
:::

### secure

æŒ‡å®šå¸ƒå°”å€¼ä½œä¸º [Secure Set-Cookie å±æ€§](https://tools.ietf.org/html/rfc6265#section-5.2.5) çš„å€¼ã€‚å½“ä¸ºçœŸæ—¶ï¼Œè®¾ç½® Secure å±æ€§ï¼Œå¦åˆ™ä¸è®¾ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸è®¾ç½® Secure å±æ€§ã€‚

::: tip
è®¾ç½®ä¸º true æ—¶è¦å°å¿ƒï¼Œå› ä¸ºç¬¦åˆè§„èŒƒçš„å®¢æˆ·ç«¯å°†åœ¨æœªæ¥å¦‚æœæµè§ˆå™¨æ²¡æœ‰ HTTPS è¿æ¥æ—¶ï¼Œä¸ä¼šå°†è¯¥ Cookie å‘é€å›æœåŠ¡å™¨ã€‚
:::

---

---
url: 'https://elysiajs.com/integrations/vercel.md'
---

# åœ¨ Vercel ä¸Šéƒ¨ç½² Elysia

Elysia å¯ä»¥ä½¿ç”¨ Bun æˆ– Node è¿è¡Œæ—¶åœ¨ Vercel ä¸Šé›¶é…ç½®éƒ¨ç½²ã€‚

1. åœ¨ **src/index.ts** ä¸­ï¼Œåˆ›å»ºæˆ–å¯¼å…¥ç°æœ‰çš„ Elysia æœåŠ¡å™¨
2. å°† Elysia æœåŠ¡å™¨ä½œä¸ºé»˜è®¤å¯¼å‡º

```typescript
import { Elysia, t } from 'elysia'

export default new Elysia() // [!code ++]
    .get('/', () => 'Hello Vercel Function')
    .post('/', ({ body }) => body, {
        body: t.Object({
            name: t.String()
        })
    })
```

3. ä½¿ç”¨ Vercel CLI åœ¨æœ¬åœ°å¼€å‘

```bash
vc dev
```

4. éƒ¨ç½²åˆ° Vercel

```bash
vc deploy
```

å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚æ‚¨çš„ Elysia åº”ç”¨ç°åœ¨å·²è¿è¡Œåœ¨ Vercel ä¸Šã€‚

### pnpm

å¦‚æœæ‚¨ä½¿ç”¨ pnpmï¼Œ[pnpm é»˜è®¤ä¸è‡ªåŠ¨å®‰è£… peer dependencies](https://github.com/orgs/pnpm/discussions/3995#discussioncomment-1893230)ï¼Œå› æ­¤éœ€è¦æ‚¨æ‰‹åŠ¨å®‰è£…é¢å¤–çš„ä¾èµ–ã€‚

```bash
pnpm add @sinclair/typebox openapi-types
```

### ä½¿ç”¨ Node.js

ä½¿ç”¨ Node.js éƒ¨ç½²æ—¶ï¼Œè¯·ç¡®ä¿åœ¨æ‚¨çš„ `package.json` ä¸­è®¾ç½® `type: module`

::: code-group

```ts [package.json]
{
  "name": "elysia-app",
  "type": "module" // [!code ++]
}
```

:::

### ä½¿ç”¨ Bun

ä½¿ç”¨ Bun éƒ¨ç½²æ—¶ï¼Œè¯·ç¡®ä¿åœ¨ `vercel.json` ä¸­å°†è¿è¡Œæ—¶è®¾ç½®ä¸º Bun

::: code-group

```ts [vercel.json]
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "bunVersion": "1.x" // [!code ++]
}
```

## å¦‚æœæ­¤æ–¹æ³•ä¸èµ·ä½œç”¨

Vercel å¯¹ Elysia æä¾›é›¶é…ç½®æ”¯æŒï¼Œè‹¥éœ€é¢å¤–é…ç½®ï¼Œè¯·å‚è€ƒ [Vercel æ–‡æ¡£](https://vercel.com/docs/frameworks/backend/elysia)

æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ [Vercel Function æ–‡æ¡£](https://vercel.com/docs/functions?framework=other)ã€‚

---

---
url: 'https://elysiajs.com/tutorial/getting-started/handler-and-context.md'
---

# å¤„ç†å™¨ä¸ä¸Šä¸‹æ–‡

**å¤„ç†å™¨** - ä¸€ä¸ªèµ„æºæˆ–è·¯ç”±å‡½æ•°ï¼Œç”¨äºå‘å®¢æˆ·ç«¯å‘é€æ•°æ®ã€‚

```ts
import { Elysia } from 'elysia'

new Elysia()
    // `() => 'hello world'` æ˜¯ä¸€ä¸ªå¤„ç†å™¨
    .get('/', () => 'hello world')
    .listen(3000)
```

å¤„ç†å™¨ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå­—é¢å€¼ï¼Œè§ å¤„ç†å™¨

```ts
import { Elysia } from 'elysia'

new Elysia()
    // `'hello world'` æ˜¯ä¸€ä¸ªå¤„ç†å™¨
    .get('/', 'hello world')
    .listen(3000)
```

ä½¿ç”¨å†…è”å€¼å¯¹äºé™æ€èµ„æºå¦‚ **æ–‡ä»¶** æ˜¯æœ‰ç”¨çš„ã€‚

## ä¸Šä¸‹æ–‡

åŒ…å«æœ‰å…³æ¯ä¸ªè¯·æ±‚çš„ä¿¡æ¯ã€‚å®ƒä½œä¸ºå¤„ç†å™¨çš„å”¯ä¸€å‚æ•°ä¼ é€’ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
	.get('/', (context) => context.path)
            // ^ è¿™æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡
```

**ä¸Šä¸‹æ–‡** å­˜å‚¨å…³äºè¯·æ±‚çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š

* body - å®¢æˆ·ç«¯å‘é€åˆ°æœåŠ¡å™¨çš„æ•°æ®ï¼Œå¦‚è¡¨å•æ•°æ®ã€JSON è´Ÿè½½ã€‚
* query - ä½œä¸ºå¯¹è±¡çš„æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚(æŸ¥è¯¢æ˜¯ä»è·¯å¾„åä»¥ '?' é—®å·å¼€å§‹çš„å€¼ä¸­æå–çš„)
* params - è§£æä¸ºå¯¹è±¡çš„è·¯å¾„å‚æ•°
* headers - HTTP å¤´ï¼Œå…³äºè¯·æ±‚çš„é™„åŠ ä¿¡æ¯ï¼Œå¦‚ "Content-Type"ã€‚

è¯·å‚è§ ä¸Šä¸‹æ–‡ã€‚

## é¢„è§ˆ

æ‚¨å¯ä»¥é€šè¿‡æŸ¥çœ‹ **ç¼–è¾‘å™¨** éƒ¨åˆ†æ¥é¢„è§ˆç»“æœã€‚

åœ¨é¢„è§ˆçª—å£çš„ **å·¦ä¸Šè§’** åº”è¯¥æœ‰ä¸€ä¸ªå°å¯¼èˆªå™¨ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨å®ƒåœ¨è·¯å¾„å’Œæ–¹æ³•ä¹‹é—´åˆ‡æ¢ä»¥æŸ¥çœ‹å“åº”ã€‚

æ‚¨è¿˜å¯ä»¥ç‚¹å‡»  æ¥ç¼–è¾‘è¯·æ±‚ä½“å’Œå¤´éƒ¨ã€‚

## ç»ƒä¹ 

è®©æˆ‘ä»¬å°è¯•æå–ä¸Šä¸‹æ–‡å‚æ•°ï¼š

\<template #answer>

1. æˆ‘ä»¬å¯ä»¥ä»å›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå€¼ä¸­æå– `body`ã€`query` å’Œ `headers`ã€‚
2. ç„¶åæˆ‘ä»¬å¯ä»¥åƒ `{ body, query, headers }` è¿™æ ·è¿”å›å®ƒä»¬ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.post('/', ({ body, query, headers }) => {
		return {
			query,
			body,
			headers
		}
	})
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/essential/handler.md'
---

# å¤„ç†ç¨‹åº&#x20;

**Handler** - æ¥å— HTTP è¯·æ±‚å¹¶è¿”å›å“åº”çš„å‡½æ•°ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    // å‡½æ•° `() => 'hello world'` æ˜¯ä¸€ä¸ªå¤„ç†ç¨‹åº
    .get('/', () => 'hello world')
    .listen(3000)
```

å¤„ç†ç¨‹åºå¯ä»¥æ˜¯æ–‡å­—å€¼ï¼Œä¹Ÿå¯ä»¥æ˜¯å†…è”å€¼ã€‚

```typescript
import { Elysia, file } from 'elysia'

new Elysia()
    .get('/', 'Hello Elysia')
    .get('/video', file('kyuukurarin.mp4'))
    .listen(3000)
```

ä½¿ç”¨**å†…è”å€¼**å§‹ç»ˆè¿”å›ç›¸åŒçš„å€¼ï¼Œè¿™æœ‰åŠ©äºä¼˜åŒ–é™æ€èµ„æºï¼ˆå¦‚æ–‡ä»¶ï¼‰çš„æ€§èƒ½ã€‚

è¿™ä½¿å¾— Elysia å¯ä»¥æå‰ç¼–è¯‘å“åº”ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚

::: tip
æä¾›å†…è”å€¼å¹¶ä¸æ˜¯ç¼“å­˜ã€‚

é™æ€èµ„æºå€¼ã€å¤´éƒ¨å’ŒçŠ¶æ€å¯ä»¥ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸåŠ¨æ€æ”¹å˜ã€‚
:::

## ä¸Šä¸‹æ–‡

**ä¸Šä¸‹æ–‡**åŒ…å«æ¯ä¸ªè¯·æ±‚å”¯ä¸€çš„è¯·æ±‚ä¿¡æ¯ï¼Œé™¤äº† `store` (å…¨å±€å¯å˜çŠ¶æ€)ï¼Œä¸è¢«å…±äº«ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
	.get('/', (context) => context.path)
            // ^ è¿™æ˜¯ä¸Šä¸‹æ–‡
```

**ä¸Šä¸‹æ–‡**åªèƒ½åœ¨è·¯ç”±å¤„ç†ç¨‹åºä¸­è®¿é—®ã€‚å®ƒåŒ…æ‹¬ï¼š

#### å±æ€§

* [**body**](/essential/validation.html#body) - [HTTP æ¶ˆæ¯](https://developer.mozilla.org/en-US/docs/Web/HTTP/Messages)ï¼Œè¡¨å•æˆ–æ–‡ä»¶ä¸Šä¼ ã€‚
* [**query**](/essential/validation.html#query) - [æŸ¥è¯¢å­—ç¬¦ä¸²](https://en.wikipedia.org/wiki/Query_string)ï¼ŒåŒ…å«é¢å¤–æœç´¢å‚æ•°çš„ JavaScript å¯¹è±¡ã€‚ï¼ˆæŸ¥è¯¢ä»è·¯å¾„ååâ€œ?â€å·å¼€å§‹æå–ï¼‰
* [**params**](/essential/validation.html#params) - Elysia çš„è·¯å¾„å‚æ•°ï¼Œè§£æä¸º JavaScript å¯¹è±¡
* [**headers**](/essential/validation.html#headers) - [HTTP å¤´éƒ¨](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers)ï¼Œè¯·æ±‚çš„é™„åŠ ä¿¡æ¯ï¼Œå¦‚ User-Agentã€Content-Typeã€ç¼“å­˜æç¤ºç­‰ã€‚
* [**cookie**](#cookie) - ä¸€ä¸ªå…¨å±€å¯å˜ä¿¡å·å­˜å‚¨ï¼Œç”¨äºäº¤äº’ Cookieï¼ˆåŒ…æ‹¬è·å–å’Œè®¾ç½®ï¼‰
* [**store**](#state) - Elysia å®ä¾‹çš„å…¨å±€å¯å˜å­˜å‚¨

#### å·¥å…·å‡½æ•°

* [**redirect**](#redirect) - é‡å®šå‘å“åº”çš„å‡½æ•°
* [**status**](#status) - è¿”å›è‡ªå®šä¹‰çŠ¶æ€ç çš„å‡½æ•°
* [**set**](#set) - åº”ç”¨äºå“åº”çš„å±æ€§ï¼š
  * [**headers**](#set.headers) - å“åº”å¤´éƒ¨

#### å…¶ä»–å±æ€§

* [**request**](#request) - [Web æ ‡å‡† Request](https://developer.mozilla.org/en-US/docs/Web/API/Request)
* [**server**](#server-bun-only) - Bun æœåŠ¡å™¨å®ä¾‹
* **path** - è¯·æ±‚çš„è·¯å¾„å

## status&#x20;

è¿”å›è‡ªå®šä¹‰çŠ¶æ€ç çš„å‡½æ•°ï¼Œå¹¶æ”¯æŒç±»å‹ç¼©å°ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/', ({ status }) => status(418, "Kirifuji Nagisa"))
    .listen(3000)
```

å»ºè®®ä½¿ç”¨**æ°¸ä¸æŠ›å‡º**ï¼ˆnever-throwï¼‰æ–¹å¼è¿”å›**status**ï¼Œè€ŒéæŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºå®ƒï¼š

* å…è®¸ TypeScript æ£€æŸ¥è¿”å›å€¼æ˜¯å¦ç¬¦åˆå“åº”æ¨¡å¼çš„ç±»å‹
* åŸºäºçŠ¶æ€ç æ”¯æŒè‡ªåŠ¨è¡¥å…¨çš„ç±»å‹ç¼©å°
* æ”¯æŒç«¯åˆ°ç«¯ç±»å‹å®‰å…¨çš„é”™è¯¯å¤„ç†çš„ç±»å‹ç¼©å°ï¼ˆå‚è€ƒ [Eden](/eden/overview)ï¼‰

## Set

**set** æ˜¯ä¸€ä¸ªå¯å˜å±æ€§ï¼Œä»£è¡¨é€šè¿‡ `Context.set` è®¿é—®çš„å“åº”ã€‚

```ts twoslash
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ set, status }) => {
		set.headers = { 'X-Teapot': 'true' }

		return status(418, 'æˆ‘æ˜¯èŒ¶å£¶')
	})
	.listen(3000)
```

### set.headers

å…è®¸æˆ‘ä»¬é™„åŠ æˆ–åˆ é™¤å“åº”å¤´ï¼Œä»¥å¯¹è±¡å½¢å¼è¡¨ç¤ºã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/', ({ set }) => {
        set.headers['x-powered-by'] = 'Elysia'

        return 'a mimir'
    })
    .listen(3000)
```

::: tip
Elysia ä¸ºåŒºåˆ†å¤§å°å†™æä¾›äº†å°å†™è‡ªåŠ¨è¡¥å…¨ä»¥ä¿æŒä¸€è‡´æ€§ï¼Œä¾‹å¦‚ä½¿ç”¨ `set-cookie` è€Œé `Set-Cookie`ã€‚
:::

å°†è¯·æ±‚é‡å®šå‘åˆ°å…¶ä»–èµ„æºã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/', ({ redirect }) => {
        return redirect('https://youtu.be/whpVWVWBW4U?&t=8')
    })
    .get('/custom-status', ({ redirect }) => {
        // ä½ è¿˜å¯ä»¥è®¾ç½®è‡ªå®šä¹‰çŠ¶æ€ç æ¥é‡å®šå‘
        return redirect('https://youtu.be/whpVWVWBW4U?&t=8', 302)
    })
    .listen(3000)
```

ä½¿ç”¨é‡å®šå‘æ—¶ï¼Œè¿”å›å€¼ä¸æ˜¯å¿…é¡»çš„ä¸”ä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºå“åº”æ¥è‡ªå…¶ä»–èµ„æºã€‚

è®¾ç½®é»˜è®¤çŠ¶æ€ç ï¼ˆå¦‚æœæœªæä¾›ï¼‰ã€‚

å»ºè®®åœ¨åªéœ€è¿”å›ç‰¹å®šçŠ¶æ€ç ï¼Œä½†å…è®¸ç”¨æˆ·è¿”å›è‡ªå®šä¹‰å€¼çš„æ’ä»¶ä¸­ä½¿ç”¨ï¼Œä¾‹å¦‚ HTTP 201/206 æˆ– 403/405 ç­‰ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .onBeforeHandle(({ set }) => {
        set.status = 418

        return 'Kirifuji Nagisa'
    })
    .get('/', () => 'hi')
    .listen(3000)
```

ä¸ `status` å‡½æ•°ä¸åŒï¼Œ`set.status` æ— æ³•æ¨æ–­è¿”å›å€¼ç±»å‹ï¼Œå› æ­¤æ— æ³•æ£€æŸ¥è¿”å›å€¼æ˜¯å¦ç¬¦åˆå“åº”æ¨¡å¼ã€‚

::: tip
HTTP çŠ¶æ€ç æŒ‡ç¤ºå“åº”ç±»å‹ã€‚å¦‚æœè·¯ç”±å¤„ç†ç¨‹åºæˆåŠŸæ‰§è¡Œä¸”æ— é”™è¯¯ï¼ŒElysia å°†è¿”å›çŠ¶æ€ç  200ã€‚
:::

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨çŠ¶æ€ç çš„å¸¸ç”¨åå­—æ›¿ä»£æ•°å­—æ¥è®¾ç½®çŠ¶æ€ç ã€‚

```typescript twoslash
// @errors 2322
import { Elysia } from 'elysia'

new Elysia()
    .get('/', ({ set }) => {
        set.status
          // ^?
        return 'Kirifuji Nagisa'
    })
    .listen(3000)
```

## Cookie

Elysia æä¾›ä¸€ä¸ªå¯å˜ä¿¡å·ç”¨ä»¥äº¤äº’ Cookieã€‚

æ— éœ€æ˜¾å¼çš„ get/setï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—® cookie åç§°å¹¶è¯»å–æˆ–æ›´æ–°å…¶å€¼ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
	.get('/set', ({ cookie: { name } }) => {
		// è¯»å–
        name.value

        // è®¾ç½®
        name.value = "æ–°å€¼"
	})
```

æ›´å¤šä¿¡æ¯è§ [æ¨¡ç‰ˆï¼šCookie](/essentials/cookie)ã€‚

## Redirect

å°†è¯·æ±‚é‡å®šå‘åˆ°å…¶ä»–èµ„æºã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ redirect }) => {
		return redirect('https://youtu.be/whpVWVWBW4U?&t=8')
	})
	.get('/custom-status', ({ redirect }) => {
		// ä½ ä¹Ÿå¯ä»¥è®¾ç½®è‡ªå®šä¹‰çŠ¶æ€ç æ¥é‡å®šå‘
		return redirect('https://youtu.be/whpVWVWBW4U?&t=8', 302)
	})
	.listen(3000)
```

ä½¿ç”¨é‡å®šå‘æ—¶ï¼Œè¿”å›å€¼ä¸æ˜¯å¿…é¡»ä¸”ä¼šè¢«å¿½ç•¥ï¼Œå› ä¸ºå“åº”æ¥è‡ªå…¶ä»–èµ„æºã€‚

## è¡¨å•æ•°æ®

å¯ä»¥é€šè¿‡ç›´æ¥ä»å¤„ç†ç¨‹åºè¿”å› `form` å·¥å…·æ¥è¿”å› `FormData`ã€‚

```typescript
import { Elysia, form, file } from 'elysia'

new Elysia()
	.get('/', () => form({
		name: 'Tea Party',
		images: [file('nagi.web'), file('mika.webp')]
	}))
	.listen(3000)
```

è¿™ç§æ¨¡å¼éå¸¸æœ‰ç”¨ï¼Œå³ä½¿éœ€è¦è¿”å›æ–‡ä»¶æˆ–å¤šéƒ¨åˆ†è¡¨å•æ•°æ®ã€‚

### è¿”å›å•ä¸ªæ–‡ä»¶

æˆ–è€…ï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥è¿”å›å•ä¸ªæ–‡ä»¶ï¼Œä¸ç”¨åŒ…è£¹åœ¨ `form`ã€‚

```typescript
import { Elysia, file } from 'elysia'

new Elysia()
	.get('/', file('nagi.web'))
	.listen(3000)
```

## æµ

é€šè¿‡ä½¿ç”¨å¸¦ `yield` å…³é”®å­—çš„ç”Ÿæˆå™¨å‡½æ•°è¿”å›å“åº”æµã€‚

```typescript
import { Elysia } from 'elysia'

const app = new Elysia()
	.get('/ok', function* () {
		yield 1
		yield 2
		yield 3
	})
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `yield` å…³é”®å­—å®ç°å“åº”çš„æµå¼ä¼ è¾“ã€‚

## æœåŠ¡å™¨å‘é€äº‹ä»¶ (SSE)

Elysia é€šè¿‡æä¾› `sse` å·¥å…·æ”¯æŒ [æœåŠ¡å™¨å‘é€äº‹ä»¶](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)ã€‚

```typescript twoslash
import { Elysia, sse } from 'elysia'

new Elysia()
	.get('/sse', function* () {
		yield sse('hello world')
		yield sse({
			event: 'message',
			data: {
				message: 'è¿™æ˜¯ä¸€ä¸ªæ¶ˆæ¯',
				timestamp: new Date().toISOString()
			},
		})
	})
```

å½“å€¼è¢«åŒ…è£¹åœ¨ `sse` ä¸­æ—¶ï¼ŒElysia ä¼šè‡ªåŠ¨å°†å“åº”å¤´è®¾ç½®ä¸º `text/event-stream`ï¼Œå¹¶æ ¼å¼åŒ–æ•°æ®ä¸º SSE äº‹ä»¶ã€‚

### æœåŠ¡å™¨å‘é€äº‹ä»¶ä¸­çš„å¤´éƒ¨

å¤´éƒ¨åªèƒ½åœ¨ç¬¬ä¸€ä¸ªæ•°æ®å—ï¼ˆchunkï¼‰è¢« `yield` ä¹‹å‰è®¾ç½®ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

const app = new Elysia()
	.get('/ok', function* ({ set }) {
		// è¿™ä¼šè®¾ç½®å¤´éƒ¨
		set.headers['x-name'] = 'Elysia'
		yield 1
		yield 2

		// è¿™ä¸ä¼šç”Ÿæ•ˆ
		set.headers['x-id'] = '1'
		yield 3
	})
```

ä¸€æ—¦ç¬¬ä¸€ä¸ªæ•°æ®å—è¢« `yield`ï¼ŒElysia ä¼šå°†å¤´éƒ¨å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå› æ­¤ä¹‹åæ›´æ”¹å¤´éƒ¨æ²¡æœ‰æ•ˆæœã€‚

### æ¡ä»¶æµ

å¦‚æœå“åº”è¿”å›è€Œæ²¡æœ‰ `yield`ï¼ŒElysia å°†è‡ªåŠ¨æŠŠæµè½¬æ¢ä¸ºæ™®é€šå“åº”ã€‚

```typescript
import { Elysia } from 'elysia'

const app = new Elysia()
	.get('/ok', function* () {
		if (Math.random() > 0.5) return 'ok'

		yield 1
		yield 2
		yield 3
	})
```

è¿™è®©æˆ‘ä»¬èƒ½å¤Ÿæ ¹æ®æ¡ä»¶é€‰æ‹©æµå¼ä¼ è¾“å“åº”æˆ–è¿”å›æ™®é€šå“åº”ã€‚

### è‡ªåŠ¨å–æ¶ˆ

åœ¨å“åº”æµå®Œæˆä¹‹å‰ï¼Œå¦‚æœç”¨æˆ·å–æ¶ˆè¯·æ±‚ï¼ŒElysia ä¼šè‡ªåŠ¨åœæ­¢ç”Ÿæˆå™¨å‡½æ•°ã€‚

### Eden

[Eden](/eden/overview) ä¼šå°†æµå¼å“åº”è§£é‡Šä¸º `AsyncGenerator`ï¼Œå…è®¸æˆ‘ä»¬ç”¨ `for await` å¾ªç¯æ¶ˆè´¹æµã€‚

```typescript twoslash
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia()
	.get('/ok', function* () {
		yield 1
		yield 2
		yield 3
	})

const { data, error } = await treaty(app).ok.get()
if (error) throw error

for await (const chunk of data)
	console.log(chunk)
```

## Request

Elysia åŸºäº [Web æ ‡å‡† Request](https://developer.mozilla.org/en-US/docs/Web/API/Request)ï¼Œæ”¯æŒ Nodeã€Bunã€Denoã€Cloudflare Workerã€Vercel Edge Function ç­‰å¤šç§è¿è¡Œæ—¶ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/user-agent', ({ request }) => {
		return request.headers.get('user-agent')
	})
	.listen(3000)
```

å…è®¸ä½ åœ¨å¿…è¦æ—¶è®¿é—®åº•å±‚è¯·æ±‚ä¿¡æ¯ã€‚

## Server ä»… Bun æ”¯æŒ

æœåŠ¡å™¨å®ä¾‹ä¸º Bun æœåŠ¡å™¨å®ä¾‹ï¼Œå…è®¸è®¿é—®æœåŠ¡å™¨ä¿¡æ¯ï¼Œå¦‚ç«¯å£å·æˆ–è¯·æ±‚ IPã€‚

ä»…å½“ä½¿ç”¨ `listen` è¿è¡Œ HTTP æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨å®ä¾‹æ‰å¯ç”¨ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/port', ({ server }) => {
		return server?.port
	})
	.listen(3000)
```

### è¯·æ±‚ IP ä»… Bun æ”¯æŒ

å¯ä»¥é€šè¿‡ `server.requestIP` æ–¹æ³•è·å–è¯·æ±‚ IPã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/ip', ({ server, request }) => {
		return server?.requestIP(request)
	})
	.listen(3000)
```

## æ‰©å±•ä¸Šä¸‹æ–‡ é«˜çº§æ¦‚å¿µ

Elysia é»˜è®¤æä¾›ä¸€ä¸ªæœ€å°çš„ä¸Šä¸‹æ–‡ï¼Œå…è®¸æˆ‘ä»¬ä½¿ç”¨çŠ¶æ€ã€è£…é¥°ã€æ´¾ç”Ÿå’Œè§£ææ¥æ‰©å±•ä¸Šä¸‹æ–‡ä»¥æ»¡è¶³æˆ‘ä»¬çš„ç‰¹å®šéœ€æ±‚ã€‚

æœ‰å…³å¦‚ä½•æ‰©å±•ä¸Šä¸‹æ–‡çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [æ‰©å±•ä¸Šä¸‹æ–‡](/patterns/extends-context)ã€‚

---

---
url: 'https://elysiajs.com/eden/treaty/websocket.md'
---

# WebSocket

å¤©å ‚æ¡çº¦æ”¯æŒä½¿ç”¨ `subscribe` æ–¹æ³•çš„ WebSocketã€‚

```typescript twoslash
import { Elysia, t } from "elysia";
import { treaty } from "@elysiajs/eden";

const app = new Elysia()
  .ws("/chat", {
    body: t.String(),
    response: t.String(),
    message(ws, message) {
      ws.send(message);
    },
  })
  .listen(3000);

const api = treaty<typeof app>("localhost:3000");

const chat = api.chat.subscribe();

chat.subscribe((message) => {
  console.log("æ”¶åˆ°", message);
});

chat.on("open", () => {
  chat.send("æ¥è‡ªå®¢æˆ·ç«¯çš„é—®å€™");
});
```

**.subscribe** æ¥å—ä¸ `get` å’Œ `head` ç›¸åŒçš„å‚æ•°ã€‚

## å“åº”

**Eden.subscribe** è¿”å› **EdenWS**ï¼Œå®ƒæ‰©å±•äº† [WebSocket](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/WebSocket) å¹¶ä¸”è¯­æ³•ç›¸åŒã€‚

å¦‚æœéœ€è¦æ›´å¤šæ§åˆ¶ï¼Œå¯ä»¥è®¿é—® **EdenWebSocket.raw** ä»¥ä¸åŸç”Ÿ WebSocket API è¿›è¡Œäº¤äº’ã€‚

---

---
url: 'https://elysiajs.com/tutorial/patterns/macro.md'
---

# å®

å¯é‡ç”¨çš„è·¯ç”±é€‰é¡¹ã€‚

æƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬æœ‰ä¸€ä¸ªè¿™æ ·çš„è®¤è¯æ£€æŸ¥ï¼š

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.post('/user', ({ body }) => body, {
		cookie: t.Object({
			session: t.String()
		}),
		beforeHandle({ cookie: { session } }) {
			if(!session.value) throw 'æœªæˆæƒ'
		}
	})
	.listen(3000)
```

å¦‚æœæˆ‘ä»¬æœ‰å¤šä¸ªè·¯ç”±éœ€è¦è®¤è¯ï¼Œå°±å¿…é¡»é‡å¤ç›¸åŒçš„é€‰é¡¹ã€‚

ç›¸åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®æ¥é‡ç”¨è·¯ç”±é€‰é¡¹ï¼š

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.macro('auth', {
		cookie: t.Object({
			session: t.String()
		}),
		// ä¼ªè®¤è¯æ£€æŸ¥
		beforeHandle({ cookie: { session }, status }) {
			if(!session.value) return status(401)
		}
	})
	.post('/user', ({ body }) => body, {
		auth: true // [!code ++]
	})
	.listen(3000)
```

**auth** å°†å†…è” **cookie** å’Œ **beforeHandle** åˆ°è·¯ç”±ä¸­ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œå® **æ˜¯å¯é‡ç”¨çš„è·¯ç”±é€‰é¡¹**ï¼Œç±»ä¼¼äºå‡½æ•°ï¼Œä½†ä½œä¸ºå…·æœ‰ **ç±»å‹å®‰å…¨æ€§** çš„è·¯ç”±é€‰é¡¹ã€‚

## ä»»åŠ¡

è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå®æ¥æ£€æŸ¥ä¸€ä¸ªæ•°å­—æ˜¯å¦æ˜¯æ–æ³¢é‚£å¥‘æ•°ï¼š

```typescript
function isFibonacci(n: number) {
	let a = 0, b = 1
	while(b < n) [a, b] = [b, a + b]
	return b === n || n === 0
}
```

\<template #answer>

1. ä¸ºäº†å¼ºåˆ¶ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®ä¸­å®šä¹‰ä¸€ä¸ª `body` å±æ€§ã€‚
2. ä¸ºäº†çŸ­è·¯è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `status` å‡½æ•°æå‰è¿”å›ã€‚

```typescript
import { Elysia, t } from 'elysia'

function isPerfectSquare(x: number) {
    const s = Math.floor(Math.sqrt(x))
    return s * s === x
}

function isFibonacci(n: number) {
    if (n < 0) return false

    return isPerfectSquare(5 * n * n + 4) || isPerfectSquare(5 * n * n - 4)
}

new Elysia()
    .macro('isFibonacci', {
		body: t.Number(),
        beforeHandle({ body, status }) {
            if(!isFibonacci(body)) return status(418)
        }
    })
	.post('/', ({ body }) => body, {
		isFibonacci: true
	})
    .listen(3000)
```

---

---
url: 'https://elysiajs.com/patterns/macro.md'
---

# å®&#x20;

å®ç±»ä¼¼äºä¸€ä¸ªå‡½æ•°ï¼Œèƒ½å¤Ÿå¯¹ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€æ¨¡å¼ã€ä¸Šä¸‹æ–‡è¿›è¡Œæ§åˆ¶ï¼Œå¹¶å…·å¤‡å®Œå…¨çš„ç±»å‹å®‰å…¨ã€‚

ä¸€æ—¦å®šä¹‰ï¼Œå®ƒå°†åœ¨é’©å­ä¸­å¯ç”¨ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ·»åŠ è¯¥å±æ€§æ¥æ¿€æ´»ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

const plugin = new Elysia({ name: 'plugin' })
    .macro({
        hi: (word: string) => ({
            beforeHandle() {
                console.log(word)
            }
        })
    })

const app = new Elysia()
    .use(plugin)
    .get('/', () => 'hi', {
        hi: 'Elysia' // [!code ++]
    })
```

è®¿é—®è¯¥è·¯å¾„æ—¶ï¼Œåº”ä¼šåœ¨æ§åˆ¶å°è¾“å‡º **"Elysia"**ã€‚

## å±æ€§ç®€å†™

ä» Elysia 1.2.10 å¼€å§‹ï¼Œå®å¯¹è±¡ä¸­çš„æ¯ä¸ªå±æ€§éƒ½å¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°æˆ–ä¸€ä¸ªå¯¹è±¡ã€‚

å¦‚æœå±æ€§æ˜¯å¯¹è±¡ï¼Œå®ƒå°†è¢«è½¬æ¢ä¸ºä¸€ä¸ªæ¥å—å¸ƒå°”å‚æ•°çš„å‡½æ•°ï¼Œå¹¶ä¸”åœ¨å‚æ•°ä¸º true æ—¶æ‰§è¡Œã€‚

```typescript
import { Elysia } from 'elysia'

export const auth = new Elysia()
    .macro({
    	// This property shorthand
    	isAuth: { // [!code ++]
      		resolve: () => ({ // [!code ++]
      			user: 'saltyaom' // [!code ++]
      		}) // [!code ++]
        }, // [!code ++]
        // is equivalent to
        isAuth(enabled: boolean) { // [!code --]
        	if(!enabled) return // [!code --]
// [!code --]

        	return { // [!code --]
				resolve() { // [!code --]
					return { // [!code --]
						user // [!code --]
					} // [!code --]
				} // [!code --]
         	} // [!code --]
        } // [!code --]
    })
```

## é”™è¯¯å¤„ç†

ä½ å¯ä»¥é€šè¿‡è¿”å›ä¸€ä¸ª `status` æ¥è¿”å›é”™è¯¯çš„ HTTP çŠ¶æ€ã€‚

```ts
import { Elysia, status } from 'elysia' // [!code ++]

new Elysia()
	.macro({
		auth: {
			resolve({ headers }) {
				if(!headers.authorization)
					return status(401, 'Unauthorized') // [!code ++]
		
				return {
					user: 'SaltyAom'
				}
			}
		}
	})
	.get('/', ({ user }) => `Hello ${user}`, {
	            // ^?
		auth: true
	})
```

å»ºè®®æ‚¨ä½¿ç”¨ `return status` è€Œä¸æ˜¯ `throw new Error()` æ¥æ ‡æ³¨æ­£ç¡®çš„ HTTP çŠ¶æ€ç ã€‚

å¦‚æœæ‚¨æŠ›å‡ºé”™è¯¯ï¼ŒElysia é»˜è®¤ä¼šå°†å…¶è½¬æ¢ä¸º `500 Internal Server Error`ã€‚

åŒæ ·å»ºè®®ä½¿ç”¨ `return status` è€Œä¸æ˜¯ `throw status`ï¼Œä»¥ç¡®ä¿ [Eden](/eden/overview) å’Œ [OpenAPI Type Gen](/patterns/openapi#openapi-from-types) éƒ½èƒ½è¿›è¡Œç±»å‹æ¨æ–­ã€‚

## è§£æ (Resolve)

é€šè¿‡è¿”å›ä¸€ä¸ªå¸¦æœ‰ [**resolve**](/essential/life-cycle.html#resolve) å‡½æ•°çš„å¯¹è±¡ï¼Œæ‚¨å¯ä»¥å°†å±æ€§æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚

```ts twoslash
import { Elysia } from 'elysia'

new Elysia()
	.macro({
		user: (enabled: true) => ({
			resolve: () => ({
				user: 'Pardofelis'
			})
		})
	})
	.get('/', ({ user }) => user, {
                          // ^?
		user: true
	})
```

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è¿”å›ä¸€ä¸ªå¸¦æœ‰ **resolve** å‡½æ•°çš„å¯¹è±¡å‘ä¸Šä¸‹æ–‡æ·»åŠ äº†ä¸€ä¸ªæ–°å±æ€§ **user**ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®è§£æå¯èƒ½æœ‰ç”¨çš„ç¤ºä¾‹ï¼š

* æ‰§è¡Œèº«ä»½éªŒè¯å¹¶å°†ç”¨æˆ·æ·»åŠ åˆ°ä¸Šä¸‹æ–‡
* è¿è¡Œé¢å¤–çš„æ•°æ®åº“æŸ¥è¯¢å¹¶å°†æ•°æ®æ·»åŠ åˆ°ä¸Šä¸‹æ–‡
* å‘ä¸Šä¸‹æ–‡æ·»åŠ æ–°å±æ€§

### å¸¦æœ‰è§£æçš„å®æ‰©å±•

ç”±äº TypeScript çš„é™åˆ¶ï¼Œæ‰©å±•å…¶ä»–å®çš„å®æ— æ³•æ¨æ–­ **resolve** å‡½æ•°çš„ç±»å‹ã€‚

æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå‘½åçš„å•ä¸€å®ä½œä¸ºè§£å†³æ­¤é™åˆ¶çš„å˜é€šæ–¹æ³•ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'
new Elysia()
	.macro('user', {
		resolve: () => ({
			user: 'lilith' as const
		})
	})
	.macro('user2', {
		user: true,
		resolve: ({ user }) => {
		//           ^?
		}
	})
```

## æ¶æ„

æ‚¨å¯ä»¥ä¸ºæ‚¨çš„å®å®šä¹‰ä¸€ä¸ªè‡ªå®šä¹‰æ¶æ„ï¼Œä»¥ç¡®ä¿ä½¿ç”¨è¯¥å®çš„è·¯ç”±ä¼ é€’æ­£ç¡®çš„ç±»å‹ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.macro({
		withFriends: {
			body: t.Object({
				friends: t.Tuple([t.Literal('Fouco'), t.Literal('Sartre')])
			})
		}
	})
	.post('/', ({ body }) => body.friends, {
//                                  ^?

		body: t.Object({
			name: t.Literal('Lilith')
		}),
		withFriends: true
	})
```

å¸¦æœ‰æ¨¡å¼çš„å®å°†è‡ªåŠ¨è¿›è¡Œæ ¡éªŒå¹¶æ¨æ–­ç±»å‹ï¼Œç¡®ä¿ç±»å‹å®‰å…¨ï¼Œå¹¶ä¸”å¯ä»¥ä¸ç°æœ‰çš„æ¨¡å¼å…±å­˜ã€‚

æ‚¨ä¹Ÿå¯ä»¥å †å æ¥è‡ªä¸åŒå®çš„å¤šä¸ªæ¨¡å¼ï¼Œç”šè‡³ä¸æ ‡å‡†éªŒè¯å™¨é…åˆä½¿ç”¨ï¼Œå®ƒä»¬å°†æ— ç¼åä½œã€‚

### Schema with lifecycle in the same macro

Similar to [Macro extension with resolve](#macro-extension-with-resolve),

Macro schema also support type inference for **lifecycle within the same macro** **BUT** only with named single macro due to TypeScript limitation.

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.macro('withFriends', {
		body: t.Object({
			friends: t.Tuple([t.Literal('Fouco'), t.Literal('Sartre')])
		}),
		beforeHandle({ body: { friends } }) {
//                             ^?
		}
	})
```

å¦‚æœæ‚¨æƒ³åœ¨åŒä¸€å®å†…ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸç±»å‹æ¨æ–­ï¼Œå»ºè®®ä½¿ç”¨å‘½åçš„å•ä¸€å®ï¼Œè€Œéå¤šä¸ªå åŠ å®ã€‚

> ä¸è¦å°†æ­¤ä¸ä½¿ç”¨å®æ¨¡å¼æ¨æ–­è·¯ç”±ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ä¸­çš„ç±»å‹æ··æ·†ã€‚åè€…è¿è¡Œè‰¯å¥½ï¼Œæ­¤é™åˆ¶ä»…é’ˆå¯¹åœ¨åŒä¸€å®ä¸­ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸã€‚

## æ‰©å±•

å®å¯ä»¥æ‰©å±•å…¶ä»–å®ï¼Œå…è®¸æ‚¨åŸºäºå·²æœ‰å®è¿›è¡Œæ„å»ºã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.macro({
		sartre: {
			body: t.Object({
				sartre: t.Literal('Sartre')
			})
		},
		fouco: {
			body: t.Object({
				fouco: t.Literal('Fouco')
			})
		},
		lilith: {
			fouco: true,
			sartre: true,
			body: t.Object({
				lilith: t.Literal('Lilith')
			})
		}
	})
	.post('/', ({ body }) => body, {
//                            ^?
		lilith: true
	})



// ---cut-after---
//
```

è¿™å…è®¸æ‚¨åŸºäºå·²æœ‰å®æ„å»ºï¼Œå¹¶ä¸ºå…¶æ·»åŠ æ›´å¤šåŠŸèƒ½ã€‚

## å»é‡

å®ä¼šè‡ªåŠ¨å»é‡ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç¡®ä¿æ¯ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶åªæ‰§è¡Œä¸€æ¬¡ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia ä¼šä½¿ç”¨å±æ€§å€¼ä½œä¸ºç§å­ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡æä¾›è‡ªå®šä¹‰ç§å­æ¥è¦†ç›–å®ƒã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.macro({
		sartre: (role: string) => ({
			seed: role, // [!code ++]
			body: t.Object({
				sartre: t.Literal('Sartre')
			})
		})
	})
```

ä¸è¿‡ï¼Œå¦‚æœæ‚¨ä¸æ…åˆ›å»ºäº†å¾ªç¯ä¾èµ–ï¼ŒElysia ä¼šæœ‰ä¸€ä¸ª16å±‚çš„é™åˆ¶å †æ ˆï¼Œä»¥é˜²æ­¢è¿è¡Œæ—¶å’Œç±»å‹æ¨æ–­ä¸­å‡ºç°æ— é™å¾ªç¯ã€‚

å¦‚æœè·¯ç”±å·²ç»æœ‰ OpenAPI è¯¦æƒ…ï¼Œå®ƒå°†åˆå¹¶è¯¥è¯¦æƒ…ï¼Œä½†ä¼˜å…ˆä¿ç•™è·¯ç”±çš„è¯¦æƒ…ï¼Œè€Œéå®çš„è¯¦æƒ…ã€‚

---

---
url: 'https://elysiajs.com/tutorial/getting-started/encapsulation.md'
---

# å°è£…

Elysia é’©å­ä»…**å°è£…**åˆ°å…¶è‡ªå·±çš„å®ä¾‹ä¸­ã€‚

å¦‚æœæ‚¨åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹ï¼Œåˆ™ä¸ä¼šä¸å…¶ä»–å®ä¾‹å…±äº«é’©å­ã€‚

```ts
import { Elysia } from 'elysia'

const profile = new Elysia()
	.onBeforeHandle(
		({ query: { name }, status }) => {
			if(!name)
				return status(401)
		}
	)
	.get('/profile', () => 'å—¨ï¼')

new Elysia()
	.use(profile)
	.patch('/rename', () => 'å¥½çš„ï¼XD')
	.listen(3000)
```

> å°è¯•åœ¨ URL åœ°å€æ ä¸­æ›´æ”¹è·¯å¾„ä¸º **/rename** å¹¶æŸ¥çœ‹ç»“æœ

**Elysia éš”ç¦»ç”Ÿå‘½å‘¨æœŸ**ï¼Œé™¤éæ˜ç¡®è¯´æ˜ã€‚

è¿™ç±»ä¼¼äº JavaScript ä¸­çš„ **export**ï¼Œæ‚¨éœ€è¦å¯¼å‡ºå‡½æ•°æ‰èƒ½ä½¿å…¶å¯ç”¨äºæ¨¡å—å¤–éƒ¨ã€‚

è¦\*\*â€œå¯¼å‡ºâ€\*\*ç”Ÿå‘½å‘¨æœŸåˆ°å…¶ä»–å®ä¾‹ï¼Œæ‚¨å¿…é¡»æŒ‡å®šèŒƒå›´ã€‚

### èŒƒå›´

æœ‰ 3 ç§å¯ç”¨èŒƒå›´ï¼š

1. **local**ï¼ˆé»˜è®¤ï¼‰ - ä»…é€‚ç”¨äºå½“å‰å®ä¾‹åŠå…¶å­å®ä¾‹
2. **scoped** - é€‚ç”¨äºçˆ¶å®ä¾‹ã€å½“å‰å®ä¾‹åŠå­å®ä¾‹
3. **global** - é€‚ç”¨äºåº”ç”¨æ’ä»¶çš„æ‰€æœ‰å®ä¾‹ï¼ˆæ‰€æœ‰çˆ¶å®ä¾‹ã€å½“å‰å®ä¾‹å’Œå­å®ä¾‹ï¼‰

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›å°†ç™»å½•æ£€æŸ¥åº”ç”¨äºç›´æ¥çˆ¶çº§ `app`ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ **scoped** æˆ– **global**ã€‚

```ts
import { Elysia } from 'elysia'

const profile = new Elysia()
	.onBeforeHandle(
		{ as: 'scoped' }, // [!code ++]
		({ cookie }) => {
			throwIfNotSignIn(cookie)
		}
	)
	.get('/profile', () => 'ä½ å¥½ï¼')

const app = new Elysia()
	.use(profile)
	// è¿™é‡Œæœ‰ç™»å½•æ£€æŸ¥
	.patch('/rename', ({ body }) => updateProfile(body))
```

å°†ç”Ÿå‘½å‘¨æœŸè½¬æ¢ä¸º **"scoped"** å°†ç”Ÿå‘½å‘¨æœŸå¯¼å‡ºåˆ° **çˆ¶å®ä¾‹**ã€‚
è€Œ **"global"** å°†ç”Ÿå‘½å‘¨æœŸå¯¼å‡ºåˆ° **æ‰€æœ‰å…·æœ‰æ’ä»¶çš„å®ä¾‹**ã€‚

åœ¨ èŒƒå›´ ä¸­äº†è§£æ›´å¤šå…³äºæ­¤çš„ä¿¡æ¯ã€‚

## ä¿æŠ¤

ç±»ä¼¼äºç”Ÿå‘½å‘¨æœŸï¼Œ**schema** ä¹Ÿå°è£…åˆ°å…¶è‡ªå·±çš„å®ä¾‹ä¸­ã€‚

æˆ‘ä»¬å¯ä»¥åƒç”Ÿå‘½å‘¨æœŸä¸€æ ·æŒ‡å®šä¿æŠ¤èŒƒå›´ã€‚

```typescript
import { Elysia } from 'elysia'

const user = new Elysia()
	.guard({
		as: 'scoped', // [!code ++]
		query: t.Object({
			age: t.Number(),
			name: t.Optional(t.String())
		}),
		beforeHandle({ query: { age }, status }) {
			if(age < 18) return status(403)
		}
	})
	.get('/profile', () => 'å—¨ï¼')
	.get('/settings', () => 'è®¾ç½®')
```

éå¸¸é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œæ¯ä¸ªé’©å­å°†å½±å“å…¶å£°æ˜**åé¢**çš„æ‰€æœ‰è·¯ç”±ã€‚

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ èŒƒå›´ã€‚

## ä»»åŠ¡

è®©æˆ‘ä»¬ä¸º `nameCheck` å’Œ `ageCheck` å®šä¹‰ä¸€ä¸ªèŒƒå›´ï¼Œä»¥ä½¿æˆ‘ä»¬çš„åº”ç”¨æ­£å¸¸å·¥ä½œã€‚

\<template #answer>

æˆ‘ä»¬å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼ä¿®æ”¹èŒƒå›´ï¼š

1. å°† `nameCheck` çš„èŒƒå›´ä¿®æ”¹ä¸º **scope**
2. å°† `ageCheck` çš„èŒƒå›´ä¿®æ”¹ä¸º **global**

```typescript
import { Elysia, t } from 'elysia'

const nameCheck = new Elysia()
	.onBeforeHandle(
		{ as: 'scoped' }, // [!code ++]
		({ query: { name }, status }) => {
			if(!name) return status(401)
		}
	)

const ageCheck = new Elysia()
	.guard({
		as: 'global', // [!code ++]
		query: t.Object({
			age: t.Number(),
			name: t.Optional(t.String())
		}),
		beforeHandle({ query: { age }, status }) {
			if(age < 18) return status(403)
		}
	})

const name = new Elysia()
	.use(nameCheck)
	.patch('/rename', () => 'å¥½çš„ï¼XD')

const profile = new Elysia()
	.use(ageCheck)
	.use(name)
	.get('/profile', () => 'å—¨ï¼')

new Elysia()
	.use(profile)
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/quick-start.md'
---

# å¿«é€Ÿå…¥é—¨

Elysia æ˜¯ä¸€ä¸ªæ”¯æŒå¤šç§è¿è¡Œç¯å¢ƒçš„ TypeScript åç«¯æ¡†æ¶ï¼Œä½†å·²é’ˆå¯¹ Bun è¿›è¡Œäº†ä¼˜åŒ–ã€‚

ç„¶è€Œï¼Œä½ ä¹Ÿå¯ä»¥åœ¨å…¶ä»–è¿è¡Œç¯å¢ƒå¦‚ Node.js ä¸­ä½¿ç”¨ Elysiaã€‚

\<Tab
id="quickstart"
:names="\['Bun', 'Node.js', 'Web Standard']"
:tabs="\['bun', 'node', 'web-standard']"

>

Elysia é’ˆå¯¹ Bun è¿›è¡Œäº†ä¼˜åŒ–ï¼ŒBun æ˜¯ä¸€ç§æ—¨åœ¨ä½œä¸º Node.js çš„ç›´æ¥æ›¿ä»£å“çš„ JavaScript è¿è¡Œæ—¶ã€‚

ä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£… Bunï¼š

::: code-group

```bash [MacOS/Linux]
curl -fsSL https://bun.sh/install | bash
```

```bash [Windows]
powershell -c "irm bun.sh/install.ps1 | iex"
```

:::

\<Tab
id="quickstart"
:names="\['è‡ªåŠ¨å®‰è£…', 'æ‰‹åŠ¨å®‰è£…']"
:tabs="\['auto', 'manual']"

>

æˆ‘ä»¬å»ºè®®ä½¿ç”¨ `bun create elysia` å¯åŠ¨ä¸€ä¸ªæ–°çš„ Elysia æœåŠ¡å™¨ï¼Œè¯¥å‘½ä»¤ä¼šè‡ªåŠ¨è®¾ç½®æ‰€æœ‰å†…å®¹ã€‚

```bash
bun create elysia app
```

å®Œæˆåï¼Œä½ åº”è¯¥ä¼šåœ¨ç›®å½•ä¸­çœ‹åˆ°åä¸º `app` çš„æ–‡ä»¶å¤¹ã€‚

```bash
cd app
```

é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š

```bash
bun dev
```

è®¿é—® [localhost:3000](http://localhost:3000) åº”è¯¥ä¼šæ˜¾ç¤º "Hello Elysia"ã€‚

::: tip
Elysia æä¾›äº† `dev` å‘½ä»¤ï¼Œèƒ½å¤Ÿåœ¨æ–‡ä»¶æ›´æ”¹æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½ä½ çš„æœåŠ¡å™¨ã€‚
:::

è¦æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ Elysia åº”ç”¨ï¼Œè¯·å°† Elysia ä½œä¸ºä¸€ä¸ªåŒ…å®‰è£…ï¼š

```typescript
bun add elysia
bun add -d @types/bun
```

è¿™å°†å®‰è£… Elysia å’Œ Bun çš„ç±»å‹å®šä¹‰ã€‚

åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ `src/index.ts`ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```typescript
import { Elysia } from 'elysia'

const app = new Elysia()
	.get('/', () => 'Hello Elysia')
	.listen(3000)

console.log(
	`ğŸ¦Š Elysia æ­£åœ¨è¿è¡Œåœ¨ ${app.server?.hostname}:${app.server?.port}`
)
```

æ‰“å¼€ä½ çš„ `package.json` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹è„šæœ¬ï¼š

```json
{
   	"scripts": {
  		"dev": "bun --watch src/index.ts",
  		"build": "bun build src/index.ts --target bun --outdir ./dist",
  		"start": "NODE_ENV=production bun dist/index.js",
  		"test": "bun test"
   	}
}
```

è¿™äº›è„šæœ¬é€‚ç”¨äºåº”ç”¨ç¨‹åºå¼€å‘çš„ä¸åŒé˜¶æ®µï¼š

* **dev** - åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯åŠ¨ Elysiaï¼Œå¹¶åœ¨ä»£ç æ›´æ”¹æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½ã€‚
* **build** - ä¸ºç”Ÿäº§ä½¿ç”¨æ„å»ºåº”ç”¨ç¨‹åºã€‚
* **start** - å¯åŠ¨ Elysia ç”Ÿäº§æœåŠ¡å™¨ã€‚

å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ TypeScriptï¼Œè¯·ç¡®ä¿åˆ›å»ºå¹¶æ›´æ–° `tsconfig.json`ï¼Œå°† `compilerOptions.strict` è®¾ç½®ä¸º `true`ï¼š

```json
{
   	"compilerOptions": {
  		"strict": true
   	}
}
```

Node.js æ˜¯ä¸€ä¸ªç”¨äºæœåŠ¡å™¨ç«¯åº”ç”¨çš„ JavaScript è¿è¡Œæ—¶ï¼Œä¹Ÿæ˜¯ Elysia æ”¯æŒçš„æœ€æµè¡Œçš„è¿è¡Œæ—¶ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£… Node.jsï¼š

::: code-group

```bash [MacOS]
brew install node
```

```bash [Windows]
choco install nodejs
```

```bash [apt (Linux)]
sudo apt install nodejs
```

```bash [pacman (Arch)]
pacman -S nodejs npm
```

:::

## è®¾ç½®

æˆ‘ä»¬å»ºè®®åœ¨ä½ çš„ Node.js é¡¹ç›®ä¸­ä½¿ç”¨ TypeScriptã€‚

\<Tab
id="language"
:names="\['TypeScript', 'JavaScript']"
:tabs="\['ts', 'js']"

>

è¦ä½¿ç”¨ TypeScript åˆ›å»ºä¸€ä¸ªæ–°çš„ Elysia åº”ç”¨ï¼Œæˆ‘ä»¬å»ºè®®é€šè¿‡ `tsx` å®‰è£… Elysiaï¼š

::: code-group

```bash [bun]
bun add elysia @elysiajs/node && \
bun add -d tsx @types/node typescript
```

```bash [pnpm]
# pnpm doesn't install peer dependencies
pnpm add elysia @elysiajs/node @sinclair/typebox openapi-types && \
pnpm add -D tsx @types/node typescript
```

```bash [npm]
npm install elysia @elysiajs/node && \
npm install --save-dev tsx @types/node typescript
```

```bash [yarn]
yarn add elysia @elysiajs/node && \
yarn add -D tsx @types/node typescript
```

:::

è¿™å°†å®‰è£… Elysiaã€TypeScript å’Œ `tsx`ã€‚

`tsx` æ˜¯ä¸€ä¸ª CLIï¼Œå¯ä»¥å°† TypeScript è½¬æ¢ä¸º JavaScriptï¼Œå…·æœ‰çƒ­é‡è½½å’Œç°ä»£å¼€å‘ç¯å¢ƒæ‰€éœ€çš„å…¶ä»–åŠŸèƒ½ã€‚

åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ `src/index.ts` å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```typescript
import { Elysia } from 'elysia'
import { node } from '@elysiajs/node'

const app = new Elysia({ adapter: node() })
	.get('/', () => 'Hello Elysia')
	.listen(3000, ({ hostname, port }) => {
		console.log(
			`ğŸ¦Š Elysia æ­£åœ¨è¿è¡Œåœ¨ ${hostname}:${port}`
		)
	})
```

æ‰“å¼€ä½ çš„ `package.json` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹è„šæœ¬ï¼š

```json
{
   	"scripts": {
  		"dev": "tsx watch src/index.ts",
    	"build": "tsc src/index.ts --outDir dist",
  		"start": "NODE_ENV=production node dist/index.js"
   	}
}
```

è¿™äº›è„šæœ¬é€‚ç”¨äºåº”ç”¨ç¨‹åºå¼€å‘çš„ä¸åŒé˜¶æ®µï¼š

* **dev** - åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯åŠ¨ Elysiaï¼Œå¹¶åœ¨ä»£ç æ›´æ”¹æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½ã€‚
* **build** - ä¸ºç”Ÿäº§ä½¿ç”¨æ„å»ºåº”ç”¨ç¨‹åºã€‚
* **start** - å¯åŠ¨ Elysia ç”Ÿäº§æœåŠ¡å™¨ã€‚

ç¡®ä¿åˆ›å»º `tsconfig.json`

```bash
npx tsc --init
```

ä¸è¦å¿˜è®°æ›´æ–° `tsconfig.json`ï¼Œå°† `compilerOptions.strict` è®¾ç½®ä¸º `true`ï¼š

```json
{
   	"compilerOptions": {
  		"strict": true
   	}
}
```

::: warning
å¦‚æœæ‚¨åœ¨æ²¡æœ‰ TypeScript çš„æƒ…å†µä¸‹ä½¿ç”¨ Elysiaï¼Œæ‚¨å¯èƒ½ä¼šé”™è¿‡ä¸€äº›åŠŸèƒ½ï¼Œæ¯”å¦‚è‡ªåŠ¨è¡¥å…¨ã€å…ˆè¿›çš„ç±»å‹æ£€æŸ¥å’Œç«¯åˆ°ç«¯çš„ç±»å‹å®‰å…¨ï¼Œè¿™äº›éƒ½æ˜¯ Elysia çš„æ ¸å¿ƒåŠŸèƒ½ã€‚
:::

è¦ä½¿ç”¨ JavaScript åˆ›å»ºä¸€ä¸ªæ–°çš„ Elysia åº”ç”¨ï¼Œé¦–å…ˆå®‰è£… Elysiaï¼š

::: code-group

```bash [pnpm]
bun add elysia @elysiajs/node
```

```bash [pnpm]
# pnpm doesn't install peer dependencies
pnpm add elysia @elysiajs/node @sinclair/typebox openapi-types
```

```bash [npm]
npm install elysia @elysiajs/node
```

```bash [yarn]
yarn add elysia @elysiajs/node
```

:::

è¿™å°†å®‰è£… Elysia å’Œ TypeScriptã€‚

åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ `src/index.ts` å¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```javascript
import { Elysia } from 'elysia'
import { node } from '@elysiajs/node'

const app = new Elysia({ adapter: node() })
	.get('/', () => 'Hello Elysia')
	.listen(3000, ({ hostname, port }) => {
		console.log(
			`ğŸ¦Š Elysia æ­£åœ¨è¿è¡Œåœ¨ ${hostname}:${port}`
		)
	})
```

æ‰“å¼€ä½ çš„ `package.json` æ–‡ä»¶å¹¶æ·»åŠ ä»¥ä¸‹è„šæœ¬ï¼š

```json
{
	"type": "module",
   	"scripts": {
  		"dev": "node src/index.ts",
  		"start": "NODE_ENV=production node src/index.js"
   	}
}
```

è¿™äº›è„šæœ¬é€‚ç”¨äºåº”ç”¨ç¨‹åºå¼€å‘çš„ä¸åŒé˜¶æ®µï¼š

* **dev** - åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯åŠ¨ Elysiaï¼Œå¹¶åœ¨ä»£ç æ›´æ”¹æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½ã€‚
* **start** - å¯åŠ¨ Elysia ç”Ÿäº§æœåŠ¡å™¨ã€‚

ç¡®ä¿åˆ›å»º `tsconfig.json`

```bash
npx tsc --init
```

ä¸è¦å¿˜è®°æ›´æ–° `tsconfig.json`ï¼Œå°† `compilerOptions.strict` è®¾ç½®ä¸º `true`ï¼š

```json
{
   	"compilerOptions": {
  		"strict": true
   	}
}
```

Elysia æ˜¯ä¸€ä¸ªç¬¦åˆ WinterCG æ ‡å‡†çš„åº“ï¼Œè¿™æ„å‘³ç€å¦‚æœä¸€ä¸ªæ¡†æ¶æˆ–è¿è¡Œæ—¶æ”¯æŒ Web æ ‡å‡†çš„è¯·æ±‚/å“åº”ï¼Œå®ƒå°±å¯ä»¥è¿è¡Œ Elysiaã€‚

é¦–å…ˆï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£… Elysiaï¼š

::: code-group

```bash [bun]
bun install elysia
```

```bash [pnpm]
# pnpm doesn't install peer depepdencies
pnpm install elysia @sinclair/typebox openapi-types
```

```bash [npm]
npm install elysia
```

```bash [yarn]
yarn add elysia
```

:::

æ¥ä¸‹æ¥ï¼Œé€‰æ‹©ä¸€ä¸ªæ”¯æŒ Web æ ‡å‡†è¯·æ±‚/å“åº”çš„è¿è¡Œæ—¶ã€‚

æˆ‘ä»¬æœ‰ä¸€äº›æ¨èï¼š

### æ²¡åœ¨åˆ—è¡¨ä¸Šï¼Ÿ

å¦‚æœæ‚¨ä½¿ç”¨è‡ªå®šä¹‰è¿è¡Œæ—¶ï¼Œæ‚¨å¯ä»¥è®¿é—® `app.fetch` æ‰‹åŠ¨å¤„ç†è¯·æ±‚å’Œå“åº”ã€‚

```typescript
import { Elysia } from 'elysia'

const app = new Elysia()
	.get('/', () => 'Hello Elysia')
	.listen(3000)

export default app.fetch

console.log(
	`ğŸ¦Š Elysia æ­£åœ¨è¿è¡Œåœ¨ ${app.server?.hostname}:${app.server?.port}`
)
```

---

---
url: 'https://elysiajs.com/tutorial/patterns/extends-context.md'
---

# æ‰©å±•ä¸Šä¸‹æ–‡

Elysia æä¾›äº†ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œå®ƒé…å¤‡äº†å°å·¥å…·ï¼Œå¸®åŠ©æ‚¨å…¥é—¨ã€‚

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰©å±• Elysia çš„ä¸Šä¸‹æ–‡ï¼š

1. Decorate
2. State
3. Resolve
4. Derive

## Decorate

**å•ä¾‹**ï¼Œä¸”æ˜¯**ä¸å¯å˜**çš„ï¼Œè·¨æ‰€æœ‰è¯·æ±‚å…±äº«ã€‚

```typescript
import { Elysia } from 'elysia'

class Logger {
    log(value: string) {
        console.log(value)
    }
}

new Elysia()
    .decorate('logger', new Logger())
    .get('/', ({ logger }) => {
        logger.log('hi')

        return 'hi'
    })
```

è£…é¥°åçš„å€¼å°†åœ¨ä¸Šä¸‹æ–‡ä¸­ä½œä¸ºåªè¯»å±æ€§å¯ç”¨ï¼Œè¯¦è§ Decorateã€‚

## State

ä¸€ä¸ª**å¯å˜**çš„å¼•ç”¨ï¼Œè·¨æ‰€æœ‰è¯·æ±‚å…±äº«ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.state('count', 0)
	.get('/', ({ store }) => {
		store.count++

		return store.count
	})
```

çŠ¶æ€å°†åœ¨æ¯ä¸ªè¯·æ±‚å…±äº«çš„ **context.store** ä¸­å¯ç”¨ï¼Œè¯¦è§ Stateã€‚

## Resolve / Derive

Decorate çš„å€¼æ³¨å†Œä¸ºå•ä¾‹ã€‚

è€Œ Resolve å’Œ Derive å…è®¸æ‚¨æ¯ä¸ªè¯·æ±‚æŠ½è±¡ä¸€ä¸ªä¸Šä¸‹æ–‡å€¼ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.derive(({ headers: { authorization } }) => ({
		authorization
	}))
	.get('/', ({ authorization }) => authorization)
```

ä»»ä½•**è¿”å›çš„å€¼éƒ½ä¼šåœ¨ä¸Šä¸‹æ–‡ä¸­å¯ç”¨**ï¼Œé™¤äº†çŠ¶æ€ï¼Œå®ƒå°†ç›´æ¥å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå¹¶ä¸­æ­¢åç»­å¤„ç†ç¨‹åºã€‚

ä¸¤ä¸ª resolve å’Œ derive çš„è¯­æ³•ç›¸ä¼¼ï¼Œä½†ä½¿ç”¨åœºæ™¯ä¸åŒã€‚

åœ¨åº•å±‚ï¼Œä¸¤è€…æ˜¯ä¸€ä¸ªè¯­æ³•ç³– (å…·æœ‰ç±»å‹å®‰å…¨) çš„ç”Ÿå‘½å‘¨æœŸï¼š

* derive åŸºäº transform
* resolve åŸºäº before handle

ç”±äº derive åŸºäº transformï¼Œè¿™æ„å‘³ç€æ•°æ®å°šæœªéªŒè¯ä¸”æœªå¼ºåˆ¶/è½¬æ¢ã€‚å¦‚æœæ‚¨éœ€è¦ç»è¿‡éªŒè¯çš„æ•°æ®ï¼Œæœ€å¥½ä½¿ç”¨ resolveã€‚

## ä½œç”¨åŸŸ

State å’Œ Decorate æ˜¯è·¨æ‰€æœ‰è¯·æ±‚å’Œå®ä¾‹å…±äº«çš„ã€‚

Resolve å’Œ Derive æ˜¯æ¯ä¸ªè¯·æ±‚éƒ½æœ‰çš„ï¼Œå¹¶å…·æœ‰å°è£…ä½œç”¨åŸŸ (å› ä¸ºå®ƒä»¬åŸºäºç”Ÿå‘½å‘¨æœŸäº‹ä»¶)ã€‚

å¦‚æœæ‚¨æƒ³ä½¿ç”¨æ¥è‡ªæ’ä»¶çš„è§£æ/æ´¾ç”Ÿå€¼ï¼Œæ‚¨éœ€è¦å£°æ˜ä¸€ä¸ª Scopeã€‚

```typescript
import { Elysia } from 'elysia'

const plugin = new Elysia()
	.derive(
		{ as: 'scoped' }, // [!ä»£ç  ++]
		({ headers: { authorization } }) => ({
			authorization
		})
	)

new Elysia()
	.use(plugin)
	.get('/', ({ authorization }) => authorization)
	.listen(3000)
```

## ç»ƒä¹ 

è®©æˆ‘ä»¬å°è¯•æ‰©å±• Elysia çš„ä¸Šä¸‹æ–‡ã€‚

\<template #answer>

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ resolve ä»æŸ¥è¯¢ä¸­æå–å¹´é¾„ã€‚

```typescript
import { Elysia, t } from 'elysia'

class Logger {
	log(info: string) {
		console.log(info)
	}
}

new Elysia()
	.decorate('logger', new Logger())
	.onRequest(({ request, logger }) => {
		logger.log(`Request to ${request.url}`)
	})
	.guard({
		query: t.Optional(
			t.Object({
				age: t.Number({ min: 15 })
			})
		)
	})
	.resolve(({ query: { age }, status }) => {
		if(!age) return status(401)

		return { age }
	})
	.get('/profile', ({ age }) => age)
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/patterns/extends-context.md'
---

# æ‰©å±•ä¸Šä¸‹æ–‡&#x20;

Elysiaé»˜è®¤æä¾›äº†ä¸€ä¸ªæœ€å°çš„ä¸Šä¸‹æ–‡ï¼Œå…è®¸æˆ‘ä»¬ä½¿ç”¨çŠ¶æ€ã€è£…é¥°ã€æ´¾ç”Ÿå’Œè§£ææ ¹æ®æˆ‘ä»¬çš„å…·ä½“éœ€æ±‚æ‰©å±•ä¸Šä¸‹æ–‡ã€‚

Elysiaå…è®¸æˆ‘ä»¬ä¸ºå„ç§ç”¨ä¾‹æ‰©å±•ä¸Šä¸‹æ–‡ï¼Œä¾‹å¦‚ï¼š

* å°†ç”¨æˆ·IDæå–ä¸ºå˜é‡
* æ³¨å…¥ä¸€ä¸ªå…¬å…±æ¨¡å¼å­˜å‚¨åº“
* æ·»åŠ ä¸€ä¸ªæ•°æ®åº“è¿æ¥

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ä»¥ä¸‹APIæ¥æ‰©å±•Elysiaçš„ä¸Šä¸‹æ–‡ï¼Œä»¥è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ï¼š

* [state](#state) - å…¨å±€å¯å˜çŠ¶æ€
* [decorate](#decorate) - åˆ†é…ç»™ **Context** çš„é¢å¤–å±æ€§
* [derive](#derive) / [resolve](#resolve) - ä»ç°æœ‰å±æ€§åˆ›å»ºæ–°å€¼

### ä½•æ—¶æ‰©å±•ä¸Šä¸‹æ–‡

åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼Œæ‚¨æ‰åº”è¯¥æ‰©å±•ä¸Šä¸‹æ–‡ï¼š

* å±æ€§æ˜¯ä¸€ä¸ªå…¨å±€å¯å˜çŠ¶æ€ï¼Œå¹¶ä¸”åœ¨å¤šä¸ªè·¯ç”±ä¸­ä½¿ç”¨[state](#state)å…±äº«
* å±æ€§ä¸è¯·æ±‚æˆ–å“åº”ç›¸å…³è”ï¼Œä½¿ç”¨[decorate](#decorate)
* å±æ€§æ˜¯ä»ç°æœ‰å±æ€§æ´¾ç”Ÿçš„ï¼Œä½¿ç”¨[derive](#derive) / [resolve](#resolve)

å¦åˆ™ï¼Œæˆ‘ä»¬å»ºè®®å°†å€¼æˆ–å‡½æ•°å•ç‹¬å®šä¹‰ï¼Œè€Œä¸æ˜¯æ‰©å±•ä¸Šä¸‹æ–‡ã€‚

::: tip
å»ºè®®å°†ä¸è¯·æ±‚å’Œå“åº”ç›¸å…³çš„å±æ€§æˆ–ç»å¸¸ä½¿ç”¨çš„å‡½æ•°åˆ†é…ç»™Contextï¼Œä»¥å®ç°å…³æ³¨ç‚¹åˆ†ç¦»ã€‚
:::

## çŠ¶æ€

**çŠ¶æ€**æ˜¯ä¸€ä¸ªå…¨å±€å¯å˜å¯¹è±¡æˆ–çŠ¶æ€ï¼Œåœ¨Elysiaåº”ç”¨ç¨‹åºä¸­å…±äº«ã€‚

ä¸€æ—¦è°ƒç”¨ **state**ï¼Œå€¼å°†æ·»åŠ åˆ° **store** å±æ€§ **ä¸€æ¬¡åœ¨è°ƒç”¨æ—¶**ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å¤„ç†ç¨‹åºä¸­ä½¿ç”¨ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .state('version', 1)
    .get('/a', ({ store: { version } }) => version)
                // ^?
    .get('/b', ({ store }) => store)
    .get('/c', () => 'ä»ç„¶å¯ä»¥')
    .listen(3000)
```

### ä½•æ—¶ä½¿ç”¨

* å½“æ‚¨éœ€è¦åœ¨å¤šä¸ªè·¯ç”±ä¸­å…±äº«ä¸€ä¸ªåŸå§‹å¯å˜å€¼æ—¶
* å¦‚æœæ‚¨æƒ³ä½¿ç”¨ä¸€ä¸ªéåŸå§‹æˆ– `wrapper` å€¼æˆ–ç±»æ¥æ”¹å˜å†…éƒ¨çŠ¶æ€ï¼Œè¯·æ”¹ç”¨[decorate](#decorate)ã€‚

### å…³é”®è¦ç‚¹

* **store** æ˜¯æ•´ä¸ªElysiaåº”ç”¨ç¨‹åºçš„å•ä¸€çœŸç›¸æ¥æºçš„å…¨å±€å¯å˜å¯¹è±¡çš„è¡¨ç¤ºã€‚
* **state** æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºä¸º **store** åˆ†é…åˆå§‹å€¼ï¼Œè¯¥å€¼å¯ä»¥åœ¨åç»­è¿›è¡Œä¿®æ”¹ã€‚
* ç¡®ä¿åœ¨å¤„ç†ç¨‹åºä¸­ä½¿ç”¨ä¹‹å‰åˆ†é…ä¸€ä¸ªå€¼ã€‚

```typescript twoslash
// @errors: 2339
import { Elysia } from 'elysia'

new Elysia()
    // âŒ TypeError: counter åœ¨ store ä¸­ä¸å­˜åœ¨
    .get('/error', ({ store }) => store.counter)
    .state('counter', 0)
    // âœ… å› ä¸ºæˆ‘ä»¬ä¹‹å‰åˆ†é…äº†ä¸€ä¸ª counterï¼Œæ‰€ä»¥ç°åœ¨å¯ä»¥è®¿é—®å®ƒ
    .get('/', ({ store }) => store.counter)
```

::: tip
è¯·æ³¨æ„ï¼Œåœ¨åˆ†é…ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨çŠ¶æ€å€¼ã€‚

Elysiaä¼šè‡ªåŠ¨å°†çŠ¶æ€å€¼æ³¨å†Œåˆ°å•†åº—ä¸­ï¼Œè€Œæ— éœ€æ˜¾å¼ç±»å‹æˆ–é¢å¤–çš„TypeScriptæ³›å‹ã€‚
:::

### å¼•ç”¨å’Œå€¼ æ³¨æ„äº‹é¡¹

è¦æ”¹å˜çŠ¶æ€ï¼Œå»ºè®®ä½¿ç”¨ **å¼•ç”¨** è¿›è¡Œä¿®æ”¹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å®é™…å€¼ã€‚

åœ¨ä»JavaScriptè®¿é—®å±æ€§æ—¶ï¼Œå¦‚æœæˆ‘ä»¬å°†å¯¹è±¡å±æ€§ä¸­çš„åŸå§‹å€¼å®šä¹‰ä¸ºæ–°å€¼ï¼Œåˆ™ä¼šä¸¢å¤±å¼•ç”¨ï¼Œè¯¥å€¼å°†è¢«è§†ä¸ºæ–°çš„ç‹¬ç«‹å€¼ã€‚

ä¾‹å¦‚ï¼š

```typescript
const store = {
    counter: 0
}

store.counter++
console.log(store.counter) // âœ… 1
```

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **store.counter** æ¥è®¿é—®å’Œä¿®æ”¹å±æ€§ã€‚

ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å°† counter å®šä¹‰ä¸ºæ–°å€¼

```typescript
const store = {
    counter: 0
}

let counter = store.counter

counter++
console.log(store.counter) // âŒ 0
console.log(counter) // âœ… 1
```

ä¸€æ—¦åŸå§‹å€¼è¢«é‡æ–°å®šä¹‰ä¸ºæ–°å˜é‡ï¼Œå¼•ç”¨ **"é“¾æ¥"** å°†ä¼šä¸¢å¤±ï¼Œä»è€Œå¯¼è‡´æ„å¤–è¡Œä¸ºã€‚

è¿™ä¹Ÿé€‚ç”¨äº `store`ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå…¨å±€å¯å˜å¯¹è±¡ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .state('counter', 0)
    // âœ… ä½¿ç”¨å¼•ç”¨ï¼Œå…±äº«å€¼
    .get('/', ({ store }) => store.counter++)
    // âŒ åœ¨åŸå§‹å€¼ä¸Šåˆ›å»ºæ–°å˜é‡ï¼Œé“¾æ¥ä¸¢å¤±
    .get('/error', ({ store: { counter } }) => counter)
```

## è£…é¥°

**decorate** ç›´æ¥åœ¨è°ƒç”¨æ—¶ä¸º **Context** åˆ†é…ä¸€ä¸ªé¢å¤–çš„å±æ€§ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

class Logger {
    log(value: string) {
        console.log(value)
    }
}

new Elysia()
    .decorate('logger', new Logger())
    // âœ… ä»å‰ä¸€è¡Œå®šä¹‰
    .get('/', ({ logger }) => {
        logger.log('hi')

        return 'hi'
    })
```

### ä½•æ—¶ä½¿ç”¨

* ä¸€ä¸ªå¸¸é‡æˆ–åªè¯»å€¼å¯¹è±¡åˆ° **Context**
* éåŸå§‹å€¼æˆ–ç±»ï¼Œå¯èƒ½åŒ…å«å†…éƒ¨å¯å˜çŠ¶æ€
* é™„åŠ å‡½æ•°ã€å•ä¾‹æˆ–ä¸å¯å˜å±æ€§åˆ°æ‰€æœ‰å¤„ç†ç¨‹åºã€‚

### å…³é”®è¦ç‚¹

* ä¸ **state** ä¸åŒï¼Œè£…é¥°çš„å€¼ **ä¸åº”** è¢«æ”¹å˜ï¼Œå°½ç®¡è¿™æ˜¯å¯èƒ½çš„
* ç¡®ä¿åœ¨å¤„ç†ç¨‹åºä¸­ä½¿ç”¨ä¹‹å‰åˆ†é…ä¸€ä¸ªå€¼ã€‚

## æ´¾ç”Ÿ

###### âš ï¸ æ´¾ç”Ÿä¸å¤„ç†ç±»å‹å®Œæ•´æ€§ï¼Œæ‚¨å¯èƒ½æƒ³è¦ä½¿ç”¨ [resolve](#resolve) ä»£æ›¿ã€‚

ä» **Context** ä¸­ç°æœ‰å±æ€§ä¸­æ£€ç´¢å€¼å¹¶åˆ†é…æ–°å±æ€§ã€‚

åœ¨è¯·æ±‚å‘ç”Ÿæ—¶ **æ´¾ç”Ÿ** åœ¨è½¬æ¢ç”Ÿå‘½å‘¨æœŸä¸­åˆ†é…ï¼Œå…è®¸æˆ‘ä»¬ "æ´¾ç”Ÿ" (ä»ç°æœ‰å±æ€§åˆ›å»ºæ–°å±æ€§)ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .derive(({ headers }) => {
        const auth = headers['authorization']

        return {
            bearer: auth?.startsWith('Bearer ') ? auth.slice(7) : null
        }
    })
    .get('/', ({ bearer }) => bearer)
```

å› ä¸º **derive** åœ¨æ–°è¯·æ±‚å¼€å§‹æ—¶åˆ†é…ï¼Œ**derive** å¯ä»¥è®¿é—®è¯·æ±‚å±æ€§ï¼Œå¦‚ **headers**ã€**query**ã€**body**ï¼Œè€Œ **store** å’Œ **decorate** åˆ™æ— æ³•ã€‚

### ä½•æ—¶ä½¿ç”¨

* ä»ç°æœ‰å±æ€§ä¸­åˆ›å»ºä¸€ä¸ªæ–°å±æ€§ï¼Œè€Œæ— éœ€éªŒè¯æˆ–ç±»å‹æ£€æŸ¥
* å½“æ‚¨éœ€è¦è®¿é—®è¯·æ±‚å±æ€§ï¼Œå¦‚ **headers**ã€**query**ã€**body**ï¼Œè€Œæ— éœ€éªŒè¯

### å…³é”®è¦ç‚¹

* ä¸ **state** å’Œ **decorate** ä¸åŒï¼Œ**derive** æ˜¯åœ¨æ–°è¯·æ±‚å¼€å§‹æ—¶åˆ†é…çš„ï¼Œè€Œä¸æ˜¯åœ¨è°ƒç”¨æ—¶èµ‹å€¼ã€‚
* **derive åœ¨è½¬æ¢æ—¶è¢«è°ƒç”¨ï¼Œæˆ–è€…åœ¨éªŒè¯ä¹‹å‰** å‘ç”Ÿï¼ŒElysiaæ— æ³•å®‰å…¨ç¡®è®¤è¯·æ±‚å±æ€§çš„ç±»å‹ï¼Œå¯¼è‡´å…¶ç»“æœä¸º **unknown**ã€‚å¦‚æœæ‚¨æƒ³ä»ç±»å‹è¯·æ±‚å±æ€§ä¸­åˆ†é…æ–°å€¼ï¼Œæ‚¨å¯èƒ½æƒ³ä½¿ç”¨ [resolve](#resolve) ä»£æ›¿ã€‚

## è§£æ

ç±»ä¼¼äº[derive](#derive)ï¼Œä½†ç¡®ä¿ç±»å‹å®Œæ•´æ€§ã€‚

è§£æå…è®¸æˆ‘ä»¬å°†æ–°å±æ€§åˆ†é…åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚

è§£æåœ¨ **beforeHandle** ç”Ÿå‘½å‘¨æœŸæˆ– **after validation** é˜¶æ®µè¢«è°ƒç”¨ï¼Œå…è®¸æˆ‘ä»¬å®‰å…¨åœ° **è§£æ** è¯·æ±‚å±æ€§ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.guard({
		headers: t.Object({
			bearer: t.String({
				pattern: '^Bearer .+$'
			})
		})
	})
	.resolve(({ headers }) => {
		return {
			bearer: headers.bearer.slice(7)
		}
	})
	.get('/', ({ bearer }) => bearer)
```

### ä½•æ—¶ä½¿ç”¨

* åœ¨å…·æœ‰ç±»å‹å®Œæ•´æ€§çš„æƒ…å†µä¸‹ï¼Œä»ç°æœ‰å±æ€§ä¸­åˆ›å»ºæ–°å±æ€§ï¼ˆè¿›è¡Œç±»å‹æ£€æŸ¥ï¼‰
* å½“æ‚¨éœ€è¦è®¿é—®è¯·æ±‚å±æ€§ï¼Œå¦‚ **headers**ã€**query**ã€**body**ï¼Œå¹¶ä¸”éœ€è¦è¿›è¡ŒéªŒè¯æ—¶

### å…³é”®è¦ç‚¹

* **resolve åœ¨ beforeHandle é˜¶æ®µæˆ–éªŒè¯åè¢«è°ƒç”¨**ã€‚Elysiaå¯ä»¥å®‰å…¨ç¡®è®¤è¯·æ±‚å±æ€§çš„ç±»å‹å¹¶å°†å…¶è§†ä¸º **typed**ã€‚

### æ¥è‡ªè§£æ/æ´¾ç”Ÿçš„é”™è¯¯

ç”±äºè§£æå’Œæ´¾ç”ŸåŸºäº **transform** å’Œ **beforeHandle** ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä»¬å¯ä»¥ä»è§£æå’Œæ´¾ç”Ÿä¸­è¿”å›é”™è¯¯ã€‚å¦‚æœä» **derive** è¿”å›é”™è¯¯ï¼ŒElysiaå°†æå‰é€€å‡ºå¹¶å°†é”™è¯¯ä½œä¸ºå“åº”è¿”å›ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .derive(({ headers, status }) => {
        const auth = headers['authorization']

        if(!auth) return status(400)

        return {
            bearer: auth?.startsWith('Bearer ') ? auth.slice(7) : null
        }
    })
    .get('/', ({ bearer }) => bearer)
```

## æ¨¡å¼ é«˜çº§æ¦‚å¿µ

**state**ï¼Œ**decorate** ä¸ºå‘Contextåˆ†é…å±æ€§æä¾›äº†ç±»ä¼¼APIæ¨¡å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

* é”®-å€¼
* å¯¹è±¡
* é‡æ˜ å°„

å…¶ä¸­ **derive** åªèƒ½ä¸ **remap** ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸ºå®ƒä¾èµ–äºç°æœ‰å€¼ã€‚

### é”®-å€¼

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ **state** å’Œ **decorate** é€šè¿‡é”®å€¼æ¨¡å¼åˆ†é…ä¸€ä¸ªå€¼ã€‚

```typescript
import { Elysia } from 'elysia'

class Logger {
    log(value: string) {
        console.log(value)
    }
}

new Elysia()
    .state('counter', 0)
    .decorate('logger', new Logger())
```

è¿™ç§æ¨¡å¼éå¸¸é€‚åˆè®¾ç½®å•ä¸ªå±æ€§æ—¶çš„å¯è¯»æ€§ã€‚

### å¯¹è±¡

åŒæ—¶åˆ†é…å¤šä¸ªå±æ€§åœ¨å•ä¸€åˆ†é…çš„å¯¹è±¡ä¸­æ›´å¥½åœ°åŒ…å«ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .decorate({
        logger: new Logger(),
        trace: new Trace(),
        telemetry: new Telemetry()
    })
```

å¯¹è±¡æä¾›äº†ä¸€ä¸ªè¾ƒå°‘é‡å¤çš„APIç”¨äºè®¾ç½®å¤šä¸ªå€¼ã€‚

### é‡æ˜ å°„

é‡æ˜ å°„æ˜¯ä¸€ä¸ªå‡½æ•°é‡æ–°åˆ†é…ã€‚

å…è®¸æˆ‘ä»¬ä»ç°æœ‰å€¼åˆ›å»ºä¸€ä¸ªæ–°å€¼ï¼Œä¾‹å¦‚é‡å‘½åæˆ–ç§»é™¤ä¸€ä¸ªå±æ€§ã€‚

é€šè¿‡æä¾›ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡æ¥é‡æ–°åˆ†é…è¯¥å€¼ã€‚

```typescript twoslash
// @errors: 2339
import { Elysia } from 'elysia'

new Elysia()
    .state('counter', 0)
    .state('version', 1)
    .state(({ version, ...store }) => ({
        ...store,
        elysiaVersion: 1
    }))
    // âœ… ä»çŠ¶æ€é‡æ˜ å°„åˆ›å»º
    .get('/elysia-version', ({ store }) => store.elysiaVersion)
    // âŒ ä»çŠ¶æ€é‡æ˜ å°„ä¸­æ’é™¤
    .get('/version', ({ store }) => store.version)
```

ä½¿ç”¨çŠ¶æ€é‡æ˜ å°„ä»ç°æœ‰å€¼åˆ›å»ºæ–°çš„åˆå§‹å€¼æ˜¯ä¸ªå¥½ä¸»æ„ã€‚

ä½†æ˜¯ï¼Œé‡è¦çš„æ˜¯è¦æ³¨æ„Elysiaå¹¶æœªä»è¿™ç§æ–¹æ³•ä¸­æä¾›ååº”æ€§ï¼Œå› ä¸ºé‡æ˜ å°„åªæ˜¯åˆ†é…äº†åˆå§‹å€¼ã€‚

::: tip
ä½¿ç”¨é‡æ˜ å°„ï¼ŒElysiaä¼šå°†è¿”å›çš„å¯¹è±¡è§†ä¸ºæ–°å±æ€§ï¼Œä»è€Œç§»é™¤å¯¹è±¡ä¸­ç¼ºå¤±çš„ä»»ä½•å±æ€§ã€‚
:::

## é™„åŠ  é«˜çº§æ¦‚å¿µ

ä¸ºæä¾›æ›´æµç•…çš„ä½“éªŒï¼Œä¸€äº›æ’ä»¶å¯èƒ½æœ‰å¾ˆå¤šå±æ€§å€¼ï¼Œè¿™ä½¿å¾—é€ä¸ªé‡æ˜ å°„å˜å¾—ç¹çã€‚

**é™„åŠ ** å‡½æ•°ç”± **prefix** å’Œ **suffix** ç»„æˆï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿé‡æ˜ å°„å®ä¾‹çš„æ‰€æœ‰å±æ€§ã€‚

```ts twoslash
import { Elysia } from 'elysia'

const setup = new Elysia({ name: 'setup' })
    .decorate({
        argon: 'a',
        boron: 'b',
        carbon: 'c'
    })

const app = new Elysia()
    .use(setup)
    .prefix('decorator', 'setup')
    .get('/', ({ setupCarbon, ...rest }) => setupCarbon)
```

è¿™ä½¿æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°æ‰¹é‡é‡æ˜ å°„æ’ä»¶çš„å±æ€§ï¼Œé˜²æ­¢æ’ä»¶åç§°å†²çªã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ**é™„åŠ ** å°†è‡ªåŠ¨å¤„ç†è¿è¡Œæ—¶ã€ç±»å‹çº§åˆ«çš„ä»£ç ï¼Œå°†å±æ€§é‡æ˜ å°„ä¸ºå‘½åçº¦å®šçš„é©¼å³°å¼å‘½åã€‚

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é‡æ˜ å°„æ’ä»¶çš„ `all` å±æ€§ï¼š

```ts twoslash
import { Elysia } from 'elysia'

const setup = new Elysia({ name: 'setup' })
    .decorate({
        argon: 'a',
        boron: 'b',
        carbon: 'c'
    })

const app = new Elysia()
    .use(setup)
    .prefix('all', 'setup') // [!code ++]
    .get('/', ({ setupCarbon, ...rest }) => setupCarbon)
```

---

---
url: 'https://elysiajs.com/tutorial/getting-started/plugin.md'
---

# æ’ä»¶

æ¯ä¸ª Elysia å®ä¾‹éƒ½å¯ä»¥é€šè¿‡ `use` æ–¹æ³•ä¸å…¶ä»–å®ä¾‹è¿›è¡Œå³æ’å³ç”¨ã€‚

```typescript
import { Elysia } from 'elysia'

const user = new Elysia()
	.get('/profile', 'ç”¨æˆ·èµ„æ–™')
	.get('/settings', 'ç”¨æˆ·è®¾ç½®')

new Elysia()
	.use(user) // [!code ++]
	.get('/', 'é¦–é¡µ')
	.listen(3000)
```

ä¸€æ—¦åº”ç”¨ï¼Œæ¥è‡ª `user` å®ä¾‹çš„æ‰€æœ‰è·¯ç”±å°†åœ¨ `app` å®ä¾‹ä¸­å¯ç”¨ã€‚

### æ’ä»¶é…ç½®

æ‚¨è¿˜å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¥å—å‚æ•°çš„æ’ä»¶ï¼Œå¹¶è¿”å›ä¸€ä¸ª Elysia å®ä¾‹ï¼Œä»¥åˆ¶ä½œä¸€ä¸ªæ›´åŠ¨æ€çš„æ’ä»¶ã€‚

```typescript
import { Elysia } from 'elysia'

const user = ({ log = false }) => new Elysia() // [!code ++]
	.onBeforeHandle(({ request }) => {
		if (log) console.log(request)
	})
	.get('/profile', 'ç”¨æˆ·èµ„æ–™')
	.get('/settings', 'ç”¨æˆ·è®¾ç½®')

new Elysia()
	.use(user({ log: true })) // [!code ++]
	.get('/', 'é¦–é¡µ')
	.listen(3000)
```

It's also recommended that you should also read about [Key Concept: Dependency](/key-concept#dependency) to understand how Elysia handles dependencies between plugins.

## ç»ƒä¹ 

è®©æˆ‘ä»¬å°† `user` å®ä¾‹åº”ç”¨äº `app` å®ä¾‹ã€‚

\<template #answer>

ä¸ä¸Šè¿°ç¤ºä¾‹ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `use` æ–¹æ³•å°† `user` å®ä¾‹æ’å…¥åˆ° `app` å®ä¾‹ä¸­ã€‚

```typescript
import { Elysia } from 'elysia'

const user = new Elysia()
	.get('/profile', 'ç”¨æˆ·èµ„æ–™')
	.get('/settings', 'ç”¨æˆ·è®¾ç½®')

const app = new Elysia()
	.use(user) // [!code ++]
	.get('/', 'é¦–é¡µ')
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/essential/plugin.md'
---

# æ’ä»¶&#x20;

æ’ä»¶æ˜¯ä¸€ç§å°†åŠŸèƒ½è§£è€¦æˆæ›´å°éƒ¨åˆ†çš„æ¨¡å¼ã€‚ä¸ºæˆ‘ä»¬çš„ Web æœåŠ¡å™¨åˆ›å»ºå¯é‡ç”¨çš„ç»„ä»¶ã€‚

è¦åˆ›å»ºä¸€ä¸ªæ’ä»¶ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å®ä¾‹ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

const plugin = new Elysia()
    .decorate('plugin', 'hi')
    .get('/plugin', ({ plugin }) => plugin)

const app = new Elysia()
    .use(plugin)
    .get('/', ({ plugin }) => plugin)
               // ^?
    .listen(3000)
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å®ä¾‹ä¼ é€’ç»™ **Elysia.use** æ¥ä½¿ç”¨æ’ä»¶ã€‚

æ’ä»¶å°†ç»§æ‰¿æ’ä»¶å®ä¾‹çš„æ‰€æœ‰å±æ€§ï¼Œå¦‚ `state`ã€`decorate`ï¼Œä½†**ä¸ä¼šç»§æ‰¿æ’ä»¶ç”Ÿå‘½å‘¨æœŸ**ï¼Œå› ä¸ºå®ƒé»˜è®¤æ˜¯[éš”ç¦»çš„](#scope)ï¼ˆå°†åœ¨ä¸‹ä¸€èŠ‚ä¸­æåˆ° â†“ï¼‰ã€‚

Elysia ä¹Ÿä¼šè‡ªåŠ¨å¤„ç†ç±»å‹æ¨æ–­ã€‚

## ä½œç”¨åŸŸ&#x20;

Elysia çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•**åªå¯¹å…¶è‡ªèº«å®ä¾‹å°è£…**ã€‚

è¿™æ„å‘³ç€å¦‚æœä½ åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå®ƒä¸ä¼šä¸å…¶ä»–å®ä¾‹å…±äº«ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚

```ts
import { Elysia } from 'elysia'

const profile = new Elysia()
	.onBeforeHandle(({ cookie }) => {
		throwIfNotSignIn(cookie)
	})
	.get('/profile', () => 'Hi there!')

const app = new Elysia()
	.use(profile)
	// âš ï¸ æ­¤å¤„ä¸ä¼šæœ‰ç™»å½•æ£€æŸ¥
	.patch('/rename', ({ body }) => updateProfile(body))
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œ`isSignIn` æ£€æŸ¥åªä¼šåº”ç”¨äº `profile`ï¼Œè€Œä¸ä¼šåº”ç”¨äº `app`ã€‚

> å°è¯•åœ¨ URL è¾“å…¥æ¡†ä¸­åˆ‡æ¢åˆ° **/rename** æŸ¥çœ‹ç»“æœ

**Elysia é»˜è®¤éš”ç¦»ç”Ÿå‘½å‘¨æœŸ**ï¼Œé™¤éæ˜¾å¼å£°æ˜ã€‚è¿™ç±»ä¼¼äºJavaScriptä¸­çš„**export**ï¼Œä½ éœ€è¦å¯¼å‡ºå‡½æ•°æ‰èƒ½è®©å…¶åœ¨æ¨¡å—å¤–éƒ¨å¯ç”¨ã€‚

è¦å°†ç”Ÿå‘½å‘¨æœŸ\*\*â€œå¯¼å‡ºâ€\*\*åˆ°å…¶ä»–å®ä¾‹ï¼Œå¿…é¡»æŒ‡å®šä½œç”¨åŸŸã€‚

```ts
import { Elysia } from 'elysia'

const profile = new Elysia()
	.onBeforeHandle(
		{ as: 'global' }, // [!code ++]
		({ cookie }) => {
			throwIfNotSignIn(cookie)
		}
	)
	.get('/profile', () => 'Hi there!')

const app = new Elysia()
	.use(profile)
	// è¿™å°†è¿›è¡Œç™»å½•æ£€æŸ¥
	.patch('/rename', ({ body }) => updateProfile(body))
```

å°†ç”Ÿå‘½å‘¨æœŸä½œç”¨åŸŸè®¾ç½®ä¸º\*\*"global"**å°†æŠŠç”Ÿå‘½å‘¨æœŸå¯¼å‡ºè‡³**æ‰€æœ‰å®ä¾‹\*\*ã€‚

### ä½œç”¨åŸŸçº§åˆ«

Elysia æœ‰ä¸‰ç§ä½œç”¨åŸŸçº§åˆ«ï¼š

ä½œç”¨åŸŸç±»å‹å¦‚ä¸‹ï¼š

1. **local**ï¼ˆé»˜è®¤ï¼‰ - ä»…åº”ç”¨äºå½“å‰å®ä¾‹åŠå…¶å­å®ä¾‹
2. **scoped** - åº”ç”¨äºçˆ¶å®ä¾‹ã€å½“å‰å®ä¾‹åŠå­å®ä¾‹
3. **global** - åº”ç”¨äºæ‰€æœ‰ä½¿ç”¨æ­¤æ’ä»¶çš„å®ä¾‹ï¼ˆæ‰€æœ‰çˆ¶çº§ã€å½“å‰å®ä¾‹åŠå­å®ä¾‹ï¼‰

é€šè¿‡ä»¥ä¸‹ç¤ºä¾‹æŸ¥çœ‹æ¯ç§ä½œç”¨åŸŸç±»å‹çš„è¡Œä¸ºï¼š

```typescript
import { Elysia } from 'elysia'


const child = new Elysia()
    .get('/child', 'hi')

const current = new Elysia()
	// ? ç±»å‹å€¼åŸºäºä¸‹è¡¨
    .onBeforeHandle({ as: 'local' }, () => { // [!code ++]
        console.log('hi')
    })
    .use(child)
    .get('/current', 'hi')

const parent = new Elysia()
    .use(current)
    .get('/parent', 'hi')

const main = new Elysia()
    .use(parent)
    .get('/main', 'hi')
```

æ ¹æ® `type` å€¼çš„ä¸åŒï¼Œç»“æœåº”å¦‚ä¸‹æ‰€ç¤ºï¼š

| type       | child | current | parent | main |
| ---------- | ----- | ------- | ------ | ---- |
| local      | âœ…    | âœ…      | âŒ      | âŒ   |
| scoped     | âœ…    | âœ…      | âœ…      | âŒ   |
| global     | âœ…    | âœ…      | âœ…      | âœ…   |

### å­å®ä¾‹

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ’ä»¶åªä¼š**å°†é’©å­åº”ç”¨äºè‡ªèº«åŠå…¶å­å®ä¾‹**ã€‚

å¦‚æœé’©å­æ³¨å†Œåœ¨ä¸€ä¸ªæ’ä»¶ä¸­ï¼Œç»§æ‰¿è¯¥æ’ä»¶çš„å®ä¾‹**ä¸ä¼š**ç»§æ‰¿è¯¥é’©å­å’Œæ¨¡å¼ã€‚

```typescript
import { Elysia } from 'elysia'

const plugin = new Elysia()
    .onBeforeHandle(() => {
        console.log('hi')
    })
    .get('/child', 'log hi')

const main = new Elysia()
    .use(plugin)
    .get('/parent', 'not log hi')
```

è¦å°†é’©å­åº”ç”¨åˆ°å…¨å±€ï¼Œéœ€æŒ‡å®šé’©å­ä½œç”¨åŸŸä¸º globalã€‚

```typescript
import { Elysia } from 'elysia'

const plugin = new Elysia()
    .onBeforeHandle(() => {
        return 'hi'
    })
    .get('/child', 'child')
    .as('scoped')

const main = new Elysia()
    .use(plugin)
    .get('/parent', 'parent')
```

## é…ç½®

ä¸ºäº†è®©æ’ä»¶æ›´æœ‰ç”¨ï¼Œå»ºè®®é€šè¿‡é…ç½®æ”¯æŒè‡ªå®šä¹‰ã€‚

ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªæ¥å—å‚æ•°çš„å‡½æ•°ï¼Œè¿™äº›å‚æ•°èƒ½å¤Ÿå½±å“æ’ä»¶è¡Œä¸ºï¼Œä»è€Œæå‡å¤ç”¨æ€§ã€‚

```typescript
import { Elysia } from 'elysia'

const version = (version = 1) => new Elysia()
        .get('/version', version)

const app = new Elysia()
    .use(version(1))
    .listen(3000)
```

### åŠŸèƒ½å›è°ƒ

æ¨èå®šä¹‰ä¸€ä¸ªæ–°çš„æ’ä»¶å®ä¾‹ï¼Œè€Œéä½¿ç”¨åŠŸèƒ½å›è°ƒã€‚

å‡½æ•°å¼å›è°ƒå…è®¸æˆ‘ä»¬è®¿é—®ä¸»å®ä¾‹å·²æœ‰å±æ€§ï¼Œä¾‹å¦‚æ£€æµ‹æŸäº›è·¯ç”±æˆ–çŠ¶æ€æ˜¯å¦å­˜åœ¨ï¼Œä½†æ­£ç¡®å¤„ç†å°è£…å’Œä½œç”¨åŸŸè¾ƒå›°éš¾ã€‚

å‡½æ•°å¼å›è°ƒæ˜¯æŒ‡åˆ›å»ºä¸€ä¸ªæ¥å— Elysia å®ä¾‹ä½œä¸ºå‚æ•°çš„å‡½æ•°ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

const plugin = (app: Elysia) => app
    .state('counter', 0)
    .get('/plugin', () => 'Hi')

const app = new Elysia()
    .use(plugin)
    .get('/counter', ({ store: { counter } }) => counter)
    .listen(3000)
```

ä¸€æ—¦ä¼ é€’ç»™ `Elysia.use`ï¼Œå‡½æ•°å¼å›è°ƒçš„è¡Œä¸ºç±»ä¼¼äºæ™®é€šæ’ä»¶ï¼Œåªä¸è¿‡å…¶å±æ€§ç›´æ¥èµ‹å€¼ç»™ä¸»å®ä¾‹ã€‚

::: tip
ä½ æ— éœ€æ‹…å¿ƒå‡½æ•°å›è°ƒä¸æ–°å»ºå®ä¾‹é—´çš„æ€§èƒ½å·®å¼‚ã€‚

Elysia èƒ½åœ¨å‡ æ¯«ç§’å†…åˆ›å»º 1 ä¸‡ä¸ªå®ä¾‹ï¼Œä¸”æ–°å®ä¾‹çš„ç±»å‹æ¨æ–­æ€§èƒ½ä¼˜äºå‡½æ•°å›è°ƒã€‚
:::

## æ’ä»¶å»é‡

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia ä¼šæ³¨å†Œä»»æ„æ’ä»¶å¹¶å¤„ç†ç±»å‹å®šä¹‰ã€‚

æŸäº›æ’ä»¶å¯èƒ½å› éœ€è¦å¤šæ¬¡ä½¿ç”¨ä»¥å®ç°ç±»å‹æ¨æ–­ï¼Œå¯¼è‡´åˆå§‹åŒ–å€¼æˆ–è·¯ç”±é‡å¤è®¾ç½®ã€‚

Elysia é€šè¿‡ä½¿ç”¨ **name** å’Œ **å¯é€‰ç§å­(seed)** æ¥åŒºåˆ†å®ä¾‹ï¼Œé¿å…é‡å¤æ³¨å†Œï¼š

```typescript
import { Elysia } from 'elysia'

const plugin = <T extends string>(config: { prefix: T }) =>
    new Elysia({
        name: 'my-plugin', // [!code ++]
        seed: config, // [!code ++]
    })
    .get(`${config.prefix}/hi`, () => 'Hi')

const app = new Elysia()
    .use(
        plugin({
            prefix: '/v2'
        })
    )
    .listen(3000)
```

Elysia ä½¿ç”¨ **name** å’Œ **seed** ç”Ÿæˆæ ¡éªŒå’Œç”¨ä»¥åˆ¤æ–­å®ä¾‹æ˜¯å¦å·²æ³¨å†Œï¼Œè‹¥å·²æ³¨å†Œåˆ™è·³è¿‡æ’ä»¶æ³¨å†Œã€‚

è‹¥æœªæä¾›ç§å­ï¼ŒElysia åªåˆ¤æ–­ **name**ã€‚è¿™æ„å‘³ç€å³ä½¿å¤šæ¬¡æ³¨å†Œæ’ä»¶ï¼Œä¹Ÿåªä¼šæ³¨å†Œä¸€æ¬¡ã€‚

```typescript
import { Elysia } from 'elysia'

const plugin = new Elysia({ name: 'plugin' })

const app = new Elysia()
    .use(plugin)
    .use(plugin)
    .use(plugin)
    .use(plugin)
    .listen(3000)
```

è¿™è®© Elysia é€šè¿‡å¤ç”¨å·²æ³¨å†Œçš„æ’ä»¶è€Œä¸æ˜¯é‡å¤å¤„ç†æ’ä»¶ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚

::: tip
ç§å­å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼Œä»å­—ç¬¦ä¸²åˆ°å¤æ‚å¯¹è±¡æˆ–ç±»ã€‚

è‹¥ç§å­ä¸ºç±»ï¼ŒElysia ä¼šå°è¯•è°ƒç”¨å…¶ `.toString` æ–¹æ³•ç”Ÿæˆæ ¡éªŒå’Œã€‚
:::

### æœåŠ¡å®šä½å™¨

å½“ä½ å°†å¸¦çŠ¶æ€æˆ–è£…é¥°å™¨çš„æ’ä»¶åº”ç”¨äºå®ä¾‹æ—¶ï¼Œè¯¥å®ä¾‹å°†è·å¾—ç±»å‹å®‰å…¨ã€‚

ä½†è‹¥ä¸å°†æ’ä»¶åº”ç”¨äºå¦ä¸€ä¸ªå®ä¾‹ï¼Œåˆ™æ— æ³•æ¨æ–­ç±»å‹ã€‚

```typescript twoslash
// @errors: 2339
import { Elysia } from 'elysia'

const child = new Elysia()
    // âŒ ç¼ºå°‘ 'a'
    .get('/', ({ a }) => a)

const main = new Elysia()
    .decorate('a', 'a')
    .use(child)
```

ä¸ºè§£å†³è¯¥é—®é¢˜ï¼ŒElysia å¼•å…¥äº† **æœåŠ¡å®šä½å™¨** æ¨¡å¼ã€‚

Elysia ä¼šå¯»æ‰¾æ’ä»¶çš„æ ¡éªŒå’Œä»¥è·å–å€¼ï¼Œæˆ–è€…æ³¨å†Œæ–°çš„å€¼ï¼Œå¹¶æ ¹æ®æ’ä»¶æ¨æ–­ç±»å‹ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»æä¾›æ’ä»¶å¼•ç”¨ï¼Œä»¥ä¾¿ Elysia æ‰¾åˆ°æœåŠ¡ï¼Œä»è€Œæ·»åŠ ç±»å‹å®‰å…¨ã€‚

```typescript twoslash
// @errors: 2339
import { Elysia } from 'elysia'

const setup = new Elysia({ name: 'setup' })
    .decorate('a', 'a')

// æ²¡æœ‰ä½¿ç”¨ 'setup'ï¼Œç±»å‹ä¼šç¼ºå¤±
const error = new Elysia()
    .get('/', ({ a }) => a)

// ä½¿ç”¨ `setup`ï¼Œç±»å‹å¯ä»¥æ¨æ–­
const child = new Elysia()
    .use(setup) // [!code ++]
    .get('/', ({ a }) => a)
    //           ^?

const main = new Elysia()
    .use(child)
```

## é˜²æŠ¤&#x20;

é˜²æŠ¤å…è®¸æˆ‘ä»¬å°†é’©å­å’Œæ¨¡å¼ä¸€æ¬¡æ€§åº”ç”¨äºå¤šä¸ªè·¯ç”±ã€‚

```typescript twoslash
const signUp = <T>(a: T) => a
const signIn = <T>(a: T) => a
const isUserExists = <T>(a: T) => a
// ---cut---
import { Elysia, t } from 'elysia'

new Elysia()
    .guard(
        { // [!code ++]
            body: t.Object({ // [!code ++]
                username: t.String(), // [!code ++]
                password: t.String() // [!code ++]
            }) // [!code ++]
        }, // [!code ++]
        (app) => // [!code ++]
            app
                .post('/sign-up', ({ body }) => signUp(body))
                .post('/sign-in', ({ body }) => signIn(body), {
                                                     // ^?
                    beforeHandle: isUserExists
                })
    )
    .get('/', 'hi')
    .listen(3000)
```

æ­¤ä»£ç ä¸º `/sign-in` å’Œ `/sign-up` åº”ç”¨äº† `body` éªŒè¯ï¼Œè€Œ `/` åˆ™æ²¡æœ‰ã€‚

è·¯ç”±éªŒè¯æ€»ç»“å¦‚ä¸‹ï¼š
| è·¯å¾„ | æœ‰éªŒè¯ |
| ------- | ------------- |
| /sign-up | âœ… |
| /sign-in | âœ… |
| / | âŒ |

é˜²æŠ¤æ¥å—ä¸å†…è”é’©å­ç›¸åŒçš„å‚æ•°ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ä½ å¯ä»¥åœ¨ä½œç”¨åŸŸå†…å°†é’©å­åº”ç”¨äºå¤šä¸ªè·¯ç”±ã€‚

è¿™æ„å‘³ç€ä¸Šè¿°ä»£ç å¯ç­‰åŒäºï¼š

```typescript twoslash
const signUp = <T>(a: T) => a
const signIn = <T>(a: T) => a
const isUserExists = (a: any) => a
// ---cut---
import { Elysia, t } from 'elysia'

new Elysia()
    .post('/sign-up', ({ body }) => signUp(body), {
        body: t.Object({
            username: t.String(),
            password: t.String()
        })
    })
    .post('/sign-in', ({ body }) => body, {
        beforeHandle: isUserExists,
        body: t.Object({
            username: t.String(),
            password: t.String()
        })
    })
    .get('/', () => 'hi')
    .listen(3000)
```

### åˆ†ç»„é˜²æŠ¤

é€šè¿‡æä¾›ä¸‰ä¸ªå‚æ•°ç»™ group å¯ä»¥ä½¿ç”¨å‰ç¼€ï¼š

1. å‰ç¼€ - è·¯ç”±å‰ç¼€
2. é˜²æŠ¤ - æ¨¡å¼
3. èŒƒå›´ - Elysia åº”ç”¨å›è°ƒ

é˜²æŠ¤åº”ç”¨çš„ API å’Œå†…è”ç”¨æ³•ç›¸åŒï¼Œåªæ˜¯ä½œç”¨äºç¬¬äºŒä¸ªå‚æ•°ï¼Œè€Œä¸æ˜¯å°†åˆ†ç»„å’Œé˜²æŠ¤åµŒå¥—ã€‚

ç¤ºä¾‹ï¼š

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
    .group('/v1', (app) =>
        app.guard(
            {
                body: t.Literal('Rikuhachima Aru')
            },
            (app) => app.post('/student', ({ body }) => body)
                                            // ^?
        )
    )
    .listen(3000)
```

é˜²æŠ¤å’Œåˆ†ç»„åˆå¹¶å†™æ³•ï¼š

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
    .group(
        '/v1',
        (app) => app.guard( // [!code --]
        {
            body: t.Literal('Rikuhachima Aru')
        },
        (app) => app.post('/student', ({ body }) => body)
        ) // [!code --]
    )
    .listen(3000)
```

ç­‰ä»·äºå¦‚ä¸‹è¯­æ³•ï¼š

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
    .group(
        '/v1',
        {
            body: t.Literal('Rikuhachima Aru')
        },
        (app) => app.post('/student', ({ body }) => body)
                                       // ^?
    )
    .listen(3000)
```

## ä½œç”¨åŸŸè½¬æ¢ é«˜çº§æ¦‚å¿µ

è‹¥è¦å°†é’©å­åº”ç”¨äºçˆ¶å®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ï¼š

1. [å†…è” as](#inline-as) ä»…åº”ç”¨äºå•ä¸ªé’©å­
2. [é˜²æŠ¤ as](#guard-as) åº”ç”¨äºé˜²æŠ¤ä¸­çš„æ‰€æœ‰é’©å­
3. [å®ä¾‹ as](#instance-as) åº”ç”¨äºå®ä¾‹ä¸­çš„æ‰€æœ‰é’©å­

### å†…è”é’©å­

æ¯ä¸ªäº‹ä»¶ç›‘å¬å™¨éƒ½æ¥å— `as` å‚æ•°ï¼Œç”¨ä»¥æŒ‡å®šé’©å­çš„ä½œç”¨åŸŸã€‚

```typescript twoslash
import { Elysia } from 'elysia'

const plugin = new Elysia()
    .derive({ as: 'scoped' }, () => { // [!code ++]
        return { hi: 'ok' }
    })
    .get('/child', ({ hi }) => hi)

const main = new Elysia()
    .use(plugin)
    // âœ… å¯ä»¥è®¿é—® hi
    .get('/parent', ({ hi }) => hi)
```

ä½†æ­¤æ–¹æ³•åªé€‚ç”¨äºå•ä¸ªé’©å­ï¼Œä¸”å¯èƒ½ä¸é€‚åˆå¤šä¸ªé’©å­ã€‚

### é˜²æŠ¤ as

æ¯ä¸ªäº‹ä»¶ç›‘å¬å™¨æ¥å— `as` å‚æ•°ï¼ŒæŒ‡å®šé’©å­ä½œç”¨åŸŸã€‚

```typescript
import { Elysia, t } from 'elysia'

const plugin = new Elysia()
	.guard({
		as: 'scoped', // [!code ++]
		response: t.String(),
		beforeHandle() {
			console.log('ok')
		}
	})
    .get('/child', 'ok')

const main = new Elysia()
    .use(plugin)
    .get('/parent', 'hello')
```

é˜²æŠ¤å…è®¸æˆ‘ä»¬ä¸€æ¬¡æ€§å°† `schema` å’Œ `hook` åº”ç”¨äºå¤šä¸ªè·¯ç”±ï¼Œå¹¶ä¸”å¯ä»¥æŒ‡å®šä½œç”¨åŸŸã€‚

ä½†å®ƒä¸æ”¯æŒ `derive` å’Œ `resolve` æ–¹æ³•ã€‚

### å®ä¾‹ as

`as` ä¼šè¯»å–å½“å‰å®ä¾‹æ‰€æœ‰é’©å­å’Œæ¨¡å¼çš„ä½œç”¨åŸŸï¼Œå¹¶å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

const plugin = new Elysia()
    .derive(() => {
        return { hi: 'ok' }
    })
    .get('/child', ({ hi }) => hi)
    .as('scoped') // [!code ++]

const main = new Elysia()
    .use(plugin)
    // âœ… å¯ä»¥è®¿é—® hi
    .get('/parent', ({ hi }) => hi)
```

æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›å°†æ’ä»¶é‡æ–°åº”ç”¨äºçˆ¶å®ä¾‹ï¼Œä½†å—é™äº `scoped` æœºåˆ¶ä»…é™ä¸€ä¸ªçˆ¶çº§ã€‚

è¦å°†å…¶åº”ç”¨åˆ°çˆ¶å®ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦**æå‡ä½œç”¨åŸŸåˆ°çˆ¶å®ä¾‹**ï¼Œè€Œ `as` æ˜¯å®ç°æ­¤ç›®çš„çš„ç»ä½³æ–¹å¼ã€‚

è¿™æ„å‘³ç€å¦‚æœä½ æœ‰ä¸€ä¸ª `local` èŒƒå›´ï¼Œæƒ³è¦åº”ç”¨åˆ°çˆ¶å®ä¾‹ï¼Œä½ å¯ä»¥ç”¨ `as('scoped')` æ¥æå‡å®ƒã€‚

```typescript twoslash
// @errors: 2304 2345
import { Elysia, t } from 'elysia'

const plugin = new Elysia()
	.guard({
		response: t.String()
	})
	.onBeforeHandle(() => { console.log('called') })
	.get('/ok', () => 'ok')
	.get('/not-ok', () => 1)
	.as('scoped') // [!code ++]

const instance = new Elysia()
	.use(plugin)
	.get('/no-ok-parent', () => 2)
	.as('scoped') // [!code ++]

const parent = new Elysia()
	.use(instance)
	// è¿™é‡Œå°†æŠ¥é”™ï¼Œå› ä¸º `scoped` è¢«æå‡åˆ°çˆ¶çº§
	.get('/ok', () => 3)
```

## å»¶è¿ŸåŠ è½½

æ¨¡å—é»˜è®¤æ˜¯ç«‹å³åŠ è½½çš„ã€‚

Elysia ä¼šç¡®ä¿æ‰€æœ‰æ¨¡å—åœ¨æœåŠ¡å™¨å¯åŠ¨ä¹‹å‰è¢«æ³¨å†Œã€‚

ç„¶è€Œï¼Œæœ‰äº›æ¨¡å—è®¡ç®—å¼€é”€å¤§æˆ–é˜»å¡ï¼Œå¯¼è‡´æœåŠ¡å™¨å¯åŠ¨å˜æ…¢ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒElysia å…è®¸ä½ æä¾›å¼‚æ­¥æ’ä»¶ï¼Œä»¥å…é˜»å¡æœåŠ¡å™¨å¯åŠ¨ã€‚

### å»¶è¿Ÿæ¨¡å—

å»¶è¿Ÿæ¨¡å—æ˜¯ä¸€ä¸ªå¼‚æ­¥æ’ä»¶ï¼ŒæœåŠ¡å™¨å¯åŠ¨åæ‰æ³¨å†Œã€‚

```typescript
// plugin.ts
import { Elysia, file } from 'elysia'
import { loadAllFiles } from './files'

export const loadStatic = async (app: Elysia) => {
    const files = await loadAllFiles()

    files.forEach((asset) => app
        .get(asset, file(file))
    )

    return app
}
```

åœ¨ä¸»æ–‡ä»¶ä¸­ï¼š

```typescript
import { Elysia } from 'elysia'
import { loadStatic } from './plugin'

const app = new Elysia()
    .use(loadStatic)
```

### å»¶è¿ŸåŠ è½½æ¨¡å—

ä¸å¼‚æ­¥æ’ä»¶ç±»ä¼¼ï¼Œå»¶è¿ŸåŠ è½½æ¨¡å—ä¼šåœ¨æœåŠ¡å™¨å¯åŠ¨åæ³¨å†Œã€‚

å»¶è¿ŸåŠ è½½æ¨¡å—å¯ä»¥æ˜¯åŒæ­¥æˆ–å¼‚æ­¥å‡½æ•°ï¼Œåªè¦é€šè¿‡ `import` ä½¿ç”¨ï¼Œæ¨¡å—å°±ä¼šå»¶è¿ŸåŠ è½½ã€‚

```typescript
import { Elysia } from 'elysia'

const app = new Elysia()
    .use(import('./plugin'))
```

å¯¹è®¡ç®—é‡å¤§å’Œ/æˆ–é˜»å¡çš„æ¨¡å—ï¼Œæ¨èä½¿ç”¨å»¶è¿ŸåŠ è½½ã€‚

è‹¥éœ€ç¡®ä¿æ¨¡å—åœ¨æœåŠ¡å™¨å¯åŠ¨å‰åŠ è½½ï¼Œè¯· `await` å»¶è¿Ÿæ¨¡å—ã€‚

### æµ‹è¯•

æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `await app.modules` ç­‰å¾…å»¶è¿ŸåŠ è½½å’Œæ‡’åŠ è½½æ¨¡å—å®Œæˆã€‚

```typescript
import { describe, expect, it } from 'bun:test'
import { Elysia } from 'elysia'

describe('æ¨¡å—', () => {
    it('å†…è”å¼‚æ­¥', async () => {
        const app = new Elysia()
              .use(async (app) =>
                  app.get('/async', () => 'async')
              )

        await app.modules

        const res = await app
            .handle(new Request('http://localhost/async'))
            .then((r) => r.text())

        expect(res).toBe('async')
    })
})
```

---

---
url: 'https://elysiajs.com/plugins/overview.md'
---

# æ¦‚è¿°

Elysia æ—¨åœ¨å®ç°æ¨¡å—åŒ–å’Œè½»é‡åŒ–ã€‚

éµå¾ªä¸ Arch Linux ç›¸åŒçš„ç†å¿µï¼ˆé¡ºä¾¿è¯´ä¸€å¥ï¼Œæˆ‘ä½¿ç”¨ Archï¼‰ï¼š

> è®¾è®¡å†³ç­–æ˜¯é€šè¿‡å¼€å‘è€…å…±è¯†é€ä¸ªæ¡ˆä¾‹åšå‡ºçš„

è¿™ç¡®ä¿äº†å¼€å‘è€…æœ€ç»ˆèƒ½å¤Ÿåˆ›å»ºå‡ºé«˜æ€§èƒ½çš„ web æœåŠ¡å™¨ã€‚å› æ­¤ï¼ŒElysia åŒ…å«äº†é¢„æ„å»ºçš„å¸¸è§æ¨¡å¼æ’ä»¶ï¼Œä»¥æ–¹ä¾¿å¼€å‘è€…ä½¿ç”¨ï¼š

## å®˜æ–¹æ’ä»¶

ä»¥ä¸‹æ˜¯ç”± Elysia å›¢é˜Ÿç»´æŠ¤çš„ä¸€äº›å®˜æ–¹æ’ä»¶ï¼š

* [Bearer](/plugins/bearer) - è‡ªåŠ¨æ£€ç´¢ [Bearer](https://swagger.io/docs/specification/authentication/bearer-authentication/) ä»¤ç‰Œ
* [CORS](/plugins/cors) - è®¾ç½® [è·¨æºèµ„æºå…±äº« (CORS)](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)
* [Cron](/plugins/cron) - è®¾ç½® [cron](https://en.wikipedia.org/wiki/Cron) ä»»åŠ¡
* [Eden](/eden/overview) - Elysia çš„ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨å®¢æˆ·ç«¯
* [GraphQL Apollo](/plugins/graphql-apollo) - åœ¨ Elysia ä¸Šè¿è¡Œ [Apollo GraphQL](https://www.apollographql.com/)
* [GraphQL Yoga](/plugins/graphql-yoga) - åœ¨ Elysia ä¸Šè¿è¡Œ [GraphQL Yoga](https://github.com/dotansimha/graphql-yoga)
* [HTML](/plugins/html) - å¤„ç† HTML å“åº”
* [JWT](/plugins/jwt) - ä½¿ç”¨ [JWT](https://jwt.io/) è¿›è¡Œèº«ä»½éªŒè¯
* [OpenAPI](/plugins/openapi) - ç”Ÿæˆ [OpenAPI](https://swagger.io/specification/) æ–‡æ¡£
* [OpenTelemetry](/plugins/opentelemetry) - æ·»åŠ å¯¹ OpenTelemetry çš„æ”¯æŒ
* [Server Timing](/plugins/server-timing) - ä½¿ç”¨ [Server-Timing API](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Server-Timing) è¿›è¡Œæ€§èƒ½ç“¶é¢ˆå®¡è®¡
* [Static](/plugins/static) - æä¾›é™æ€æ–‡ä»¶/æ–‡ä»¶å¤¹

## ç¤¾åŒºæ’ä»¶

* [Create ElysiaJS](https://github.com/kravetsone/create-elysiajs) - è½»æ¾æ­å»ºæ‚¨çš„ Elysia é¡¹ç›®ç¯å¢ƒï¼ˆå¸®åŠ©å¤„ç† ORMã€Linters å’Œæ’ä»¶ï¼‰ï¼
* [Lucia Auth](https://github.com/pilcrowOnPaper/lucia) - èº«ä»½éªŒè¯ï¼Œç®€å•è€Œæ¸…æ™°
* [Elysia Clerk](https://github.com/wobsoriano/elysia-clerk) - éå®˜æ–¹ Clerk èº«ä»½éªŒè¯æ’ä»¶
* [Elysia Polyfills](https://github.com/bogeychan/elysia-polyfills) - åœ¨ Node.js å’Œ Deno ä¸Šè¿è¡Œ Elysia ç”Ÿæ€ç³»ç»Ÿ
* [Vite server](https://github.com/kravetsone/elysia-vite-server) - æ’ä»¶ï¼Œåœ¨ `development` æ¨¡å¼ä¸‹å¯åŠ¨å’Œè£…é¥° [`vite`](https://vitejs.dev/) å¼€å‘æœåŠ¡å™¨ï¼Œåœ¨ `production` æ¨¡å¼ä¸‹æä¾›é™æ€æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰
* [Vite](https://github.com/timnghg/elysia-vite) - æä¾›æ³¨å…¥ Vite è„šæœ¬çš„å…¥å£ HTML æ–‡ä»¶
* [Nuxt](https://github.com/trylovetom/elysiajs-nuxt) - è½»æ¾å°† Elysia ä¸ Nuxt é›†æˆï¼
* [Remix](https://github.com/kravetsone/elysia-remix) - ä½¿ç”¨ [`HMR`](https://vitejs.dev/) æ”¯æŒçš„ [Remix](https://remix.run/)ï¼å…³é—­ä¸€ä¸ªé•¿æœŸå­˜åœ¨çš„æ’ä»¶è¯·æ±‚ [#12](https://github.com/elysiajs/elysia/issues/12)
* [Sync](https://github.com/johnny-woodtke/elysiajs-sync) - ä¸€ä¸ªåŸºäº [Dexie.js](https://dexie.org/) çš„è½»é‡çº§ç¦»çº¿ä¼˜å…ˆæ•°æ®åŒæ­¥æ¡†æ¶
* [Connect middleware](https://github.com/kravetsone/elysia-connect-middleware) - æ’ä»¶ï¼Œå…è®¸æ‚¨åœ¨ Elysia ä¸­ç›´æ¥ä½¿ç”¨ [`express`](https://www.npmjs.com/package/express)/[`connect`](https://www.npmjs.com/package/connect) ä¸­é—´ä»¶ï¼
* [Elysia HTTP Exception](https://github.com/codev911/elysia-http-exception) - Elysia æ’ä»¶ï¼Œç”¨äºå¤„ç† HTTP 4xx/5xx é”™è¯¯ï¼Œæä¾›ç»“æ„åŒ–å¼‚å¸¸ç±»
* [Elysia Helmet](https://github.com/DevTobias/elysia-helmet) - ç”¨å„ç§ HTTP å¤´å®‰å…¨ä¿æŠ¤ Elysia åº”ç”¨
* [Vite Plugin SSR](https://github.com/timnghg/elysia-vite-plugin-ssr) - ä½¿ç”¨ Elysia æœåŠ¡å™¨çš„ Vite SSR æ’ä»¶
* [OAuth 2.0](https://github.com/kravetsone/elysia-oauth2) - ç”¨äº [OAuth 2.0](https://en.wikipedia.org/wiki/OAuth) æˆæƒæµç¨‹çš„æ’ä»¶ï¼Œæ”¯æŒè¶…è¿‡ **42** ä¸ªæä¾›è€…ä¸”å…·æœ‰ **ç±»å‹å®‰å…¨æ€§**ï¼
* [OAuth2](https://github.com/bogeychan/elysia-oauth2) - å¤„ç† OAuth 2.0 æˆæƒç æµ
* [OAuth2 Resource Server](https://github.com/ap-1/elysia-oauth2-resource-server) - æ’ä»¶ï¼Œç”¨äºéªŒè¯æ¥è‡ª OAuth2 æä¾›è€…çš„ JWT ä»¤ç‰Œä¸ JWKS ç«¯ç‚¹ï¼Œæ”¯æŒå‘è¡Œè€…ã€å—ä¼—å’ŒèŒƒå›´éªŒè¯
* [Elysia OpenID Client](https://github.com/macropygia/elysia-openid-client) - åŸºäº [openid-client](https://github.com/panva/node-openid-client) çš„ OpenID å®¢æˆ·ç«¯
* [Rate Limit](https://github.com/rayriffy/elysia-rate-limit) - ç®€å•è½»é‡çš„é€Ÿç‡é™åˆ¶å™¨
* [Logysia](https://github.com/tristanisham/logysia) - ç»å…¸çš„æ—¥å¿—ä¸­é—´ä»¶
* [Logestic](https://github.com/cybercoder-naj/logestic) - ä¸º ElysiaJS æä¾›çš„é«˜çº§å¯å®šåˆ¶æ—¥å¿—åº“
* [Logger](https://github.com/bogeychan/elysia-logger) - åŸºäº [pino](https://github.com/pinojs/pino) çš„æ—¥å¿—ä¸­é—´ä»¶
* [Elysia Line](https://github.com/KrataiB/elysia-line) - Elysia çš„ LINE Messaging API å’Œ LINE ç™»å½•é›†æˆï¼ˆåŸºäºå®˜æ–¹ [@line/bot-sdk](https://github.com/line/line-bot-sdk-nodejs) çš„å°è£…ï¼‰
* [Elylog](https://github.com/eajr/elylog) - ç®€å•çš„ stdout æ—¥å¿—åº“ï¼Œå…·å¤‡ä¸€äº›è‡ªå®šä¹‰åŠŸèƒ½
* [Logify for Elysia.js](https://github.com/0xrasla/logify) - ä¸€æ¬¾ä¼˜é›…ã€å¿«é€Ÿä¸”ç±»å‹å®‰å…¨çš„ Elysia.js åº”ç”¨æ—¥å¿—ä¸­é—´ä»¶
* [Nice Logger](https://github.com/tanishqmanuja/nice-logger) - å¯èƒ½ä¸æ˜¯æœ€å¥½çš„ï¼Œä½†å¯¹äº Elysia æ¥è¯´æ˜¯ä¸€ä¸ªç›¸å½“ä¸é”™ä¸”ç”œç¾çš„æ—¥å¿—å™¨ã€‚
* [Sentry](https://github.com/johnny-woodtke/elysiajs-sentry) - ä½¿ç”¨æ­¤ [Sentry](https://docs.sentry.io/) æ’ä»¶æ•è·è¿½è¸ªå’Œé”™è¯¯
* [Elysia Lambda](https://github.com/TotalTechGeek/elysia-lambda) - éƒ¨ç½²åœ¨ AWS Lambda ä¸Š
* [Decorators](https://github.com/gaurishhs/elysia-decorators) - ä½¿ç”¨ TypeScript è£…é¥°å™¨
* [Autoload](https://github.com/kravetsone/elysia-autoload) - åŸºäºç›®å½•ç»“æ„çš„æ–‡ä»¶ç³»ç»Ÿè·¯ç”±ï¼Œæ”¯æŒç”Ÿæˆ [Eden](https://elysiajs.com/eden/overview.html) çš„ç±»å‹ï¼Œå¹¶æ”¯æŒ [`Bun.build`](https://github.com/kravetsone/elysia-autoload?tab=readme-ov-file#bun-build-usage)
* [Msgpack](https://github.com/kravetsone/elysia-msgpack) - å…è®¸æ‚¨ä¸ [MessagePack](https://msgpack.org) ä¸€èµ·å·¥ä½œ
* [XML](https://github.com/kravetsone/elysia-xml) - å…è®¸æ‚¨ä¸ XML ä¸€èµ·å·¥ä½œ
* [Autoroutes](https://github.com/wobsoriano/elysia-autoroutes) - æ–‡ä»¶ç³»ç»Ÿè·¯ç”±
* [Group Router](https://github.com/itsyoboieltr/elysia-group-router) - åŸºäºæ–‡ä»¶ç³»ç»Ÿå’Œæ–‡ä»¶å¤¹çš„ç»„è·¯ç”±å™¨
* [Basic Auth](https://github.com/itsyoboieltr/elysia-basic-auth) - åŸºæœ¬ HTTP èº«ä»½éªŒè¯
* [ETag](https://github.com/bogeychan/elysia-etag) - è‡ªåŠ¨ç”Ÿæˆ HTTP [ETag](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag)
* [CDN Cache](https://github.com/johnny-woodtke/elysiajs-cdn-cache) - Elysia çš„ Cache-Control æ’ä»¶ - ä¸å†æ‰‹åŠ¨è®¾ç½® HTTP å¤´
* [Basic Auth](https://github.com/eelkevdbos/elysia-basic-auth) - åŸºæœ¬ HTTP èº«ä»½éªŒè¯ï¼ˆä½¿ç”¨ `request` äº‹ä»¶ï¼‰
* [i18n](https://github.com/eelkevdbos/elysia-i18next) - åŸºäº [i18next](https://www.i18next.com/) çš„ [i18n](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/i18n) å°è£…
* [Intlify](https://github.com/intlify/srvmid/blob/main/packages/elysia/README.md) - Internationalization server middleware & utilities
* [Elysia Request ID](https://github.com/gtramontina/elysia-requestid) - æ·»åŠ /è½¬å‘è¯·æ±‚ IDï¼ˆ`X-Request-ID` æˆ–è‡ªå®šä¹‰ï¼‰
* [Elysia HTMX](https://github.com/gtramontina/elysia-htmx) - [HTMX](https://htmx.org/) çš„ä¸Šä¸‹æ–‡åŠ©æ‰‹
* [Elysia HMR HTML](https://github.com/gtrabanco/elysia-hmr-html) - åœ¨æ›´æ”¹ç›®å½•ä¸­çš„ä»»ä½•æ–‡ä»¶æ—¶é‡æ–°åŠ è½½ HTML æ–‡ä»¶
* [Elysia Inject HTML](https://github.com/gtrabanco/elysia-inject-html) - å°† HTML ä»£ç æ³¨å…¥ HTML æ–‡ä»¶
* [Elysia HTTP Error](https://github.com/yfrans/elysia-http-error) - ä» Elysia å¤„ç†ç¨‹åºè¿”å› HTTP é”™è¯¯
* [Elysia Http Status Code](https://github.com/sylvain12/elysia-http-status-code) - é›†æˆ HTTP çŠ¶æ€ä»£ç 
* [NoCache](https://github.com/gaurishhs/elysia-nocache) - ç¦ç”¨ç¼“å­˜
* [Elysia Tailwind](https://github.com/gtramontina/elysia-tailwind) - åœ¨æ’ä»¶ä¸­ç¼–è¯‘ [Tailwindcss](https://tailwindcss.com/)ã€‚
* [Elysia Compression](https://github.com/gusb3ll/elysia-compression) - å‹ç¼©å“åº”
* [Elysia IP](https://github.com/gaurishhs/elysia-ip) - è·å– IP åœ°å€
* [OAuth2 Server](https://github.com/myazarc/elysia-oauth2-server) - ä½¿ç”¨ Elysia å¼€å‘ OAuth2 æœåŠ¡å™¨
* [Elysia Flash Messages](https://github.com/gtramontina/elysia-flash-messages) - å¯ç”¨é—ªå­˜æ¶ˆæ¯
* [Elysia AuthKit](https://github.com/gtramontina/elysia-authkit) - éå®˜æ–¹ [WorkOS' AuthKit](https://www.authkit.com/) èº«ä»½éªŒè¯
* [Elysia Error Handler](https://github.com/gtramontina/elysia-error-handler) - æ›´ç®€å•çš„é”™è¯¯å¤„ç†
* [Elysia env](https://github.com/yolk-oss/elysia-env) - å…·æœ‰ typebox çš„ç±»å‹å®‰å…¨ç¯å¢ƒå˜é‡
* [Elysia Drizzle Schema](https://github.com/Edsol/elysia-drizzle-schema) - å¸®åŠ©åœ¨ Elysia OpenAPI æ¨¡å‹ä¸­ä½¿ç”¨ Drizzle ORM æ¶æ„ã€‚
* [Unify-Elysia](https://github.com/qlaffont/unify-elysia) - ä¸º Elysia ç»Ÿä¸€é”™è¯¯ä»£ç 
* [Unify-Elysia-GQL](https://github.com/qlaffont/unify-elysia-gql) - ä¸º Elysia GraphQL æœåŠ¡å™¨ï¼ˆYoga & Apolloï¼‰ç»Ÿä¸€é”™è¯¯ä»£ç 
* [Elysia Auth Drizzle](https://github.com/qlaffont/elysia-auth-drizzle) - å¤„ç† JWT è®¤è¯çš„åº“ï¼ˆå¤´/ Cookie/ æŸ¥è¯¢å‚æ•°ï¼‰ã€‚
* [graceful-server-elysia](https://github.com/qlaffont/graceful-server-elysia) - å— [graceful-server](https://github.com/gquittet/graceful-server) å¯å‘çš„åº“ã€‚
* [Logixlysia](https://github.com/PunGrumpy/logixlysia) - æ—¨åœ¨ä¸º ElysiaJS æä¾›ç¾è§‚ä¸”ç®€å•çš„æ—¥å¿—ä¸­é—´ä»¶ï¼Œæ”¯æŒé¢œè‰²å’Œæ—¶é—´æˆ³ã€‚
* [Elysia Fault](https://github.com/vitorpldev/elysia-fault) - æä¾›ç®€å•ä¸”å¯å®šåˆ¶çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼Œå…è®¸åˆ›å»ºè‡ªå®šä¹‰ HTTP é”™è¯¯ã€‚
* [Elysia Compress](https://github.com/vermaysha/elysia-compress) - ElysiaJS æ’ä»¶ï¼Œç”¨äºå‹ç¼©å“åº”ï¼Œçµæ„Ÿæ¥è‡ª [@fastify/compress](https://github.com/fastify/fastify-compress)
* [@labzzhq/compressor](https://github.com/labzzhq/compressor/) - ç´§å‡‘çš„å“è¶Šä¸å¹¿æ³›çš„ç»“æœï¼šæ”¯æŒ gzipã€deflate å’Œ brotli çš„ Elysia å’Œ Bunnyhop HTTP å‹ç¼©å™¨ã€‚
* [Elysia Accepts](https://github.com/morigs/elysia-accepts) - ç”¨äºæ¥å—å¤´è§£æå’Œå†…å®¹åå•†çš„ Elysia æ’ä»¶
* [Elysia Compression](https://github.com/chneau/elysia-compression) - ç”¨äºå‹ç¼©å“åº”çš„ Elysia æ’ä»¶
* [Elysia Logger](https://github.com/chneau/elysia-logger) - ç”¨äºè®°å½• HTTP è¯·æ±‚å’Œå“åº”çš„ Elysia æ’ä»¶ï¼Œçµæ„Ÿæ¥è‡ª [hono/logger](https://hono.dev/docs/middleware/builtin/logger)
* [Elysia CQRS](https://github.com/jassix/elysia-cqrs) - Elysia æ’ä»¶ï¼Œå®ç° CQRS æ¨¡å¼
* [Elysia Supabase](https://github.com/mastermakrela/elysia-supabase) - æ— ç¼é›†æˆ [Supabase](https://supabase.com/) èº«ä»½éªŒè¯å’Œæ•°æ®åº“åŠŸèƒ½ï¼Œä½¿è®¿é—®ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·æ•°æ®å’Œ Supabase å®¢æˆ·ç«¯å®ä¾‹å˜å¾—å®¹æ˜“ã€‚ç‰¹åˆ«é€‚ç”¨äº [Edge Functions](https://supabase.com/docs/guides/functions)ã€‚
* [Elysia XSS](https://www.npmjs.com/package/elysia-xss) - ä¸º Elysia.js æä¾› XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰ä¿æŠ¤çš„æ’ä»¶ï¼Œæ¸…æ´—è¯·æ±‚ä½“æ•°æ®ã€‚
* [Elysiajs Helmet](https://www.npmjs.com/package/elysiajs-helmet) - ä¸º Elysia.js åº”ç”¨æä¾›å…¨é¢å®‰å…¨æ€§çš„ä¸­é—´ä»¶ï¼Œé€šè¿‡è®¾ç½®å„ç§ HTTP å¤´ä¿æŠ¤æ‚¨çš„åº”ç”¨ã€‚
* [Decorators for Elysia.js](https://github.com/Ateeb-Khan-97/better-elysia) - ä½¿ç”¨è¿™ä¸ªå°åº“æ— ç¼å¼€å‘å’Œé›†æˆ APIã€Websocket å’Œæµå¼ APIã€‚
* [Elysia Protobuf](https://github.com/ilyhalight/elysia-protobuf) - ä¸º Elysia æ”¯æŒ Protobufã€‚
* [Elysia Prometheus](https://github.com/m1handr/elysia-prometheus) - Elysia æ’ä»¶ï¼Œç”¨äºä¸º Prometheus æš´éœ² HTTP ç›‘æ§æŒ‡æ ‡ã€‚
* [Elysia Remote DTS](https://github.com/rayriffy/elysia-remote-dts) - ä¸º Eden Treaty æä¾›å¯è¿œç¨‹æ¶ˆè´¹çš„ .d.ts ç±»å‹çš„æ’ä»¶ã€‚
* [Cap Checkpoint plugin for Elysia](https://capjs.js.org/guide/middleware/elysia.html) - ç±» Cloudflare çš„ä¸­é—´ä»¶ï¼Œç”¨äº Capï¼Œä¸€ä¸ªè½»é‡çº§ã€ç°ä»£çš„å¼€æº CAPTCHA æ›¿ä»£æ–¹æ¡ˆï¼Œä½¿ç”¨ SHA-256 PoW è®¾è®¡ã€‚
* [Elysia Background](https://github.com/staciax/elysia-background) - ç”¨äº Elysia.js çš„åå°ä»»åŠ¡å¤„ç†æ’ä»¶
* [@fedify/elysia](https://github.com/fedify-dev/fedify/tree/main/packages/elysia) - ä¸ [Fedify](https://fedify.dev/) å¹³å°æ— ç¼é›†æˆçš„æ’ä»¶ï¼Œå…¼å®¹ ActivityPub æœåŠ¡å™¨æ¡†æ¶ã€‚
* [elysia-healthcheck](https://github.com/iam-medvedev/elysia-healthcheck) - ç”¨äº Elysia.js çš„å¥åº·æ£€æŸ¥æ’ä»¶
* [elysia-local-https](https://github.com/mrtcmn/elysia-local-https) - Automatic local HTTPS for Elysia â€” certs generated, managed, and refreshed in one line.
* [Eden TanStack Query](https://github.com/xkelxmc/eden-tanstack-query) - type-safe TanStack Query integration for Eden, like
  @trpc/react-query but for Elysia

## ç›¸å…³é¡¹ç›®ï¼š

* [prismabox](https://github.com/m1212e/prismabox) - åŸºäºæ‚¨çš„æ•°æ®åº“æ¨¡å‹ç”Ÿæˆ typebox æ¨¡å¼çš„ç”Ÿæˆå™¨ï¼Œé€‚ç”¨äº Elysia

***

å¦‚æœæ‚¨ä¸º Elysia ç¼–å†™äº†ä¸€ä¸ªæ’ä»¶ï¼Œè¯·éšæ—¶é€šè¿‡ **ç‚¹å‡»ä¸‹é¢çš„ åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µé¢** å°†æ‚¨çš„æ’ä»¶æ·»åŠ åˆ°åˆ—è¡¨ä¸­ ğŸ‘‡

---

---
url: 'https://elysiajs.com/plugins/server-timing.md'
---

# æœåŠ¡å™¨è®¡æ—¶æ’ä»¶

è¯¥æ’ä»¶æ”¯æŒé€šè¿‡æœåŠ¡å™¨è®¡æ—¶ API å®¡è®¡æ€§èƒ½ç“¶é¢ˆ

å®‰è£…æ–¹æ³•ï¼š

```bash
bun add @elysiajs/server-timing
```

ç„¶åä½¿ç”¨å®ƒï¼š

```typescript twoslash
import { Elysia } from 'elysia'
import { serverTiming } from '@elysiajs/server-timing'

new Elysia()
    .use(serverTiming())
    .get('/', () => 'hello')
    .listen(3000)
```

ç„¶åï¼ŒæœåŠ¡å™¨è®¡æ—¶å°†é™„åŠ  'Server-Timing' å¤´ï¼Œè®°å½•æ¯ä¸ªç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„æŒç»­æ—¶é—´ã€å‡½æ•°åç§°å’Œç»†èŠ‚ã€‚

è¦æ£€æŸ¥ï¼Œè¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· > ç½‘ç»œ > \[é€šè¿‡ Elysia æœåŠ¡å™¨å‘å‡ºçš„è¯·æ±‚] > æ—¶åºã€‚

![å¼€å‘è€…å·¥å…·æ˜¾ç¤ºçš„æœåŠ¡å™¨è®¡æ—¶æˆªå›¾](/assets/server-timing.webp)

ç°åœ¨ï¼Œæ‚¨å¯ä»¥è½»æ¾å®¡è®¡æœåŠ¡å™¨çš„æ€§èƒ½ç“¶é¢ˆã€‚

## é…ç½®

ä»¥ä¸‹æ˜¯æ’ä»¶æ¥å—çš„é…ç½®

### enabled

@default `NODE_ENV !== 'production'`

ç¡®å®šæ˜¯å¦å¯ç”¨æœåŠ¡å™¨è®¡æ—¶

### allow

@default `undefined`

ä¸€ä¸ªæ¡ä»¶ï¼Œå†³å®šæ˜¯å¦è®°å½•æœåŠ¡å™¨è®¡æ—¶

### trace

@default `undefined`

å…è®¸æœåŠ¡å™¨è®¡æ—¶è®°å½•æŒ‡å®šçš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼š

Trace æ¥å—ä»¥ä¸‹å¯¹è±¡ï¼š

* request: æ•è·è¯·æ±‚çš„æŒç»­æ—¶é—´
* parse: æ•è·è§£æçš„æŒç»­æ—¶é—´
* transform: æ•è·è½¬åŒ–çš„æŒç»­æ—¶é—´
* beforeHandle: æ•è·å¤„ç†å‰çš„æŒç»­æ—¶é—´
* handle: æ•è·å¤„ç†çš„æŒç»­æ—¶é—´
* afterHandle: æ•è·å¤„ç†åçš„æŒç»­æ—¶é—´
* total: æ•è·ä»å¼€å§‹åˆ°ç»“æŸçš„æ€»æŒç»­æ—¶é—´

## æ¨¡å¼

ä¸‹é¢æ‚¨å¯ä»¥æ‰¾åˆ°ä½¿ç”¨æ’ä»¶çš„å¸¸è§æ¨¡å¼ã€‚

* [å…è®¸æ¡ä»¶](#allow-condition)

## å…è®¸æ¡ä»¶

æ‚¨å¯ä»¥é€šè¿‡ `allow` å±æ€§åœ¨ç‰¹å®šè·¯ç”±ä¸Šç¦ç”¨æœåŠ¡å™¨è®¡æ—¶

```ts twoslash
import { Elysia } from 'elysia'
import { serverTiming } from '@elysiajs/server-timing'

new Elysia()
    .use(
        serverTiming({
            allow: ({ request }) => {
                return new URL(request.url).pathname !== '/no-trace'
            }
        })
    )
```

---

---
url: 'https://elysiajs.com/eden/treaty/overview.md'
---

# Eden æ¡çº¦

Eden æ¡çº¦æ˜¯ç”¨äºä¸æœåŠ¡å™¨äº¤äº’çš„å¯¹è±¡è¡¨ç¤ºï¼Œå…·æœ‰ç±»å‹å®‰å…¨ã€è‡ªåŠ¨è¡¥å…¨å’Œé”™è¯¯å¤„ç†ç­‰ç‰¹æ€§ã€‚

è¦ä½¿ç”¨ Eden æ¡çº¦ï¼Œé¦–å…ˆå¯¼å‡ºæ‚¨ç°æœ‰çš„ Elysia æœåŠ¡å™¨ç±»å‹ï¼š

```typescript
// server.ts
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .get('/hi', () => 'ä½ å¥½ Elysia')
    .get('/id/:id', ({ params: { id } }) => id)
    .post('/mirror', ({ body }) => body, {
        body: t.Object({
            id: t.Number(),
            name: t.String()
        })
    })
    .listen(3000)

export type App = typeof app // [!ä»£ç  ++]
```

ç„¶åå¯¼å…¥æœåŠ¡å™¨ç±»å‹å¹¶åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ Elysia APIï¼š

```typescript twoslash
// @filename: server.ts
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .get('/hi', () => 'ä½ å¥½ Elysia')
    .get('/id/:id', ({ params: { id } }) => id)
    .post('/mirror', ({ body }) => body, {
        body: t.Object({
            id: t.Number(),
            name: t.String()
        })
    })
    .listen(3000)

export type App = typeof app // [!ä»£ç  ++]

// @filename: client.ts
// ---cut---
// client.ts
import { treaty } from '@elysiajs/eden'
import type { App } from './server' // [!ä»£ç  ++]

const app = treaty<App>('localhost:3000')

// å“åº”ç±»å‹: 'ä½ å¥½ Elysia'
const { data, error } = await app.hi.get()
      // ^?
```

## æ ‘çŠ¶è¯­æ³•

HTTP è·¯å¾„æ˜¯æ–‡ä»¶ç³»ç»Ÿæ ‘çš„èµ„æºæŒ‡ç¤ºç¬¦ã€‚

æ–‡ä»¶ç³»ç»Ÿç”±å¤šä¸ªçº§åˆ«çš„æ–‡ä»¶å¤¹ç»„æˆï¼Œä¾‹å¦‚ï¼š

* /documents/elysia
* /documents/kalpas
* /documents/kelvin

æ¯ä¸ªå±‚çº§ç”± **/**ï¼ˆæ–œæ ï¼‰å’Œä¸€ä¸ªåç§°åˆ†éš”ã€‚

ä½†æ˜¯åœ¨ JavaScript ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ **"."**ï¼ˆç‚¹ï¼‰æ¥è®¿é—®æ›´æ·±å±‚çš„èµ„æºï¼Œè€Œä¸æ˜¯ä½¿ç”¨ **"/"**ï¼ˆæ–œæ ï¼‰ã€‚

Eden æ¡çº¦å°† Elysia æœåŠ¡å™¨è½¬æ¢ä¸ºå¯ä»¥åœ¨ JavaScript å‰ç«¯è®¿é—®çš„æ ‘çŠ¶æ–‡ä»¶ç³»ç»Ÿã€‚

| è·¯å¾„         | æ¡çº¦       |
| ------------ | ------------ |
| /            |              |
| /hi          | .hi          |
| /deep/nested | .deep.nested |

ç»“åˆ HTTP æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ Elysia æœåŠ¡å™¨è¿›è¡Œäº¤äº’ã€‚

| è·¯å¾„         | æ–¹æ³• | æ¡çº¦              |
| ------------ | ------ | ------------------- |
| /            | GET    | .get()              |
| /hi          | GET    | .hi.get()           |
| /deep/nested | GET    | .deep.nested.get()  |
| /deep/nested | POST   | .deep.nested.post() |

## åŠ¨æ€è·¯å¾„

ç„¶è€Œï¼ŒåŠ¨æ€è·¯å¾„å‚æ•°æ— æ³•ä½¿ç”¨ç¬¦å·è¡¨ç¤ºã€‚å¦‚æœå®ƒä»¬è¢«å®Œå…¨æ›¿æ¢ï¼Œæˆ‘ä»¬ä¸çŸ¥é“å‚æ•°åç§°åº”è¯¥æ˜¯ä»€ä¹ˆã€‚

```typescript
// âŒ ä¸æ¸…æ¥šè¿™ä¸ªå€¼åº”è¯¥è¡¨ç¤ºä»€ä¹ˆï¼Ÿ
treaty.item['skadi'].get()
```

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‡½æ•°æŒ‡å®šä¸€ä¸ªåŠ¨æ€è·¯å¾„ï¼Œä»¥æä¾›é”®å€¼ã€‚

```typescript
// âœ… æ¸…æ¥šå€¼çš„åŠ¨æ€è·¯å¾„æ˜¯ 'name'
treaty.item({ name: 'Skadi' }).get()
```

| è·¯å¾„            | æ¡çº¦                           |
| --------------- | -------------------------------- |
| /item           | .item                            |
| /item/:name     | .item({ name: 'Skadi' })         |
| /item/:name/id  | .item({ name: 'Skadi' }).id      |

---

---
url: 'https://elysiajs.com/patterns/unit-test.md'
---

# å•å…ƒæµ‹è¯•&#x20;

ä½œä¸º WinterCG çš„åˆè§„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Request/Response ç±»æ¥æµ‹è¯• Elysia æœåŠ¡å™¨ã€‚

Elysia æä¾›äº† **Elysia.handle** æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å— Web æ ‡å‡† [Request](https://developer.mozilla.org/zh-CN/docs/Web/API/Request) å¹¶è¿”å› [Response](https://developer.mozilla.org/zh-CN/docs/Web/API/Response)ï¼Œæ¨¡æ‹Ÿ HTTP è¯·æ±‚ã€‚

Bun åŒ…å«ä¸€ä¸ªå†…ç½®çš„ [æµ‹è¯•è¿è¡Œå™¨](https://bun.zhcndoc.com/cli/test)ï¼Œé€šè¿‡ `bun:test` æ¨¡å—æä¾›ç±»ä¼¼ Jest çš„ APIï¼Œä¾¿äºåˆ›å»ºå•å…ƒæµ‹è¯•ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º **test/index.test.ts**ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```typescript
// test/index.test.ts
import { describe, expect, it } from 'bun:test'
import { Elysia } from 'elysia'

describe('Elysia', () => {
    it('returns a response', async () => {
        const app = new Elysia().get('/', () => 'hi')

        const response = await app
            .handle(new Request('http://localhost/'))
            .then((res) => res.text())

        expect(response).toBe('hi')
    })
})
```

ç„¶åæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œ **bun test** æ¥è¿›è¡Œæµ‹è¯•ã€‚

```bash
bun test
```

å¯¹ Elysia æœåŠ¡å™¨çš„æ–°è¯·æ±‚å¿…é¡»æ˜¯ä¸€ä¸ªå®Œå…¨æœ‰æ•ˆçš„ URLï¼Œ**ä¸èƒ½**æ˜¯ URL çš„ä¸€éƒ¨åˆ†ã€‚

è¯·æ±‚å¿…é¡»æä¾›å¦‚ä¸‹æ ¼å¼çš„ URLï¼š

| URL                   | æœ‰æ•ˆ |
| --------------------- | ----- |
| http://localhost/user | âœ…    |
| /user                 | âŒ    |

æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–æµ‹è¯•åº“ï¼Œå¦‚ Jest æˆ–å…¶ä»–æµ‹è¯•åº“æ¥åˆ›å»º Elysia å•å…ƒæµ‹è¯•ã€‚

## Eden Treaty æµ‹è¯•

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Eden Treaty åˆ›å»º Elysia æœåŠ¡å™¨çš„ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨æµ‹è¯•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript twoslash
// test/index.test.ts
import { describe, expect, it } from 'bun:test'
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'

const app = new Elysia().get('/hello', 'hi')

const api = treaty(app)

describe('Elysia', () => {
    it('returns a response', async () => {
        const { data, error } = await api.hello.get()

        expect(data).toBe('hi')
              // ^?
    })
})
```

æœ‰å…³è®¾ç½®å’Œæ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [Eden Treaty å•å…ƒæµ‹è¯•](/eden/treaty/unit-test)ã€‚

---

---
url: 'https://elysiajs.com/playground.md'
---

# æ¬¢è¿æ¥åˆ° ElysiaJS

å¾ˆé«˜å…´ä½ èƒ½æ¥åˆ°è¿™é‡Œï¼è¿™ä¸ªæ¼”ç¤ºåŒºæ—¨åœ¨å¸®åŠ©ä½ å¿«é€Ÿè€Œè½»æ¾åœ°å…¥é—¨ ElysiaJSã€‚

ä¸åŒäºä¼ ç»Ÿçš„åç«¯æ¡†æ¶ï¼ŒElysia ä¹Ÿå¯ä»¥åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼å…è®¸ä½ ç›´æ¥åœ¨æµè§ˆå™¨ä¸­ç¼–å†™å’Œå°è¯• Elysiaï¼ä½¿å…¶æˆä¸ºå­¦ä¹ å’Œå®éªŒçš„å®Œç¾ç¯å¢ƒã€‚

Elysia æ˜¯ä¸€ä¸ªä¸ºäººç±»è®¾è®¡çš„äººæ€§åŒ–ç½‘ç»œæ¡†æ¶ã€‚

---

---
url: 'https://elysiajs.com/tutorial/getting-started/status-and-headers.md'
---

# çŠ¶æ€ç 

çŠ¶æ€ç æ˜¯æœåŠ¡å™¨å¤„ç†è¯·æ±‚çš„æŒ‡ç¤ºå™¨ã€‚

å½“æ‚¨è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢æ—¶ï¼Œæ‚¨ä¸€å®šå¬è¯´è¿‡è‡­åæ˜­è‘—çš„ **404 Not Found**ã€‚

é‚£æ˜¯ä¸€ä¸ª **çŠ¶æ€ç **ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia ä¼šå¯¹æˆåŠŸçš„è¯·æ±‚è¿”å› **200 OK**ã€‚

æ ¹æ®æƒ…å†µï¼ŒElysia è¿˜è¿”å›è®¸å¤šå…¶ä»–çŠ¶æ€ç ï¼Œä¾‹å¦‚ï¼š

* 400 Bad Request
* 422 Unprocessable Entity
* 500 Internal Server Error

æ‚¨è¿˜å¯ä»¥é€šè¿‡åœ¨ `status` å‡½æ•°ä¸­è¿”å›æ‚¨çš„å“åº”æ¥è¿”å›çŠ¶æ€ç ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ status }) => status(418, "æˆ‘æ˜¯ä¸€å£¶èŒ¶'"))
	.listen(3000)
```

è¯·å‚é˜… çŠ¶æ€ç ã€‚

## é‡å®šå‘

åŒæ ·ï¼Œæ‚¨è¿˜å¯ä»¥é€šè¿‡è¿”å› `redirect` å‡½æ•°å°†è¯·æ±‚é‡å®šå‘åˆ°å¦ä¸€ä¸ª URLã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ redirect }) => redirect('https://elysiajs.com'))
	.listen(3000)
```

è¯·å‚é˜… é‡å®šå‘ã€‚

## å“åº”å¤´

ä¸çŠ¶æ€ç å’Œé‡å®šå‘ç›´æ¥è¿”å›ä¸åŒã€‚

æ‚¨å¯èƒ½ä¼šåœ¨åº”ç”¨ç¨‹åºä¸­å¤šæ¬¡è®¾ç½®å“åº”å¤´ã€‚

å› æ­¤ï¼ŒElysia æä¾›äº† `set.headers` å¯¹è±¡æ¥è®¾ç½®å“åº”å¤´ï¼Œè€Œä¸æ˜¯è¿”å›ä¸€ä¸ª `headers` å‡½æ•°ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ set }) => {
		set.headers['x-powered-by'] = 'Elysia'

		return 'ä½ å¥½ï¼Œä¸–ç•Œ'
	})
	.listen(3000)
```

å› ä¸º `headers` æ˜¯ **è¯·æ±‚å¤´**ï¼ŒElysia é€šè¿‡å‰ç¼€ **set.headers** æ¥åŒºåˆ†è¯·æ±‚å¤´å’Œå“åº”å¤´ã€‚

è¯·å‚é˜… å“åº”å¤´ã€‚

## ç»ƒä¹ 

è®©æˆ‘ä»¬ç»ƒä¹ ä¸€ä¸‹æˆ‘ä»¬æ‰€å­¦çš„å†…å®¹ã€‚

\<template #answer>

1. è¦å°†çŠ¶æ€ç è®¾ç½®ä¸º `418 æˆ‘æ˜¯ä¸€å£¶èŒ¶`ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `status` å‡½æ•°ã€‚
2. è¦å°† `/docs` é‡å®šå‘åˆ° `https://elysiajs.com`ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `redirect` å‡½æ•°ã€‚
3. è¦å°†è‡ªå®šä¹‰å¤´ `x-powered-by` è®¾ç½®ä¸º `Elysia`ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `set.headers` å¯¹è±¡ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ status, set }) => {
		set.headers['x-powered-by'] = 'Elysia'

		return status(418, 'ä½ å¥½ Elysia!')
	})
	.get('/docs', ({ redirect }) => redirect('https://elysiajs.com'))
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/tutorial/patterns/standalone-schema.md'
---

# ç‹¬ç«‹æ¨¡å¼

å½“æˆ‘ä»¬ä½¿ç”¨ ä¿æŠ¤å™¨ å®šä¹‰ä¸€ä¸ªæ¨¡å¼æ—¶ï¼Œæ¨¡å¼å°†è¢«æ·»åŠ åˆ°ä¸€ä¸ªè·¯ç”±ã€‚ä½†å¦‚æœè¯¥è·¯ç”±æä¾›äº†ä¸€ä¸ªæ¨¡å¼ï¼Œå®ƒå°†è¢« **è¦†ç›–**ï¼š

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.guard({
		body: t.Object({
			age: t.Number()
		})
	})
	.post(
		'/user',
		({ body }) => body,
		{
			// è¿™å°†è¦†ç›–ä¿æŠ¤å™¨æ¨¡å¼
			body: t.Object({
				name: t.String()
			})
		}
	)
	.listen(3000)
```

å¦‚æœæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªæ¨¡å¼ä¸è·¯ç”±æ¨¡å¼ **å…±å­˜**ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶å®šä¹‰ä¸º **ç‹¬ç«‹æ¨¡å¼**ï¼š

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.guard({
		schema: 'standalone', // [!code ++]
		body: t.Object({
			age: t.Number()
		})
	})
	.post(
		'/user',
		// body å°†åŒæ—¶æ‹¥æœ‰ age å’Œ name å±æ€§
		({ body }) => body,
		{
			body: t.Object({
				name: t.String()
			})
		}
	)
	.listen(3000)
```

## æ¨¡å¼åº“çš„äº’æ“ä½œæ€§

ç‹¬ç«‹æ¨¡å¼ä¹‹é—´çš„æ¨¡å¼å¯ä»¥æ¥è‡ªä¸åŒçš„éªŒè¯åº“ã€‚

ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ **zod** å®šä¹‰ç‹¬ç«‹æ¨¡å¼ï¼Œè€Œä½¿ç”¨ **Elysia.t** å®šä¹‰æœ¬åœ°æ¨¡å¼ï¼Œä¸¤è€…å¯ä»¥äº’æ¢ä½¿ç”¨ã€‚

## ä»»åŠ¡

é€šè¿‡ä½¿ç”¨ç‹¬ç«‹æ¨¡å¼æ¥ä½¿è¯·æ±‚ä½“ä¸­çš„ `age` å’Œ `name` å±æ€§å˜ä¸ºå¿…éœ€ã€‚

\<template #answer>

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ä¿æŠ¤å™¨é€‰é¡¹ä¸­æ·»åŠ  `schema: 'standalone'` æ¥å®šä¹‰ç‹¬ç«‹æ¨¡å¼ã€‚

```typescript
import { Elysia, t } from 'elysia'
import { z } from 'zod'

new Elysia()
	.guard({
		schema: 'standalone', // [!code ++]
		body: z.object({
			age: z.number()
		})
	})
	.post(
		'/user',
		({ body }) => body,
		{
			body: t.Object({
				name: t.String()
			})
		}
	)
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/tutorial/getting-started/life-cycle.md'
---

# ç”Ÿå‘½å‘¨æœŸ

ç”Ÿå‘½å‘¨æœŸ **é’©å­** æ˜¯åœ¨è¯·æ±‚-å“åº”å‘¨æœŸä¸­çš„ç‰¹å®šäº‹ä»¶ä¸Šæ‰§è¡Œçš„å‡½æ•°ã€‚

å®ƒä»¬å…è®¸ä½ åœ¨ç‰¹å®šçš„æ—¶åˆ»è¿è¡Œè‡ªå®šä¹‰é€»è¾‘

* request - å½“æ”¶åˆ°è¯·æ±‚æ—¶
* beforeHandle - åœ¨æ‰§è¡Œå¤„ç†å™¨ä¹‹å‰
* afterResponse - åœ¨å‘é€å“åº”ä¹‹åï¼Œç­‰ç­‰ã€‚
* error - å½“å‘ç”Ÿé”™è¯¯æ—¶

è¿™å¯¹äºæ—¥å¿—è®°å½•ã€èº«ä»½éªŒè¯ç­‰ä»»åŠ¡éå¸¸æœ‰ç”¨ã€‚

è¦æ³¨å†Œç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä½ å¯ä»¥å°†å…¶ä¼ é€’ç»™è·¯ç”±æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼š

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/1', () => 'ä½ å¥½ï¼ŒElysiaï¼')
	.get('/auth', () => {
		console.log('è¿™æ˜¯åœ¨ "beforeHandle" ä¹‹åæ‰§è¡Œçš„')

		return 'å“¦ï¼Œä½ çœŸå¹¸è¿ï¼'
	}, {
		beforeHandle({ request, status }) {
			console.log('è¿™æ˜¯åœ¨å¤„ç†å™¨ä¹‹å‰æ‰§è¡Œçš„')

			if(Math.random() <= 0.5)
				return status(418)
		}
	})
	.get('/2', () => 'ä½ å¥½ï¼ŒElysiaï¼')
```

å½“ `beforeHandle` è¿”å›ä¸€ä¸ªå€¼æ—¶ï¼Œå®ƒå°†è·³è¿‡å¤„ç†å™¨å¹¶è¿”å›è¯¥å€¼ã€‚

è¿™å¯¹äºåƒèº«ä»½éªŒè¯è¿™æ ·çš„äº‹æƒ…éå¸¸æœ‰ç”¨ï¼Œå½“ç”¨æˆ·æœªè¿›è¡Œèº«ä»½éªŒè¯æ—¶ï¼Œä½ æƒ³è¿”å› `401 Unauthorized` å“åº”ã€‚

è¯·å‚è§ ç”Ÿå‘½å‘¨æœŸï¼Œå¤„ç†ä¹‹å‰ ä»¥è·å¾—æ›´è¯¦ç»†çš„è¯´æ˜ã€‚

## é’©å­

ä¸€ä¸ªæ‹¦æˆª **ç”Ÿå‘½å‘¨æœŸäº‹ä»¶** çš„å‡½æ•°ã€‚ å› ä¸ºä¸€ä¸ªå‡½æ•° **â€œé’©ä½â€** äº†ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

é’©å­å¯ä»¥åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š

1. æœ¬åœ°é’©å­ - åœ¨ç‰¹å®šè·¯ç”±ä¸Šæ‰§è¡Œ
2. æ‹¦æˆªå™¨é’©å­ - åœ¨æ¯ä¸ªè·¯ç”±ä¸Šæ‰§è¡Œ **åœ¨é’©å­æ³¨å†Œå**

## æœ¬åœ°é’©å­

æœ¬åœ°é’©å­åœ¨ç‰¹å®šè·¯ç”±ä¸Šæ‰§è¡Œã€‚

è¦ä½¿ç”¨æœ¬åœ°é’©å­ï¼Œä½ å¯ä»¥å°†é’©å­å†…è”åˆ°è·¯ç”±å¤„ç†å™¨ä¸­ï¼š

```typescript
// ç±»ä¼¼äºä¹‹å‰çš„ä»£ç ç‰‡æ®µ
import { Elysia } from 'elysia'

new Elysia()
	.get('/1', () => 'ä½ å¥½ï¼ŒElysiaï¼')
	.get('/auth', () => {
		console.log('åœ¨ "beforeHandle" ä¹‹åè¿è¡Œ')

		return 'å“¦ï¼Œä½ çœŸå¹¸è¿ï¼'
	}, {
		// è¿™æ˜¯ä¸€ä¸ªæœ¬åœ°é’©å­
		beforeHandle({ request, status }) {
			console.log('åœ¨å¤„ç†å™¨ä¹‹å‰è¿è¡Œ')

			if(Math.random() <= 0.5)
				return status(418)
		}
	})
	.get('/2', () => 'ä½ å¥½ï¼ŒElysiaï¼')
```

## æ‹¦æˆªå™¨é’©å­

åœ¨æ¯ä¸ª **é’©å­è¢«è°ƒç”¨ååˆ°æ¥çš„å¤„ç†å™¨** ä¸­æ³¨å†Œé’©å­ï¼Œä»…é’ˆå¯¹å½“å‰å®ä¾‹ã€‚

è¦æ·»åŠ æ‹¦æˆªå™¨é’©å­ï¼Œä½ å¯ä»¥ä½¿ç”¨ `.on` åè·Ÿä¸€ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼š

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/1', () => 'ä½ å¥½ï¼ŒElysiaï¼')
	.onBeforeHandle(({ request, status }) => {
		console.log('è¿™æ˜¯åœ¨å¤„ç†å™¨ä¹‹å‰æ‰§è¡Œçš„')

		if(Math.random() <= 0.5)
			return status(418)
	})
	// "beforeHandle" è¢«åº”ç”¨
	.get('/auth', () => {
		console.log('è¿™æ˜¯åœ¨ "beforeHandle" ä¹‹åæ‰§è¡Œçš„')

		return 'å“¦ï¼Œä½ çœŸå¹¸è¿ï¼'
	})
	// "beforeHandle" ä¹Ÿè¢«åº”ç”¨
	.get('/2', () => 'ä½ å¥½ï¼ŒElysiaï¼')
```

ä¸æœ¬åœ°é’©å­ä¸åŒï¼Œæ‹¦æˆªå™¨é’©å­ä¼šå°†é’©å­æ·»åŠ åˆ°é’©å­æ³¨å†Œååˆ°æ¥çš„æ¯ä¸ªè·¯ç”±ã€‚

## å®è·µ

è®©æˆ‘ä»¬å°†ä¸¤ç§ç±»å‹çš„é’©å­ä»˜è¯¸å®è·µã€‚

\<template #answer>

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `beforeHandle` åœ¨è¯·æ±‚åˆ°è¾¾å¤„ç†å™¨ä¹‹å‰æ‹¦æˆªè¯·æ±‚ï¼Œå¹¶ä½¿ç”¨ `status` æ–¹æ³•è¿”å›å“åº”ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.onBeforeHandle(({ query: { name }, status }) => {
		if(!name) return status(401)
	})
	.get('/auth', ({ query: { name = 'anon' } }) => {
		return `ä½ å¥½ ${name}ï¼`
	})
	.get('/profile', ({ query: { name = 'anon' } }) => {
		return `ä½ å¥½ ${name}ï¼`
	})
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/essential/life-cycle.md'
---

# ç”Ÿå‘½å‘¨æœŸ&#x20;

ç”Ÿå‘½å‘¨æœŸå…è®¸æˆ‘ä»¬åœ¨é¢„å®šä¹‰çš„ç‚¹æ‹¦æˆªä¸€ä¸ªé‡è¦äº‹ä»¶ï¼Œä»è€Œæ ¹æ®éœ€è¦è‡ªå®šä¹‰æœåŠ¡å™¨çš„è¡Œä¸ºã€‚

Elysiaçš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¯ä»¥å¦‚ä¸‹æ‰€ç¤ºã€‚
![Elysia ç”Ÿå‘½å‘¨æœŸå›¾](/assets/lifecycle-chart.svg)

> ç‚¹å‡»å›¾ç‰‡æ”¾å¤§

ä»¥ä¸‹æ˜¯Elysiaä¸­å¯ç”¨çš„è¯·æ±‚ç”Ÿå‘½å‘¨æœŸï¼š

***

Elysiaçš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥ç”¨å¦‚ä¸‹å›¾ç¤ºè¡¨ç¤ºã€‚
![Elysia ç”Ÿå‘½å‘¨æœŸå›¾](/assets/lifecycle-chart.svg)

> ç‚¹å‡»å›¾ç‰‡æ”¾å¤§

## ä¸ºä»€ä¹ˆ

å‡è®¾æˆ‘ä»¬æƒ³è¿”å›ä¸€äº› HTMLã€‚

é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šè®¾ç½® **"Content-Type"** å¤´ä¸º **"text/html"**ï¼Œä»¥ä¾¿æµè§ˆå™¨èƒ½å¤Ÿæ¸²æŸ“å®ƒã€‚

ä½†æ˜¯æ‰‹åŠ¨ä¸ºæ¯ä¸ªè·¯ç”±è®¾ç½®è¿™ä¸ªå¤´ä¿¡æ¯å¾ˆç¹çã€‚

é‚£ä¹ˆï¼Œå¦‚æœæ¡†æ¶èƒ½å¤Ÿè‡ªåŠ¨æ£€æµ‹å“åº”æ˜¯ HTML å¹¶è‡ªåŠ¨ä¸ºæ‚¨è®¾ç½®å¤´éƒ¨æ€ä¹ˆåŠï¼Ÿè¿™å°±æ˜¯ç”Ÿå‘½å‘¨æœŸæ¦‚å¿µçš„ç”±æ¥ã€‚

## é’©å­

æ¯ä¸ªæ‹¦æˆª **ç”Ÿå‘½å‘¨æœŸäº‹ä»¶** çš„å‡½æ•°ç§°ä¸º **é’©å­**ã€‚

ï¼ˆå‡½æ•°â€œé’©å…¥â€(hook) ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼‰

é’©å­åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š

1. [æœ¬åœ°é’©å­ (Local Hook)](#local-hook)ï¼šåœ¨ç‰¹å®šè·¯ç”±ä¸Šæ‰§è¡Œ
2. [æ‹¦æˆªé’©å­ (Interceptor Hook)](#interceptor-hook)ï¼šåœ¨é’©å­æ³¨å†Œå**æ¯ä¸ªè·¯ç”±**æ‰§è¡Œ

::: tip
é’©å­æ¥æ”¶ä¸å¤„ç†ç¨‹åºç›¸åŒçš„ä¸Šä¸‹æ–‡ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆåœ¨ç‰¹å®šç‚¹æ·»åŠ çš„è·¯ç”±å¤„ç†ç¨‹åºã€‚
:::

## æœ¬åœ°é’©å­

æœ¬åœ°é’©å­åœ¨ç‰¹å®šè·¯ç”±ä¸Šæ‰§è¡Œã€‚

è¦ä½¿ç”¨æœ¬åœ°é’©å­ï¼Œä½ å¯ä»¥å°†é’©å­å†…è”åˆ°è·¯ç”±å¤„ç†ç¨‹åºä¸­ï¼š

```typescript
import { Elysia } from 'elysia'
import { isHtml } from '@elysiajs/html'

new Elysia()
    .get('/', () => '<h1>Hello World</h1>', {
        afterHandle({ responseValue, set }) {
            if (isHtml(responseValue))
                set.headers['Content-Type'] = 'text/html; charset=utf8'
        }
    })
    .get('/hi', () => '<h1>ä½ å¥½ï¼Œä¸–ç•Œ</h1>')
    .listen(3000)
```

å“åº”åº”åˆ—å‡ºå¦‚ä¸‹ï¼š

| è·¯å¾„ | Content-Type             |
| ---- | ------------------------ |
| /    | text/html; charset=utf8  |
| /hi  | text/plain; charset=utf8 |

## æ‹¦æˆªé’©å­

é’©å­æ³¨å†Œåï¼Œä¼šä½œç”¨äº**å½“å‰å®ä¾‹**çš„æ¯ä¸ªå¤„ç†ç¨‹åºã€‚

è¦æ·»åŠ æ‹¦æˆªé’©å­ï¼Œå¯ä»¥ä½¿ç”¨ `.on` åŠ ä¸Šé©¼å³°å½¢å¼çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼š

```typescript
import { Elysia } from 'elysia'
import { isHtml } from '@elysiajs/html'

new Elysia()
    .get('/none', () => '<h1>Hello World</h1>')
    .onAfterHandle(({ responseValue, set }) => {
        if (isHtml(responseValue))
            set.headers['Content-Type'] = 'text/html; charset=utf8'
    })
    .get('/', () => '<h1>ä½ å¥½ï¼Œä¸–ç•Œ</h1>')
    .get('/hi', () => '<h1>ä½ å¥½ï¼Œä¸–ç•Œ</h1>')
    .listen(3000)
```

å“åº”åº”åˆ—å‡ºå¦‚ä¸‹ï¼š

| è·¯å¾„  | Content-Type                |
| ----- | -------------------------- |
| /none | text/**plain**; charset=utf8 |
| /     | text/**html**; charset=utf8  |
| /hi   | text/**html**; charset=utf8  |

å…¶å®ƒæ’ä»¶çš„äº‹ä»¶ä¹Ÿä¼šåº”ç”¨åˆ°è·¯ç”±ä¸Šï¼Œæ‰€ä»¥ä»£ç é¡ºåºå¾ˆé‡è¦ã€‚

## ä»£ç é¡ºåº

äº‹ä»¶åªä¼šåº”ç”¨åˆ°**æ³¨å†Œä¹‹å**çš„è·¯ç”±ã€‚

å¦‚æœä½ åœ¨æ’ä»¶ä¹‹å‰æ”¾ç½® onErrorï¼Œæ’ä»¶å°†ä¸ä¼šç»§æ‰¿ onError äº‹ä»¶ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
 	.onBeforeHandle(() => {
        console.log('1')
    })
	.get('/', () => 'ä½ å¥½')
    .onBeforeHandle(() => {
        console.log('2')
    })
    .listen(3000)
```

æ§åˆ¶å°åº”è¾“å‡ºå¦‚ä¸‹å†…å®¹ï¼š

```bash
1
```

æ³¨æ„æ²¡æœ‰è¾“å‡º **2**ï¼Œå› ä¸ºäº‹ä»¶æ˜¯åœ¨è·¯ç”±ä¹‹åæ³¨å†Œçš„ï¼Œæ‰€ä»¥ä¸ä¼šä½œç”¨äºè¯¥è·¯ç”±ã€‚

è¿™åŒæ ·é€‚ç”¨äºæ’ä»¶ï¼š

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.onBeforeHandle(() => {
		console.log('1')
	})
	.use(someRouter)
	.onBeforeHandle(() => {
		console.log('2')
	})
	.listen(3000)
```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªä¼šæ‰“å° **1**ï¼Œå› ä¸ºäº‹ä»¶æ˜¯åœ¨æ’ä»¶ä¹‹åæ³¨å†Œçš„ã€‚

é™¤äº† `onRequest` äº‹ä»¶å¤–ï¼Œæ‰€æœ‰äº‹ä»¶éƒ½éµå¾ªæ­¤è§„åˆ™ã€‚
å› ä¸º onRequest å‘ç”Ÿåœ¨è¯·æ±‚æ—¶ï¼Œä¸çŸ¥é“åº”ç”¨åˆ°å“ªä¸ªè·¯ç”±ï¼Œæ‰€ä»¥å®ƒæ˜¯å…¨å±€äº‹ä»¶ã€‚

## è¯·æ±‚ (Request)

ç”Ÿå‘½å‘¨æœŸä¸­ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„äº‹ä»¶æ˜¯åœ¨æ¥æ”¶åˆ°æ¯ä¸ªæ–°è¯·æ±‚æ—¶è§¦å‘ã€‚

ç”±äº `onRequest` ä»…æä¾›æœ€é‡è¦çš„ä¸Šä¸‹æ–‡ä»¥å‡å°‘é¢å¤–å¼€é”€ï¼Œå»ºè®®ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š

* ç¼“å­˜
* é€Ÿç‡é™åˆ¶ / IPæˆ–åœ°åŒºé™åˆ¶
* åˆ†æç»Ÿè®¡
* æä¾›è‡ªå®šä¹‰å¤´éƒ¨ï¼Œä¾‹å¦‚ CORS

#### ç¤ºä¾‹

ä»¥ä¸‹æ˜¯å¼ºåˆ¶é™åˆ¶æŸä¸ª IP åœ°å€è®¿é—®é€Ÿç‡çš„ä¼ªä»£ç ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .use(rateLimiter)
    .onRequest(({ rateLimiter, ip, set, status }) => {
        if (rateLimiter.check(ip)) return status(420, 'ä¿æŒå†·é™')
    })
    .get('/', () => 'ä½ å¥½')
    .listen(3000)
```

å¦‚æœ `onRequest` è¿”å›äº†ä¸€ä¸ªå€¼ï¼Œå®ƒå°†è¢«ç”¨ä½œå“åº”ï¼Œå…¶ä½™çš„ç”Ÿå‘½å‘¨æœŸå°†è¢«è·³è¿‡ã€‚

### é¢„ä¸Šä¸‹æ–‡ (Pre-context)

`onRequest` çš„ä¸Šä¸‹æ–‡è¢«ç±»å‹åŒ–ä¸º `PreContext`ï¼Œå®ƒæ˜¯ `Context` çš„æœ€å°è¡¨ç¤ºï¼ŒåŒ…å«ä»¥ä¸‹å±æ€§ï¼š

è¯·æ±‚: `Request`

* set: `Set`
* store
* decorators

ä¸Šä¸‹æ–‡ä¸æä¾›æ´¾ç”Ÿå€¼ (`derived`)ï¼Œå› ä¸ºå®ƒåŸºäº `onTransform` äº‹ä»¶ã€‚

## è§£æ (Parse)

è§£ææ˜¯ Express ä¸­**ä¸»ä½“è§£æå™¨**çš„ç­‰ä»·ç‰©ã€‚

ä¸€ä¸ªç”¨äºè§£æè¯·æ±‚ä¸»ä½“çš„å‡½æ•°ï¼Œè¿”å›å€¼å°†èµ‹å€¼ç»™ `Context.body`ã€‚å¦‚æœæ²¡æœ‰è¿”å›ï¼ŒElysia ä¼šç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªç”± `onParse` æ³¨å†Œçš„è§£æå‡½æ•°ï¼Œç›´åˆ°ä¸»ä½“è¢«èµ‹å€¼æˆ–æ‰€æœ‰è§£æå™¨éƒ½æ‰§è¡Œå®Œæ¯•ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia è§£æä»¥ä¸‹å†…å®¹ç±»å‹çš„è¯·æ±‚ä½“ï¼š

* `text/plain`
* `application/json`
* `multipart/form-data`
* `application/x-www-form-urlencoded`

å»ºè®®é€šè¿‡ `onParse` äº‹ä»¶æä¾› Elysia é»˜è®¤ä¸æ”¯æŒçš„è‡ªå®šä¹‰ä¸»ä½“è§£æå™¨ã€‚

#### ç¤ºä¾‹

ä»¥ä¸‹æ˜¯åŸºäºè‡ªå®šä¹‰å¤´éƒ¨ç±»å‹è§£æè¯·æ±‚ä½“çš„ç¤ºä¾‹ä»£ç ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia().onParse(({ request, contentType }) => {
    if (contentType === 'application/custom-type') return request.text()
})
```

è¿”å›å€¼ä¼šèµ‹å€¼ç»™ `Context.body`ã€‚å¦‚æœæ²¡æœ‰è¿”å›ï¼ŒElysia å°†ç»§ç»­è¿­ä»£ `onParse` æ ˆä¸­çš„å…¶ä»–è§£æå‡½æ•°ï¼Œç›´åˆ°è¯·æ±‚ä½“è¢«èµ‹å€¼æˆ–æ‰€æœ‰è§£æå™¨æ‰§è¡Œå®Œæˆã€‚

### ä¸Šä¸‹æ–‡

`onParse` çš„ä¸Šä¸‹æ–‡åŸºäº `Context` æ‰©å±•ï¼ŒåŒ…å«ä»¥ä¸‹æ–°å¢å±æ€§ï¼š

* contentType: è¯·æ±‚çš„ Content-Type å¤´éƒ¨

æ‰€æœ‰ä¸Šä¸‹æ–‡åŸºäºæ ‡å‡†ä¸Šä¸‹æ–‡ï¼Œå¯åœ¨è·¯ç”±å¤„ç†ç¨‹åºä¸­åƒæ™®é€šä¸Šä¸‹æ–‡ä¸€æ ·ä½¿ç”¨ã€‚

### è§£æå™¨

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia ä¼šå°è¯•æå‰è¯†åˆ«è¯·æ±‚ä½“çš„ç±»å‹ï¼Œå¹¶é€‰æ‹©æœ€åˆé€‚çš„è§£æå™¨ä»¥æé«˜æ€§èƒ½ã€‚

Elysia ä¼šè¯»å–è·¯ç”±çš„ `body` ç±»å‹å®šä¹‰æ¥æ¨æ–­è¯·æ±‚ä½“ç±»å‹ã€‚

ä¾‹å¦‚ï¼š

```typescript
import { Elysia, t } from 'elysia'

new Elysia().post('/', ({ body }) => body, {
    body: t.Object({
        username: t.String(),
        password: t.String()
    })
})
```

Elysia è¯»å–è¯·æ±‚ä½“çš„æ¶æ„å¹¶å‘ç°æ˜¯å¯¹è±¡ç±»å‹ï¼Œåˆ™çŒœæµ‹è¯·æ±‚ä½“æ˜¯ JSONï¼Œä¾¿ä¼šæå‰ä½¿ç”¨ JSON è§£æå™¨å°è¯•è§£æè¯·æ±‚ä½“ã€‚

Elysia ç”¨äºé€‰æ‹©è§£æå™¨çš„è§„åˆ™å¦‚ä¸‹ï¼š

* `application/json`ï¼šå½“ä½“ç±»å‹ä¸º `t.Object`
* `multipart/form-data`ï¼šä½“ç±»å‹ä¸ºä¸€çº§æ·±åº¦åŒ…å« `t.File` çš„ `t.Object`
* `application/x-www-form-urlencoded`ï¼šä½“ç±»å‹ä¸º `t.URLEncoded`
* `text/plain`ï¼šå…¶ä»–åŸºæœ¬ç±»å‹

è¿™ä½¿ Elysia èƒ½å¤Ÿæå‰ä¼˜åŒ–ä½“è§£ææ€§èƒ½ï¼Œå‡å°‘ç¼–è¯‘æ—¶å¼€é”€ã€‚

### æ˜¾å¼è§£æå™¨

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè‹¥ Elysia æœªèƒ½æ­£ç¡®é€‰æ‹©è§£æå™¨ï¼Œå¯é€šè¿‡æ˜¾å¼æŒ‡å®š `parse` ç±»å‹æŒ‡å®šä½¿ç”¨å“ªä¸ªè§£æå™¨ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia().post('/', ({ body }) => body, {
    // application/json çš„ç®€å†™
    parse: 'json'
})
```

è¿™æ ·å¯ä»¥åœ¨å¤æ‚åœºæ™¯ä¸­æ§åˆ¶ Elysia é€‰æ‹©åˆé€‚çš„è§£æå™¨ã€‚

`parse` å¯ä½¿ç”¨ä»¥ä¸‹ç±»å‹ï¼š

```typescript
type ContentType = |
    // 'text/plain' ç®€å†™
    | 'text'
    // 'application/json' ç®€å†™
    | 'json'
    // 'multipart/form-data' ç®€å†™
    | 'formdata'
    // 'application/x-www-form-urlencoded' ç®€å†™
    | 'urlencoded'
    // è·³è¿‡è§£æ
    | 'none'
    | 'text/plain'
    | 'application/json'
    | 'multipart/form-data'
    | 'application/x-www-form-urlencoded'
```

### è·³è¿‡ä¸»ä½“è§£æ

å½“ä½ éœ€è¦é›†æˆç¬¬ä¸‰æ–¹ HTTP å¤„ç†åº“ï¼ˆå¦‚ `trpc`ã€`orpc`ï¼‰ï¼Œå¹¶é‡åˆ°æŠ›å‡º `Body is already used` é”™è¯¯æ—¶ï¼Œå¯ä»¥è·³è¿‡ Elysia çš„è¯·æ±‚ä½“è§£æã€‚

è¿™æ˜¯å› ä¸º Web æ ‡å‡†ä¸­è¯·æ±‚ä½“åªèƒ½è¢«è¯»å–ä¸€æ¬¡ã€‚

Elysia å’Œç¬¬ä¸‰æ–¹åº“éƒ½æœ‰å„è‡ªçš„è§£æå™¨ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®š `parse: 'none'` æ¥è·³è¿‡ Elysia ç«¯çš„è§£æã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.post(
		'/',
		({ request }) => library.handle(request),
		{
			parse: 'none'
		}
	)
```

### è‡ªå®šä¹‰è§£æå™¨

å¯é€šè¿‡ `parser` æ–¹æ³•æ³¨å†Œè‡ªå®šä¹‰è§£æå™¨ï¼š

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .parser('custom', ({ request, contentType }) => {
        if (contentType === 'application/elysia') return request.text()
    })
    .post('/', ({ body }) => body, {
        parse: ['custom', 'json']
    })
```

## è½¬æ¢ (Transform)

åœ¨**éªŒè¯ä¹‹å‰**æ‰§è¡Œï¼Œç›®çš„æ˜¯ä¿®æ”¹ä¸Šä¸‹æ–‡ä»¥é€‚é…éªŒè¯æˆ–é™„åŠ æ–°å€¼ã€‚

å»ºè®®åœ¨ä»¥ä¸‹åœºæ™¯ä½¿ç”¨è½¬æ¢ï¼š

* ä¿®æ”¹å·²æœ‰ä¸Šä¸‹æ–‡ä»¥ç¬¦åˆéªŒè¯è¦æ±‚
* é€šè¿‡ `derive` åŸºäº `onTransform` æ”¯æŒæä¾›ç±»å‹

#### ç¤ºä¾‹

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨è½¬æ¢å°†å‚æ•°ä¿®æ”¹ä¸ºæ•°å­—ç±»å‹ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
    .get('/id/:id', ({ params: { id } }) => id, {
        params: t.Object({
            id: t.Number()
        }),
        transform({ params }) {
            const id = +params.id

            if (!Number.isNaN(id)) params.id = id
        }
    })
    .listen(3000)
```

## æ´¾ç”Ÿ (Derive)

åœ¨**éªŒè¯ä¹‹å‰**å°†æ–°å€¼é™„åŠ åˆ°ä¸Šä¸‹æ–‡ã€‚å®ƒä¸**è½¬æ¢**å­˜åœ¨äºåŒä¸€ä¸ªè°ƒç”¨æ ˆã€‚

ä¸**state**å’Œ**decorate**ä¸åŒï¼Œåè€…åœ¨æœåŠ¡å™¨å¯åŠ¨å‰åˆ†é…å€¼ã€‚**derive** åœ¨æ¯æ¬¡è¯·æ±‚æ—¶åˆ†é…å±æ€§ã€‚å®ƒå…è®¸å°†éƒ¨åˆ†ä¿¡æ¯æå–åˆ°å•ç‹¬çš„å±æ€§ä¸­ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .derive(({ headers }) => {
        const auth = headers['Authorization']

        return {
            bearer: auth?.startsWith('Bearer ') ? auth.slice(7) : null
        }
    })
    .get('/', ({ bearer }) => bearer)
```

å› ä¸º **derive** ä¼šåœ¨æ¯ä¸ªè¯·æ±‚å¼€å§‹æ—¶èµ‹å€¼ï¼Œæ‰€ä»¥èƒ½å¤Ÿè®¿é—®è¯·æ±‚å±æ€§ï¼Œæ¯”å¦‚ **headers**ã€**query**ã€**body**ï¼Œè€Œ **store** å’Œ **decorate** åˆ™ä¸èƒ½ã€‚

ä¸åŒäº **state** å’Œ **decorate**ï¼Œç”± **derive** åˆ†é…çš„å±æ€§æ˜¯å”¯ä¸€çš„ï¼Œä¸ä¼šä¸å…¶å®ƒè¯·æ±‚å…±äº«ã€‚

::: tip
ä½ å¯èƒ½å¤§å¤šæ•°æƒ…å†µä¸‹æ›´æƒ³ä½¿ç”¨ [resolve](#resolve)ã€‚

Resolve ç±»ä¼¼ derive ä½†åœ¨éªŒè¯ä¹‹åæ‰§è¡Œã€‚è¿™ä½¿å¾— resolve æ›´å®‰å…¨ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å…ˆéªŒè¯ä¼ å…¥æ•°æ®ï¼Œå†ç”¨å®ƒæ´¾ç”Ÿæ–°å±æ€§ã€‚
:::

### é˜Ÿåˆ—

`derive` å’Œ `transform` å­˜å‚¨åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .onTransform(() => {
        console.log(1)
    })
    .derive(() => {
        console.log(2)

        return {}
    })
```

æ§åˆ¶å°åº”è¾“å‡ºï¼š

```bash
1
2
```

## å¤„ç†å‰ (Before Handle)

åœ¨éªŒè¯ä¹‹åï¼Œä¸»è·¯ç”±å¤„ç†ç¨‹åºæ‰§è¡Œä¹‹å‰è°ƒç”¨ã€‚

ç›®çš„æ˜¯æä¾›è‡ªå®šä¹‰éªŒè¯ï¼Œæ»¡è¶³è¿è¡Œä¸»å¤„ç†ç¨‹åºä¹‹å‰çš„ç‰¹æ®Šéœ€æ±‚ã€‚

å»ºè®®åœ¨ä»¥ä¸‹åœºæ™¯ä½¿ç”¨å¤„ç†å‰ï¼š

* è®¿é—®æƒé™æ£€æŸ¥ï¼šæˆæƒã€ç”¨æˆ·ç™»å½•
* é’ˆå¯¹æ•°æ®ç»“æ„çš„è‡ªå®šä¹‰è¯·æ±‚è¦æ±‚

#### ç¤ºä¾‹

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•é€šè¿‡å¤„ç†å‰æ ¡éªŒç”¨æˆ·ç™»å½•çŠ¶æ€ã€‚

```typescript
import { Elysia } from 'elysia'
import { validateSession } from './user'

new Elysia()
    .get('/', () => 'ä½ å¥½', {
        beforeHandle({ set, cookie: { session }, status }) {
            if (!validateSession(session.value)) return status(401)
        }
    })
    .listen(3000)
```

å“åº”åº”åˆ—å‡ºå¦‚ä¸‹ï¼š

| æ˜¯å¦å·²ç™»å½• | å“åº”         |
| ---------- | ------------ |
| âŒ         | æœªæˆæƒ      |
| âœ…         | ä½ å¥½        |

### å®ˆå« (Guard)

å½“éœ€è¦å°†ç›¸åŒçš„å¤„ç†å‰åº”ç”¨äºå¤šä¸ªè·¯ç”±æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ `guard` æ¥æ‰¹é‡åº”ç”¨è¯¥å¤„ç†å‰ã€‚

```typescript
import { Elysia } from 'elysia'
import { signUp, signIn, validateSession, isUserExists } from './user'

new Elysia()
    .guard(
        {
            beforeHandle({ set, cookie: { session }, status }) {
                if (!validateSession(session.value)) return status(401)
            }
        },
        (app) =>
            app
                .get('/user/:id', ({ body }) => signUp(body))
                .post('/profile', ({ body }) => signIn(body), {
                    beforeHandle: isUserExists
                })
    )
    .get('/', () => 'ä½ å¥½')
    .listen(3000)
```

## è§£æ (Resolve)

åœ¨éªŒè¯**ä¹‹å**å‘ä¸Šä¸‹æ–‡æ·»åŠ æ–°å€¼ã€‚å®ƒå’Œ**å¤„ç†å‰**ä½äºåŒä¸€ä¸ªè°ƒç”¨æ ˆã€‚

è§£æçš„è¯­æ³•ä¸ [derive](#derive) ç›¸åŒï¼Œä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºä» Authorization æ’ä»¶è·å– bearer tokenã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
    .guard(
        {
            headers: t.Object({
                authorization: t.TemplateLiteral('Bearer ${string}')
            })
        },
        (app) =>
            app
                .resolve(({ headers: { authorization } }) => {
                    return {
                        bearer: authorization.split(' ')[1]
                    }
                })
                .get('/', ({ bearer }) => bearer)
    )
    .listen(3000)
```

`resolve` å’Œ `onBeforeHandle` å­˜å‚¨åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸­ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .onBeforeHandle(() => {
        console.log(1)
    })
    .resolve(() => {
        console.log(2)

        return {}
    })
    .onBeforeHandle(() => {
        console.log(3)
    })
```

æ§åˆ¶å°åº”è¾“å‡ºï¼š

```bash
1
2
3
```

åŒ **derive**ï¼Œç”± **resolve** åˆ†é…çš„å±æ€§æ˜¯ç§æœ‰çš„ï¼Œä¸ä¼šè¢«å…¶ä»–è¯·æ±‚å…±äº«ã€‚

### å®ˆå«è§£æ

ç”±äº **resolve** ä¸é€‚ç”¨äºæœ¬åœ°é’©å­ï¼Œå»ºè®®ç”¨å®ˆå«å°è£… **resolve** äº‹ä»¶ã€‚

```typescript
import { Elysia } from 'elysia'
import { isSignIn, findUserById } from './user'

new Elysia()
    .guard(
        {
            beforeHandle: isSignIn
        },
        (app) =>
            app
                .resolve(({ cookie: { session } }) => ({
                    userId: findUserById(session.value)
                }))
                .get('/profile', ({ userId }) => userId)
    )
    .listen(3000)
```

## å¤„ç†å (After Handle)

åœ¨ä¸»å¤„ç†ç¨‹åºåæ‰§è¡Œï¼Œç”¨äºå°†**å¤„ç†å‰**å’Œè·¯ç”±å¤„ç†ç¨‹åºçš„è¿”å›å€¼æ˜ å°„åˆ°åˆé€‚çš„å“åº”ã€‚

å»ºè®®åœ¨ä»¥ä¸‹æƒ…å†µä½¿ç”¨å¤„ç†åï¼š

* è½¬æ¢è¯·æ±‚ç»“æœï¼Œä¾‹å¦‚å‹ç¼©ã€äº‹ä»¶æµ
* æ ¹æ®å“åº”å†…å®¹æ·»åŠ è‡ªå®šä¹‰å¤´éƒ¨ï¼Œå¦‚ **Content-Type**

#### ç¤ºä¾‹

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨å¤„ç†åç»™å“åº”æ·»åŠ  HTML å†…å®¹ç±»å‹å¤´ã€‚

```typescript
import { Elysia } from 'elysia'
import { isHtml } from '@elysiajs/html'

new Elysia()
    .get('/', () => '<h1>ä½ å¥½ï¼Œä¸–ç•Œ</h1>', {
        afterHandle({ response, set }) {
            if (isHtml(response))
                set.headers['content-type'] = 'text/html; charset=utf8'
        }
    })
    .get('/hi', () => '<h1>ä½ å¥½ï¼Œä¸–ç•Œ</h1>')
    .listen(3000)
```

å“åº”åº”åˆ—å‡ºå¦‚ä¸‹ï¼š

| è·¯å¾„ | Content-Type             |
| ---- | ------------------------ |
| /    | text/html; charset=utf8  |
| /hi  | text/plain; charset=utf8 |

### è¿”å›å€¼

å¦‚æœ `afterHandle` è¿”å›äº†å€¼ï¼Œåˆ™è¯¥å€¼å°†ä½œä¸ºæ–°çš„å“åº”å€¼ä½¿ç”¨ï¼Œé™¤éè¯¥å€¼ä¸º **undefined**ã€‚

ä¸Šè¿°ç¤ºä¾‹ä¹Ÿå¯ä»¥æ”¹å†™ä¸ºå¦‚ä¸‹å½¢å¼ï¼š

```typescript
import { Elysia } from 'elysia'
import { isHtml } from '@elysiajs/html'

new Elysia()
    .get('/', () => '<h1>ä½ å¥½ï¼Œä¸–ç•Œ</h1>', {
        afterHandle({ response, set }) {
            if (isHtml(response)) {
                set.headers['content-type'] = 'text/html; charset=utf8'
                return new Response(response)
            }
        }
    })
    .get('/hi', () => '<h1>ä½ å¥½ï¼Œä¸–ç•Œ</h1>')
    .listen(3000)
```

ä¸ **beforeHandle** ä¸åŒçš„æ˜¯ï¼Œåœ¨ **afterHandle** è¿”å›æ–°å€¼åï¼Œåç»­çš„å¤„ç†åè¿­ä»£ **ä¸ä¼šè¢«è·³è¿‡**ã€‚

### ä¸Šä¸‹æ–‡

`onAfterHandle` çš„ä¸Šä¸‹æ–‡ç»§æ‰¿è‡ª `Context`ï¼Œå¹¶é¢å¤–åŒ…å« `response` å±æ€§ï¼Œå³è¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”ã€‚

å®ƒåŸºäºæ ‡å‡†ä¸Šä¸‹æ–‡ï¼Œå¯åœ¨è·¯ç”±å¤„ç†ç¨‹åºä¸­åƒæ™®é€šä¸Šä¸‹æ–‡ä¸€æ ·ä½¿ç”¨ã€‚

## æ˜ å°„å“åº” (Map Response)

åœ¨ **afterHandle** ä¹‹åæ‰§è¡Œï¼Œç”¨äºè‡ªå®šä¹‰å“åº”æ˜ å°„ã€‚

å»ºè®®åœ¨ä»¥ä¸‹åœºæ™¯ä½¿ç”¨æ˜ å°„å“åº”ï¼š

* å“åº”å‹ç¼©
* æ˜ å°„å€¼åˆ°ç¬¦åˆ Web æ ‡å‡†çš„å“åº”å¯¹è±¡

#### ç¤ºä¾‹

ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨ `mapResponse` å®ç°å“åº”å‹ç¼©ã€‚

```typescript
import { Elysia } from 'elysia'

const encoder = new TextEncoder()

new Elysia()
    .mapResponse(({ responseValue, set }) => {
        const isJson = typeof responseValue === 'object'

        const text = isJson
            ? JSON.stringify(responseValue)
            : (responseValue?.toString() ?? '')

        set.headers['Content-Encoding'] = 'gzip'

        return new Response(Bun.gzipSync(encoder.encode(text)), {
            headers: {
                'Content-Type': `${
                    isJson ? 'application/json' : 'text/plain'
                }; charset=utf-8`
            }
        })
    })
    .get('/text', () => 'æ˜ å°„å“åº”')
    .get('/json', () => ({ map: 'å“åº”' }))
    .listen(3000)
```

ä¸ **parse** å’Œ **beforeHandle** ç±»ä¼¼ï¼Œä¸€æ—¦è¿”å›ä¸€ä¸ªå€¼ï¼Œåç»­çš„ **mapResponse** è¿­ä»£å°†è¢«è·³è¿‡ã€‚

Elysia ä¼šè‡ªåŠ¨å¤„ç† **set.headers** å’Œ Response çš„åˆå¹¶ï¼Œæˆ‘ä»¬æ— éœ€æ‰‹åŠ¨æ‹¼æ¥å¤´éƒ¨ã€‚

## é”™è¯¯å¤„ç†ï¼ˆOn Errorï¼‰

è®¾è®¡ç”¨äºå¤„ç†é”™è¯¯ã€‚ç”Ÿå‘½å‘¨æœŸä¸­çš„ä»»ä½•é˜¶æ®µå‘ç”Ÿå¼‚å¸¸æ—¶éƒ½ä¼šè§¦å‘ã€‚

å»ºè®®åœ¨ä»¥ä¸‹åœºæ™¯ä½¿ç”¨ `onError`ï¼š

* è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯
* å®¹é”™å¤„ç†ã€é”™è¯¯å¤„ç†æˆ–è¯·æ±‚é‡è¯•
* è®°å½•å’Œåˆ†æé”™è¯¯

#### ç¤ºä¾‹

Elysia ä¼šæ•è·å¤„ç†ç¨‹åºä¸­æŠ›å‡ºçš„æ‰€æœ‰é”™è¯¯ï¼ŒåŸºäºé”™è¯¯ä»£ç è¿›è¡Œå¤„ç†ï¼Œå¹¶ä¼ é€’åˆ° `onError` ä¸­é—´ä»¶ä¸­ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .onError(({ error }) => {
        return new Response(error.toString())
    })
    .get('/', () => {
        throw new Error('æœåŠ¡å™¨æ­£åœ¨ç»´æŠ¤')

        return 'æ— æ³•åˆ°è¾¾'
    })
```

é€šè¿‡ `onError`æˆ‘ä»¬å¯ä»¥æ•è·å¹¶å°†é”™è¯¯è½¬æ¢ä¸ºè‡ªå®šä¹‰æ¶ˆæ¯ã€‚

::: tip
é‡è¦çš„æ˜¯ï¼Œ`onError` å¿…é¡»åœ¨å¯¹åº”å¤„ç†ç¨‹åºä¹‹å‰æ³¨å†Œã€‚
:::

### è‡ªå®šä¹‰404æ¶ˆæ¯

ä¾‹å¦‚ï¼Œè‡ªå®šä¹‰è¿”å› 404 æ¶ˆæ¯ï¼š

```typescript
import { Elysia, NotFoundError } from 'elysia'

new Elysia()
    .onError(({ code, status, set }) => {
        if (code === 'NOT_FOUND') return status(404, 'æœªæ‰¾åˆ° :(')
    })
    .post('/', () => {
        throw new NotFoundError()
    })
    .listen(3000)
```

### ä¸Šä¸‹æ–‡

`onError` çš„ä¸Šä¸‹æ–‡ç»§æ‰¿è‡ª `Context`ï¼ŒåŒ…å«ä»¥ä¸‹é™„åŠ å±æ€§ï¼š

* **error**ï¼šæŠ›å‡ºçš„é”™è¯¯å¯¹è±¡
* **code**ï¼š*é”™è¯¯ä»£ç *

### é”™è¯¯ä»£ç 

Elysia çš„é”™è¯¯ä»£ç åŒ…æ‹¬ï¼š

* **NOT\_FOUND**
* **PARSE**
* **VALIDATION**
* **INTERNAL\_SERVER\_ERROR**
* **INVALID\_COOKIE\_SIGNATURE**
* **INVALID\_FILE\_TYPE**
* **UNKNOWN**
* **number**ï¼ˆHTTP çŠ¶æ€ç ï¼‰

é»˜è®¤æƒ…å†µä¸‹ï¼ŒæŠ›å‡ºçš„é”™è¯¯ä»£ç ä¸º `UNKNOWN`ã€‚

::: tip
å¦‚æœæ²¡æœ‰è¿”å›é”™è¯¯å“åº”ï¼Œå°†ä½¿ç”¨ `error.name` è¿”å›é”™è¯¯ä¿¡æ¯ã€‚
:::

### æœ¬åœ°é”™è¯¯

ä¸å…¶ä»–ç”Ÿå‘½å‘¨æœŸç±»ä¼¼ï¼Œå¯ä»¥é€šè¿‡å®ˆå«åœ¨[ä½œç”¨åŸŸ](/essential/plugin.html#scope)å†…æä¾›é”™è¯¯å¤„ç†ï¼š

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/', () => 'ä½ å¥½', {
        beforeHandle({ set, request: { headers }, error }) {
            if (!isSignIn(headers)) throw error(401)
        },
        error() {
            return 'Handled'
        }
    })
    .listen(3000)
```

## å“åº”å (After Response)

åœ¨å“åº”å‘é€åˆ°å®¢æˆ·ç«¯åæ‰§è¡Œã€‚

å»ºè®®åœ¨ä»¥ä¸‹åœºæ™¯ä½¿ç”¨å“åº”åï¼š

* æ¸…ç†èµ„æº
* æ—¥å¿—è®°å½•å’Œåˆ†æ

#### ç¤ºä¾‹

ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨å“åº”åå¤„ç†ç¨‹åºæ‰“å°å“åº”æ—¶é—´ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .onAfterResponse(() => {
        console.log('å“åº”', performance.now())
    })
    .listen(3000)
```

æ§åˆ¶å°åº”è¾“å‡ºï¼š

```bash
å“åº” 0.0000
å“åº” 0.0001
å“åº” 0.0002
```

### Response

ä¸ [æ˜ å°„å“åº”](#map-response) ç±»ä¼¼ï¼Œ`onAfterResponse` æ¥å—ä¸€ä¸ª `responseValue`ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.onAfterResponse(({ responseValue }) => {
		console.log(responseValue)
	})
	.get('/', () => 'ä½ å¥½')
	.listen(3000)
```

`onAfterResponse` çš„ `response` å¹¶é Web æ ‡å‡†çš„ `Response`ï¼Œè€Œæ˜¯å¤„ç†ç¨‹åºè¿”å›çš„å€¼ã€‚

è¦è·å–è¿”å›çš„å¤´éƒ¨å’ŒçŠ¶æ€ï¼Œå¯ä»¥é€šè¿‡ä¸Šä¸‹æ–‡çš„ `set` è®¿é—®ï¼š

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.onAfterResponse(({ set }) => {
		console.log(set.status, set.headers)
	})
	.get('/', () => 'ä½ å¥½')
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/tutorial/features/end-to-end-type-safety.md'
---

# ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨

Elysia æä¾›äº†åç«¯å’Œå‰ç«¯ä¹‹é—´çš„ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ **æ— éœ€ä»£ç ç”Ÿæˆ**ï¼Œä½¿ç”¨ Edenï¼Œç±»ä¼¼äº tRPCã€‚

```typescript
import { Elysia } from 'elysia'
import { treaty } from '@elysiajs/eden'

// åç«¯
export const app = new Elysia()
	.get('/', 'Hello Elysia!')
	.listen(3000)

// å‰ç«¯
const client = treaty<typeof app>('localhost:3000')

const { data, error } = await client.get()

console.log(data) // Hello World
```

è¿™é€šè¿‡ä» Elysia å®ä¾‹æ¨å¯¼ç±»å‹æ¥å·¥ä½œï¼Œå¹¶ä½¿ç”¨ç±»å‹æç¤ºæä¾›å®¢æˆ·ç«¯çš„ç±»å‹å®‰å…¨ã€‚

è¯·å‚è§ Eden Treatyã€‚

## ä»»åŠ¡

è®©æˆ‘ä»¬åœ¨é¢„è§ˆä¸­ç‚¹å‡»  å›¾æ ‡ï¼Œçœ‹çœ‹è¯·æ±‚æ˜¯å¦‚ä½•è¢«è®°å½•çš„ã€‚

---

---
url: 'https://elysiajs.com/eden/overview.md'
---

# ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨&#x20;

æƒ³è±¡ä¸€ä¸‹ä½ æœ‰ä¸€ä¸ªç©å…·ç«è½¦å¥—ä»¶ã€‚

æ¯ä¸€æ®µç«è½¦è½¨é“éƒ½å¿…é¡»å®Œç¾å¥‘åˆä¸‹ä¸€æ®µï¼Œå°±åƒæ‹¼å›¾ä¸€æ ·ã€‚

ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨å°±åƒç¡®ä¿æ‰€æœ‰è½¨é“çš„æ‹¼æ¥éƒ½æ­£ç¡®ï¼Œä»¥å…ç«è½¦è„±è½¨æˆ–å¡ä½ã€‚

å¯¹äºä¸€ä¸ªæ¡†æ¶æ¥è¯´ï¼Œå…·å¤‡ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨çš„æ„æ€æ˜¯ä½ å¯ä»¥ä»¥ç±»å‹å®‰å…¨çš„æ–¹å¼è¿æ¥å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ã€‚

Elysia æä¾›äº†ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ **æ— ä»£ç ç”Ÿæˆ** å¼€ç®±å³ç”¨ï¼Œä¸ RPC ç±»ä¼¼çš„è¿æ¥å™¨ **Eden**

æ”¯æŒ e2e ç±»å‹å®‰å…¨çš„å…¶ä»–æ¡†æ¶ï¼š

* tRPC
* Remix
* SvelteKit
* Nuxt
* TS-Rest

Elysia å…è®¸ä½ åœ¨æœåŠ¡å™¨ä¸Šæ›´æ”¹ç±»å‹ï¼Œå¹¶ä¼šç«‹å³åæ˜ åˆ°å®¢æˆ·ç«¯ï¼Œå¸®åŠ©è‡ªåŠ¨å®Œæˆå’Œç±»å‹å¼ºåˆ¶ã€‚

## Eden

Eden æ˜¯ä¸€ä¸ªç±»ä¼¼äº RPC çš„å®¢æˆ·ç«¯ï¼Œæ—¨åœ¨ä»…ä½¿ç”¨ TypeScript çš„ç±»å‹æ¨æ–­æ¥è¿æ¥ Elysia **ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨**ï¼Œè€Œæ— éœ€ä»£ç ç”Ÿæˆã€‚

ä½¿ä½ èƒ½å¤Ÿè½»æ¾åŒæ­¥å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç±»å‹ï¼Œä½“ç§¯ä¸åˆ° 2KBã€‚

Eden ç”±ä¸¤ä¸ªæ¨¡å—ç»„æˆï¼š

1. Eden Treaty **ï¼ˆæ¨èï¼‰**: Eden Treaty çš„æ”¹è¿›ç‰ˆæœ¬ RPC
2. Eden Fetch: å…·æœ‰ç±»å‹å®‰å…¨çš„ Fetch ç±»å®¢æˆ·ç«¯ã€‚

ä¸‹é¢æ˜¯æ¯ä¸ªæ¨¡å—çš„æ¦‚è¿°ã€ç”¨ä¾‹å’Œæ¯”è¾ƒã€‚

## Eden Treaty ï¼ˆæ¨èï¼‰

Eden Treaty æ˜¯ä¸€ä¸ªç±»ä¼¼å¯¹è±¡çš„è¡¨ç¤ºï¼Œæä¾› Elysia æœåŠ¡å™¨çš„ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨å’Œæ˜¾è‘—æ”¹å–„çš„å¼€å‘ä½“éªŒã€‚

é€šè¿‡ Eden Treatyï¼Œæˆ‘ä»¬å¯ä»¥ä¸ Elysia æœåŠ¡å™¨è¿›è¡Œäº¤äº’ï¼Œæ”¯æŒå®Œæ•´çš„ç±»å‹å’Œè‡ªåŠ¨å®Œæˆã€ç±»å‹æ”¶çª„çš„é”™è¯¯å¤„ç†ï¼Œä»¥åŠåˆ›å»ºç±»å‹å®‰å…¨çš„å•å…ƒæµ‹è¯•ã€‚

Eden Treaty çš„ç¤ºä¾‹ç”¨æ³•ï¼š

```typescript twoslash
// @filename: server.ts
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .get('/', 'hi')
    .get('/users', () => 'Skadi')
    .put('/nendoroid/:id', ({ body }) => body, {
        body: t.Object({
            name: t.String(),
            from: t.String()
        })
    })
    .get('/nendoroid/:id/name', () => 'Skadi')
    .listen(3000)

export type App = typeof app

// @filename: index.ts
// ---cut---
import { treaty } from '@elysiajs/eden'
import type { App } from './server'

const app = treaty<App>('localhost:3000')

// @noErrors
app.
//  ^|


// è°ƒç”¨ [GET] åœ¨ '/'
const { data } = await app.get()

// è°ƒç”¨ [PUT] åœ¨ '/nendoroid/:id'
const { data: nendoroid, error } = await app.nendoroid({ id: 1895 }).put({
    name: 'Skadi',
    from: 'Arknights'
})
```

## Eden Fetch

ä¸€ä¸ªç±»ä¼¼äº Eden Treaty çš„ Fetch æ›¿ä»£æ–¹æ¡ˆï¼Œé€‚åˆåå¥½ fetch è¯­æ³•çš„å¼€å‘è€…ã€‚

```typescript
import { edenFetch } from '@elysiajs/eden'
import type { App } from './server'

const fetch = edenFetch<App>('http://localhost:3000')

const { data } = await fetch('/name/:name', {
    method: 'POST',
    params: {
        name: 'Saori'
    },
    body: {
        branch: 'Arius',
        type: 'Striker'
    }
})
```

::: tip æ³¨æ„
ä¸ Eden Treaty ä¸åŒï¼ŒEden Fetch ä¸æä¾› Elysia æœåŠ¡å™¨çš„ Web Socket å®ç°
:::

---

---
url: 'https://elysiajs.com/at-glance.md'
---

# ä¸€è§ˆ

Elysia æ˜¯ä¸€ä¸ªç¬¦åˆäººä½“å·¥å­¦çš„ Web æ¡†æ¶ï¼Œç”¨äºä½¿ç”¨ Bun æ„å»ºåç«¯æœåŠ¡å™¨ã€‚

Elysia è®¾è®¡ç®€æ´ä¸”ç±»å‹å®‰å…¨ï¼Œæä¾›äº†ä¸€ä¸ªç†Ÿæ‚‰çš„ APIï¼Œå¹¿æ³›æ”¯æŒ TypeScriptï¼Œå¹¶é’ˆå¯¹ Bun è¿›è¡Œäº†ä¼˜åŒ–ã€‚

ä¸‹é¢æ˜¯åœ¨ Elysia ä¸­çš„ç®€å• hello world ç¤ºä¾‹ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/', 'ä½ å¥½ Elysia')
    .get('/user/:id', ({ params: { id }}) => id)
    .post('/form', ({ body }) => body)
    .listen(3000)
```

æ‰“å¼€ [localhost:3000](http://localhost:3000/) ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ç»“æœæ˜¯â€œHello Elysiaâ€ã€‚

::: tip
å°†é¼ æ ‡æ‚¬åœåœ¨ä»£ç ç‰‡æ®µä¸ŠæŸ¥çœ‹ç±»å‹å®šä¹‰ã€‚

åœ¨æ¨¡æ‹Ÿæµè§ˆå™¨ä¸­ï¼Œç‚¹å‡»è“è‰²é«˜äº®çš„è·¯å¾„å¯ä»¥åˆ‡æ¢è·¯å¾„å¹¶é¢„è§ˆå“åº”ã€‚

Elysia å¯åœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼Œæ‰€çœ‹åˆ°çš„ç»“æœå®é™…ä¸Šæ˜¯ä½¿ç”¨ Elysia æ‰§è¡Œçš„ã€‚
:::

## æ€§èƒ½

åŸºäº Bun åŠé™æ€ä»£ç åˆ†æç­‰å¹¿æ³›ä¼˜åŒ–ï¼Œä½¿ Elysia èƒ½å¤ŸåŠ¨æ€ç”Ÿæˆä¼˜åŒ–ä»£ç ã€‚

Elysia çš„æ€§èƒ½ä¼˜äºå½“å‰å¤§å¤šæ•° Web æ¡†æ¶\[1]ï¼Œç”šè‡³èƒ½åŒ¹é… Golang å’Œ Rust æ¡†æ¶çš„è¡¨ç°\[2]ã€‚

| æ¡†æ¶         | è¿è¡Œæ—¶ | å¹³å‡       | æ™®é€šæ–‡æœ¬   | åŠ¨æ€å‚æ•°       | JSON æ•°æ®   |
| ------------ | ------ | ---------- | ---------- | --------------- | ----------- |
| bun          | bun    | 262,660.433| 326,375.76 | 237,083.18      | 224,522.36  |
| elysia       | bun    | 255,574.717| 313,073.64 | 241,891.57      | 211,758.94  |
| hyper-express| node   | 234,395.837| 311,775.43 | 249,675         | 141,737.08  |
| hono         | bun    | 203,937.883| 239,229.82 | 201,663.43      | 170,920.4   |
| h3           | node   | 96,515.027 | 114,971.87 | 87,935.94       | 86,637.27   |
| oak          | deno   | 46,569.853 | 55,174.24  | 48,260.36       | 36,274.96   |
| fastify      | bun    | 65,897.043 | 92,856.71  | 81,604.66       | 23,229.76   |
| fastify      | node   | 60,322.413 | 71,150.57  | 62,060.26       | 47,756.41   |
| koa          | node   | 39,594.14  | 46,219.64  | 40,961.72       | 31,601.06   |
| express      | bun    | 29,715.537 | 39,455.46  | 34,700.85       | 14,990.3    |
| express      | node   | 15,913.153 | 17,736.92  | 17,128.7        | 12,873.84   |

## TypeScript

Elysia è‡´åŠ›äºå¸®åŠ©ä½ ç¼–å†™æ›´å°‘çš„ TypeScriptã€‚

Elysia çš„ç±»å‹ç³»ç»Ÿç»è¿‡ç»†è‡´è°ƒæ ¡ï¼Œå®ç°è‡ªåŠ¨ä»ä»£ç ä¸­æ¨æ–­ç±»å‹ï¼Œè€Œæ— éœ€æ˜¾å¼ç¼–å†™ TypeScriptï¼ŒåŒæ—¶åœ¨è¿è¡Œæ—¶å’Œç¼–è¯‘æ—¶éƒ½æä¾›ç±»å‹å®‰å…¨ï¼Œç¡®ä¿å¼€å‘ä½“éªŒçš„äººæ€§åŒ–ã€‚

çœ‹çœ‹è¿™ä¸ªä¾‹å­ï¼š

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/user/:id', ({ params: { id } }) => id)
                        // ^?
    .listen(3000)
```

ä¸Šé¢ä»£ç åˆ›å»ºäº†è·¯å¾„å‚æ•° **"id"**ã€‚æ›¿ä»£ `:id` çš„å€¼ä¼šåœ¨è¿è¡Œæ—¶å’Œç±»å‹ä¸­ä¼ é€’ç»™ `params.id`ï¼Œæ— éœ€æ‰‹åŠ¨å£°æ˜ç±»å‹ã€‚

Elysia çš„ç›®æ ‡æ˜¯å¸®åŠ©ä½ å†™æ›´å°‘çš„ TypeScriptï¼Œæ›´å¤šå…³æ³¨ä¸šåŠ¡é€»è¾‘ã€‚è®©æ¡†æ¶å¸®ä½ å¤„ç†å¤æ‚çš„ç±»å‹ã€‚

ä½¿ç”¨ Elysia ä¸å¼ºåˆ¶è¦æ±‚ TypeScriptï¼Œä½†æ¨èä½¿ç”¨ã€‚

## ç±»å‹å®Œæ•´æ€§

æ›´è¿›ä¸€æ­¥ï¼ŒElysia æä¾›äº† **Elysia.t** â€”â€” ä¸€ä¸ªæ¨¡å¼æ„å»ºå™¨ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶å’Œç¼–è¯‘æ—¶å¯¹ç±»å‹å’Œæ•°å€¼è¿›è¡Œæ ¡éªŒï¼Œå½¢æˆæ•°æ®ç±»å‹çš„å”¯ä¸€å¯ä¿¡æ¥æºã€‚

æˆ‘ä»¬æ¥ä¿®æ”¹ä¹‹å‰çš„ä»£ç ï¼Œä½¿å…¶åªæ¥å—æ•°å­—å€¼è€Œéå­—ç¬¦ä¸²ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
    .get('/user/:id', ({ params: { id } }) => id, {
                                // ^?
        params: t.Object({
            id: t.Number()
        })
    })
    .listen(3000)
```

è¿™æ®µä»£ç ç¡®ä¿è·¯å¾„å‚æ•° **id** åœ¨è¿è¡Œæ—¶å’Œç¼–è¯‘æ—¶ï¼ˆç±»å‹å±‚é¢ï¼‰å§‹ç»ˆæ˜¯æ•°å­—ã€‚

::: tip
å°†é¼ æ ‡æ‚¬åœåœ¨ä¸Šè¿°ä»£ç ç‰‡æ®µä¸­çš„ "id" ä»¥æŸ¥çœ‹ç±»å‹å®šä¹‰ã€‚
:::

å€ŸåŠ© Elysia çš„æ¨¡å¼æ„å»ºå™¨ï¼Œæˆ‘ä»¬èƒ½åƒå¼ºç±»å‹è¯­è¨€ä¸€æ ·ï¼Œä½¿ç”¨å”¯ä¸€æ•°æ®æ¥æºç¡®ä¿ç±»å‹å®‰å…¨ã€‚

## æ ‡å‡† Schema

Elysia æ”¯æŒ [Standard Schema](https://github.com/standard-schema/standard-schema)ï¼Œå…è®¸ä½ ä½¿ç”¨å–œçˆ±çš„éªŒè¯åº“ï¼š

* Zod
* Valibot
* ArkType
* Effect Schema
* Yup
* Joi
* [åŠæ›´å¤š](https://github.com/standard-schema/standard-schema)

```typescript twoslash
import { Elysia } from 'elysia'
import { z } from 'zod'
import * as v from 'valibot'

new Elysia()
	.get('/id/:id', ({ params: { id }, query: { name } }) => id, {
	//                           ^?
		params: z.object({
			id: z.coerce.number()
		}),
		query: v.object({
			name: v.literal('Lilith')
		})
	})
	.listen(3000)
```

Elysia ä¼šè‡ªåŠ¨ä»æ¨¡å¼æ¨æ–­ç±»å‹ï¼Œå…è®¸ä½ åŒæ—¶ä½¿ç”¨ç†Ÿæ‚‰çš„éªŒè¯åº“å’Œä¿æŒç±»å‹å®‰å…¨ã€‚

## OpenAPI

Elysia é»˜è®¤é‡‡çº³å¤šç§æ ‡å‡†ï¼Œå¦‚ OpenAPIã€WinterTC å…¼å®¹æ€§å’Œ Standard Schemaï¼Œæ–¹ä¾¿ä½ é›†æˆç»å¤§å¤šæ•°è¡Œä¸šæ ‡å‡†å·¥å…·ï¼Œæˆ–è½»æ¾é›†æˆå·²æœ‰ç†Ÿæ‚‰å·¥å…·ã€‚

ä¾‹å¦‚ï¼Œå›  Elysia é»˜è®¤æ”¯æŒ OpenAPIï¼Œåªéœ€æ·»åŠ ä¸€è¡Œä»£ç å³å¯ç”Ÿæˆ API æ–‡æ¡£ï¼š

```typescript
import { Elysia, t } from 'elysia'
import { openapi } from '@elysiajs/openapi'

new Elysia()
    .use(openapi()) // [!code ++]
    .get('/user/:id', ({ params: { id } }) => id, {
        params: t.Object({
            id: t.Number()
        })
    })
    .listen(3000)
```

é€šè¿‡ OpenAPI æ’ä»¶ï¼Œä½ æ— éœ€é¢å¤–ä»£ç æˆ–ç‰¹æ®Šé…ç½®å³å¯æ— ç¼ç”Ÿæˆ API æ–‡æ¡£é¡µé¢ï¼Œå¹¶è½»æ¾ä¸å›¢é˜Ÿå…±äº«ã€‚

## ä»ç±»å‹ç”Ÿæˆ OpenAPI

Elysia å¯¹ OpenAPI æä¾›äº†æä½³æ”¯æŒï¼Œæ¨¡å¼å¯ç”¨äºæ•°æ®éªŒè¯ã€ç±»å‹æ¨æ–­å’Œ OpenAPI æ³¨è§£ï¼Œæºäºå”¯ä¸€æ•°æ®æ¥æºã€‚

Elysia ä¹Ÿæ”¯æŒç”¨ **ä¸€è¡Œä»£ç ç›´æ¥ä»ç±»å‹ç”Ÿæˆ OpenAPI Schema**ï¼Œå®ç°å®Œæ•´å‡†ç¡®çš„ API æ–‡æ¡£ï¼Œæ— éœ€æ‰‹åŠ¨æ³¨è§£ã€‚

```typescript
import { Elysia, t } from 'elysia'
import { openapi, fromTypes } from '@elysiajs/openapi'

export const app = new Elysia()
    .use(openapi({
    	references: fromTypes() // [!code ++]
    }))
    .get('/user/:id', ({ params: { id } }) => id, {
        params: t.Object({
            id: t.Number()
        })
    })
    .listen(3000)
```

è¿™æ˜¯ Elysia çš„ä¸€ä¸ª **ç‹¬ç‰¹åŠŸèƒ½**ï¼Œä½¿ä½ èƒ½å¤Ÿç›´æ¥ä»ä»£ç ä¸­è·å¾—å®Œæ•´ä¸”å‡†ç¡®çš„ API æ–‡æ¡£ï¼Œæ— éœ€ä»»ä½•æ‰‹åŠ¨æ³¨è§£ã€‚

## ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨

åˆ©ç”¨ Elysiaï¼Œç±»å‹å®‰å…¨ä¸é™äºæœåŠ¡ç«¯ã€‚

å€ŸåŠ© Elysia å’Œå…¶å®¢æˆ·ç«¯åº“ â€œEdenâ€ï¼Œä½ å¯ä»¥åƒ tRPC ä¸€æ ·è‡ªåŠ¨åŒæ­¥ç±»å‹ç»™å‰ç«¯å›¢é˜Ÿã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'
import { openapi, fromTypes } from '@elysiajs/openapi'

export const app = new Elysia()
    .use(openapi({
    	references: fromTypes()
    }))
    .get('/user/:id', ({ params: { id } }) => id, {
        params: t.Object({
            id: t.Number()
        })
    })
    .listen(3000)

export type App = typeof app // [!code ++]
```

åœ¨ä½ çš„å®¢æˆ·ç«¯ä»£ç ä¸­ï¼š

```typescript twoslash
// @filename: server.ts
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .get('/user/:id', ({ params: { id } }) => id, {
        params: t.Object({
            id: t.Number()
        })
    })
    .listen(3000)

export type App = typeof app

// @filename: client.ts
// ---cut---
// client.ts
import { treaty } from '@elysiajs/eden'
import type { App } from './server'

const app = treaty<App>('localhost:3000')

// ä» /user/617 è·å–æ•°æ®
const { data } = await app.user({ id: 617 }).get()
      // ^?

console.log(data)
```

ä½¿ç”¨ Edenï¼Œä½ å¯ä»¥ä½¿ç”¨å·²æœ‰çš„ Elysia ç±»å‹æŸ¥è¯¢ Elysia æœåŠ¡å™¨ï¼Œ**æ— éœ€ä»£ç ç”Ÿæˆ**ï¼Œå¹¶è‡ªåŠ¨åŒæ­¥å‰åç«¯ç±»å‹ã€‚

Elysia ä¸ä»…å¸®åŠ©ä½ æ„å»ºå¯é åç«¯ï¼Œä¹Ÿè‡´åŠ›äºè¿™ä¸ªä¸–ç•Œä¸Šç¾å¥½çš„äº‹ç‰©ã€‚

## ç±»å‹ä¸¥è°¨æ€§

å¤§å¤šæ•°å…·æœ‰ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨çš„æ¡†æ¶é€šå¸¸åªæ¶µç›–â€œç†æƒ³æƒ…å†µâ€ï¼Œå°†é”™è¯¯å¤„ç†å’Œè¾¹ç¼˜æƒ…å†µæ’é™¤åœ¨ç±»å‹ç³»ç»Ÿä¹‹å¤–ã€‚

ç„¶è€Œï¼ŒElysia å¯ä»¥æ¨æ–­ API çš„æ‰€æœ‰å¯èƒ½ç»“æœï¼ŒåŒ…æ‹¬ç”Ÿå‘½å‘¨æœŸäº‹ä»¶å’Œä»£ç åº“ä¸­ä»»ä½•éƒ¨åˆ†çš„å®ã€‚

::: code-group

```typescript twoslash [client.ts]
// @filename: server.ts
import { Elysia, t } from 'elysia'

const plugin = new Elysia()
	.macro({
		auth: {
			cookie: t.Object({
				session: t.String()
			}),
			beforeHandle({ cookie: { session }, status }) {
				if(session.value !== 'valid')
					return status(401)
			}
		}
	})

const app = new Elysia()
	.use(plugin)
    .get('/user/:id', ({ params: { id }, status }) => {
    	if(Math.random() > 0.1)
     		return status(420)
       
       return id
    }, {
    	auth: true,
        params: t.Object({
            id: t.Number()
        })
    })
    .listen(3000)

export type App = typeof app

// @filename: client.ts
// ---cut---
// client.ts
import { treaty } from '@elysiajs/eden'
import type { App } from './server'

const app = treaty<App>('localhost:3000')

// ä» /user/617 è·å–æ•°æ®
const { data, error } = await app.user({ id: 617 }).get()
            // ^?

console.log(data)
```

```typescript twoslash [server.ts]
import { Elysia, t } from 'elysia'

const plugin = new Elysia()
	.macro({
		auth: {
			cookie: t.Object({
				session: t.String()
			}),
			beforeHandle({ cookie: { session }, status }) {
				if(session.value !== 'valid')
					return status(401)
			}
		}
	})

const app = new Elysia()
	.use(plugin)
    .get('/user/:id', ({ params: { id }, status }) => {
    	if(Math.random() > 0.1)
     		return status(420)
       
       return id
    }, {
    	auth: true,
        params: t.Object({
            id: t.Number()
        })
    })
    .listen(3000)
    
export type App = typeof app
```

:::

è¿™æ˜¯ Elysia å¤šå¹´æ¥åœ¨ç±»å‹ç³»ç»ŸæŠ•èµ„å¸¦æ¥çš„ **ç‹¬ç‰¹ä¼˜åŠ¿** ä¹‹ä¸€ã€‚

## è·¨å¹³å°æ€§

Elysia ä¸º Bun è®¾è®¡å¹¶ä¼˜åŒ–äº†åŸç”ŸåŠŸèƒ½ï¼Œä½†**ä¸é™äº Bun**ã€‚

éµå¾ª [WinterTC æ ‡å‡†](https://wintertc.org/) å…è®¸ä½ å°† Elysia éƒ¨ç½²åˆ°ï¼š

* Bun
* [Node.js](/integrations/node)
* [Deno](/integrations/deno)
* [Cloudflare Worker](/integrations/cloudflare-worker)
* [Vercel](/integrations/vercel)
* é€šè¿‡ API è·¯ç”±çš„ [Expo](/integrations/expo)
* é€šè¿‡ API è·¯ç”±çš„ [Nextjs](/integrations/nextjs)
* é€šè¿‡ API è·¯ç”±çš„ [Astro](/integrations/astro)

ä»¥åŠæ›´å¤šï¼è¯·æŸ¥çœ‹ä¾§è¾¹æ ä¸­çš„ `é›†æˆ` éƒ¨åˆ†ï¼Œäº†è§£æ›´å¤šæ”¯æŒçš„è¿è¡Œæ—¶ç¯å¢ƒã€‚

## æˆ‘ä»¬çš„ç¤¾åŒº

æˆ‘ä»¬å¸Œæœ›ä¸ºæ¯ä¸ªäººåˆ›å»ºä¸€ä¸ªå‹å¥½ä¸”æ¬¢è¿çš„ç¤¾åŒºï¼Œé‡‡ç”¨å¯çˆ±ä¸”å¯Œæœ‰æ´»åŠ›çš„è®¾è®¡ï¼ŒåŒ…æ‹¬æˆ‘ä»¬çš„åŠ¨æ¼«å‰ç¥¥ç‰© Elysia é…±ã€‚

æˆ‘ä»¬ç›¸ä¿¡æŠ€æœ¯å¯ä»¥æ—¢å¯çˆ±åˆæœ‰è¶£ï¼Œè€Œéä¸€æˆä¸å˜çš„ä¸¥è‚ƒï¼Œè¿™èƒ½ä¸ºäººä»¬çš„ç”Ÿæ´»å¸¦æ¥ä¹è¶£ã€‚

å³ä½¿å¦‚æ­¤ï¼Œæˆ‘ä»¬ä»ç„¶éå¸¸è®¤çœŸå¯¹å¾… Elysiaï¼Œç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªå¯é çš„ã€é«˜æ€§èƒ½çš„ç”Ÿäº§çº§æ¡†æ¶ï¼Œå¯ä»¥ä¿¡èµ–äºä½ çš„ä¸‹ä¸€ä¸ªé¡¹ç›®ã€‚

Elysia å·²è¢«å…¨çƒä¼—å¤šå…¬å¸å’Œé¡¹ç›®**æŠ•å…¥ç”Ÿäº§ä½¿ç”¨**ï¼ŒåŒ…æ‹¬ [X](https://x.com/shlomiatar/status/1822381556142362734)ã€[å†œä¸šä¸å†œä¸šåˆä½œé“¶è¡Œ](https://github.com/elysiajs/elysia/discussions/1312#discussioncomment-13924470)ã€[Cluely](https://github.com/elysiajs/elysia/discussions/1312#discussioncomment-14420139)ã€[CS.Money](https://github.com/elysiajs/elysia/discussions/1312#discussioncomment-13913513)ã€[Abacate Pay](https://github.com/elysiajs/elysia/discussions/1312#discussioncomment-13922081)ï¼Œå¹¶è¢« GitHub ä¸Šè¶…è¿‡ 10,000 ä¸ªï¼ˆå¼€æºï¼‰é¡¹ç›®ä½¿ç”¨ã€‚è‡ª 2022 å¹´ä»¥æ¥æŒç»­æ´»è·ƒå¼€å‘å’Œç»´æŠ¤ï¼Œæ‹¥æœ‰æ¥è‡ªç¤¾åŒºçš„ä¼—å¤šå¸¸é©»è´¡çŒ®è€…ã€‚

Elysia æ˜¯æ„å»ºä½ çš„ä¸‹ä¸€ä¸ªåç«¯æœåŠ¡å™¨çš„å¯é ä¸”ç”Ÿäº§å°±ç»ªçš„é€‰æ‹©ã€‚

ä»¥ä¸‹æ˜¯ç¤¾åŒºèµ„æºï¼ŒåŠ©ä½ å¿«é€Ÿå…¥é—¨ï¼š

***

1\. è¯·æ±‚/ç§’çš„æµ‹é‡ã€‚åŸºäº Debian 11 ä¸Šçš„åŸºå‡†æµ‹è¯•ï¼Œæ¶‰åŠæŸ¥è¯¢ã€è·¯å¾„å‚æ•°è§£æå’Œå“åº”å¤´è®¾ç½®ï¼Œä½¿ç”¨ Intel i7-13700Kï¼Œæµ‹è¯•æ—¶é—´ä¸º 2023 å¹´ 8 æœˆ 6 æ—¥ï¼ŒåŸºäº Bun 0.7.2ã€‚è¯¦ç»†åŸºå‡†æµ‹è¯•æ¡ä»¶è§ [æ­¤å¤„](https://github.com/SaltyAom/bun-http-framework-benchmark/tree/c7e26fe3f1bfee7ffbd721dbade10ad72a0a14ab#results)ã€‚

2\. åŸºäº [TechEmpower åŸºå‡†æµ‹è¯•ç¬¬ 22 è½®](https://www.techempower.com/benchmarks/#section=data-r22\&hw=ph\&test=composite)ã€‚

---

---
url: 'https://elysiajs.com/essential/route.md'
---

# è·¯ç”±&#x20;

Web æœåŠ¡å™¨ä½¿ç”¨è¯·æ±‚çš„**è·¯å¾„å’Œæ–¹æ³•**æ¥æŸ¥æ‰¾æ­£ç¡®çš„èµ„æºï¼Œè¿™ä¸€è¿‡ç¨‹ç§°ä¸º\*\*â€œè·¯ç”±â€\*\*ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡**HTTP åŠ¨è¯æ–¹æ³•**ã€è·¯å¾„å’ŒåŒ¹é…æ—¶æ‰§è¡Œçš„å‡½æ•°æ¥å®šä¹‰è·¯ç”±ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/', 'ä½ å¥½')
    .get('/hi', 'å—¨')
    .listen(3000)
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¿é—® **http://localhost:3000** æ¥è®¿é—® web æœåŠ¡å™¨ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œweb æµè§ˆå™¨åœ¨è®¿é—®é¡µé¢æ—¶ä¼šå‘é€ GET æ–¹æ³•ã€‚

::: tip
ä½¿ç”¨ä¸Šé¢çš„äº¤äº’å¼æµè§ˆå™¨ï¼Œå°†é¼ æ ‡æ‚¬åœåœ¨è“è‰²é«˜äº®åŒºåŸŸä»¥æŸ¥çœ‹æ¯ä¸ªè·¯å¾„ä¹‹é—´çš„ä¸åŒç»“æœ
:::

## è·¯å¾„ç±»å‹

Elysia ä¸­çš„è·¯å¾„å¯åˆ†ä¸º3ç§ç±»å‹ï¼š

* **é™æ€è·¯å¾„** - é™æ€å­—ç¬¦ä¸²ç”¨äºå®šä½èµ„æº
* **åŠ¨æ€è·¯å¾„** - æ®µå¯ä»¥æ˜¯ä»»ä½•å€¼
* **é€šé…ç¬¦è·¯å¾„** - è·¯å¾„åˆ°æŸä¸ªç‰¹å®šç‚¹å¯ä»¥æ˜¯ä»»ä½•å†…å®¹

ä½ å¯ä»¥å°†æ‰€æœ‰è¿™äº›è·¯å¾„ç±»å‹ç»„åˆèµ·æ¥ï¼Œä¸ºä½ çš„ web æœåŠ¡å™¨è®¾è®¡è¡Œä¸ºã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/id/1', 'é™æ€è·¯å¾„')
    .get('/id/:id', 'åŠ¨æ€è·¯å¾„')
    .get('/id/*', 'é€šé…ç¬¦è·¯å¾„')
    .listen(3000)
```

## é™æ€è·¯å¾„

é™æ€è·¯å¾„æ˜¯ç¡¬ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œç”¨äºå®šä½æœåŠ¡å™¨ä¸Šçš„èµ„æºã€‚

```ts
import { Elysia } from 'elysia'

new Elysia()
	.get('/hello', 'hello')
	.get('/hi', 'hi')
	.listen(3000)
```

## åŠ¨æ€è·¯å¾„

åŠ¨æ€è·¯å¾„åŒ¹é…æŸéƒ¨åˆ†å†…å®¹å¹¶æ•è·è¯¥å€¼å¾—åˆ°é¢å¤–ä¿¡æ¯ã€‚

å®šä¹‰åŠ¨æ€è·¯å¾„æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å†’å· `:` åè·Ÿåç§°ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/id/:id', ({ params: { id } }) => id)
                      // ^?
    .listen(3000)
```

è¿™é‡Œé€šè¿‡ `/id/:id` åˆ›å»ºäº†ä¸€ä¸ªåŠ¨æ€è·¯å¾„ã€‚Elysia ä¼šæ•è· `:id` æ®µçš„å€¼ï¼Œæ¯”å¦‚ **/id/1**ã€**/id/123**ã€**/id/anything**ã€‚

è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä»¥ä¸‹å“åº”ï¼š

| è·¯å¾„                   | å“åº”  |
| ---------------------- | ------- |
| /id/1                  | 1       |
| /id/123                | 123     |
| /id/anything           | anything  |
| /id/anything?name=salt | anything  |
| /id                    | æœªæ‰¾åˆ°  |
| /id/anything/rest      | æœªæ‰¾åˆ°  |

åŠ¨æ€è·¯å¾„éå¸¸é€‚åˆåŒ…å«å¦‚ ID è¿™ç±»ç¨åå¯ç”¨çš„å˜é‡ã€‚

æˆ‘ä»¬å°†å‘½åå˜é‡è·¯å¾„ç§°ä¸º**è·¯å¾„å‚æ•°**ï¼Œç®€ç§°**params**ã€‚

### å¤šä¸ªè·¯å¾„å‚æ•°

ä½ å¯ä»¥æœ‰å¤šä¸ªè·¯å¾„å‚æ•°ï¼Œå®ƒä»¬ä¼šå­˜å‚¨åœ¨ä¸€ä¸ª `params` å¯¹è±¡ä¸­ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/id/:id', ({ params: { id } }) => id)
    .get('/id/:id/:name', ({ params: { id, name } }) => id + ' ' + name)
                             // ^?
    .listen(3000)
```

æœåŠ¡å™¨å°†è¿”å›ä»¥ä¸‹å“åº”ï¼š

| è·¯å¾„                   | å“åº”      |
| ---------------------- | ------------- |
| /id/1                  | 1             |
| /id/123                | 123           |
| /id/anything           | anything      |
| /id/anything?name=salt | anything      |
| /id                    | æœªæ‰¾åˆ°     |
| /id/anything/rest      | anything rest |

## å¯é€‰è·¯å¾„å‚æ•°

æœ‰æ—¶æˆ‘ä»¬æƒ³è®©é™æ€è·¯å¾„ä¸åŠ¨æ€è·¯å¾„è§£æåˆ°ç›¸åŒçš„å¤„ç†ç¨‹åºã€‚

å¯ä»¥é€šè¿‡åœ¨å‚æ•°åç§°ååŠ é—®å· `?` æ¥ä½¿è·¯å¾„å‚æ•°å¯é€‰ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/id/:id?', ({ params: { id } }) => `id ${id}`)
                          // ^?
    .listen(3000)
```

## é€šé…ç¬¦

åŠ¨æ€è·¯å¾„åªæ•è·å•ä¸ªæ®µï¼Œè€Œé€šé…ç¬¦è·¯å¾„å¯æ•è·å‰©ä½™è·¯å¾„ã€‚

å®šä¹‰é€šé…ç¬¦ä½¿ç”¨æ˜Ÿå· `*`ã€‚

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .get('/id/*', ({ params }) => params['*'])
                    // ^?
    .listen(3000)
```

## è·¯å¾„ä¼˜å…ˆçº§

Elysia çš„è·¯å¾„ä¼˜å…ˆçº§å¦‚ä¸‹ï¼š

1. é™æ€è·¯å¾„
2. åŠ¨æ€è·¯å¾„
3. é€šé…ç¬¦

å¦‚æœé™æ€è·¯å¾„å’ŒåŠ¨æ€è·¯å¾„åŒæ—¶åŒ¹é…ï¼ŒElysia å°†ä¼˜å…ˆè§£æé™æ€è·¯å¾„ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/id/1', 'é™æ€è·¯å¾„')
    .get('/id/:id', 'åŠ¨æ€è·¯å¾„')
    .get('/id/*', 'é€šé…ç¬¦è·¯å¾„')
    .listen(3000)
```

## HTTP åŠ¨è¯

HTTP å®šä¹‰äº†ä¸€ç»„è¯·æ±‚æ–¹æ³•ï¼ŒæŒ‡ç¤ºå¯¹ç»™å®šèµ„æºæ‰§è¡Œçš„æ“ä½œã€‚

å¸¸è§çš„ HTTP åŠ¨è¯åŒ…æ‹¬ï¼š

### GET

GET è¯·æ±‚ä»…ç”¨äºè·å–æ•°æ®ã€‚

### POST

å‘æŒ‡å®šèµ„æºæäº¤æœ‰æ•ˆè´Ÿè½½ï¼Œé€šå¸¸å¼•èµ·çŠ¶æ€å˜åŒ–æˆ–å‰¯ä½œç”¨ã€‚

### PUT

ç”¨è¯·æ±‚è´Ÿè½½æ›¿æ¢ç›®æ ‡èµ„æºçš„æ‰€æœ‰å½“å‰è¡¨ç¤ºã€‚

### PATCH

å¯¹èµ„æºè¿›è¡Œéƒ¨åˆ†ä¿®æ”¹ã€‚

### DELETE

åˆ é™¤æŒ‡å®šèµ„æºã€‚

***

ä¸ºäº†æ”¯æŒä¸åŒåŠ¨è¯ï¼ŒElysia å†…ç½®å¤šä¸ª HTTP åŠ¨è¯APIï¼Œä¸ `Elysia.get` ç±»ä¼¼ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/', 'ä½ å¥½')
    .post('/hi', 'å—¨')
    .listen(3000)
```

Elysia çš„ HTTP æ–¹æ³•æ¥å—ä»¥ä¸‹å‚æ•°ï¼š

* **path**: è·¯å¾„å
* **function**: å“åº”å®¢æˆ·ç«¯çš„å‡½æ•°
* **hook**: é¢å¤–å…ƒæ•°æ®

ä½ å¯ä»¥åœ¨ [HTTP è¯·æ±‚æ–¹æ³•](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods) é˜…è¯»æ›´å¤šå…³äº HTTP æ–¹æ³•çš„å†…å®¹ã€‚

## è‡ªå®šä¹‰æ–¹æ³•

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `Elysia.route` å®šä¹‰è‡ªå®šä¹‰ HTTP æ–¹æ³•ã€‚

```typescript
import { Elysia } from 'elysia'

const app = new Elysia()
    .get('/get', 'hello')
    .post('/post', 'hi')
    .route('M-SEARCH', '/m-search', 'connect') // [!code ++]
    .listen(3000)
```

**Elysia.route** æ¥å—ä»¥ä¸‹å‚æ•°ï¼š

* **method**: HTTP åŠ¨è¯
* **path**: è·¯å¾„å
* **function**: å“åº”å®¢æˆ·ç«¯çš„å‡½æ•°
* **hook**: é¢å¤–å…ƒæ•°æ®

::: tip
åŸºäº [RFC 7231](https://www.rfc-editor.org/rfc/rfc7231#section-4.1)ï¼ŒHTTP åŠ¨è¯æ˜¯åŒºåˆ†å¤§å°å†™çš„ã€‚

å»ºè®®ä¸º Elysia è‡ªå®šä¹‰ HTTP åŠ¨è¯ä½¿ç”¨å¤§å†™å‘½åã€‚
:::

### ALL æ–¹æ³•

Elysia æä¾›äº† `Elysia.all`ï¼Œç”¨äºå¤„ç†æŒ‡å®šè·¯å¾„çš„ä»»æ„ HTTP æ–¹æ³•ï¼ŒAPI ä¸ **Elysia.get** å’Œ **Elysia.post** ä¸€è‡´ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .all('/', 'å—¨')
    .listen(3000)
```

æ‰€æœ‰åŒ¹é…è¯¥è·¯å¾„çš„ HTTP æ–¹æ³•éƒ½å°†å¦‚ä¸‹å¤„ç†ï¼š
| è·¯å¾„ | æ–¹æ³• | ç»“æœ |
| ---- | ---- | ---- |
| /    | GET  | å—¨   |
| /    | POST | å—¨   |
| /    | DELETE | å—¨ |

## å¤„ç†

å¤§å¤šæ•°å¼€å‘è€…ä½¿ç”¨ REST å®¢æˆ·ç«¯å¦‚ Postmanã€Insomnia æˆ– Hoppscotch æµ‹è¯• APIã€‚

ä½† Elysia ä¹Ÿå¯ä»¥é€šè¿‡ `Elysia.handle` ç¼–ç¨‹åœ°æµ‹è¯•ã€‚

```typescript
import { Elysia } from 'elysia'

const app = new Elysia()
    .get('/', 'ä½ å¥½')
    .post('/hi', 'å—¨')
    .listen(3000)

app.handle(new Request('http://localhost/')).then(console.log)
```

**Elysia.handle** æ˜¯å¤„ç†å‘é€ç»™æœåŠ¡å™¨çš„çœŸå®è¯·æ±‚çš„å‡½æ•°ã€‚

::: tip
ä¸å•å…ƒæµ‹è¯•ä¸­çš„ mock ä¸åŒï¼Œ**ä½ å¯ä»¥æœŸæœ›å®ƒè¡¨ç°å¾—åƒå‘é€åˆ°æœåŠ¡å™¨çš„çœŸå®è¯·æ±‚**ã€‚

åŒæ—¶ï¼Œä¹Ÿæ–¹ä¾¿æ¨¡æ‹Ÿæˆ–ç¼–å†™å•å…ƒæµ‹è¯•ã€‚
:::

## ç»„

åœ¨æ„å»º web æœåŠ¡å™¨æ—¶ï¼Œå¸¸å¸¸æœ‰å¤šä¸ªè·¯ç”±å…±äº«ç›¸åŒå‰ç¼€ï¼š

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .post('/user/sign-in', 'ç™»å½•')
    .post('/user/sign-up', 'æ³¨å†Œ')
    .post('/user/profile', 'ä¸ªäººèµ„æ–™')
    .listen(3000)
```

è¿™å¯ä»¥ç”¨ `Elysia.group` ä¼˜åŒ–ï¼Œå°†å®ƒä»¬åˆ†ç»„å¹¶ç»Ÿä¸€æ·»åŠ å‰ç¼€ï¼š

```typescript twoslash
import { Elysia } from 'elysia'

new Elysia()
    .group('/user', (app) =>
        app
            .post('/sign-in', 'ç™»å½•')
            .post('/sign-up', 'æ³¨å†Œ')
            .post('/profile', 'ä¸ªäººèµ„æ–™')
    )
    .listen(3000)
```

è¿™æ®µä»£ç è¡Œä¸ºä¸ä¹‹å‰ç¤ºä¾‹ç›¸åŒï¼Œè·¯å¾„ç»“æ„ï¼š

| è·¯å¾„          | ç»“æœ  |
| ------------- | ------- |
| /user/sign-in | ç™»å½• |
| /user/sign-up | æ³¨å†Œ |
| /user/profile | ä¸ªäººèµ„æ–™ |

`.group()` è¿˜å¯æ¥å—å¯é€‰ä¿æŠ¤å‚æ•°ï¼Œå‡å°‘åŒæ—¶åº”ç”¨ç»„å’Œä¿æŠ¤å±‚çš„æ ·æ¿ä»£ç ï¼š

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
    .group(
        '/user',
        {
            body: t.Literal('Rikuhachima Aru')
        },
        (app) => app
            .post('/sign-in', 'ç™»å½•')
            .post('/sign-up', 'æ³¨å†Œ')
            .post('/profile', 'ä¸ªäººèµ„æ–™')
    )
    .listen(3000)
```

æ›´å¤šåˆ†ç»„å’Œä¿æŠ¤ä¿¡æ¯è§ [ä½œç”¨åŸŸ](/essential/plugin.html#scope)ã€‚

### å‰ç¼€

è¿˜å¯ä»¥ç»™æ„é€ å‡½æ•°ä¼ å…¥ **prefix**ï¼Œå°†ä¸€ç»„è·¯ç”±åˆ†ç¦»åˆ°å•ç‹¬çš„æ’ä»¶å®ä¾‹ï¼Œé¿å…åµŒå¥—ï¼š

```typescript
import { Elysia } from 'elysia'

const users = new Elysia({ prefix: '/user' })
    .post('/sign-in', 'ç™»å½•')
    .post('/sign-up', 'æ³¨å†Œ')
    .post('/profile', 'ä¸ªäººèµ„æ–™')

new Elysia()
    .use(users)
    .get('/', 'ä½ å¥½ï¼Œä¸–ç•Œ')
    .listen(3000)
```

---

---
url: 'https://elysiajs.com/integrations/cheat-sheet.md'
---

# é€ŸæŸ¥è¡¨

è¿™é‡Œæ˜¯ä¸€äº›å¸¸è§ Elysia æ¨¡å¼çš„å¿«é€Ÿæ¦‚è¿°

## Hello World

ä¸€ä¸ªç®€å•çš„ hello world

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/', () => 'Hello World')
    .listen(3000)
```

## è‡ªå®šä¹‰ HTTP æ–¹æ³•

ä½¿ç”¨è‡ªå®šä¹‰ HTTP æ–¹æ³•/åŠ¨è¯å®šä¹‰è·¯ç”±

å‚è§ [è·¯ç”±](/essential/route.html#custom-method)

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/hi', () => 'Hi')
    .post('/hi', () => 'From Post')
    .put('/hi', () => 'From Put')
    .route('M-SEARCH', '/hi', () => 'Custom Method')
    .listen(3000)
```

## è·¯å¾„å‚æ•°

ä½¿ç”¨åŠ¨æ€è·¯å¾„å‚æ•°

å‚è§ [è·¯å¾„](/essential/route.html#path-type)

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/id/:id', ({ params: { id } }) => id)
    .get('/rest/*', () => 'Rest')
    .listen(3000)
```

## è¿”å› JSON

Elysia ä¼šè‡ªåŠ¨å°†å“åº”è½¬æ¢ä¸º JSON

å‚è§ [å¤„ç†å™¨](/essential/handler.html)

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/json', () => {
        return {
            hello: 'Elysia'
        }
    })
    .listen(3000)
```

## è¿”å›æ–‡ä»¶

æ–‡ä»¶å¯ä»¥ä½œä¸º formdata å“åº”è¿”å›

å“åº”å¿…é¡»æ˜¯ 1 çº§æ·±åº¦å¯¹è±¡

```typescript
import { Elysia, file } from 'elysia'

new Elysia()
    .get('/json', () => {
        return {
            hello: 'Elysia',
            image: file('public/cat.jpg')
        }
    })
    .listen(3000)
```

## å¤´éƒ¨å’ŒçŠ¶æ€

è®¾ç½®è‡ªå®šä¹‰å¤´éƒ¨å’ŒçŠ¶æ€ç 

å‚è§ [å¤„ç†å™¨](/essential/handler.html)

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/', ({ set, status }) => {
        set.headers['x-powered-by'] = 'Elysia'

        return status(418, "I'm a teapot")
    })
    .listen(3000)
```

## ç»„

ä¸ºå­è·¯ç”±å®šä¹‰ä¸€æ¬¡å‰ç¼€

å‚è§ [ç»„](/essential/route.html#group)

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get("/", () => "Hi")
    .group("/auth", app => {
        return app
            .get("/", () => "Hi")
            .post("/sign-in", ({ body }) => body)
            .put("/sign-up", ({ body }) => body)
    })
    .listen(3000)
```

## æ¨¡å¼

å¼ºåˆ¶è·¯ç”±çš„æ•°æ®ç±»å‹

å‚è§ [éªŒè¯](/essential/validation)

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
    .post('/mirror', ({ body: { username } }) => username, {
        body: t.Object({
            username: t.String(),
            password: t.String()
        })
    })
    .listen(3000)
```

## æ–‡ä»¶ä¸Šä¼ 

è¯·å‚è§ [éªŒè¯#æ–‡ä»¶](/essential/validation#file)

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.post('/body', ({ body }) => body, {
                    // ^?





		body: t.Object({
			file: t.File({ format: 'image/*' }),
			multipleFiles: t.Files()
		})
	})
	.listen(3000)
```

## ç”Ÿå‘½å‘¨æœŸé’©å­

æŒ‰é¡ºåºæ‹¦æˆª Elysia äº‹ä»¶

å‚è§ [ç”Ÿå‘½å‘¨æœŸ](/essential/life-cycle.html)

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
    .onRequest(() => {
        console.log('On request')
    })
    .on('beforeHandle', () => {
        console.log('Before handle')
    })
    .post('/mirror', ({ body }) => body, {
        body: t.Object({
            username: t.String(),
            password: t.String()
        }),
        afterHandle: () => {
            console.log("After handle")
        }
    })
    .listen(3000)
```

## å®ˆå«

å¼ºåˆ¶å­è·¯ç”±çš„æ•°æ®ç±»å‹

å‚è§ [èŒƒå›´](/essential/plugin.html#scope)

```typescript twoslash
// @errors: 2345
import { Elysia, t } from 'elysia'

new Elysia()
    .guard({
        response: t.String()
    }, (app) => app
        .get('/', () => 'Hi')
        // æ— æ•ˆ: ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå¹¶ä¸” TypeScript ä¼šæŠ¥å‘Šé”™è¯¯
        .get('/invalid', () => 1)
    )
    .listen(3000)
```

## è‡ªå®šä¹‰ä¸Šä¸‹æ–‡

å‘è·¯ç”±ä¸Šä¸‹æ–‡æ·»åŠ è‡ªå®šä¹‰å˜é‡

å‚è§ [ä¸Šä¸‹æ–‡](/essential/handler.html#context)

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .state('version', 1)
    .decorate('getDate', () => Date.now())
    .get('/version', ({
        getDate,
        store: { version }
    }) => `${version} ${getDate()}`)
    .listen(3000)
```

## é‡å®šå‘

é‡å®šå‘å“åº”

å‚è§ [å¤„ç†å™¨](/essential/handler.html#redirect)

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .get('/', () => 'hi')
    .get('/redirect', ({ redirect }) => {
        return redirect('/')
    })
    .listen(3000)
```

## æ’ä»¶

åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å®ä¾‹

å‚è§ [æ’ä»¶](/essential/plugin)

```typescript
import { Elysia } from 'elysia'

const plugin = new Elysia()
    .state('plugin-version', 1)
    .get('/hi', () => 'hi')

new Elysia()
    .use(plugin)
    .get('/version', ({ store }) => store['plugin-version'])
    .listen(3000)
```

## Web Socket

ä½¿ç”¨ Web Socket åˆ›å»ºå®æ—¶è¿æ¥

å‚è§ [Web Socket](/patterns/websocket)

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .ws('/ping', {
        message(ws, message) {
            ws.send('hello ' + message)
        }
    })
    .listen(3000)
```

## OpenAPI æ–‡æ¡£

ä½¿ç”¨ Scalar (æˆ–å¯é€‰çš„ Swagger) åˆ›å»ºäº¤äº’å¼æ–‡æ¡£

å‚è§ [openapi](/plugins/openapi.html)

```typescript
import { Elysia } from 'elysia'
import { openapi } from '@elysiajs/openapi'

const app = new Elysia()
    .use(openapi())
    .listen(3000)

console.log(`åœ¨æµè§ˆå™¨ä¸­è®¿é—® "${app.server!.url}openapi" æŸ¥çœ‹æ–‡æ¡£`);
```

## å•å…ƒæµ‹è¯•

ç¼–å†™ Elysia åº”ç”¨çš„å•å…ƒæµ‹è¯•

å‚è§ [å•å…ƒæµ‹è¯•](/patterns/unit-test)

```typescript
// test/index.test.ts
import { describe, expect, it } from 'bun:test'
import { Elysia } from 'elysia'

describe('Elysia', () => {
    it('è¿”å›å“åº”', async () => {
        const app = new Elysia().get('/', () => 'hi')

        const response = await app
            .handle(new Request('http://localhost/'))
            .then((res) => res.text())

        expect(response).toBe('hi')
    })
})
```

## è‡ªå®šä¹‰ä¸»ä½“è§£æå™¨

ä¸ºè§£æä¸»ä½“åˆ›å»ºè‡ªå®šä¹‰é€»è¾‘

å‚è§ [è§£æ](/essential/life-cycle.html#parse)

```typescript
import { Elysia } from 'elysia'

new Elysia()
    .onParse(({ request, contentType }) => {
        if (contentType === 'application/custom-type')
            return request.text()
    })
```

## GraphQL

ä½¿ç”¨ GraphQL Yoga æˆ– Apollo åˆ›å»ºè‡ªå®šä¹‰ GraphQL æœåŠ¡å™¨

å‚è§ [GraphQL Yoga](/plugins/graphql-yoga)

```typescript
import { Elysia } from 'elysia'
import { yoga } from '@elysiajs/graphql-yoga'

const app = new Elysia()
    .use(
        yoga({
            typeDefs: /* GraphQL */`
                type Query {
                    hi: String
                }
            `,
            resolvers: {
                Query: {
                    hi: () => 'Hello from Elysia'
                }
            }
        })
    )
    .listen(3000)
```

---

---
url: 'https://elysiajs.com/patterns/deploy.md'
---

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

æœ¬é¡µé¢æ˜¯å…³äºå¦‚ä½•å°† Elysia éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒçš„æŒ‡å—ã€‚

## é›†ç¾¤æ¨¡å¼

Elysia é»˜è®¤æ˜¯å•çº¿ç¨‹çš„ã€‚ä¸ºäº†åˆ©ç”¨å¤šæ ¸ CPUï¼Œæˆ‘ä»¬å¯ä»¥ä»¥é›†ç¾¤æ¨¡å¼è¿è¡Œ Elysiaã€‚

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª **index.ts** æ–‡ä»¶ï¼Œä» **server.ts** å¯¼å…¥æˆ‘ä»¬çš„ä¸»æœåŠ¡å™¨ï¼Œå¹¶æ ¹æ®å¯ç”¨çš„ CPU æ ¸å¿ƒæ•°é‡æ´¾ç”Ÿå¤šä¸ªå·¥ä½œè¿›ç¨‹ã€‚

::: code-group

```ts [src/index.ts]
import cluster from 'node:cluster'
import os from 'node:os'
import process from 'node:process'

if (cluster.isPrimary) {
  	for (let i = 0; i < os.availableParallelism(); i++)
    	cluster.fork()
} else {
  	await import('./server')
  	console.log(`Worker ${process.pid} started`)
}
```

```ts [src/server.ts]
import { Elysia } from 'elysia'

new Elysia()
	.get('/', () => 'Hello World!')
	.listen(3000)
```

:::

è¿™å°†ç¡®ä¿ Elysia è¿è¡Œäºå¤šä¸ª CPU æ ¸å¿ƒä¸Šã€‚

::: tip
Elysia åœ¨ Bun ä¸Šé»˜è®¤ä½¿ç”¨ SO\_REUSEPORTï¼Œè¿™å…è®¸å¤šä¸ªå®ä¾‹ç›‘å¬åŒä¸€ç«¯å£ã€‚æ­¤åŠŸèƒ½ä»…åœ¨ Linux ä¸Šæœ‰æ•ˆã€‚
:::

## ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶

æˆ‘ä»¬å»ºè®®åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¹‹å‰è¿è¡Œæ„å»ºå‘½ä»¤ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šæ˜¾è‘—å‡å°‘å†…å­˜ä½¿ç”¨å’Œæ–‡ä»¶å¤§å°ã€‚

æˆ‘ä»¬æ¨èä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°† Elysia ç¼–è¯‘æˆå•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼š

```bash
bun build \
	--compile \
	--minify-whitespace \
	--minify-syntax \
	--target bun \
	--outfile server \
	src/index.ts
```

è¿™å°†ç”Ÿæˆä¸€ä¸ªå¯ç§»æ¤çš„äºŒè¿›åˆ¶æ–‡ä»¶ `server`ï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡Œå®ƒæ¥å¯åŠ¨æœåŠ¡å™¨ã€‚

å°†æœåŠ¡å™¨ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶é€šå¸¸ä¼šæ¯”å¼€å‘ç¯å¢ƒæ˜¾è‘—å‡å°‘ 2-3 å€çš„å†…å­˜ä½¿ç”¨ã€‚

è¿™ä¸ªå‘½ä»¤æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬æ¥æ‹†è§£è¯´æ˜ï¼š

1. **--compile** ç¼–è¯‘ TypeScript ä¸ºäºŒè¿›åˆ¶
2. **--minify-whitespace** ç§»é™¤ä¸å¿…è¦çš„ç©ºç™½
3. **--minify-syntax** å‹ç¼© JavaScript è¯­æ³•ä»¥å‡å°‘æ–‡ä»¶å¤§å°
4. **--target bun** ä¸º Bun è¿è¡Œæ—¶ä¼˜åŒ–äºŒè¿›åˆ¶
5. **--outfile server** è¾“å‡ºäºŒè¿›åˆ¶æ–‡ä»¶ä¸º `server`
6. **src/index.ts** æœåŠ¡å™¨çš„å…¥å£æ–‡ä»¶ï¼ˆä»£ç åŸºç¡€ï¼‰

è¦å¯åŠ¨æœåŠ¡å™¨ï¼Œåªéœ€è¿è¡Œè¯¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

```bash
./server
```

ä¸€æ—¦äºŒè¿›åˆ¶æ–‡ä»¶ç¼–è¯‘å®Œæˆï¼Œæ‚¨æ— éœ€åœ¨æœºå™¨ä¸Šå®‰è£… `Bun` æ¥è¿è¡ŒæœåŠ¡å™¨ã€‚

è¿™éå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºéƒ¨ç½²æœåŠ¡å™¨æ— éœ€å®‰è£…é¢å¤–è¿è¡Œæ—¶å³å¯è¿è¡Œï¼Œä½¿äºŒè¿›åˆ¶æ–‡ä»¶å…·å¤‡å¯ç§»æ¤æ€§ã€‚

### ç›®æ ‡å¹³å°

æ‚¨ä¹Ÿå¯ä»¥æ·»åŠ  `--target` æ ‡å¿—æ¥é’ˆå¯¹ç›®æ ‡å¹³å°ä¼˜åŒ–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

```bash
bun build \
	--compile \
	--minify-whitespace \
	--minify-syntax \
	--target bun-linux-x64 \
	--outfile server \
	src/index.ts
```

ä»¥ä¸‹æ˜¯å¯ç”¨çš„ç›®æ ‡åˆ—è¡¨ï¼š
| ç›®æ ‡                      | æ“ä½œç³»ç»Ÿ         | æ¶æ„          | Modern | åŸºçº¿      | Libc  |
|--------------------------|------------------|--------------|--------|----------|-------|
| bun-linux-x64           | Linux            | x64          | âœ…      | âœ…        | glibc |
| bun-linux-arm64         | Linux            | arm64        | âœ…      | N/A      | glibc |
| bun-windows-x64         | Windows          | x64          | âœ…      | âœ…        | -     |
| bun-windows-arm64       | Windows          | arm64        | âŒ      | âŒ        | -     |
| bun-darwin-x64          | macOS            | x64          | âœ…      | âœ…        | -     |
| bun-darwin-arm64        | macOS            | arm64        | âœ…      | N/A      | -     |
| bun-linux-x64-musl      | Linux            | x64          | âœ…      | âœ…        | musl  |
| bun-linux-arm64-musl    | Linux            | arm64        | âœ…      | N/A      | musl  |

### ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ --minify

Bun ç¡®å®æœ‰ `--minify` æ ‡å¿—ï¼Œç”¨äºå‹ç¼©äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ [OpenTelemetry](/plugins/opentelemetry)ï¼Œå®ƒä¼šå°†å‡½æ•°åç¼©å‡ä¸ºå•ä¸ªå­—ç¬¦ã€‚

è¿™ä½¿å¾—è¿½è¸ªæ¯”é¢„æœŸæ›´å›°éš¾ï¼Œå› ä¸º OpenTelemetry ä¾èµ–äºå‡½æ•°åã€‚

ä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä¸ä½¿ç”¨ OpenTelemetryï¼Œåˆ™å¯ä»¥é€‰æ‹©ä½¿ç”¨ `--minify`ï¼š

```bash
bun build \
	--compile \
	--minify \
	--outfile server \
	src/index.ts
```

### æƒé™

ä¸€äº› Linux å‘è¡Œç‰ˆå¯èƒ½æ— æ³•ç›´æ¥è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ Linuxï¼Œå»ºè®®ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶å¯ç”¨å¯æ‰§è¡Œæƒé™ï¼š

```bash
chmod +x ./server

./server
```

### æœªçŸ¥çš„éšæœºä¸­æ–‡é”™è¯¯

å¦‚æœæ‚¨å°è¯•å°†äºŒè¿›åˆ¶æ–‡ä»¶éƒ¨ç½²åˆ°æœåŠ¡å™¨ä½†æ— æ³•è¿è¡Œï¼Œå¹¶å‡ºç°éšæœºä¸­æ–‡å­—ç¬¦é”™è¯¯ï¼Œè¿™æ„å‘³ç€æ‚¨è¿è¡Œçš„æœºå™¨ **ä¸æ”¯æŒ AVX2**ã€‚

ä¸å¹¸çš„æ˜¯ï¼ŒBun è¦æ±‚æœºå™¨å¿…é¡»å…·å¤‡ `AVX2` ç¡¬ä»¶æ”¯æŒã€‚

æ®æˆ‘ä»¬æ‰€çŸ¥ï¼Œå½“å‰æ²¡æœ‰æ›¿ä»£æ–¹æ¡ˆã€‚

## ç¼–è¯‘ä¸º JavaScript

å¦‚æœæ‚¨æ— æ³•ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶æˆ–æ‚¨åœ¨ Windows æœåŠ¡å™¨ä¸Šè¿›è¡Œéƒ¨ç½²ã€‚

æ‚¨å¯ä»¥å°†æœåŠ¡å™¨æ‰“åŒ…ä¸ºä¸€ä¸ª JavaScript æ–‡ä»¶ã€‚

```bash
bun build \
	--minify-whitespace \
	--minify-syntax \
	--outfile ./dist/index.js \
	src/index.ts
```

è¿™å°†ç”Ÿæˆä¸€ä¸ªå¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²çš„å•ä¸ªå¯ç§»æ¤çš„ JavaScript æ–‡ä»¶ã€‚

```bash
NODE_ENV=production bun ./dist/index.js
```

## Docker

åœ¨ Docker ä¸Šï¼Œæˆ‘ä»¬å»ºè®®å§‹ç»ˆç¼–è¯‘ä¸ºäºŒè¿›åˆ¶ä»¥å‡å°‘åŸºç¡€é•œåƒçš„å¼€é”€ã€‚

ä»¥ä¸‹æ˜¯ä½¿ç”¨äºŒè¿›åˆ¶çš„ Distroless é•œåƒçš„ç¤ºä¾‹ã€‚

```dockerfile [Dockerfile]
FROM oven/bun AS build

WORKDIR /app

# ç¼“å­˜ä¾èµ–å®‰è£…
COPY package.json package.json
COPY bun.lock bun.lock

RUN bun install

COPY ./src ./src

ENV NODE_ENV=production

RUN bun build \
	--compile \
	--minify-whitespace \
	--minify-syntax \
	--outfile server \
	src/index.ts

FROM gcr.io/distroless/base

WORKDIR /app

COPY --from=build /app/server server

ENV NODE_ENV=production

CMD ["./server"]

EXPOSE 3000
```

### OpenTelemetry

å¦‚æœæ‚¨ä½¿ç”¨ [OpenTelemetry](/patterns/opentelemetry) æ¥éƒ¨ç½²ç”Ÿäº§æœåŠ¡å™¨ã€‚

ç”±äº OpenTelemetry ä¾èµ–äºçŒ´å­è¡¥ä¸ `node_modules/<library>`ï¼Œä¸ºäº†ç¡®ä¿ç›¸å…³å·¥å…·æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šä¾›å…¶ä½¿ç”¨çš„åº“ä¸ºå¤–éƒ¨æ¨¡å—ï¼Œä»¥å°†å…¶æ’é™¤åœ¨æ‰“åŒ…ä¹‹å¤–ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ `@opentelemetry/instrumentation-pg` æ¥å¯¹ `pg` åº“è¿›è¡Œä»ªè¡¨åŒ–ï¼Œæˆ‘ä»¬éœ€è¦å°† `pg` æ’é™¤åœ¨æ‰“åŒ…ä¹‹å¤–ï¼Œå¹¶ç¡®ä¿å®ƒä» `node_modules/pg` å¯¼å…¥ã€‚

ä¸ºä½¿è¿™ä¸€åˆ‡æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `--external pg` å°† `pg` æŒ‡å®šä¸ºå¤–éƒ¨æ¨¡å—ï¼š

```bash
bun build --compile --external pg --outfile server src/index.ts
```

è¿™å‘Šè¯‰ bun ä¸å°† `pg` æ‰“åŒ…åˆ°æœ€ç»ˆè¾“å‡ºæ–‡ä»¶ä¸­ï¼Œå¹¶å°†åœ¨è¿è¡Œæ—¶ä» `node_modules` ç›®å½•å¯¼å…¥ã€‚å› æ­¤ï¼Œåœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šï¼Œæ‚¨è¿˜å¿…é¡»ä¿ç•™ `node_modules` ç›®å½•ã€‚

å»ºè®®åœ¨ `package.json` ä¸­å°†åº”åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šå¯ç”¨çš„åŒ…æŒ‡å®šä¸º `dependencies`ï¼Œå¹¶ä½¿ç”¨ `bun install --production` ä»…å®‰è£…ç”Ÿäº§ä¾èµ–é¡¹ã€‚

```json
{
	"dependencies": {
		"pg": "^8.15.6"
	},
	"devDependencies": {
		"@elysiajs/opentelemetry": "^1.2.0",
		"@opentelemetry/instrumentation-pg": "^0.52.0",
		"@types/pg": "^8.11.14",
		"elysia": "^1.2.25"
	}
}
```

ç„¶åï¼Œåœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šè¿è¡Œæ„å»ºå‘½ä»¤å

```bash
bun install --production
```

å¦‚æœ `node_modules` ç›®å½•ä»ç„¶åŒ…å«å¼€å‘ä¾èµ–ï¼Œæ‚¨å¯ä»¥åˆ é™¤ `node_modules` ç›®å½•å¹¶é‡æ–°å®‰è£…ç”Ÿäº§ä¾èµ–ã€‚

### Monorepo

å¦‚æœæ‚¨åœ¨ Monorepo ä¸­ä½¿ç”¨ Elysiaï¼Œæ‚¨å¯èƒ½éœ€è¦åŒ…å«ä¾èµ–çš„ `packages`ã€‚

å¦‚æœæ‚¨ä½¿ç”¨ Turborepoï¼Œæ‚¨å¯ä»¥åœ¨åº”ç”¨ç¨‹åºç›®å½•ä¸­æ”¾ç½® Dockerfileï¼Œæ¯”å¦‚ **apps/server/Dockerfile**ã€‚è¿™ä¹Ÿé€‚ç”¨äºå…¶ä»– monorepo ç®¡ç†å·¥å…·ï¼Œå¦‚ Lerna ç­‰ã€‚

å‡è®¾æˆ‘ä»¬çš„ monorepo ä½¿ç”¨ Turborepoï¼Œç»“æ„å¦‚ä¸‹ï¼š

* apps
  * server
    * **Dockerfileï¼ˆåœ¨æ­¤æ”¾ç½® Dockerfileï¼‰**
* packages
  * config

ç„¶åæˆ‘ä»¬å¯ä»¥åœ¨ monorepo æ ¹ç›®å½•ï¼ˆè€Œéåº”ç”¨ç›®å½•ï¼‰æ„å»ºæˆ‘ä»¬çš„ Dockerfileï¼š

```bash
docker build -t elysia-mono .
```

Dockerfile å¦‚ä¸‹ï¼š

```dockerfile [apps/server/Dockerfile]
FROM oven/bun:1 AS build

WORKDIR /app

# ç¼“å­˜ä¾èµ–
COPY package.json package.json
COPY bun.lock bun.lock

COPY /apps/server/package.json ./apps/server/package.json
COPY /packages/config/package.json ./packages/config/package.json

RUN bun install

COPY /apps/server ./apps/server
COPY /packages/config ./packages/config

ENV NODE_ENV=production

RUN bun build \
	--compile \
	--minify-whitespace \
	--minify-syntax \
	--outfile server \
	src/index.ts

FROM gcr.io/distroless/base

WORKDIR /app

COPY --from=build /app/server server

ENV NODE_ENV=production

CMD ["./server"]

EXPOSE 3000
```

## Railway

[Railway](https://railway.app) æ˜¯ä¸€ä¸ªæµè¡Œçš„éƒ¨ç½²å¹³å°ã€‚

Railway ä¸ºæ¯ä¸ªéƒ¨ç½²åˆ†é…ä¸€ä¸ª **éšæœºç«¯å£**ï¼Œå¯é€šè¿‡ `PORT` ç¯å¢ƒå˜é‡è®¿é—®ã€‚

æˆ‘ä»¬éœ€è¦ä¿®æ”¹ Elysia æœåŠ¡å™¨ä»£ç ä»¥æ¥å— `PORT` ç¯å¢ƒå˜é‡ï¼Œä»è€Œå…¼å®¹ Railway çš„ç«¯å£ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `process.env.PORT`ï¼Œå¹¶åœ¨å¼€å‘æ—¶æä¾›ä¸€ä¸ªé»˜è®¤ç«¯å£ï¼š

```ts
new Elysia()
	.listen(3000) // [!code --]
	.listen(process.env.PORT ?? 3000) // [!code ++]
```

è¿™åº”å…è®¸ Elysia ç›‘å¬ Railway æä¾›çš„ç«¯å£ã€‚

::: tip
Elysia è‡ªåŠ¨å°†ä¸»æœºååˆ†é…ä¸º `0.0.0.0`ï¼Œä¸ Railway å®Œå…¨å…¼å®¹ã€‚
:::

---

---
url: 'https://elysiajs.com/patterns/configuration.md'
---

# é…ç½®

Elysia æä¾›äº†å¯é…ç½®çš„è¡Œä¸ºï¼Œå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰å…¶åŠŸèƒ½çš„å„ä¸ªæ–¹é¢ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨æ„é€ å‡½æ•°å®šä¹‰é…ç½®ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia({
	prefix: '/v1',
	normalize: true
})
```

## é€‚é…å™¨

###### è‡ª 1.1.11 èµ·

ç”¨äºåœ¨ä¸åŒç¯å¢ƒä¸­ä½¿ç”¨ Elysia çš„è¿è¡Œæ—¶é€‚é…å™¨ã€‚

é»˜è®¤é€‚é…å™¨ä¼šæ ¹æ®ç¯å¢ƒé€‰æ‹©ã€‚

```ts
import { Elysia, t } from 'elysia'
import { BunAdapter } from 'elysia/adapter/bun'

new Elysia({
	adapter: BunAdapter
})
```

## allowUnsafeValidationDetails

###### è‡ª 1.4.13 èµ·

æ˜¯å¦å…è®¸ Elysia åœ¨ç”Ÿäº§ç¯å¢ƒçš„é”™è¯¯å“åº”ä¸­åŒ…å«ä¸å®‰å…¨çš„éªŒè¯è¯¦æƒ…ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia({
	allowUnsafeValidationDetails: true
})
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia ä¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­çœç•¥æ‰€æœ‰éªŒè¯ç»†èŠ‚ã€‚

è¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢æ³„éœ²æœ‰å…³éªŒè¯æ¨¡å¼çš„æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚å­—æ®µåç§°å’Œé¢„æœŸç±»å‹ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½ä¼šè¢«æ”»å‡»è€…åˆ©ç”¨ã€‚

ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™åªåº”åœ¨å…¬å…± API ä¸Šå¯ç”¨ï¼Œå› ä¸ºå®ƒå¯èƒ½ä¼šæ³„éœ²æœ‰å…³æœåŠ¡å™¨å®ç°çš„æ•æ„Ÿä¿¡æ¯ã€‚

#### é€‰é¡¹ - @default `false`

* `true` - åœ¨ç”Ÿäº§ç¯å¢ƒçš„é”™è¯¯å“åº”ä¸­åŒ…å«ä¸å®‰å…¨çš„éªŒè¯è¯¦æƒ…
* `false` - åœ¨ç”Ÿäº§ç¯å¢ƒçš„é”™è¯¯å“åº”ä¸­æ’é™¤ä¸å®‰å…¨çš„éªŒè¯è¯¦æƒ…

## AOT

###### è‡ª 0.4.0 èµ·

æå‰ç¼–è¯‘ï¼ˆAhead of Time compilationï¼‰ã€‚

Elysia å†…ç½®äº†ä¸€ä¸ª JIT *"ç¼–è¯‘å™¨"*ï¼Œå¯ä»¥[ä¼˜åŒ–æ€§èƒ½](/blog/elysia-04.html#ahead-of-time-complie)ã€‚

```ts twoslash
import { Elysia } from 'elysia'

new Elysia({
	aot: true
})
```

ç¦ç”¨æå‰ç¼–è¯‘

#### é€‰é¡¹ - @default `false`

* `true` - åœ¨å¯åŠ¨æœåŠ¡å™¨ä¹‹å‰é¢„ç¼–è¯‘æ¯ä¸ªè·¯ç”±

* `false` - å®Œå…¨ç¦ç”¨ JITã€‚å¯åŠ¨æ—¶é—´æ›´å¿«ï¼Œè€Œä¸å½±å“æ€§èƒ½

## è¯¦ç»†ä¿¡æ¯

ä¸ºå®ä¾‹çš„æ‰€æœ‰è·¯ç”±å®šä¹‰ OpenAPI æ–¹æ¡ˆã€‚

æ­¤æ–¹æ¡ˆå°†ç”¨äºç”Ÿæˆå®ä¾‹æ‰€æœ‰è·¯ç”±çš„ OpenAPI æ–‡æ¡£ã€‚

```ts twoslash
import { Elysia } from 'elysia'

new Elysia({
	detail: {
		hide: true,
		tags: ['elysia']
	}
})
```

## encodeSchema

å¤„ç†è‡ªå®šä¹‰ `t.Transform` æ¨¡å¼çš„è‡ªå®šä¹‰ `Encode`ï¼Œåœ¨å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ä¹‹å‰è¿›è¡Œå¤„ç†ã€‚

è¿™å…è®¸æˆ‘ä»¬åœ¨å‘é€å“åº”åˆ°å®¢æˆ·ç«¯ä¹‹å‰ä¸ºæ•°æ®åˆ›å»ºè‡ªå®šä¹‰ç¼–ç å‡½æ•°ã€‚

```ts
import { Elysia, t } from 'elysia'

new Elysia({ encodeSchema: true })
```

#### é€‰é¡¹ - @default `true`

* `true` - åœ¨å°†å“åº”å‘é€ç»™å®¢æˆ·ç«¯ä¹‹å‰è¿è¡Œ `Encode`
* `false` - å®Œå…¨è·³è¿‡ `Encode`

## name

å®šä¹‰å®ä¾‹åç§°ï¼Œç”¨äºè°ƒè¯•å’Œ [æ’ä»¶å»é‡](/essential/plugin.html#plugin-deduplication)

```ts twoslash
import { Elysia } from 'elysia'

new Elysia({
	name: 'service.thing'
})
```

## nativeStaticResponse

###### è‡ª 1.1.11 èµ·

ä¸ºæ¯ä¸ªç›¸åº”çš„è¿è¡Œæ—¶ä½¿ç”¨ä¼˜åŒ–çš„å‡½æ•°å¤„ç†å†…è”å€¼ã€‚

```ts twoslash
import { Elysia } from 'elysia'

new Elysia({
	nativeStaticResponse: true
})
```

#### ç¤ºä¾‹

å¦‚æœåœ¨ Bun ä¸Šå¯ç”¨ï¼ŒElysia å°†å†…è”å€¼æ’å…¥åˆ° `Bun.serve.static` ä¸­ï¼Œä»è€Œæé«˜é™æ€å€¼çš„æ€§èƒ½ã€‚

```ts
import { Elysia } from 'elysia'

// è¿™æ˜¯
new Elysia({
	nativeStaticResponse: true
}).get('/version', 1)

// ç›¸å½“äº
Bun.serve({
	static: {
		'/version': new Response(1)
	}
})
```

## è§„èŒƒåŒ–

###### è‡ª 1.1.0 èµ·

Elysia æ˜¯å¦åº”è¯¥å°†å­—æ®µå¼ºåˆ¶è½¬æ¢ä¸ºæŒ‡å®šçš„æ¨¡å¼ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia({
	normalize: true
})
```

å½“åœ¨è¾“å…¥å’Œè¾“å‡ºä¸­å‘ç°ä¸åœ¨æ¨¡å¼ä¸­è§„å®šçš„æœªçŸ¥å±æ€§æ—¶ï¼ŒElysia åº”è¯¥å¦‚ä½•å¤„ç†å­—æ®µï¼Ÿ

é€‰é¡¹ - @default `true`

* `true`: Elysia å°†ä½¿ç”¨ [exact mirror](/blog/elysia-13.html#exact-mirror) å°†å­—æ®µå¼ºåˆ¶è½¬æ¢ä¸ºæŒ‡å®šæ¨¡å¼

* `typebox`: Elysia å°†ä½¿ç”¨ [TypeBox's Value.Clean](https://github.com/sinclairzx81/typebox) å°†å­—æ®µå¼ºåˆ¶è½¬æ¢ä¸ºæŒ‡å®šæ¨¡å¼

* `false`: å¦‚æœè¯·æ±‚æˆ–å“åº”åŒ…å«ä¸åœ¨å„è‡ªå¤„ç†ç¨‹åºçš„æ¨¡å¼ä¸­æ˜ç¡®å…è®¸çš„å­—æ®µï¼ŒElysia å°†å¼•å‘é”™è¯¯ã€‚

## é¢„ç¼–è¯‘

###### è‡ª 1.0.0 èµ·

Elysia æ˜¯å¦åº”è¯¥åœ¨å¯åŠ¨æœåŠ¡å™¨ä¹‹å‰[é¢„ç¼–è¯‘æ‰€æœ‰è·¯ç”±](/blog/elysia-10.html#improved-startup-time)ã€‚

```ts twoslash
import { Elysia } from 'elysia'

new Elysia({
	precompile: true
})
```

é€‰é¡¹ - @default `false`

* `true`: åœ¨å¯åŠ¨æœåŠ¡å™¨ä¹‹å‰å¯¹æ‰€æœ‰è·¯ç”±è¿›è¡Œ JIT ç¼–è¯‘

* `false`: åŠ¨æ€æŒ‰éœ€ç¼–è¯‘è·¯ç”±

æ¨èå°†å…¶ä¿æŒä¸º `false`ã€‚

## å‰ç¼€

å®šä¹‰å®ä¾‹æ‰€æœ‰è·¯ç”±çš„å‰ç¼€

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia({
	prefix: '/v1'
})
```

å½“å®šä¹‰å‰ç¼€æ—¶ï¼Œæ‰€æœ‰è·¯ç”±å°†ä»¥ç»™å®šå€¼ä¸ºå‰ç¼€ã€‚

#### ç¤ºä¾‹

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia({ prefix: '/v1' }).get('/name', 'elysia') // Path is /v1/name
```

## sanitize

ä¸€ä¸ªå‡½æ•°æˆ–ä¸€ä¸ªå‡½æ•°æ•°ç»„ï¼Œåœ¨æ¯ä¸ª `t.String` éªŒè¯æ—¶è°ƒç”¨å¹¶æ‹¦æˆªã€‚

å…è®¸æˆ‘ä»¬è¯»å–å¹¶å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ–°å€¼ã€‚

```ts
import { Elysia, t } from 'elysia'

new Elysia({
	sanitize: (value) => Bun.escapeHTML(value)
})
```

## ç§å­

å®šä¹‰ä¸€ä¸ªå€¼ï¼Œç”¨äºç”Ÿæˆå®ä¾‹çš„æ ¡éªŒå’Œï¼Œç”¨äº[æ’ä»¶å»é‡](/essential/plugin.html#plugin-deduplication)

```ts twoslash
import { Elysia } from 'elysia'

new Elysia({
	seed: {
		value: 'service.thing'
	}
})
```

è¯¥å€¼å¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼Œä¸é™äºå­—ç¬¦ä¸²ã€æ•°å­—æˆ–å¯¹è±¡ã€‚

## ä¸¥æ ¼è·¯å¾„

Elysia æ˜¯å¦åº”è¯¥ä¸¥æ ¼å¤„ç†è·¯å¾„ã€‚

æ ¹æ®[RFC 3986](https://tools.ietf.org/html/rfc3986#section-3.3)ï¼Œè·¯å¾„åº”ä¸è·¯ç”±ä¸­å®šä¹‰çš„è·¯å¾„å®Œå…¨ç›¸ç­‰ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia({ strictPath: true })
```

#### é€‰é¡¹ - @default `false`

* `true` - ä¸¥æ ¼éµå¾ª[RFC 3986](https://tools.ietf.org/html/rfc3986#section-3.3) è¿›è¡Œè·¯å¾„åŒ¹é…
* `false` - å®¹å¿åç¼€ '/' æˆ–åä¹‹äº¦ç„¶ã€‚

#### ç¤ºä¾‹

```ts twoslash
import { Elysia, t } from 'elysia'

// è·¯å¾„å¯ä»¥æ˜¯ /name æˆ– /name/
new Elysia({ strictPath: false }).get('/name', 'elysia')

// è·¯å¾„åªèƒ½æ˜¯ /name
new Elysia({ strictPath: true }).get('/name', 'elysia')
```

## æœåŠ¡

è‡ªå®šä¹‰ HTTP æœåŠ¡å™¨è¡Œä¸ºã€‚

Bun æœåŠ¡é…ç½®ã€‚

```ts
import { Elysia } from 'elysia'

new Elysia({
	serve: {
		hostname: 'elysiajs.com',
		tls: {
			cert: Bun.file('cert.pem'),
			key: Bun.file('key.pem')
		}
	},
})
```

è¯¥é…ç½®æ‰©å±•äº†[Bun Serve API](https://bun.zhcndoc.com/api/http)å’Œ[Bun TLS](https://bun.zhcndoc.com/api/http#tls)

### ç¤ºä¾‹: æœ€å¤§ä¸»ä½“å¤§å°

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ `serve` é…ç½®ä¸­è®¾ç½®[`serve.maxRequestBodySize`](#serve-maxrequestbodysize)æ¥è®¾ç½®æœ€å¤§ä¸»ä½“å¤§å°ã€‚

```ts
import { Elysia } from 'elysia'

new Elysia({
	serve: {
		maxRequestBodySize: 1024 * 1024 * 256 // 256MB
	}
})
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œæœ€å¤§è¯·æ±‚ä½“å¤§å°ä¸º 128MB (1024 \* 1024 \* 128)ã€‚
å®šä¹‰ä¸»ä½“å¤§å°é™åˆ¶ã€‚

```ts
import { Elysia } from 'elysia'

new Elysia({
	serve: {
		// æœ€å¤§æ¶ˆæ¯å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰
	    maxPayloadLength: 64 * 1024,
	}
})
```

### ç¤ºä¾‹: HTTPS / TLS

é€šè¿‡ä¼ å…¥å¯†é’¥å’Œè¯ä¹¦çš„å€¼ï¼Œæˆ‘ä»¬å¯ä»¥å¯ç”¨ TLSï¼ˆSSL çš„ç»§ä»»è€…ï¼‰ï¼›ä¸¤è€…å‡ä¸ºå¯ç”¨ TLS æ‰€å¿…éœ€ã€‚

```ts
import { Elysia, file } from 'elysia'

new Elysia({
	serve: {
		tls: {
			cert: file('cert.pem'),
			key: file('key.pem')
		}
	}
})
```

### ç¤ºä¾‹ï¼šå¢åŠ è¶…æ—¶

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ `serve` é…ç½®ä¸­è®¾ç½® [`serve.idleTimeout`](#serve-idletimeout) æ¥å¢åŠ ç©ºé—²è¶…æ—¶ã€‚

```ts
import { Elysia } from 'elysia'

new Elysia({
	serve: {
		// Increase idle timeout to 30 seconds
		idleTimeout: 30
	}
})
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œç©ºé—²è¶…æ—¶æ—¶é—´ä¸º 10 ç§’ï¼ˆåœ¨ Bun ä¸Šï¼‰ã€‚

***

## serve

HTTP æœåŠ¡å™¨é…ç½®ã€‚

Elysia æ‰©å±•äº† Bun é…ç½®ï¼Œå¼€ç®±å³ç”¨åœ°æ”¯æŒ TLSï¼ŒåŸºäº BoringSSLã€‚

æœ‰å…³å¯ç”¨é…ç½®ï¼Œè¯·å‚è§ [serve.tls](#serve-tls)ã€‚

### serve.hostname

@default `0.0.0.0`

æœåŠ¡å™¨åº”ç›‘å¬çš„ä¸»æœºåã€‚

### serve.id

Uniquely identify a server instance with an ID

This string will be used to hot reload the server without interrupting pending requests or websockets. If not provided, a value will be generated. To disable hot reloading, set this value to `null`.

### serve.idleTimeout

@default `10` (10 seconds)

By default, Bun set idle timeout to 10 seconds, which means that if a request is not completed within 10 seconds, it will be aborted.

### serve.maxRequestBodySize

@default `1024 * 1024 * 128` (128MB)

è¯·æ±‚ä½“çš„æœ€å¤§å¤§å°ï¼Ÿï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰

### serve.port

@default `3000`

ç›‘å¬çš„ç«¯å£ã€‚

### serve.rejectUnauthorized

@default `NODE_TLS_REJECT_UNAUTHORIZED` ç¯å¢ƒå˜é‡

å¦‚æœè®¾ç½®ä¸º `false`ï¼Œå°†æ¥å—ä»»ä½•è¯ä¹¦ã€‚

### serve.reusePort

@default `true`

æ˜¯å¦åº”è®¾ç½® `SO_REUSEPORT` æ ‡å¿—ã€‚

è¿™å…è®¸å¤šä¸ªè¿›ç¨‹ç»‘å®šåˆ°åŒä¸€ç«¯å£ï¼Œå¯¹è´Ÿè½½å‡è¡¡å¾ˆæœ‰ç”¨ã€‚

è¯¥é…ç½®è¢«è¦†ç›–ï¼Œå¹¶é»˜è®¤ç”± Elysia æ‰“å¼€ã€‚

### serve.unix

å¦‚æœè®¾ç½®ï¼ŒHTTP æœåŠ¡å™¨å°†åœ¨ Unix å¥—æ¥å­—ä¸Šç›‘å¬ï¼Œè€Œä¸æ˜¯åœ¨ç«¯å£ä¸Šã€‚

ï¼ˆä¸èƒ½ä¸ä¸»æœºå+ç«¯å£ä¸€èµ·ä½¿ç”¨ï¼‰

### serve.tls

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ å…¥å¯†é’¥å’Œè¯ä¹¦çš„å€¼å¯ç”¨ TLSï¼ˆSSL çš„ç»§ä»»è€…ï¼‰ï¼›è¿™ä¸¤è€…éƒ½æ˜¯å¯ç”¨ TLS æ‰€å¿…éœ€çš„ã€‚

```ts
import { Elysia, file } from 'elysia'

new Elysia({
	serve: {
		tls: {
			cert: file('cert.pem'),
			key: file('key.pem')
		}
	}
})
```

Elysia æ‰©å±•äº†æ”¯æŒ TLS çš„ Bun é…ç½®ï¼Œä½¿ç”¨ BoringSSL ä½œä¸ºæ”¯æŒã€‚

### serve.tls.ca

å¯é€‰è¦†ç›–å—ä¿¡ä»»çš„ CA è¯ä¹¦ã€‚é»˜è®¤æ˜¯ä¿¡ä»» Mozilla ç²¾å¿ƒæŒ‘é€‰çš„çŸ¥å CAã€‚

å½“ä½¿ç”¨æ­¤é€‰é¡¹æ˜ç¡®æŒ‡å®š CA æ—¶ï¼ŒMozilla çš„ CA ä¼šå®Œå…¨è¢«æ›¿æ¢ã€‚

### serve.tls.cert

PEM æ ¼å¼çš„è¯ä¹¦é“¾ã€‚æ¯ä¸ªç§é’¥åº”æä¾›ä¸€æ¡è¯ä¹¦é“¾ã€‚

æ¯æ¡è¯ä¹¦é“¾åº”åŒ…å«ä¸ºæä¾›çš„ç§é’¥æ ¼å¼åŒ–çš„ PEM è¯ä¹¦ï¼Œä»¥åŠ PEM æ ¼å¼çš„ä¸­é—´è¯ä¹¦ï¼ˆå¦‚æœæœ‰ï¼‰ï¼ŒæŒ‰é¡ºåºæ’åˆ—ï¼Œä¸åŒ…æ‹¬æ ¹ CAï¼ˆæ ¹ CA å¿…é¡»æå‰ä¸ºå¯¹ç­‰æ–¹æ‰€çŸ¥ï¼Œå‚è§ caï¼‰ã€‚

æä¾›å¤šä¸ªè¯ä¹¦é“¾æ—¶ï¼Œé¡ºåºä¸å¿…ä¸å…¶åœ¨å¯†é’¥ä¸­çš„ç§é’¥é¡ºåºç›¸åŒã€‚

å¦‚æœæœªæä¾›ä¸­é—´è¯ä¹¦ï¼Œå¯¹ç­‰æ–¹å°†æ— æ³•éªŒè¯è¯ä¹¦ï¼Œæ¡æ‰‹å°†å¤±è´¥ã€‚

### serve.tls.dhParamsFile

è‡ªå®šä¹‰ Diffie Helman å‚æ•°çš„ .pem æ–‡ä»¶è·¯å¾„ã€‚

### serve.tls.key

PEM æ ¼å¼çš„ç§é’¥ã€‚PEM å…è®¸åŠ å¯†ç§é’¥çš„é€‰é¡¹ã€‚åŠ å¯†å¯†é’¥å°†ä½¿ç”¨ options.passphrase è§£å¯†ã€‚

å¯ä»¥æä¾›ä½¿ç”¨ä¸åŒç®—æ³•çš„å¤šä¸ªå¯†é’¥ï¼Œå¯ä»¥æ˜¯æœªåŠ å¯†çš„å¯†é’¥å­—ç¬¦ä¸²æˆ–ç¼“å†²åŒºçš„æ•°ç»„ï¼Œæˆ–è€…ä»¥å¯¹è±¡å½¢å¼çš„æ•°ç»„ã€‚

å¯¹è±¡å½¢å¼åªèƒ½åœ¨æ•°ç»„ä¸­å‡ºç°ã€‚

**object.passphrase** æ˜¯å¯é€‰çš„ã€‚åŠ å¯†å¯†é’¥å°†ä½¿ç”¨æä¾›çš„ object.passphrase è§£å¯†ï¼Œ

**object.passphrase** å¦‚æœæä¾›ï¼Œæˆ– **options.passphrase** å¦‚æœæœªæä¾›ã€‚

### serve.tls.lowMemoryMode

@default `false`

å°† `OPENSSL_RELEASE_BUFFERS` è®¾ç½®ä¸º 1ã€‚

è¿™ä¼šé™ä½æ•´ä½“æ€§èƒ½ï¼Œä½†èŠ‚çœä¸€äº›å†…å­˜ã€‚

### serve.tls.passphrase

ç”¨äºå•ä¸ªç§é’¥å’Œ/æˆ– PFX çš„å…±äº«å¯†ç çŸ­è¯­ã€‚

### serve.tls.requestCert

@default `false`

å¦‚æœè®¾ç½®ä¸º `true`ï¼ŒæœåŠ¡å™¨å°†è¯·æ±‚å®¢æˆ·ç«¯è¯ä¹¦ã€‚

### serve.tls.secureOptions

å¯é€‰å½±å“ OpenSSL åè®®è¡Œä¸ºï¼Œè¿™é€šå¸¸ä¸æ˜¯å¿…éœ€çš„ã€‚

åº”è°¨æ…ä½¿ç”¨ï¼

å€¼æ˜¯ OpenSSL å¯é€‰é€‰é¡¹çš„ SSL\_OP\_\* çš„æ•°å­—ä½æ©ç ã€‚

### serve.tls.serverName

æ˜¾å¼è®¾ç½®æœåŠ¡å™¨åç§°ã€‚

## æ ‡ç­¾

ä¸ºå®ä¾‹çš„æ‰€æœ‰è·¯ç”±å®šä¹‰ OpenAPI æ–¹æ¡ˆçš„æ ‡ç­¾ï¼Œç±»ä¼¼äº[è¯¦ç»†ä¿¡æ¯](#detail)ã€‚

```ts twoslash
import { Elysia } from 'elysia'

new Elysia({
	tags: ['elysia']
})
```

## systemRouter

åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ä½¿ç”¨è¿è¡Œæ—¶/æ¡†æ¶æä¾›çš„è·¯ç”±å™¨ã€‚

åœ¨ Bun ä¸Šï¼ŒElysia å°†ä½¿ç”¨ [Bun.serve.routes](https://bun.zhcndoc.com/api/http#routing) å¹¶å›é€€åˆ° Elysia è‡ªå·±çš„è·¯ç”±å™¨ã€‚

## websocket

è¦†ç›– websocket é…ç½®

å»ºè®®å°†å…¶ä¿æŒä¸ºé»˜è®¤å€¼ï¼Œå› ä¸º Elysia å°†è‡ªåŠ¨ç”Ÿæˆé€‚åˆå¤„ç† WebSocket çš„é…ç½®

è¯¥é…ç½®æ‰©å±•äº† [Bun's WebSocket API](https://bun.zhcndoc.com/api/websockets)

#### ç¤ºä¾‹

```ts
import { Elysia } from 'elysia'

new Elysia({
	websocket: {
		// å¯ç”¨å‹ç¼©å’Œè§£å‹ç¼©
    	perMessageDeflate: true
	}
})
```

***

---

---
url: 'https://elysiajs.com/tutorial/patterns/error-handling.md'
---

# é”™è¯¯å¤„ç†

onError åœ¨ **æŠ›å‡ºé”™è¯¯** æ—¶è¢«è°ƒç”¨ã€‚

å®ƒæ¥å—ä¸å¤„ç†ç¨‹åºç±»ä¼¼çš„ **ä¸Šä¸‹æ–‡**ï¼Œä½†åŒ…å«é¢å¤–çš„ï¼š

* error - æŠ›å‡ºçš„é”™è¯¯
* code - é”™è¯¯ä»£ç 

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.onError(({ code, status }) => {
		if(code === "NOT_FOUND")
			return 'å‘ƒ~ ä½ è¿·è·¯äº†å—ï¼Ÿ'

		return status(418, "æˆ‘é”™äº†ï¼ä½†æˆ‘å¯çˆ±ï¼Œæ‰€ä»¥ä½ ä¼šåŸè°…æˆ‘ï¼Œå¯¹å§ï¼Ÿ")
	})
	.get('/', () => 'ok')
	.listen(3000)
```

æ‚¨å¯ä»¥è¿”å›ä¸€ä¸ª status ä»¥è¦†ç›–é»˜è®¤é”™è¯¯çŠ¶æ€ã€‚

## è‡ªå®šä¹‰é”™è¯¯

æ‚¨å¯ä»¥å¦‚ä¸‹æä¾›å¸¦æœ‰ é”™è¯¯ä»£ç  çš„è‡ªå®šä¹‰é”™è¯¯ï¼š

```typescript
import { Elysia } from 'elysia'

class NicheError extends Error {
	constructor(message: string) {
		super(message)
	}
}

new Elysia()
	.error({ // [!code ++]
		'NICHE': NicheError // [!code ++]
	}) // [!code ++]
	.onError(({ error, code, status }) => {
		if(code === 'NICHE') {
			// ç±»å‹ä¸º NicheError
			console.log(error)

			return status(418, "æˆ‘ä»¬ä¸çŸ¥é“ä½ æ˜¯æ€ä¹ˆæ¥åˆ°è¿™é‡Œçš„")
		}
	})
	.get('/', () => {
		throw new NicheError('è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯')
	})
	.listen(3000)
```

Elysia ä½¿ç”¨ é”™è¯¯ä»£ç  æ¥ç¼©å°é”™è¯¯çš„ç±»å‹ã€‚

å»ºè®®æ³¨å†Œè‡ªå®šä¹‰é”™è¯¯ï¼Œå› ä¸º Elysia å¯ä»¥ç¼©å°ç±»å‹ã€‚

### é”™è¯¯çŠ¶æ€ä»£ç 

æ‚¨è¿˜å¯ä»¥é€šè¿‡å‘ç±»æ·»åŠ  **status** å±æ€§æ¥æä¾›è‡ªå®šä¹‰çŠ¶æ€ä»£ç ï¼š

```typescript
import { Elysia } from 'elysia'

class NicheError extends Error {
	status = 418 // [!code ++]

	constructor(message: string) {
		super(message)
	}
}
```

å¦‚æœæŠ›å‡ºé”™è¯¯ï¼ŒElysia å°†ä½¿ç”¨æ­¤çŠ¶æ€ä»£ç ï¼Œè¯·å‚è§ è‡ªå®šä¹‰çŠ¶æ€ä»£ç ã€‚

### é”™è¯¯å“åº”

æ‚¨è¿˜å¯ä»¥é€šè¿‡æä¾› `toResponse` æ–¹æ³•ç›´æ¥åœ¨é”™è¯¯ä¸­å®šä¹‰è‡ªå®šä¹‰é”™è¯¯å“åº”ï¼š

```typescript
import { Elysia } from 'elysia'

class NicheError extends Error {
	status = 418

	constructor(message: string) {
		super(message)
	}

	toResponse() { // [!code ++]
		return { message: this.message } // [!code ++]
	} // [!code ++]
}
```

å¦‚æœæŠ›å‡ºé”™è¯¯ï¼ŒElysia å°†ä½¿ç”¨æ­¤å“åº”ï¼Œè¯·å‚è§ è‡ªå®šä¹‰é”™è¯¯å“åº”ã€‚

## ç»ƒä¹ 

ç°åœ¨è®©æˆ‘ä»¬å°è¯•æ‰©å±• Elysia çš„ä¸Šä¸‹æ–‡ã€‚

\<template #answer>

1. æ‚¨å¯ä»¥é€šè¿‡ "NOT\_FOUND" ç¼©å°é”™è¯¯ä»¥è¦†ç›– 404 å“åº”ã€‚
2. ä½¿ç”¨å¸¦æœ‰ 418 çŠ¶æ€å±æ€§çš„ `.error()` æ–¹æ³•æä¾›æ‚¨çš„é”™è¯¯ã€‚

```typescript
import { Elysia } from 'elysia'

class YourError extends Error {
	status = 418

	constructor(message: string) {
		super(message)
	}
}

new Elysia()
	.error({
		"YOUR_ERROR": YourError
	})
	.onError(({ code, status }) => {
		if(code === "NOT_FOUND")
			return "å—¨ï¼Œä½ å¥½"
	})
	.get('/', () => {
		throw new YourError("A")
	})
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/patterns/error-handling.md'
---

# é”™è¯¯å¤„ç†&#x20;

æœ¬é¡µæä¾›äº†ä¸€ä¸ªæ›´é«˜çº§çš„æŒ‡å—ï¼Œç”¨äºåœ¨ Elysia ä¸­æœ‰æ•ˆå¤„ç†é”™è¯¯ã€‚

å¦‚æœä½ è¿˜æ²¡æœ‰é˜…è¯» **â€œç”Ÿå‘½å‘¨æœŸ (onError)â€**ï¼Œå»ºè®®å…ˆé˜…è¯»å®ƒã€‚

## è‡ªå®šä¹‰éªŒè¯æ¶ˆæ¯

åœ¨å®šä¹‰æ¨¡å¼æ—¶ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªå­—æ®µæä¾›è‡ªå®šä¹‰éªŒè¯æ¶ˆæ¯ã€‚

å½“éªŒè¯å¤±è´¥æ—¶ï¼Œè¯¥æ¶ˆæ¯å°†åŸæ ·è¿”å›ã€‚

```ts
import { Elysia } from 'elysia'

new Elysia().get('/:id', ({ params: { id } }) => id, {
    params: t.Object({
        id: t.Number({
            error: 'id å¿…é¡»æ˜¯æ•°å­—' // [!code ++]
        })
    })
})
```

å¦‚æœ `id` å­—æ®µéªŒè¯å¤±è´¥ï¼Œå“åº”å°†è¿”å› `id å¿…é¡»æ˜¯æ•°å­—`ã€‚

### éªŒè¯è¯¦æƒ…&#x20;

ä» `schema.error` è¿”å›ä¸€ä¸ªå€¼å°†åŸæ ·è¿”å›éªŒè¯æ¶ˆæ¯ï¼Œä½†æœ‰æ—¶ä½ ä¹Ÿå¸Œæœ›è¿”å›éªŒè¯ç»†èŠ‚ï¼Œæ¯”å¦‚å­—æ®µåå’ŒæœŸæœ›ç±»å‹ã€‚

ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨ `validationDetail` æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

```ts
import { Elysia, validationDetail } from 'elysia' // [!code ++]

new Elysia().get('/:id', ({ params: { id } }) => id, {
    params: t.Object({
        id: t.Number({
            error: validationDetail('id å¿…é¡»æ˜¯æ•°å­—') // [!code ++]
        })
    })
})
```

è¿™å°†åœ¨å“åº”ä¸­åŒ…å«æ‰€æœ‰éªŒè¯è¯¦æƒ…ï¼Œæ¯”å¦‚å­—æ®µåå’ŒæœŸæœ›ç±»å‹ã€‚

ä½†æ˜¯å¦‚æœä½ è®¡åˆ’åœ¨æ¯ä¸ªå­—æ®µéƒ½ä½¿ç”¨ `validationDetail`ï¼Œæ‰‹åŠ¨æ·»åŠ ä¼šå¾ˆéº»çƒ¦ã€‚

ä½ å¯ä»¥åœ¨ `onError` é’©å­ä¸­è‡ªåŠ¨å¤„ç†éªŒè¯è¯¦æƒ…ã€‚

```ts
new Elysia()
    .onError(({ error, code }) => {
        if (code === 'VALIDATION') return error.detail(error.message) // [!code ++]
    })
    .get('/:id', ({ params: { id } }) => id, {
        params: t.Object({
            id: t.Number({
                error: 'id å¿…é¡»æ˜¯æ•°å­—'
            })
        })
    })
    .listen(3000)
```

è¿™å°†ä¸ºæ¯ä¸ªå¸¦æœ‰è‡ªå®šä¹‰æ¶ˆæ¯çš„éªŒè¯é”™è¯¯æ·»åŠ è‡ªå®šä¹‰éªŒè¯è¯¦æƒ…ã€‚

## ç”Ÿäº§ç¯å¢ƒä¸­çš„éªŒè¯è¯¦æƒ…

é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœ `NODE_ENV` æ˜¯ `production`ï¼ŒElysia ä¼šçœç•¥æ‰€æœ‰éªŒè¯è¯¦æƒ…ã€‚

è¿™æ ·åšæ˜¯ä¸ºäº†é˜²æ­¢æ³„éœ²éªŒè¯æ¨¡å¼çš„æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å­—æ®µåå’ŒæœŸæœ›ç±»å‹ï¼Œè¿™å¯èƒ½è¢«æ”»å‡»è€…åˆ©ç”¨ã€‚

Elysia åªä¼šè¿”å›éªŒè¯å¤±è´¥çš„ä¿¡æ¯ï¼Œè€Œä¸åŒ…å«ä»»ä½•è¯¦æƒ…ã€‚

```json
{
    "type": "validation",
    "on": "body",
    "found": {},
    // ä»…å¯¹è‡ªå®šä¹‰é”™è¯¯æ˜¾ç¤º
    "message": "x å¿…é¡»æ˜¯æ•°å­—"
}
```

`message` å±æ€§æ˜¯å¯é€‰çš„ï¼Œé»˜è®¤çœç•¥ï¼Œé™¤éä½ åœ¨æ¨¡å¼ä¸­æä¾›äº†è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ã€‚

å¯ä»¥é€šè¿‡å°† `Elysia.allowUnsafeValidationDetails` è®¾ç½®ä¸º `true` æ¥è¦†ç›–æ­¤è®¾ç½®ï¼Œæ›´å¤šè¯¦æƒ…è¯·å‚è§ [Elysia é…ç½®](/patterns/configuration#allow-unsafe-validation-details)ã€‚

## è‡ªå®šä¹‰é”™è¯¯

Elysia æ”¯æŒç±»å‹å±‚çº§å’Œå®ç°å±‚çº§çš„è‡ªå®šä¹‰é”™è¯¯ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia æœ‰ä¸€ç»„å†…ç½®é”™è¯¯ç±»å‹ï¼Œå¦‚ `VALIDATION`ã€`NOT_FOUND`ï¼Œä¼šè‡ªåŠ¨ç¼©å°ç±»å‹ã€‚

å¦‚æœ Elysia ä¸è®¤è¯†è¯¥é”™è¯¯ï¼Œé”™è¯¯ä»£ç å°†æ˜¯ `UNKNOWN`ï¼Œé»˜è®¤çŠ¶æ€ç ä¸º `500`ã€‚

ä½†ä½ ä¹Ÿå¯ä»¥é€šè¿‡ `Elysia.error` æ·»åŠ å¸¦ç±»å‹å®‰å…¨çš„è‡ªå®šä¹‰é”™è¯¯ï¼Œå®ƒèƒ½å¸®åŠ©ç¼©å°é”™è¯¯ç±»å‹ï¼Œæä¾›å®Œæ•´ç±»å‹å®‰å…¨å’Œè‡ªåŠ¨è¡¥å…¨ï¼Œå¹¶æ”¯æŒè‡ªå®šä¹‰çŠ¶æ€ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript twoslash
import { Elysia } from 'elysia'

class MyError extends Error {
    constructor(public message: string) {
        super(message)
    }
}

new Elysia()
    .error({
        MyError
    })
    .onError(({ code, error }) => {
        switch (code) {
            // è‡ªåŠ¨è¡¥å…¨
            case 'MyError':
                // ç±»å‹ç¼©å°
                // æ‚¬åœæŸ¥çœ‹ error çš„ç±»å‹ä¸º `CustomError`
                return error
        }
    })
    .get('/:id', () => {
        throw new MyError('Hello Error')
    })
```

### è‡ªå®šä¹‰çŠ¶æ€ç 

ä½ ä¹Ÿå¯ä»¥é€šè¿‡åœ¨è‡ªå®šä¹‰é”™è¯¯ç±»ä¸­æ·»åŠ  `status` å±æ€§ï¼Œä¸ºä½ çš„è‡ªå®šä¹‰é”™è¯¯æŒ‡å®šçŠ¶æ€ç ã€‚

```typescript
import { Elysia } from 'elysia'

class MyError extends Error {
    status = 418

    constructor(public message: string) {
        super(message)
    }
}
```

å½“æŠ›å‡ºè¯¥é”™è¯¯æ—¶ï¼ŒElysia ä¼šä½¿ç”¨æ­¤çŠ¶æ€ç ã€‚

å¦åˆ™ä½ ä¹Ÿå¯ä»¥åœ¨ `onError` é’©å­ä¸­æ‰‹åŠ¨è®¾ç½®çŠ¶æ€ç ã€‚

```typescript
import { Elysia } from 'elysia'

class MyError extends Error {
	constructor(public message: string) {
		super(message)
	}
}

new Elysia()
	.error({
		MyError
	})
	.onError(({ code, error, status }) => {
		switch (code) {
			case 'MyError':
				return status(418, error.message)
		}
	})
	.get('/:id', () => {
		throw new MyError('Hello Error')
	})
```

### è‡ªå®šä¹‰é”™è¯¯å“åº”

ä½ ä¹Ÿå¯ä»¥åœ¨è‡ªå®šä¹‰é”™è¯¯ç±»ä¸­æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„ `toResponse` æ–¹æ³•ï¼Œå½“é”™è¯¯è¢«æŠ›å‡ºæ—¶è¿”å›è‡ªå®šä¹‰å“åº”ã€‚

```typescript
import { Elysia } from 'elysia'

class MyError extends Error {
	status = 418

	constructor(public message: string) {
		super(message)
	}

	toResponse() {
		return Response.json({
			error: this.message,
			code: this.status
		}, {
			status: 418
		})
	}
}
```

## æŠ›å‡ºæˆ–è¿”å›

å¤§å¤šæ•°é”™è¯¯å¤„ç†å¯ä»¥é€šè¿‡æŠ›å‡ºé”™è¯¯å¹¶åœ¨ `onError` ä¸­å¤„ç†å®Œæˆã€‚

ä½† `status` å¯èƒ½ä¼šè®©äººå›°æƒ‘ï¼Œå› ä¸ºå®ƒæ—¢å¯ä»¥ä½œä¸ºè¿”å›å€¼ä¹Ÿå¯ä»¥æŠ›å‡ºé”™è¯¯ã€‚

æ ¹æ®ä½ çš„å…·ä½“éœ€æ±‚ï¼Œå®ƒå¯ä»¥æ˜¯ **è¿”å›** æˆ– **æŠ›å‡º** ã€‚

* å¦‚æœ `status` è¢« **æŠ›å‡º**ï¼Œä¼šè¢« `onError` ä¸­é—´ä»¶æ•è·ã€‚
* å¦‚æœ `status` è¢« **è¿”å›**ï¼Œä¸ä¼šè¢« `onError` ä¸­é—´ä»¶æ•è·ã€‚

è¯·çœ‹ä»¥ä¸‹ä»£ç ï¼š

```typescript
import { Elysia, file } from 'elysia'

new Elysia()
    .onError(({ code, error, path }) => {
        if (code === 418) return 'caught'
    })
    .get('/throw', ({ status }) => {
        // è¿™ä¼šè¢« onError æ•è·
        throw status(418)
    })
    .get('/return', ({ status }) => {
        // è¿™ä¸ä¼šè¢« onError æ•è·
        return status(418)
    })
```

---

---
url: 'https://elysiajs.com/plugins/static.md'
---

# é™æ€æ’ä»¶

æ­¤æ’ä»¶å¯ä»¥ä¸º Elysia Server æä¾›é™æ€æ–‡ä»¶/æ–‡ä»¶å¤¹çš„æœåŠ¡

å®‰è£…æ–¹æ³•ï¼š

```bash
bun add @elysiajs/static
```

ç„¶åä½¿ç”¨å®ƒï¼š

```typescript twoslash
import { Elysia } from 'elysia'
import { staticPlugin } from '@elysiajs/static'

new Elysia()
    .use(staticPlugin())
    .listen(3000)
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œé™æ€æ’ä»¶çš„é»˜è®¤æ–‡ä»¶å¤¹æ˜¯ `public`ï¼Œå¹¶ä»¥ `/public` å‰ç¼€æ³¨å†Œã€‚

å‡è®¾ä½ çš„é¡¹ç›®ç»“æ„ä¸ºï¼š

```
| - src
  | - index.ts
| - public
  | - takodachi.png
  | - nested
    | - takodachi.png
```

å¯ç”¨çš„è·¯å¾„å°†å˜ä¸ºï¼š

* /public/takodachi.png
* /public/nested/takodachi.png

## é…ç½®

ä»¥ä¸‹æ˜¯æ’ä»¶æ¥å—çš„é…ç½®

### assets

@default `"public"`

è¦æš´éœ²ä¸ºé™æ€çš„æ–‡ä»¶å¤¹è·¯å¾„

### prefix

@default `"/public"`

æ³¨å†Œå…¬å…±æ–‡ä»¶çš„è·¯å¾„å‰ç¼€

### ignorePatterns

@default `[]`

è¦å¿½ç•¥çš„ä¸æä¾›é™æ€æ–‡ä»¶æœåŠ¡çš„æ–‡ä»¶åˆ—è¡¨

### staticLimit

@default `1024`

é»˜è®¤ä¸ºï¼Œé™æ€æ’ä»¶å°†ä»¥é™æ€åç§°å°†è·¯å¾„æ³¨å†Œåˆ°è·¯ç”±å™¨ï¼Œå¦‚æœè¶…è¿‡é™åˆ¶ï¼Œè·¯å¾„å°†æ‡’æƒ°åœ°æ·»åŠ åˆ°è·¯ç”±å™¨ä»¥å‡å°‘å†…å­˜ä½¿ç”¨ã€‚
åœ¨å†…å­˜å’Œæ€§èƒ½ä¹‹é—´æƒè¡¡ã€‚

### alwaysStatic

@default `false`

å¦‚æœè®¾ç½®ä¸º trueï¼Œé™æ€æ–‡ä»¶è·¯å¾„å°†è·³è¿‡ `staticLimits` æ³¨å†Œåˆ°è·¯ç”±å™¨ã€‚

### headers

@default `{}`

è®¾ç½®æ–‡ä»¶çš„å“åº”å¤´

### indexHTML

@default `false`

å¦‚æœè®¾ç½®ä¸º trueï¼Œå½“è¯·æ±‚æ—¢ä¸åŒ¹é…è·¯ç”±ä¹Ÿä¸åŒ¹é…ä»»ä½•ç°æœ‰é™æ€æ–‡ä»¶æ—¶ï¼Œå°†æä¾›é™æ€ç›®å½•ä¸­çš„ `index.html` æ–‡ä»¶ã€‚

## æ¨¡å¼

ä»¥ä¸‹æ˜¯ä½¿ç”¨è¯¥æ’ä»¶çš„å¸¸è§æ¨¡å¼ã€‚

* [å•ä¸ªæ–‡ä»¶](#å•ä¸ªæ–‡ä»¶)

## å•ä¸ªæ–‡ä»¶

å‡è®¾ä½ åªæƒ³è¿”å›ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ `file` è€Œä¸æ˜¯ä½¿ç”¨é™æ€æ’ä»¶

```typescript
import { Elysia, file } from 'elysia'

new Elysia()
    .get('/file', file('public/takodachi.png'))
```

---

---
url: 'https://elysiajs.com/playground/preview.md'
---


---

---
url: 'https://elysiajs.com/tutorial/getting-started/validation.md'
---

# éªŒè¯

Elysia æä¾›å¼€ç®±å³ç”¨çš„æ•°æ®éªŒè¯ã€‚

ä½ å¯ä»¥ä½¿ç”¨ `Elysia.t` æ¥å®šä¹‰ä¸€ä¸ªæ¨¡å¼ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.post(
		'/user',
		({ body: { name } }) => `ä½ å¥½ ${name}!`,
		{
			body: t.Object({
				name: t.String(),
				age: t.Number()
			})
		}
	)
	.listen(3000)
```

å½“ä½ å®šä¹‰æ¨¡å¼æ—¶ï¼ŒElysia ä¼šç¡®ä¿æ•°æ®çš„å½¢çŠ¶æ˜¯æ­£ç¡®çš„ã€‚

å¦‚æœæ•°æ®ä¸ç¬¦åˆæ¨¡å¼ï¼ŒElysia ä¼šè¿”å› **422 æ— æ³•å¤„ç†çš„å®ä½“** é”™è¯¯ã€‚

è¯·å‚è§ éªŒè¯ã€‚

### è‡ªå¸¦æ¨¡å¼

æˆ–è€…ï¼ŒElysia æ”¯æŒ **æ ‡å‡†æ¨¡å¼**ï¼Œå…è®¸æ‚¨ä½¿ç”¨è‡ªå·±é€‰æ‹©çš„åº“ï¼Œå¦‚ **zod**ã€**yup** æˆ– **valibot**ã€‚

```typescript
import { Elysia } from 'elysia'
import { z } from 'zod'

new Elysia()
	.post(
		'/user',
		({ body: { name } }) => `ä½ å¥½ ${name}!`,
		{
			body: z.object({
				name: z.string(),
				age: z.number()
			})
		}
	)
	.listen(3000)
```

è¯·å‚è§ æ ‡å‡†æ¨¡å¼ ä»¥è·å–æ‰€æœ‰å…¼å®¹æ¨¡å¼ã€‚

## éªŒè¯ç±»å‹

æ‚¨å¯ä»¥éªŒè¯ä»¥ä¸‹å±æ€§ï¼š

* `body`
* `query`
* `params`
* `headers`
* `cookie`
* `response`

ä¸€æ—¦å®šä¹‰äº†æ¨¡å¼ï¼ŒElysia ä¼šä¸ºæ‚¨æ¨æ–­ç±»å‹ï¼Œå› æ­¤æ‚¨æ— éœ€åœ¨ TypeScript ä¸­å®šä¹‰å•ç‹¬çš„æ¨¡å¼ã€‚

è¯·å‚è§ æ¨¡å¼ç±»å‹ ä»¥äº†è§£æ¯ç§ç±»å‹ã€‚

## å“åº”éªŒè¯

å½“æ‚¨ä¸º `response` å®šä¹‰éªŒè¯æ¨¡å¼æ—¶ï¼ŒElysia ä¼šåœ¨å°†å“åº”å‘é€ç»™å®¢æˆ·ç«¯ä¹‹å‰éªŒè¯å“åº”ï¼Œå¹¶ä¸ºæ‚¨è¿›è¡Œç±»å‹æ£€æŸ¥ã€‚

æ‚¨è¿˜å¯ä»¥æŒ‡å®šè¦éªŒè¯çš„çŠ¶æ€ç ï¼š

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.get(
		'/user',
		() => `ä½ å¥½ Elysia!`,
		{
			response: {
				200: t.Literal('ä½ å¥½ Elysia!'),
				418: t.Object({
					message: t.Literal("æˆ‘æ˜¯ä¸€å£¶èŒ¶")
				})
			}
		}
	)
	.listen(3000)
```

è¯·å‚è§ å“åº”éªŒè¯ã€‚

## ç»ƒä¹ 

è®©æˆ‘ä»¬ç»ƒä¹ ä¸€ä¸‹æˆ‘ä»¬æ‰€å­¦çš„å†…å®¹ã€‚

\<template #answer>

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨ `t.Object` æ¥å®šä¹‰ä¸€ä¸ªæ¨¡å¼ï¼Œæä¾›ç»™ `body` å±æ€§ã€‚

```typescript
import { Elysia } from 'elysia'

new Elysia()
	.get('/', ({ status, set }) => {
		set.headers['x-powered-by'] = 'Elysia'

		return status(418, 'ä½ å¥½ Elysia!')
	})
	.get('/docs', ({ redirect }) => redirect('https://elysiajs.com'))
	.listen(3000)
```

---

---
url: 'https://elysiajs.com/essential/validation.md'
---

# éªŒè¯&#x20;

Elysia æä¾›äº†ä¸€ä¸ªå†…ç½®æ¨¡å¼ï¼Œç”¨äºéªŒè¯æ•°æ®ï¼Œç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
    .get('/id/:id', ({ params: { id } }) => id, {
        params: t.Object({
            id: t.Number()
        })
    })
    .listen(3000)
```

### TypeBox

**Elysia.t** æ˜¯åŸºäº [TypeBox](https://github.com/sinclairzx81/typebox) çš„æ¨¡å¼æ„å»ºå™¨ï¼Œæä¾›è¿è¡Œæ—¶ã€ç¼–è¯‘æ—¶çš„ç±»å‹å®‰å…¨ä»¥åŠä»å•ä¸€æ•°æ®æºç”Ÿæˆ OpenAPI æ¨¡å¼ã€‚

Elysia ä¸ºæœåŠ¡å™¨ç«¯éªŒè¯å®šåˆ¶äº† TypeBoxï¼Œä»¥æä¾›æ— ç¼ä½“éªŒã€‚

### æ ‡å‡† Schema

Elysia ä¹Ÿæ”¯æŒ [Standard Schema](https://github.com/standard-schema/standard-schema)ï¼Œå…è®¸æ‚¨ä½¿ç”¨å–œæ¬¢çš„éªŒè¯åº“ï¼š

* Zod
* Valibot
* ArkType
* Effect Schema
* Yup
* Joi
* [ä»¥åŠæ›´å¤š](https://github.com/standard-schema/standard-schema)

ä½¿ç”¨ Standard Schemaï¼Œåªéœ€å¯¼å…¥å¯¹åº”çš„ schema å¹¶ä¼ é€’ç»™è·¯ç”±å¤„ç†å™¨ã€‚

```typescript twoslash
import { Elysia } from 'elysia'
import { z } from 'zod'
import * as v from 'valibot'

new Elysia()
	.get('/id/:id', ({ params: { id }, query: { name } }) => id, {
	//                           ^?
		params: z.object({
			id: z.coerce.number()
		}),
		query: v.object({
			name: v.literal('Lilith')
		})
	})
	.listen(3000)
```

æ‚¨å¯ä»¥åœ¨åŒä¸€ä¸ªå¤„ç†å™¨ä¸­æ— ç¼ä½¿ç”¨å¤šç§éªŒè¯å™¨ã€‚

## Schema ç±»å‹

Elysia æ”¯æŒä»¥ä¸‹å£°æ˜å¼æ¨¡å¼ç±»å‹ï¼š

***

è¿™äº›å±æ€§åº”ä½œä¸ºè·¯ç”±å¤„ç†å™¨çš„ç¬¬ä¸‰ä¸ªå‚æ•°æä¾›ï¼Œç”¨äºéªŒè¯ä¼ å…¥è¯·æ±‚ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
    .get('/id/:id', () => 'Hello World!', {
        query: t.Object({
            name: t.String()
        }),
        params: t.Object({
            id: t.Number()
        })
    })
    .listen(3000)
```

å“åº”ç¤ºä¾‹ï¼š
| URL | æŸ¥è¯¢ | å‚æ•° |
| --- | --------- | ------------ |
| /id/a | âŒ | âŒ |
| /id/1?name=Elysia | âœ… | âœ… |
| /id/1?alias=Elysia | âŒ | âœ… |
| /id/a?name=Elysia | âœ… | âŒ |
| /id/a?alias=Elysia | âŒ | âŒ |

å½“æä¾›æ¨¡å¼æ—¶ï¼Œç±»å‹ä¼šè‡ªåŠ¨ä»æ¨¡å¼æ¨æ–­ï¼Œå¹¶ç”Ÿæˆç”¨äº API æ–‡æ¡£çš„ OpenAPI ç±»å‹ï¼Œæ¶ˆé™¤äº†æ‰‹åŠ¨æä¾›ç±»å‹çš„é‡å¤å·¥ä½œã€‚

## Guard

Guard å¯ç”¨äºå°†æ¨¡å¼åº”ç”¨äºå¤šä¸ªå¤„ç†å™¨ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
    .get('/none', ({ query }) => 'hi')
                   // ^?

    .guard({ // [!code ++]
        query: t.Object({ // [!code ++]
            name: t.String() // [!code ++]
        }) // [!code ++]
    }) // [!code ++]
    .get('/query', ({ query }) => query)
                    // ^?
    .listen(3000)
```

è¿™æ®µä»£ç ç¡®ä¿åœ¨ä¹‹åçš„æ¯ä¸ªå¤„ç†å™¨ä¸­ï¼ŒæŸ¥è¯¢ä¸­å¿…é¡»åŒ…å«å­—ç¬¦ä¸²ç±»å‹çš„ **name** å±æ€§ã€‚å“åº”ç¤ºä¾‹å¦‚ä¸‹ï¼š

å“åº”ç»“æœï¼š

| è·¯å¾„          | å“åº” |
| ------------- | -------- |
| /none         | hi       |
| /none?name=a  | hi       |
| /query        | error    |
| /query?name=a | a        |

å¦‚æœä¸ºåŒä¸€å±æ€§å®šä¹‰äº†å¤šä¸ªå…¨å±€ Guard æ¨¡å¼ï¼Œæœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚å¦‚æœåŒæ—¶å®šä¹‰æœ¬åœ°ä¸å…¨å±€æ¨¡å¼ï¼Œåˆ™æœ¬åœ°ä¼˜å…ˆã€‚

### Guard Schema ç±»å‹

Guard æ”¯æŒä¸¤ç§éªŒè¯æ¨¡å¼å®šä¹‰ç±»å‹ã€‚

### **è¦†ç›–ï¼ˆé»˜è®¤ï¼‰**

æ¨¡å¼å†²çªæ—¶ï¼Œåè€…è¦†ç›–å‰è€…ã€‚

![Elysia é»˜è®¤è¦†ç›–æ¨¡å¼è¿è¡Œç¤ºæ„](/blog/elysia-13/schema-override.webp)

### **ç‹¬ç«‹**&#x20;

åˆ†åˆ«å¤„ç†å†²çªçš„æ¨¡å¼å¹¶ç‹¬ç«‹è¿è¡Œï¼Œç¡®ä¿ä¸¤ä¸ªæ¨¡å¼éƒ½è¢«éªŒè¯ã€‚

![Elysia ç‹¬ç«‹è¿è¡Œå¤šä¸ªå®ˆæŠ¤åˆå¹¶ç¤ºæ„](/blog/elysia-13/schema-standalone.webp)

é€šè¿‡ä½¿ç”¨ `schema` å±æ€§å®šä¹‰ Guard çš„æ¨¡å¼ç±»å‹ï¼š

```ts
import { Elysia } from 'elysia'

new Elysia()
	.guard({
		schema: 'standalone', // [!code ++]
		response: t.Object({
			title: t.String()
		})
	})
```

## ä¸»ä½“

ä¼ å…¥çš„ [HTTP æ¶ˆæ¯](https://developer.mozilla.org/en-US/docs/Web/HTTP/Messages) æ˜¯å‘é€åˆ°æœåŠ¡å™¨çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯ JSONã€è¡¨å•æ•°æ®æˆ–å…¶ä»–ä»»æ„æ ¼å¼ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.post('/body', ({ body }) => body, {
                    // ^?

		body: t.Object({
			name: t.String()
		})
	})
	.listen(3000)
```

éªŒè¯ç¤ºä¾‹ï¼š
| ä¸»ä½“ | éªŒè¯ |
| --- | --------- |
| { name: 'Elysia' } | âœ… |
| { name: 1 } | âŒ |
| { alias: 'Elysia' } | âŒ |
| `undefined` | âŒ |

Elysia é»˜è®¤ç¦ç”¨ **GET** å’Œ **HEAD** è¯·æ±‚çš„ body è§£æï¼Œéµå¾ª HTTP/1.1 è§„èŒƒ [RFC2616](https://www.rfc-editor.org/rfc/rfc2616#section-4.3)

> å¦‚æœè¯·æ±‚æ–¹æ³•ä¸åŒ…å«å®ä½“ä¸»ä½“çš„å®šä¹‰è¯­ä¹‰ï¼Œåˆ™åº”å¿½ç•¥æ¶ˆæ¯ä¸»ä½“ã€‚

å¤§å¤šæ•°æµè§ˆå™¨é»˜è®¤ä¸å…è®¸åœ¨ **GET** å’Œ **HEAD** æ–¹æ³•ä¸­å‘é€ä¸»ä½“ã€‚

#### è§„èŒƒ

éªŒè¯ä¼ å…¥çš„ [HTTP æ¶ˆæ¯](https://developer.mozilla.org/en-US/docs/Web/HTTP/Messages)ï¼ˆä¹Ÿå³ä¸»ä½“ï¼‰ã€‚

è¿™äº›æ¶ˆæ¯æ˜¯ä¾› Web æœåŠ¡å™¨å¤„ç†çš„é™„åŠ ä¿¡æ¯ã€‚

ä¸»ä½“å¯¹åº”äº `fetch` API ä¸­çš„ `body`ã€‚å†…å®¹ç±»å‹åº”æ ¹æ®å®šä¹‰çš„ä¸»ä½“ç±»å‹é€‚å½“è®¾ç½®ã€‚

```typescript
fetch('https://elysiajs.com', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        name: 'Elysia'
    })
})
```

### æ–‡ä»¶

æ–‡ä»¶æ˜¯ç‰¹æ®Šçš„ä¸»ä½“ç±»å‹ï¼Œç”¨äºæ–‡ä»¶ä¸Šä¼ ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.post('/body', ({ body }) => body, {
                    // ^?

		body: t.Object({
			file: t.File({ format: 'image/*' }),
			multipleFiles: t.Files()
		})
	})
	.listen(3000)
```

é€šè¿‡æŒ‡å®šæ–‡ä»¶ç±»å‹ï¼ŒElysia ä¼šè‡ªåŠ¨å‡è®¾å†…å®¹ç±»å‹ä¸º `multipart/form-data`ã€‚

### Fileï¼ˆæ ‡å‡† Schemaï¼‰

å¦‚æœæ‚¨ä½¿ç”¨æ ‡å‡† Schemaï¼Œéœ€è¦æ³¨æ„ Elysia æ— æ³•åƒ `t.File` é‚£æ ·è‡ªåŠ¨éªŒè¯å†…å®¹ç±»å‹ã€‚

ä½† Elysia å¯¼å‡ºäº†ä¸€ä¸ª `fileType` å‡½æ•°ï¼Œå¯é€šè¿‡é­”æ•°ï¼ˆmagic numberï¼‰éªŒè¯æ–‡ä»¶ç±»å‹ã€‚

```typescript twoslash
import { Elysia, fileType } from 'elysia'
import { z } from 'zod'

new Elysia()
	.post('/body', ({ body }) => body, {
		body: z.object({
			file: z.file().refine((file) => fileType(file, 'image/jpeg')) // [!code ++]
		})
	})
```

å¼ºçƒˆå»ºè®®æ‚¨**ä½¿ç”¨** `fileType` éªŒè¯æ–‡ä»¶ç±»å‹ï¼Œå› ä¸ºå¤§å¤šæ•°éªŒè¯å™¨æ— æ³•æ­£ç¡®éªŒè¯æ–‡ä»¶ï¼Œä»…æ£€æŸ¥å†…å®¹ç±»å‹å­—æ®µå¯èƒ½å¼•å‘å®‰å…¨æ¼æ´ã€‚

## æŸ¥è¯¢

æŸ¥è¯¢æ˜¯é€šè¿‡ URL ä¼ é€’çš„æ•°æ®ï¼Œå½¢å¼ä¸º `?key=value`ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/query', ({ query }) => query, {
                    // ^?

		query: t.Object({
			name: t.String()
		})
	})
	.listen(3000)
```

æŸ¥è¯¢å‚æ•°å¿…é¡»ä»¥å¯¹è±¡å½¢å¼æä¾›ã€‚

éªŒè¯ç¤ºä¾‹ï¼š
| æŸ¥è¯¢ | éªŒè¯ |
| ---- | --------- |
| /?name=Elysia | âœ… |
| /?name=1 | âœ… |
| /?alias=Elysia | âŒ |
| /?name=ElysiaJS\&alias=Elysia | âœ… |
| / | âŒ |

#### è§„èŒƒ

æŸ¥è¯¢å­—ç¬¦ä¸²æ˜¯ URL çš„ä¸€éƒ¨åˆ†ï¼Œä»¥ **?** å¼€å¤´ï¼Œç”±ä¸€ä¸ªæˆ–å¤šä¸ªé”®å€¼å¯¹ç»„æˆï¼Œç”¨äºå‘æœåŠ¡å™¨ä¼ é€’é™„åŠ ä¿¡æ¯ï¼Œå¸¸ç”¨äºå®šåˆ¶è¡Œä¸ºå¦‚è¿‡æ»¤æˆ–æœç´¢ã€‚

![URL å¯¹è±¡](/essential/url-object.svg)

æŸ¥è¯¢å‚æ•°ç´§éš Fetch API è¯·æ±‚çš„ **?** ä¹‹åã€‚

```typescript
fetch('https://elysiajs.com/?name=Elysia')
```

æŒ‡å®šæŸ¥è¯¢å‚æ•°æ—¶ï¼Œæ‰€æœ‰å‚æ•°å€¼å¿…é¡»è¡¨ç¤ºä¸ºå­—ç¬¦ä¸²ï¼Œå› å…¶è¢«ç¼–ç å¹¶é™„åŠ åˆ° URLã€‚

### å¼ºåˆ¶è½¬æ¢

Elysia ä¼šè‡ªåŠ¨å°†æŸ¥è¯¢ä¸­çš„å€¼å¼ºåˆ¶è½¬æ¢ä¸ºæ¨¡å¼æ‰€éœ€çš„ç±»å‹ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ [Elysia è¡Œä¸º](/patterns/type#elysia-behavior)ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/', ({ query }) => query, {
               // ^?

		query: t.Object({ // [!code ++]
			name: t.Number() // [!code ++]
		}) // [!code ++]
	})
	.listen(3000)
```

### æ•°ç»„

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia å°†æŸ¥è¯¢å‚æ•°è§†ä¸ºå•ä¸ªå­—ç¬¦ä¸²ï¼Œå³ä½¿åŒä¸€ä¸ªé”®è¢«å¤šæ¬¡æŒ‡å®šã€‚

è‹¥è¦ä½¿ç”¨æ•°ç»„ï¼Œå¿…é¡»æ˜ç¡®å£°æ˜ä¸ºæ•°ç»„ç±»å‹ã€‚

```ts twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/', ({ query }) => query, {
               // ^?

		query: t.Object({
			name: t.Array(t.String()) // [!code ++]
		})
	})
	.listen(3000)
```

ä¸€æ—¦ Elysia è¯†åˆ«æŸå±æ€§ä¸ºæ•°ç»„ï¼Œä¼šè‡ªåŠ¨å°†å…¶å¼ºåˆ¶è½¬æ¢ä¸ºæŒ‡å®šç±»å‹çš„æ•°ç»„ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia æ”¯æŒä»¥ä¸‹æŸ¥è¯¢æ•°ç»„æ ¼å¼ï¼š

#### nuqs

è¯¥æ ¼å¼è¢« [nuqs](https://nuqs.47ng.com) ä½¿ç”¨ã€‚

é€šè¿‡ **,** åˆ†éš”ç¬¦ï¼Œå°†å±æ€§è§£æä¸ºæ•°ç»„ã€‚

```
http://localhost?name=rapi,anis,neon&squad=counter
{
	name: ['rapi', 'anis', 'neon'],
	squad: 'counter'
}
```

#### HTML è¡¨å•æ ¼å¼

å½“åŒä¸€é”®å¤šæ¬¡å‡ºç°æ—¶ï¼Œè¯¥é”®è¢«è§†ä¸ºæ•°ç»„ã€‚

è¿™ä¸ HTML è¡¨å•æ ¼å¼ç›¸åŒï¼Œå½“ç›¸åŒåç§°çš„è¾“å…¥å¤šæ¬¡å‡ºç°æ—¶ã€‚

```
http://localhost?name=rapi&name=anis&name=neon&squad=counter
// name: ['rapi', 'anis', 'neon']
```

## å‚æ•°

å‚æ•°ï¼Œæˆ–è·¯å¾„å‚æ•°ï¼Œæ˜¯é€šè¿‡ URL è·¯å¾„ä¼ é€’çš„æ•°æ®ï¼Œå½¢å¼ä¸º `/key`ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/id/:id', ({ params }) => params, {
                      // ^?

		params: t.Object({
			id: t.Number()
		})
	})
```

å‚æ•°å¿…é¡»ä»¥å¯¹è±¡å½¢å¼æä¾›ã€‚

éªŒè¯ç¤ºä¾‹ï¼š
| URL | éªŒè¯ |
| --- | --------- |
| /id/1 | âœ… |
| /id/a | âŒ |

#### è§„èŒƒ

è·¯å¾„å‚æ•° ï¼ˆåŒºåˆ«äºæŸ¥è¯¢å­—ç¬¦ä¸²æˆ–æŸ¥è¯¢å‚æ•°ï¼‰ã€‚

**é€šå¸¸æ— éœ€é¢å¤–å£°æ˜ï¼ŒElysia ä¼šè‡ªåŠ¨æ¨æ–­è·¯å¾„å‚æ•°ç±»å‹**ï¼Œé™¤ééœ€è¦ç‰¹å®šçš„å€¼æ¨¡å¼ï¼Œå¦‚æ•°å­—æˆ–æ¨¡æ¿å­—é¢é‡ã€‚

```typescript
fetch('https://elysiajs.com/id/1')
```

### å‚æ•°ç±»å‹æ¨æ–­

å¦‚æœæœªæä¾›å‚æ•°æ¨¡å¼ï¼ŒElysia ä¼šé»˜è®¤å°†ç±»å‹æ¨æ–­ä¸ºå­—ç¬¦ä¸²ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/id/:id', ({ params }) => params)
                      // ^?
```

## å¤´éƒ¨

å¤´éƒ¨æ˜¯é€šè¿‡è¯·æ±‚å¤´å‘é€çš„é™„åŠ æ•°æ®ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/headers', ({ headers }) => headers, {
                      // ^?

		headers: t.Object({
			authorization: t.String()
		})
	})
```

ä¸åŒäºå…¶ä»–ç±»å‹ï¼Œå¤´éƒ¨çš„ `additionalProperties` é»˜è®¤å…è®¸ä¸º `true`ã€‚

è¿™æ„å‘³ç€å¤´éƒ¨å¯ä»¥åŒ…å«ä»»æ„é”®å€¼å¯¹ï¼Œä½†å…¶å€¼å¿…é¡»ç¬¦åˆæ¨¡å¼ã€‚

#### è§„èŒƒ

HTTP å¤´éƒ¨å…è®¸å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¼ é€’é™„åŠ ä¿¡æ¯ï¼Œé€šå¸¸ä½œä¸ºå…ƒæ•°æ®å¤„ç†ã€‚

è¯¥å­—æ®µå¸¸ç”¨æ¥å¼ºåˆ¶æŸäº›ç‰¹å®šå¤´éƒ¨å­—æ®µï¼Œå¦‚ `Authorization`ã€‚

å¤´éƒ¨çš„ä½¿ç”¨ä¸ Fetch API ä¸­çš„ `body` ä¸€è‡´ã€‚

```typescript
fetch('https://elysiajs.com/', {
    headers: {
        authorization: 'Bearer 12345'
    }
})
```

::: tip
Elysia åªä½¿ç”¨å°å†™é”®åè§£æå¤´éƒ¨ã€‚

è¯·ç¡®ä¿éªŒè¯æ—¶å¤´éƒ¨å­—æ®µåç§°ä¸ºå°å†™ã€‚
:::

## Cookie

Cookie æ˜¯é€šè¿‡è¯·æ±‚çš„ Cookie å‘é€çš„æ•°æ®ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/cookie', ({ cookie }) => cookie, {
                     // ^?

		cookie: t.Cookie({
			cookieName: t.String()
		})
	})
```

Cookie å¿…é¡»ç”± `t.Cookie` æˆ– `t.Object` å½¢å¼å®šä¹‰ã€‚

ä¸ `headers` ç±»ä¼¼ï¼Œcookie çš„ `additionalProperties` é»˜è®¤è®¾ä¸º `true`ã€‚

#### è§„èŒƒ

HTTP Cookie æ˜¯æœåŠ¡å™¨å‘é€ç»™å®¢æˆ·ç«¯çš„å°å‹æ•°æ®å—ï¼Œæ¯æ¬¡è®¿é—®åŒä¸€ç½‘é¡µæœåŠ¡å™¨æ—¶éƒ½ä¼šè‡ªåŠ¨å‘é€ï¼Œä½¿æœåŠ¡å™¨èƒ½è®°ä½å®¢æˆ·ç«¯ä¿¡æ¯ã€‚

ç®€å•æ¥è¯´ï¼ŒCookie æ˜¯æ¯ä¸ªè¯·æ±‚ä¸­æºå¸¦çš„å­—ç¬¦ä¸²åŒ–çŠ¶æ€ã€‚

è¯¥å­—æ®µå¸¸ç”¨æ¥å¼ºåˆ¶æŸäº›ç‰¹å®š Cookie å­—æ®µã€‚

Cookie æ˜¯ç‰¹æ®Šçš„è¯·æ±‚å¤´å­—æ®µï¼ŒFetch API ä¸å…è®¸è‡ªå®šä¹‰ï¼Œéœ€è¦ç”±æµè§ˆå™¨ç®¡ç†ã€‚å‘é€ Cookie éœ€è®¾ç½® `credentials` å­—æ®µï¼š

```typescript
fetch('https://elysiajs.com/', {
    credentials: 'include'
})
```

### t.Cookie

`t.Cookie` æ˜¯ç‰¹æ®Šç±»å‹ï¼Œç±»ä¼¼äº `t.Object`ï¼Œä½†æ”¯æŒè®¾ç½® Cookie ç‰¹å®šé€‰é¡¹ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/cookie', ({ cookie }) => cookie.name.value, {
                      // ^?

		cookie: t.Cookie({
			name: t.String()
		}, {
			secure: true,
			httpOnly: true
		})
	})
```

## å“åº”

å“åº”æ˜¯å¤„ç†å™¨è¿”å›çš„æ•°æ®ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/response', () => {
		return {
			name: 'Jane Doe'
		}
	}, {
		response: t.Object({
			name: t.String()
		})
	})
```

### æŒ‰çŠ¶æ€ç è®¾ç½®å“åº”

å“åº”å¯ä»¥æŒ‰ HTTP çŠ¶æ€ç å®šä¹‰ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.get('/response', ({ status }) => {
		if (Math.random() > 0.5)
			return status(400, {
				error: 'å‡ºäº†ç‚¹é—®é¢˜'
			})

		return {
			name: 'Jane Doe'
		}
	}, {
		response: {
			200: t.Object({
				name: t.String()
			}),
			400: t.Object({
				error: t.String()
			})
		}
	})
```

è¿™æ˜¯ Elysia ç‹¬æœ‰çš„åŠŸèƒ½ï¼Œå…è®¸è®¾ç½®ä¸åŒçŠ¶æ€ç å¯¹åº”çš„å“åº”ç»“æ„ã€‚

## é”™è¯¯æä¾›å™¨

éªŒè¯å¤±è´¥æ—¶ï¼Œæœ‰ä¸¤ç§æ–¹å¼æä¾›è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ï¼š

1. å†…è”è®¾ç½® `error` å±æ€§
2. é€šè¿‡ [onError](/essential/life-cycle.html#on-error) äº‹ä»¶

### é”™è¯¯å±æ€§

Elysia æä¾›é¢å¤–çš„ **error** å±æ€§ï¼Œå…è®¸é’ˆå¯¹å­—æ®µæ— æ•ˆæ—¶è¿”å›è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
    .post('/', () => 'Hello World!', {
        body: t.Object({
            x: t.Number({
                error: 'x å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—'
            })
        })
    })
    .listen(3000)
```

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºä¸åŒç±»å‹ä½¿ç”¨é”™è¯¯å±æ€§ï¼š

```typescript
t.String({
    format: 'email',
    error: 'æ— æ•ˆçš„ç”µå­é‚®ä»¶ :('
})
```

```
æ— æ•ˆçš„ç”µå­é‚®ä»¶ :(
```

```typescript
t.Array(
    t.String(),
    {
        error: 'æ‰€æœ‰æˆå‘˜å¿…é¡»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²'
    }
)
```

```
æ‰€æœ‰æˆå‘˜å¿…é¡»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²
```

```typescript
t.Object({
    x: t.Number()
}, {
    error: 'Invalid object UnU'
})
```

```
Invalid object UnU
```

```typescript
t.Object({
    x: t.Number({
        error({ errors, type, validation, value }) {
            return 'æœŸæœ› x ä¸ºæ•°å­—'
        }
    })
})
```

```
æœŸæœ› x ä¸ºæ•°å­—
```

## è‡ªå®šä¹‰é”™è¯¯

TypeBox å…è®¸é€šè¿‡ "**error**" å±æ€§è‡ªå®šä¹‰å­—æ®µæ— æ•ˆæ—¶çš„é”™è¯¯æ¶ˆæ¯ã€‚

```typescript
t.String({
    format: 'email',
    error: 'æ— æ•ˆçš„ç”µå­é‚®ç®± :( '
})
```

```
æ— æ•ˆçš„ç”µå­é‚®ç®± :(
```

```typescript
t.Object({
    x: t.Number()
}, {
    error: 'Invalid object UnU'
})
```

```
Invalid object UnU
```

### é”™è¯¯æ¶ˆæ¯ä¸ºå‡½æ•°

é™¤äº†å­—ç¬¦ä¸²ï¼ŒElysia ç±»å‹çš„ `error` ä¹Ÿå¯ä»¥æ˜¯å‡½æ•°ï¼Œä¸ºæ¯ä¸ªå±æ€§åŠ¨æ€è¿”å›è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ã€‚

é”™è¯¯å‡½æ•°çš„å‚æ•°ä¸ `ValidationError` ä¸€è‡´ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
    .post('/', () => 'Hello World!', {
        body: t.Object({
            x: t.Number({
                error() {
                    return 'æœŸæœ› x ä¸ºæ•°å­—'
                }
            })
        })
    })
    .listen(3000)
```

::: tip
å°†é¼ æ ‡æ‚¬åœäº `error` å¯æŸ¥çœ‹ç±»å‹æç¤ºã€‚
:::

### é”™è¯¯æŒ‰å­—æ®µè°ƒç”¨

æ³¨æ„ï¼Œé”™è¯¯å‡½æ•°åªåœ¨å¯¹åº”å­—æ®µæ— æ•ˆæ—¶è°ƒç”¨ã€‚

ç¤ºä¾‹å¦‚ä¸‹ï¼š

```typescript
t.Object({
    x: t.Number({
        error() {
            return 'æœŸæœ› x ä¸ºæ•°å­—'
        }
    })
})
```

```json
{
    x: "hello"
}
```

```typescript
t.Object({
    x: t.Number({
        error() {
            return 'æœŸæœ› x ä¸ºæ•°å­—'
        }
    })
})
```

```json
"hello"
```

```typescript
t.Object(
    {
        x: t.Number({
            error() {
                return 'æœŸæœ› x ä¸ºæ•°å­—'
            }
        })
    }, {
        error() {
            return 'æœŸæœ›å€¼ä¸ºå¯¹è±¡'
        }
    }
)
```

```json
"hello"
```

### onError

æˆ‘ä»¬å¯ä»¥é€šè¿‡ [onError](/essential/life-cycle.html#on-error) äº‹ä»¶è‡ªå®šä¹‰éªŒè¯è¡Œä¸ºï¼Œæ•è·é”™è¯¯ä»£ç  "**VALIDATION**"ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

new Elysia()
	.onError(({ code, error }) => {
		if (code === 'VALIDATION')
		    return error.message
	})
	.listen(3000)
```

ç®€åŒ–åçš„é”™è¯¯ç±»å‹è¡¨ç°ä¸ºä» **elysia/error** å¯¼å…¥çš„ `ValidationError`ã€‚

**ValidationError** æš´éœ²åä¸º **validator** çš„å±æ€§ï¼Œç±»å‹ä¸º [TypeCheck](https://github.com/sinclairzx81/typebox#typecheck)ï¼Œå…è®¸ç›´æ¥æ“ä½œ TypeBox åŠŸèƒ½ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
    .onError(({ code, error }) => {
        if (code === 'VALIDATION')
            return error.all[0].message
    })
    .listen(3000)
```

### é”™è¯¯åˆ—è¡¨

**ValidationError** æä¾›äº†æ–¹æ³• `ValidationError.all`ï¼Œç”¨äºåˆ—å‡ºæ‰€æœ‰é”™è¯¯åŸå› ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.post('/', ({ body }) => body, {
		body: t.Object({
			name: t.String(),
			age: t.Number()
		}),
		error({ code, error }) {
			switch (code) {
				case 'VALIDATION':
                    console.log(error.all)

                    // æŸ¥æ‰¾ç‰¹å®šé”™è¯¯ï¼Œè·¯å¾„ç¬¦åˆ OpenAPI è§„èŒƒ
                    const name = error.all.find(
						(x) => x.summary && x.path === '/name'
					)

                    // è‹¥å­˜åœ¨éªŒè¯é”™è¯¯åˆ™æ‰“å°
                    if(name)
    					console.log(name)
			}
		}
	})
	.listen(3000)
```

å…³äº TypeBox éªŒè¯å™¨æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚é˜… [TypeCheck](https://github.com/sinclairzx81/typebox#typecheck)ã€‚

## å¼•ç”¨æ¨¡å‹

æœ‰æ—¶æˆ‘ä»¬ä¼šå£°æ˜é‡å¤æ¨¡å‹ï¼Œæˆ–å¤šæ¬¡å¤ç”¨åŒä¸€æ¨¡å‹ã€‚

é€šè¿‡å¼•ç”¨æ¨¡å‹ï¼Œå¯ä»¥ä¸ºæ¨¡å‹å‘½åï¼Œå¹¶é€šè¿‡åç§°åœ¨ä¸åŒåœ°æ–¹å¼•ç”¨ã€‚

å…ˆçœ‹ä¸€ä¸ªç®€å•åœºæ™¯ï¼š

å‡è®¾ç”¨äºç™»å½•çš„æ§åˆ¶å™¨å…±äº«åŒä¸€æ¨¡å‹ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .post('/sign-in', ({ body }) => body, {
        body: t.Object({
            username: t.String(),
            password: t.String()
        }),
        response: t.Object({
            username: t.String(),
            password: t.String()
        })
    })
```

æˆ‘ä»¬å¯ä»¥å°†æ¨¡å‹æå–æˆå˜é‡å¹¶å¤ç”¨ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

// å‡è®¾åœ¨ä¸åŒæ–‡ä»¶ï¼Œå¦‚ models.ts
const SignDTO = t.Object({
    username: t.String(),
    password: t.String()
})

const app = new Elysia()
    .post('/sign-in', ({ body }) => body, {
        body: SignDTO,
        response: SignDTO
    })
```

è¿™ç§å…³æ³¨ç‚¹åˆ†ç¦»æ–¹å¼æœ‰æ•ˆï¼Œä½†éšç€é¡¹ç›®å¤æ‚åº¦æå‡ï¼Œæˆ‘ä»¬å¯èƒ½åœ¨ä¸åŒæ§åˆ¶å™¨å¤šå¤„å¤ç”¨å¤šä¸ªæ¨¡å‹ã€‚

å¯é€šè¿‡åˆ›å»ºâ€œå¼•ç”¨æ¨¡å‹â€è§£å†³ï¼Œå‘½åæ¨¡å‹å¹¶åœ¨ `schema` ç›´æ¥ä½¿ç”¨åç§°å¼•ç”¨ï¼ŒåŒæ—¶é€šè¿‡ `model` æ³¨å†Œæ¨¡å‹ã€‚

```typescript twoslash
import { Elysia, t } from 'elysia'

const app = new Elysia()
    .model({
        sign: t.Object({
            username: t.String(),
            password: t.String()
        })
    })
    .post('/sign-in', ({ body }) => body, {
        // ä½¿ç”¨å·²æ³¨å†Œçš„æ¨¡å‹åç§°ï¼Œäº«å—è‡ªåŠ¨è¡¥å…¨
        body: 'sign',
        response: 'sign'
    })
```

è‹¥éœ€è®¿é—®æ¨¡å‹é›†åˆï¼Œå¯å°† `model` å®šä¹‰æˆæ’ä»¶ï¼Œå¯¼å‡ºæ—¶æä¾›ä¸€ç»„æ¨¡å‹ï¼Œé¿å…å¤šæ¬¡å¯¼å…¥ã€‚

```typescript
// auth.model.ts
import { Elysia, t } from 'elysia'

export const authModel = new Elysia()
    .model({
        sign: t.Object({
            username: t.String(),
            password: t.String()
        })
    })
```

åœ¨ä¸»ç¨‹åºä¸­ï¼š

```typescript twoslash
// @filename: auth.model.ts
import { Elysia, t } from 'elysia'

export const authModel = new Elysia()
    .model({
        sign: t.Object({
            username: t.String(),
            password: t.String()
        })
    })

// @filename: index.ts
// ---çœç•¥---
// index.ts
import { Elysia } from 'elysia'
import { authModel } from './auth.model'

const app = new Elysia()
    .use(authModel)
    .post('/sign-in', ({ body }) => body, {
        // ä½¿ç”¨å·²æ³¨å†Œçš„æ¨¡å‹åç§°ï¼Œäº«å—è‡ªåŠ¨è¡¥å…¨
        body: 'sign',
        response: 'sign'
    })
```

è¿™ç§æ–¹å¼ä¸ä»…å®ç°å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œè¿˜èƒ½å¤šå¤„å¤ç”¨æ¨¡å‹ï¼Œå¹¶å°†æ¨¡å‹æ•´åˆè¿› OpenAPI æ–‡æ¡£ã€‚

### å¤šæ¨¡å‹

`model` æ¥å—ä¸€ä¸ªå¯¹è±¡ï¼Œé”®ä¸ºæ¨¡å‹åï¼Œå€¼ä¸ºæ¨¡å‹å®šä¹‰ï¼Œæ”¯æŒæ³¨å†Œå¤šä¸ªæ¨¡å‹ã€‚

```typescript
// auth.model.ts
import { Elysia, t } from 'elysia'

export const authModel = new Elysia()
    .model({
        number: t.Number(),
        sign: t.Object({
            username: t.String(),
            password: t.String()
        })
    })
```

### å‘½åè§„èŒƒ

é‡å¤æ¨¡å‹åç§°ä¼šå¯¼è‡´ Elysia æŠ›é”™ã€‚ä¸ºé¿å…å£°æ˜é‡å¤å‘½åæ¨¡å‹ï¼Œæ¨èé‡‡ç”¨å‘½åè§„èŒƒã€‚

å‡è®¾å°†æ‰€æœ‰æ¨¡å‹å­˜å‚¨äº `models/<name>.ts` å¹¶åœ¨æ¨¡å‹åå‰åŠ å‰ç¼€ä½œä¸ºå‘½åç©ºé—´ã€‚

```typescript
import { Elysia, t } from 'elysia'

// admin.model.ts
export const adminModels = new Elysia()
    .model({
        'admin.auth': t.Object({
            username: t.String(),
            password: t.String()
        })
    })

// user.model.ts
export const userModels = new Elysia()
    .model({
        'user.auth': t.Object({
            username: t.String(),
            password: t.String()
        })
    })
```

è¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…å‘½åå†²çªï¼Œæœ€ç»ˆä»éœ€å›¢é˜Ÿç»Ÿä¸€å‘½åæ–¹æ¡ˆã€‚

Elysia æä¾›æ„è§åŒ–é€‰é¡¹ï¼Œå¸®åŠ©é¿å…å†³ç­–ç–²åŠ³ã€‚

### TypeScript

æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¿é—®æ¯ä¸ª Elysia/TypeBox ç±»å‹çš„ `static` å±æ€§ï¼Œè·å–å…¶ç±»å‹å®šä¹‰ï¼š

```ts twoslash
import { t } from 'elysia'

const MyType = t.Object({
	hello: t.Literal('Elysia')
})

type MyType = typeof MyType.static
//    ^?
```

è¿™å…è®¸ Elysia è‡ªåŠ¨æ¨æ–­å¹¶æä¾›ç±»å‹ï¼Œå‡å°‘é‡å¤å£°æ˜æ¨¡å¼çš„éœ€æ±‚ã€‚

ä¸€ä¸ª Elysia/TypeBox æ¨¡å¼å¯è¢«ç”¨äºï¼š

* è¿è¡Œæ—¶éªŒè¯
* æ•°æ®å¼ºåˆ¶è½¬æ¢
* TypeScript ç±»å‹
* OpenAPI æ¨¡å¼

ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†æ¨¡å¼ä½œä¸º**å•ä¸€å¯ä¿¡æº**ã€‚

---

---
url: 'https://elysiajs.com/tutorial/patterns/validation-error.md'
---

# éªŒè¯é”™è¯¯

å¦‚æœæ‚¨ä½¿ç”¨ `Elysia.t` è¿›è¡ŒéªŒè¯ï¼Œå¯ä»¥æ ¹æ®æœªé€šè¿‡éªŒè¯çš„å­—æ®µæä¾›è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.post(
		'/',
		({ body }) => body,
		{
			body: t.Object({
				age: t.Number({
					error: 'å¹´é¾„å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—' // [!code ++]
				})
			}, {
				error: 'ä¸»ä½“å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡' // [!code ++]
			})
		}
	)
	.listen(3000)
```

Elysia å°†ç”¨æ‚¨æä¾›çš„è‡ªå®šä¹‰æ¶ˆæ¯è¦†ç›–é»˜è®¤é”™è¯¯æ¶ˆæ¯ï¼Œè¯·å‚è§ è‡ªå®šä¹‰éªŒè¯æ¶ˆæ¯ã€‚

## éªŒè¯è¯¦ç»†ä¿¡æ¯

é»˜è®¤æƒ…å†µä¸‹ï¼ŒElysia è¿˜æä¾› éªŒè¯è¯¦ç»†ä¿¡æ¯ æ¥è§£é‡ŠéªŒè¯å‡ºé”™çš„åŸå› ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```json
{
	"type": "validation",
	"on": "params",
	"value": { "id": "string" },
	"property": "/id",
	"message": "id å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—", // [!code ++]
	"summary": "å±æ€§ 'id' åº”è¯¥æ˜¯ï¼š'numeric', 'number'",
	"found": { "id": "string" },
	"expected": { "id": 0 },
	"errors": [
		{
			"type": 62,
			"schema": {
				"anyOf": [
					{ "format": "numeric", "default": 0, "type": "string" },
					{ "type": "number" }
				]
			},
			"path": "/id",
			"value": "string",
			"message": "æœŸæœ›çš„è”åˆå€¼",
			"errors": [{ "iterator": {} }, { "iterator": {} }],
			"summary": "å±æ€§ 'id' åº”è¯¥æ˜¯ï¼š'numeric', 'number'"
		}
	]
}
```

ç„¶è€Œï¼Œå½“æ‚¨æä¾›è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯æ—¶ï¼Œå®ƒå°†å®Œå…¨è¦†ç›– éªŒè¯è¯¦ç»†ä¿¡æ¯

è¦æ¢å¤éªŒè¯è¯¦ç»†ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥å°†è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯åŒ…è£…åœ¨ éªŒè¯è¯¦ç»†ä¿¡æ¯ å‡½æ•°ä¸­ã€‚

```typescript
import { Elysia, t, validationDetail } from 'elysia' // [!code ++]

new Elysia()
	.post(
		'/',
		({ body }) => body,
		{
			body: t.Object({
				age: t.Number({
					error: validationDetail('å¹´é¾„å¿…é¡»æ˜¯ä¸€ä¸ªæ•°å­—') // [!code ++]
				})
			}, {
				error: validationDetail('ä¸»ä½“å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡') // [!code ++]
			})
		}
	)
	.listen(3000)
```

## ä»»åŠ¡

è®©æˆ‘ä»¬å°è¯•æ‰©å±• Elysia çš„ä¸Šä¸‹æ–‡ã€‚

\<template #answer>

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸ºæ¨¡å¼æä¾› `error` å±æ€§æ¥æä¾›è‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯ã€‚

```typescript
import { Elysia, t } from 'elysia'

new Elysia()
	.post(
		'/',
		({ body }) => body,
		{
			body: t.Object({
				age: t.Number({
                    error: 'æŸäº‹' // [!code ++]
                })
			})
		}
	)
	.listen(3000)
```
